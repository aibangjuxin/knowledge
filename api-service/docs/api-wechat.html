<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>API 平台演进：从标准 API 到多模式服务支持</title>
  </head>
  <body
    style="
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
        Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 677px;
      margin: 0 auto;
      padding: 20px;
    "
  >
    <section style="margin-bottom: 20px">
      <h1
        style="
          font-size: 22px;
          font-weight: bold;
          color: #000;
          margin-bottom: 15px;
          border-left: 4px solid #07c160;
          padding-left: 10px;
          line-height: 1.4;
        "
      >
        API 平台演进：从标准 API 到多模式服务支持
      </h1>
    </section>

    <section style="margin-bottom: 30px">
      <h2
        style="
          font-size: 18px;
          font-weight: bold;
          color: #07c160;
          margin-top: 25px;
          margin-bottom: 15px;
          border-bottom: 1px solid #eee;
          padding-bottom: 5px;
        "
      >
        1. 背景与现状
      </h2>
      <p style="margin-bottom: 15px; text-align: justify">
        我们当前的 API 平台基于
        <strong>GCP (Google Cloud Platform)</strong> 构建，核心流量链路为：
      </p>
      <div
        style="
          background-color: #f6f8fa;
          padding: 10px;
          border-radius: 4px;
          font-size: 14px;
          color: #555;
          margin-bottom: 15px;
          border: 1px solid #eee;
        "
      >
        GCP GLB (Global Load Balancer) -> Nginx (L7 Ingress) -> Kong Gateway
        (API Management) -> Runtime (GKE/Java/Python/Go/Node.js)
      </div>
      <p style="margin-bottom: 15px; text-align: justify">
        这套架构目前完美支持了 <strong>Standard API</strong>（标准 RESTful
        API）的托管，提供了统一的认证、鉴权、限流和监控能力。然而，随着业务的扩展和
        AI 技术的发展，我们需要支持更多样化的服务形态，包括
        <strong>Container</strong>（通用容器服务）、<strong>No Gateway</strong
        >（直连/高性能服务）、<strong>Microservices</strong>（微服务架构）以及
        <strong>AI Services</strong>（流式/事件驱动服务）。
      </p>
      <p style="margin-bottom: 15px; text-align: justify">
        本文档旨在深度解析这些服务形态的区别，并探讨我们的平台如何演进以支持这些新需求。
      </p>
    </section>

    <section style="margin-bottom: 30px">
      <h2
        style="
          font-size: 18px;
          font-weight: bold;
          color: #07c160;
          margin-top: 25px;
          margin-bottom: 15px;
          border-bottom: 1px solid #eee;
          padding-bottom: 5px;
        "
      >
        2. 服务模式深度解析
      </h2>

      <h3
        style="
          font-size: 16px;
          font-weight: bold;
          color: #333;
          margin-top: 20px;
          margin-bottom: 10px;
        "
      >
        2.1. Standard API (标准 API)
      </h3>
      <ul
        style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px"
      >
        <li style="margin-bottom: 5px">
          <strong>定义</strong>: 传统的 Request-Response 模型，通常基于 HTTP/1.1
          RESTful 规范。
        </li>
        <li style="margin-bottom: 5px">
          <strong>特点</strong>:
          <ul
            style="list-style-type: circle; padding-left: 20px; margin-top: 5px"
          >
            <li style="margin-bottom: 3px">
              <strong>强治理</strong>: 必须经过 API 网关，接受严格的
              AuthN/AuthZ、Rate Limiting、Logging 等策略管控。
            </li>
            <li style="margin-bottom: 3px">
              <strong>无状态</strong>: 适合水平扩展。
            </li>
            <li style="margin-bottom: 3px">
              <strong>面向外部</strong>: 主要作为对外暴露的业务能力接口。
            </li>
          </ul>
        </li>
        <li style="margin-bottom: 5px">
          <strong>当前支持</strong>: ✅ 完美支持。
        </li>
      </ul>

      <h3
        style="
          font-size: 16px;
          font-weight: bold;
          color: #333;
          margin-top: 20px;
          margin-bottom: 10px;
        "
      >
        2.2. Container (通用容器服务)
      </h3>
      <ul
        style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px"
      >
        <li style="margin-bottom: 5px">
          <strong>定义</strong>:
          用户只需提供一个容器镜像，平台负责运行，不强制要求遵循 REST API
          规范。可能是 Web App、后台 Worker、定时任务或非标准 HTTP 服务。
        </li>
        <li style="margin-bottom: 5px">
          <strong>特点</strong>:
          <ul
            style="list-style-type: circle; padding-left: 20px; margin-top: 5px"
          >
            <li style="margin-bottom: 3px">
              <strong>灵活性</strong>: 关注点在于“运行代码”而非“暴露接口”。
            </li>
            <li style="margin-bottom: 3px">
              <strong>弱治理</strong>: 可能不需要复杂的 API
              网关策略，或者只需要最基础的路由功能。
            </li>
            <li style="margin-bottom: 3px">
              <strong>生命周期</strong>: 可能包含非 HTTP
              的生命周期（如批处理）。
            </li>
          </ul>
        </li>
        <li style="margin-bottom: 5px">
          <strong>区别</strong>: 与 Standard API 相比，它更像是一个 PaaS
          (Platform as a Service) 运行时，而非 SaaS 接口。
        </li>
      </ul>

      <h3
        style="
          font-size: 16px;
          font-weight: bold;
          color: #333;
          margin-top: 20px;
          margin-bottom: 10px;
        "
      >
        2.3. No Gateway (无网关/直连服务)
      </h3>
      <ul
        style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px"
      >
        <li style="margin-bottom: 5px">
          <strong>定义</strong>: 流量不经过 API
          网关（Kong）的应用层处理，直接到达后端服务，或者仅经过 4
          层（TCP/UDP）转发。
        </li>
        <li style="margin-bottom: 5px">
          <strong>特点</strong>:
          <ul
            style="list-style-type: circle; padding-left: 20px; margin-top: 5px"
          >
            <li style="margin-bottom: 3px">
              <strong>高性能</strong>: 减少了网关层的 Hop，降低延迟（Latency）。
            </li>
            <li style="margin-bottom: 3px">
              <strong>特殊协议</strong>: 支持网关无法解析的私有协议或非 HTTP
              协议（如纯 TCP、UDP、MQTT）。
            </li>
            <li style="margin-bottom: 3px">
              <strong>内部使用</strong>:
              通常用于受信任的内部服务间调用，或对延迟极度敏感的场景。
            </li>
          </ul>
        </li>
        <li style="margin-bottom: 5px">
          <strong>区别</strong>:
          牺牲了统一治理能力（鉴权、监控需自理），换取了极致的性能或协议灵活性。
        </li>
      </ul>

      <h3
        style="
          font-size: 16px;
          font-weight: bold;
          color: #333;
          margin-top: 20px;
          margin-bottom: 10px;
        "
      >
        2.4. Microservices (微服务架构)
      </h3>
      <ul
        style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px"
      >
        <li style="margin-bottom: 5px">
          <strong>定义</strong>: 一组小型、松耦合的服务协同工作。重点在于<strong
            >服务间通信 (East-West Traffic)</strong
          >
          而非单纯的外部访问 (North-South Traffic)。
        </li>
        <li style="margin-bottom: 5px">
          <strong>特点</strong>:
          <ul
            style="list-style-type: circle; padding-left: 20px; margin-top: 5px"
          >
            <li style="margin-bottom: 3px">
              <strong>服务发现</strong>: 服务之间需要动态发现彼此。
            </li>
            <li style="margin-bottom: 3px">
              <strong>复杂的调用链</strong>:
              一个外部请求可能触发内部几十次服务调用。
            </li>
            <li style="margin-bottom: 3px">
              <strong>治理下沉</strong>: 熔断、重试、负载均衡等逻辑通常下沉到
              Sidecar (Service Mesh) 而非集中式网关。
            </li>
          </ul>
        </li>
        <li style="margin-bottom: 5px">
          <strong>区别</strong>: Standard API 关注“大门”的守卫，Microservices
          关注“房间”内部的协作。
        </li>
      </ul>

      <h3
        style="
          font-size: 16px;
          font-weight: bold;
          color: #333;
          margin-top: 20px;
          margin-bottom: 10px;
        "
      >
        2.5. AI Services (AI 流式/事件服务)
      </h3>
      <ul
        style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px"
      >
        <li style="margin-bottom: 5px">
          <strong>定义</strong>: 基于长连接和实时数据流的服务，如 LLM 的 Token
          流式输出、语音识别流、实时推理等。
        </li>
        <li style="margin-bottom: 5px">
          <strong>特点</strong>:
          <ul
            style="list-style-type: circle; padding-left: 20px; margin-top: 5px"
          >
            <li style="margin-bottom: 3px">
              <strong>协议特殊</strong>: 强依赖 <strong>HTTP/2</strong>,
              <strong>gRPC</strong>, <strong>WebSocket</strong>,
              <strong>SSE (Server-Sent Events)</strong>。
            </li>
            <li style="margin-bottom: 3px">
              <strong>长连接</strong>:
              连接持续时间长，对超时（Timeout）配置敏感。
            </li>
            <li style="margin-bottom: 3px">
              <strong>双向通信</strong>: 客户端和服务端可能同时发送数据（如 gRPC
              Bi-directional streaming）。
            </li>
          </ul>
        </li>
        <li style="margin-bottom: 5px">
          <strong>区别</strong>:
          打破了传统的“请求-立即响应-关闭”模型，要求全链路（GLB -> Nginx -> Kong
          -> App）都支持长连接和特定协议。
        </li>
      </ul>
    </section>

    <section style="margin-bottom: 30px">
      <h2
        style="
          font-size: 18px;
          font-weight: bold;
          color: #07c160;
          margin-top: 25px;
          margin-bottom: 15px;
          border-bottom: 1px solid #eee;
          padding-bottom: 5px;
        "
      >
        3. 平台支持策略与演进方案
      </h2>
      <p style="margin-bottom: 15px; text-align: justify">
        为了在现有架构上支持上述服务，我们需要对各层级进行差异化配置或引入新组件。
      </p>

      <h3
        style="
          font-size: 16px;
          font-weight: bold;
          color: #333;
          margin-top: 20px;
          margin-bottom: 10px;
        "
      >
        3.1. 架构概览图
      </h3>
      <div
        style="
          background-color: #f6f8fa;
          padding: 15px;
          border-radius: 4px;
          border: 1px solid #eee;
          margin-bottom: 15px;
          text-align: center;
          color: #666;
          font-size: 14px;
        "
      >
        <p style="margin-bottom: 10px">[此处建议插入 Mermaid 架构图]</p>
        <pre
          style="
            text-align: left;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
          "
        >
graph TD
    User[User / Client] --> GLB[GCP GLB]
    GLB --> Nginx["Nginx Ingress (L7/L4)"]
    
    subgraph "Existing Path"
    Nginx --"HTTP/1.1"--> Kong[Kong Gateway]
    Kong --> StdAPI[Standard API]
    end

    subgraph "New Paths"
    Nginx --"TCP/Stream"--> NoGW[No Gateway Service]
    Nginx --"HTTP/2 / gRPC"--> KongAI["Kong (AI Config)"]
    KongAI --> AI["AI Service (Stream/gRPC)"]
    end

    subgraph "Runtime & Mesh"
    StdAPI <--> Mesh((Service Mesh))
    AI <--> Mesh
    Micro[Microservices] <--> Mesh
    end
            </pre
        >
        <p style="font-size: 12px; color: #999; margin-top: 5px">
          (请使用 Mermaid 工具生成图片后插入)
        </p>
      </div>

      <h3
        style="
          font-size: 16px;
          font-weight: bold;
          color: #333;
          margin-top: 20px;
          margin-bottom: 10px;
        "
      >
        3.2. 详细支持方案
      </h3>

      <h4
        style="
          font-size: 15px;
          font-weight: bold;
          color: #444;
          margin-top: 15px;
          margin-bottom: 8px;
        "
      >
        A. 支持 Container (通用容器)
      </h4>
      <ul
        style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px"
      >
        <li style="margin-bottom: 5px">
          <strong>策略</strong>: <strong>Cloud Run 集成</strong> 或
          <strong>GKE 简化部署</strong>。
        </li>
        <li style="margin-bottom: 5px">
          <strong>实施</strong>:
          <ul
            style="list-style-type: circle; padding-left: 20px; margin-top: 5px"
          >
            <li style="margin-bottom: 3px">
              利用 GCP 的
              <strong>Cloud Run</strong>
              作为无服务器容器运行时，适合无状态、HTTP 驱动的容器。
            </li>
            <li style="margin-bottom: 3px">
              在 GKE 中提供通用的 Helm Chart 模板，允许用户部署不通过 Kong
              的服务（通过 Kubernetes Service 直接暴露或仅走 Nginx Ingress）。
            </li>
          </ul>
        </li>
      </ul>

      <h4
        style="
          font-size: 15px;
          font-weight: bold;
          color: #444;
          margin-top: 15px;
          margin-bottom: 8px;
        "
      >
        B. 支持 No Gateway (无网关)
      </h4>
      <ul
        style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px"
      >
        <li style="margin-bottom: 5px">
          <strong>策略</strong>: <strong>Nginx L4 透传</strong> 或
          <strong>GKE L4 LoadBalancer</strong>。
        </li>
        <li style="margin-bottom: 5px">
          <strong>实施</strong>:
          <ul
            style="list-style-type: circle; padding-left: 20px; margin-top: 5px"
          >
            <li style="margin-bottom: 3px">
              <strong>方案一 (推荐)</strong>: 在 Nginx 层配置
              <code>stream</code> 模块，进行 TCP/UDP 透传，直接指向后端
              Service，完全绕过 Kong。
            </li>
            <li style="margin-bottom: 3px">
              <strong>方案二</strong>: 为特定服务创建类型为
              <code>LoadBalancer</code> 的 Kubernetes Service，直接获取 GCP 的
              L4 LB IP，绕过所有 Ingress 层（适合极高性能需求）。
            </li>
          </ul>
        </li>
      </ul>

      <h4
        style="
          font-size: 15px;
          font-weight: bold;
          color: #444;
          margin-top: 15px;
          margin-bottom: 8px;
        "
      >
        C. 支持 Microservices (微服务)
      </h4>
      <ul
        style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px"
      >
        <li style="margin-bottom: 5px">
          <strong>策略</strong>:
          <strong>引入 Service Mesh (如 Istio / Anthos Service Mesh)</strong>。
        </li>
        <li style="margin-bottom: 5px">
          <strong>实施</strong>:
          <ul
            style="list-style-type: circle; padding-left: 20px; margin-top: 5px"
          >
            <li style="margin-bottom: 3px">
              Kong 继续负责
              <strong>南北向 (North-South)</strong> 流量（外部入口）。
            </li>
            <li style="margin-bottom: 3px">
              引入 <strong>Istio/ASM</strong> 接管
              <strong>东西向 (East-West)</strong> 流量。
            </li>
            <li style="margin-bottom: 3px">
              Kong 可以作为 Mesh 的 Ingress Gateway，或者与 Mesh 的 Sidecar
              协同工作。
            </li>
            <li style="margin-bottom: 3px">
              利用 Mesh 提供的
              mTLS、细粒度流量控制和全链路追踪（Tracing）来管理微服务复杂性。
            </li>
          </ul>
        </li>
      </ul>

      <h4
        style="
          font-size: 15px;
          font-weight: bold;
          color: #444;
          margin-top: 15px;
          margin-bottom: 8px;
        "
      >
        D. 支持 AI Services (Stream Events)
      </h4>
      <ul
        style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px"
      >
        <li style="margin-bottom: 5px">
          <strong>策略</strong>: <strong>全链路协议升级与超时调优</strong>。
        </li>
        <li style="margin-bottom: 5px">
          <strong>实施</strong>:
          <ul
            style="list-style-type: circle; padding-left: 20px; margin-top: 5px"
          >
            <li style="margin-bottom: 3px">
              <strong>GCP GLB</strong>: 开启 HTTP/2 支持。
            </li>
            <li style="margin-bottom: 3px">
              <strong>Nginx</strong>:
              <ul
                style="
                  list-style-type: square;
                  padding-left: 20px;
                  margin-top: 3px;
                "
              >
                <li style="margin-bottom: 3px">
                  配置 <code>grpc_pass</code> 或 <code>proxy_pass</code> 并开启
                  HTTP/2。
                </li>
                <li style="margin-bottom: 3px">
                  <strong>关键</strong>: 调大 <code>proxy_read_timeout</code> 和
                  <code>keepalive_timeout</code
                  >，避免长连接被意外切断（例如设置为 3600s）。
                </li>
                <li style="margin-bottom: 3px">支持 WebSocket Upgrade 头。</li>
              </ul>
            </li>
            <li style="margin-bottom: 3px">
              <strong>Kong</strong>:
              <ul
                style="
                  list-style-type: square;
                  padding-left: 20px;
                  margin-top: 3px;
                "
              >
                <li style="margin-bottom: 3px">
                  配置 Service 的 <code>protocol</code> 为 <code>grpc</code> 或
                  <code>http</code> (针对 SSE)。
                </li>
                <li style="margin-bottom: 3px">
                  配置 Route 匹配 gRPC 方法或 WebSocket 路径。
                </li>
                <li style="margin-bottom: 3px">
                  同样需要调整 Upstream 的超时设置。
                </li>
              </ul>
            </li>
            <li style="margin-bottom: 3px">
              <strong>Runtime (GKE)</strong>:
              <ul
                style="
                  list-style-type: square;
                  padding-left: 20px;
                  margin-top: 3px;
                "
              >
                <li style="margin-bottom: 3px">
                  配置 <code>BackendConfig</code> (GCP CRD) 以调整 GKE Ingress
                  Controller (如果使用) 的超时参数。
                </li>
                <li style="margin-bottom: 3px">
                  应用本身需实现 Keepalive/Heartbeat 机制以保活。
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>

      <h3
        style="
          font-size: 16px;
          font-weight: bold;
          color: #333;
          margin-top: 20px;
          margin-bottom: 10px;
        "
      >
        3.3. 总结对照表
      </h3>
      <table
        style="
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
          font-size: 13px;
        "
      >
        <thead>
          <tr style="background-color: #f2f2f2">
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left">
              服务类型
            </th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left">
              关键需求
            </th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left">
              平台改造点
            </th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left">
              推荐路径
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px">
              <strong>Standard API</strong>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">统一治理, REST</td>
            <td style="border: 1px solid #ddd; padding: 8px">无 (维持现状)</td>
            <td style="border: 1px solid #ddd; padding: 8px">
              GLB -> Nginx -> Kong -> App
            </td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px">
              <strong>Container</strong>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">灵活运行</td>
            <td style="border: 1px solid #ddd; padding: 8px">
              提供通用部署模板 / Cloud Run
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">
              GLB -> Nginx -> App (可选 Kong)
            </td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px">
              <strong>No Gateway</strong>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">
              高性能, 私有协议
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">
              Nginx L4 Stream 或 L4 LB
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">
              GLB (TCP) -> Nginx (TCP) -> App
            </td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px">
              <strong>Microservices</strong>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">
              服务间通信, 治理
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">
              引入 Service Mesh (ASM/Istio)
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">
              Kong (入口) + Mesh (内部)
            </td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px">
              <strong>AI Services</strong>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">
              长连接, HTTP/2, gRPC
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">
              全链路超时调整, HTTP/2 开启
            </td>
            <td style="border: 1px solid #ddd; padding: 8px">
              GLB -> Nginx (H2) -> Kong (H2) -> App
            </td>
          </tr>
        </tbody>
      </table>

      <p style="margin-bottom: 15px; text-align: justify; font-weight: bold">
        通过上述演进，我们的平台将从单一的 API
        管理平台转变为一个支持多模态计算和服务的综合性云原生平台。
      </p>
    </section>
  </body>
</html>
