# Verify Public/Private IP Script (`verify-pub-priv-ip.sh`)

此脚本用于验证指定域名（FQDN）在多个主流 DNS 服务器上的解析情况，并根据解析出的 IP 地址类型（公网或私网）判定该域名的出口模式。它是 Onboarding 流程中自动化网络策略决策的核心工具。

## 1. 核心功能

- **多 DNS 交叉验证**：同时查询 Google (8.8.8.8)、腾讯 (119.29.29.29)、114 和 阿里 (223.5.5.5) 的 DNS 服务器。
- **Peering 列表检查**：预置 `DNS_PEERING` 列表，快速识别内部已知域名。
- **IP 类型自动识别**：基于 RFC1918 标准（10/8, 172.16/12, 192.168/16）以及本地回环地址自动分类 IP。
- **多种输出格式支持**：支持人类可读的表格、简短的结论字符串以及标准的 JSON 格式，方便 Pipeline 调用。

## 2. 使用方法

```bash
# 基础用法（显示详细报表）
./verify-pub-priv-ip.sh www.google.com

# 简短模式（仅输出 PUBLIC/PRIVATE/UNKNOWN，适合脚本判断）
./verify-pub-priv-ip.sh www.google.com --short

# JSON 模式（输出完整信息的结构化数据，适合高级集成）
./verify-pub-priv-ip.sh www.google.com --json
```

## 3. 判断逻辑实现详解 (Verdict Logic)

脚本的最终结论（Final Verdict）遵循**“安全优先、公网优先”**的原则，具体实现逻辑如下：

### 第一步：服务器级别分类
对于每一个被查询的 DNS 服务器：
- 如果解析出的 IP 列表中包含**任何一个**公网 IP（非私有地址），则该服务器的结论定为 `PUBLIC`。
- 如果解析出的所有 IP **均为**私有地址（RFC1918 等），则该服务器的结论定为 `PRIVATE`。
- 如果解析失败或无记录，则标记为 `FAILED` 或 `EMPTY`。

### 第二步：最终结论判定 (Final Verdict)
脚本汇总所有服务器的分类结果，并应用以下权重规则：
1. **PUBLIC 优先**：只要有**任何一个** DNS 服务器返回了 `PUBLIC` 结果，最终结论即为 `PUBLIC`。
   - *原因*：防止域名在某些 DNS 下存在公网入口而被忽略，确保安全出口策略覆盖到位。
2. **PRIVATE 次之**：如果没有服务器返回 `PUBLIC`，但有**任何一个**服务器返回了 `PRIVATE`，最终结论即为 `PRIVATE`。
3. **UNKNOWN 保底**：如果所有查询均失败或没有有效的 A 记录解析，结论为 `UNKNOWN`。

### 退出状态码 (Exit Codes)
为了方便集成到 CI/CD Pipeline（如 Jenkins Groovy），脚本提供了特定的退出码：
- `0`: 结论为 `PUBLIC`。
- `1`: 结论为 `PRIVATE`。
- `2`: 结论为 `UNKNOWN` 或执行出错。

## 4. 自动化集成建议

在 Onboarding Pipeline 中，推荐使用 `--short` 模式结合退出码进行逻辑切换：

```groovy
// 示例 Pipeline 代码
def domain = "api.external.com"
def status = sh(script: "./dns/dns-peering/verify-pub-priv-ip.sh ${domain} --short", returnStatus: true)

if (status == 0) {
    echo "检测到公网域名，启用 Squid 代理模式"
    // 执行公网出口配置逻辑
} else if (status == 1) {
    echo "检测到私网域名，启用 DNS Peering / 直接路由模式"
    // 执行内部私有链路配置逻辑
} else {
    error "无法确定域名类型，请人工核查"
}
```

---
*Generated by Alma @ 2026-01-01*
