# GCP Cloud DNS è®°å½•æ‰¹é‡åˆ é™¤è„šæœ¬ä½¿ç”¨è¯´æ˜

## æ ¸å¿ƒè®¾è®¡ç†å¿µ

### âš ï¸ é‡è¦åŒºåˆ«

ä¸æ·»åŠ è„šæœ¬ä¸åŒ,åˆ é™¤è„šæœ¬**ä¸ä¾èµ– `host` å‘½ä»¤é‡æ–°è§£æåŸŸå**,è€Œæ˜¯:

> **ç›´æ¥æŸ¥è¯¢ Cloud DNS Zone ä¸­å·²å­˜åœ¨çš„è®°å½•å¹¶åˆ é™¤**

è¿™æ ·è®¾è®¡çš„åŸå› :
- âœ… åˆ é™¤çš„æ˜¯ä½ ä¹‹å‰æ·»åŠ çš„è®°å½•,è€Œä¸æ˜¯å½“å‰è§£æç»“æœ
- âœ… å³ä½¿å¤–éƒ¨ DNS å·²ç»å˜åŒ–,ä¹Ÿèƒ½å‡†ç¡®åˆ é™¤ Zone ä¸­çš„æ—§è®°å½•
- âœ… é¿å…å›  DNS è§£æå˜åŒ–å¯¼è‡´åˆ é™¤é”™è¯¯çš„è®°å½•

## å·¥ä½œåŸç†

```mermaid
graph TD
    A["æä¾›åŸŸååˆ—è¡¨"] --> B["æŸ¥è¯¢ Cloud DNS Zone"]
    B --> C["æ‰¾åˆ°è¯¥åŸŸåçš„æ‰€æœ‰è®°å½•"]
    C --> D["è¿½è¸ªå®Œæ•´ CNAME é“¾"]
    D --> E["é€†åºåˆ é™¤<br/>(å…ˆ A è®°å½•,å CNAME)"]
    E --> F["éªŒè¯åˆ é™¤ç»“æœ"]
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# é¢„è§ˆæ¨¡å¼(æ¨èå…ˆä½¿ç”¨)
./dnsrecord-del-script.sh -n

# å®é™…åˆ é™¤
./dnsrecord-del-script.sh

# æŒ‡å®šé¡¹ç›®å’Œ Zone
./dnsrecord-del-script.sh -p my-project -z my-zone

# é¢„è§ˆæŒ‡å®š Zone çš„åˆ é™¤
./dnsrecord-del-script.sh -z custom-zone -n

# æ˜¾ç¤ºå¸®åŠ©
./dnsrecord-del-script.sh -h
```

## é…ç½®è¯´æ˜

### ç¼–è¾‘åŸŸååˆ—è¡¨

```bash
# éœ€è¦åˆ é™¤çš„åŸŸååˆ—è¡¨
DOMAINS=(
    "login.microsoft.com"
    "graph.microsoft.com"
    "www.example.com"
)
```

**æ³¨æ„**: åªéœ€è¦æä¾›æœ€åˆæ·»åŠ çš„åŸŸå,è„šæœ¬ä¼šè‡ªåŠ¨æ‰¾åˆ°æ‰€æœ‰ç›¸å…³çš„ CNAME é“¾å’Œ A è®°å½•ã€‚

## åˆ é™¤é€»è¾‘

### 1. æŸ¥æ‰¾é˜¶æ®µ

è„šæœ¬ä¼šåœ¨ Cloud DNS Zone ä¸­æŸ¥æ‰¾:
- æŒ‡å®šåŸŸåçš„ CNAME è®°å½•
- CNAME æŒ‡å‘çš„ä¸‹ä¸€è·³è®°å½•
- æœ€ç»ˆçš„ A è®°å½•

### 2. åˆ é™¤é¡ºåº

**é€†åºåˆ é™¤** (ä»åå¾€å‰):
```
A è®°å½• (æœ€åä¸€è·³)
  â†“
CNAME è®°å½• (ä¸­é—´è·³)
  â†“
CNAME è®°å½• (ç¬¬ä¸€è·³)
```

è¿™æ ·å¯ä»¥é¿å…åˆ é™¤é¡ºåºå¯¼è‡´çš„ä¾èµ–é—®é¢˜ã€‚

## è¾“å‡ºç¤ºä¾‹

### é¢„è§ˆæ¨¡å¼

```
========================================
GCP Cloud DNS è®°å½•æ‰¹é‡åˆ é™¤å·¥å…· [é¢„è§ˆæ¨¡å¼]
========================================
é¡¹ç›® ID: my-project
DNS Zone: private-access
åŸŸåæ•°é‡: 2
æ¨¡å¼: é¢„è§ˆæ¨¡å¼ (ä¸ä¼šå®é™…åˆ é™¤)

========================================
å¤„ç†åŸŸå: login.microsoft.com
========================================
æŸ¥æ‰¾åŸŸåç›¸å…³è®°å½•: login.microsoft.com
  æ‰¾åˆ° CNAME è®°å½•: login.microsoft.com. -> login.mso.msidentity.com.
  æ‰¾åˆ° CNAME è®°å½•: login.mso.msidentity.com. -> ak.privatelink.msidentity.com.
  æ‰¾åˆ° A è®°å½•: ak.privatelink.msidentity.com. -> 20.190.160.1

[é¢„è§ˆæ¨¡å¼] å°†è¦åˆ é™¤ä»¥ä¸‹è®°å½•:
  A è®°å½•: ak.privatelink.msidentity.com. (TTL: 300) -> 20.190.160.1
    [é¢„è§ˆ] å°†åˆ é™¤æ­¤è®°å½•
  CNAME è®°å½•: login.mso.msidentity.com. (TTL: 300) -> ak.privatelink.msidentity.com.
    [é¢„è§ˆ] å°†åˆ é™¤æ­¤è®°å½•
  CNAME è®°å½•: login.microsoft.com. (TTL: 300) -> login.mso.msidentity.com.
    [é¢„è§ˆ] å°†åˆ é™¤æ­¤è®°å½•
  å¤„ç†äº† 3 æ¡è®°å½•

========================================
é¢„è§ˆå®Œæˆ
========================================
æ€»åŸŸåæ•°: 2
æˆåŠŸå¤„ç†: 2
å¤±è´¥: 0
å°†åˆ é™¤è®°å½•æ•°: 6

è¿™æ˜¯é¢„è§ˆæ¨¡å¼,æ²¡æœ‰å®é™…åˆ é™¤ä»»ä½•è®°å½•
å¦‚éœ€å®é™…åˆ é™¤,è¯·å»æ‰ -n å‚æ•°é‡æ–°è¿è¡Œ
```

### å®é™…åˆ é™¤æ¨¡å¼

```
========================================
GCP Cloud DNS è®°å½•æ‰¹é‡åˆ é™¤å·¥å…·
========================================

åˆ é™¤ login.microsoft.com çš„ DNS è®°å½•...
  A è®°å½•: ak.privatelink.msidentity.com. (TTL: 300) -> 20.190.160.1
    âœ“ æˆåŠŸåˆ é™¤
  CNAME è®°å½•: login.mso.msidentity.com. (TTL: 300) -> ak.privatelink.msidentity.com.
    âœ“ æˆåŠŸåˆ é™¤
  CNAME è®°å½•: login.microsoft.com. (TTL: 300) -> login.mso.msidentity.com.
    âœ“ æˆåŠŸåˆ é™¤
  å¤„ç†äº† 3 æ¡è®°å½•

éªŒè¯åˆ é™¤ç»“æœ...
âœ“ ç¡®è®¤æ‰€æœ‰ç›¸å…³è®°å½•å·²åˆ é™¤

========================================
åˆ é™¤å®Œæˆ
========================================
æ€»åŸŸåæ•°: 2
æˆåŠŸå¤„ç†: 2
å¤±è´¥: 0
å·²åˆ é™¤è®°å½•æ•°: 6
========================================
```

## å®‰å…¨ç‰¹æ€§

### 1. é¢„è§ˆæ¨¡å¼ (`-n`)

**å¼ºçƒˆå»ºè®®å…ˆä½¿ç”¨é¢„è§ˆæ¨¡å¼**:
```bash
./dnsrecord-del-script.sh -n
```

é¢„è§ˆæ¨¡å¼ä¼š:
- âœ… æ˜¾ç¤ºå°†è¦åˆ é™¤çš„æ‰€æœ‰è®°å½•
- âœ… ä¸å®é™…æ‰§è¡Œåˆ é™¤æ“ä½œ
- âœ… è®©ä½ ç¡®è®¤åˆ é™¤å†…å®¹æ˜¯å¦æ­£ç¡®

### 2. éªŒè¯åˆ é™¤

åˆ é™¤åè‡ªåŠ¨éªŒè¯:
- æ£€æŸ¥è®°å½•æ˜¯å¦çœŸçš„è¢«åˆ é™¤
- æ˜¾ç¤ºä»»ä½•æ®‹ç•™çš„è®°å½•

### 3. å¾ªç¯æ£€æµ‹

è„šæœ¬åŒ…å«å¾ªç¯æ£€æµ‹æœºåˆ¶,é¿å… CNAME å¾ªç¯å¯¼è‡´çš„æ— é™é€’å½’ã€‚

## å¸¸è§åœºæ™¯

### åœºæ™¯ 1: æ¸…ç†æ—§çš„å¤–éƒ¨ä¾èµ–è®°å½•

```bash
# 5 å¤©å‰æ·»åŠ çš„è®°å½•
DOMAINS=(
    "old-api.example.com"
    "deprecated-service.com"
)

# é¢„è§ˆ
./dnsrecord-del-script.sh -n

# ç¡®è®¤ååˆ é™¤
./dnsrecord-del-script.sh
```

### åœºæ™¯ 2: æ‰¹é‡æ¸…ç†æµ‹è¯•è®°å½•

```bash
DOMAINS=(
    "test1.example.com"
    "test2.example.com"
    "test3.example.com"
)

./dnsrecord-del-script.sh
```

### åœºæ™¯ 3: åªåˆ é™¤ç‰¹å®š Zone çš„è®°å½•

```bash
./dnsrecord-del-script.sh -z test-zone
```

## æ³¨æ„äº‹é¡¹

### âš ï¸ é‡è¦æé†’

1. **å…ˆé¢„è§ˆ**: å§‹ç»ˆå…ˆä½¿ç”¨ `-n` å‚æ•°é¢„è§ˆ
2. **ç¡®è®¤åŸŸå**: ç¡®ä¿åŸŸååˆ—è¡¨æ­£ç¡®
3. **Zone é€‰æ‹©**: ç¡®è®¤æ“ä½œçš„æ˜¯æ­£ç¡®çš„ Zone
4. **æƒé™è¦æ±‚**: éœ€è¦ Cloud DNS åˆ é™¤æƒé™

### ğŸ” æ•…éšœæ’é™¤

#### é—®é¢˜: "æœªæ‰¾åˆ°ç›¸å…³è®°å½•"

**åŸå› **: 
- åŸŸååœ¨ Zone ä¸­ä¸å­˜åœ¨
- åŸŸåæ‹¼å†™é”™è¯¯
- è®°å½•å·²ç»è¢«åˆ é™¤

**è§£å†³**:
```bash
# æ‰‹åŠ¨æŸ¥çœ‹ Zone ä¸­çš„æ‰€æœ‰è®°å½•
gcloud dns record-sets list --zone=private-access
```

#### é—®é¢˜: "åˆ é™¤å¤±è´¥"

**å¯èƒ½åŸå› **:
- æƒé™ä¸è¶³
- è®°å½•è¢«å…¶ä»–è®°å½•å¼•ç”¨
- Zone è¢«é”å®š

**è§£å†³**:
```bash
# æ£€æŸ¥æƒé™
gcloud projects get-iam-policy PROJECT_ID

# æ‰‹åŠ¨åˆ é™¤å•æ¡è®°å½•
gcloud dns record-sets delete DOMAIN. \
    --type=CNAME \
    --zone=private-access
```

## ä¸æ·»åŠ è„šæœ¬çš„å¯¹æ¯”

| ç‰¹æ€§ | æ·»åŠ è„šæœ¬ | åˆ é™¤è„šæœ¬ |
|------|---------|---------|
| DNS è§£æ | âœ… ä½¿ç”¨ `host` å‘½ä»¤ | âŒ ä¸ä½¿ç”¨ |
| æ•°æ®æ¥æº | å…¬ç½‘ DNS | Cloud DNS Zone |
| é‡å¤æ£€æŸ¥ | è·³è¿‡å·²å­˜åœ¨ | æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³ |
| é¡ºåº | æ­£åºæ·»åŠ  | é€†åºåˆ é™¤ |
| é¢„è§ˆæ¨¡å¼ | âŒ æ—  | âœ… æœ‰ (`-n`) |

## æœ€ä½³å®è·µ

### æ¨èå·¥ä½œæµç¨‹

```bash
# 1. å…ˆé¢„è§ˆ
./dnsrecord-del-script.sh -n

# 2. æ£€æŸ¥è¾“å‡º,ç¡®è®¤è¦åˆ é™¤çš„è®°å½•

# 3. å®é™…åˆ é™¤
./dnsrecord-del-script.sh

# 4. éªŒè¯ç»“æœ
gcloud dns record-sets list --zone=private-access
```

### ä¿å­˜åˆ é™¤æ—¥å¿—

```bash
./dnsrecord-del-script.sh 2>&1 | tee dns-delete-$(date +%Y%m%d).log
```

## ç›¸å…³å‘½ä»¤

```bash
# æŸ¥çœ‹ Zone ä¸­çš„æ‰€æœ‰è®°å½•
gcloud dns record-sets list --zone=private-access

# æŸ¥çœ‹ç‰¹å®šåŸŸåçš„è®°å½•
gcloud dns record-sets list \
    --zone=private-access \
    --filter="name:example.com"

# æ‰‹åŠ¨åˆ é™¤å•æ¡è®°å½•
gcloud dns record-sets delete example.com. \
    --type=CNAME \
    --zone=private-access
```
