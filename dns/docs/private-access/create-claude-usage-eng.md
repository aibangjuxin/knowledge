# create-claude.sh Usage Documentation

This document details the functionality, usage, and core internal logic of the `create-claude.sh` script, particularly focusing on the special handling for DNS record import and export.

## 1. Script Overview

`create-claude.sh` is a tool for migrating GCP Cloud DNS Private Zones. It aims to migrate records from an existing `private-access` zone to a new, environment-specific Private Zone (e.g., `dev-cn-private-access`), while maintaining the original network binding configurations.

### Key Features
- **Multi-Network Binding Support**: Correctly handles and restores multiple VPC networks bound to the zone.
- **High-Performance Bulk Import**: Uses BIND file format and the `import` command, which is several times faster than creating records individually.
- **Intelligent Conflict Handling**: Automatically filters system-generated NS/SOA records to prevent import conflicts.
- **Safety Mechanism**: Automatically attempts to restore the source zone's network bindings if creating the new zone fails.

## 2. Core Logic Explained

The script does not simply copy files between "export" and "import". Instead, it includes key data processing logic to ensure migration success and data accuracy.

### 2.1 Export
The script first exports all DNS records from the source zone.
- **Format**: **BIND Zone File** (RFC 1035)
- **Command**: `gcloud dns record-sets export --zone-file-format`
- **Reason**: BIND format is the standard DNS format, natively supported by `gcloud`, and easier for text processing than JSON/YAML.

### 2.2 Filtering and Preprocessing
This is the most critical step of the script. Directly importing exported files will fail because newly created zones are automatically assigned default `SOA` (Start of Authority) and `NS` (Name Server) records by GCP.

Before importing, the script processes the BIND file using `awk` to generate a **filtered temporary file**:
1.  **Remove SOA Records**: Discard all records of type `SOA`, keeping the SOA automatically generated by the new zone.
2.  **Remove Root NS Records**: Discard `NS` records for the zone root domain (e.g., `example.com.`).
    *   *Note*: Subdomain NS records (delegations, e.g., NS for `sub.example.com.`) are **retained** because these are user-defined configurations.
3.  **Retain Other Records**: All user data such as A, CNAME, TXT, MX records are retained as-is.

### 2.3 Bulk Import
Import using the filtered file.
- **Command**: `gcloud dns record-sets import --zone-file-format --delete-all-existing`
- **--delete-all-existing**: This parameter appears dangerous, but it actually ensures that the "originally empty" new zone can accept the import.
    - It **will not** delete GCP-managed system records (default NS/SOA).
    - It **will** clear any user-created records (though the new zone is originally empty, this ensures operation idempotency).
- **Advantage**: Compared to looping calls to `gcloud ... create`, this method completes all record submissions in a single API call, greatly reducing time and throttling risk.

### 2.4 Multi-Network Binding
The script can identify multiple VPC networks bound to the source zone (e.g., both `dev` and `prod` networks are bound).
- **Logic**: Get all network URLs -> Build a comma-separated list -> Create zone using `--networks=url1,url2` parameter.
- **Fix**: Resolves the issue in previous versions where using multiple `--networks` parameters caused only the last one to take effect.

## 3. Usage

### Command Line Arguments

```bash
./create-claude.sh -e ENVIRONMENT [options]
```

| Parameter | Description | Required | Example |
| :--- | :--- | :--- | :--- |
| `-e` | Environment identifier (defined in the script's `env_info` array) | Yes | `-e dev-cn` |
| `-s` | Source zone name (default is `private-access`) | No | `-s my-custom-zone` |

### Examples

**1. Migrate to dev-cn environment**
```bash
./create-claude.sh -e dev-cn
```

**2. Migrate from custom zone**
```bash
./create-claude.sh -e lex-in -s old-private-zone
```

## 4. Verification and Troubleshooting

After execution, the script automatically performs the following verifications:
1.  **Record Count Comparison**: Compare total record counts between source file and target zone.
2.  **Content Difference Comparison**: If counts match, further compare differences in record content (ignoring NS/SOA).
3.  **Logs**:
    - Export file: `/tmp/{zone}-records-{timestamp}.txt` (BIND format)
    - Import filtered file: `/tmp/{zone}-import-{timestamp}.txt` (filtered BIND file)
    - Failure log: `/tmp/{zone}-failed-{timestamp}.log` (if any)

If problems arise, you can check these intermediate files in the `/tmp/` directory to troubleshoot whether the filtering logic meets expectations.