- [**é—®é¢˜åˆ†æï¼ˆä¸ºä½•è¦è¯¦ç»†è§£é‡Šè¿™ä¸ªå¤šé˜¶æ®µ Dockerfileï¼‰**](#é—®é¢˜åˆ†æä¸ºä½•è¦è¯¦ç»†è§£é‡Šè¿™ä¸ªå¤šé˜¶æ®µ-dockerfile)
- [**æœ€ç»ˆæ¨è Dockerfileï¼ˆå¸¦æ³¨é‡Š â€” å¯ç›´æ¥å¤åˆ¶ä½¿ç”¨ï¼‰**](#æœ€ç»ˆæ¨è-dockerfileå¸¦æ³¨é‡Š--å¯ç›´æ¥å¤åˆ¶ä½¿ç”¨)
- [**æ¯ä¸€éƒ¨åˆ†è¯¦ç»†è§£é‡Š**](#æ¯ä¸€éƒ¨åˆ†è¯¦ç»†è§£é‡Š)
- [**å¯é€‰å˜ä½“ï¼ˆæ ¹æ®å·¥ç¨‹ä¸åŒåœºæ™¯ï¼‰**](#å¯é€‰å˜ä½“æ ¹æ®å·¥ç¨‹ä¸åŒåœºæ™¯)
  - [**1ï¼‰æºç åœ¨é•œåƒå†…æ„å»ºï¼ˆä¸æ¨èåœ¨ç”Ÿäº§ Dockerfile åšï¼‰**](#1æºç åœ¨é•œåƒå†…æ„å»ºä¸æ¨èåœ¨ç”Ÿäº§-dockerfile-åš)
  - [**2ï¼‰Spring Boot åˆ†å±‚ï¼ˆæœ€ä½³å®è·µï¼‰**](#2spring-boot-åˆ†å±‚æœ€ä½³å®è·µ)
  - [**3ï¼‰ä½¿ç”¨**](#3ä½¿ç”¨)
  - [**gcr.io/distroless/java17:debug**](#gcriodistrolessjava17debug)
  - [**ï¼ˆä»…è°ƒè¯•ç”¨ï¼‰**](#ä»…è°ƒè¯•ç”¨)
- [**æ„å»º / è¿è¡Œ / æœ¬åœ°æµ‹è¯•å‘½ä»¤ï¼ˆç¤ºä¾‹ï¼‰**](#æ„å»º--è¿è¡Œ--æœ¬åœ°æµ‹è¯•å‘½ä»¤ç¤ºä¾‹)
- [**åœ¨ GKE ä¸Šéƒ¨ç½²çš„æ³¨æ„ç‚¹ï¼ˆChecklistï¼‰**](#åœ¨-gke-ä¸Šéƒ¨ç½²çš„æ³¨æ„ç‚¹checklist)
- [**æ•…éšœæ’æŸ¥ï¼ˆdistroless å¸¸è§é—®é¢˜ä¸è§£å†³ï¼‰**](#æ•…éšœæ’æŸ¥distroless-å¸¸è§é—®é¢˜ä¸è§£å†³)
- [**å®‰å…¨ä¸æ‰«æå»ºè®®**](#å®‰å…¨ä¸æ‰«æå»ºè®®)
- [**æ€§èƒ½ä¸ä½“ç§¯å¯¹æ¯”ï¼ˆæœŸæœ›ï¼‰**](#æ€§èƒ½ä¸ä½“ç§¯å¯¹æ¯”æœŸæœ›)
- [**æ£€æŸ¥æ¸…å•ï¼ˆDeployment å‰å¿…é¡»ç¡®è®¤ï¼‰**](#æ£€æŸ¥æ¸…å•deployment-å‰å¿…é¡»ç¡®è®¤)
- [**å°ç»“ä¸å»ºè®®ï¼ˆå®è·µå»ºè®®ï¼‰**](#å°ç»“ä¸å»ºè®®å®è·µå»ºè®®)
- [**å¤šé˜¶æ®µ Dockerfile è¯¦è§£**](#å¤šé˜¶æ®µ-dockerfile-è¯¦è§£)
  - [**1. é—®é¢˜åˆ†æ**](#1-é—®é¢˜åˆ†æ)
- [**2. æ¨èçš„å¤šé˜¶æ®µ Dockerfileï¼ˆç¤ºä¾‹ï¼‰**](#2-æ¨èçš„å¤šé˜¶æ®µ-dockerfileç¤ºä¾‹)
- [**3. æ¯ä¸€é˜¶æ®µè¯¦ç»†è§£é‡Š**](#3-æ¯ä¸€é˜¶æ®µè¯¦ç»†è§£é‡Š)
  - [**3.1 é˜¶æ®µ 1ï¼šä¾èµ–ç¼“å­˜ï¼ˆdepsï¼‰**](#31-é˜¶æ®µ-1ä¾èµ–ç¼“å­˜deps)
    - [**âœ“ ç›®çš„**](#-ç›®çš„)
    - [**âœ“ å…³é”®ç‚¹è¯´æ˜**](#-å…³é”®ç‚¹è¯´æ˜)
    - [**âœ“ ä¼˜ç‚¹**](#-ä¼˜ç‚¹)
  - [**3.2 é˜¶æ®µ 2ï¼šæ„å»ºé˜¶æ®µï¼ˆbuilderï¼‰**](#32-é˜¶æ®µ-2æ„å»ºé˜¶æ®µbuilder)
    - [**âœ“ ç›®çš„**](#-ç›®çš„-1)
    - [**âœ“ å…³é”®ç‚¹è¯´æ˜**](#-å…³é”®ç‚¹è¯´æ˜-1)
    - [**è§£é‡Šï¼š**](#è§£é‡Š)
    - [**âœ“ ä¸ºä»€ä¹ˆä¸è¦åœ¨æœ€ç»ˆé•œåƒä¸­å®‰è£… Mavenï¼Ÿ**](#-ä¸ºä»€ä¹ˆä¸è¦åœ¨æœ€ç»ˆé•œåƒä¸­å®‰è£…-maven)
  - [**3.3 é˜¶æ®µ 3ï¼šè¿è¡Œé•œåƒï¼ˆruntimeï¼‰**](#33-é˜¶æ®µ-3è¿è¡Œé•œåƒruntime)
    - [**âœ“ ç›®çš„**](#-ç›®çš„-2)
    - [**å…³é”®ç‚¹è¯´æ˜**](#å…³é”®ç‚¹è¯´æ˜)
    - [**ä¸ºä»€ä¹ˆåªç”¨ JREï¼Ÿ**](#ä¸ºä»€ä¹ˆåªç”¨-jre)
    - [**è¿è¡Œé•œåƒçš„ä¸‰ä¸ªé‡è¦å¥½å¤„**](#è¿è¡Œé•œåƒçš„ä¸‰ä¸ªé‡è¦å¥½å¤„)
- [**4. Mermaid æµç¨‹å›¾**](#4-mermaid-æµç¨‹å›¾)
- [**5. æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ**](#5-æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ)
  - [**â‘  æ„å»ºå‰åŠ¡å¿…æ£€æŸ¥æ–‡ä»¶æƒé™**](#-æ„å»ºå‰åŠ¡å¿…æ£€æŸ¥æ–‡ä»¶æƒé™)
  - [**â‘¡ CI ç¯å¢ƒå»ºè®®å¯ç”¨å±‚ç¼“å­˜**](#-ci-ç¯å¢ƒå»ºè®®å¯ç”¨å±‚ç¼“å­˜)
  - [**â‘¢ ç”Ÿäº§é•œåƒåº”ä¿æŒæœ€å°åŒ–**](#-ç”Ÿäº§é•œåƒåº”ä¿æŒæœ€å°åŒ–)
  - [**â‘£ ä½¿ç”¨ JRE è€Œä¸æ˜¯ JDKï¼ˆé™¤ééœ€è¦ç¼–è¯‘åŠ¨æ€ç±»ï¼‰**](#-ä½¿ç”¨-jre-è€Œä¸æ˜¯-jdké™¤ééœ€è¦ç¼–è¯‘åŠ¨æ€ç±»)
  - [**â‘¤ ä¿æŒ**](#-ä¿æŒ)
  - [**.dockerignore**](#dockerignore)
  - [**å¹²å‡€**](#å¹²å‡€)
- [**å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥å¸®ä½ ç”Ÿæˆï¼š**](#å¦‚æœä½ æ„¿æ„æˆ‘å¯ä»¥è¿›ä¸€æ­¥å¸®ä½ ç”Ÿæˆ)

# **é—®é¢˜åˆ†æï¼ˆä¸ºä½•è¦è¯¦ç»†è§£é‡Šè¿™ä¸ªå¤šé˜¶æ®µ Dockerfileï¼‰**

ä½ è¦æŠŠå½“å‰åŸºäº Debian çš„é•œåƒè¿ç§»åˆ° **distroless + multistage build**ã€‚å¤šé˜¶æ®µæ„å»ºæŠŠâ€œæ„å»ºç¯å¢ƒâ€ï¼ˆåŒ…å« JDKã€æ„å»ºå·¥å…·ï¼‰å’Œâ€œè¿è¡Œç¯å¢ƒâ€ï¼ˆæœ€å°è¿è¡Œé•œåƒï¼‰åˆ†ç¦»ï¼šæ„å»ºæ—¶äº§å‡º artifactï¼ˆå¦‚ app.jar æˆ–åˆ†å±‚ artifactï¼‰ï¼Œè¿è¡Œæ—¶åªæŠŠè¿è¡Œæ‰€éœ€æ–‡ä»¶æ‹·è´è¿›å»ï¼Œä»è€Œå¾—åˆ°æ›´å°ã€æ›´å®‰å…¨çš„é•œåƒã€‚ä¸‹é¢å¯¹æˆ‘ç»™å‡ºçš„æ¨è Dockerfile åšé€è¡Œã€é€å—çš„è¯¦ç»†è§£é‡Šã€å˜ä½“ã€æ³¨æ„äº‹é¡¹ä¸è°ƒè¯•å»ºè®®ï¼Œä¿è¯ä½ èƒ½ç›´æ¥ç…§ç€è½åœ°å¹¶æŠŠæ½œåœ¨é—®é¢˜éƒ½è€ƒè™‘åˆ°ã€‚

---

# **æœ€ç»ˆæ¨è Dockerfileï¼ˆå¸¦æ³¨é‡Š â€” å¯ç›´æ¥å¤åˆ¶ä½¿ç”¨ï¼‰**

```dockerfile
# ----- Stage 1: Builder -----
FROM eclipse-temurin:17-jdk as builder

# å¯é€šè¿‡ build-arg ä¼ å…¥
ARG API_NAME
ARG API_VERSION

WORKDIR /build

# å°†æ„å»ºå¥½çš„ fat jar å¤åˆ¶åˆ°æ„å»ºé•œåƒï¼ˆå‡å¦‚ä½ å·²ç»åœ¨ CI é‡Œæ„å»ºå¥½äº† jarï¼‰
# å¦‚æœä½ åœ¨æœ¬åœ°é€šè¿‡ docker build æ„å»ºï¼Œå¯ä»¥å…ˆæŠŠ jar æ”¾åœ¨æ„å»ºä¸Šä¸‹æ–‡
COPY ${API_NAME}-${API_VERSION}.jar app.jar

# å¯é€‰ï¼šå¦‚æœæ˜¯ Spring Boot å¯åˆ©ç”¨ layertools æŠŠ jar è§£å±‚ï¼Œå‡å°‘ä¹‹åå¤åˆ¶åˆ°è¿è¡Œé•œåƒçš„å¤§å°å’Œå±‚æ•°é‡
# æ³¨æ„ï¼šlayertools éœ€è¦ Spring Boot å¯ç”¨ï¼ˆ2.3+ çš„ jarmode=layertools æ”¯æŒï¼‰
RUN java -Djarmode=layertools -jar app.jar extract

# ----- Stage 2: Runtime (distroless) -----
# ä½¿ç”¨ Google çš„ distroless Java17 é root è¿è¡Œé•œåƒ
FROM gcr.io/distroless/java17:nonroot

# æŒ‡å®šé root ç”¨æˆ·ï¼ˆé•œåƒå†…å·²ç»å£°æ˜ nonrootï¼Œä»å¯æ˜¾å¼è®¾ç½® uidï¼‰
USER 3000:3000
WORKDIR /app

# å°†æœ€ç»ˆ artifact å¤åˆ¶åˆ°è¿è¡Œé•œåƒ
# å¦‚æœä½¿ç”¨ layertoolsï¼Œå¯èƒ½éœ€è¦å¤åˆ¶ /build/dependencies /build/spring-boot-loader /build/snapshot-dependencies /build/application ç­‰ç›®å½•
COPY --from=builder /build/app.jar /app/app.jar

# Distroless æ—  shellï¼Œå¿…é¡»ä½¿ç”¨ JSON array å½¢å¼ ENTRYPOINT
ENTRYPOINT ["java","-jar","/app/app.jar"]
```

---

# **æ¯ä¸€éƒ¨åˆ†è¯¦ç»†è§£é‡Š**

```bash
## **Stage 1 â€”**Â 

## **FROM eclipse-temurin:17-jdk as builder**

- **ä½œç”¨**ï¼šè¿™æ˜¯æ„å»ºé˜¶æ®µçš„åŸºç¡€é•œåƒï¼ŒåŒ…å«å®Œæ•´ JDKï¼Œç”¨äºè¿è¡Œ layertools æˆ–åœ¨ CI ä¸­å¯¹ jar åšå¤„ç†ï¼æ„å»ºäºŒè¿›åˆ¶ã€‚

- **ä¸ºä»€ä¹ˆé€‰ temurin**ï¼šTemurinï¼ˆEclipse Temurinï¼‰æ˜¯å¸¸ç”¨çš„å¼€æº JDK å‘è¡Œç‰ˆï¼Œä½“ç§¯æ¯”å®˜æ–¹ Oracle JDK æ›´å‹å¥½ï¼Œå…¼å®¹æ€§å¥½ã€‚ä½ ä¹Ÿå¯ä»¥ç”¨ maven:3.8-openjdk-17 æˆ–è€… gradle:jdk17ï¼Œå¦‚æœéœ€è¦åœ¨é•œåƒå†…åšæºç æ„å»ºï¼ˆmvn packageï¼‰ã€‚

- **åˆ«å** **as builder**ï¼šæ ‡è¯†è¿™æ˜¯ç¬¬ä¸€é˜¶æ®µï¼Œåé¢ç”¨ --from=builder å¼•ç”¨ã€‚




## **ARG API_NAME / API_VERSION**## Â **ä¸**Â ## **WORKDIR /build**

- ARGï¼šåœ¨ docker build æ—¶é€šè¿‡ --build-arg API_NAME=... æ³¨å…¥ï¼Œæ–¹ä¾¿å¤ç”¨æ¨¡æ¿ã€‚

- WORKDIRï¼šæŠŠæ„å»ºä¸Šä¸‹æ–‡ç›®å½•è®¾ä¸º /buildï¼Œç»Ÿä¸€æ–‡ä»¶è·¯å¾„ã€‚




## **COPY ${API_NAME}-${API_VERSION}.jar app.jar**

- **å‡è®¾**ï¼šCI å·²ç»æŠŠ jar äº§ç‰©æ”¾åˆ° Docker build çš„ä¸Šä¸‹æ–‡å†…ï¼ˆä¾‹å¦‚ target/ï¼‰ï¼Œæˆ–è€…ä½ æŠŠ jar æ”¾åˆ° repo æ ¹ã€‚

- **å¯æ›¿ä»£æ–¹æ¡ˆ**ï¼š

    - å¦‚æœ CI åœ¨é•œåƒå†…åš mvn packageï¼šåœ¨ builder é˜¶æ®µå…ˆ COPY pom.xml .ã€COPY src ./src å¹¶æ‰§è¡Œ mvn -DskipTests packageï¼ˆæ³¨æ„ä¼šå¢åŠ æ„å»ºæ—¶é—´ï¼‰ã€‚

    - æ¨èåšæ³•ï¼šåœ¨ CIï¼ˆå¦‚ Cloud Build / GitLab CIï¼‰å…ˆæ„å»º jarï¼Œå†åœ¨ Dockerfile ä¸­åªå¤åˆ¶ jarï¼ˆæ›´å¿«ã€æ›´ç¨³å®šï¼‰ã€‚





## **RUN java -Djarmode=layertools -jar app.jar extract**

- **ç›®çš„**ï¼šå¯¹ Spring Boot fat-jar åšâ€œåˆ†å±‚æå–â€ï¼ˆlayersï¼‰ï¼Œç”Ÿæˆ dependencies/ spring-boot-loader/ application/ ç­‰ç›®å½•ï¼Œä»è€Œåœ¨ runtime é˜¶æ®µåªå¤åˆ¶å¿…è¦å±‚ï¼Œæ˜¾è‘—å‡å°‘é‡å»ºæ—¶çš„é•œåƒå±‚å˜åŒ–ä¸æ‹‰å–ä½“ç§¯ã€‚

- **å‰æ**ï¼šä»…åœ¨ Spring Boot å¯ç”¨ä¸”ä½ äº§ç‰©æ˜¯ Spring Boot å¯æ‰§è¡Œ jar æ—¶ä½¿ç”¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

- **å¦‚æœé Spring Boot**ï¼šè·³è¿‡è¿™ä¸ªæ­¥éª¤ï¼Œç›´æ¥ COPY jar å³å¯ã€‚


---

## **Stage 2 â€”**Â 

## **FROM gcr.io/distroless/java17:nonroot**

- **Distroless é•œåƒç‰¹æ€§**ï¼š

    - ä¸åŒ…å« shellã€åŒ…ç®¡ç†å™¨ã€å¸¸è§ linux å·¥å…·ã€‚åªç•™ä¸‹è¿è¡Œæ—¶æ‰€éœ€çš„æœ€å°åº“ï¼ˆglibc / JREï¼‰ã€‚

    - :nonroot é€šå¸¸ä¼šé¢„ç½®ä¸€ä¸ªé root ç”¨æˆ·å¹¶åšå¥½æƒé™æ§åˆ¶ï¼Œä½†ä¸ºäº†ç¡®å®šè¿è¡Œ UIDï¼Œæˆ‘ä»¬ä»æ˜¾å¼ USER 3000:3000ã€‚


- **é•œåƒæ¥æº**ï¼šgcr.io/distroless æ˜¯ Google æä¾›çš„ distroless é•œåƒä»“åº“ï¼Œä¹Ÿå¯ç”¨ gcr.io/distroless/java:17 ç­‰ã€‚




## **USER 3000:3000**

## Â **/**Â 

## **WORKDIR /app**

- **ä¸ºä»€ä¹ˆæ˜¾å¼è®¾ç½® UID**ï¼š

    - åœ¨ Kubernetes ä¸­æ¨èä½¿ç”¨ runAsNonRoot / runAsUser ç­–ç•¥ï¼›è‹¥é•œåƒå†…æ²¡æœ‰ä½ éœ€è¦çš„ UIDï¼Œæœ€å¥½æ˜¾å¼è®¾ç½®ã€‚

    - ä¿è¯æŒ‚è½½å·ï¼ˆConfigMapã€Secretï¼‰æˆ–æŒä¹…åŒ–å·çš„æƒé™èƒ½è¢«å®¹å™¨è¿›ç¨‹è®¿é—®ã€‚


- **è·¯å¾„å»ºè®®**ï¼šæŠŠ application æ”¾åœ¨ /app æˆ– /opt/appï¼Œä¿æŒä¸€è‡´æ€§ã€‚




## **COPY --from=builder /build/app.jar /app/app.jar**

- **æ³¨æ„**ï¼šå¦‚æœä½¿ç”¨ layertools æå–äº†å±‚ï¼ˆ/build/dependencies ç­‰ï¼‰ï¼Œå»ºè®®æŠŠè¿™äº›ç›®å½•æŒ‰æ­£ç¡®ç»“æ„å¤åˆ¶è¿‡å»å¹¶ä½¿ç”¨ java -cp æˆ– Spring Boot çš„ launcher å¯åŠ¨æ–¹å¼ï¼Œä»¥å……åˆ†åˆ©ç”¨å±‚åŒ–ä¼˜åŠ¿ã€‚ä¾‹å¦‚ï¼š



COPY --from=builder /build/dependencies/ /app/dependencies/
COPY --from=builder /build/spring-boot-loader/ /app/spring-boot-loader/
COPY --from=builder /build/snapshot-dependencies/ /app/snapshot-dependencies/
COPY --from=builder /build/application/ /app/application/
ENTRYPOINT ["java","-cp","/app/dependencies:/app/spring-boot-loader:/app/application","org.springframework.boot.loader.JarLauncher"]
```

-
- **ç®€å•æ€§ä¼˜å…ˆ**ï¼šå¦‚æœä½ ä¸æƒ³å¤„ç†å¤æ‚çš„ classpathï¼Œå¯ç›´æ¥ app.jar ä¸€ä½“åŒ–å¤åˆ¶å¹¶ java -jar å¯åŠ¨ã€‚

```bash
## **ENTRYPOINT ["java","-jar","/app/app.jar"]**

```

â‰ˆ

---

# **å¯é€‰å˜ä½“ï¼ˆæ ¹æ®å·¥ç¨‹ä¸åŒåœºæ™¯ï¼‰**

### **1ï¼‰æºç åœ¨é•œåƒå†…æ„å»ºï¼ˆä¸æ¨èåœ¨ç”Ÿäº§ Dockerfile åšï¼‰**

```
FROM maven:3.8-openjdk-17 as builder
WORKDIR /build
COPY pom.xml .
COPY src ./src
RUN mvn -DskipTests package
# åç»­åŒä¸Šä» target/*.jar å¤åˆ¶
```

ä¼˜ç‚¹ï¼šä¸€æ¬¡æ€§å®Œæˆæ„å»ºï¼›ç¼ºç‚¹ï¼šæ„å»ºæ—¶é—´é•¿ã€ç¼“å­˜ç­–ç•¥å¤æ‚ã€CI é€šå¸¸æ›´é€‚åˆåšæ„å»ºã€‚

### **2ï¼‰Spring Boot åˆ†å±‚ï¼ˆæœ€ä½³å®è·µï¼‰**

- åœ¨ builder é‡Œ java -Djarmode=layertools -jar app.jar extract
- runtime å¤åˆ¶åˆ†å±‚ç›®å½•å¹¶ç”¨ JarLauncher å¯åŠ¨ï¼ˆå¯ä»¥æå¤§åˆ©ç”¨é•œåƒå±‚ç¼“å­˜ï¼ŒCI æ¨é€æ—¶èŠ‚çœå¸¦å®½ï¼‰

### **3ï¼‰ä½¿ç”¨**

### **gcr.io/distroless/java17:debug**

### **ï¼ˆä»…è°ƒè¯•ç”¨ï¼‰**

- distroless æœ‰ debug ç‰ˆæœ¬åŒ…å« bash/sh å—ï¼Ÿé€šå¸¸æ²¡æœ‰ã€‚å¦‚æœä½ éœ€è°ƒè¯•å»ºè®®ä¸´æ—¶ç”¨ openjdk slim ä»£æ›¿ distroless åšè°ƒè¯•ï¼Œç„¶åå›åˆ° distroless åšæœ€ç»ˆæ„å»ºã€‚

---

# **æ„å»º / è¿è¡Œ / æœ¬åœ°æµ‹è¯•å‘½ä»¤ï¼ˆç¤ºä¾‹ï¼‰**

```dockerfile
# æ„å»ºï¼ˆåœ¨å« jar çš„ä¸Šä¸‹æ–‡ï¼‰
docker build -t sample-api:distroless \
  --build-arg API_NAME=sample-api \
  --build-arg API_VERSION=1.0.0 .

# æœ¬åœ°è¿è¡Œï¼ˆæ³¨æ„ distroless æ—  shellï¼Œå®¹å™¨å†…æ— æ³• exec äº¤äº’ï¼‰
docker run --rm -p 8080:8080 sample-api:distroless

# æœ¬åœ°æŸ¥çœ‹æ—¥å¿—
docker logs <container_id>

# æŸ¥çœ‹é•œåƒå±‚ä¸å¤§å°
docker image inspect sample-api:distroless --format='{{.Size}}'
docker history sample-api:distroless
```

---

# **åœ¨ GKE ä¸Šéƒ¨ç½²çš„æ³¨æ„ç‚¹ï¼ˆChecklistï¼‰**

- åœ¨ Deployment Spec ä¸­æ·»åŠ ï¼š

```
securityContext:
  runAsNonRoot: true
  runAsUser: 3000
  allowPrivilegeEscalation: false
```

-
- readinessProbe / livenessProbe æŒ‡å‘åº”ç”¨çš„å¥åº·ç«¯ç‚¹ï¼ˆ/actuator/health æˆ–ä½ è‡ªå®šä¹‰çš„ï¼‰ã€‚
- æ—¥å¿—åŠ¡å¿…è¾“å‡ºåˆ° stdout/stderrï¼ˆKubernetes é›†æˆæ—¥å¿—æ”¶é›†å™¨æ‰èƒ½æ”¶é›†ï¼‰ã€‚
- å¦‚æœæŒ‚è½½ ConfigMap/Secret åˆ°å®¹å™¨å†…éƒ¨ï¼Œç¡®è®¤æ–‡ä»¶æƒé™å¯¹ UID 3000 å¯è¯»å†™ï¼ˆæˆ–åªè¯»ä¸”åº”ç”¨èƒ½è¯»å–ï¼‰ã€‚
- Distroless æ— å·¥å…·ï¼Œä»»ä½•åŸºäºå®¹å™¨å†… debug çš„æ“ä½œéœ€é€šè¿‡ kubectl logs / kubectl execï¼ˆexec è¿›å®¹å™¨ä¼šå¤±è´¥ï¼›å¦‚æœè¦ execï¼Œéœ€ä¸´æ—¶ä½¿ç”¨ debug é•œåƒæ›¿æ¢ï¼‰ï¼š
  - æ¨èåšæ³•ï¼škubectl run --rm -it --image=busybox debug -- /bin/sh è”ç½‘åˆ°åŒä¸€ç½‘ç»œåšç½‘ç»œè°ƒè¯•ï¼Œæˆ–éƒ¨ç½²å¸¦ debug sidecarã€‚

---

# **æ•…éšœæ’æŸ¥ï¼ˆdistroless å¸¸è§é—®é¢˜ä¸è§£å†³ï¼‰**

1. **å®¹å™¨ç›´æ¥ CrashLoop / æ— æ—¥å¿—**
   - æ£€æŸ¥é•œåƒå†… JAVA ç‰ˆæœ¬å…¼å®¹æ€§ï¼ˆJRE vs JDKï¼‰ã€‚
   - docker run æŸ¥çœ‹ docker logs è¾“å‡ºé”™è¯¯å †æ ˆã€‚
   - è‹¥æ— å¼‚å¸¸ä¿¡æ¯ï¼Œå¯èƒ½åº”ç”¨ç«‹å³ exitï¼ˆæ£€æŸ¥ ENTRYPOINTï¼‰ï¼Œæˆ–æƒé™é—®é¢˜ï¼ˆæ–‡ä»¶ä¸å¯è¯»ï¼‰ï¼Œæ£€æŸ¥ runAsUser ä¸æ–‡ä»¶æ‰€æœ‰è€…ã€‚

2. **æ— æ³•æŒ‚è½½ ConfigMap/Secretï¼ˆæƒé™é—®é¢˜ï¼‰**
   - Kubernetes ä¸­å¯ä»¥åœ¨ Pod Spec ç”¨ fsGroup è®¾ç½®å·æ–‡ä»¶ç»„æƒé™ï¼Œæˆ–åœ¨ container å†…ä½¿ç”¨ initContainer é¢„ chownï¼ˆä½†åœ¨ distroless æ—  shellï¼Œéœ€åœ¨ initContainer ä¸­ chownï¼‰ã€‚

3. **å¥åº·æ£€æŸ¥å¤±è´¥**
   - ç¡®è®¤ readinessProbe ç«¯å£/è·¯å¾„æ­£ç¡®ï¼›ç¡®è®¤åº”ç”¨æ¥å— 0.0.0.0 è€Œä¸é™äº 127.0.0.1ï¼ˆå¸¸è§è¯¯é…ç½®ï¼‰ã€‚

4. **éœ€è¦è¿è¡Œæ—¶è°ƒè¯•**
   - åœ¨ CI æ„å»ºé˜¶æ®µæ³¨å…¥è°ƒè¯•å¼€å…³ï¼ˆä¾‹å¦‚ JVM remote debug portï¼‰ï¼Œæœ¬åœ°ä½¿ç”¨é-distroless é•œåƒè°ƒè¯•ï¼Œå®Œæˆååˆ‡å› distrolessã€‚

5. **æ—¥å¿—æ ¼å¼/ç¼–ç é—®é¢˜**
   - ç¡®ä¿æ—¥å¿—è¾“å‡ºåˆ° stdout/stderrï¼Œä¸å†™åœ¨å®¹å™¨å†…æ–‡ä»¶ï¼ˆé™¤éæŒ‚è½½æŒä¹…å·ï¼‰ï¼Œä»¥ä¾¿ GKE æ—¥å¿—ç³»ç»Ÿï¼ˆStackdriver/Cloud Loggingï¼‰æ”¶é›†ã€‚

---

# **å®‰å…¨ä¸æ‰«æå»ºè®®**

- **é•œåƒæ‰«æ**ï¼šä½¿ç”¨ trivy / clair æ‰«ææœ€ç»ˆé•œåƒï¼ˆdistroless ä¼šæ˜¾è‘—å‡å°‘å¯æ‰«æé¢ä¸æ¼æ´æ•°ï¼‰ã€‚

```
trivy image sample-api:distroless
```

-
- **æœ€å°æƒé™**ï¼šåœ¨ K8S ä¸­å¯ç”¨ PodSecurityPolicies / PSAï¼Œè¦æ±‚ runAsNonRootã€ç¦æ­¢ privilegedã€‚
- **ä¸è¦åœ¨è¿è¡Œé•œåƒä¸­æ”¾å…¥å‡­è¯**ï¼šä½¿ç”¨ K8S Secret æˆ– GCP Secret Manager + CSI Driver æ³¨å…¥ã€‚

---

# **æ€§èƒ½ä¸ä½“ç§¯å¯¹æ¯”ï¼ˆæœŸæœ›ï¼‰**

- **é•œåƒå°ºå¯¸**ï¼šä» Debian-slim åŸºçº¿ï¼ˆå¯èƒ½ 200-500MBï¼‰é™åˆ° distroless Javaï¼ˆé€šå¸¸ ~50-150MBï¼Œè§† JRE å¤§å°ä¸æ˜¯å¦åˆ†å±‚è€Œå®šï¼‰ã€‚
- **æ‹‰å–æ—¶é—´**ï¼šé•œåƒå±‚è¾ƒå°‘ã€ä½“ç§¯å° â†’ åœ¨ GKE èŠ‚ç‚¹ä¸Šæ‹‰å–é€Ÿåº¦æ›´å¿« â†’ å¯åŠ¨æ—¶é—´æ€»ä½“æ”¹å–„ã€‚
- **å®‰å…¨æ€§**ï¼šæ— åŒ…ç®¡ç†å™¨ / æ—  shell â†’ æ”»å‡»é¢æ˜¾è‘—ä¸‹é™ã€‚

---

# **æ£€æŸ¥æ¸…å•ï¼ˆDeployment å‰å¿…é¡»ç¡®è®¤ï¼‰**

- CI èƒ½äº§å‡º jar å¹¶ä¸ Dockerfile åŒæ­¥ï¼ˆæˆ– Dockerfile å†…èƒ½åšæ„å»ºï¼‰
- ç¡®è®¤æ˜¯å¦ä½¿ç”¨ Spring Boot layertoolsï¼ˆè‹¥ä½¿ç”¨ï¼Œè°ƒæ•´ COPY è·¯å¾„ï¼‰
- Deployment çš„ runAsUser ä¸é•œåƒ USER åŒ¹é…
- readiness/liveness æŒ‡å‘æ­£ç¡®çš„ç«¯ç‚¹
- æ—¥å¿—è¾“å‡ºåˆ° stdout/stderr
- ConfigMap/Secret çš„æŒ‚è½½æƒé™æ­£ç¡®
- å·²åœ¨ CI/CD ä¸­åŠ å…¥é•œåƒæ‰«æï¼ˆtrivyï¼‰ä¸ç­¾åï¼ˆå¯é€‰ï¼‰
- åœ¨ staging ç¯å¢ƒé€šè¿‡ Kong åšæµé‡éªŒè¯ï¼ˆåŒ…å« headerã€mTLSã€rate-limit åœºæ™¯ï¼‰

---

# **å°ç»“ä¸å»ºè®®ï¼ˆå®è·µå»ºè®®ï¼‰**

1. **å…ˆåšå•æœåŠ¡ POC**ï¼šæŠŠä¸€ä¸ªæ— å¤æ‚æœ¬åœ°ä¾èµ–çš„ API è¿ç§»åˆ° distrolessï¼Œè¦†ç›–å¯åŠ¨ã€å¥åº·ã€æ—¥å¿—ã€Kubernetes éƒ¨ç½²ã€é€šè¿‡ Kong çš„çœŸå®æµé‡ã€‚
2. **ä¸è¦è¯•å›¾ä¿ç•™ wrapper.sh**ï¼šå¦‚æœ wrapper.sh åªåš java -jarï¼Œç›´æ¥ç”¨ ENTRYPOINTï¼›å¦‚æœåšå¤æ‚å¯åŠ¨é€»è¾‘ï¼Œæœ€å¥½æŠŠé€»è¾‘æ”¾å…¥ Java å¯åŠ¨æˆ–ç”¨ initContainer å¤„ç†ã€‚
3. **åˆ©ç”¨åˆ†å±‚ï¼ˆlayertoolsï¼‰**ï¼šå¯¹ Spring Boot æœåŠ¡å¾ˆæœ‰å¸®åŠ©ï¼Œèƒ½å‡å°‘é•œåƒé‡å»ºçš„å˜æ›´é¢ã€‚
4. **è°ƒè¯•ç­–ç•¥**ï¼šå¼€å‘æ—¶ä»¥ openjdk:slim æˆ– busybox/ubuntu åšè°ƒè¯•é•œåƒï¼›ä¸Šçº¿å‰åˆ‡å› distrolessã€‚
5. **CI/CD**ï¼šåœ¨ pipeline ä¸­æŠŠæ„å»º jarã€æ„å»ºé•œåƒã€æ‰«æé•œåƒã€æ¨é•œåƒã€éƒ¨ç½²åˆ° stagingã€æµé‡éªŒè¯è¿™äº›æ­¥éª¤ä¸²è”èµ·æ¥ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥æ¥ç€ï¼š

- æŠŠä½ æä¾›çš„ **æ—§ Dockerfile** è‡ªåŠ¨è½¬æ¢ä¸º **distroless å¤šé˜¶æ®µ Dockerfile**ï¼ˆæˆ‘ä¼šä¿ç•™ä½ å¿…è¦çš„é€»è¾‘å¹¶ç»™å‡ºæ”¹é€ å»ºè®®ï¼‰ï¼Œæˆ–è€…
- åŸºäºä½ çš„ä¸€ä¸¤ä¸ªçœŸå® APIï¼ˆæŠŠ jar åç§°è´´æ¥ï¼‰ç›´æ¥ç»™å‡ºå¯æ‰§è¡Œçš„ Dockerfileã€CI snippetï¼ˆCloud Build / GitHub Actionsï¼‰ä¸ Kubernetes Deployment YAMLï¼ˆå« runAsUserã€probesã€resourceLimitsï¼‰ã€‚

è¦æˆ‘ç›´æ¥æŠŠä½ é‚£ä¸ªæ—§ Dockerfile æ”¹å†™æˆ distroless ç‰ˆæœ¬å—ï¼Ÿï¼ˆæˆ‘ä¼šç›´æ¥ç”Ÿæˆå¹¶è¯´æ˜æ‰€æœ‰æ”¹åŠ¨ï¼‰

ä¸‹é¢å¯¹ **æœ€ç»ˆæ¨èçš„å¤šé˜¶æ®µ Dockerfile** ä¸­çš„å…³é”®é˜¶æ®µï¼Œé€æ®µè¿›è¡Œå®Œæ•´ã€ä¸“ä¸šã€ç»“æ„åŒ–çš„è¯´æ˜ï¼Œç¡®ä¿ä½ å¯ä»¥ç›´æ¥åœ¨å›¢é˜Ÿå†…è¿›è¡Œåˆ†äº«æˆ–æ–‡æ¡£åŒ–ã€‚

---

# **å¤šé˜¶æ®µ Dockerfile è¯¦è§£**

## **1. é—®é¢˜åˆ†æ**

åœ¨æ„å»º Java Spring Boot æœåŠ¡æ—¶ï¼Œæœ€å¸¸è§çš„é—®é¢˜åŒ…æ‹¬ï¼š

- æ„å»ºé•œåƒè¿‡å¤§
- æ„å»ºè¿‡ç¨‹ä¸­æ³„æ¼ä¸å¿…è¦çš„æ–‡ä»¶ï¼ˆå¦‚æºç ã€~/.m2 ç­‰ï¼‰
- è¿è¡Œç¯å¢ƒä¸æ„å»ºç¯å¢ƒæ··æ‚
- æ— æ³•å¤ç”¨ Maven ç¼“å­˜å¯¼è‡´æ„å»ºæ—¶é—´è¿‡é•¿
- é•œåƒå®‰å…¨æ€§ä¸ç”Ÿäº§ç¯å¢ƒéš”ç¦»è¦æ±‚ä¸å……åˆ†

å¤šé˜¶æ®µæ„å»ºå¯ä»¥è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œä½¿æ„å»ºè¿‡ç¨‹æ¸…æ™°ã€å¯ç»´æŠ¤ã€å¹¶ä¿æŒæœ€ç»ˆè¿è¡Œé•œåƒæå°ã€‚

---

# **2. æ¨èçš„å¤šé˜¶æ®µ Dockerfileï¼ˆç¤ºä¾‹ï¼‰**

```dockerfile
############################
# 1. ä¾èµ–ç¼“å­˜é˜¶æ®µï¼ˆå¯é€‰ï¼‰
############################
FROM maven:3.9.6-eclipse-temurin-17 AS deps

WORKDIR /build

# ä»…å¤åˆ¶ pom.xml ä¾¿äºç¼“å­˜ä¾èµ–
COPY pom.xml .

# é¢„æ‹‰å–ä¾èµ–ï¼ˆä½†ä¸ç¼–è¯‘ä»£ç ï¼‰
RUN mvn -B dependency:go-offline


############################
# 2. æ„å»ºé˜¶æ®µ
############################
FROM maven:3.9.6-eclipse-temurin-17 AS builder

WORKDIR /build

COPY --from=deps /root/.m2 /root/.m2

# å¤åˆ¶é¡¹ç›®æºç 
COPY . .

RUN mvn -B clean package -DskipTests


############################
# 3. è¿è¡Œé˜¶æ®µï¼ˆç”Ÿäº§é•œåƒï¼‰
############################
FROM eclipse-temurin:17-jre AS runtime

WORKDIR /app

# å°†æ„å»ºäº§ç‰©å¤åˆ¶åˆ°æœ€ç»ˆé•œåƒ
COPY --from=builder /build/target/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

---

# **3. æ¯ä¸€é˜¶æ®µè¯¦ç»†è§£é‡Š**

## **3.1 é˜¶æ®µ 1ï¼šä¾èµ–ç¼“å­˜ï¼ˆdepsï¼‰**

### **âœ“ ç›®çš„**

- å‡å°‘æ¯æ¬¡æ„å»ºé‡å¤ä¸‹è½½ Maven ä¾èµ–çš„æ—¶é—´
- æé«˜æ„å»ºé€Ÿåº¦ï¼ˆCI æœ€æ˜æ˜¾ï¼‰

### **âœ“ å…³é”®ç‚¹è¯´æ˜**

```
COPY pom.xml .
RUN mvn -B dependency:go-offline
```

åªå¤åˆ¶ pom.xmlï¼Œé¿å…æºç å˜åŒ–å¼•å‘ Maven ä¾èµ–é‡æ‹‰ã€‚

ç±»ä¼¼æ•ˆæœå°±åƒï¼š

> â€œå…ˆæŠŠæ‰€æœ‰ææ–™å‡†å¤‡å¥½ï¼Œåé¢è¦çœŸæ­£å¼€å§‹åšé¥­æ—¶å°±æ›´å¿«äº†ã€‚â€

### **âœ“ ä¼˜ç‚¹**

| **ä¼˜åŠ¿**       | **æè¿°**                                |
| -------------- | --------------------------------------- |
| ä¾èµ–ç¼“å­˜       | åªè¦ pom ä¸å˜ï¼Œå°±å¯ä»¥å¤ç”¨ä¾èµ– cache     |
| CI åŠ é€Ÿ        | å¤§å‹é¡¹ç›®æ•ˆæœæå¤§ï¼ŒèŠ‚çœ 1â€“5 åˆ†é’Ÿç¼–è¯‘æ—¶é—´ |
| åˆ†ç¦»ä»£ç ä¸ç¯å¢ƒ | ä¿æŒæ„å»ºå±‚æ›´å¹²å‡€ã€å¯æ§                  |

---

## **3.2 é˜¶æ®µ 2ï¼šæ„å»ºé˜¶æ®µï¼ˆbuilderï¼‰**

### **âœ“ ç›®çš„**

- å°†æºç ä¸å‰ä¸€é˜¶æ®µçš„ä¾èµ–ç»“åˆ
- æ‰§è¡ŒçœŸå®çš„ Maven build

### **âœ“ å…³é”®ç‚¹è¯´æ˜**

```
COPY --from=deps /root/.m2 /root/.m2
COPY . .
RUN mvn -B clean package -DskipTests
```

### **è§£é‡Šï¼š**

- ä» deps é˜¶æ®µå¤åˆ¶ .m2 ç¼“å­˜å¯æå¤§åŠ é€Ÿæ„å»º
- mvn package -DskipTests é»˜è®¤è·³è¿‡æµ‹è¯•ï¼Œæé«˜é€Ÿåº¦ï¼ˆç”Ÿäº§ CI å¸¸ç”¨ï¼‰

### **âœ“ ä¸ºä»€ä¹ˆä¸è¦åœ¨æœ€ç»ˆé•œåƒä¸­å®‰è£… Mavenï¼Ÿ**

å› ä¸ºï¼š

- Maven + JDK ä½“ç§¯å·¨å¤§ï¼ˆ300MB+ï¼‰
- ç”Ÿäº§é•œåƒåº”è¯¥å°½é‡å°ï¼Œå‡å°‘æ”»å‡»é¢

---

## **3.3 é˜¶æ®µ 3ï¼šè¿è¡Œé•œåƒï¼ˆruntimeï¼‰**

### **âœ“ ç›®çš„**

- ä¿è¯æœ€å°åŒ–ä¸”å®‰å…¨çš„è¿è¡Œç¯å¢ƒ
- åˆ†ç¦»æ„å»ºä¸è¿è¡Œï¼Œæé«˜å®‰å…¨æ€§ä¸å¯ç»´æŠ¤æ€§

### **å…³é”®ç‚¹è¯´æ˜**

```
FROM eclipse-temurin:17-jre
COPY --from=builder /build/target/*.jar app.jar
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### **ä¸ºä»€ä¹ˆåªç”¨ JREï¼Ÿ**

- CI ä¸­ç¼–è¯‘æ—¶éœ€è¦ JDK
- è¿è¡Œæ—¶åªéœ€è¦ JRE
- ä½“ç§¯å·®è·å¯è¾¾ 200MB

### **è¿è¡Œé•œåƒçš„ä¸‰ä¸ªé‡è¦å¥½å¤„**

| **å¥½å¤„** | **æè¿°**                   |
| -------- | -------------------------- |
| æ›´å°     | é€šå¸¸ 100MB ä»¥ä¸‹            |
| æ›´å®‰å…¨   | æ²¡æœ‰ Mavenã€æºç ã€æ„å»ºå·¥å…· |
| æ€§èƒ½æ›´å¥½ | è¿è¡Œå±‚å¹²å‡€ã€èµ„æºå¯æ§       |

---

# **4. Mermaid æµç¨‹å›¾**

```
graph TD
    A["å¼€å§‹ï¼šæ„å»º Docker é•œåƒ"] --> B["ä¾èµ–ç¼“å­˜é˜¶æ®µï¼ˆdepsï¼‰"]
    B --> C["æ„å»ºé˜¶æ®µï¼ˆbuilderï¼‰"]
    C --> D["è¿è¡Œé˜¶æ®µï¼ˆruntimeï¼‰"]
    D --> E["æœ€ç»ˆè¿è¡Œé•œåƒ"]
```

---

# **5. æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ**

### **â‘  æ„å»ºå‰åŠ¡å¿…æ£€æŸ¥æ–‡ä»¶æƒé™**

ç¡®ä¿ Docker build è¿è¡Œç”¨æˆ·å…·å¤‡å¯¹é¡¹ç›®æ–‡ä»¶çš„è¯»å–æƒé™ã€‚

### **â‘¡ CI ç¯å¢ƒå»ºè®®å¯ç”¨å±‚ç¼“å­˜**

ä¾‹å¦‚ GitHub Actions:

```
uses: actions/cache
```

### **â‘¢ ç”Ÿäº§é•œåƒåº”ä¿æŒæœ€å°åŒ–**

ä¸è¦å¼•å…¥ï¼š

- ç¼–è¯‘å·¥å…·
- debug å·¥å…·
- æºç 

### **â‘£ ä½¿ç”¨ JRE è€Œä¸æ˜¯ JDKï¼ˆé™¤ééœ€è¦ç¼–è¯‘åŠ¨æ€ç±»ï¼‰**

è¿›ä¸€æ­¥å‡å°‘é•œåƒå¤§å°ä¸æ”»å‡»é¢ã€‚

### **â‘¤ ä¿æŒ**

### **.dockerignore**

### Â **å¹²å‡€**

æ¨èï¼š

```
.git
target
.idea
*.iml
```

---

# **å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥å¸®ä½ ç”Ÿæˆï¼š**

- ğŸ“„ å®Œæ•´æ–‡æ¡£æ¨¡æ¿ï¼ˆé€‚åˆå›¢é˜Ÿ Confluence / README ä½¿ç”¨ï¼‰
- ğŸ§ª æœ¬åœ°éªŒè¯è„šæœ¬ï¼ˆshellï¼‰
- âš™ï¸ é€‚é…ä½ çš„ GKE éƒ¨ç½² YAMLï¼ˆå« readinessProbe / livenessProbeï¼‰
- ğŸ§° CIï¼ˆGitHub Actions / GitLab / Cloud Buildï¼‰è‡ªåŠ¨åŒ–æ„å»ºé…ç½®

ä½ éœ€è¦å—ï¼Ÿ

quick wins for this:

- multi-stage build (dev deps just for build)
- switch base to python:slim-bookworm (~120MB)
- combine RUN layers to reduce layer size
- .dockerignore for tests/docs
