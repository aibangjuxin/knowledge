# GKE Egress Proxy 架构设计

## 1. 架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              GKE Cluster                                   │
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────────────────────────────────────┐ │
│  │   API Pod       │    │           intra-proxy namespace                 │ │
│  │                 │    │                                                 │ │
│  │ HTTP_PROXY=     │    │  ┌─────────────────┐                           │ │
│  │ microsoft.intra │───▶│  │   Squid Proxy   │                           │ │
│  │ .aibang.local   │    │  │                 │                           │ │
│  │                 │    │  │ Port: 3128      │                           │ │
│  └─────────────────┘    │  │                 │                           │ │
│                         │  └─────────────────┘                           │ │
│                         │           │                                     │ │
│                         └───────────┼─────────────────────────────────────┘ │
└─────────────────────────────────────┼─────────────────────────────────────────┘
                                      │
                                      │ cache_peer
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              GCE VM                                        │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                    int-proxy.aibang.com:3128                           │ │
│  │                                                                         │ │
│  │  ┌─────────────────┐                                                   │ │
│  │  │   Squid Proxy   │                                                   │ │
│  │  │   (二级代理)      │ ──────────────────────────────────────────────────┼─┤
│  │  │                 │                                                   │ │
│  │  └─────────────────┘                                                   │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ Direct Internet Access
                                      ▼
                            ┌─────────────────────┐
                            │  login.microsoft.com │
                            │  External Services   │
                            └─────────────────────┘
```

## 2. 流量路径详解

### 2.1 正常流量路径
```
API Pod → HTTP_PROXY=microsoft.intra.aibang.local:3128 
       → GKE Squid (intra-proxy namespace)
       → cache_peer int-proxy.aibang.com:3128
       → GCE VM Squid
       → login.microsoft.com
```

### 2.2 DNS 解析配置
- `microsoft.intra.aibang.local` → GKE Squid Service ClusterIP
- `int-proxy.aibang.com` → GCE VM 内网 IP

## 3. 核心组件

### 3.1 GKE 内部 Squid (一级代理)
- **位置**: intra-proxy namespace
- **功能**: 
  - 接收 API Pod 的代理请求
  - ACL 控制访问权限
  - 转发到二级代理
  - 日志记录和监控

### 3.2 GCE VM Squid (二级代理)
- **位置**: 独立 GCE VM
- **功能**:
  - 真正的外网出口
  - 二次 ACL 控制
  - 审计日志
  - 缓存优化

## 4. 安全控制点

### 4.1 一级代理 (GKE Squid)
- 基于源 Pod/Namespace 的访问控制
- 目标域名白名单
- 请求频率限制

### 4.2 二级代理 (GCE VM)
- 基于源 IP 的访问控制
- 目标域名二次验证
- 完整的审计日志

## 5. 优势分析

### 5.1 安全性
- 双层代理提供多重安全控制
- 完整的访问审计链路
- 可以实现细粒度的访问控制

### 5.2 可管理性
- 集中化的出口管理
- 统一的日志收集
- 灵活的策略配置

### 5.3 可扩展性
- 支持多个不同的出口策略
- 可以为不同服务配置不同的代理链路
- 支持负载均衡和高可用

## 6. 潜在挑战

### 6.1 性能影响
- 双层代理增加延迟 (预估 +50-100ms)
- 需要考虑代理的并发处理能力

### 6.2 复杂性
- 需要维护两套代理配置
- 故障排查链路较长

### 6.3 应用改造
- API Pod 需要配置 HTTP_PROXY
- 需要处理 HTTPS 代理的证书问题