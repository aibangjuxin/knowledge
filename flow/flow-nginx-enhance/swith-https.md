# 平滑切换至外部HTTPS负载均衡器 (零停机方案)

本方案旨在提供一个详细的步骤,以确保从现有TCP负载均衡器平滑、零停机地切换到新的外部HTTPS负载均衡器,同时集成Cloud Armor。



## 1. 核心策略：DNS切换

为了避免服务中断,我们将采用“并行部署,DNS切换”的策略。这意味着新的HTTPS负载均衡器将与现有TCP负载均衡器并行运行一段时间,直到所有流量都切换到新系统。

## 2. 前提条件

*   您的Nginx A (或合并后的Nginx实例) 已经准备好接收HTTPS流量,并且SSL证书已正确配置。
*   Nginx后端已配置为将流量转发到GKE Gateway。

## 3. 切换步骤

### 步骤 1: 创建新的外部HTTPS负载均衡器

在GCP中,按照以下步骤配置新的HTTPS负载均衡器:

1.  **保留现有TCP LB**: 不要动当前的TCP负载均衡器。
2.  **创建新的外部HTTPS负载均衡器**: 在GCP控制台或通过`gcloud`命令创建一个新的外部HTTPS负载均衡器。
3.  **配置前端**: 
    *   选择HTTPS协议,并上传您的SSL证书 (或使用Google管理的证书)。
    *   **分配一个新的静态IP地址**: 这是关键一步。确保为这个新的HTTPS LB分配一个**全新的、未被使用的静态IP地址**。这个IP地址将是您稍后在DNS中指向的目标。
4.  **配置后端服务**: 
    *   创建或选择一个后端服务,将其指向包含您的Nginx A (或合并后的Nginx) 实例的实例组。
    *   确保后端服务的健康检查配置正确,能够反映Nginx实例的健康状态。

### 步骤 2: 配置Cloud Armor策略

在新的HTTPS负载均衡器创建完成后,按照之前方案中讨论的步骤,为后端服务附加Cloud Armor策略:

1.  在Cloud Armor中创建或选择您的安全策略。
2.  确保策略中包含针对特定API路径的CEL表达式规则 (例如 `request.path.matches('/api_name1_version/v1/.*')`)。
3.  将此Cloud Armor策略附加到新创建的HTTPS负载均衡器的后端服务上。

### 步骤 3: 内部测试与验证

在进行DNS切换之前,务必对新的HTTPS负载均衡器进行彻底的内部测试:

1.  **直接访问新IP**: 使用新的静态IP地址直接访问您的服务 (例如 `https://<新HTTPS LB IP>/api_name1_version/v1/`)。
2.  **验证功能**: 确保所有API功能正常,响应正确。
3.  **验证SSL**: 检查SSL证书是否正确加载,HTTPS连接是否安全。
4.  **验证Cloud Armor**: 尝试触发Cloud Armor规则 (例如,从被阻止的IP访问),验证防护是否生效。
5.  **监控日志**: 检查Nginx日志、应用日志和Cloud Armor日志,确保没有异常。

### 步骤 4: 更新DNS记录 (流量切换)

当您确认新的HTTPS负载均衡器工作正常后,执行DNS切换:

1.  **修改DNS A记录**: 登录您的DNS服务提供商,将您的域名 (FQDN, 例如 `www.aibang.com`) 的A记录更新为**新的HTTPS负载均衡器的静态IP地址**。
2.  **降低TTL**: 在切换前,可以考虑将DNS记录的TTL (Time-To-Live) 值设置得更低 (例如,从3600秒降低到300秒或60秒),以加快DNS解析的传播速度。