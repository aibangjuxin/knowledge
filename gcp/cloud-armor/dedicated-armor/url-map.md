
# GCP HTTPS Load Balancer â€”â€” URL Map æ·±åº¦è§£æä¸å¯å®æ–½é…ç½®æŒ‡å—

> æœ¬æ–‡ç›®æ ‡  
> **æŠŠ URL Map è¿™ä¸ªâ€œé»‘ç›’â€å½»åº•è®²æ¸…æ¥š**ï¼š  
>
> - å®ƒæ˜¯ä»€ä¹ˆ  
> - å®ƒåœ¨è¯·æ±‚é“¾è·¯ä¸­åˆ°åº•å¹²äº†ä»€ä¹ˆ  
> - å®ƒçš„å†…éƒ¨åŒ¹é…é€»è¾‘  
> - å®ƒå’Œ Backend Service / Cloud Armor çš„çœŸå®å…³ç³»  
> - å¦‚ä½•â€œå®‰å…¨ã€å¯æ§â€åœ°ä¿®æ”¹ä¸æ¼”è¿›  
> - **URL Map â‰ˆ æŠŠã€Œæ˜¯å¦éœ€è¦åœ¨ Nginx åšçš„é‚£ä¸€éƒ¨åˆ† L7 è·¯ç”±èƒ½åŠ›ï¼Œä¸Šç§»åˆ°äº† GLB å±‚ã€**

---

## 1. URL Map æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆä¸€å¥è¯ + æœ¬è´¨ï¼‰

### 1.1 ä¸€å¥è¯å®šä¹‰

> **URL Map æ˜¯ HTTPS Global Load Balancer çš„ L7 è·¯ç”±è§„åˆ™å¼•æ“ï¼Œç”¨äºæ ¹æ® Host + Path å†³å®šè¯·æ±‚åº”è¯¥è½¬å‘åˆ°å“ªä¸ª Backend Serviceã€‚
****

---

### 1.2 åœ¨ GLB ä¸­çš„ä½ç½®

```flow
Client
  â†“
HTTPS Proxy
  â†“
URL Map        â† L7 å†³ç­–æ ¸å¿ƒ
  â†“
Backend Service
  â†“
Instance Group / NEG
```

ğŸ‘‰ **URL Map = L7 Router**

ğŸ‘‰ **Backend Service = å®‰å…¨ & è´Ÿè½½è¾¹ç•Œ**

---

## **2. URL Map èƒ½åšä»€ä¹ˆ / ä¸èƒ½åšä»€ä¹ˆ**

### **2.1 URL Map èƒ½åšçš„äº‹**

|**èƒ½åŠ›**|**æ˜¯å¦æ”¯æŒ**|
|---|---|
|æŒ‰ Host åˆ†æµ|âœ…|
|æŒ‰ Path åˆ†æµ|âœ…|
|Path ä¼˜å…ˆçº§åŒ¹é…|âœ…|
|ä¸€ä¸ª URL Map æŒ‡å‘å¤šä¸ª Backend Service|âœ…|
|ä¸€ä¸ª Backend Service è¢«å¤šä¸ª Path ä½¿ç”¨|âœ…|

---

### **2.2 URL Map ä¸èƒ½åšçš„äº‹ï¼ˆå…³é”®è®¤çŸ¥ï¼‰**

|**èƒ½åŠ›**|**æ˜¯å¦æ”¯æŒ**|
|---|---|
|ç»‘å®š Cloud Armor|âŒ|
|æ‰§è¡Œå®‰å…¨è§„åˆ™|âŒ|
|ä¿®æ”¹è¯·æ±‚å†…å®¹|âŒ|
|æ ¹æ® Header åšå¤æ‚é€»è¾‘|âŒ|

ğŸ‘‰ **URL Map åªåšâ€œå»å“ªâ€ï¼Œä¸åšâ€œèƒ½ä¸èƒ½â€**

---

## **3. URL Map çš„å†…éƒ¨ç»“æ„ï¼ˆå¿…é¡»ç†è§£ï¼‰**

### **3.1 URL Map çš„é€»è¾‘ç»“æ„å›¾**

```mermaid
graph TD
  A["URL Map"]
  B["Host Rule"]
  C["Path Matcher"]
  D["Path Rule"]
  E["Backend Service"]

  A --> B
  B --> C
  C --> D
  D --> E
```

---

### **3.2 å…³é”®å¯¹è±¡è§£é‡Š**

#### **3.2.1 Host Rule**

- å†³å®š **æŸä¸ª Host ç”¨å“ªä¸ª Path Matcher**

- ç¤ºä¾‹ï¼š

  - <www.abc.com> â†’ api-path-matcher

> å³ä½¿åªæœ‰ä¸€ä¸ªåŸŸåï¼Œä¹Ÿå¿…é¡»å­˜åœ¨ Host Rule

---

#### **3.2.2 Path Matcherï¼ˆé€»è¾‘åˆ†ç»„å™¨ï¼‰**

- ä¸€ç»„ Path Rule çš„é›†åˆ

- æ¯ä¸ª Path Matcherï¼š

  - æœ‰ **ä¸€ä¸ª default backend service**

  - æœ‰ **å¤šæ¡ path â†’ backend** æ˜ å°„

---

#### **3.2.3 Path Rule**

```
/api-a-v1/* â†’ bs-api-a-v1
/api-b-v1/* â†’ bs-api-b-v1
```

- æ”¯æŒé€šé…ç¬¦ *

- ä¸æ”¯æŒæ­£åˆ™

- **æœ€é•¿è·¯å¾„ä¼˜å…ˆåŒ¹é…**

---

## **4. URL Map çš„çœŸå®åŒ¹é…é¡ºåºï¼ˆéå¸¸é‡è¦ï¼‰**

> GCP å®˜æ–¹å†…éƒ¨é¡ºåºï¼ˆä½ å¿…é¡»è®°ä½ï¼‰

```
1. Host Rule åŒ¹é… Host
2. æ‰¾åˆ°å¯¹åº” Path Matcher
3. Path Ruleï¼šLongest Path Match
4. è‹¥æ— åŒ¹é… â†’ Default Backend Service
```

---

### **4.1 Longest Path Match ç¤ºä¾‹**

|**Path Rule**|**è¯·æ±‚ Path**|**æ˜¯å¦å‘½ä¸­**|
|---|---|---|
|/api/*|/api/a/v1|å‘½ä¸­|
|/api-a-v1/*|/api-a-v1/order|**ä¼˜å…ˆå‘½ä¸­**|

ğŸ‘‰ **è·¯å¾„è¶Šå…·ä½“ï¼Œä¼˜å…ˆçº§è¶Šé«˜**

---

## **5. URL Map ä¸ Backend Service / Cloud Armor çš„å…³ç³»**

### **5.1 è´£ä»»è¾¹ç•Œï¼ˆéå¸¸å…³é”®ï¼‰**

```
URL Map        â†’ å†³å®šç”¨å“ªä¸ª Backend Service
Backend Service â†’ å†³å®šï¼š
                  - Cloud Armor Policy
                  - Health Check
                  - Session Affinity
```

---

### **5.2 ä¸ºä»€ä¹ˆâ€œå…±äº« MIG + å¤š Backend Serviceâ€å¯è¡Œï¼Ÿ**

```
bs-api-a â”€â”
          â”œâ”€â†’ nginx-mig
bs-api-b â”€â”˜
```

- URL Mapï¼šåªå…³å¿ƒ BS åç§°

- BSï¼šåªå…³å¿ƒåç«¯æ˜¯è°

- MIGï¼šå®Œå…¨æ— æ„Ÿ

---

## **6. ä¸€ä¸ªå®Œæ•´ URL Map ç¤ºä¾‹ï¼ˆæ¦‚å¿µçº§ï¼‰**

```
hostRules:
- hosts:
  - www.abc.com
  pathMatcher: api-matcher

pathMatchers:
- name: api-matcher
  defaultService: bs-default
  pathRules:
  - paths:
    - /api-a-v1/*
    service: bs-api-a-v1
  - paths:
    - /api-b-v1/*
    service: bs-api-b-v1
```

---

## **7. URL Map çš„æ›´æ–°æ–¹å¼ï¼ˆç”Ÿäº§å®è·µé‡ç‚¹ï¼‰**

### **7.1 ä¸‰ç§æ›´æ–°æ–¹å¼å¯¹æ¯”**

|**æ–¹å¼**|**æ¨èåº¦**|**è¯´æ˜**|
|---|---|---|
|gcloud url-maps edit|â­â­â­â­|å®‰å…¨ã€å¯æ§|
|Terraform|â­â­â­â­â­|æœ€ä½³å®è·µ|
|Console æ‰‹åŠ¨|â­|ä¸æ¨è|

---

### **7.2**

### **gcloud compute url-maps edit**

### **ï¼ˆæ¨èï¼‰**

#### **7.2.1 æ‰§è¡Œå‘½ä»¤**

```
gcloud compute url-maps edit your-url-map
```

- è‡ªåŠ¨æ‹‰å– YAML

- æœ¬åœ°ç¼–è¾‘

- ä¿å­˜åè‡ªåŠ¨æ ¡éªŒ & æ›´æ–°

---

#### **7.2.2 æ·»åŠ ä¸€æ¡ API Pathï¼ˆç¤ºä¾‹ï¼‰**

```
 pathMatchers:
 - name: api-matcher
   defaultService: bs-default
   pathRules:
+  - paths:
+    - /api-c-v1/*
+    service: bs-api-c-v1
```

> âš ï¸ ä¸ä¼šå½±å“å·²æœ‰ Path

---

## **8. URL Map å˜æ›´çš„â€œå®‰å…¨åŸåˆ™â€ï¼ˆéå¸¸é‡è¦ï¼‰**

### **8.1 å˜æ›´åŸåˆ™**

- åªæ–°å¢ Path Rule

- ä¸åŠ¨ defaultService

- ä¸è¦†ç›–å·²æœ‰ Path

---

### **8.2 ç°åº¦è¿ç§»å»ºè®®**

```
/api-a-v1/internal/* â†’ æ–° BSï¼ˆå…ˆç°åº¦ï¼‰
/api-a-v1/*          â†’ æ—§ BS
```

---

## **9. å¸¸è§è¯¯è§£æ¾„æ¸…**

|**è¯¯è§£**|**äº‹å®**|
|---|---|
|URL Map æ‰§è¡Œå®‰å…¨ç­–ç•¥|âŒ Cloud Armor æ‰§è¡Œ|
|Path Rule æœ‰é¡ºåº|âŒ æŒ‰æœ€é•¿åŒ¹é…|
|ä¸€ä¸ª Path åªèƒ½ä¸€ä¸ª BS|âŒ å¯å¤ç”¨|
|å¿…é¡»æ‹†åŸŸå|âŒ Path å³å¯|

---

## **10. æ€»ç»“ä¸€å¥è¯ï¼ˆURL Map çš„æœ¬è´¨ï¼‰**

> **URL Map æ˜¯ä¸€ä¸ªçº¯ L7 è·¯ç”±å†³ç­–è¡¨ï¼Œå®ƒå”¯ä¸€çš„èŒè´£å°±æ˜¯ï¼šæ ¹æ® Host + Pathï¼Œé€‰ä¸­ä¸€ä¸ª Backend Serviceï¼›è€Œå®‰å…¨ã€ç­–ç•¥ã€å¥åº·æ£€æŸ¥å…¨éƒ¨å‘ç”Ÿåœ¨ Backend Service å±‚ã€‚**

---

## **11. ä¸‹ä¸€æ­¥ä½ å¯ä»¥ç»§ç»­æ·±å…¥çš„æ–¹å‘**

- æˆ‘å¯ä»¥å¸®ä½ ï¼š

  - **ç”»å‡ºä½ å½“å‰ URL Map çš„å®Œæ•´ç»“æ„å›¾**

  - ç»™ä½ ä¸€ä¸ª **Terraform moduleï¼šurl-map + path matcher**

  - å¸®ä½ åˆ¶å®š **API Path è®¾è®¡è§„èŒƒ**

  - ç»“åˆ Cloud Armor è®¾è®¡ **Policy æ¨¡æ¿**

ä½ æ˜¯æƒ³ **å…ˆå®Œå…¨ææ‡‚æ¦‚å¿µ**ï¼Œè¿˜æ˜¯ **ç›´æ¥çœ‹ä¸€ä¸ªå¯ä»¥å¤åˆ¶ç”¨çš„ URL Map æ¨¡æ¿**ï¼Ÿ

# GCP HTTPS Load Balancer â€”â€” URL Map å®Œæ•´ç»“æ„å›¾ï¼ˆæ¦‚å¿µ + å®ä¾‹ï¼‰

ä¸‹é¢è¿™å¼ å›¾æ˜¯ **URL Map åœ¨ GLB ä¸­çš„å®Œæ•´ã€çœŸå®é€»è¾‘ç»“æ„**ï¼Œä¸æ˜¯ç®€åŒ–å›¾ï¼Œ**å¯ä»¥ç›´æ¥å¯¹åº”åˆ° gcloud / Terraform çš„é…ç½®ç»“æ„**ã€‚

---

## 1. URL Map å®Œæ•´é€»è¾‘ç»“æ„å›¾ï¼ˆå®˜æ–¹è¯­ä¹‰çº§ï¼‰

```mermaid
graph TD
  A["HTTPS Proxy"]
  B["URL Map"]

  C["Host Rule<br/>hosts: www.abc.com"]
  D["Path Matcher: api-matcher"]

  E["Path Rule<br/>/api-a-v1/*"]
  F["Path Rule<br/>/api-b-v1/*"]
  G["Default Service"]

  H["Backend Service: bs-api-a-v1<br/>Cloud Armor: policy-api-a-v1"]
  I["Backend Service: bs-api-b-v1<br/>Cloud Armor: policy-api-b-v1"]
  J["Backend Service: bs-default<br/>Cloud Armor: policy-default"]

  K["Nginx MIG"]

  A --> B
  B --> C
  C --> D

  D --> E
  D --> F
  D --> G

  E --> H --> K
  F --> I --> K
  G --> J --> K
````

---

## **2. ä»ã€Œè¯·æ±‚è§†è§’ã€å†ç”»ä¸€éï¼ˆæ‰§è¡Œè·¯å¾„ç‰ˆï¼‰**

> è¿™å¼ å›¾æ˜¯ **çœŸæ­£å‘ç”Ÿåœ¨è¿è¡Œæ—¶çš„å†³ç­–é¡ºåº**

```mermaid
graph LR
  R["Client Request<br/>https://www.abc.com/api-a-v1/orders"]

  H["Host Match<br/>www.abc.com"]
  P["Path Match<br/>/api-a-v1/*"]
  BSA["Backend Service<br/>bs-api-a-v1"]
  CA["Cloud Armor<br/>policy-api-a-v1"]
  MIG["Nginx MIG"]
  APP["Backend App"]

  R --> H --> P --> BSA --> CA --> MIG --> APP
```

---

## **3. URL Map å¯¹åº”çš„â€œçœŸå®é…ç½®ç»“æ„â€ï¼ˆå’Œä¸Šå›¾ä¸€ä¸€å¯¹åº”ï¼‰**

```
hostRules:
- hosts:
  - www.abc.com
  pathMatcher: api-matcher

pathMatchers:
- name: api-matcher
  defaultService: bs-default
  pathRules:
  - paths:
    - /api-a-v1/*
    service: bs-api-a-v1
  - paths:
    - /api-b-v1/*
    service: bs-api-b-v1
```

> âš ï¸ æ³¨æ„ï¼š

- > **Host Rule åªæ˜¯â€œå…¥å£é€‰æ‹©å™¨â€**

- > **Path Matcher æ‰æ˜¯ä½ çœŸæ­£ç»´æŠ¤çš„æ ¸å¿ƒå¯¹è±¡**

---

## **4. å’Œä½ å½“å‰æ–¹æ¡ˆçš„â€œå…³é”®å¯¹åº”å…³ç³»è¡¨â€**

|**ä½ å…³å¿ƒçš„ç‚¹**|**åœ¨å›¾ä¸­çš„ä½ç½®**|
|---|---|
|URL Map åšè·¯ç”±|Host Rule + Path Matcher|
|API Path åˆ†æµ|Path Rule|
|Cloud Armor éš”ç¦»|Backend Service|
|å…±äº« Nginx|æ‰€æœ‰ BS æŒ‡å‘åŒä¸€ä¸ª MIG|
|Nginx é›¶æ”¹åŠ¨|MIG å®Œå…¨æ— æ„Ÿ|

---

## **5. ä¸ºä»€ä¹ˆè¿™ä¸ªç»“æ„**

## **å¤©ç„¶æ”¯æŒ API çº§å®‰å…¨éš”ç¦»**

```
/api-a-v1/* â†’ bs-api-a-v1 â†’ policy-api-a-v1
/api-b-v1/* â†’ bs-api-b-v1 â†’ policy-api-b-v1
```

- URL Mapï¼šåªè´Ÿè´£â€œé€‰å“ªä¸ª BSâ€

- Cloud Armorï¼šåªçœ‹â€œè‡ªå·±ç»‘çš„ BSâ€

- MIGï¼šåªæ˜¯æ‰§è¡Œè¯·æ±‚

ğŸ‘‰ **ä¸‰å±‚èŒè´£å®Œå…¨æ­£äº¤**

---

## **6. ä½ åœ¨ç”Ÿäº§ä¸­â€œçœŸæ­£ä¼šæ”¹çš„åªæœ‰å“ªä¸€å—ï¼Ÿâ€**

**99% çš„æƒ…å†µä¸‹ï¼ŒåªåŠ¨è¿™ä¸€å°å—ï¼š**

```
pathRules:
- paths:
  - /api-new-v1/*
  service: bs-api-new-v1
```

å…¶ä»–éƒ½ **ä¸éœ€è¦åŠ¨**ï¼š

- ä¸åŠ¨ HTTPS Proxy

- ä¸åŠ¨ Host Rule

- ä¸åŠ¨ Nginx

- ä¸åŠ¨å·²æœ‰ API Path

---

## **7. ä¸€å¥è¯å¸®ä½ å½»åº•è®°ä½ URL Map**

> **URL Map å°±æ˜¯ä¸€å¼ ã€ŒHost + Path â†’ Backend Serviceã€çš„é™æ€è·¯ç”±è¡¨ï¼›çœŸæ­£çš„å®‰å…¨å’Œèƒ½åŠ›è¾¹ç•Œï¼Œæ°¸è¿œåœ¨ Backend Serviceã€‚**

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ï¼š

- âœ… **æŒ‰ä½ å½“å‰ç”Ÿäº§ URL Map å¸®ä½ ç”»â€œç°ç½‘ç‰ˆâ€ç»“æ„å›¾**

- âœ… ç»™ä½  **Terraform ç‰ˆ URL Map æ¨¡å—**

- âœ… è®¾è®¡ **API Path / Backend Service / Policy çš„å‘½åä¸ç”Ÿå‘½å‘¨æœŸè§„èŒƒ**

ä½ æ›´æƒ³ **å¯¹ç…§ä½ ç°åœ¨çš„é…ç½®æ¥ç”»ä¸€å¼  1:1 çš„å›¾**ï¼Œè¿˜æ˜¯ **ç›´æ¥ä¸Š Terraformï¼Ÿ**

# RL Map æ˜¯ HTTPS Global Load Balancer çš„ L7 è·¯ç”±è§„åˆ™å¼•æ“

URL Map æ˜¯ HTTPS Global Load Balancer çš„ L7 è·¯ç”±è§„åˆ™å¼•æ“ï¼Œç”¨äºæ ¹æ® Host + Path å†³å®šè¯·æ±‚åº”è¯¥è½¬å‘åˆ°å“ªä¸ª Backend Serviceã€‚**
é‚£è¿™ä¸ªå…¶å®æ˜¯å®Œå…¨æŠŠæˆ‘ Nginxé‡Œé¢çš„é…ç½®æåˆ°äº†è¿™ä¸ªåœ°æ–¹æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è¿™ä¹ˆç†è§£ã€‚æ¯•ç«Ÿæˆ‘åé¢çš„ Nginxä¹Ÿæ˜¯åŸºäºè¿™ä¸ªé€»è¾‘å»åšçš„å¯¹åº”è½¬å‘ ?

è¿™ä¸ªç†è§£ **æ–¹å‘æ˜¯å¯¹çš„ï¼Œä½†éœ€è¦ç¨å¾®â€œæ ¡å‡†ä¸€ä¸‹è¾¹ç•Œâ€**ã€‚

å¯ä»¥è¿™ä¹ˆè¯´ï¼š

> **URL Map â‰ˆ æŠŠã€Œæ˜¯å¦éœ€è¦åœ¨ Nginx åšçš„é‚£ä¸€éƒ¨åˆ† L7 è·¯ç”±èƒ½åŠ›ï¼Œä¸Šç§»åˆ°äº† GLB å±‚ã€**

> ä½† **å®ƒä¸æ˜¯ Nginx çš„å®Œå…¨æ›¿ä»£**ï¼Œè€Œæ˜¯ **èŒè´£æ‹†åˆ†åçš„å‰åŠæ®µ**ã€‚

æˆ‘åˆ† 4 ä¸ªå±‚æ¬¡æŠŠè¿™ä¸ªé—®é¢˜è®²é€ï¼Œä½ ä¼šå‘ç°è¿™å…¶å®æ­£å¥½è§£é‡Šäº†ä½ ä»¬ç°åœ¨è¿™å¥—æ¶æ„ä¸ºä»€ä¹ˆâ€œçœ‹èµ·æ¥æœ‰ç‚¹é‡å¤â€ã€‚

---

# URL Map vs Nginxï¼šæ˜¯ä¸æ˜¯æŠŠ Nginx é…ç½®â€œæåˆ°â€äº† GLBï¼Ÿ

## 1. ç›´è§‚ç»“è®ºï¼ˆç»™ä¸€ä¸ªä½ èƒ½ç›´æ¥ç”¨çš„åˆ¤æ–­ï¼‰

âœ… **å¯ä»¥ç†è§£ä¸ºï¼š**
> URL Map æŠŠ **Nginx ä¸­ã€ŒåŸºäº Host / Path å†³å®šå»å“ªã€çš„é‚£ä¸€éƒ¨åˆ†é€»è¾‘ï¼Œä¸Šç§»åˆ°äº† GCP GLBã€‚**

âŒ **ä½†ä¸èƒ½ç†è§£ä¸ºï¼š**
> URL Map = Nginx

---

## 2. æŠŠ Nginx çš„èƒ½åŠ›æ‹†å¼€çœ‹ï¼ˆè¿™æ˜¯å…³é”®ï¼‰

ä½ ç°åœ¨ Nginx çš„å…¸å‹èƒ½åŠ›å…¶å®æ˜¯ä¸‰ç±»ï¼š

| èƒ½åŠ›ç±»å‹ | ç¤ºä¾‹ |
|---|---|
| **L7 è·¯ç”±** | `location /api-a/ { proxy_pass ... }` |
| æµé‡æ§åˆ¶ | rewriteã€header æ“ä½œ |
| åè®® / è¿æ¥ç®¡ç† | keepaliveã€bufferã€http2 |

**URL Map åªè¦†ç›–ç¬¬ä¸€ç±»ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªã€Œå—é™ç‰ˆã€çš„ç¬¬ä¸€ç±»ã€‚**

---

## 3. ä¸€ä¸€å¯¹ç…§ï¼šURL Map å’Œ Nginx location çš„å¯¹åº”å…³ç³»

### 3.1 Nginx ä¸­ä½ ç†Ÿå¾—ä¸èƒ½å†ç†Ÿçš„ä¸œè¥¿

```nginx
server {
  server_name www.abc.com;

  location /api-a-v1/ {
    proxy_pass http://upstream_a;
  }

  location /api-b-v1/ {
    proxy_pass http://upstream_b;
  }
}
````

### **3.2 åœ¨ GLB ä¸­å¯¹åº”çš„æ˜¯ï¼š**

```
Host Rule: www.abc.com
  â””â”€â”€ Path Matcher
        â”œâ”€â”€ /api-a-v1/* â†’ bs-api-a-v1
        â””â”€â”€ /api-b-v1/* â†’ bs-api-b-v1
```

ğŸ‘‰ **è¯­ä¹‰æ˜¯å®Œå…¨ç­‰ä»·çš„**ï¼š

éƒ½æ˜¯åœ¨åšã€Œçœ‹åˆ°è¿™ä¸ª Pathï¼Œå°±æŠŠè¯·æ±‚é€åˆ°å“ªä¸ªåç«¯ã€ã€‚

---

## **4. é‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦ Nginxï¼Ÿï¼ˆæ ¸å¿ƒåŒºåˆ«ç‚¹ï¼‰**

### **4.1 URL Map åšä¸äº†çš„äº‹ï¼ˆNginx å¿…é¡»å­˜åœ¨ï¼‰**

|**èƒ½åŠ›**|**URL Map**|**Nginx**|
|---|---|---|
|Path â†’ Backend|âœ…|âœ…|
|æ­£åˆ™åŒ¹é…|âŒ|âœ…|
|Header åˆ¤æ–­|âŒ|âœ…|
|rewrite / redirect|âŒ|âœ…|
|è®¤è¯ã€é™æµ|âŒ|ï¼ˆå¯é€‰ï¼‰|
|L7 åˆ° L4 è½¬æ¢|âŒ|âœ…|

> URL Map = **éå¸¸â€œå¹²å‡€â€çš„é™æ€è·¯ç”±è¡¨**

> Nginx = **çœŸæ­£çš„ L7 ä»£ç†å¼•æ“**

---

## **5. ä»ã€Œè´£ä»»è¾¹ç•Œã€è§’åº¦å†çœ‹ä¸€æ¬¡ï¼ˆéå¸¸é‡è¦ï¼‰**

```
GLBï¼ˆURL Mapï¼‰
  â”œâ”€â”€ åšä»€ä¹ˆï¼Ÿ
  â”‚   â””â”€â”€ API Path â†’ Backend Service
  â”‚
  â””â”€â”€ ä¸åšä»€ä¹ˆï¼Ÿ
      â””â”€â”€ ä¸ç†è§£ API è¯­ä¹‰ã€ä¸ç¢°è¯·æ±‚å†…å®¹

Nginx
  â”œâ”€â”€ åšä»€ä¹ˆï¼Ÿ
  â”‚   â”œâ”€â”€ proxy / rewrite / header
  â”‚   â”œâ”€â”€ åè®®è½¬æ¢ï¼ˆHTTP â†’ gRPC ç­‰ï¼‰
  â”‚   â””â”€â”€ è¿æ¥ç®¡ç†
```

ğŸ‘‰ **è¿™å…¶å®æ˜¯ä¸€ä¸ªâ€œå‰ç½®è·¯ç”± + æ·±åº¦ä»£ç†â€çš„åˆ†å±‚è®¾è®¡**

---

## **6. ç”¨ä¸€å¥å·¥ç¨‹å¸ˆèƒ½æ¥å—çš„è¯æ€»ç»“**

> **URL Map ç›¸å½“äºæŠŠ Nginx é‡Œâ€œæœ€å¤–å±‚ã€æœ€ç¨³å®šã€æœ€ä¸è¯¥é¢‘ç¹æ”¹çš„ location è·¯ç”±â€ï¼Œå‰ç§»åˆ°äº† GLBï¼›**

> **è€Œ Nginx ä¿ç•™æ‰€æœ‰éœ€è¦çµæ´»æ€§ã€è¡¨è¾¾åŠ›ã€åè®®å¤„ç†èƒ½åŠ›çš„éƒ¨åˆ†ã€‚**

---

## **7. æ”¾åˆ°ä½ ä»¬ API å¹³å°è¯­å¢ƒä¸‹çš„ã€Œæœ€ä½³å®è·µç†è§£ã€**

å¯¹ä½ ä»¬è¿™ç§ï¼š

- ç»Ÿä¸€å…¥å£åŸŸå

- API path æ¸…æ™°ã€ç‰ˆæœ¬åŒ–

- å¼ºè°ƒå®‰å…¨éš”ç¦»ï¼ˆCloud Armorï¼‰

ğŸ‘‰ **éå¸¸é€‚åˆï¼š**

- GLB URL Mapï¼š

  - /api-x-v{n}/* çº§åˆ«è·¯ç”±

  - ç¨³å®šã€å°‘å˜ã€ä¸å®‰å…¨ç­–ç•¥å¼ºç»‘å®š

- Nginxï¼š

  - å†…éƒ¨ç»†åˆ†

  - Header / rewrite / upstream ç®¡ç†

---

## **8. ä¸€å¥è¯ç»™ä½ ä¸€ä¸ªâ€œæ˜¯å¦è¯¥ä¸Šç§»â€çš„åˆ¤æ–­æ ‡å‡†**

> **å¦‚æœè¿™æ®µ Nginx é…ç½®åªä¾èµ– Host + Pathï¼Œä¸”å’Œå®‰å…¨ç­–ç•¥ / API è¾¹ç•Œå¼ºç›¸å…³ï¼Œé‚£å®ƒå°±éå¸¸é€‚åˆè¢«ä¸Šç§»åˆ° URL Mapã€‚**

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ åšä¸€ä»¶**éå¸¸æœ‰ä»·å€¼çš„äº‹**ï¼š

- æ‹¿ä½ ç°åœ¨çš„ **Nginx location åˆ—è¡¨**

- å¸®ä½ æ‹†æˆï¼š

  - âœ…ã€Œåº”è¯¥ä¸Šç§»åˆ° URL Map çš„ã€

  - âš ï¸ã€Œå¿…é¡»ç•™åœ¨ Nginx çš„ã€

- é¡ºä¾¿å‘Šè¯‰ä½  **å“ªäº› location ä¼šæˆä¸º Cloud Armor çš„å¤©ç„¶è¾¹ç•Œ**

è¿™ä¸ªæ‹†å®Œï¼Œä½ ä»¬çš„æ¶æ„ä¼š**éå¸¸æ¸…çˆ½**ã€‚
