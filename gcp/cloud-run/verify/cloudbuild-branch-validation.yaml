# Google Cloud Buildé…ç½®æ–‡ä»¶
# cloudbuild.yaml

substitutions:
  _SERVICE_NAME: 'my-agent-4'
  _REGION: 'europe-west2'
  _REPOSITORY: 'containers'

steps:
  # 1. åˆ†æ”¯æ ¡éªŒæ­¥éª¤
  - name: 'alpine:latest'
    id: 'branch-validation'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "=== Cloud Build åˆ†æ”¯æ ¡éªŒ ==="
        echo "åˆ†æ”¯åç§°: $BRANCH_NAME"
        echo "ç¯å¢ƒ: $_DEPLOY_ENV"
        echo "é¡¹ç›®: $PROJECT_ID"
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
        if [ "$_DEPLOY_ENV" = "prd" ] || [ "$_DEPLOY_ENV" = "production" ]; then
          echo "ğŸ”’ æ£€æµ‹åˆ°ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼Œæ‰§è¡Œä¸¥æ ¼åˆ†æ”¯æ ¡éªŒ..."
          
          # æ ¡éªŒåˆ†æ”¯åç§°
          if [ "$BRANCH_NAME" != "master" ]; then
            echo "âŒ é”™è¯¯: ç”Ÿäº§ç¯å¢ƒåªèƒ½ä»masteråˆ†æ”¯éƒ¨ç½²!"
            echo "å½“å‰åˆ†æ”¯: $BRANCH_NAME"
            echo "è¦æ±‚åˆ†æ”¯: master"
            exit 1
          fi
          
          echo "âœ… åˆ†æ”¯æ ¡éªŒé€šè¿‡: å…è®¸ä»masteråˆ†æ”¯éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        else
          echo "â„¹ï¸  éç”Ÿäº§ç¯å¢ƒï¼Œè·³è¿‡åˆ†æ”¯æ ¡éªŒ"
        fi

  # 2. æ„å»ºé•œåƒ
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE_NAME}:${BRANCH_NAME}-${SHORT_SHA}'
      - '.'
    waitFor: ['branch-validation']

  # 3. æ¨é€é•œåƒ
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE_NAME}:${BRANCH_NAME}-${SHORT_SHA}'
    waitFor: ['build-image']

  # 4. éƒ¨ç½²åˆ°Cloud Run (æ ¹æ®ç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-cloud-run'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # åŸºç¡€å‘½ä»¤
        CMD="gcloud run jobs deploy ${_SERVICE_NAME} \
          --image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE_NAME}:${BRANCH_NAME}-${SHORT_SHA} \
          --region=${_REGION} \
          --project=$PROJECT_ID"
        
        # æ ¹æ®ç¯å¢ƒæ·»åŠ ç‰¹å®šé…ç½®
        case "$_DEPLOY_ENV" in
          "prd"|"production")
            echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
            CMD="$$CMD \
              --vpc-connector=vpc-conn-europe \
              --vpc-egress=all-traffic \
              --max-retries=3 \
              --set-env-vars=env=prd,region=uk,version=release_17.0.0 \
              --set-secrets=cloud_run_secret=cloud_run_prod:latest \
              --task-timeout=10m \
              --cpu=2 \
              --memory=1Gi \
              --labels=environment=production \
              --key=projects/my-kms-project/locations/europe-west2/keyRings/run/cryptoKeys/HSMrunSharedKey \
              --service-account=prod-mgmt@$PROJECT_ID.iam.gserviceaccount.com"
            ;;
          "test")
            echo "ğŸ§ª éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
            CMD="$$CMD \
              --set-env-vars=env=test,region=uk \
              --cpu=1 \
              --memory=512Mi \
              --labels=environment=testing \
              --service-account=test-mgmt@$PROJECT_ID.iam.gserviceaccount.com"
            ;;
          *)
            echo "ğŸ”§ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
            CMD="$$CMD \
              --set-env-vars=env=dev,region=uk \
              --cpu=0.5 \
              --memory=256Mi \
              --labels=environment=development \
              --service-account=dev-mgmt@$PROJECT_ID.iam.gserviceaccount.com"
            ;;
        esac
        
        echo "æ‰§è¡Œéƒ¨ç½²å‘½ä»¤: $$CMD"
        eval $$CMD
    waitFor: ['push-image']

# è§¦å‘å™¨é…ç½®é€‰é¡¹
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

# è¶…æ—¶è®¾ç½®
timeout: '1200s'