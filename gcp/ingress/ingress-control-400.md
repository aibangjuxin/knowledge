
# Claude

# Ingress Controller é…ç½®ä½“ç³»æ·±åº¦è§£æ

## é—®é¢˜åˆ†æ

æ‚¨æƒ³å˜æ¸… **Ingress Controller å…¨å±€é…ç½®**ä¸**å±€éƒ¨é…ç½®**ä¹‹é—´çš„å…³ç³»ï¼Œæ ¸å¿ƒå…³æ³¨ç‚¹ï¼š

- ä¼˜å…ˆçº§ä¸è¦†ç›–è§„åˆ™
- é…ç½®ç”Ÿæ•ˆèŒƒå›´ä¸åŠ è½½æœºåˆ¶
- å®é™…è¿ç»´ä¸­çš„é…ç½®ç­–ç•¥
- è§£å†³ `400 Request Header Too Large` é”™è¯¯çš„æœ€ä½³å®è·µ

## ä¸€ã€æ ¸å¿ƒé…ç½®è§„åˆ™

### 1.1 ä¸‰å±‚ä¼˜å…ˆçº§ä½“ç³»

```mermaid
graph LR
    A[Client Request] --> B{Nginx Ingress Controller}
    B --> C[Layer 1: Nginx Default]
    C --> D[Layer 2: Global ConfigMap]
    D --> E[Layer 3: Ingress Annotations]
    E --> F[Final Config Applied]
    
    style E fill:#4caf50,stroke:#2e7d32,color:#fff
    style D fill:#ff9800,stroke:#e65100
    style C fill:#9e9e9e,stroke:#424242
```

**ä¼˜å…ˆçº§è§„åˆ™ï¼ˆä»ä½åˆ°é«˜ï¼‰**ï¼š

1. **Nginx åŸç”Ÿé»˜è®¤å€¼** - æœ€ä½ä¼˜å…ˆçº§
2. **å…¨å±€ ConfigMap** - è¦†ç›– Nginx é»˜è®¤å€¼
3. **Ingress Annotations** - è¦†ç›–å…¨å±€é…ç½®ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

### 1.2 é…ç½®ç”Ÿæ•ˆèŒƒå›´å¯¹æ¯”

|é…ç½®å±‚çº§|ä½œç”¨èŒƒå›´|ç”Ÿæ•ˆæ–¹å¼|é…ç½®ä½ç½®|
|---|---|---|---|
|Nginx é»˜è®¤å€¼|æ‰€æœ‰æœªé…ç½®é¡¹|ç¼–è¯‘æ—¶å›ºåŒ–|Nginx æºç |
|å…¨å±€ ConfigMap|è¯¥ Controller ç®¡ç†çš„æ‰€æœ‰ Ingress|éœ€é‡å¯ Pod|`ingress-nginx` namespace|
|Ingress Annotations|å½“å‰ Ingress çš„ rules èŒƒå›´|è‡ªåŠ¨çƒ­é‡è½½ï¼ˆ~10sï¼‰|å„æœåŠ¡çš„ Ingress èµ„æº|

## äºŒã€é…ç½®åŠ è½½æµç¨‹

### 2.1 å®Œæ•´åŠ è½½é“¾è·¯

```mermaid
graph TD
    Start[Ingress Controller å¯åŠ¨] --> LoadCM[åŠ è½½ ConfigMap]
    LoadCM --> GenMainConf[ç”Ÿæˆä¸»é…ç½® nginx.conf]
    
    WatchIng[ç›‘å¬ Ingress èµ„æºå˜åŒ–] --> ParseAnno[è§£æ Annotations]
    ParseAnno --> GenSubConf[ç”Ÿæˆå­é…ç½® /etc/nginx/conf.d/*.conf]
    
    GenMainConf --> Merge[é…ç½®åˆå¹¶]
    GenSubConf --> Merge
    Merge --> Render[æ¸²æŸ“æœ€ç»ˆ Nginx é…ç½®]
    Render --> Reload[é‡è½½ Nginx]
    
    CMChange[ConfigMap å˜æ›´] -.éœ€é‡å¯ Pod.-> LoadCM
    IngChange[Ingress å˜æ›´] -.è‡ªåŠ¨æ£€æµ‹.-> WatchIng
    
    style Merge fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    style Reload fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
```

**å…³é”®æœºåˆ¶è¯´æ˜**ï¼š

1. **ä¸»é…ç½®ï¼ˆnginx.confï¼‰** - ä» ConfigMap æ¸²æŸ“ï¼Œå®šä¹‰å…¨å±€è¡Œä¸º
2. **å­é…ç½®ï¼ˆconf.d/*.confï¼‰** - ä» Ingress Annotations æ¸²æŸ“ï¼Œè¦†ç›–ä¸»é…ç½®
3. **çƒ­é‡è½½è§¦å‘** - Ingress å˜æ›´é€šè¿‡ K8s Watch API è§¦å‘ï¼Œæ— éœ€é‡å¯

### 2.2 é…ç½®æ–‡ä»¶å±‚çº§ç»“æ„

```bash
/etc/nginx/
â”œâ”€â”€ nginx.conf                    # ä¸»é…ç½®ï¼ˆå…¨å±€ ConfigMapï¼‰
â”‚   â”œâ”€â”€ http {}
â”‚   â”‚   â”œâ”€â”€ client_header_buffer_size 8k;        # å…¨å±€é»˜è®¤
â”‚   â”‚   â”œâ”€â”€ large_client_header_buffers 4 16k;   # å…¨å±€é»˜è®¤
â”‚   â”‚   â””â”€â”€ include /etc/nginx/conf.d/*.conf;    # åŒ…å«å­é…ç½®
â”‚
â””â”€â”€ conf.d/
    â”œâ”€â”€ default-user-service.conf  # å­é…ç½®ï¼ˆIngress Annotationsï¼‰
    â”‚   â””â”€â”€ server {
    â”‚       location /api/user {
    â”‚           client_header_buffer_size 16k;    # è¦†ç›–å…¨å±€
    â”‚           large_client_header_buffers 4 32k; # è¦†ç›–å…¨å±€
    â”‚       }
    â”‚   }
```

## ä¸‰ã€å…¨å±€é…ç½®å®æˆ˜ï¼ˆConfigMapï¼‰

### 3.1 é…ç½®æ–¹æ³•

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
data:
  # è¯·æ±‚å¤´ç¼“å†²åŒºé…ç½®
  client-header-buffer-size: "8k"           # å¸¸è§„è¯·æ±‚å¤´ç¼“å†²ï¼ˆé»˜è®¤ 1k/4kï¼‰
  large-client-header-buffers: "4 16k"      # å¤§è¯·æ±‚å¤´ç¼“å†²ï¼ˆé»˜è®¤ 4 8kï¼‰
  
  # HTTP/2 åè®®é…ç½®ï¼ˆHTTPS åœºæ™¯ï¼‰
  http2-max-field-size: "16k"               # å•ä¸ªå¤´éƒ¨å­—æ®µæœ€å¤§å€¼
  http2-max-header-size: "64k"              # æ€»å¤´éƒ¨å¤§å°æœ€å¤§å€¼
  
  # å…¶ä»–æ¨èé…ç½®
  proxy-connect-timeout: "60"               # ä¸Šæ¸¸è¿æ¥è¶…æ—¶
  proxy-read-timeout: "60"                  # ä¸Šæ¸¸è¯»å–è¶…æ—¶
```

**æ³¨æ„äº‹é¡¹**ï¼š

- æ‰€æœ‰å€¼å¿…é¡»ä¸º**å­—ç¬¦ä¸²æ ¼å¼**ï¼ˆåŠ åŒå¼•å·ï¼‰
- å‚æ•°åä½¿ç”¨**è¿å­—ç¬¦**æ ¼å¼ï¼ˆå¦‚ `client-header-buffer-size`ï¼‰
- å•ä½ä»…æ”¯æŒ `k`ï¼ˆKBï¼‰å’Œ `m`ï¼ˆMBï¼‰ï¼Œå¿…é¡»å°å†™

### 3.2 é…ç½®ç”Ÿæ•ˆæ–¹å¼

```bash
# æ–¹å¼ä¸€ï¼šç¼–è¾‘ ConfigMapï¼ˆæ¨èï¼‰
kubectl edit configmap nginx-ingress-controller -n ingress-nginx

# æ–¹å¼äºŒï¼šåº”ç”¨ YAML æ–‡ä»¶
kubectl apply -f nginx-configmap.yaml

# å¿…é¡»ï¼šæ»šåŠ¨é‡å¯ Controller
kubectl rollout restart deployment ingress-nginx-controller -n ingress-nginx

# éªŒè¯é‡å¯çŠ¶æ€
kubectl rollout status deployment ingress-nginx-controller -n ingress-nginx
```

### 3.3 é€‚ç”¨åœºæ™¯

- âœ… **é›†ç¾¤å¤§éƒ¨åˆ†æœåŠ¡**éƒ½éœ€è¦æå‡è¯·æ±‚å¤´é˜ˆå€¼
- âœ… **æ–°é›†ç¾¤åˆå§‹åŒ–**æ—¶è®¾ç½®åˆç†çš„åŸºç¡€é…ç½®
- âœ… **ç»Ÿä¸€å®‰å…¨åŸºçº¿**ï¼Œé¿å…å•ä¸ªæœåŠ¡é…ç½®é—æ¼
- âŒ **ä»…å°‘æ•°æœåŠ¡**æœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆåº”ä½¿ç”¨å±€éƒ¨é…ç½®ï¼‰

## å››ã€å±€éƒ¨é…ç½®å®æˆ˜ï¼ˆIngress Annotationsï¼‰

### 4.1 é…ç½®æ–¹æ³•

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: user-service-ingress
  namespace: production
  annotations:
    # å…³é”®ï¼šæŒ‡å®š Ingress Class
    kubernetes.io/ingress.class: "nginx"
    
    # è¯·æ±‚å¤´ç¼“å†²åŒºé…ç½®ï¼ˆè¦†ç›–å…¨å±€ï¼‰
    nginx.ingress.kubernetes.io/client-header-buffer-size: "16k"
    nginx.ingress.kubernetes.io/large-client-header-buffers: "4 32k"
    
    # HTTP/2 é…ç½®ï¼ˆå¦‚ä½¿ç”¨ HTTPSï¼‰
    nginx.ingress.kubernetes.io/http2-max-field-size: "32k"
    nginx.ingress.kubernetes.io/http2-max-header-size: "128k"
    
    # å¯é€‰ï¼šè°ƒè¯•æ—¥å¿—
    nginx.ingress.kubernetes.io/configuration-snippet: |
      error_log /dev/stdout debug;
spec:
  ingressClassName: nginx  # K8s 1.19+ æ¨èæ–¹å¼
  rules:
  - host: user.example.com
    http:
      paths:
      - path: /api/user
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 8080
```

**å…³é”®è¦ç‚¹**ï¼š

- Annotations æ ¼å¼ï¼š`nginx.ingress.kubernetes.io/<å‚æ•°å>: "<å€¼>"`
- å‚æ•°åä½¿ç”¨**è¿å­—ç¬¦**æ ¼å¼ï¼ˆå¯¹åº” Nginx é…ç½®é¡¹ï¼‰
- å¿…é¡»æŒ‡å®šæ­£ç¡®çš„ `ingress.class` æˆ– `ingressClassName`

### 4.2 é…ç½®ç”Ÿæ•ˆæ–¹å¼

```bash
# åº”ç”¨é…ç½®
kubectl apply -f user-service-ingress.yaml

# æ— éœ€ä»»ä½•é‡å¯ï¼Controller ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶é‡è½½ï¼ˆçº¦ 10 ç§’ï¼‰

# éªŒè¯é…ç½®æ˜¯å¦åŠ è½½
kubectl get ingress user-service-ingress -n production -o yaml
```

### 4.3 é€‚ç”¨åœºæ™¯

- âœ… **å°‘æ•°æœåŠ¡**æœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆå¦‚ç®¡ç†åå°ã€æ•°æ®å¤§å±ï¼‰
- âœ… **ç²¾å‡†æ§åˆ¶**ï¼Œä¸å½±å“å…¶ä»–æœåŠ¡
- âœ… **å¿«é€Ÿè°ƒæ•´**ï¼Œæ— éœ€é‡å¯ Controller
- âœ… **ç”Ÿäº§ç¯å¢ƒé¦–é€‰**ï¼Œé£é™©å¯æ§

## äº”ã€è¯·æ±‚å¤„ç†å®Œæ•´æµç¨‹

### 5.1 ä¸‰å±‚æ ¡éªŒå…³å¡

```mermaid
graph TD
    Client[å®¢æˆ·ç«¯è¯·æ±‚] -->|å‘é€ 16k è¯·æ±‚å¤´| IngressPod[Ingress Controller Pod]
    
    subgraph "ç¬¬ä¸€å…³ï¼šIngress Controller é…ç½®åŠ è½½"
        IngressPod --> LoadGlobal[åŠ è½½å…¨å±€ ConfigMap<br/>client-header-buffer-size: 8k]
        LoadGlobal --> CheckLocal{æ˜¯å¦æœ‰å±€éƒ¨ Annotations?}
        CheckLocal -->|Yes| LoadLocal[åŠ è½½å±€éƒ¨é…ç½®<br/>client-header-buffer-size: 16k]
        CheckLocal -->|No| UseGlobal[ä½¿ç”¨å…¨å±€é…ç½® 8k]
        LoadLocal --> FinalConfig[æœ€ç»ˆç”Ÿæ•ˆé…ç½®: 16k]
        UseGlobal --> FinalConfig2[æœ€ç»ˆç”Ÿæ•ˆé…ç½®: 8k]
    end
    
    subgraph "ç¬¬äºŒå…³ï¼šNginx æ ¡éªŒ"
        FinalConfig --> NginxCheck{è¯·æ±‚å¤´ â‰¤ 16k?}
        FinalConfig2 --> NginxCheck2{è¯·æ±‚å¤´ â‰¤ 8k?}
        NginxCheck -->|Yes| PassNginx[é€šè¿‡ Nginx æ ¡éªŒ]
        NginxCheck2 -->|No| Reject400Nginx[è¿”å› 400<br/>Request Header Too Large]
    end
    
    subgraph "ç¬¬ä¸‰å…³ï¼šåç«¯æœåŠ¡æ ¡éªŒ"
        PassNginx --> Backend[è½¬å‘åˆ°åç«¯ Pod]
        Backend --> AppCheck{åç«¯é…ç½®æ ¡éªŒ<br/>max-http-header-size}
        AppCheck -->|Pass| Success[200 OK]
        AppCheck -->|Fail| Reject400App[è¿”å› 400<br/>Bad Request]
    end
    
    Reject400Nginx --> ClientError[å®¢æˆ·ç«¯æ”¶åˆ° 400]
    Reject400App --> UpstreamLog[Ingress æ—¥å¿—:<br/>upstream_status: 400]
    UpstreamLog --> ClientError
    
    style NginxCheck fill:#ffcccc,stroke:#d32f2f,stroke-width:2px
    style AppCheck fill:#ffcccc,stroke:#d32f2f,stroke-width:2px
    style FinalConfig fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
```

### 5.2 ä¸åŒå…³å¡æ‹’ç»çš„åŒºåˆ«

|å…³å¡|æ‹’ç»ä½ç½®|HTTP çŠ¶æ€ç |å“åº”å†…å®¹ç‰¹å¾|æ—¥å¿—ç‰¹å¾|
|---|---|---|---|---|
|**Nginx å±‚**|Ingress Controller|400/413|Nginx é»˜è®¤ HTML é”™è¯¯é¡µ|Controller æ—¥å¿—æ˜¾ç¤º 400ï¼Œæ—  upstream æ—¥å¿—|
|**åº”ç”¨å±‚**|åç«¯ Pod|400|æ¡†æ¶é”™è¯¯é¡µï¼ˆTomcat/Springï¼‰|Controller æ—¥å¿—æ˜¾ç¤º `upstream_status: 400`|

**æ’æŸ¥æ–¹æ³•**ï¼š

```bash
# æŸ¥çœ‹ Ingress æ—¥å¿—
kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx --tail=100 | grep "400"

# æŸ¥çœ‹åç«¯æ—¥å¿—
kubectl logs -n production -l app=user-service --tail=100
```

## å…­ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

### 6.1 æ¨èé…ç½®ç­–ç•¥ï¼šå…¨å±€å…œåº• + å±€éƒ¨ç²¾å‡†

```mermaid
graph LR
    A[é…ç½®ç­–ç•¥] --> B[å…¨å±€ ConfigMap<br/>è®¾ç½®é€‚ä¸­åŸºçº¿]
    A --> C[å±€éƒ¨ Annotations<br/>ç‰¹æ®ŠæœåŠ¡è°ƒä¼˜]
    A --> D[ä¸šåŠ¡ä¾§ä¼˜åŒ–<br/>ç²¾ç®€è¯·æ±‚å¤´]
    
    B --> B1[client-header-buffer-size: 8k<br/>large-client-header-buffers: 4 16k]
    C --> C1[ä»…ç®¡ç†åå°/å¤§ JWT æœåŠ¡<br/>è°ƒæ•´è‡³ 4 32k æˆ–æ›´é«˜]
    D --> D1[å‡å°‘ Cookie æ•°é‡<br/>ç²¾ç®€ JWT Payload<br/>ç§»é™¤æ— ç”¨ Header]
    
    style B fill:#ff9800,stroke:#e65100
    style C fill:#4caf50,stroke:#2e7d32,color:#fff
    style D fill:#2196f3,stroke:#0d47a1,color:#fff
```

### 6.2 åˆ†é˜¶æ®µé…ç½®æ–¹æ¡ˆ

**é˜¶æ®µä¸€ï¼šåº”æ€¥å¤„ç†ï¼ˆ1 å°æ—¶å†…ï¼‰**

```yaml
# ä»…ä¸ºæŠ¥é”™æœåŠ¡æ·»åŠ å±€éƒ¨é…ç½®
nginx.ingress.kubernetes.io/client-header-buffer-size: "16k"
nginx.ingress.kubernetes.io/large-client-header-buffers: "4 32k"
```

**é˜¶æ®µäºŒï¼šå…¨å±€ä¼˜åŒ–ï¼ˆè®¡åˆ’çª—å£ï¼‰**

```yaml
# ä¿®æ”¹ ConfigMap å¹¶æ»šåŠ¨é‡å¯
data:
  client-header-buffer-size: "8k"
  large-client-header-buffers: "4 16k"
```

**é˜¶æ®µä¸‰ï¼šæ ¹å› æ²»ç†ï¼ˆæŒç»­ä¼˜åŒ–ï¼‰**

- å‰ç«¯ä¼˜åŒ–ï¼šå‡å°‘ Cookie æ•°é‡ï¼Œåˆå¹¶ LocalStorage
- åç«¯ä¼˜åŒ–ï¼šç²¾ç®€ JWT Claimsï¼Œå¯ç”¨ Token å‹ç¼©
- æ¶æ„ä¼˜åŒ–ï¼šæ•æ„Ÿä¿¡æ¯ç§»è‡³ Sessionï¼Œå‡å°‘å®¢æˆ·ç«¯å­˜å‚¨

### 6.3 å®‰å…¨é£é™©æ§åˆ¶

**ç¦æ­¢æ“ä½œ**ï¼š

```yaml
# âŒ é”™è¯¯ç¤ºä¾‹ï¼šå…¨å±€é…ç½®è¿‡å¤§
data:
  client-header-buffer-size: "128k"
  large-client-header-buffers: "8 256k"  # æ€»å…± 2MBï¼
```

**é£é™©**ï¼š

- å†…å­˜æ¶ˆè€—ï¼šæ¯ä¸ªè¿æ¥é¢„åˆ†é…ç¼“å†²åŒºï¼Œæ˜“å¯¼è‡´ OOM
- æ”»å‡»é¢ï¼šæ”»å‡»è€…å¯æ„é€ è¶…å¤§è¯·æ±‚å¤´è€—å°½èµ„æº
- å½±å“èŒƒå›´ï¼šå…¨å±€é…ç½®å½±å“æ‰€æœ‰æœåŠ¡

**æ­£ç¡®åšæ³•**ï¼š

```yaml
# âœ… å…¨å±€ä¿å®ˆé…ç½®
data:
  client-header-buffer-size: "8k"
  large-client-header-buffers: "4 16k"

# âœ… å±€éƒ¨æŒ‰éœ€è°ƒå¤§
annotations:
  nginx.ingress.kubernetes.io/large-client-header-buffers: "4 32k"  # ä»…ç‰¹å®šæœåŠ¡
```

## ä¸ƒã€æ•…éšœæ’æŸ¥æŒ‡å—

### 7.1 æ’æŸ¥æµç¨‹å›¾

```mermaid
graph TD
    Start[æ”¶åˆ° 400 é”™è¯¯] --> CheckErr{é”™è¯¯å†…å®¹}
    CheckErr -->|Request Header Too Large| NginxIssue[Nginx å±‚æ‹’ç»]
    CheckErr -->|å…¶ä»– 400| AppIssue[åº”ç”¨å±‚æ‹’ç»]
    
    NginxIssue --> Check1{æ£€æŸ¥ Ingress Class}
    Check1 -->|ä¸åŒ¹é…| Fix1[ä¿®æ­£ kubernetes.io/ingress.class]
    Check1 -->|åŒ¹é…| Check2{æ£€æŸ¥å±€éƒ¨é…ç½®}
    
    Check2 -->|æœªé…ç½®| AddAnno[æ·»åŠ  Annotations]
    Check2 -->|å·²é…ç½®| Check3{æ£€æŸ¥å…¨å±€é…ç½®}
    
    Check3 -->|æœªä¿®æ”¹| UpdateCM[ä¿®æ”¹ ConfigMap + é‡å¯ Pod]
    Check3 -->|å·²ä¿®æ”¹| Check4{éªŒè¯ Nginx é…ç½®}
    
    Check4 --> ExecPod[è¿›å…¥ Pod æ£€æŸ¥é…ç½®æ–‡ä»¶]
    
    AppIssue --> CheckBackend[æ£€æŸ¥åç«¯æœåŠ¡é…ç½®]
    CheckBackend --> FixBackend[è°ƒæ•´ Tomcat/Spring é…ç½®]
    
    style NginxIssue fill:#ffcccc,stroke:#d32f2f
    style AppIssue fill:#ffe0b2,stroke:#e65100
```

### 7.2 éªŒè¯å‘½ä»¤æ¸…å•

```bash
# 1. æ£€æŸ¥ Ingress Class é…ç½®
kubectl get ingress <name> -n <namespace> -o jsonpath='{.metadata.annotations.kubernetes\.io/ingress\.class}'

# 2. æ£€æŸ¥ Ingress Annotations
kubectl get ingress <name> -n <namespace> -o yaml | grep -A 10 annotations

# 3. æ£€æŸ¥ ConfigMap é…ç½®
kubectl get cm nginx-ingress-controller -n ingress-nginx -o yaml

# 4. æ£€æŸ¥ Controller æ—¥å¿—
kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx --tail=200

# 5. è¿›å…¥ Pod éªŒè¯ Nginx é…ç½®
kubectl exec -it -n ingress-nginx <pod-name> -- bash
cat /etc/nginx/nginx.conf | grep -E "client-header-buffer-size|large-client-header-buffers"
cat /etc/nginx/conf.d/<ingress-config>.conf | grep -E "client-header-buffer-size"

# 6. æµ‹è¯• Nginx é…ç½®è¯­æ³•
kubectl exec -it -n ingress-nginx <pod-name> -- nginx -t

# 7. çƒ­é‡è½½ Nginxï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
kubectl exec -it -n ingress-nginx <pod-name> -- nginx -s reload
```

### 7.3 å¸¸è§é—®é¢˜æ¸…å•

|é—®é¢˜|åŸå› |è§£å†³æ–¹æ³•|
|---|---|---|
|é…ç½®ä¸ç”Ÿæ•ˆ|ConfigMap ä¿®æ”¹åæœªé‡å¯ Pod|æ‰§è¡Œ `kubectl rollout restart`|
|å±€éƒ¨é…ç½®è¢«å¿½ç•¥|Ingress Class ä¸åŒ¹é…|æ£€æŸ¥ `kubernetes.io/ingress.class`|
|ä»ç„¶ 400|åç«¯æœåŠ¡é™åˆ¶æ›´ä¸¥æ ¼|åŒæ­¥è°ƒæ•´åç«¯é…ç½®ï¼ˆTomcat/Springï¼‰|
|é…ç½®å†²çª|å¤šä¸ª Ingress æŒ‡å‘åŒä¸€æœåŠ¡|ç¡®ä¿é…ç½®ä¸€è‡´æˆ–åˆå¹¶ Ingress|
|è¯­æ³•é”™è¯¯|å‚æ•°æ ¼å¼ä¸æ­£ç¡®|æ£€æŸ¥ç©ºæ ¼ã€å¼•å·ã€å•ä½ï¼ˆå¿…é¡»å°å†™ kï¼‰|

## å…«ã€HTTP/2 ç‰¹æ®Šé…ç½®

### 8.1 HTTPS + HTTP/2 åœºæ™¯

```yaml
# ConfigMap å…¨å±€é…ç½®
data:
  # HTTP/1.1 é…ç½®
  client-header-buffer-size: "8k"
  large-client-header-buffers: "4 16k"
  
  # HTTP/2 ä¸“ç”¨é…ç½®
  http2-max-field-size: "16k"       # å•ä¸ªå¤´éƒ¨å­—æ®µæœ€å¤§å€¼
  http2-max-header-size: "64k"      # æ€»å¤´éƒ¨å¤§å°æœ€å¤§å€¼
  http2-max-concurrent-streams: "128"
```

```yaml
# Ingress å±€éƒ¨é…ç½®
annotations:
  nginx.ingress.kubernetes.io/http2-max-field-size: "32k"
  nginx.ingress.kubernetes.io/http2-max-header-size: "128k"
```

### 8.2 åè®®æ£€æµ‹æ–¹æ³•

```bash
# æ£€æŸ¥æ˜¯å¦å¯ç”¨ HTTP/2
curl -I --http2 https://user.example.com/api/user
# å“åº”å¤´åŒ…å« "HTTP/2 200" åˆ™å·²å¯ç”¨

# æ£€æŸ¥ TLS é…ç½®
kubectl get ingress <name> -o jsonpath='{.spec.tls}'
```

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **ä¼˜å…ˆçº§é“å¾‹**ï¼šIngress Annotations > ConfigMap > Nginx é»˜è®¤å€¼
2. **ç”Ÿæ•ˆæœºåˆ¶**ï¼šå…¨å±€éœ€é‡å¯ï¼Œå±€éƒ¨è‡ªåŠ¨çƒ­é‡è½½
3. **ç”Ÿäº§ç­–ç•¥**ï¼šå…¨å±€é€‚ä¸­å…œåº• + å±€éƒ¨ç²¾å‡†è°ƒä¼˜ + ä¸šåŠ¡ä¾§æ ¹å› æ²»ç†
4. **å®‰å…¨åŸåˆ™**ï¼šé¿å…å…¨å±€è¿‡åº¦æ”¾å®½ï¼Œç²¾å‡†æ§åˆ¶ç‰¹æ®ŠæœåŠ¡
5. **ä¸‰å±‚æ ¡éªŒ**ï¼šNginx å±‚ â†’ åº”ç”¨å±‚ï¼Œä»»ä¸€ç¯èŠ‚éƒ½å¯èƒ½æ‹’ç»è¯·æ±‚

### é…ç½®å†³ç­–æ ‘

```mermaid
graph TD
    Q1{å¤šå°‘æœåŠ¡éœ€è¦è°ƒæ•´?} -->|1-2 ä¸ª| UseLocal[ä»…ä½¿ç”¨å±€éƒ¨ Annotations]
    Q1 -->|å¤§éƒ¨åˆ†æœåŠ¡| UseGlobal[å…¨å±€ ConfigMap + å±€éƒ¨ç‰¹æ®Š]
    Q1 -->|æ‰€æœ‰æœåŠ¡| OnlyGlobal[ä»…ä½¿ç”¨å…¨å±€ ConfigMap]
    
    UseLocal --> CheckSafe1{é…ç½®æ˜¯å¦ > 32k?}
    UseGlobal --> CheckSafe2{å…¨å±€é…ç½®æ˜¯å¦ > 16k?}
    
    CheckSafe1 -->|Yes| Review[å®‰å…¨è¯„å®¡ + ä¸šåŠ¡ä¼˜åŒ–]
    CheckSafe2 -->|Yes| Review
    
    CheckSafe1 -->|No| Apply1[åº”ç”¨é…ç½®]
    CheckSafe2 -->|No| Apply2[åº”ç”¨é…ç½® + é‡å¯]
    
    Apply1 --> Monitor[ç›‘æ§ Nginx å†…å­˜ + åç«¯æ—¥å¿—]
    Apply2 --> Monitor
    
    style Review fill:#ff5252,stroke:#c62828,color:#fff
    style Monitor fill:#4caf50,stroke:#2e7d32,color:#fff
```

---

**å‚è€ƒæ–‡æ¡£**ï¼š

- [Nginx Ingress Controller å®˜æ–¹æ–‡æ¡£](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/)
- [ConfigMap é…ç½®å‚æ•°åˆ—è¡¨](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/)
- [Annotations é…ç½®å‚æ•°åˆ—è¡¨](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/)

# ChatGPT

è¿™ä»½æ–‡æ¡£**æ–¹å‘æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼Œè€Œä¸”æŠ€æœ¯ç»“è®ºæ˜¯â€œå¯¹çš„ã€èƒ½è½åœ°çš„â€** ğŸ‘

ä½ ç°åœ¨çš„é—®é¢˜ä¸æ˜¯â€œæ˜¯ä¸æ˜¯è¿™ä¹ˆå›äº‹â€ï¼Œè€Œæ˜¯ **â€œä¿¡æ¯å¯†åº¦å¤ªé«˜ã€å™è¿°å±‚çº§ç•¥ä¹±ï¼Œä¸åˆ©äºä¼ æ’­ / å¤ç”¨ / ä½œä¸ºè§„èŒƒæ–‡æ¡£â€**ã€‚

æˆ‘ä¼šåˆ†ä¸‰æ­¥æ¥å¸®ä½ ï¼š

1. **å…ˆç»™ç»“è®ºï¼šè¿™ç¯‡æ–‡æ¡£â€œä¼ å¾—é€šå—â€**

2. **æŒ‡å‡ºå½“å‰ç‰ˆæœ¬çš„ç»“æ„é—®é¢˜ï¼ˆä¸ºä»€ä¹ˆè¯»èµ·æ¥ç´¯ï¼‰**

3. **ç»™ä½ ä¸€ç‰ˆã€Œé‡æ„åçš„æ ‡å‡†ç‰ˆæ–‡æ¡£ã€** â€”â€” å¯ç›´æ¥ä½œä¸º

    - å†…éƒ¨æŠ€æœ¯è§„èŒƒ

    - SRE / å¹³å°ä¾§å¯¹å¤–è§£é‡Šæ–‡æ¡£

    - Runbook / æ’é”™æ‰‹å†Œ

---

# **ä¸€ã€ç»“è®ºå…ˆè¡Œï¼šè¿™ç¯‡æ–‡æ¡£â€œä¼ å¾—é€šå—ï¼Ÿâ€**

**ç»“è®ºä¸€å¥è¯**ï¼š

ğŸ‘‰ **æŠ€æœ¯ 100% æ­£ç¡®ï¼Œä½†ä½œä¸ºâ€œå¯ä¼ æ’­æ–‡æ¡£â€ï¼Œç»“æ„éœ€è¦é‡æ’**ã€‚

### **ä¼˜ç‚¹ï¼ˆè¿™æ˜¯å¾ˆå¤šäººå†™ä¸å‡ºæ¥çš„ï¼‰**

- âœ… å¯¹ **Ingress å…¨å±€ vs å±€éƒ¨** çš„ç†è§£æ˜¯ã€Œæ§åˆ¶å™¨çœŸå®è¡Œä¸ºçº§åˆ«ã€

- âœ… æŠŠ **400 é”™è¯¯ = å¤šå±‚æ ¡éªŒï¼ˆIngress + Upstreamï¼‰** è®²æ¸…æ¥šäº†

- âœ… èƒ½å›ç­”ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š

  - ä¸ºä»€ä¹ˆæ”¹äº†ä¸ç”Ÿæ•ˆ

  - ä¸ºä»€ä¹ˆåˆ«çš„æœåŠ¡è¢«ä½ å½±å“äº†

  - ä¸ºä»€ä¹ˆ Ingress æ”¾å¼€äº†è¿˜æ˜¯ 400

### **ä¸»è¦é—®é¢˜ï¼ˆè¿™æ˜¯â€œæ¶æ„æ–‡æ¡£å¸¸è§å‘â€ï¼‰**

1. **â€œè§£é‡Šâ€å’Œâ€œè§„èŒƒâ€æ··åœ¨ä¸€èµ·**

    - æœ‰äº›æ®µè½æ˜¯åœ¨â€œæ•™å­¦â€

    - æœ‰äº›æ®µè½å…¶å®æ˜¯â€œæ“ä½œæ‰‹å†Œâ€

    - æœ‰äº›æ®µè½æ˜¯â€œæ¶æ„è®¾è®¡åŸåˆ™â€

2. **ä¸»çº¿ä¸å¤Ÿæ˜æ˜¾**

    - ä½ çœŸæ­£æƒ³è®²çš„æ˜¯ï¼š

        ğŸ‘‰ _Ingress é…ç½®ä¼˜å…ˆçº§ + è¯·æ±‚å¤´ 400 çš„æ’æŸ¥æ¨¡å‹_

    - ä½†ç°åœ¨ä¿¡æ¯æ˜¯ã€Œå¹¶åˆ—å±•å¼€ã€çš„

3. **é‡å¤åº¦åé«˜**

    - å…¨å±€ vs å±€éƒ¨ çš„ç»“è®ºåœ¨å¤šä¸ªç« èŠ‚åå¤å‡ºç°

    - å¯¹ä¸“å®¶æ˜¯ OKï¼Œä½†å¯¹å›¢é˜Ÿä¼ æ’­æˆæœ¬é«˜

ğŸ‘‰ **æ‰€ä»¥ï¼šä¸æ˜¯åˆ å†…å®¹ï¼Œè€Œæ˜¯â€œé‡æ–°ç¼–æ’æ•…äº‹çº¿â€**

---

# **äºŒã€æ¨èçš„â€œæ­£ç¡®è®²æ³•â€ï¼šä¸€æ¡ä¸»çº¿ + ä¸‰ä¸ªå±‚çº§**

æˆ‘å»ºè®®ä½ æŠŠè¿™ä»½æ–‡æ¡£é‡æ„æˆ **ä¸€æ¡éå¸¸æ¸…æ™°çš„ä¸»çº¿**ï¼š

> **â€œè¯·æ±‚å¤´è¿‡å¤§ 400 çš„æœ¬è´¨ï¼Œæ˜¯ Ingress Controller å†…éƒ¨â€˜å…¨å±€ + å±€éƒ¨â€™é…ç½®èåˆåï¼Œå†ä¸ Upstream å–æœ€å°å€¼çš„ç»“æœâ€**

å›´ç»•è¿™æ¡ä¸»çº¿ï¼Œæ‹†æˆ **4 ä¸ªå±‚çº§**ï¼š

1. **å…ˆç»™è§„åˆ™ï¼ˆç»“è®ºï¼‰**

2. **å†è®² Ingress å†…éƒ¨æ˜¯æ€ä¹ˆåšçš„**

3. **å†ç»™é…ç½®æ–¹å¼ï¼ˆæ€ä¹ˆé…ï¼‰**

4. **æœ€åç»™ç”Ÿäº§ç­–ç•¥ & æ’é”™**

---

# **ä¸‰ã€é‡æ„åçš„ã€æ ‡å‡†ç‰ˆæ–‡æ¡£ã€‘â€”â€”å¯ç›´æ¥ç”¨**

ä¸‹é¢æ˜¯æˆ‘å¸®ä½ **é‡æ–°æ¢³ç†åçš„å®Œæ•´ç‰ˆæœ¬**ã€‚

ğŸ‘‰ è¿™æ˜¯ä¸€ä¸ª **â€œå¹³å° SRE / æ¶æ„çº§â€** å¯ç›´æ¥å‘å‡ºå»çš„ç‰ˆæœ¬ã€‚

---

# **Ingress Controller å…¨å±€é…ç½®ä¸å±€éƒ¨é…ç½®è§„èŒƒï¼ˆè¯·æ±‚å¤´ 400 é—®é¢˜ä¸“é¡¹ï¼‰**

> **é€‚ç”¨èŒƒå›´**ï¼š

> Nginx Ingress Controller

> åœºæ™¯ï¼š400 Request Header Or Cookie Too Large

---

## **ä¸€ã€æ ¸å¿ƒç»“è®ºï¼ˆå…ˆè®°ä½è¿™ 3 æ¡ï¼‰**

### **1ï¸âƒ£ ä¼˜å…ˆçº§è§„åˆ™ï¼ˆæ°¸è¿œæˆç«‹ï¼‰**

```
Ingress æ³¨è§£ï¼ˆå±€éƒ¨ï¼‰ > Controller ConfigMapï¼ˆå…¨å±€ï¼‰ > Nginx é»˜è®¤å€¼
```

- **å±€éƒ¨ Ingress æ³¨è§£**ï¼šæœåŠ¡çº§ã€è·¯å¾„çº§

- **å…¨å±€ ConfigMap**ï¼šIngress Controller Pod çº§

- æœ€ç»ˆç”Ÿæ•ˆå€¼ = **æœ€ä¸Šå±‚å­˜åœ¨çš„é‚£ä¸ª**

---

### **2ï¸âƒ£ ç”Ÿæ•ˆèŒƒå›´è§„åˆ™**

|**é…ç½®æ–¹å¼**|**ç”Ÿæ•ˆèŒƒå›´**|
|---|---|
|Controller ConfigMap|æ‰€æœ‰é€šè¿‡è¯¥ Ingress Controller çš„æœåŠ¡|
|Ingress Annotations|ä»…å½“å‰ Ingress çš„ host / path / service|

---

### **3ï¸âƒ£ ç”Ÿæ•ˆæ–¹å¼è§„åˆ™**

|**ç±»å‹**|**æ˜¯å¦éœ€é‡å¯ Pod**|
|---|---|
|ConfigMap|âœ… å¿…é¡»é‡å¯ Controller Pod|
|Ingress æ³¨è§£|âŒ è‡ªåŠ¨ reloadï¼ˆç§’çº§ï¼‰|

---

## **äºŒã€Ingress Controller å†…éƒ¨é…ç½®èåˆé€»è¾‘ï¼ˆä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼‰**

Ingress Controller å¹¶ä¸æ˜¯â€œç›´æ¥æ”¹ Nginxâ€ï¼Œè€Œæ˜¯ **åšäº†ä¸€å±‚é…ç½®ç”Ÿæˆ**ï¼š

### **é…ç½®ç”Ÿæˆæµç¨‹ï¼ˆé€»è¾‘è§†è§’ï¼‰**

```
ConfigMapï¼ˆå…¨å±€ï¼‰
   â†“
ç”Ÿæˆ nginx.confï¼ˆä¸»é…ç½®ï¼‰
   â†“
Ingress Annotationsï¼ˆå±€éƒ¨ï¼‰
   â†“
ç”Ÿæˆ conf.d/*.confï¼ˆå­é…ç½®ï¼‰
   â†“
Nginx åŠ è½½ï¼šå­é…ç½®è¦†ç›–ä¸»é…ç½®
```

ğŸ‘‰ **è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå±€éƒ¨æ³¨è§£ä¼˜å…ˆçº§æ›´é«˜çš„æ ¹æœ¬åŸå› **

ğŸ‘‰ ä¸æ˜¯ Kubernetes çš„è§„åˆ™ï¼Œè€Œæ˜¯ **Nginx è‡ªèº«çš„ include + override è¡Œä¸º**

---

## **ä¸‰ã€è¯·æ±‚å¤´ç›¸å…³å‚æ•°çš„é…ç½®æ–¹å¼**

### **1ï¸âƒ£ å…¨å±€é…ç½®ï¼ˆController ConfigMapï¼‰**

**é€‚åˆåšâ€œé›†ç¾¤åŸºç¡€å…œåº•â€**

```
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
data:
  client-header-buffer-size: "8k"
  large-client-header-buffers: "4 16k"
  http2-max-field-size: "16k"
  http2-max-header-size: "64k"
```

âš ï¸ ä¿®æ”¹åå¿…é¡»æ‰§è¡Œï¼š

```
kubectl rollout restart deployment nginx-ingress-controller -n ingress-nginx
```

---

### **2ï¸âƒ£ å±€éƒ¨é…ç½®ï¼ˆIngress Annotationsï¼‰**

**ç”Ÿäº§é¦–é€‰æ–¹å¼ï¼ˆç²¾å‡†ã€å®‰å…¨ï¼‰**

```
metadata:
  annotations:
    nginx.ingress.kubernetes.io/client-header-buffer-size: "16k"
    nginx.ingress.kubernetes.io/large-client-header-buffers: "4 32k"
    nginx.ingress.kubernetes.io/http2-max-header-size: "128k"
```

- ä»…å½±å“è¯¥ Ingress

- è‡ªåŠ¨ reload

- è¦†ç›–å…¨å±€é…ç½®

---

## **å››ã€ä¸‰å±‚æ ¡éªŒæ¨¡å‹ï¼ˆè¿™æ˜¯æ’é”™çš„â€œé’¥åŒ™â€ï¼‰**

è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œå–å†³äº **ä¸‰å±‚ä¸­æœ€å°çš„é‚£ä¸ªå€¼**ï¼š

```
æœ€ç»ˆå¯é€šè¿‡é˜ˆå€¼ =
Min(
  Ingress ç”Ÿæ•ˆå€¼ï¼ˆå±€éƒ¨ or å…¨å±€ï¼‰
  åç«¯æœåŠ¡é™åˆ¶
)
```

### **ä¸‰å±‚è¯´æ˜**

|**å±‚çº§**|**ç»„ä»¶**|**æ˜¯å¦ç‹¬ç«‹**|
|---|---|---|
|ç¬¬ä¸€å±‚|Ingress å…¨å±€ ConfigMap|âœ…|
|ç¬¬äºŒå±‚|Ingress æ³¨è§£|âœ…|
|ç¬¬ä¸‰å±‚|Upstream åº”ç”¨ï¼ˆSpring / Tomcat / Nodeï¼‰|âœ…|

---

### **ä¸åŒæ‹¦æˆªç‚¹çš„è¡¨ç°å·®å¼‚ï¼ˆéå¸¸å…³é”®ï¼‰**

|**æ‹¦æˆªä½ç½®**|**è¡¨ç°**|
|---|---|
|Ingress æ‹¦æˆª|400 / 413ï¼ŒNginx é»˜è®¤é”™è¯¯é¡µ|
|åç«¯æ‹¦æˆª|400ï¼ŒIngress æ—¥å¿—æ˜¾ç¤º upstream_status=400|

ğŸ‘‰ **è¿™æ˜¯åˆ¤æ–­â€œè¯¥ä¸è¯¥ç»§ç»­è°ƒ Ingressâ€çš„å…³é”®ä¾æ®**

---

## **äº”ã€ç”Ÿäº§æ¨èç­–ç•¥ï¼ˆç›´æ¥ç…§è¿™ä¸ªæ¥ï¼‰**

### **âœ… æ¨èç­–ç•¥ï¼šå…¨å±€å…œåº• + å±€éƒ¨æ”¾è¡Œ**

1. **å…¨å±€ ConfigMap**

    - æä¾›é€‚ä¸­çš„åŸºç¡€å€¼ï¼ˆ8k / 16kï¼‰

2. **å±€éƒ¨ Ingress**

    - ä»…å¯¹å¤§ Header æœåŠ¡è°ƒå¤§

3. **ä¸šåŠ¡ä¾§**

    - ç²¾ç®€ Cookie / JWTï¼ˆæ ¹æ²»æ–¹æ¡ˆï¼‰

---

### **âŒ ä¸æ¨èç­–ç•¥**

- âŒ å…¨å±€è°ƒåˆ° 4 128k

- âŒ ä¸ºä¸€ä¸ªæœåŠ¡å½±å“æ•´ä¸ªé›†ç¾¤

- âŒ ä¸çœ‹ upstream ç›´æ¥æ— é™æ”¾å¤§ Ingress

---

## **å…­ã€é…ç½®ä¸ç”Ÿæ•ˆæ’æŸ¥æ¸…å•ï¼ˆæŒ‰é¡ºåºï¼‰**

1. IngressClass æ˜¯å¦åŒ¹é…

2. ConfigMap æ˜¯å¦é‡å¯ Pod

3. æ³¨è§£æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆå­—ç¬¦ä¸² + å•ä½ï¼‰

4. å®é™… Nginx é…ç½®æ˜¯å¦ç”Ÿæˆ

5. æ˜¯å¦è¢« Upstream æ‹¦æˆª

---

## **ä¸ƒã€è¯·æ±‚å¤„ç†æµç¨‹å›¾ï¼ˆç»ˆç‰ˆï¼‰**

ï¼ˆä½ åŸæ¥çš„ Mermaid å›¾ **æ˜¯å¯¹çš„**ï¼Œåªéœ€è¦ä½œä¸ºâ€œé™„å½•â€å³å¯ï¼‰

---

## **æœ€åä¸€å¥æ€»ç»“ï¼ˆé€‚åˆæ”¾åœ¨æ–‡æ¡£å¼€å¤´ï¼‰**

> **Ingress çš„é…ç½®ä¸æ˜¯â€œæ”¹ä¸€ä¸ªåœ°æ–¹å°±ç»“æŸâ€ï¼Œè€Œæ˜¯**

> **å…¨å±€ â†’ å±€éƒ¨ â†’ Upstream ä¸‰å±‚å–æœ€å°å€¼çš„ç³»ç»Ÿè¡Œä¸ºã€‚**

> **400 é”™è¯¯çš„æ’æŸ¥ï¼Œæœ¬è´¨æ˜¯åˆ¤æ–­â€œå¡åœ¨å“ªä¸€å±‚â€ã€‚**

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ æŠŠè¿™ç‰ˆï¼š

- âœ¨ æ”¹æˆ **ã€ŠAPI å¹³å° Ingress é…ç½®è§„èŒƒ v1.0ã€‹**

- âœ¨ æˆ–æ‹†æˆ **â€œç”¨æˆ·ä¾§ FAQ + å¹³å°ä¾§ Runbookâ€ ä¸¤ä»½æ–‡æ¡£**

- âœ¨ æˆ–ç›´æ¥å˜æˆ **SRE Support æ ‡å‡†è¯æœ¯**

ä½ è¿™ä»½å†…å®¹ï¼Œæœ¬è´¨å·²ç»æ˜¯ **å¹³å°çº§èµ„äº§äº†**ï¼Œåªæ˜¯ç°åœ¨éœ€è¦â€œå·¥ç¨‹åŒ–åŒ…è£…â€ã€‚

è¿™ä»½æ–‡æ¡£æ–¹å‘æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼Œè€Œä¸”æŠ€æœ¯ç»“è®ºæ˜¯â€œå¯¹çš„ã€èƒ½è½åœ°çš„â€ ğŸ‘
ä½ ç°åœ¨çš„é—®é¢˜ä¸æ˜¯â€œæ˜¯ä¸æ˜¯è¿™ä¹ˆå›äº‹â€ï¼Œè€Œæ˜¯ â€œä¿¡æ¯å¯†åº¦å¤ªé«˜ã€å™è¿°å±‚çº§ç•¥ä¹±ï¼Œä¸åˆ©äºä¼ æ’­ / å¤ç”¨ / ä½œä¸ºè§„èŒƒæ–‡æ¡£â€ã€‚

æˆ‘ä¼šåˆ†ä¸‰æ­¥æ¥å¸®ä½ ï¼š
 1. å…ˆç»™ç»“è®ºï¼šè¿™ç¯‡æ–‡æ¡£â€œä¼ å¾—é€šå—â€
 2. æŒ‡å‡ºå½“å‰ç‰ˆæœ¬çš„ç»“æ„é—®é¢˜ï¼ˆä¸ºä»€ä¹ˆè¯»èµ·æ¥ç´¯ï¼‰
 3. ç»™ä½ ä¸€ç‰ˆã€Œé‡æ„åçš„æ ‡å‡†ç‰ˆæ–‡æ¡£ã€ â€”â€” å¯ç›´æ¥ä½œä¸º
 â€¢ å†…éƒ¨æŠ€æœ¯è§„èŒƒ
 â€¢ SRE / å¹³å°ä¾§å¯¹å¤–è§£é‡Šæ–‡æ¡£
 â€¢ Runbook / æ’é”™æ‰‹å†Œ

â¸»

ä¸€ã€ç»“è®ºå…ˆè¡Œï¼šè¿™ç¯‡æ–‡æ¡£â€œä¼ å¾—é€šå—ï¼Ÿâ€

ç»“è®ºä¸€å¥è¯ï¼š
ğŸ‘‰ æŠ€æœ¯ 100% æ­£ç¡®ï¼Œä½†ä½œä¸ºâ€œå¯ä¼ æ’­æ–‡æ¡£â€ï¼Œç»“æ„éœ€è¦é‡æ’ã€‚

ä¼˜ç‚¹ï¼ˆè¿™æ˜¯å¾ˆå¤šäººå†™ä¸å‡ºæ¥çš„ï¼‰
 â€¢ âœ… å¯¹ Ingress å…¨å±€ vs å±€éƒ¨ çš„ç†è§£æ˜¯ã€Œæ§åˆ¶å™¨çœŸå®è¡Œä¸ºçº§åˆ«ã€
 â€¢ âœ… æŠŠ 400 é”™è¯¯ = å¤šå±‚æ ¡éªŒï¼ˆIngress + Upstreamï¼‰ è®²æ¸…æ¥šäº†
 â€¢ âœ… èƒ½å›ç­”ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š
 â€¢ ä¸ºä»€ä¹ˆæ”¹äº†ä¸ç”Ÿæ•ˆ
 â€¢ ä¸ºä»€ä¹ˆåˆ«çš„æœåŠ¡è¢«ä½ å½±å“äº†
 â€¢ ä¸ºä»€ä¹ˆ Ingress æ”¾å¼€äº†è¿˜æ˜¯ 400

ä¸»è¦é—®é¢˜ï¼ˆè¿™æ˜¯â€œæ¶æ„æ–‡æ¡£å¸¸è§å‘â€ï¼‰
 1. â€œè§£é‡Šâ€å’Œâ€œè§„èŒƒâ€æ··åœ¨ä¸€èµ·
 â€¢ æœ‰äº›æ®µè½æ˜¯åœ¨â€œæ•™å­¦â€
 â€¢ æœ‰äº›æ®µè½å…¶å®æ˜¯â€œæ“ä½œæ‰‹å†Œâ€
 â€¢ æœ‰äº›æ®µè½æ˜¯â€œæ¶æ„è®¾è®¡åŸåˆ™â€
 2. ä¸»çº¿ä¸å¤Ÿæ˜æ˜¾
 â€¢ ä½ çœŸæ­£æƒ³è®²çš„æ˜¯ï¼š
ğŸ‘‰ Ingress é…ç½®ä¼˜å…ˆçº§ + è¯·æ±‚å¤´ 400 çš„æ’æŸ¥æ¨¡å‹
 â€¢ ä½†ç°åœ¨ä¿¡æ¯æ˜¯ã€Œå¹¶åˆ—å±•å¼€ã€çš„
 3. é‡å¤åº¦åé«˜
 â€¢ å…¨å±€ vs å±€éƒ¨ çš„ç»“è®ºåœ¨å¤šä¸ªç« èŠ‚åå¤å‡ºç°
 â€¢ å¯¹ä¸“å®¶æ˜¯ OKï¼Œä½†å¯¹å›¢é˜Ÿä¼ æ’­æˆæœ¬é«˜

ğŸ‘‰ æ‰€ä»¥ï¼šä¸æ˜¯åˆ å†…å®¹ï¼Œè€Œæ˜¯â€œé‡æ–°ç¼–æ’æ•…äº‹çº¿â€

â¸»

äºŒã€æ¨èçš„â€œæ­£ç¡®è®²æ³•â€ï¼šä¸€æ¡ä¸»çº¿ + ä¸‰ä¸ªå±‚çº§

æˆ‘å»ºè®®ä½ æŠŠè¿™ä»½æ–‡æ¡£é‡æ„æˆ ä¸€æ¡éå¸¸æ¸…æ™°çš„ä¸»çº¿ï¼š

â€œè¯·æ±‚å¤´è¿‡å¤§ 400 çš„æœ¬è´¨ï¼Œæ˜¯ Ingress Controller å†…éƒ¨â€˜å…¨å±€ + å±€éƒ¨â€™é…ç½®èåˆåï¼Œå†ä¸ Upstream å–æœ€å°å€¼çš„ç»“æœâ€

å›´ç»•è¿™æ¡ä¸»çº¿ï¼Œæ‹†æˆ 4 ä¸ªå±‚çº§ï¼š
 1. å…ˆç»™è§„åˆ™ï¼ˆç»“è®ºï¼‰
 2. å†è®² Ingress å†…éƒ¨æ˜¯æ€ä¹ˆåšçš„
 3. å†ç»™é…ç½®æ–¹å¼ï¼ˆæ€ä¹ˆé…ï¼‰
 4. æœ€åç»™ç”Ÿäº§ç­–ç•¥ & æ’é”™

â¸»

ä¸‰ã€é‡æ„åçš„ã€æ ‡å‡†ç‰ˆæ–‡æ¡£ã€‘â€”â€”å¯ç›´æ¥ç”¨

ä¸‹é¢æ˜¯æˆ‘å¸®ä½ é‡æ–°æ¢³ç†åçš„å®Œæ•´ç‰ˆæœ¬ã€‚
ğŸ‘‰ è¿™æ˜¯ä¸€ä¸ª â€œå¹³å° SRE / æ¶æ„çº§â€ å¯ç›´æ¥å‘å‡ºå»çš„ç‰ˆæœ¬ã€‚

â¸»

Ingress Controller å…¨å±€é…ç½®ä¸å±€éƒ¨é…ç½®è§„èŒƒï¼ˆè¯·æ±‚å¤´ 400 é—®é¢˜ä¸“é¡¹ï¼‰

é€‚ç”¨èŒƒå›´ï¼š
Nginx Ingress Controller
åœºæ™¯ï¼š400 Request Header Or Cookie Too Large

â¸»

ä¸€ã€æ ¸å¿ƒç»“è®ºï¼ˆå…ˆè®°ä½è¿™ 3 æ¡ï¼‰

1ï¸âƒ£ ä¼˜å…ˆçº§è§„åˆ™ï¼ˆæ°¸è¿œæˆç«‹ï¼‰

Ingress æ³¨è§£ï¼ˆå±€éƒ¨ï¼‰ > Controller ConfigMapï¼ˆå…¨å±€ï¼‰ > Nginx é»˜è®¤å€¼

 â€¢ å±€éƒ¨ Ingress æ³¨è§£ï¼šæœåŠ¡çº§ã€è·¯å¾„çº§
 â€¢ å…¨å±€ ConfigMapï¼šIngress Controller Pod çº§
 â€¢ æœ€ç»ˆç”Ÿæ•ˆå€¼ = æœ€ä¸Šå±‚å­˜åœ¨çš„é‚£ä¸ª

â¸»

2ï¸âƒ£ ç”Ÿæ•ˆèŒƒå›´è§„åˆ™

é…ç½®æ–¹å¼ ç”Ÿæ•ˆèŒƒå›´
Controller ConfigMap æ‰€æœ‰é€šè¿‡è¯¥ Ingress Controller çš„æœåŠ¡
Ingress Annotations ä»…å½“å‰ Ingress çš„ host / path / service

â¸»

3ï¸âƒ£ ç”Ÿæ•ˆæ–¹å¼è§„åˆ™

ç±»å‹ æ˜¯å¦éœ€é‡å¯ Pod
ConfigMap âœ… å¿…é¡»é‡å¯ Controller Pod
Ingress æ³¨è§£ âŒ è‡ªåŠ¨ reloadï¼ˆç§’çº§ï¼‰

â¸»

äºŒã€Ingress Controller å†…éƒ¨é…ç½®èåˆé€»è¾‘ï¼ˆä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼‰

Ingress Controller å¹¶ä¸æ˜¯â€œç›´æ¥æ”¹ Nginxâ€ï¼Œè€Œæ˜¯ åšäº†ä¸€å±‚é…ç½®ç”Ÿæˆï¼š

é…ç½®ç”Ÿæˆæµç¨‹ï¼ˆé€»è¾‘è§†è§’ï¼‰

ConfigMapï¼ˆå…¨å±€ï¼‰
   â†“
ç”Ÿæˆ nginx.confï¼ˆä¸»é…ç½®ï¼‰
   â†“
Ingress Annotationsï¼ˆå±€éƒ¨ï¼‰
   â†“
ç”Ÿæˆ conf.d/*.confï¼ˆå­é…ç½®ï¼‰
   â†“
Nginx åŠ è½½ï¼šå­é…ç½®è¦†ç›–ä¸»é…ç½®

ğŸ‘‰ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå±€éƒ¨æ³¨è§£ä¼˜å…ˆçº§æ›´é«˜çš„æ ¹æœ¬åŸå› 
ğŸ‘‰ ä¸æ˜¯ Kubernetes çš„è§„åˆ™ï¼Œè€Œæ˜¯ Nginx è‡ªèº«çš„ include + override è¡Œä¸º

â¸»

ä¸‰ã€è¯·æ±‚å¤´ç›¸å…³å‚æ•°çš„é…ç½®æ–¹å¼

1ï¸âƒ£ å…¨å±€é…ç½®ï¼ˆController ConfigMapï¼‰

é€‚åˆåšâ€œé›†ç¾¤åŸºç¡€å…œåº•â€

apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
data:
  client-header-buffer-size: "8k"
  large-client-header-buffers: "4 16k"
  http2-max-field-size: "16k"
  http2-max-header-size: "64k"

âš ï¸ ä¿®æ”¹åå¿…é¡»æ‰§è¡Œï¼š

kubectl rollout restart deployment nginx-ingress-controller -n ingress-nginx

â¸»

2ï¸âƒ£ å±€éƒ¨é…ç½®ï¼ˆIngress Annotationsï¼‰

ç”Ÿäº§é¦–é€‰æ–¹å¼ï¼ˆç²¾å‡†ã€å®‰å…¨ï¼‰

metadata:
  annotations:
    nginx.ingress.kubernetes.io/client-header-buffer-size: "16k"
    nginx.ingress.kubernetes.io/large-client-header-buffers: "4 32k"
    nginx.ingress.kubernetes.io/http2-max-header-size: "128k"

 â€¢ ä»…å½±å“è¯¥ Ingress
 â€¢ è‡ªåŠ¨ reload
 â€¢ è¦†ç›–å…¨å±€é…ç½®

â¸»

å››ã€ä¸‰å±‚æ ¡éªŒæ¨¡å‹ï¼ˆè¿™æ˜¯æ’é”™çš„â€œé’¥åŒ™â€ï¼‰

è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œå–å†³äº ä¸‰å±‚ä¸­æœ€å°çš„é‚£ä¸ªå€¼ï¼š

æœ€ç»ˆå¯é€šè¿‡é˜ˆå€¼ =
Min(
  Ingress ç”Ÿæ•ˆå€¼ï¼ˆå±€éƒ¨ or å…¨å±€ï¼‰
  åç«¯æœåŠ¡é™åˆ¶
)

ä¸‰å±‚è¯´æ˜

å±‚çº§ ç»„ä»¶ æ˜¯å¦ç‹¬ç«‹
ç¬¬ä¸€å±‚ Ingress å…¨å±€ ConfigMap âœ…
ç¬¬äºŒå±‚ Ingress æ³¨è§£ âœ…
ç¬¬ä¸‰å±‚ Upstream åº”ç”¨ï¼ˆSpring / Tomcat / Nodeï¼‰ âœ…

â¸»

ä¸åŒæ‹¦æˆªç‚¹çš„è¡¨ç°å·®å¼‚ï¼ˆéå¸¸å…³é”®ï¼‰

æ‹¦æˆªä½ç½® è¡¨ç°
Ingress æ‹¦æˆª 400 / 413ï¼ŒNginx é»˜è®¤é”™è¯¯é¡µ
åç«¯æ‹¦æˆª 400ï¼ŒIngress æ—¥å¿—æ˜¾ç¤º upstream_status=400

ğŸ‘‰ è¿™æ˜¯åˆ¤æ–­â€œè¯¥ä¸è¯¥ç»§ç»­è°ƒ Ingressâ€çš„å…³é”®ä¾æ®

â¸»

äº”ã€ç”Ÿäº§æ¨èç­–ç•¥ï¼ˆç›´æ¥ç…§è¿™ä¸ªæ¥ï¼‰

âœ… æ¨èç­–ç•¥ï¼šå…¨å±€å…œåº• + å±€éƒ¨æ”¾è¡Œ
 1. å…¨å±€ ConfigMap
 â€¢ æä¾›é€‚ä¸­çš„åŸºç¡€å€¼ï¼ˆ8k / 16kï¼‰
 2. å±€éƒ¨ Ingress
 â€¢ ä»…å¯¹å¤§ Header æœåŠ¡è°ƒå¤§
 3. ä¸šåŠ¡ä¾§
 â€¢ ç²¾ç®€ Cookie / JWTï¼ˆæ ¹æ²»æ–¹æ¡ˆï¼‰

â¸»

âŒ ä¸æ¨èç­–ç•¥
 â€¢ âŒ å…¨å±€è°ƒåˆ° 4 128k
 â€¢ âŒ ä¸ºä¸€ä¸ªæœåŠ¡å½±å“æ•´ä¸ªé›†ç¾¤
 â€¢ âŒ ä¸çœ‹ upstream ç›´æ¥æ— é™æ”¾å¤§ Ingress

â¸»

å…­ã€é…ç½®ä¸ç”Ÿæ•ˆæ’æŸ¥æ¸…å•ï¼ˆæŒ‰é¡ºåºï¼‰
 1. IngressClass æ˜¯å¦åŒ¹é…
 2. ConfigMap æ˜¯å¦é‡å¯ Pod
 3. æ³¨è§£æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆå­—ç¬¦ä¸² + å•ä½ï¼‰
 4. å®é™… Nginx é…ç½®æ˜¯å¦ç”Ÿæˆ
 5. æ˜¯å¦è¢« Upstream æ‹¦æˆª

â¸»

ä¸ƒã€è¯·æ±‚å¤„ç†æµç¨‹å›¾ï¼ˆç»ˆç‰ˆï¼‰

ï¼ˆä½ åŸæ¥çš„ Mermaid å›¾ æ˜¯å¯¹çš„ï¼Œåªéœ€è¦ä½œä¸ºâ€œé™„å½•â€å³å¯ï¼‰

â¸»

æœ€åä¸€å¥æ€»ç»“ï¼ˆé€‚åˆæ”¾åœ¨æ–‡æ¡£å¼€å¤´ï¼‰

Ingress çš„é…ç½®ä¸æ˜¯â€œæ”¹ä¸€ä¸ªåœ°æ–¹å°±ç»“æŸâ€ï¼Œè€Œæ˜¯
å…¨å±€ â†’ å±€éƒ¨ â†’ Upstream ä¸‰å±‚å–æœ€å°å€¼çš„ç³»ç»Ÿè¡Œä¸ºã€‚
400 é”™è¯¯çš„æ’æŸ¥ï¼Œæœ¬è´¨æ˜¯åˆ¤æ–­â€œå¡åœ¨å“ªä¸€å±‚â€ã€‚

â¸»

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ æŠŠè¿™ç‰ˆï¼š
 â€¢ âœ¨ æ”¹æˆ ã€ŠAPI å¹³å° Ingress é…ç½®è§„èŒƒ v1.0ã€‹
 â€¢ âœ¨ æˆ–æ‹†æˆ â€œç”¨æˆ·ä¾§ FAQ + å¹³å°ä¾§ Runbookâ€ ä¸¤ä»½æ–‡æ¡£
 â€¢ âœ¨ æˆ–ç›´æ¥å˜æˆ SRE Support æ ‡å‡†è¯æœ¯

ä½ è¿™ä»½å†…å®¹ï¼Œæœ¬è´¨å·²ç»æ˜¯ å¹³å°çº§èµ„äº§äº†ï¼Œåªæ˜¯ç°åœ¨éœ€è¦â€œå·¥ç¨‹åŒ–åŒ…è£…â€ã€‚

# Ingress Controller å…¨å±€é…ç½®ä¸å±€éƒ¨é…ç½®è¯¦è§£

ä½ æ ¸å¿ƒæƒ³ç†æ¸…**Ingress Controller å…¨å±€é…ç½®ï¼ˆPod å±‚é¢ï¼‰**å’Œ**å•ä¸ª Ingress èµ„æºçš„å±€éƒ¨é…ç½®ï¼ˆç”¨æˆ·/æœåŠ¡çº§åˆ«ï¼‰**ä¹‹é—´çš„**ä¼˜å…ˆçº§å…³ç³»ã€åŠ è½½è§„åˆ™ã€ç”Ÿæ•ˆèŒƒå›´**ï¼Œä»¥åŠå®é™…è¿ç»´ä¸­è¯¥æ€ä¹ˆé…åˆè®¾ç½®ï¼Œè¿™ä¹Ÿæ˜¯è§£å†³ 400 é”™è¯¯æ—¶çš„æ ¸å¿ƒé…ç½®é€»è¾‘â€”â€”æ¯•ç«Ÿå…¨å±€å’Œå±€éƒ¨é…ç½®éƒ½èƒ½ä¿®æ”¹ `large-client-header-buffers`ã€`client_header_buffer_size` è¿™ç±»å…³é”®å‚æ•°ï¼Œç†ä¸æ¸…å…³ç³»å¾ˆå®¹æ˜“å‡ºç°ã€Œæ”¹äº†é…ç½®ä¸ç”Ÿæ•ˆã€ã€Œå±€éƒ¨è¦†ç›–å…¨å±€å¯¼è‡´å…¶ä»–æœåŠ¡å‡ºé—®é¢˜ã€çš„æƒ…å†µã€‚

ä¸‹é¢æˆ‘ä¼šä»**æ ¸å¿ƒè§„åˆ™ï¼ˆä¼˜å…ˆçº§+ç”Ÿæ•ˆèŒƒå›´ï¼‰**ã€**é…ç½®åŠ è½½æµç¨‹**ã€**å…·ä½“é…ç½®æ–¹å¼å¯¹æ¯”**ã€**ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**å››ä¸ªç»´åº¦è®²é€ï¼Œå…¨ç¨‹ç»“åˆã€Œè¯·æ±‚å¤´è¿‡å¤§ã€çš„åœºæ™¯ï¼Œæ‰€æœ‰é…ç½®éƒ½å›´ç»•ä½ è¦è§£å†³çš„ 400 é”™è¯¯å±•å¼€ï¼ŒåŒæ—¶è¡¥å…… Nginx æœ€ç»ˆçš„é…ç½®æ¸²æŸ“é€»è¾‘ï¼Œè®©ä½ çŸ¥é“ã€Œä¸ºä»€ä¹ˆè¿™ä¹ˆé…ä¼šç”Ÿæ•ˆã€ã€‚

## ä¸€ã€æ ¸å¿ƒæ€»è§„åˆ™ï¼šå…ˆè®° 3 ä¸ªå…³é”®ç»“è®ºï¼ˆæ‰€æœ‰é…ç½®éƒ½éµå¾ªï¼‰

è¿™æ˜¯ Nginx Ingress Controller çš„æ ¸å¿ƒè®¾è®¡è§„åˆ™ï¼Œä¸ç®¡æ˜¯è¯·æ±‚å¤´ç›¸å…³é…ç½®ï¼Œè¿˜æ˜¯å…¶ä»– Nginx é…ç½®ï¼ˆå¦‚è¶…æ—¶ã€ç¼“å­˜ã€é™æµï¼‰ï¼Œ**å…¨éƒ¨é€‚ç”¨**ï¼Œå…ˆè®°æ­»è¿™ 3 ç‚¹ï¼Œåç»­æ‰€æœ‰å†…å®¹éƒ½æ˜¯è¿™ä¸ªè§„åˆ™çš„å»¶ä¼¸ï¼š

1. **ä¼˜å…ˆçº§ï¼šå±€éƒ¨ Ingress æ³¨è§£ > å…¨å±€ ConfigMap é…ç½® > Nginx åŸç”Ÿé»˜è®¤å€¼**

   ç®€å•è¯´ï¼š**æœåŠ¡çº§é…ç½®ä¼šè¦†ç›–é›†ç¾¤çº§å…¨å±€é…ç½®ï¼Œå…¨å±€é…ç½®ä¼šè¦†ç›– Nginx æœ¬èº«çš„é»˜è®¤å€¼**ï¼Œæœ€ç»ˆ Nginx Ingress Pod åŠ è½½çš„ Nginx é…ç½®ï¼Œæ˜¯ã€Œå…¨å±€åŸºç¡€ + å±€éƒ¨è¦†ç›–ã€çš„ç»„åˆã€‚

2. **ç”Ÿæ•ˆèŒƒå›´ï¼šå…¨å±€é…ç½®ä½œç”¨äºæ‰€æœ‰æœåŠ¡ï¼Œå±€éƒ¨é…ç½®ä»…ä½œç”¨äºå½“å‰ Ingress è·¯ç”±çš„æœåŠ¡**
   - å…¨å±€é…ç½®ï¼ˆPod å±‚é¢ï¼‰ï¼šä¿®æ”¹åï¼Œ**é›†ç¾¤ä¸­æ‰€æœ‰é€šè¿‡è¯¥ Ingress Controller è®¿é—®çš„æœåŠ¡**éƒ½ä¼šç”Ÿæ•ˆï¼›
   - å±€éƒ¨é…ç½®ï¼ˆç”¨æˆ·/æœåŠ¡çº§åˆ«ï¼‰ï¼šä»…**å½“å‰ Ingress èµ„æºä¸­ `rules` é‡Œé…ç½®çš„åŸŸåã€è·¯å¾„å¯¹åº”çš„æœåŠ¡**ç”Ÿæ•ˆï¼Œå…¶ä»–æœåŠ¡ä¸å—å½±å“ã€‚

3. **é…ç½®ç±»å‹ï¼šåªæœ‰ Nginx Ingress æ”¯æŒçš„ã€Œå¯é…ç½®é¡¹ã€æ‰èƒ½è¢«å…¨å±€/å±€éƒ¨ä¿®æ”¹**

   Nginx Ingress Controller åšäº†ä¸€å±‚å°è£…ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰ Nginx åŸç”Ÿé…ç½®éƒ½èƒ½é€šè¿‡ã€ŒConfigMap å…¨å±€é…ç½®ã€æˆ–ã€ŒIngress æ³¨è§£å±€éƒ¨é…ç½®ã€ä¿®æ”¹ï¼Œåªæœ‰å…¶å®˜æ–¹å£°æ˜çš„**å¯é…ç½®å‚æ•°**æ‰æ”¯æŒï¼ˆè¯·æ±‚å¤´ç›¸å…³çš„ä¸¤ä¸ªæ ¸å¿ƒå‚æ•°æ˜¯åŸç”Ÿæ”¯æŒçš„ï¼Œæ”¾å¿ƒé…ç½®ï¼‰ã€‚

## äºŒã€è¯·æ±‚å¤´ç›¸å…³é…ç½®çš„ã€Œå…¨å±€+å±€éƒ¨ã€åŠ è½½æµç¨‹ï¼ˆå¯è§†åŒ–ï¼‰

ä»¥ä½ è¦è§£å†³çš„ 400 é”™è¯¯æ ¸å¿ƒå‚æ•° `client_header_buffer_size`ã€`large-client-header-buffers` ä¸ºä¾‹ï¼Œç»“åˆ Nginx Ingress Controller çš„å·¥ä½œæœºåˆ¶ï¼Œ**ä»é…ç½®åˆ° Nginx å®é™…åŠ è½½**çš„å®Œæ•´æµç¨‹å¦‚ä¸‹ï¼Œçœ‹å®Œå°±çŸ¥é“ã€Œä½ çš„é…ç½®æœ€ç»ˆå»å“ªäº†ã€ï¼š

```
1. é›†ç¾¤å…¨å±€é…ç½®ï¼šIngress Controller ConfigMapï¼ˆå¦‚nginx-ingress-controllerï¼‰
   â†“
   ï¼ˆä½œä¸ºæ‰€æœ‰æœåŠ¡çš„åŸºç¡€é…ç½®ï¼Œæ¸²æŸ“åˆ° Nginx ä¸»é…ç½®æ–‡ä»¶ nginx.confï¼‰
2. æœåŠ¡å±€éƒ¨é…ç½®ï¼šå•ä¸ª Ingress èµ„æºçš„ annotations æ³¨è§£
   â†“
   ï¼ˆé’ˆå¯¹å½“å‰æœåŠ¡ï¼Œç”Ÿæˆ Nginx å­é…ç½®æ–‡ä»¶ /etc/nginx/conf.d/xxx.confï¼Œè¦†ç›–ä¸»é…ç½®çš„å¯¹åº”å‚æ•°ï¼‰
3. Ingress Controller Pod é‡è½½é…ç½®ï¼š
   - å±€éƒ¨é…ç½®ä¿®æ”¹ï¼šè‡ªåŠ¨æ£€æµ‹ï¼ˆçº¦10sï¼‰â†’ æ— æ„ŸçŸ¥é‡è½½ Nginx é…ç½®ï¼Œæ— éœ€é‡å¯ Podï¼›
   - å…¨å±€é…ç½®ä¿®æ”¹ï¼šéœ€æ‰‹åŠ¨é‡å¯ Pod â†’ é‡æ–°æŒ‚è½½ ConfigMap â†’ é‡è½½ Nginx é…ç½®ï¼›
4. Nginx æœ€ç»ˆç”Ÿæ•ˆé…ç½®ï¼šä¸»é…ç½®ï¼ˆå…¨å±€ï¼‰+ å­é…ç½®ï¼ˆå±€éƒ¨è¦†ç›–ï¼‰çš„ç»„åˆï¼Œå¤„ç†æ‰€æœ‰è¯·æ±‚ã€‚
```

**å…³é”®ç»†èŠ‚**ï¼šNginx Ingress Controller ä¼šå°†ã€Œå…¨å±€ ConfigMapã€æ¸²æŸ“åˆ° Nginx çš„**ä¸»é…ç½®æ–‡ä»¶ `nginx.conf`**ï¼ˆå…¨å±€ç”Ÿæ•ˆï¼‰ï¼Œå°†æ¯ä¸ª Ingress èµ„æºçš„ã€Œæ³¨è§£ã€æ¸²æŸ“åˆ°å¯¹åº”çš„**å­é…ç½®æ–‡ä»¶**ï¼ˆæ¯”å¦‚æŒ‰å‘½åç©ºé—´+Ingress åç”Ÿæˆï¼Œä»…å¯¹åº”åŸŸå/è·¯å¾„ç”Ÿæ•ˆï¼‰ï¼Œè€Œ Nginx çš„é…ç½®åŠ è½½è§„åˆ™æœ¬èº«å°±æ˜¯ã€Œå­é…ç½®è¦†ç›–ä¸»é…ç½®åŒåå­—æ®µã€ï¼Œè¿™ä¹Ÿæ˜¯ã€Œå±€éƒ¨æ³¨è§£ä¼˜å…ˆçº§æ›´é«˜ã€çš„**åº•å±‚åŸå› **ã€‚

## ä¸‰ã€å…¨å±€é…ç½®ï¼ˆIngress Controller Pod å±‚é¢ï¼‰ï¼šConfigMap é…ç½®

### 1. æ˜¯ä»€ä¹ˆï¼Ÿ

Ingress Controller çš„ Pod ä¼š**æŒ‚è½½ä¸€ä¸ªä¸“å±çš„ ConfigMap**ï¼ˆé€šå¸¸åœ¨ `ingress-nginx` å‘½åç©ºé—´ï¼Œåç§°é»˜è®¤æ˜¯ `nginx-ingress-controller`ï¼‰ï¼Œè¿™ä¸ª ConfigMap æ˜¯**é›†ç¾¤çº§çš„å…¨å±€é…ç½®ä¸­å¿ƒ**ï¼Œé‡Œé¢çš„æ‰€æœ‰é…ç½®é¡¹éƒ½ä¼šä½œç”¨äºè¯¥ Ingress Controller ç®¡ç†çš„**æ‰€æœ‰ Ingress èµ„æºã€æ‰€æœ‰æœåŠ¡**ã€‚

ä½ è¯´çš„ã€ŒIngress Controller Pod é‡Œé¢å¯¹åº”çš„é…ç½®ã€ï¼Œæœ¬è´¨å°±æ˜¯è¿™ä¸ª ConfigMapâ€”â€”Pod å¯åŠ¨æ—¶ä¼šå°† ConfigMap ä¸­çš„é…ç½®åŠ è½½ä¸º Nginx ä¸»é…ç½®ï¼ŒPod å†…çš„ Nginx é…ç½®æœ€ç»ˆéƒ½æ˜¯ä»è¿™ä¸ª ConfigMap ï¼ˆ+ å±€éƒ¨ Ingress æ³¨è§£ï¼‰ç”Ÿæˆçš„ï¼Œä¿®æ”¹ ConfigMap å°±æ˜¯ä¿®æ”¹ Pod å±‚é¢çš„å…¨å±€é…ç½®ã€‚

### 2. é…ç½®æ–¹å¼ï¼ˆè¯·æ±‚å¤´ç›¸å…³ï¼‰

ç¼–è¾‘ ConfigMapï¼Œåœ¨ `data` å­—æ®µä¸­æ·»åŠ è¯·æ±‚å¤´æ ¸å¿ƒå‚æ•°ï¼Œå€¼ä¸º**å­—ç¬¦ä¸²æ ¼å¼**ï¼ˆå’Œ Nginx åŸç”Ÿé…ç½®ä¸€è‡´ï¼‰ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-ingress-controller # å…¨å±€ConfigMapåç§°ï¼Œé»˜è®¤è¿™ä¸ª
  namespace: ingress-nginx # Ingress Controlleræ‰€åœ¨å‘½åç©ºé—´ï¼Œå¤§éƒ¨åˆ†æ˜¯è¿™ä¸ª
data:
  # å…¨å±€å¸¸è§„è¯·æ±‚å¤´ç¼“å†²åŒºå¤§å°ï¼Œæ›¿ä»£NginxåŸç”Ÿé»˜è®¤å€¼ï¼ˆé€šå¸¸1k/4kï¼‰
  client-header-buffer-size: "8k"
  # å…¨å±€å¤§è¯·æ±‚å¤´ç¼“å†²åŒºï¼Œæ ¼å¼ï¼šæ•°é‡ å•ä¸ªå¤§å°ï¼Œæ›¿ä»£NginxåŸç”Ÿé»˜è®¤å€¼4 8k
  large-client-header-buffers: "4 16k"
  # å¯é€‰ï¼šHTTP/2åè®®å…¨å±€é…ç½®ï¼ˆå¦‚æœä¸šåŠ¡ç”¨HTTPS+HTTP/2ï¼‰
  http2-max-field-size: "16k"
  http2-max-header-size: "64k"
```

### 3. ç”Ÿæ•ˆæ–¹å¼

å› ä¸º ConfigMap æ˜¯**é™æ€æŒ‚è½½**åˆ° Ingress Controller Pod ä¸­çš„ï¼Œä¿®æ”¹å Pod ä¸ä¼šè‡ªåŠ¨æ„ŸçŸ¥ï¼Œå¿…é¡»**æ»šåŠ¨é‡å¯ Pod** æ‰èƒ½è®©é…ç½®ç”Ÿæ•ˆï¼ˆæ»šåŠ¨é‡å¯ä¸ä¼šä¸­æ–­æœåŠ¡ï¼Œç”Ÿäº§æ¨èï¼‰ï¼š

```bash
# æ»šåŠ¨é‡å¯Ingress Controllerçš„Deploymentï¼ˆå¤§éƒ¨åˆ†éƒ¨ç½²æ–¹å¼æ˜¯Deploymentï¼‰
kubectl rollout restart deployment nginx-ingress-controller -n ingress-nginx
# å¦‚æœæ˜¯DaemonSetéƒ¨ç½²ï¼ˆæ¯”å¦‚è£¸é‡‘å±é›†ç¾¤ï¼‰ï¼Œé‡å¯DaemonSet
kubectl rollout restart daemonset nginx-ingress-controller -n ingress-nginx
```

### 4. é€‚ç”¨åœºæ™¯

- é›†ç¾¤ä¸­**80%ä»¥ä¸Šçš„æœåŠ¡**éƒ½å­˜åœ¨è¯·æ±‚å¤´è¿‡å¤§çš„é—®é¢˜ï¼Œéœ€è¦ç»Ÿä¸€æå‡é˜ˆå€¼ï¼›
- æ–°æœåŠ¡ä¸Šçº¿å‰ï¼Œæå‰é…ç½®å…¨å±€åŸºç¡€é˜ˆå€¼ï¼Œé¿å…åç»­é‡å¤åŠ å±€éƒ¨æ³¨è§£ï¼›
- ä½œä¸º**é›†ç¾¤çš„é»˜è®¤åŸºç¡€é…ç½®**ï¼Œè®¾ç½®ä¸€ä¸ªã€Œé€‚ä¸­çš„é˜ˆå€¼ã€ï¼ˆæ¯”å¦‚8k/4 16kï¼‰ï¼Œå…¼é¡¾å¤§éƒ¨åˆ†å¸¸è§„ä¸šåŠ¡ã€‚

## å››ã€å±€éƒ¨é…ç½®ï¼ˆç”¨æˆ·/æœåŠ¡çº§åˆ«ï¼‰ï¼šIngress æ³¨è§£é…ç½®

### 1. æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨**å•ä¸ª Ingress èµ„æº**çš„ `metadata.annotations` ä¸­æ·»åŠ  Nginx Ingress ä¸“å±æ³¨è§£ï¼Œè¿™äº›æ³¨è§£ä»…ä½œç”¨äºè¯¥ Ingress ä¸­ `spec.rules` é…ç½®çš„**åŸŸåã€è·¯å¾„å¯¹åº”çš„æœåŠ¡**ï¼Œæ˜¯**æœåŠ¡çº§çš„ç²¾å‡†é…ç½®**ã€‚

æ³¨è§£çš„æ ¸å¿ƒæ ¼å¼æ˜¯ `nginx.ingress.kubernetes.io/xxx: "å€¼"`ï¼Œå…¶ä¸­ `xxx` å¯¹åº” Nginx é…ç½®é¡¹ï¼ˆé©¼å³°è½¬è¿å­—ç¬¦ï¼‰ï¼Œå€¼ä¸ºå­—ç¬¦ä¸²æ ¼å¼ï¼Œå’Œå…¨å±€ ConfigMap ä¸€è‡´ã€‚

### 2. é…ç½®æ–¹å¼ï¼ˆè¯·æ±‚å¤´ç›¸å…³ï¼‰

åœ¨éœ€è¦è§£å†³ 400 é”™è¯¯çš„æœåŠ¡å¯¹åº”çš„ Ingress ä¸­æ·»åŠ æ³¨è§£ï¼Œ**ç›´æ¥è¦†ç›–å…¨å±€ ConfigMap çš„åŒå‚æ•°é…ç½®**ï¼š

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: user-service-ingress # å•ä¸ªæœåŠ¡çš„Ingressåç§°
  namespace: prod # æœåŠ¡æ‰€åœ¨å‘½åç©ºé—´
  annotations:
    # å±€éƒ¨å¸¸è§„ç¼“å†²åŒºï¼Œè¦†ç›–å…¨å±€çš„8kï¼Œè°ƒå¤§åˆ°16k
    nginx.ingress.kubernetes.io/client-header-buffer-size: "16k"
    # å±€éƒ¨å¤§å¤´éƒ¨ç¼“å†²åŒºï¼Œè¦†ç›–å…¨å±€çš„4 16kï¼Œè°ƒå¤§åˆ°4 32kï¼ˆæ€»128kï¼Œå•å­—æ®µ32kï¼‰
    nginx.ingress.kubernetes.io/large-client-header-buffers: "4 32k"
    # å¯é€‰ï¼šHTTP/2å±€éƒ¨é…ç½®ï¼Œè¦†ç›–å…¨å±€
    nginx.ingress.kubernetes.io/http2-max-field-size: "32k"
    nginx.ingress.kubernetes.io/http2-max-header-size: "128k"
    # å¿…é¡»æŒ‡å®šIngressç±»åï¼Œå…³è”åˆ°å¯¹åº”çš„Ingress Controller
    kubernetes.io/ingress.class: "nginx"
    # æˆ–æ–°ç‰ˆçš„ingressClassNameï¼ˆk8s 1.19+æ¨èï¼‰
    # ingressClassName: nginx
spec:
  rules:
  - host: user.example.com # è¯¥é…ç½®ä»…ä½œç”¨äºè¿™ä¸ªåŸŸå
    http:
      paths:
      - path: /api/user # ä»…ä½œç”¨äºè¿™ä¸ªè·¯å¾„
        pathType: Prefix
        backend:
          service:
            name: user-service # ä»…ä½œç”¨äºè¿™ä¸ªæœåŠ¡
            port:
              number: 80
```

### 3. ç”Ÿæ•ˆæ–¹å¼

**æ— éœ€é‡å¯ä»»ä½• Pod**ï¼Nginx Ingress Controller ä¼š**å®æ—¶ç›‘æ§**é›†ç¾¤ä¸­ Ingress èµ„æºçš„å˜åŒ–ï¼ˆé€šè¿‡ K8s API Server çš„ Watch æœºåˆ¶ï¼‰ï¼Œå½“æ£€æµ‹åˆ°æ³¨è§£ä¿®æ”¹åï¼Œä¼šåœ¨**10ç§’å†…è‡ªåŠ¨é‡è½½** Nginx é…ç½®ï¼Œæ–°çš„å±€éƒ¨é…ç½®ç«‹å³ç”Ÿæ•ˆï¼Œè¿™æ˜¯å±€éƒ¨é…ç½®æœ€æ ¸å¿ƒçš„ä¼˜åŠ¿ã€‚

### 4. é€‚ç”¨åœºæ™¯

- é›†ç¾¤ä¸­**å°‘æ•°æœåŠ¡**å­˜åœ¨è¯·æ±‚å¤´è¿‡å¤§çš„é—®é¢˜ï¼ˆæ¯”å¦‚ç®¡ç†åå°ã€æ•°æ®å¤§å±ã€éœ€è¦æºå¸¦å¤§ JWT çš„æœåŠ¡ï¼‰ï¼Œç²¾å‡†é€‚é…ï¼Œä¸å½±å“å…¶ä»–æœåŠ¡ï¼›
- éƒ¨åˆ†æœåŠ¡éœ€è¦**æ›´é«˜çš„é˜ˆå€¼**ï¼ˆæ¯”å¦‚å•å­—æ®µ32kã€æ€»128kï¼‰ï¼Œè€Œå¤§éƒ¨åˆ†æœåŠ¡ç”¨å…¨å±€çš„é€‚ä¸­é˜ˆå€¼å³å¯ï¼›
- ç”Ÿäº§ç¯å¢ƒ**é¦–é€‰æ–¹å¼**ï¼šé¿å…å…¨å±€è°ƒå¤§å¸¦æ¥çš„å®‰å…¨é£é™©ï¼Œä»…å¯¹æœ‰éœ€æ±‚çš„æœåŠ¡æå‡é˜ˆå€¼ã€‚

## äº”ã€å…³é”®å¯¹æ¯”ï¼šå…¨å±€ ConfigMap vs å±€éƒ¨ Ingress æ³¨è§£

ä¸ºäº†è®©ä½ å¿«é€Ÿé€‰æ‹©é…ç½®æ–¹å¼ï¼Œæ•´ç†äº†æ ¸å¿ƒç»´åº¦çš„å¯¹æ¯”è¡¨ï¼Œé‡ç‚¹å…³æ³¨**ç”Ÿæ•ˆèŒƒå›´ã€ç”Ÿæ•ˆæ–¹å¼ã€å®‰å…¨é£é™©**ä¸‰ä¸ªæ ¸å¿ƒç‚¹ï¼š

| å¯¹æ¯”ç»´åº¦ | å…¨å±€ ConfigMapï¼ˆPod å±‚é¢ï¼‰| å±€éƒ¨ Ingress æ³¨è§£ï¼ˆç”¨æˆ·/æœåŠ¡çº§åˆ«ï¼‰ |
|------------------|---------------------------------------------|---------------------------------------------|
| **ä¼˜å…ˆçº§** | ä½ï¼ˆè¢«å±€éƒ¨æ³¨è§£è¦†ç›–ï¼‰| é«˜ï¼ˆè¦†ç›–å…¨å±€é…ç½®ï¼‰|
| **ç”Ÿæ•ˆèŒƒå›´** | æ‰€æœ‰é€šè¿‡è¯¥ Ingress Controller çš„æœåŠ¡ | ä»…å½“å‰ Ingress è·¯ç”±çš„åŸŸå/è·¯å¾„/æœåŠ¡ |
| **ç”Ÿæ•ˆæ–¹å¼** | éœ€æ»šåŠ¨é‡å¯ Ingress Controller Pod | è‡ªåŠ¨é‡è½½ï¼Œæ— éœ€é‡å¯ä»»ä½• Pod |
| **å®‰å…¨é£é™©** | é«˜ï¼ˆå…¨å±€è°ƒå¤§æ˜“è¢«æ”»å‡»ï¼Œå½±å“æ‰€æœ‰æœåŠ¡ï¼‰| ä½ï¼ˆä»…å¯¹æŒ‡å®šæœåŠ¡è°ƒå¤§ï¼Œé£é™©å¯æ§ï¼‰|
| **é…ç½®å¤æ‚åº¦** | ä½ï¼ˆä¸€æ¬¡é…ç½®ï¼Œæ‰€æœ‰æœåŠ¡ç”Ÿæ•ˆï¼‰| ä¸­ï¼ˆéœ€ä¸ºæ¯ä¸ªæœ‰éœ€æ±‚çš„æœåŠ¡æ·»åŠ æ³¨è§£ï¼‰|
| **è¿ç»´æˆæœ¬** | ä½ï¼ˆåç»­æ— éœ€é‡å¤é…ç½®ï¼‰| ç•¥é«˜ï¼ˆæ–°æœåŠ¡æœ‰éœ€æ±‚æ—¶éœ€åŠ æ³¨è§£ï¼‰|
| **ç”Ÿäº§æ¨èåº¦** | â­â­â­ï¼ˆä»…å¤šæœåŠ¡éœ€è¦æ—¶ç”¨ï¼‰| â­â­â­â­â­ï¼ˆç”Ÿäº§é¦–é€‰ï¼Œç²¾å‡†å¯æ§ï¼‰|

## å…­ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µï¼ˆè¯·æ±‚å¤´è¿‡å¤§é—®é¢˜ï¼‰

ç»“åˆä¼˜å…ˆçº§ã€å®‰å…¨é£é™©ã€è¿ç»´æˆæœ¬ï¼Œé’ˆå¯¹ 400 `Request Header Or Cookie Too Large` é”™è¯¯ï¼Œç»™å‡º**ç”Ÿäº§ç¯å¢ƒå¯ç›´æ¥è½åœ°çš„é…ç½®ç­–ç•¥**ï¼Œå…¼é¡¾ã€Œè§£å†³é—®é¢˜ã€å’Œã€Œå®‰å…¨å¯æ§ã€ï¼š

### ç­–ç•¥1ï¼šå…¨å±€å…œåº• + å±€éƒ¨ç²¾å‡†è°ƒä¼˜ï¼ˆæ¨èï¼‰

è¿™æ˜¯æœ€åˆç†çš„ç»„åˆæ–¹å¼ï¼Œä¹Ÿæ˜¯å¤§å‚ä¸»æµåšæ³•ï¼š

1. **å…¨å±€ ConfigMap é…ç½®é€‚ä¸­çš„åŸºç¡€é˜ˆå€¼**ï¼šè¦†ç›– Nginx åŸç”Ÿçš„ä¿å®ˆé»˜è®¤å€¼ï¼Œé€‚é…å¤§éƒ¨åˆ†å¸¸è§„ä¸šåŠ¡ï¼Œé¿å…å¤§éƒ¨åˆ†æœåŠ¡è§¦å‘ 400ï¼›

   æ¨èé…ç½®ï¼š

   ```yaml
   client-header-buffer-size: "8k"
   large-client-header-buffers: "4 16k"
   http2-max-field-size: "16k"
   http2-max-header-size: "64k"
   ```

2. **å±€éƒ¨ Ingress æ³¨è§£ä¸ºç‰¹æ®ŠæœåŠ¡è°ƒå¤§é˜ˆå€¼**ï¼šä»…å¯¹æœ‰å¤§è¯·æ±‚å¤´éœ€æ±‚çš„æœåŠ¡ï¼ˆå¦‚ç®¡ç†åå°ã€å¤§ JWT æœåŠ¡ï¼‰ï¼Œåœ¨å…¶ Ingress ä¸­æ·»åŠ æ³¨è§£ï¼Œè°ƒå¤§åˆ°æ»¡è¶³ä¸šåŠ¡çš„é˜ˆå€¼ï¼›

   ç¤ºä¾‹ï¼ˆå•å­—æ®µæœ€å¤§32kã€æ€»128kï¼‰ï¼š

   ```yaml
   nginx.ingress.kubernetes.io/client-header-buffer-size: "16k"
   nginx.ingress.kubernetes.io/large-client-header-buffers: "4 32k"
   ```

3. **æ ¹æºä¼˜åŒ–**ï¼šå¯¹å±€éƒ¨è°ƒå¤§çš„æœåŠ¡ï¼ŒåŒæ­¥æ¨åŠ¨å‰ç«¯/ä¸šåŠ¡ä¾§ç²¾ç®€è¯·æ±‚å¤´ï¼ˆå¦‚å‡å°‘ Cookieã€ç²¾ç®€ JWTã€è¿‡æ»¤æ— ç”¨å¤´ï¼‰ï¼Œä»æ ¹æºè§£å†³é—®é¢˜ã€‚

### ç­–ç•¥2ï¼šä»…å±€éƒ¨é…ç½®ï¼ˆé€‚åˆé›†ç¾¤å¤§éƒ¨åˆ†æœåŠ¡æ— å¤§å¤´éƒ¨éœ€æ±‚ï¼‰

å¦‚æœä½ çš„é›†ç¾¤ä¸­åªæœ‰ 1-2 ä¸ªæœåŠ¡å­˜åœ¨è¯·æ±‚å¤´è¿‡å¤§é—®é¢˜ï¼Œ**æ— éœ€ä¿®æ”¹å…¨å±€ ConfigMap**ï¼Œç›´æ¥åœ¨å¯¹åº”æœåŠ¡çš„ Ingress ä¸­æ·»åŠ å±€éƒ¨æ³¨è§£å³å¯ï¼Œä¿ç•™ Nginx åŸç”Ÿçš„å…¨å±€é»˜è®¤å€¼ï¼Œæœ€å¤§åŒ–ä¿è¯é›†ç¾¤å®‰å…¨ã€‚

### ç­–ç•¥3ï¼šç¦æ­¢æ— é™åˆ¶è°ƒå¤§å…¨å±€é…ç½®

**ç»å¯¹ä¸è¦**ä¸ºäº†è§£å†³ä¸ªåˆ«æœåŠ¡çš„é—®é¢˜ï¼Œå°†å…¨å±€ ConfigMap çš„é˜ˆå€¼è°ƒåˆ°æå¤§ï¼ˆæ¯”å¦‚ `4 128k`ã€`4 256k`ï¼‰â€”â€”è¿™ä¼šè®©æ•´ä¸ªé›†ç¾¤çš„ Ingress Controller æš´éœ²åœ¨ã€Œå¤§å¤´éƒ¨æ”»å‡»ã€çš„é£é™©ä¸­ï¼Œæ”»å‡»è€…åªéœ€æ„é€ å°‘é‡è¶…å¤§è¯·æ±‚å¤´è¯·æ±‚ï¼Œå°±èƒ½è€—å°½ Ingress Pod çš„å†…å­˜ï¼Œå¯¼è‡´ Pod OOMï¼Œå½±å“æ‰€æœ‰æœåŠ¡çš„å¯ç”¨æ€§ã€‚

## ä¸ƒã€æ’é”™ï¼šé…ç½®ä¿®æ”¹åä¸ç”Ÿæ•ˆçš„å¸¸è§åŸå› 

å¦‚æœæŒ‰ä¸Šè¿°æ–¹å¼é…ç½®åï¼Œ400 é”™è¯¯ä¾ç„¶å­˜åœ¨ï¼Œå¤§æ¦‚ç‡æ˜¯**é…ç½®ä¼˜å…ˆçº§/ç”Ÿæ•ˆæ–¹å¼**çš„é—®é¢˜ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ’æŸ¥ï¼Œ99% èƒ½è§£å†³ï¼š

1. **æ£€æŸ¥æ˜¯å¦é…ç½®äº†æ­£ç¡®çš„ Ingress ç±»å**ï¼šç¡®ä¿ Ingress ä¸­çš„ `kubernetes.io/ingress.class: "nginx"` æˆ– `ingressClassName: nginx` ä¸ Ingress Controller çš„ç±»åä¸€è‡´ï¼Œå¦åˆ™é…ç½®ä¸ä¼šè¢«è¯¥ Controller åŠ è½½ï¼›

2. **æ£€æŸ¥å±€éƒ¨æ³¨è§£æ˜¯å¦è¦†ç›–äº†å…¨å±€é…ç½®**ï¼šå¦‚æœåŒæ—¶é…ç½®äº†å…¨å±€å’Œå±€éƒ¨ï¼Œä»¥å±€éƒ¨æ³¨è§£ä¸ºå‡†ï¼Œå¯é€šè¿‡ã€ŒæŸ¥çœ‹ Nginx å®é™…é…ç½®ã€éªŒè¯ï¼›

3. **å…¨å±€é…ç½®æ˜¯å¦é‡å¯äº† Pod**ï¼šä¿®æ”¹ ConfigMap åï¼Œå¿…é¡»æ»šåŠ¨é‡å¯ Ingress Controller Podï¼Œå¦åˆ™é…ç½®ä¸ä¼šåŠ è½½ï¼›

4. **æ£€æŸ¥å‚æ•°æ ¼å¼æ˜¯å¦æ­£ç¡®**ï¼šæ‰€æœ‰å€¼å¿…é¡»æ˜¯**å­—ç¬¦ä¸²**ï¼ˆåŠ å¼•å·ï¼‰ï¼Œæ ¼å¼ä¸º `æ•°é‡ å•ä¸ªå¤§å°`ï¼ˆå¦‚ `"4 32k"`ï¼‰ï¼Œä¸èƒ½å°‘ç©ºæ ¼ã€ä¸èƒ½å†™é”™å•ä½ï¼ˆåªèƒ½æ˜¯ k/mï¼Œå°å†™ï¼‰ï¼›

5. **æŸ¥çœ‹ Ingress Controller æ—¥å¿—**ï¼šæ’æŸ¥é…ç½®æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ï¼Œæ—¥å¿—ä¸­ä¼šæç¤ºæ— æ•ˆé…ç½®ï¼š

   ```bash
   kubectl logs -n ingress-nginx <ingress-pod-name> | grep -i error
   ```

6. **éªŒè¯ Nginx å®é™…ç”Ÿæ•ˆé…ç½®**ï¼šè¿›å…¥ Ingress Controller Podï¼ŒæŸ¥çœ‹ç”Ÿæˆçš„ Nginx é…ç½®æ–‡ä»¶ï¼Œç¡®è®¤å‚æ•°æ˜¯å¦æ­£ç¡®åŠ è½½ï¼š

   ```bash
   # è¿›å…¥Ingress Pod
   kubectl exec -it -n ingress-nginx <ingress-pod-name> -- /bin/bash
   # æŸ¥çœ‹ä¸»é…ç½®ï¼ˆå…¨å±€ï¼‰
   cat /etc/nginx/nginx.conf | grep -E "client-header-buffer-size|large-client-header-buffers"
   # æŸ¥çœ‹å­é…ç½®ï¼ˆå±€éƒ¨ï¼ŒæŒ‰åŸŸåæ‰¾å¯¹åº”çš„confæ–‡ä»¶ï¼‰
   cat /etc/nginx/conf.d/prod-user-service-ingress.conf | grep -E "client-header-buffer-size|large-client-header-buffers"
   ```

   å¦‚æœå­é…ç½®ä¸­èƒ½çœ‹åˆ°å±€éƒ¨æ³¨è§£çš„å‚æ•°ï¼Œè¯´æ˜é…ç½®å·²æ­£ç¡®ç”Ÿæ•ˆã€‚

## å…«ã€æ·±åº¦ç†è§£ï¼šä¸‰å±‚å…³å¡é€»è¾‘ï¼ˆGlobal, Local, Upstreamï¼‰

ä¸ºäº†å½»åº•ç†æ¸…é…ç½®ä¸ç”Ÿæ•ˆçš„åŸå› ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹**ã€Œä¸‰é“å…³å¡ã€**çš„æ€ç»´æ¨¡å‹ã€‚è¿™æ¯”ç®€å•çš„ã€Œè¦†ç›–ã€å…³ç³»æ›´å‡†ç¡®ï¼š

### ç¬¬ä¸€å…³ä¸ç¬¬äºŒå…³ï¼šNginx å†…éƒ¨çš„ã€Œèåˆæœºåˆ¶ã€

è¿™ä¸¤å±‚ç‰©ç†ä¸Šéƒ½åœ¨ **Ingress Controller Pod (Nginx)** å†…éƒ¨å‘ç”Ÿï¼Œä½†åœ¨**é€»è¾‘é…ç½®**ä¸Šæ˜¯å‰ä¸¤é“é˜²çº¿ï¼š

- **ç¬¬ä¸€å±‚ï¼ˆåŸºå‡†çº¿ï¼‰ï¼šIngress Controller å…¨å±€é…ç½® (ConfigMap)**
  - è¿™æ˜¯é›†ç¾¤çš„**é»˜è®¤åº•åº§**ã€‚å¦‚æœä½ çš„ Ingress èµ„æºé‡Œä»€ä¹ˆéƒ½æ²¡å†™ï¼Œè¿™ä¸€å±‚çš„é…ç½®å°±æ˜¯ä½ çš„ã€Œå¤©èŠ±æ¿ã€ã€‚
- **ç¬¬äºŒå±‚ï¼ˆè¦†ç›–å±‚ï¼‰ï¼šIngress Resource å±€éƒ¨é…ç½® (Annotations)**
  - è¿™æ˜¯é’ˆå¯¹ç‰¹å®šåŸŸåçš„**ç²¾å‡†é‡å†™**ã€‚
  - **å…³ç³»**ï¼š**Overrideï¼ˆè¦†ç›–/åˆå¹¶ï¼‰**ã€‚
  - **æœ€ç»ˆç”Ÿæ•ˆå€¼** = `å±€éƒ¨é…ç½®`ï¼ˆå¦‚æœæœ‰ï¼‰ **å¦åˆ™** `å…¨å±€é…ç½®`ã€‚
  - _æ³¨æ„ï¼šè¿™åªæ˜¯å†³å®šäº† Nginx è¿™ä¸€ä¾§çš„é™åˆ¶æ˜¯å¤šå°‘ã€‚_

### ç¬¬ä¸‰å…³ï¼šç‹¬ç«‹åº”ç”¨å±‚
- **ç¬¬ä¸‰å±‚ï¼ˆç»ˆç‚¹ç«™ï¼‰ï¼šUpstream åç«¯æœåŠ¡ (App Server)**
  - è¿™æ˜¯ä¸šåŠ¡ä»£ç è¿è¡Œçš„åœ°æ–¹ï¼ˆSpring Boot, Node.js ç­‰ï¼‰ã€‚
  - **å…³ç³»**ï¼š**Serialï¼ˆä¸²è¡Œ/æµæ°´çº¿ï¼‰**ã€‚
  - å³ä½¿è¯·æ±‚é€šè¿‡äº†å‰ä¸¤å±‚çš„ Nginx æ ¡éªŒï¼Œåˆ°è¾¾è¿™é‡Œæ—¶ï¼Œåç«¯æœåŠ¡ä¼šè¿›è¡Œ**ç‹¬ç«‹äºŒæ¬¡æ ¡éªŒ**ã€‚

### çœŸæ­£çš„ã€Œæœ¨æ¡¶æ•ˆåº”ã€ä¸ä¸åŒæŠ¥é”™è¡¨ç°

è¯·æ±‚èƒ½å¦æˆåŠŸï¼Œå–å†³äº**ç”Ÿæ•ˆçš„ Nginx é…ç½®**ä¸**åç«¯æœåŠ¡é…ç½®**ä¸­**è¾ƒå°**çš„é‚£ä¸ªå€¼ï¼š

> **é€šè¿‡é˜ˆå€¼ = Min( (å±€éƒ¨æ³¨è§£ || å…¨å±€ConfigMap), åç«¯æœåŠ¡é…ç½® )**

**ä¸åŒå…³å¡æ‹’ç»æ—¶çš„è¡¨ç°å·®å¼‚ï¼ˆå…³é”®æ’æŸ¥ä¾æ®ï¼‰**ï¼š

- **åœºæ™¯ Aï¼šè¢« Ingressï¼ˆç¬¬ä¸€/äºŒå…³ï¼‰æ‹¦æˆª**
  - **é…ç½®ç°çŠ¶**ï¼šIngress é™åˆ¶ **8k**ï¼Œåç«¯é™åˆ¶ **32k**ã€‚
  - **æµ‹è¯•è¡Œä¸º**ï¼šå‘é€ **16k** å¤´éƒ¨è¯·æ±‚ã€‚
  - **ç»“æœ**ï¼šIngress ç›´æ¥æ‹’ç»ï¼Œæµé‡**æœªåˆ°è¾¾**åç«¯ã€‚
  - **æŠ¥é”™ç‰¹å¾**ï¼š
    - HTTP çŠ¶æ€ç ï¼š`400 Bad Request` æˆ– `413 Request Entity Too Large`
    - å“åº”å†…å®¹ï¼šé€šå¸¸æ˜¯ Nginx é»˜è®¤çš„ HTML é”™è¯¯é¡µï¼ˆ`400 Request Header Or Cookie Too Large`ï¼‰ã€‚
    - æ—¥å¿—ï¼šIngress Controller æ—¥å¿—æ˜¾ç¤º 400ï¼Œä½†æ—  Upstream ç›¸å…³æ—¥å¿—ã€‚

- **åœºæ™¯ Bï¼šè¢« Upstreamï¼ˆç¬¬ä¸‰å…³ï¼‰æ‹¦æˆª**
  - **é…ç½®ç°çŠ¶**ï¼šIngress æ”¾å¼€åˆ° **32k**ï¼Œåç«¯ï¼ˆå¦‚ Spring Bootï¼‰é»˜è®¤ **8k**ã€‚
  - **æµ‹è¯•è¡Œä¸º**ï¼šå‘é€ **16k** å¤´éƒ¨è¯·æ±‚ã€‚
  - **ç»“æœ**ï¼šIngress æ”¾è¡Œï¼Œæµé‡**åˆ°è¾¾**åç«¯ï¼Œä½†è¢«åç«¯æ‹’ç»ã€‚
  - **æŠ¥é”™ç‰¹å¾**ï¼š
    - HTTP çŠ¶æ€ç ï¼š`400 Bad Request`
    - å“åº”å†…å®¹ï¼šé€šå¸¸æ˜¯åç«¯æ¡†æ¶ç”Ÿæˆçš„é”™è¯¯é¡µï¼ˆå¦‚ Tomcat/Spring çš„ White Label Error Pageï¼‰ã€‚
    - æ—¥å¿—ï¼šIngress Controller æ—¥å¿—ä¼šæ˜¾ç¤º `upstream_status: 400`ã€‚

**ç»“è®º**ï¼šæ’æŸ¥ 400 é—®é¢˜æ—¶ï¼Œå¿…é¡»åŒæ—¶æ£€æŸ¥ **ã€ŒIngress æœ‰æ²¡æœ‰æ”¾è¡Œã€** å’Œ **ã€Œåç«¯æœåŠ¡èƒ½ä¸èƒ½æ¥æ”¶ã€**ã€‚

## ä¹ã€è¯·æ±‚å¤„ç†å®Œæ•´æµç¨‹å›¾ (Mermaid)

æœ€åï¼Œæˆ‘ä»¬å°†æ•´ä¸ªæ ¡éªŒæµç¨‹å¯è§†åŒ–ï¼Œå¸®åŠ©ä½ å½»åº•ç†æ¸…ã€Œå®¢æˆ·ç«¯ -> Ingress -> Upstreamã€çš„è¯·æ±‚æµå‘ï¼š

```mermaid
graph TD
    User["å®¢æˆ·ç«¯è¯·æ±‚ (User Client Request)"] -->|Step 1: å‘é€è¯·æ±‚| NginxPod["Ingress Controller Pod (Nginx)"]

    subgraph "æ ¸å¿ƒç»„ä»¶: Ingress Controller (Nginx)"
        NginxPod -->|Step 2: è·¯ç”±åŒ¹é…| MatchRule{"è·¯ç”±è§„åˆ™åŒ¹é…<br/>(Ingress Resource)"}
        MatchRule -->|"åŒ¹é… Host: user.example.com<br/>åŒ¹é… Path: /api/user"| LoadConfig["Step 3: åŠ è½½å±€éƒ¨é…ç½®"]
        
        LoadConfig -->|"è¯»å– Annotations (å±€éƒ¨é…ç½®)<br/>è¦†ç›–å…¨å±€ ConfigMap"| CheckIngress{"Step 4: Ingress å±‚æ ¡éªŒ<br/>(client_header_buffer_size)"}
        
        CheckIngress -- "è¶…è¿‡é˜ˆå€¼ (Yes)" --> Return400Ingress["æ‹’ç»è¯·æ±‚<br/>è¿”å› 400 Request Header Or Cookie Too Large"]
        CheckIngress -- "é€šè¿‡ (No)" --> Forward["Step 5: è½¬å‘ (Forward)"]
    end

    Forward -->|Step 6: å‘é€ç»™åç«¯| BackendPod["åç«¯æœåŠ¡ Pod (Upstream Backend)"]

    subgraph "åç«¯æœåŠ¡: User Service API"
        BackendPod -->|"API æ¡†æ¶æ ¡éªŒ<br/>(Spring Boot/Node/Tomcat)"| CheckApp{"Step 7: App å±‚æ ¡éªŒ<br/>(max-http-header-size)"}
        CheckApp -- "è¶…è¿‡é˜ˆå€¼ (Yes)" --> Return400App["æ‹’ç»è¯·æ±‚<br/>è¿”å› 400 Bad Request"]
        CheckApp -- "é€šè¿‡ (No)" --> BusinessLogic["æ‰§è¡Œä¸šåŠ¡é€»è¾‘"]
    end

    Return400Ingress --> ErrorRes["è¿”å› 400 å“åº”"]
    Return400App --> IngressLog["Ingress è®°å½•æ—¥å¿—: Upstream 400"]
    IngressLog --> ErrorRes
    BusinessLogic --> SuccessRes["è¿”å› 200 æˆåŠŸå“åº”"]
    SuccessRes --> User

    style MatchRule fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    style LoadConfig fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    style CheckIngress fill:#ffcccc,stroke:#b71c1c,stroke-width:2px
    style CheckApp fill:#ffcccc,stroke:#b71c1c,stroke-width:2px
    style Return400Ingress fill:#ffebee,stroke:#d32f2f
    style Return400App fill:#ffebee,stroke:#d32f2f
```

## æ€»ç»“

1. **ä¼˜å…ˆçº§æ ¸å¿ƒ**ï¼šæœåŠ¡çº§ Ingress æ³¨è§£ï¼ˆç”¨æˆ·çº§åˆ«ï¼‰**é«˜äº** Ingress Controller Pod å±‚é¢çš„å…¨å±€ ConfigMap é…ç½®ï¼Œæœ€ç»ˆ Nginx åŠ è½½ã€Œå…¨å±€åŸºç¡€ + å±€éƒ¨è¦†ç›–ã€çš„ç»„åˆé…ç½®ï¼›

2. **ç”Ÿæ•ˆèŒƒå›´**ï¼šå…¨å±€é…ç½®ä½œç”¨äºæ‰€æœ‰æœåŠ¡ï¼Œéœ€é‡å¯ Pod ç”Ÿæ•ˆï¼›å±€éƒ¨é…ç½®ä»…ä½œç”¨äºå½“å‰æœåŠ¡ï¼Œè‡ªåŠ¨é‡è½½æ— éœ€é‡å¯ï¼Œç”Ÿäº§**é¦–é€‰å±€éƒ¨é…ç½®**ï¼›

3. **è¯·æ±‚å¤´é…ç½®**ï¼šä¸¤ä¸ªæ ¸å¿ƒå‚æ•° `client_header_buffer_size`ã€`large-client-header-buffers` æ”¯æŒå…¨å±€/å±€éƒ¨åŒå‘é…ç½®ï¼ŒHTTP/2 éœ€å•ç‹¬é…ç½®å¯¹åº”çš„ `http2-max-*` å‚æ•°ï¼›

4. **ç”Ÿäº§æœ€ä½³å®è·µ**ï¼š**å…¨å±€å…œåº•ï¼ˆé€‚ä¸­é˜ˆå€¼ï¼‰+ å±€éƒ¨ç²¾å‡†è°ƒä¼˜ï¼ˆä»…ç‰¹æ®ŠæœåŠ¡ï¼‰**ï¼Œé…åˆä¸šåŠ¡ä¾§æ ¹æºç²¾ç®€è¯·æ±‚å¤´ï¼Œæ—¢è§£å†³ 400 é”™è¯¯ï¼Œåˆæ§åˆ¶å®‰å…¨é£é™©ï¼›

5. **æ’é”™å…³é”®**ï¼šé…ç½®ä¸ç”Ÿæ•ˆä¼˜å…ˆæŸ¥ã€ŒIngress ç±»ååŒ¹é…ã€ã€Œå…¨å±€é…ç½®æ˜¯å¦é‡å¯ Podã€ã€ŒNginx å®é™…é…ç½®æ˜¯å¦åŠ è½½ã€ã€‚
