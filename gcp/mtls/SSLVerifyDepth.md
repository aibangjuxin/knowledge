**GCP Certificates Trust Config** çš„ç¡®ä¸ç±»ä¼¼äº **SSLVerifyDepth** çš„æ¦‚å¿µç›¸å…³ï¼Œä½†äºŒè€…ä¸æ˜¯å®Œå…¨ç­‰ä»·çš„é…ç½®é¡¹ï¼Œè€Œæ˜¯**åŒä¸€ä¸ªéªŒè¯é“¾æœºåˆ¶çš„ä¸åŒè¡¨ç°å±‚é¢**ã€‚æˆ‘æ¥å¸®ä½ ç†æ¸…ä¸¤è€…çš„å…³ç³»ã€‚

---

## **ğŸ” GCP Trust Config ç®€è¿°**

åœ¨ GCP ä¸­ï¼ˆç‰¹åˆ«æ˜¯ **Certificate Manager** ä¸­ï¼‰ï¼ŒTrustConfig ä¸»è¦ç”¨äºé…ç½® **å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯ï¼ˆmTLSï¼‰** æ—¶æœåŠ¡å™¨ç«¯ç”¨äºéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦é“¾çš„æ ¹è¯ä¹¦å’Œä¸­é—´è¯ä¹¦ï¼š

- TrustConfig åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª **trusted CA certificates**ï¼ˆé€šå¸¸æ˜¯ PEM æ ¼å¼çš„æ ¹è¯ä¹¦æˆ–ä¸­é—´ CAï¼‰ã€‚
- ç”¨äºé…ç½® **Server ç«¯å¦‚ä½•éªŒè¯ Client è¯ä¹¦**ã€‚
- ä¸€èˆ¬åœ¨é…ç½® **mTLS** çš„ GCLB æˆ– GKE Gateway ç­‰åœºæ™¯ä¸‹ä½¿ç”¨ã€‚

---

## **ğŸ” ä»€ä¹ˆæ˜¯ SSLVerifyDepthï¼Ÿ**

è¿™æ˜¯åœ¨ Apache HTTP Server æˆ– Nginx ä¸­ç”¨äº TLS å®¢æˆ·ç«¯éªŒè¯çš„å‚æ•°ï¼Œç”¨äºé™åˆ¶ **éªŒè¯é“¾çš„æœ€å¤§æ·±åº¦**ã€‚

ç®€å•æ¥è¯´ï¼Œå®ƒæ§åˆ¶äº†ï¼š

> â€œä»å®¢æˆ·ç«¯è¯ä¹¦åˆ°ä¿¡ä»»æ ¹è¯ä¹¦ï¼Œæœ€å¤šå…è®¸å¤šå°‘å±‚è¯ä¹¦é“¾â€

ä¸¾ä¸ªä¾‹å­ï¼š

```
Client cert -> Intermediate CA -> Root CA
```

è¿™æ˜¯ä¸€ä¸ª**æ·±åº¦ä¸º 2** çš„é“¾æ¡ï¼ˆIntermediate æ˜¯ç¬¬ 1 å±‚ï¼ŒRoot æ˜¯ç¬¬ 2 å±‚ï¼‰ã€‚

é…ç½®ï¼š

```
ssl_verify_depth 2;
```

æ„å‘³ç€æœ€å¤šå…è®¸æœ‰ä¸¤å±‚ä¸­é—´ CA + root è¯ä¹¦ã€‚å¦‚æœé“¾å¤ªé•¿ï¼Œå°±æ‹’ç»ã€‚

---

## **âœ… äºŒè€…çš„å…³ç³»**

- åœ¨ GCP çš„ TrustConfig ä¸­ï¼Œå¹¶æ²¡æœ‰**æ˜¾å¼çš„ verify_depth å‚æ•°**ï¼Œä½†å®ƒ **éšå«æ”¯æŒç±»ä¼¼æœºåˆ¶**ã€‚
- å¦‚æœä½ ä¸Šä¼ çš„ trust anchorsï¼ˆæ ¹æˆ–ä¸­é—´ CAï¼‰ä¸è¶³ä»¥éªŒè¯ client è¯ä¹¦é“¾ï¼Œé‚£ä¹ˆéªŒè¯å°±ä¼šå¤±è´¥ï¼Œç›¸å½“äºä¸€ä¸ªåŠ¨æ€çš„ verify depth checkã€‚
- ç›®å‰ GCP é»˜è®¤çš„ TLS ç»„ä»¶ï¼ˆå¦‚ GCLB æˆ– Gatewayï¼‰**æ”¯æŒçš„æœ€å¤§è¯ä¹¦é“¾é•¿åº¦ä¸ºçº¦ 10**ï¼Œè¿™ä¸ªç±»ä¼¼ ssl_verify_depth çš„ç³»ç»Ÿé™åˆ¶æ˜¯ç¡¬ç¼–ç çš„ã€‚

---

## **âœ… å°ç»“ï¼šæ˜¯å¦æœ‰å…³ï¼Ÿ**

| **æ¦‚å¿µ**   | **GCP TrustConfig**                             | **SSLVerifyDepth**       |
| ---------- | ----------------------------------------------- | ------------------------ |
| æ˜¯å¦ç›¸å…³   | âœ… æ˜¯ï¼ˆåº•å±‚æœºåˆ¶ä¸€è‡´ï¼‰                           | âœ… æ˜¯ï¼ˆæ˜¾å¼é…ç½®ï¼‰        |
| åœ¨å“ªé‡Œé…ç½® | GCP Certificate Manager, Gateway API            | Nginx / Apache / Envoy   |
| æ§åˆ¶æ–¹å¼   | ä¸Šä¼ çš„ trusted roots å’Œé“¾çš„å®Œæ•´æ€§å†³å®šå¯éªŒè¯æ·±åº¦ | æ˜ç¡®å†™å‡º max depth       |
| é»˜è®¤è¡Œä¸º   | å…è®¸åˆç†æ·±åº¦ï¼ˆå¦‚ 5~10ï¼‰ï¼Œè¿‡æ·±å¯èƒ½å¤±è´¥           | éœ€è¦æ‰‹åŠ¨æ§åˆ¶æ˜¯å¦æ¥å—æ·±é“¾ |

---

å¦‚æœä½ åœ¨ GCP Gateway æˆ– GCLB ä¸­é…ç½®äº† mTLS å¹¶å‡ºç°å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯å¤±è´¥çš„é—®é¢˜ï¼Œå¯èƒ½å°±æ˜¯ï¼š

- ä¿¡ä»»é“¾æœªè¡¥é½ï¼ˆç¼ºä¸­é—´è¯ä¹¦ï¼‰
- è¯ä¹¦é“¾å¤ªæ·±
- ä¸Šä¼ çš„ trust config ä¸æ­£ç¡®ï¼ˆPEM é”™è¯¯ã€æ ¼å¼ä¸å¯¹ï¼‰

---

éœ€è¦æˆ‘å¸®ä½ çœ‹å…·ä½“é…ç½®æˆ–è€… debug æŸä¸ªéªŒè¯å¤±è´¥çš„ä¾‹å­å—ï¼Ÿä½ å¯ä»¥è´´ä¸€ä¸‹ trust configã€è¯ä¹¦é“¾ç»“æ„ï¼Œæˆ‘æ¥ä¸€èµ·åˆ†æã€‚

# nginx

é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç°åœ¨èµ° MTLS çš„ TrustConfig çš„éªŒè¯çš„,åé¢çš„ Nginx ä»…ä»…åš CN çš„æ ¡éªŒ,é‚£ä¹ˆå…¶å®å°±ä¸ç”¨è€ƒè™‘ nginx å±‚å»é…ç½® SSLVerifyDepth?

å½“ç„¶å¯ä»¥ï¼Œä»¥ä¸‹æ˜¯æè¿°ä½ è¿™ä¸ª mTLS éªŒè¯æµç¨‹çš„ Mermaid æµç¨‹å›¾ï¼Œé‡ç‚¹ä½“ç°äº† TrustConfig åœ¨å‰ç«¯éªŒè¯ï¼ŒNginx åªåš CN æ ¡éªŒçš„ç»“æ„ï¼š

```mermaid
flowchart TD
    Client["Client å‘é€å«è¯ä¹¦è¯·æ±‚"]
    GCLB["GCP Load Balancer Certificate Manager TrustConfig"]
    Nginx["GKE åç«¯æœåŠ¡ Nginx"]
    App["åç«¯åº”ç”¨ æˆ– API æœåŠ¡"]

    Client -->|TLS + Client Cert| GCLB
    GCLB -->|éªŒè¯ TrustConfig:éªŒè¯è¯ä¹¦é“¾æ˜¯å¦åˆæ³• æ ¹CAã€ä¸­é—´CAç­‰| GCLB
    GCLB -->|éªŒè¯é€šè¿‡åè½¬å‘è¯·æ±‚ TLS è§£å¯†å®Œ| Nginx
    Nginx -->|æå– client CN è¿›è¡ŒåŒ¹é…æ£€æŸ¥| Nginx
    Nginx -->|é€šè¿‡åè½¬å‘è¯·æ±‚| App

    %% ä¿®æ­£ note è¯­æ³•
    note["mTLS éªŒè¯é“¾åœ¨æ­¤å®Œæˆ<br/>ä¸éœ€è¦åç«¯é‡å¤éªŒè¯"] -->|é™„æ³¨| GCLB
    note2["ä»…åš CN æˆ– SAN æ£€æŸ¥<br/>ä¸å¯ç”¨ ssl_verify_client æˆ– depth"] -->|é™„æ³¨| Nginx
```

---

### **ğŸ’¡ å°æç¤ºï¼š**

å¦‚æœä½ åé¢è€ƒè™‘è®©åç«¯æœåŠ¡è¿›ä¸€æ­¥åšç»†ç²’åº¦æ§åˆ¶ï¼ˆå¦‚åŸºäºè¯ä¹¦çš„ RBACï¼‰ï¼Œé‚£å¯èƒ½è¿˜ä¼šéœ€è¦æŠŠ X-Forwarded-Client-Cert ä¹‹ç±»çš„å¤´éƒ¨å¸¦è¿‡å»ï¼ˆåœ¨ GCP LB é‡Œå¼€å¯ client certificate forwardingï¼‰ã€‚ä½†å½“å‰è¿™ä¸ªæ¶æ„åªæ ¡éªŒ CNï¼Œæ˜¯éå¸¸æ¸…æ™°ä¸”é«˜æ•ˆçš„ã€‚

è¦ä¸è¦ also æˆ‘ç»™ä½ ç”»ä¸€ä¸ªå¸¦ CN æ£€æŸ¥é€»è¾‘çš„ Nginx é…ç½®ç¤ºä¾‹ï¼Ÿ

å¥½çš„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„ **Nginx é…ç½®ç¤ºä¾‹**ï¼Œé€‚ç”¨äºä½ çš„åœºæ™¯ï¼š**å‰ç«¯ï¼ˆGCP LBï¼‰åšäº† mTLS + TrustConfig éªŒè¯ï¼Œåç«¯ Nginx åªåš CN æ ¡éªŒ**ã€‚

---

### **ğŸ“„ Nginx é…ç½®ç‰‡æ®µï¼ˆä»…æ ¡éªŒ CNï¼Œä¸åš TLS éªŒè¯ï¼‰**

```nginx
# é€šå¸¸ç”¨äº HTTPS åç«¯æˆ– Sidecar æ¨¡å¼
server {
    listen 443 ssl;
    server_name backend.example.com;

    ssl_certificate     /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;

    # æ³¨æ„ï¼šä¸å¯ç”¨å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯ï¼ˆç”± GCP å¤„ç†ï¼‰
    ssl_verify_client off;

    # æå–å®¢æˆ·ç«¯è¯ä¹¦ä¿¡æ¯ï¼ˆé€šè¿‡ GCP ä¼ è¿‡æ¥çš„ headerï¼‰
    # éœ€åœ¨ GCP LB ä¸­å¯ç”¨ client cert forwarding
    set $client_cert_cn "";
    if ($http_x_ssl_client_s_dn ~* "CN=(.*?)(?:,|$)") {
        set $client_cert_cn $1;
    }

    # å…è®¸çš„å®¢æˆ·ç«¯ CNï¼ˆå¯é…ç½®ä¸º map/ç™½åå•åˆ—è¡¨ï¼‰
    map $client_cert_cn $cn_allowed {
        default 0;
        "service-client.example.com" 1;
        "trusted-agent.internal" 1;
    }

    # æ‹¦æˆªéæ³• CN
    if ($cn_allowed = 0) {
        return 403;
    }

    location / {
        proxy_pass http://upstream-service;
        # å…¶ä»– proxy é…ç½® ...
    }
}
```

---

### **âœ… é…ç½®è¯´æ˜**

| **é…ç½®é¡¹**            | **è¯´æ˜**                                 |
| --------------------- | ---------------------------------------- |
| ssl_verify_client off | ä¸åšå®¢æˆ·ç«¯è¯ä¹¦éªŒè¯ï¼Œç”± GCP å®Œæˆ          |
| X-SSL-Client-S-DN     | éœ€è¦ GCP é…ç½®å¼€å¯ client cert forwarding |
| map + if è¯­å¥         | å®ç°åŸºäº CN çš„ç™½åå•æ ¡éªŒ                 |
| return 403            | å¦‚æœ CN ä¸åˆæ³•ï¼Œç›´æ¥æ‹’ç»è¯·æ±‚             |

---

### **ğŸ’¡ GCP è®¾ç½®å°æç¤ºï¼š**

- è‹¥ä½¿ç”¨ **GCLB + Certificate Manager mTLS**ï¼Œä½ éœ€åœ¨ Backend Config ä¸­å¯ç”¨ï¼š

```
enable_client_certificate: true
```

-
- å¹¶è®¾ç½®è½¬å‘ headerï¼š

```
x-forwarded-client-cert: true
```

è¿™æ · Nginx æ‰èƒ½è·å– X-SSL-Client-S-DN æˆ– X-Forwarded-Client-Certã€‚

---

å¦‚æœä½ æœ‰æ‰“ç®—æŠŠå¤šä¸ª CN ç®¡ç†å¾—æ›´çµæ´»ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨ Lua æˆ–è‡ªå®šä¹‰ whitelist æ–‡ä»¶æ–¹å¼ï¼Œåç»­å¯ä»¥åŠ ä¸Šã€‚éœ€è¦çš„è¯æˆ‘ä¹Ÿå¯ä»¥å†™ä¸ªç‰ˆæœ¬ ğŸ˜
