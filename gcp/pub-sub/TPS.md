# My Summary

## My thinks process

```bash
TPS 

计算公式 线程总数/ 单消息的处理时间

在这里为什么要引入这个概念？ 也是因为我后面的监控里面需要有一个每秒的请求量。



100 thread 
1 pods 
5s timeout 
按照每分钟整点接受消息因为scheduled job 频率是分钟能力 是 
100个消息 / 分  
单次消息如果5s 完成 那么在一分钟内 一个thread 理论可以处理后续队列数字为 60s/5  = 12 s 12 个
所以总数理论最大 100* 12= 1200 个消息 会在一分钟内处理完 

1200 / 60 = 20 tps 每秒能接收 
刚好等于下面
100 个 / 5s  =  20 tps 这个都是理论最大值 
对应监控数值 每秒投递 如果小于我的tps 就能处理


举例 我目前100 thread
假设120 个消息整点过来 100直接消费 20进入队列等待空余线程 理论大概5S 如果100线程都处理完 空余线程在分钟内就能接着处理20的这些 队列任务 


Current 
4 threads 
4 pods  
5s timeout 

4个消息/ 分钟 单个 pod  4Pod 就是16个消息
16/5 = 3.2 tps

单次5 second  单次消息如果5s 完成 那么在一分钟内 一个thread 理论可以处理后续队列数字为 60s/5  = 12 s 12 个
理论 最大值 4 * 12  = 48 个消息 会在一分钟内处理完 
48 / 60 = 0.8 tps
0.8 * 4 pods = 3.2 tps 


对应监控数值 每秒投递 如果小于我的tps 3,2 就能处理

因为监控里面🈶秒投递次数 我为了统一所以必须选出一个tps 来应对到次数/秒 



关于上面所有这些理由，即为什么我们一定要与线程数挂钩。因为线程在整个过程中都无法释放。只要有消息进来，我们必须通过线程数接收和处理
```

假设单条处理耗时为 5 秒，则：
TPS = 总线程数 ÷ 5

TPS = 总线程数 ÷ 每条消息耗时，是我们衡量系统是否能在一分钟内处理所有消息的核心指标。只要投递速率 ≤ TPS，系统就能稳定运行

### **支持分钟级调度系统的 GKE Pod 并发处理能力评估表（含 TPS）**

| **线程数（每 Pod）** | **Pod 数量** | **总线程数** | **每分钟最大处理量** | **每天最大处理量** | **每分钟最小处理量** | **每天最小处理量** | **TPS** | **总线程内存占用（MB）** |
| -------------- | ---------- | -------- | ------------ | ----------- | ------------ | ----------- | ------- | --------------- |
| 4              | 1          | 4        | 48           | 69,120      | 4            | 5,760       | 0.8     | 6 MB            |
| 4              | 2          | 8        | 96           | 138,240     | 8            | 11,520      | 1.6     | 12 MB           |
| 4              | 4          | 16       | 192          | 276,480     | 16           | 23,040      | 3.2     | 24 MB           |
| 20             | 1          | 20       | 240          | 345,600     | 20           | 28,800      | 4.0     | 30 MB           |
| 20             | 2          | 40       | 480          | 691,200     | 40           | 57,600      | 8.0     | 60 MB           |
| 20             | 4          | 80       | 960          | 1,382,400   | 80           | 115,200     | 16.0    | 120 MB          |
| 50             | 1          | 50       | 600          | 864,000     | 50           | 72,000      | 10.0    | 75 MB           |
| 50             | 2          | 100      | 1,200        | 1,728,000   | 100          | 144,000     | 20.0    | 150 MB          |
| 50             | 4          | 200      | 2,400        | 3,456,000   | 200          | 288,000     | 40.0    | 300 MB          |
| 100            | 1          | 100      | 1,200        | 1,728,000   | 100          | 144,000     | 20.0    | 150 MB          |
| 100            | 2          | 200      | 2,400        | 3,456,000   | 200          | 288,000     | 40.0    | 300 MB          |
| 100            | 4          | 400      | 4,800        | 6,912,000   | 400          | 576,000     | 80.0    | 600 MB          |
| 150            | 1          | 150      | 1,800        | 2,592,000   | 150          | 216,000     | 30.0    | 225 MB          |
| 150            | 2          | 300      | 3,600        | 5,184,000   | 300          | 432,000     | 60.0    | 450 MB          |
| 150            | 4          | 600      | 7,200        | 10,368,000  | 600          | 864,000     | 120.0   | 900 MB          |

## **✅ 汇总确认**

### **✅ 核心定义：TPS = 每秒最大理论处理能力**

> **TPS（Transactions Per Second）**：

> = 线程总数 / 单消息处理时间（秒）

> 👉 这是你系统在最理想情况下的每秒最大处理能力，用于评估系统峰值承载。

---

### **✅ 为什么需要定义 TPS？**

- 💡**目的**：为了将系统的**资源配置（线程数）**与**实时监控数据（如 Pub/Sub 每秒投递数）**做匹配
- ✅ 只要 **投递速率 ≤ TPS**，就能在一分钟内完成所有处理，避免堆积或超时

---

### **✅ 示例 1：100 线程，1 Pod**

| **参数项**             | **值**                 |
| ---------------------- | ---------------------- |
| 总线程数               | 100                    |
| 单消息耗时             | 5 秒                   |
| 理论每线程每分钟处理量 | 12（= 60/5）           |
| 理论每分钟总处理量     | 100 \* 12 = 1200 条    |
| 理论 TPS               | 1200 / 60 = **20 TPS** |
| 单线程 TPS             | 1 / 5 = 0.2 TPS        |
| 100 线程总 TPS         | 100 × 0.2 = 20 TPS     |

> ✅ **你的推导完全正确。**

---

### **✅ 示例 2：4 Pod，每 Pod 4 线程（总 16 线程）**

| **参数项**       | **值**                 |
| ---------------- | ---------------------- |
| 总线程数         | 4 × 4 = 16             |
| 单消息耗时       | 5 秒                   |
| 理论每分钟处理量 | 16 \* 12 = 192 条      |
| 理论 TPS         | 192 / 60 = **3.2 TPS** |

> ✅ 正确，**监控中只要每秒投递数 < 3.2**，该系统就不会积压。

---

## **✅ 总结推荐表达**

我们引入 TPS（每秒最大处理能力）的概念，目的是将实际投递速率与系统线程处理能力对齐：

- TPS = 线程总数 / 单消息处理耗时
- 每个线程在整个消息生命周期（拉取 → 调用 API → 等待响应 → ACK）中都**保持占用**
- 所以吞吐能力**与线程数直接挂钩**

### 示例一：100 线程，1Pod

- 理论每线程每分钟处理 12 条（60s/5s）
- 理论总吞吐 100×12 = 1200 条/分钟 = **20 TPS**
- 若整点投递 120 条，100 条立即处理，20 条将在空闲线程释放后继续处理

### 示例二：4Pod×4 线程 = 16 线程

- 理论吞吐 16×12 = 192 条/分钟 = **3.2 TPS**
- 若整点投递 16 条，每个线程处理一条刚好撑满吞吐上限

### 对接监控指标

- GCP Pub/Sub 提供 "每秒消息投递数"
- 实时对比系统配置 `TPS`，确认是否存在堆积风险
- 只要每秒投递速率 < TPS，则系统在一分钟内可完整消费

> 因此，系统的线程配置不仅影响性能，还决定了吞吐边界与容错能力

---

## **✅ 推荐你使用的最终口径（一句话总结）**

> **TPS = 总线程数 ÷ 每条消息耗时，是我们衡量系统是否能在一分钟内处理所有消息的核心指标。只要投递速率 ≤ TPS，系统就能稳定运行。**

---
