 ```mermaid
sequenceDiagram
    participant S as Cloud Scheduler
    participant P as Pub/Sub Topic
    participant G as GKE Deployment<br/>(Schedule Service)
    participant B as Backend Service

    Note over S,B: Authentication: Basic Base64(user:password)

    S->>+P: 1. Trigger Message<br/>(gcloud schedule jobs)
    P->>+G: 2. Push Message

    rect rgb(240, 240, 240)
        Note over G: Schedule Service Processing
        G->>+B: 3. HTTP Request<br/>Authorization: Basic Base64
        B-->>-G: 4. Response
    end
```


ä½ æè¿°çš„ä¸šåŠ¡æµç¨‹æ˜¯ï¼š

- å¤šä¸ª Cloud Scheduler Jobï¼ˆä»£è¡¨ä¸åŒ APIï¼‰å‘é€è¯·æ±‚
    
- Schedule Service æ¥æ”¶è¯·æ±‚åæ ¹æ® team â†’ å‘é€åˆ°æŒ‡å®š team çš„ Pub/Sub Topic
    
- æ¯ä¸ª Topic å¯¹åº”ä¸€ç»„ Backend Serviceï¼ˆæ¯ä¸ª API å¯¹åº”ä¸€ä¸ªï¼‰
    

  

ä¸‹é¢æ˜¯åŸºäºä½ æè¿°çš„ **å®Œæ•´ mermaid flow**ï¼Œå·²åŠ ä¸Š team/topic/API é€»è¾‘ã€Pub/Sub dispatchã€å¤šä¸ª Backend Serviceï¼Œå¹¶ä¿ç•™ Basic Auth ä¿¡æ¯ï¼š

---

```mermaid
sequenceDiagram
    participant S as Cloud Scheduler<br/>(å¤šä¸ª Scheduler Job)
    participant G as GKE Deployment<br/>(Schedule Service)
    participant T as Pub/Sub Topic<br/>per Team (e.g. team-a-topic)
    participant B1 as Backend Service A1
    participant B2 as Backend Service A2

    Note over S,G: æ¯ä¸ª Scheduler Job å±äºæŸä¸ª team & API

    S->>+G: 1. Trigger HTTP Request<br/>åŒ…å« team / API ä¿¡æ¯<br/>Authorization: Basic Base64

    rect rgb(240, 240, 240)
        Note over G: Schedule Service å†…éƒ¨é€»è¾‘<br/>Java åº”ç”¨
        G->>+T: 2. æ ¹æ® team æ¨é€æ¶ˆæ¯åˆ°å¯¹åº” Pub/Sub Topic
    end

    T->>+G: 3. Pub/Sub æ¶ˆæ¯é€å› Schedule Service æ¶ˆè´¹ï¼ˆGKEï¼‰
    
    rect rgb(240, 240, 240)
        Note over G: Schedule Service æ¶ˆè´¹æ¶ˆæ¯å¹¶å¤„ç†<br/>æŒ‰ API è·¯ç”±ä¸åŒ Backend
        G->>+B1: 4. è½¬å‘ç»™ Backend A1<br/>Authorization: Basic Base64
        B1-->>-G: 5. è¿”å›å“åº”
        
        G->>+B2: 6. è½¬å‘ç»™ Backend A2<br/>Authorization: Basic Base64
        B2-->>-G: 7. è¿”å›å“åº”
    end
```

---

## **âœ… è¯´æ˜è¦ç‚¹**

|**æ­¥éª¤**|**è¯´æ˜**|
|---|---|
|Step 1|Scheduler Job å‘èµ·è¯·æ±‚åˆ° GKE çš„ Schedule Serviceï¼Œé™„å¸¦ team + API ä¿¡æ¯ï¼Œä½¿ç”¨ Basic Auth|
|Step 2|Schedule Service æ ¹æ® team æ¨é€æ¶ˆæ¯åˆ°æŒ‡å®š Pub/Sub Topicï¼ˆå¦‚ team-a-topicï¼‰|
|Step 3|è‡ªå·±æ¶ˆè´¹ Topicï¼ˆåŒä¸€ä¸ª Pod è®¢é˜…è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼‰|
|Step 4~7|æŒ‰ API å†³å®šè½¬å‘ç»™å“ªä¸ª Backend Serviceï¼ˆAPI1 âœ B1ï¼ŒAPI2 âœ B2ï¼‰|

---

## **ğŸ› ï¸ å»ºè®®ä¼˜åŒ–**

- è‹¥ä¸€ä¸ª Team æœ‰å¤šä¸ª APIï¼Œå¯è€ƒè™‘æŒ‰ API æ‹†åˆ†ä¸åŒ Subscription æˆ– Topicï¼Œä»¥é¿å…ä¸²è¡Œæ¶ˆè´¹å½±å“å…¶ä»–ä»»åŠ¡ï¼›
    
- æ¯æ¡æ¶ˆæ¯å»ºè®®åŒ…å«ï¼š
    
    - team
        
    - api
        
    - request_url
        
    - retry_idï¼ˆç”¨äºå¹‚ç­‰ï¼‰
        
    - auth æˆ–å†…éƒ¨ token
        
    
- Backend è‹¥éƒ¨ç½²åœ¨ GKEï¼Œå¯é€šè¿‡å†…éƒ¨ DNS å¦‚ http://api1.default.svc.jiqun.local æ¥è®¿é—®
    

---

æ˜¯å¦è¿˜éœ€è¦æˆ‘å¸®ä½ åŠ ï¼š

- Retry è¡Œä¸ºï¼ˆå¦‚ 3 æ¬¡ Retry é—´éš”ï¼‰
    
- Pub/Sub æ¶ˆæ¯å¤±è´¥ DLQï¼ˆDead Letter Queueï¼‰æµç¨‹ï¼Ÿ
    
- Timeout å¤„ç†æµç¨‹ï¼Ÿ
    



ç°åœ¨è®¿é—®çš„ flow å¤§æ¦‚å¦‚ä¸‹ 
éƒ¨ç½²ä¸€ä¸ªæœåŠ¡åœ¨ GKE é‡Œé¢ æ¯”å¦‚æˆ‘ä»¬ç§°ä¹‹ä¸º schedule service GKE Deployment (Schedule Service)ä»–æ˜¯ä¸€ä¸ª Java å¼€å‘çš„åº”ç”¨ç¨‹åº
ä»–ä¼šæ¥å—ä¸åŒçš„ team ä¸€ä¸ª team å¯èƒ½æœ‰ä¸åŒçš„ cloud Schedule job å‘é€è¿‡æ¥çš„ä»»åŠ¡è¯·æ±‚ schedule service ä¼šå°†å¯¹åº” team çš„è¯·æ±‚å‘é€åˆ°è¿™ä¸ª team å¯¹åº”çš„ pub sub æˆ‘ä»¬é’ˆå¯¹æ¯ä¸ª team åˆ›å»ºäº†è‡ªå·±å¯¹åº”çš„ pub sub ç„¶åè¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¼šå°†å¯¹åº”çš„è¯·æ±‚å‘é€åˆ°ç”¨æˆ·æœ€ç»ˆè¿è¡Œçš„ backend service å½“ç„¶åŒä¸€ä¸ªTeamçš„ä¸åŒçš„ä»»åŠ¡è¯·æ±‚å¯¹åº”åé¢ä¸åŒçš„Backend Service

æˆ‘ä»¬ç°åœ¨çš„ä¸šåŠ¡å¤„ç†é€»è¾‘æœ‰ä¸€ä¸ªé—®é¢˜ æ¯”å¦‚ team A ä¸‹é¢ ä¸åŒçš„ API [ä¹Ÿå¯ä»¥è¯´æ˜¯ä¸åŒçš„cloud schedule job ]å‘é€è¿‡æ¥çš„è¯·æ±‚éƒ½è¦è®©åŒä¸€ä¸ª pub æ¥å¤„ç† æ¯”å¦‚è¯´è¿™ä¸ªé¢˜ç›® team A API1 å’Œ team A API 2

å¦‚æœ API1 çš„è¯·æ±‚æ²¡æœ‰è¿”å› é‚£ä¹ˆä»–å°±ä¼šä¸€ç›´ç­‰å¾… è€Œä¸ä¼šå¤„ç† team A API 2 å¯¹åº”çš„è¯·æ±‚

æˆ‘ä»¬ç°åœ¨ä»ä¸‹é¢è¿™ä¸ªæ–¹é¢æ¥å…³æ³¨è¿™ä¸ªæœåŠ¡ Â  æˆ‘ä»¬ç°åœ¨é‡åˆ°çš„é—®é¢˜æ˜¯ æ¶ˆæ¯é˜Ÿåˆ—é˜»å¡ ä¼šå½±å“ç”¨æˆ·çš„åç»­æ­£å¸¸å¤„ç†
æˆ‘ç°åœ¨éœ€è¦
Monitor ==> Sre é’ˆå¯¹è¿™æ ·çš„åœºæ™¯ å¦‚ä½•åšå¥½ç›‘æ§
åœºæ™¯æè¿°ï¼š 1. ç”¨æˆ·è°ƒåº¦ä»»åŠ¡ï¼š
ç”¨æˆ·é€šè¿‡ GCP Cloud Scheduler åˆ›å»ºå’Œç®¡ç†è°ƒåº¦ä»»åŠ¡ï¼Œä½¿ç”¨å‘½ä»¤å¦‚
gcloud scheduler jobs list æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡ã€‚å­˜åœ¨ä¸€ä¸ªæƒ…å†µå°±æ˜¯ Teams å…¬ç”¨ä¸€ä¸ª Pub/Sub Topic çš„æƒ…å†µ
gcloud pubsub topics list . 2. è§¦å‘ Pub/Sub é˜Ÿåˆ—ï¼š
æ¯ä¸ªè°ƒåº¦ä»»åŠ¡çš„è§¦å‘ä¼šå°†æ¶ˆæ¯æ¨é€åˆ°ä¸€ä¸ªæŒ‡å®šçš„ Pub/Sub Topic é˜Ÿåˆ—ã€‚ 3. GKE éƒ¨ç½²çš„ Schedule æœåŠ¡ï¼š
GKE ä¸­éƒ¨ç½²ä¸€ä¸ªä¸“é—¨ç”¨äºå¤„ç†è°ƒåº¦çš„æœåŠ¡ï¼ˆç§°ä¸º Schedule Serviceï¼‰ã€‚è¯¥æœåŠ¡è®¢é˜… Pub/Sub æ¶ˆæ¯å¹¶å¤„ç†å…¶ä¸­çš„å†…å®¹ã€‚ç°åœ¨è¿™ä¸ªä¸šåŠ¡å¤„ç†é€»è¾‘æœ‰ä¸€äº›ç¼ºé™·.æ¯”å¦‚å¯¹äºåŒä¸€ä¸ª Teams ä¸åŒçš„ schedule Job è¿‡æ¥åˆ°æˆ‘çš„ Schedule Service çš„æ—¶å€™ å…¶å®æ˜¯é’ˆå¯¹åŒä¸€ä¸ª PUB/SUB çš„å¤„ç†. å¦‚æœåé¢çš„ Backend Service å¤„ç†æ¶ˆæ¯ä¸åŠæ—¶å°±ä¼šæœ‰ç§¯å‹æˆ–è€…è¿™ä¸ª backendservice æœåŠ¡ä¸å¯ç”¨.è€Œä¸”è¿™ä¸ªæœåŠ¡æ˜¯é»˜è®¤ç»è¿‡ Kong å¤„ç†çš„,æ¯”å¦‚ Kong è®¾ç½®äº†å¯¹åº”çš„è¶…æ—¶,æ¯”å¦‚é»˜è®¤ 6 åˆ†é’Ÿ.æˆ‘é‡è¯•ä¸‰æ¬¡,å¯èƒ½å°±éœ€è¦ 18 åˆ†é’Ÿ,ç›®å‰æˆ‘çš„ scheudle Service é‡Œé¢çš„ RetryTemplate æœºåˆ¶æ˜¯ä¸‰æ¬¡é‡è¯•.é—´éš” 0s,10s,20s
è¿™æ ·,åŒä¸€ä¸ª Pub/sub çš„ä»»åŠ¡å°±ä¼š Delay é‚£ä¹ˆä¼šå½±å“æ—¶é—´çš„å¤„ç†.
. Schedule Service æœåŠ¡å¤„ç†é€»è¾‘ï¼š
â€¢ ä» Pub/Sub æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶æ¶ˆæ¯ã€‚
â€¢ è§£ææ¶ˆæ¯å†…å®¹ï¼Œæ„å»ºä¸€ä¸ª HTTP è¯·æ±‚ï¼ˆåŒ…å« Basic Auth è®¤è¯å¤´ï¼‰ã€‚
â€¢ ä½¿ç”¨ curl æˆ–å…¶ä»– HTTP å®¢æˆ·ç«¯åº“å‘æŒ‡å®šçš„åç«¯æœåŠ¡ URL å‘èµ·è¯·æ±‚ã€‚ 4. backend Service å½“ç„¶ä¹Ÿæ˜¯éƒ¨ç½²åœ¨ GKE é‡Œé¢çš„ä¸€ä¸ª Deployment.è¿™ä¸ª Deployment æ”¯æŒ HPA çš„

æˆ‘ç°åœ¨æƒ³è¦å¯¹è¿™ä¸ª GKE Schedule Service æœåŠ¡è¿›è¡Œä¸€ä¸ªå‹åŠ›æµ‹è¯•
æˆ‘å¦‚ä½•è¿›è¡Œè¿™ä¸ªå‹åŠ›æµ‹è¯• ,æˆ‘éœ€è¦å‡†å¤‡äº›ä»€ä¹ˆä¸œè¥¿.æ¯”å¦‚æˆ‘éœ€è¦é…ç½®å¯¹åº”çš„ gcloud scheduler jobs list.æ¯”å¦‚åˆ›å»ºå¤šä¸ª æ¥å¹¶éè¯·æ±‚.è€Œåé¢ä½¿ç”¨ä¸€ä¸ª pubsub ç„¶åæˆ‘éœ€è¦è§‚å¯Ÿæˆ‘çš„ backendService çš„æœåŠ¡çŠ¶æ€.
æˆ‘ä»¬ä¸€èˆ¬çš„å‹æµ‹å·¥å…·æ˜¯ Jmeter ä½†æ˜¯å¯¹äºç±»ä¼¼ä»»åŠ¡æˆ‘ä»¬å¦‚ä½•æ¥å®ç°å‘¢?

1. å‹æµ‹ç›®æ ‡ï¼šæ›´å…³æ³¨

â€¢ Schedule Service çš„å¤„ç†èƒ½åŠ›ï¼ˆæ¶ˆè´¹é€Ÿç‡ã€é‡è¯•å¤„ç†ï¼‰

â€¢ backendService çš„å“åº”èƒ½åŠ›ï¼ˆæ˜¯å¦ä¼šæ’‘çˆ† HPAï¼‰

â€¢ æ•´ä½“é“¾è·¯å»¶è¿Ÿï¼ˆä» Cloud Scheduler åˆ° backendServiceï¼‰

2. ç°æœ‰èµ„æºï¼šæˆ‘éœ€è¦åˆ›å»ºå¯¹åº”çš„ Cloud Scheduler job æ˜¯å¦èƒ½è‡ªåŠ¨åŒ–åˆ›å»ºä¸Šç™¾ä¸ªç”¨äºå‹æµ‹ï¼Ÿè¿™ä¸ªå¯ä»¥

3. æ˜¯å¦å…è®¸ä½¿ç”¨ä»£ç ç”Ÿæˆ Pub/Sub æ¶ˆæ¯ï¼šæ¯”å¦‚ç”¨è„šæœ¬æˆ– Pub/Sub Publisher API å¿«é€Ÿæ¨¡æ‹Ÿè§¦å‘è€Œä¸æ˜¯å•é  Schedulerã€‚==ã€‹ è¿™ä¸ªä¸éœ€è¦

4. Schedule Service çš„æ°´å¹³æ‰©å±•æœºåˆ¶ï¼šæ˜¯å¦æ˜¯å•å®ä¾‹ Podï¼Œè¿˜æ˜¯æ”¯æŒ HPA æ‰©å®¹ï¼Ÿå‹æµ‹æ˜¯å¦ä¹Ÿéœ€è¦è¯„ä¼°å®ƒçš„æ‰©å±•æ€§ï¼Ÿ

5. ä½ æœŸæœ›å‹æµ‹æŒç»­æ—¶é—´ï¼šæ¯”å¦‚ 5 åˆ†é’Ÿã€30 åˆ†é’Ÿã€æŒç»­ 1 å°æ—¶ï¼Ÿæ˜¯å¦æœ‰æœ€å¤§ QPS æˆ– TPS çš„ç›®æ ‡ï¼Ÿ==ã€‹ 30 åˆ†é’Ÿå‹æµ‹
   JMeter çš„å‹æµ‹æ–¹æ¡ˆã€‚

(1) åˆ¶å®šå‹æµ‹å‡†å¤‡ä¸åŸºå‡†æµ‹è¯•è®¡åˆ’ï¼š (a) ä½¿ç”¨ JMeter ç›´æ¥å¯¹åç«¯çš„ Backend Service è¿›è¡Œç‹¬ç«‹çš„å‹åŠ›æµ‹è¯•ï¼Œä»¥ç¡®å®šå…¶æ€§èƒ½åŸºå‡†ï¼ŒåŒ…æ‹¬æœ€å¤§ QPSã€å“åº”æ—¶é—´ä»¥åŠè§¦å‘ HPA çš„å…·ä½“è´Ÿè½½é˜ˆå€¼ã€‚ (b) è¯„ä¼°å¹¶å‡†å¤‡å‹æµ‹ç¯å¢ƒï¼Œç¡®ä¿ GCP é…é¢ï¼ˆå¦‚ Cloud Schedulerã€Pub/Subï¼‰å……è¶³ï¼Œå¹¶ä¸ºå‹æµ‹æ•°æ®å»ºç«‹ç‹¬ç«‹çš„å‘½åç©ºé—´æˆ–é¡¹ç›®ä»¥éš”ç¦»å½±å“ã€‚ (2) è®¾è®¡å¹¶é…ç½®è´Ÿè½½ç”Ÿæˆæœºåˆ¶ï¼š (a) ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œç”¨äºæ‰¹é‡åˆ›å»ºæ•°ç™¾ä¸ª Cloud Scheduler ä»»åŠ¡ã€‚ (b) å°†æ‰€æœ‰è¿™äº›ä»»åŠ¡é…ç½®ä¸ºåœ¨çŸ­æ—¶é—´å†…ï¼ˆä¾‹å¦‚ï¼Œæµ‹è¯•å¼€å§‹åçš„ç¬¬ä¸€åˆ†é’Ÿå†…ï¼‰è§¦å‘ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€åˆ°åŒä¸€ä¸ªç›®æ ‡ Pub/Sub Topicï¼Œä»¥æ¨¡æ‹Ÿé«˜å¹¶å‘å’Œæ¶ˆæ¯ç§¯å‹çš„åœºæ™¯ã€‚ (3) æ„å»ºå…¨é“¾è·¯çš„ç›‘æ§ä¸åº¦é‡ä½“ç³»ï¼š (a) åœ¨ GCP Monitoring (Cloud Monitoring) ä¸­åˆ›å»ºä»ªè¡¨ç›˜ï¼Œé›†ä¸­ç›‘æ§å…³é”®æŒ‡æ ‡ã€‚ (b) ç›‘æ§ Pub/Sub çš„ç§¯å‹æ¶ˆæ¯æ•°ï¼ˆ`num_undelivered_messages`ï¼‰ï¼Œè¿™æ˜¯åˆ¤æ–­ Schedule Service å¤„ç†èƒ½åŠ›ç“¶é¢ˆçš„æ ¸å¿ƒæŒ‡æ ‡ã€‚ (c) ç›‘æ§ GKE ä¸­ Schedule Service å’Œ Backend Service çš„èµ„æºä½¿ç”¨ç‡ï¼ˆCPUã€å†…å­˜ï¼‰ã€Pod æ•°é‡ï¼ˆè§‚å¯Ÿ HPA æ‰©ç¼©å®¹è¡Œä¸ºï¼‰ä»¥åŠé‡å¯æ¬¡æ•°ã€‚ (d) ç›‘æ§ Schedule Service çš„åº”ç”¨ç¨‹åºæ—¥å¿—ï¼Œé‡ç‚¹å…³æ³¨æ¶ˆæ¯å¤„ç†è€—æ—¶ã€é‡è¯•æ¬¡æ•°å’Œé”™è¯¯ä¿¡æ¯ã€‚ (e) ä¸ºäº†æµ‹é‡ç«¯åˆ°ç«¯å»¶è¿Ÿï¼Œç ”ç©¶åœ¨æ¶ˆæ¯è½½è·ä¸­æ³¨å…¥å”¯ä¸€ç›¸å…³ ID å’Œåˆå§‹æ—¶é—´æˆ³ï¼Œå¹¶åœ¨ Backend Service å¤„ç†å®Œæˆæ—¶è®°å½•æ—¥å¿—ï¼Œä»¥ä¾¿åç»­åˆ†æå»¶è¿Ÿã€‚ (4) è®¾è®¡ JMeter æµ‹è¯•æ–¹æ¡ˆä»¥åè°ƒå’Œæ§åˆ¶å‹æµ‹ï¼š (a) é…ç½® JMeter çš„çº¿ç¨‹ç»„ï¼ˆThread Groupï¼‰ï¼Œå°†æµ‹è¯•æŒç»­æ—¶é—´è®¾ç½®ä¸º 30 åˆ†é’Ÿã€‚ (b) è€ƒè™‘åˆ°è´Ÿè½½ç”± Cloud Scheduler ç”Ÿæˆï¼ŒJMeter çš„ä¸»è¦ä½œç”¨ä¸æ˜¯ç›´æ¥äº§ç”Ÿè¯·æ±‚ï¼Œè€Œæ˜¯ä½œä¸ºæµ‹è¯•æ§åˆ¶å™¨å’Œè¾…åŠ©ç›‘æ§å·¥å…·ã€‚å¯ä»¥è®¾ç½®ä¸€ä¸ª HTTP è¯·æ±‚é‡‡æ ·å™¨ï¼Œåœ¨æµ‹è¯•æœŸé—´ä»¥ä½é¢‘ç‡è½®è¯¢ Backend Service çš„å¥åº·æ£€æŸ¥æ¥å£ï¼Œä»¥ä»å¤–éƒ¨è§†è§’è®°å½•å…¶å¯ç”¨æ€§å’Œå“åº”æ—¶é—´ã€‚ (c) åœ¨ JMeter ä¸­é…ç½®åç«¯ç›‘å¬å™¨ï¼ˆBackend Listenerï¼‰ï¼Œå°† JMeter æ”¶é›†åˆ°çš„æ•°æ®ï¼ˆå¦‚å¥åº·æ£€æŸ¥å“åº”æ—¶é—´ï¼‰å®æ—¶å‘é€åˆ° Prometheus æˆ– InfluxDBï¼Œä»¥ä¾¿ä¸ GCP ç›‘æ§æ•°æ®è¿›è¡Œå…³è”åˆ†æã€‚ (5) æ‰§è¡Œå‹æµ‹å¹¶è¿›è¡Œå®æ—¶åˆ†æï¼š (a) åœ¨é¢„å®šæ—¶é—´å¯åŠ¨ JMeter æµ‹è¯•è®¡åˆ’ï¼Œå¹¶åŒæ—¶è§¦å‘è‡ªåŠ¨åŒ–è„šæœ¬æ¥åˆ›å»ºå’Œè¿è¡Œ Cloud Scheduler ä»»åŠ¡ã€‚ (a) åœ¨ 30 åˆ†é’Ÿçš„æµ‹è¯•æœŸé—´ï¼Œå¯†åˆ‡è§‚å¯Ÿç›‘æ§ä»ªè¡¨ç›˜ï¼Œç‰¹åˆ«æ˜¯ Pub/Sub æ¶ˆæ¯ç§¯å‹æ•°é‡çš„å˜åŒ–è¶‹åŠ¿ã€Schedule Service çš„èµ„æºæ¶ˆè€—ä»¥åŠ Backend Service çš„ HPA æ‰©å®¹æƒ…å†µã€‚ (6) æ·±å…¥åˆ†ææµ‹è¯•ç»“æœå¹¶å®šä½æ€§èƒ½ç“¶é¢ˆï¼š (a) æµ‹è¯•ç»“æŸåï¼Œè¯¦ç»†åˆ†æ Pub/Sub ç§¯å‹æ›²çº¿ã€‚å¦‚æœç§¯å‹æŒç»­å¢é•¿ï¼Œåˆ™è¯æ˜ Schedule Service çš„å¤„ç†èƒ½åŠ›å·²è¾¾ä¸Šé™ã€‚ (b) åˆ†æ Schedule Service çš„æ—¥å¿—ï¼Œç»Ÿè®¡é‡è¯•é€»è¾‘çš„è§¦å‘é¢‘ç‡å’Œæ€»è€—æ—¶ï¼Œè¯„ä¼°å…¶å¯¹æ•´ä½“å¤„ç†æµç¨‹çš„å½±å“ã€‚ (c) è¯„ä¼° Backend Service çš„ HPA ç­–ç•¥æ˜¯å¦æœ‰æ•ˆï¼Œæ‰©å®¹æ˜¯å¦åŠæ—¶ï¼Œä»¥åŠåœ¨é«˜è´Ÿè½½ä¸‹çš„å“åº”æ—¶é—´å’Œé”™è¯¯ç‡ã€‚ (7) ç»¼åˆè¯„ä¼°ç°æœ‰æ¶æ„å¹¶æå‡ºä¼˜åŒ–æ–¹æ¡ˆï¼š (a) åŸºäºæµ‹è¯•æ•°æ®ï¼Œæ‰¹åˆ¤æ€§åœ°åˆ†æå•ä¸€ Pub/Sub Topic å¯¹å¤š API é€ æˆçš„â€œé˜Ÿå¤´é˜»å¡â€é—®é¢˜ã€‚ (b) æå‡ºæ¶æ„ä¼˜åŒ–å»ºè®®ï¼Œä¾‹å¦‚ï¼šä¸ºæ¯ä¸ª API æˆ–ä»»åŠ¡ç±»å‹ä½¿ç”¨ç‹¬ç«‹çš„ Pub/Sub Topic å’Œ Subscription æ¥å½»åº•è§£å†³é˜»å¡é—®é¢˜ï¼›ä¸º Schedule Service å¯ç”¨ HPA å¹¶ä¼˜åŒ–å…¶å†…éƒ¨çº¿ç¨‹æ¨¡å‹ä»¥æé«˜å¹¶å‘å¤„ç†èƒ½åŠ›ï¼›ä¸º Pub/Sub è®¢é˜…é…ç½®æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead-Letter Queueï¼‰ï¼Œå°†å¤„ç†å¤±è´¥çš„æ¶ˆæ¯è½¬ç§»ï¼Œé¿å…å½±å“åç»­ä»»åŠ¡ã€‚ (8) è§„åˆ’å›å½’æµ‹è¯•ï¼š (a) åœ¨å®æ–½ä»»ä½•ä¼˜åŒ–æªæ–½åï¼Œä½¿ç”¨ç›¸åŒçš„å‹æµ‹æ–¹æ¡ˆè¿›è¡Œå›å½’æµ‹è¯•ï¼Œä»¥é‡åŒ–æ¯”è¾ƒæ”¹è¿›å‰åçš„æ€§èƒ½å·®å¼‚ï¼Œå¹¶éªŒè¯ä¼˜åŒ–æªæ–½çš„æœ‰æ•ˆæ€§ã€‚

# Chatgtp

# **JMeter å‹æµ‹æ–¹æ¡ˆ**

## **åœºæ™¯æ¦‚è¿°**

å½“å‰æ¶æ„ä¸ºï¼š**Cloud Scheduler** å®šæ—¶ä»»åŠ¡è§¦å‘æ¶ˆæ¯å‘å¸ƒåˆ°å…¬ç”¨çš„ **Pub/Sub Topic** ï¼›**Schedule Service**ï¼ˆéƒ¨ç½²åœ¨ GKEï¼‰è®¢é˜…è¯¥ä¸»é¢˜ï¼Œæ¥æ”¶æ¶ˆæ¯åæ„é€ å¸¦ Basic Auth çš„ HTTP è¯·æ±‚ï¼Œè°ƒç”¨åå° **Backend Service**ã€‚åå°æœåŠ¡åŒæ ·éƒ¨ç½²åœ¨ GKEï¼Œæ”¯æŒåŸºäº CPU æˆ–è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆå¦‚ Pub/Sub ç§¯å‹ï¼‰è¿›è¡Œ HPA æ‰©ç¼©å®¹ ã€‚ç”±äºå¤šä¸ªè°ƒåº¦ä»»åŠ¡å…±äº«åŒä¸€ä¸»é¢˜ï¼Œä¸”ç½‘å…³ï¼ˆKongï¼‰å­˜åœ¨é»˜è®¤ 6 åˆ†é’Ÿè¶…æ—¶ã€3 æ¬¡é‡è¯•ç­‰è®¾ç½®ï¼Œå¦‚æœåç«¯å¤„ç†ä¸åŠæ—¶ï¼Œå¯èƒ½å¯¼è‡´æ¶ˆæ¯å †ç§¯å’Œå»¶è¿Ÿã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•´ä¸ªé“¾è·¯è¿›è¡Œ 30 åˆ†é’Ÿçš„å‹åŠ›æµ‹è¯•ï¼Œè¯„ä¼°å„ç»„ä»¶åœ¨é«˜è´Ÿè½½ä¸‹çš„è¡¨ç°å’Œæ‰©å±•æ€§ã€‚

## **å‹æµ‹ç›®æ ‡**

- **Schedule Service å¤„ç†èƒ½åŠ›**ï¼šæµ‹é‡æ¶ˆæ¯æ¶ˆè´¹é€Ÿç‡ã€å¹¶å‘å¤„ç†èƒ½åŠ›åŠé‡è¯•æœºåˆ¶å¯¹æ€§èƒ½çš„å½±å“ã€‚ç›‘æ§è®¢é˜…æœªç¡®è®¤æ¶ˆæ¯æ•°é‡ï¼Œæ£€æŸ¥æ˜¯å¦å‡ºç°ç§¯å‹ã€‚
- **Backend æœåŠ¡å“åº”èƒ½åŠ›**ï¼šè§‚å¯Ÿåç«¯è¯·æ±‚çš„å¹³å‡å»¶è¿Ÿã€é”™è¯¯ç‡ï¼Œä»¥åŠ HPA æ‰©å±•æƒ…å†µï¼ˆPod æ•°é‡éšè´Ÿè½½å˜åŒ–ï¼‰ã€‚éªŒè¯åç«¯åœ¨é«˜å¹¶å‘ä¸‹æ˜¯å¦ä¼šè¾¾åˆ°èµ„æºç“¶é¢ˆã€‚
- **ç«¯åˆ°ç«¯å»¶è¿Ÿ**ï¼šç»Ÿè®¡ä» Cloud Scheduler è§¦å‘åˆ°æ¶ˆæ¯ç» Schedule Service å¤„ç†å¹¶é€è¾¾ Backend çš„æ€»ä½“æ—¶å»¶ï¼ˆå¯é€šè¿‡åœ¨æ¶ˆæ¯ä¸­åŠ å…¥æ—¶é—´æˆ³ã€è‡ªå®šä¹‰æ—¥å¿—åŸ‹ç‚¹ç­‰æ–¹å¼æµ‹é‡ï¼‰ã€‚
- **æ•´ä½“ç¨³å®šæ€§**ï¼šæ£€æŸ¥ç½‘å…³è¶…æ—¶ã€é”™è¯¯å“åº”ã€æœåŠ¡æ—¥å¿—é”™è¯¯ç­‰ï¼Œç¡®ä¿é«˜è´Ÿè½½æ—¶ç³»ç»Ÿç¨³å®šæ€§ã€‚

## **è´Ÿè½½ç”Ÿæˆç­–ç•¥**

- **åˆ›å»ºå¤§é‡ Scheduler ä»»åŠ¡**ï¼šåˆ©ç”¨ gcloud å‘½ä»¤æˆ–è„šæœ¬æ‰¹é‡åˆ›å»ºæ•°åç”šè‡³ä¸Šç™¾ä¸ª Cloud Scheduler ä»»åŠ¡ã€‚ä¾‹å¦‚ä½¿ç”¨ gcloud scheduler jobs create pubsub ... --topic=TOPIC --message-body="..." æ–¹å¼ï¼Œä¸€æ¬¡æ€§ç”Ÿæˆå¤šä¸ªè§¦å‘åŒä¸€ä¸»é¢˜çš„ä»»åŠ¡ ã€‚å¯ä»¥å°†è¿™äº›ä»»åŠ¡é¢‘ç‡è®¾ä¸ºæ¯åˆ†é’Ÿæˆ–æ›´çŸ­ï¼Œä»¥æŒç»­è§¦å‘å¤§é‡æ¶ˆæ¯ã€‚
- **ç›´æ¥å‘å¸ƒ Pub/Sub æ¶ˆæ¯**ï¼šé™¤äº† Schedulerï¼Œä¹Ÿå¯ä»¥è·³è¿‡ Scheduler ç›´æ¥é€šè¿‡è„šæœ¬æˆ–å·¥å…·è°ƒç”¨ Pub/Sub å‘å¸ƒ APIã€‚JMeter å¯ä»¥æ¨¡æ‹Ÿè¿™ä¸€æ“ä½œï¼ˆè§ä¸‹æ–‡ JMeter æ–¹æ¡ˆï¼‰ã€‚éœ€è¦ä¸€ä¸ªæ‹¥æœ‰ Publisher æƒé™çš„ Service Accountï¼Œå¹¶é…ç½®å¥½ Pub/Sub ä¸»é¢˜ã€‚
- **ä½¿ç”¨ JMeter ç”Ÿæˆè´Ÿè½½**ï¼šé€šè¿‡ JMeter æ¨¡æ‹Ÿå¹¶å‘ä»»åŠ¡å‘å¸ƒæ¶ˆæ¯ã€‚å®‰è£… Google Pub/Sub æ’ä»¶åï¼Œå¯åœ¨æ¯ä¸ªçº¿ç¨‹ç»„ä¸­ä½¿ç”¨ â€œ**PubSub-PublisherConfiguration**â€ é…ç½®å‘å¸ƒå‡­è¯å’Œä¸»é¢˜ä¿¡æ¯ï¼Œç„¶åæ·»åŠ  â€œ**Publisher Request**â€ é‡‡æ ·å™¨ï¼Œå¡«å…¥è¦å‘å¸ƒçš„æ¶ˆæ¯å†…å®¹ ã€‚æ¯ä¸ªçº¿ç¨‹ç»„å°±æ¨¡æ‹Ÿä¸€ä¸ªå¹¶å‘å®¢æˆ·ç«¯ï¼Œä¸æ–­å‘å¸ƒæ¶ˆæ¯åˆ° Pub/Subï¼ˆæ–‡æ¡£å»ºè®®å¯é€šè¿‡å¢å¤§çº¿ç¨‹ç»„æ•°å’Œè¯·æ±‚å»¶è¿Ÿæ¥æ§åˆ¶è´Ÿè½½å¼ºåº¦ ï¼‰ã€‚

## **JMeter æµ‹è¯•æ–¹æ¡ˆ**

- **ç¯å¢ƒå‡†å¤‡**ï¼šå®‰è£… JMeterï¼Œå¹¶ä½¿ç”¨ Plugins Manager å®‰è£… **GCP Pub/Sub Plugin**ã€‚æ ¹æ®å®˜æ–¹æç¤ºï¼Œå°† Google Cloud Pub/Sub å®¢æˆ·ç«¯ä¾èµ–ï¼ˆå¦‚ google-cloud-pubsubã€gsonï¼‰ä¸‹è½½æ”¾å…¥ JMeter çš„ lib ç›®å½• ã€‚
- **é…ç½®çº¿ç¨‹ç»„**ï¼šåœ¨æµ‹è¯•è®¡åˆ’ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç»„ï¼ˆThread Groupï¼‰ï¼Œé…ç½®å¥½çº¿ç¨‹æ•°ï¼ˆå¹¶å‘ç”¨æˆ·æ•°ï¼‰ã€Ramp-up å’Œå¾ªç¯æ¬¡æ•°ã€‚å¯ä¾æ®é¢„æœŸååé‡è°ƒæ•´çº¿ç¨‹æ•°å’Œå»¶è¿Ÿï¼Œä»¥æ¨¡æ‹Ÿé€æ­¥å¢åŠ çš„è´Ÿè½½ ã€‚ä¾‹å¦‚ï¼Œé€æ­¥ä» 10 ä¸ªçº¿ç¨‹å¢è‡³ 100 ä¸ªçº¿ç¨‹ï¼Œè§‚å¯Ÿç³»ç»Ÿè¡¨ç°ã€‚
- **Pub/Sub å‘å¸ƒé‡‡æ ·å™¨**ï¼šåœ¨çº¿ç¨‹ç»„ä¸‹é…ç½® â€œPubSub-PublisherConfigurationâ€ï¼ŒæŒ‡å®š GCP é¡¹ç›®ã€ä¸»é¢˜ã€Service Account å‡­è¯ç­‰ä¿¡æ¯ ã€‚éšåæ·»åŠ  â€œPublisher Requestâ€ é‡‡æ ·å™¨ï¼Œå°†è¦å‘é€çš„æ¶ˆæ¯æ•°æ®å¡«å…¥ Bodyï¼ˆå¯åŒ…å« JSON ç­‰è°ƒåº¦ä»»åŠ¡çš„å®é™…æ ¼å¼ï¼‰ã€‚æ‰§è¡Œæµ‹è¯•æ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šä¸æ–­å‘ Pub/Sub å‘å¸ƒæ¶ˆæ¯ã€‚
- **å¯é€‰è„šæœ¬å®ç°**ï¼šè‹¥ä¸ä½¿ç”¨æ’ä»¶ï¼Œä¹Ÿå¯åœ¨ JMeter ä¸­æ·»åŠ  **JSR223 Sampler** å¹¶å¼•å…¥ Google Pub/Sub Java å®¢æˆ·ç«¯åº“ï¼Œé€šè¿‡ Groovy è„šæœ¬è°ƒç”¨ Publisher.publish() æ¥å£å‘å¸ƒæ¶ˆæ¯ï¼ˆå‚è€ƒ Google å®˜æ–¹ç¤ºä¾‹ ï¼‰ã€‚ä½†ä½¿ç”¨æ’ä»¶æ–¹å¼æ›´ç›´è§‚ã€‚
- **æ§åˆ¶ä¸å¢é‡æµ‹è¯•**ï¼šæµ‹è¯•å»ºè®®åˆ†é˜¶æ®µè¿›è¡Œï¼Œå…ˆéªŒè¯å°è§„æ¨¡è´Ÿè½½æ˜¯å¦æ­£å¸¸ï¼Œç„¶åé€æ­¥å¢åŠ å¹¶å‘å’Œæ¶ˆæ¯é€Ÿç‡ã€‚åœ¨ç›¸åŒæµ‹è¯•æœŸé—´ä¿æŒ 30 åˆ†é’Ÿå·¦å³çš„æŒç»­è´Ÿè½½ï¼Œä»¥ç¨³å®šè§‚å¯Ÿæ‰©å±•è¡¨ç°ã€‚

## **ç›‘æ§ä¸æŒ‡æ ‡**

- **Pub/Sub è®¢é˜…ç›‘æ§**ï¼šåœ¨ Cloud Monitoring ä¸­è§‚å¯Ÿè®¢é˜…ç›¸å…³æŒ‡æ ‡ã€‚å…³æ³¨ **subscription/num_unacked_messages_by_region**ï¼ˆæœªç¡®è®¤æ¶ˆæ¯æ•°ï¼‰å’Œ **subscription/oldest_unacked_message_age_by_region**ï¼ˆæœ€è€æœªç¡®è®¤æ¶ˆæ¯æ—¶é•¿ï¼‰ç­‰æŒ‡æ ‡ ï¼Œåˆ¤æ–­æ˜¯å¦å‡ºç°æ¶ˆæ¯å †ç§¯æˆ–å¤„ç†æ»åã€‚è®¢é˜…çš„ ack/message é€Ÿç‡ä¹Ÿå¯è¡¨å¾ Schedule Service çš„æ¶ˆè´¹é€Ÿç‡ã€‚
- **Schedule Service ç›‘æ§**ï¼šé€šè¿‡å®¹å™¨ç›‘æ§ï¼ˆCPUã€å†…å­˜ï¼‰å’Œåº”ç”¨æ—¥å¿—ï¼ŒæŸ¥çœ‹å…¶å¤„ç†ååé‡ã€é”™è¯¯ï¼ˆä¾‹å¦‚å‘å¸ƒå¤±è´¥ã€è¶…æ—¶é‡è¯•ï¼‰ç­‰ã€‚è®°å½•æœåŠ¡ç«¯æ—¥å¿—ä¸­å¤„ç†æ¯æ¡æ¶ˆæ¯çš„æ—¶é—´ã€‚åˆ©ç”¨æŒ‡æ ‡å·¥å…·ï¼ˆå¦‚ Prometheus + Grafana æˆ– Stackdriver Monitoringï¼‰ç»Ÿè®¡æ¯ç§’å¤„ç†æ¶ˆæ¯æ•°ã€é‡è¯•æ¬¡æ•°ç­‰ã€‚
- **Backend æœåŠ¡ç›‘æ§**ï¼šæŸ¥çœ‹åç«¯ Deployment çš„**Pod æ•°é‡**å’Œ**CPU/å†…å­˜åˆ©ç”¨ç‡**ï¼Œè¯„ä¼° HPA æ‰©å®¹æƒ…å†µã€‚ç›‘æ§è¯·æ±‚å“åº”æ—¶é—´ï¼ˆå¹³å‡/99%æ—¶å»¶ï¼‰ã€é”™è¯¯ç‡ï¼ˆHTTP 5xxï¼‰ç­‰ã€‚HPA å¦‚æœåŸºäº CPU æˆ– Pub/Sub ç§¯å‹è¿›è¡Œæ‰©å®¹ï¼Œåº”å½“èƒ½åœ¨è´Ÿè½½å‡é«˜æ—¶è§¦å‘æ›´å¤šå‰¯æœ¬ ã€‚å¯ä½¿ç”¨ kubectl get hpa æˆ–ç›‘æ§ä»ªè¡¨ç›˜æŸ¥çœ‹å®æ—¶çŠ¶æ€ã€‚
- **ç«¯åˆ°ç«¯å»¶è¿Ÿ**ï¼šåœ¨ Schedule Service å‘å¸ƒåˆ° Backend çš„ HTTP è¯·æ±‚ä¸­ï¼Œå¯ä»¥ä¼ é€’ä¸‹æ¸¸è¿”å›ä¿¡æ¯æˆ–è€…åœ¨æ—¥å¿—æ‰“å°æ—¶é—´æˆ³ï¼›æˆ–è€…åœ¨åŸå§‹æ¶ˆæ¯ä¸Šæ‰“æ ‡è®°ä»¥è®¡ç®—ä»å‘å¸ƒåˆ°ç¡®è®¤çš„æ€»æ—¶å»¶ã€‚ç»Ÿè®¡å¹¶åˆ†æè¿™éƒ¨åˆ†å»¶è¿Ÿéšè´Ÿè½½å¢åŠ çš„å˜åŒ–è¶‹åŠ¿ã€‚
- **ç½‘å…³/Kong ç›‘æ§**ï¼šç”±äºè¯·æ±‚é€šè¿‡ Kong è½¬å‘ï¼Œéœ€å…³æ³¨ Kong çš„è¶…æ—¶å’Œé‡è¯•æ—¥å¿—ã€‚è®°å½•æ˜¯å¦æœ‰è¯·æ±‚å› è¶…æ—¶ï¼ˆ6 åˆ†é’Ÿï¼‰è¢«å–æ¶ˆè€Œå¯¼è‡´é‡è¯•ï¼Œæˆ–ç§¯å‹åœ¨ Schedule Service ä¸­ã€‚
- **æ—¥å¿—åˆ†æ**ï¼šå°†å„ç»„ä»¶æ—¥å¿—ï¼ˆSchedule Serviceã€Backendï¼‰å¯¼å‡ºåˆ° Cloud Logging æˆ– BigQueryï¼Œè¿›è¡Œè¯¦ç»†åˆ†æã€‚Google å»ºè®®åœ¨å¤§è§„æ¨¡æµ‹è¯•æ—¶è¿›è¡ŒäºŒçº§æ—¥å¿—åˆ†æï¼Œå› ä¸ºç›‘æ§æŒ‡æ ‡å¯èƒ½ä¸å¤Ÿç²¾ç»† ã€‚

## **æ‰©å±•æ€§è¯„ä¼°**

- **Schedule Service æ‰©å®¹**ï¼šå¦‚æœ Schedule Service é…ç½®äº† HPAï¼ˆå¦‚åŸºäº CPU æˆ–è‡ªå®šä¹‰æŒ‡æ ‡ï¼‰ï¼Œè§‚å¯Ÿåœ¨é«˜å¹¶å‘æ—¶æ˜¯å¦è‡ªåŠ¨å¢å®¹ã€‚æµ‹è¯•ä¸­å¯å°è¯•ä¿®æ”¹ HPA æœ€å°å®ä¾‹æ•°ã€ä¸åŒæŒ‡æ ‡ç­–ç•¥ï¼Œè¯„ä¼°å…¶çº¿æ€§æ‰©å±•èƒ½åŠ›ã€‚
- **Backend HPA**ï¼šBackend å·²å¯ç”¨ HPAï¼Œåº”èƒ½æ ¹æ®è´Ÿè½½è‡ªåŠ¨æ‰©å®¹ã€‚åˆ©ç”¨æµ‹è¯•è§‚å¯Ÿ HPA æ‰©å®¹é€Ÿåº¦å’Œå‰¯æœ¬ç¨³å®šæ€§ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨ Pub/Sub ç§¯å‹æŒ‡æ ‡æ¥é©±åŠ¨ HPAï¼Œä½¿å…¶åœ¨æ¶ˆæ¯å †ç§¯åˆæœŸå°±è§¦å‘æ‰©å®¹ ã€‚
- **Kong å’Œè¶…æ—¶ç­–ç•¥**ï¼šå¦‚æœå‘ç°ç½‘å…³è¶…æ—¶æˆä¸ºç“¶é¢ˆï¼Œå¯å°è¯•è°ƒæ•´ Kong çš„è¶…æ—¶å’Œé‡è¯•å‚æ•°ï¼Œæˆ–å¢åŠ  Kong å®ä¾‹æ•°ã€‚æµ‹è¯•åº”éªŒè¯ä¿®æ”¹é…ç½®åçš„å½±å“ï¼Œä¾‹å¦‚æ˜¯å¦æœ‰æ•ˆé¿å…äº†è¿‡å¤šçš„å¤±è´¥é‡è¯•ç´¯ç§¯ã€‚
- **æ°´å¹³æ‰©å±•èƒ½åŠ›**ï¼šåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨è´Ÿè½½é™ä½å Pod èƒ½æ­£å¸¸ç¼©å®¹ï¼ˆHPA å›ç¼©æœºåˆ¶ï¼‰ã€‚å¯å¤šæ¬¡è¿›è¡Œä¸åŒè§„æ¨¡çš„å‹æµ‹ï¼Œç¡®è®¤æœåŠ¡çš„æ‰©å±•ä¸æ”¶æ•›æ˜¯å¦ç¨³å®šå¹¶çº¿æ€§ã€‚

## **å‹æµ‹æ­¥éª¤ç¤ºä¾‹**

1. **å‡†å¤‡ç¯å¢ƒ**ï¼šåœ¨ GCP é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ª Pub/Sub ä¸»é¢˜å’Œå¯¹åº”è®¢é˜…ã€‚ç¼–å†™è„šæœ¬æˆ–æ‰‹åŠ¨ä½¿ç”¨ gcloud æ‰¹é‡åˆ›å»º Cloud Scheduler ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼šgcloud scheduler jobs create pubsub job1 --schedule="_/1 _ \* \* \*" --topic=TEST_TOPIC --message-body="test" ï¼Œä¾æ­¤ç±»æ¨åˆ›å»ºå¤šä¸ªä½œä¸šã€‚
2. **é…ç½® JMeter**ï¼šå¯åŠ¨ JMeterï¼Œå®‰è£…å¹¶é…ç½® GCP Pub/Sub æ’ä»¶ã€‚è®¾ç½®å¥½çº¿ç¨‹ç»„å‚æ•°ï¼ˆçº¿ç¨‹æ•°ã€Ramp-upã€å¾ªç¯æ¬¡æ•°ï¼‰å’Œ PubSub-PublisherConfigurationï¼ˆå¡«å†™é¡¹ç›® IDã€ä¸»é¢˜åã€æœåŠ¡è´¦å·å‡­è¯è·¯å¾„ï¼‰ã€‚
3. **è¿è¡Œå‹æµ‹**ï¼šå¯åŠ¨ JMeterï¼Œå¼€å§‹å‘ Pub/Sub å‘å¸ƒå¤§é‡æ¶ˆæ¯ï¼ŒæŒç»­çº¦ 30 åˆ†é’Ÿã€‚åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­é€æ­¥å¢åŠ å¹¶å‘é‡ï¼Œè§‚å¯Ÿ JMeter çš„ååç‡å’Œé”™è¯¯æ•°ã€‚
4. **ç›‘æ§è§‚å¯Ÿ**ï¼šåŒæ—¶åœ¨ GCP æ§åˆ¶å°ç›‘æ§ Pub/Sub è®¢é˜…çŠ¶æ€ï¼ˆæœªç¡®è®¤æ¶ˆæ¯æ•°ã€å»¶è¿Ÿï¼‰ã€Schedule Service çš„ Pod æŒ‡æ ‡ã€Backend æœåŠ¡çš„ CPU/Pod æ•°å’Œå“åº”å»¶è¿Ÿç­‰ã€‚è®°å½•å…³é”®æ•°æ®ç‚¹ï¼Œå¦‚æœ€å¤§ååé‡ã€å¹³å‡å»¶è¿Ÿã€é”™è¯¯ç‡ã€‚
5. **æ•°æ®åˆ†æ**ï¼šæµ‹è¯•ç»“æŸåï¼Œå¯¹ç…§ç›‘æ§æ•°æ®å’Œæ—¥å¿—åˆ†æå„é¡¹æŒ‡æ ‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœªç¡®è®¤æ¶ˆæ¯æ•°æŒç»­å¢é•¿ï¼Œè¯´æ˜æ¶ˆè´¹é€Ÿç‡ä¸è¶³ï¼›å¦‚æœ HPA è¾¾åˆ°ä¸Šé™ä½†ä»é¥±å’Œï¼Œè¯´æ˜èµ„æºå¯èƒ½ä¸å¤Ÿï¼›è‹¥ç½‘å…³å‡ºç°å¤§é‡è¶…æ—¶æˆ– 5xx é”™è¯¯ï¼Œåˆ™éœ€ä¼˜åŒ–é‡è¯•ç­–ç•¥æˆ–æ‰©å®¹ç½‘å…³ç­‰ã€‚

## **åç»­ä¼˜åŒ–å»ºè®®**

- ä¼˜åŒ– **Schedule Service** é€»è¾‘ï¼šè°ƒæ•´å†…éƒ¨é‡è¯•æ¬¡æ•°å’Œé—´éš”ï¼ˆå½“å‰ä¸º 0sã€10sã€20sï¼‰ï¼Œé¿å…å› é•¿æ—¶é—´é˜»å¡å¯¼è‡´æ¶ˆæ¯ç§¯å‹è¿‡å¤šã€‚
- è€ƒè™‘å¯¹ä¸åŒä¸šåŠ¡å›¢é˜Ÿåˆ†é…ç‹¬ç«‹çš„ Pub/Sub ä¸»é¢˜æˆ–è®¢é˜…ï¼Œä»¥éš”ç¦»æµé‡ï¼Œé˜²æ­¢â€œå…¬ç”¨ä¸»é¢˜â€å¯¼è‡´çš„äº’ç›¸å½±å“ã€‚
- æ ¹æ®å‹æµ‹ç»“æœè°ƒæ•´ HPA ç­–ç•¥å’Œç½‘å…³é…ç½®ï¼Œå¦‚å¢åŠ  Kong å®ä¾‹ã€å»¶é•¿è¶…æ—¶æ—¶é—´æˆ–å¯ç”¨åˆ†å¸ƒå¼è¿½è¸ªç­‰ã€‚

**å‚è€ƒèµ„æ–™ï¼š** Cloud Scheduler å¯é€šè¿‡ gcloud å‘½ä»¤åˆ›å»º Pub/Sub ç±»å‹ä»»åŠ¡ ï¼›JMeter GCP Pub/Sub æ’ä»¶ä½¿ç”¨è¯´æ˜ ï¼›Google Cloud Run æ–‡æ¡£å»ºè®®ä½¿ç”¨ JMeter çº¿ç¨‹ç»„æ¥æ§åˆ¶è´Ÿè½½ ï¼›GKE HPA å¯åŸºäº Pub/Sub ç§¯å‹è‡ªåŠ¨æ‰©å®¹ ï¼›Pub/Sub ç›‘æ§æŒ‡æ ‡åŒ…æ‹¬æœªç¡®è®¤æ¶ˆæ¯æ•°å’Œæœ€è€æœªç¡®è®¤æ—¶é—´ ã€‚

æ˜¯çš„ï¼Œä½ çš„ç›®æ ‡ **å®Œå…¨å¯ä»¥å®ç°**ï¼Œæ¶æ„ä¸Šä¹Ÿåˆç†ï¼š

**ä¸€ä¸ª Topic + å¤šä¸ª Subscriptionï¼ˆæ¯ä¸ª Job ç»‘å®šä¸€ä¸ª Subï¼‰+ åŒä¸€ä¸ª Backend APIã€‚**

---

## **âœ… æ¶æ„ç›®æ ‡æ€»ç»“**

```mermaid
flowchart TD
  subgraph "å‹æµ‹ç»“æ„"
    Scheduler1[Scheduler Job 1] --> Pub[aibang-lex-eg-job-topic]
    Scheduler2[Scheduler Job 2] --> Pub
    Scheduler3[Scheduler Job 3] --> Pub
    Pub --> Sub1[Sub-job-1]
    Pub --> Sub2[Sub-job-2]
    Pub --> Sub3[Sub-job-3]
    Sub1 --> ScheduleService1
    Sub2 --> ScheduleService2
    Sub3 --> ScheduleService3
    ScheduleService1 & ScheduleService2 & ScheduleService3 --> Kong
    Kong --> BackendAPI[Backend Service API]
  end
```

---

## **âœ… å…³é”®æŠ€æœ¯ç‚¹è¯´æ˜**

### **1.**Â 

### **Pub/Sub æ”¯æŒä¸€å¯¹å¤šæ¶ˆè´¹**

- ä¸€ä¸ª Topic å¯ä»¥ç»‘å®šå¤šä¸ª Subscriptionï¼›
- æ¯ä¸ª Subscription æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯å½¼æ­¤**ç‹¬ç«‹çš„å‰¯æœ¬**ï¼›
- æ‰€ä»¥ä½ å¯ä»¥è®©æ¯ä¸ª Cloud Scheduler Job å¯¹åº”ä¸€ä¸ª Subï¼Œé€šè¿‡ Pub/Sub -> Schedule Service -> Backendã€‚

### **2.**Â 

### **å¦‚ä½•å®ç°å¤š Sub æ¶ˆè´¹åŒä¸€ä¸ª Topicï¼Ÿ**

#### **Step A: åˆ›å»ºå¤šä¸ª Subscriptionï¼ˆç‹¬ç«‹åå­—ï¼‰**

```
for i in $(seq -w 1 100); do
  gcloud pubsub subscriptions create sub-job-${i} \
    --topic=aibang-lex-eg-job-topic \
    --ack-deadline=60 \
    --message-retention-duration=600s \
    --project=your-project-id
done
```

#### **Step B: æ¯ä¸ª Schedule Service å®ä¾‹ç›‘å¬ä¸€ä¸ª Subscriptionï¼ˆæˆ–é…ç½®æ¶ˆè´¹å¤šä¸ªï¼‰**

- ä½ å¯ä»¥éƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œæˆ– Schedule Service å†…éƒ¨ç”¨å¹¶å‘çº¿ç¨‹åˆ†åˆ«è®¢é˜…ï¼›
- æˆ–è€…åŒä¸€ä¸ªæœåŠ¡æ¥æ”¶å¤šä¸ª Subscription çš„æ¶ˆæ¯ï¼ˆéœ€è¦å¼‚æ­¥å¤„ç†ï¼‰ï¼›
- **å»ºè®®æ–¹å¼**ï¼šæ¯ä¸ª Sub å¯¹åº”ä¸€ä¸ª Kubernetes Job æˆ– Deployment å¤„ç†é€»è¾‘ã€‚

---

## **âœ… JMeter å‹æµ‹å»ºè®®**

ä½ ä¸éœ€è¦ JMeter ç›´æ¥è°ƒç”¨ Backend APIï¼Œè€Œæ˜¯é—´æ¥é€šè¿‡ Cloud Scheduler å‘é€ Pub/Sub æ¶ˆæ¯æ¥å‹æµ‹ï¼š

| **å·¥å…·**                            | **ç›®æ ‡**                                                               |
| ----------------------------------- | ---------------------------------------------------------------------- |
| gcloud scheduler jobs create pubsub | æ¨¡æ‹Ÿç”¨æˆ·ä»»åŠ¡è°ƒåº¦ï¼Œæ‰¹é‡è§¦å‘æ¶ˆæ¯                                         |
| GCP Pub/Sub                         | åŒä¸€ä¸ª Topic + å¤šä¸ª Subscription å®ç° fan-out å¹¶å‘å¤„ç†                 |
| Schedule Service (GKE)              | å®é™…æ¶ˆè´¹å¹¶è°ƒç”¨ Backend APIï¼ˆè¯„ä¼°å¤„ç†ä¸é‡è¯•èƒ½åŠ›ï¼‰                       |
| Backend API                         | è¢«å‹æµ‹ç›®æ ‡ï¼Œé€šè¿‡ GKE HPA è‡ªåŠ¨æ‰©å®¹                                      |
| JMeterï¼ˆå¯é€‰ï¼‰                      | æ¨¡æ‹Ÿå¤–éƒ¨é«˜é¢‘ Job åˆ›å»ºæˆ–ç›‘æ§ Backend å“åº”æ€§èƒ½ï¼ˆå¦‚ä½ è¿˜æƒ³æ¨¡æ‹Ÿ HTTP è¯·æ±‚ï¼‰ |

---

## **âœ… å»ºè®®ç›‘æ§æŒ‡æ ‡**

| **å±‚çº§**         | **æŒ‡æ ‡**                       | **è¯´æ˜**                   |
| ---------------- | ------------------------------ | -------------------------- |
| Pub/Sub          | num_undelivered_messages       | æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¶ˆæ¯ backlog   |
| Pub/Sub          | ack_latency                    | æ¶ˆæ¯æ¶ˆè´¹å»¶è¿Ÿ               |
| Scheduler        | job execution count            | æ˜¯å¦å®šæ—¶ç¨³å®šè§¦å‘           |
| Schedule Service | CPU / memory / request latency | æ˜¯å¦å­˜åœ¨å¤„ç†ç“¶é¢ˆ           |
| Backend API      | å“åº”æ—¶é—´ / HPA Pod æ•°          | æ˜¯å¦æ‰©å®¹åŠæ—¶ï¼Œæ˜¯å¦è¯·æ±‚æ’‘çˆ† |
| Kong             | è¶…æ—¶ / 5xx                     | è½¬å‘å¤±è´¥æˆ–å“åº”è¿‡æ…¢         |

---

## **âœ… åç»­å¯æ‰©å±•ç­–ç•¥**

- è‹¥è¦å½»åº•éš”ç¦»ä¸åŒå›¢é˜Ÿå½±å“ï¼Œå¯ä»¥è€ƒè™‘ï¼š
    - æ¯ä¸ªå›¢é˜Ÿä¸€ä¸ª Topicï¼›
    - æˆ–è€…åŒä¸€ä¸ª Topic + Filtered Subscriptionï¼ˆPub/Sub æ”¯æŒè¿‡æ»¤å™¨ï¼‰ï¼›
- å¯åœ¨æ¶ˆæ¯ä¸­åŠ ä¸Š apiName/teamName/traceId å­—æ®µï¼Œæ–¹ä¾¿æ—¥å¿—è¿½è¸ªï¼›
- å¯é€šè¿‡ Cloud Logging + BigQuery åˆ†ææ¯æ¡é“¾è·¯çš„å¤„ç†è€—æ—¶ã€‚

---

æ˜¯å¦éœ€è¦æˆ‘å¸®ä½ ç”Ÿæˆï¼š

- å¤š Subscription è‡ªåŠ¨åˆ›å»ºè„šæœ¬
- Schedule Service æ¶ˆè´¹å¤šä¸ª Sub çš„ä»£ç æ¨¡æ¿ï¼ˆJavaï¼‰
- ç›‘æ§æŒ‡æ ‡ YAML æˆ– Grafana å›¾è¡¨æ¨¡æ¿ï¼Ÿ

ä½ é€‰å“ªä¸€ä¸ªæˆ‘å°±ç›´æ¥ç»™ã€‚

æˆ‘æ˜ç¡®äº†éœ€æ±‚,ç°åœ¨ä¸ç”¨ Jmeter å·¥å…·,ç›´æ¥ç”¨ schedule job çš„æ–¹å¼æ¥ Trigger è¿™ä¸ªæµ‹è¯•,æ¯”å¦‚æˆ‘æ 100 ä¸ª Job ç„¶åå‘ç»™åŒä¸€ä¸ª PUB/SUB è®©å…¶æ¥å¤„ç†.æˆ‘ç°åœ¨æ¯”å¦‚å¦‚ä½•åˆ›å»ºè¿™ä¹ˆå¤š Job é‡Œé¢çš„ä»»åŠ¡çš„ message body å¦‚ä½•å†™?è¿™ä¸ªæ˜¯ä¸æ˜¯ä¾èµ–äºæˆ‘çš„ backend service æ¯”å¦‚æˆ‘çš„ backend service å…¶å®å°±æ˜¯ä¸€ä¸ª health çš„é¡µé¢ æˆ‘å°±æ˜¯æœ€ç®€å•çš„æ¨¡æ‹Ÿæµ‹è¯•

æ˜ç™½äº†ï¼Œä½ ç°åœ¨çš„å‹æµ‹ç›®æ ‡æ˜¯ï¼š

- âœ… ç”¨ **Cloud Scheduler åˆ›å»º 100 ä¸ª Job**
- âœ… æ‰€æœ‰ Job å‘é€åˆ°åŒä¸€ä¸ª **Pub/Sub Topic**
- âœ… ä¸ç”¨ JMeterï¼Œè€Œæ˜¯é€šè¿‡ Cloud Scheduler çš„é¢‘ç¹è§¦å‘æ¥æ¨¡æ‹Ÿé«˜å¹¶å‘
- âœ… æ¯æ¡æ¶ˆæ¯è¢« Schedule Service å¤„ç†åï¼Œè½¬å‘è¯·æ±‚åˆ°ä¸€ä¸ªç®€å•çš„ Backendï¼ˆæ¯”å¦‚ /healthï¼‰

---

## **âœ… Message Body è¦æ€ä¹ˆå†™ï¼Ÿ**

**å®Œå…¨å–å†³äºä½ çš„ Schedule Service å¦‚ä½•è§£æ Pub/Sub çš„ messageã€‚**

å¦‚æœä½ çš„ Schedule Service æ˜¯ Java å†™çš„ï¼Œé€šå¸¸ä¼šå¯¹ PubsubMessage.getData() è¿›è¡Œ Base64 è§£ç ï¼Œå†ååºåˆ—åŒ–æˆæŸç§ç»“æ„ï¼ˆæ¯”å¦‚ JSON å¯¹è±¡ï¼‰â€”â€”é‚£ä¹ˆä½ å°±åº”è¯¥æ„é€ è¿™ä¸ªæ ¼å¼çš„æ¶ˆæ¯ã€‚

### **ğŸ”§ å‡è®¾ Schedule Service åªéœ€è¦ä¸€ä¸ª URL å‚æ•°ï¼ˆè®¿é—® Backend çš„**Â 

### **/health**

### **ï¼‰**

ä½ å¯ä»¥è¿™æ ·æ„é€  message bodyï¼ˆJSON æ ¼å¼ï¼‰ï¼š

```
{
  "url": "http://backend-service.default.svc.jiqun.local/health",
  "method": "GET",
  "team": "team-a",
  "api": "health-check"
}
```

---

## **âœ… Shell è„šæœ¬ï¼šæ‰¹é‡åˆ›å»º 100 ä¸ª Job**

```
#!/bin/bash

PROJECT_ID="your-gcp-project-id"
REGION="asia-east1"
TOPIC="aibang-lex-eg-job-topic"
URL="http://backend-service.default.svc.jiqun.local/health"

for i in $(seq -w 1 100); do
  JOB_NAME="job-health-check-${i}"
  MESSAGE_BODY=$(jq -c -n \
    --arg url "$URL" \
    --arg team "team-a" \
    --arg api "health-check-$i" \
    '{url: $url, method: "GET", team: $team, api: $api}')

  gcloud scheduler jobs create pubsub "$JOB_NAME" \
    --schedule="*/1 * * * *" \
    --time-zone="Asia/Shanghai" \
    --topic="$TOPIC" \
    --message-body="$MESSAGE_BODY" \
    --description="Health check job $i" \
    --project="$PROJECT_ID" \
    --location="$REGION"
done
```

> å¦‚æœä½ æœ¬åœ°æ²¡æœ‰å®‰è£… jqï¼Œä½ ä¹Ÿå¯ä»¥ç”¨ç®€å•çš„ bash å­—ç¬¦ä¸²æ‹¼æ¥ï¼š

```
MESSAGE_BODY="{\"url\":\"$URL\",\"method\":\"GET\",\"team\":\"team-a\",\"api\":\"health-check-$i\"}"
```

---

## **âœ… Schedule Service å¦‚ä½•å¤„ç†ï¼Ÿ**

å‡è®¾ä½ çš„ Schedule Service é€»è¾‘æ˜¯è¿™æ ·ï¼ˆç®€åŒ–ï¼‰ï¼š

```
String raw = new String(pubsubMessage.getData().toByteArray(), StandardCharsets.UTF_8);
JsonObject json = new Gson().fromJson(raw, JsonObject.class);
String url = json.get("url").getAsString();
String method = json.get("method").getAsString();
```

ç„¶åæ„é€ è¯·æ±‚å‘ç»™ä½  GKE å†…çš„ Backend Deploymentã€‚

---

## **âœ… æ¨¡æ‹Ÿä¸€ä¸ªæœ€ç®€å•çš„ Backend**Â 

## **/health**

## Â **API**

å¦‚æœä½ åªæ˜¯ä¸ºäº†è®© Schedule Service å‘è¯·æ±‚ï¼Œå¯ä»¥å…ˆéƒ¨ç½²ä¸€ä¸ªæœ€ç®€å•çš„ /health æœåŠ¡ï¼Œæ¯”å¦‚ï¼š

```
kubectl create deployment health-api --image=nginx
kubectl expose deployment health-api --port=80 --target-port=80 --name=health-api
```

ç„¶å Schedule Service çš„ URL å°±æ˜¯ï¼š

```
http://health-api.default.svc.jiqun.local/
```

æˆ–è€…ä½ åœ¨å®¹å™¨é‡Œè·‘ä¸ªè¿”å› 200 OK çš„ç®€å• Spring Boot æˆ– Flask /health æ¥å£ã€‚

---

## **âœ… æ¨èä½ ç›‘æ§è¿™äº›å†…å®¹ during testï¼š**

| **ç»„ä»¶**         | **å…³æ³¨ç‚¹**            | **æŒ‡æ ‡å»ºè®®**                                         |
| ---------------- | --------------------- | ---------------------------------------------------- |
| Pub/Sub          | å †ç§¯æ˜¯å¦å¢åŠ           | num_undelivered_messages, oldest_unacked_message_age |
| Schedule Service | æ˜¯å¦æœ‰æ¶ˆè´¹å µå¡ / é‡è¯• | Pod CPUã€æ—¥å¿—ã€æ˜¯å¦æœ‰ timeoutã€ack é€Ÿç‡              |
| Backend Service  | å“åº”æ˜¯å¦æ’‘çˆ† HPA      | è¯·æ±‚ QPSã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€Pod æ•°é‡å˜åŒ–             |
| æ€»é“¾è·¯           | æ˜¯å¦ç¨³å®š              | Stackdriver Trace + Loggingï¼ˆå¯é€‰ï¼‰                  |

---

éœ€è¦æˆ‘ï¼š

- å¸®ä½ å†™ä¸€ä¸ª Schedule Service æ¶ˆè´¹è€… Java ç¤ºä¾‹ï¼Ÿ
- å¸®ä½ ç”Ÿæˆ Stackdriver ç›‘æ§ Dashboard æ¨¡æ¿ï¼Ÿ

ä½ å‘Šè¯‰æˆ‘ç›®æ ‡ï¼Œæˆ‘é©¬ä¸Šé…å¥½ã€‚

# Gemini

# é’ˆå¯¹ GKE ä¸ Pub/Sub å¼‚æ­¥æ¶æ„çš„å‹åŠ›æµ‹è¯•ä¸å¯é æ€§éªŒè¯ç»¼åˆæ–¹æ¡ˆ

æœ¬æŠ¥å‘Šæ—¨åœ¨ä¸ºåŸºäº Google Cloud Schedulerã€GKE æ‰˜ç®¡æœåŠ¡åŠ Cloud Pub/Sub çš„å¤æ‚å¼‚æ­¥å¤„ç†é“¾è·¯ï¼Œæä¾›ä¸€ä¸ªå…¨é¢ã€æ·±å…¥ä¸”å¯æ‰§è¡Œçš„å‹åŠ›æµ‹è¯•ä¸å¯é æ€§éªŒè¯æ–¹æ¡ˆã€‚æˆ‘ä»¬å°†è¶…è¶Šä¼ ç»Ÿçš„â€œå‹å®â€å¼æµ‹è¯•ï¼Œé‡‡ç”¨ç½‘ç«™å¯é æ€§å·¥ç¨‹ï¼ˆSREï¼‰çš„æœ€ä½³å®è·µï¼Œå°†æœ¬æ¬¡æµ‹è¯•æ„å»ºä¸ºä¸€æ¬¡ç§‘å­¦çš„ã€ä»¥æ•°æ®é©±åŠ¨çš„å¯é æ€§éªŒè¯è¿‡ç¨‹ã€‚

æœ¬æ–¹æ¡ˆçš„æ ¸å¿ƒç›®æ ‡ä¸ä»…æ˜¯æ‰¾å‡ºç³»ç»Ÿçš„æ€§èƒ½ç“¶ G é¢ˆï¼Œæ›´æ˜¯ä¸ºäº†é‡åŒ–å…¶åœ¨è´Ÿè½½ä¸‹çš„è¡Œä¸ºï¼ŒéªŒè¯å…¶å¼¹æ€§ä¼¸ç¼©ä¸å®¹é”™æœºåˆ¶çš„æœ‰æ•ˆæ€§ï¼Œå¹¶æœ€ç»ˆä¸ºæœåŠ¡çš„å¯é æ€§ç›®æ ‡ï¼ˆSLOï¼‰æä¾›åšå®çš„æ•°æ®æ”¯æ’‘ã€‚æˆ‘ä»¬å°†éµå¾ªä»ç†è®ºæ¡†æ¶ã€ç¯å¢ƒå‡†å¤‡ã€è´Ÿè½½ç¼–æ’ã€å…¨é“¾è·¯ç›‘æ§ï¼Œåˆ°ç»“æœåˆ†æä¸å¼¹æ€§ä¼˜åŒ–çš„å®Œæ•´æµç¨‹ï¼Œç¡®ä¿æµ‹è¯•çš„ç§‘å­¦æ€§ã€å¯é‡å¤æ€§ä¸ä»·å€¼æœ€å¤§åŒ–ã€‚

## ç¬¬ 1 éƒ¨åˆ†ï¼šä»¥å¯é æ€§ä¸ºé©±åŠ¨çš„æµ‹è¯•æ¡†æ¶

åœ¨å¯åŠ¨ä»»ä½•å®é™…æ“ä½œä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å»ºç«‹ä¸€ä¸ªåšå®çš„ç†è®ºæ¡†æ¶ã€‚è¿™æ¬¡å‹åŠ›æµ‹è¯•çš„ç›®çš„ä¸åº”ä»…ä»…æ˜¯å‘ç°ç³»ç»Ÿèƒ½æ‰¿è½½å¤šå¤§çš„ QPSï¼Œè€Œåº”æ˜¯éªŒè¯ç³»ç»Ÿåœ¨é¢„è®¾çš„è´Ÿè½½ä¸‹ï¼Œæ˜¯å¦èƒ½å¤Ÿæ»¡è¶³å…¶å¯¹ç”¨æˆ·çš„å¯é æ€§æ‰¿è¯ºã€‚æˆ‘ä»¬å°†æ­¤æ‰¿è¯ºé‡åŒ–ä¸ºæœåŠ¡ç­‰çº§ç›®æ ‡ï¼ˆService Level Objectives, SLOsï¼‰ã€‚

### 1.1. æµ‹è¯•å“²å­¦ï¼šä»å‹åŠ›æµ‹è¯•åˆ°å¯é æ€§éªŒè¯

ä¼ ç»Ÿçš„å‹åŠ›æµ‹è¯•å¾€å¾€ä»¥â€œæ‰¾åˆ°æé™â€ä¸ºç»ˆç‚¹ï¼Œä½†ä¸€ä¸ªæˆç†Ÿçš„å·¥ç¨‹ç»„ç»‡æ›´å…³å¿ƒçš„æ˜¯â€œåœ¨æ‰¿è¯ºçš„èŒƒå›´å†…ï¼Œç³»ç»Ÿæ˜¯å¦ç¨³å®šè¿è¡Œâ€ã€‚SRE çš„æ ¸å¿ƒç†å¿µåœ¨äºï¼Œ100%çš„å¯é æ€§æ—¢ä¸ç°å®ä¹Ÿéç”¨æˆ·çš„çœŸå®éœ€æ±‚ï¼Œå®ƒæˆæœ¬é«˜æ˜‚ä¸”å¯èƒ½é˜»ç¢åˆ›æ–° 1ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¿½æ±‚çš„æ˜¯ä¸€ä¸ªç»è¿‡æ·±æ€ç†Ÿè™‘ã€èƒ½å¤Ÿå¹³è¡¡ç”¨æˆ·æ»¡æ„åº¦ä¸å·¥ç¨‹æˆæœ¬çš„å¯é æ€§ç›®æ ‡ã€‚

æœ¬æ¬¡æµ‹è¯•å°†å›´ç»• SLO è¿›è¡Œï¼Œå®ƒå°†æˆä¸ºè¡¡é‡æµ‹è¯•æˆåŠŸä¸å¦çš„å”¯ä¸€æ ‡å‡†ã€‚æµ‹è¯•è¿‡ç¨‹ä¸­çš„æ¯ä¸€æ¬¡æ€§èƒ½ä¸‹é™æˆ–é”™è¯¯ï¼Œéƒ½å°†è¢«è§†ä¸ºå¯¹â€œé”™è¯¯é¢„ç®—ï¼ˆError Budgetï¼‰â€çš„æ¶ˆè€—ã€‚é”™è¯¯é¢„ç®—æ˜¯`100% - SLO`æ‰€å…è®¸çš„â€œä¸å®Œç¾â€ç©ºé—´ï¼Œå®ƒä¸ºæˆ‘ä»¬è¿›è¡Œæœ‰é£é™©çš„å‘å¸ƒã€ç»´æŠ¤å’Œæ­¤ç±»å‹åŠ›æµ‹è¯•æä¾›äº†é‡åŒ–çš„è®¸å¯ 3ã€‚å¦‚æœæµ‹è¯•è¿‡ç¨‹è€—å°½äº†é¢„è®¾çš„é”™è¯¯é¢„ç®—ï¼Œè¿™ä¾¿æ˜¯ä¸€ä¸ªå¼ºçƒˆçš„ä¿¡å·ï¼Œè¡¨æ˜ç³»ç»Ÿåœ¨å½“å‰è´Ÿè½½ä¸‹çš„å¯é æ€§ä¸è¶³ï¼Œéœ€è¦ä¼˜å…ˆæŠ•å…¥å·¥ç¨‹èµ„æºè¿›è¡ŒåŠ å›ºï¼Œè€Œéç»§ç»­å¼€å‘æ–°åŠŸèƒ½ 3ã€‚

### 1.2. å®šä¹‰æ‚¨çš„æœåŠ¡ç­‰çº§æŒ‡æ ‡ï¼ˆSLIsï¼‰

æœåŠ¡ç­‰çº§æŒ‡æ ‡ï¼ˆService Level Indicator, SLIï¼‰æ˜¯å¯¹æœåŠ¡æŸæ–¹é¢æ€§èƒ½çš„é‡åŒ–åº¦é‡ã€‚å¯¹äºæ‚¨æè¿°çš„å¼‚æ­¥å¤„ç†ç³»ç»Ÿï¼Œæˆ‘ä»¬å¿…é¡»é€‰æ‹©èƒ½å¤ŸçœŸå®åæ˜ ç”¨æˆ·ä½“éªŒçš„ SLIã€‚æ ¹æ® Google SRE çš„æœ€ä½³å®è·µï¼Œé’ˆå¯¹ä¸åŒç±»å‹çš„ç³»ç»Ÿï¼Œæˆ‘ä»¬åº”å…³æ³¨ä¸åŒçš„æŒ‡æ ‡ç»´åº¦ 6ã€‚

- **å¯ç”¨æ€§ SLI (Availability):**
    - **æŒ‡æ ‡å®šä¹‰ï¼š** ç”±`backendService`æˆåŠŸå¤„ç†å¹¶ç¡®è®¤ï¼ˆACKï¼‰çš„æ¶ˆæ¯ï¼Œå å…¶å°è¯•å¤„ç†çš„æ‰€æœ‰æœ‰æ•ˆæ¶ˆæ¯çš„æ¯”ä¾‹ã€‚è¿™æ˜¯è¡¡é‡æ¶ˆè´¹è€…å¤„ç†èƒ½åŠ›çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚
    - **å®ç°æ–¹å¼ï¼š** æ­¤ SLI å¯ä»¥é€šè¿‡ Cloud Monitoring ä¸­çš„ Pub/Sub æŒ‡æ ‡è®¡ç®—å¾—å‡ºã€‚å…¬å¼ä¸ºï¼š`æˆåŠŸå¤„ç†çš„æ¶ˆæ¯æ•° / (æˆåŠŸå¤„ç†çš„æ¶ˆæ¯æ•° + è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°)`ã€‚å…·ä½“æŒ‡æ ‡ä¸º`pubsub.googleapis.com/subscription/ack_message_count`å’Œ`pubsub.googleapis.com/subscription/dead_letter_message_count` 7ã€‚ä¸€ä¸ªé…ç½®äº†æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead-Letter Queue, DLQï¼‰çš„ç³»ç»Ÿï¼Œå…¶æœ€ç»ˆå¤±è´¥çš„æ ‡å¿—å°±æ˜¯æ¶ˆæ¯è¢«é€å…¥ DLQã€‚
- **å»¶è¿Ÿ SLI (Latency):**
    - **æŒ‡æ ‡å®šä¹‰ï¼š** ä» Cloud Scheduler ä½œä¸šè§¦å‘ï¼Œåˆ°æ¶ˆæ¯è¢«`backendService`æœ€ç»ˆæˆåŠŸå¤„ç†çš„ç«¯åˆ°ç«¯ï¼ˆEnd-to-Endï¼‰æ—¶é—´çš„åˆ†å¸ƒã€‚å¯¹äºå¼‚æ­¥ç³»ç»Ÿï¼Œè¿™æ˜¯ä¸€ä¸ªå¤æ‚ä½†è‡³å…³é‡è¦çš„æŒ‡æ ‡ 6ã€‚
    - **å®ç°æ–¹å¼ï¼š** æµ‹é‡ç«¯åˆ°ç«¯å»¶è¿Ÿçš„å”¯ä¸€å¯é æ–¹æ³•æ˜¯ä½¿ç”¨åˆ†å¸ƒå¼è¿½è¸ªï¼ˆDistributed Tracingï¼‰ã€‚æˆ‘ä»¬å°†åœ¨æœåŠ¡ä¸­æ¤å…¥ OpenTelemetryï¼Œå°†åˆ†æ•£åœ¨å„ä¸ªæœåŠ¡ä¸­çš„æ“ä½œï¼ˆspanï¼‰å…³è”åˆ°åŒä¸€ä¸ªè¿½è¸ªï¼ˆtraceï¼‰ä¸Šã€‚æˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨å»¶è¿Ÿçš„ P95ï¼ˆ95th percentileï¼‰å’Œ P99 åˆ†ä½å€¼ï¼Œå› ä¸ºå®ƒä»¬æ¯”å¹³å‡å€¼æ›´èƒ½ä»£è¡¨ç»å¤§å¤šæ•°ç”¨æˆ·çš„çœŸå®ä½“éªŒ 10ã€‚
- **æ–°é²œåº¦ SLI (Freshness):**
    - **æŒ‡æ ‡å®šä¹‰ï¼š** Pub/Sub è®¢é˜…ä¸­ï¼Œæœ€æ—§çš„æœªç¡®è®¤ï¼ˆunackedï¼‰æ¶ˆæ¯çš„å¹´é¾„ã€‚è¯¥æŒ‡æ ‡ç›´æ¥åæ˜ äº†æ•°æ®å¤„ç†ç®¡é“çš„å¥åº·çŠ¶å†µå’Œç§¯å‹ç¨‹åº¦ï¼Œæ˜¯å¼‚æ­¥ç³»ç»Ÿç›‘æ§çš„å…³é”® 11ã€‚
    - **å®ç°æ–¹å¼ï¼š** ç›´æ¥ä½¿ç”¨ Cloud Monitoring ä¸­çš„`pubsub.googleapis.com/subscription/oldest_unacked_message_age`æŒ‡æ ‡è¿›è¡Œæµ‹é‡ 12ã€‚

### 1.3. è®¾å®šå¯è¡ŒåŠ¨çš„æœåŠ¡ç­‰çº§ç›®æ ‡ï¼ˆSLOsï¼‰

åŸºäºä¸Šè¿° SLIï¼Œæˆ‘ä»¬éœ€è¦è®¾å®šæ˜ç¡®ã€å¯é‡åŒ–çš„ SLOã€‚è¿™äº›ç›®æ ‡åº”ä¸ä¸šåŠ¡éœ€æ±‚ç´§å¯†ç›¸è¿ï¼Œå®ƒä»¬æ˜¯æœ¬æ¬¡å‹åŠ›æµ‹è¯•çš„â€œè€ƒè¯•å¤§çº²â€ã€‚ä»¥ä¸‹ä¸ºå»ºè®®çš„åˆå§‹ SLOï¼Œæ‚¨åº”æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯è¿›è¡Œè°ƒæ•´ã€‚

- **å¯ç”¨æ€§ SLOï¼š** åœ¨ 30 åˆ†é’Ÿçš„æµ‹è¯•çª—å£å†…ï¼Œ`backendService`çš„**æ¶ˆæ¯å¤„ç†æˆåŠŸç‡ > 99.9%**ã€‚
- **å»¶è¿Ÿ SLOï¼š** åœ¨æµ‹è¯•æœŸé—´ï¼Œ**95%çš„ç«¯åˆ°ç«¯å¤„ç†å»¶è¿Ÿ < 800 æ¯«ç§’**ã€‚
- **æ–°é²œåº¦ SLOï¼š** åœ¨æµ‹è¯•æœŸé—´ï¼Œ**P99 çš„æœ€æ—§æœªç¡®è®¤æ¶ˆæ¯å¹´é¾„ < 60 ç§’**ã€‚

è®¾å®šè¿™äº›æ•°å­—çš„è¿‡ç¨‹ï¼Œæœ¬èº«å°±æ˜¯ä¸€æ¬¡é‡è¦çš„æŠ€æœ¯ä¸ä¸šåŠ¡å¯¹é½ã€‚ä¸€ä¸ªæ‰¹å¤„ç†åˆ†æä»»åŠ¡å¯èƒ½å®¹å¿å‡ åˆ†é’Ÿçš„å»¶è¿Ÿï¼Œä½†ä¸€ä¸ªå®æ—¶äº¤æ˜“ç³»ç»Ÿåˆ™ä¸èƒ½ã€‚è¿™äº› SLO å°†æµ‹è¯•ä»ä¸€ä¸ªæ¨¡ç³Šçš„æ¢ç´¢æ€§æ´»åŠ¨ï¼Œè½¬å˜ä¸ºä¸€æ¬¡æœ‰æ˜ç¡®æˆåŠŸæˆ–å¤±è´¥æ ‡å‡†çš„ç§‘å­¦å®éªŒ 3ã€‚

### 1.4. é”™è¯¯é¢„ç®—ï¼šåˆ›æ–°çš„é€šè¡Œè¯

é”™è¯¯é¢„ç®—æ˜¯ SLO çš„å¿…ç„¶äº§ç‰©ï¼Œå®ƒé‡åŒ–äº†æˆ‘ä»¬å¯ä»¥æ‰¿æ‹…çš„â€œé£é™©â€ã€‚ä¾‹å¦‚ï¼Œ99.9%çš„å¯ç”¨æ€§ SLO æ„å‘³ç€æˆ‘ä»¬æœ‰ 0.1%çš„é”™è¯¯é¢„ç®— 4ã€‚æœ¬æ¬¡å‹åŠ›æµ‹è¯•å¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€æ¬¡åœ¨å—æ§ç¯å¢ƒä¸­ä¸»åŠ¨â€œèŠ±è´¹â€é”™è¯¯é¢„ç®—çš„æ´»åŠ¨ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†è´­ä¹°â€œä¿¡å¿ƒâ€ã€‚

å¦‚æœåœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æ¶ˆè€—çš„é¢„ç®—è¶…å‡ºäº†é™é¢ï¼ˆä¾‹å¦‚ï¼Œè¶…è¿‡ 0.1%çš„æ¶ˆæ¯è¿›å…¥äº† DLQï¼‰ï¼Œé‚£ä¹ˆæµ‹è¯•å°±å‘å‡ºäº†ä¸€ä¸ªæ˜ç¡®çš„ã€ä¸å®¹å¿½è§†çš„ä¿¡å·ï¼šå½“å‰ç³»ç»Ÿæ— æ³•åœ¨ç›®æ ‡è´Ÿè½½ä¸‹æ»¡è¶³å…¶å¯é æ€§æ‰¿è¯ºã€‚æ­¤æ—¶ï¼Œå·¥ç¨‹å›¢é˜Ÿçš„æœ€é«˜ä¼˜å…ˆçº§åº”è¯¥æ˜¯ä¿®å¤å¯é æ€§é—®é¢˜ï¼Œè€Œä¸æ˜¯ç»§ç»­æ¨è¿›æ–°åŠŸèƒ½çš„å¼€å‘ 4ã€‚

**è¡¨ 1ï¼šæœåŠ¡ç­‰çº§ç›®æ ‡ä¸é”™è¯¯é¢„ç®—å®šä¹‰**

| ç”¨æˆ·æ—…ç¨‹ (User Journey) | SLI              | SLI å®ç° (Cloud Monitoring æŒ‡æ ‡/æŸ¥è¯¢)                                   | SLO ç›®æ ‡  | 30 å¤©é”™è¯¯é¢„ç®— (ç¤ºä¾‹)    |
| ----------------------- | ---------------- | ----------------------------------------------------------------------- | --------- | ----------------------- |
| å¼‚æ­¥ä»»åŠ¡å¤„ç†            | å¯ç”¨æ€§           | `(ack_message_count) / (ack_message_count + dead_letter_message_count)` | `> 99.9%` | `~43.2 åˆ†é’Ÿ` çš„ä¸å¯ç”¨   |
| å¼‚æ­¥ä»»åŠ¡å¤„ç†            | ç«¯åˆ°ç«¯å»¶è¿Ÿ (P95) | Cloud Trace åˆ†å¸ƒå¼è¿½è¸ªæ•°æ®                                              | `< 800ms` | `~36 å°æ—¶` çš„è¶…æ ‡æ—¶é—´   |
| å¼‚æ­¥ä»»åŠ¡å¤„ç†            | æ–°é²œåº¦ (P99)     | `pubsub.googleapis.com/subscription/oldest_unacked_message_age`         | `< 60s`   | `~21.6 åˆ†é’Ÿ` çš„ç§¯å‹è¶…æ ‡ |

## ç¬¬ 2 éƒ¨åˆ†ï¼šé£è¡Œå‰æ£€æŸ¥ï¼šç¯å¢ƒåŠ å›ºä¸å‡†å¤‡

åœ¨æ–½åŠ ä»»ä½•è´Ÿè½½ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿æµ‹è¯•ç¯å¢ƒæœ¬èº«æ˜¯ç¨³å›ºçš„ï¼Œå¹¶ä¸”ä¸å—å¤–éƒ¨å› ç´ ï¼ˆå¦‚å¹³å°é…é¢ï¼‰çš„äººä¸ºé™åˆ¶ã€‚ä¸€æ¬¡æˆåŠŸçš„å‹åŠ›æµ‹è¯•ï¼Œå…¶å¤±è´¥åŸå› åº”å½“æ˜¯ç³»ç»Ÿå†…åœ¨çš„ç“¶é¢ˆï¼Œè€Œéå‡†å¤‡å·¥ä½œçš„ç–å¿½ã€‚

### 2.1. GCP é…é¢ä¸é™åˆ¶åˆ†æ

åœ¨æµ‹è¯•æœŸé—´æ„å¤–è§¦åŠ GCP çš„é…é¢é™åˆ¶ï¼Œä¼šä½¿æµ‹è¯•ç»“æœå¤±æ•ˆï¼Œå› ä¸ºå®ƒå¼•å…¥äº†ä¸€ä¸ªä¸åº”ç”¨æœ¬èº«æ— å…³çš„äººä¸ºç“¶é¢ˆ 17ã€‚å› æ­¤ï¼Œè¿›è¡Œä¸€æ¬¡å½»åº•çš„é…é¢é¢„æ£€è‡³å…³é‡è¦ã€‚æ‚¨å¯ä»¥é€šè¿‡ GCP æ§åˆ¶å°çš„

`IAM & Admin > Quotas`é¡µé¢æˆ–ä½¿ç”¨`gcloud`å‘½ä»¤è¡Œå·¥å…·æ¥æ£€æŸ¥å’Œç”³è¯·æå‡é…é¢ 18ã€‚

ä»¥ä¸‹æ˜¯æœ¬æ¬¡æµ‹è¯•éœ€è¦é‡ç‚¹å…³æ³¨çš„é…é¢é¡¹ï¼š

- **Cloud Scheduler:**
    - æ¯ä¸ªé¡¹ç›®çš„ä½œä¸šæ•°é‡ï¼ˆJobs per projectï¼‰
    - æ¯ä¸ªé¡¹ç›®çš„ API è°ƒç”¨é¢‘ç‡ï¼ˆAPI requests per minuteï¼‰
- **Cloud Pub/Sub:**
    - æ¯ä¸ªåŒºåŸŸçš„å‘å¸ƒè€…ååé‡ï¼ˆPublisher throughput per regionï¼‰
    - æ¯ä¸ªåŒºåŸŸçš„è®¢é˜…è€…ååé‡ï¼ˆSubscriber throughput per regionï¼‰
    - è¯·æ³¨æ„ï¼Œååé‡é…é¢å› åŒºåŸŸå¤§å°è€Œå¼‚ã€‚ä¾‹å¦‚ï¼Œ`us-central1`æ˜¯ä¸€ä¸ªâ€œå¤§å‹â€åŒºåŸŸï¼Œæ‹¥æœ‰æ›´é«˜çš„é»˜è®¤é…é¢ 20ã€‚
- **Google Kubernetes Engine (GKE) / Compute Engine:**
    - æ¯ä¸ªåŒºåŸŸçš„ CPU æ ¸å¿ƒæ•°ï¼ˆCPUs per regionï¼‰
    - æ¯ä¸ªåŒºåŸŸçš„æŒä¹…åŒ–ç£ç›˜æ€»å¤§å°ï¼ˆPersistent Disk total GB per regionï¼‰
    - è¿™äº›é…é¢å¯¹äºç¡®ä¿ HPAï¼ˆHorizontal Pod Autoscalerï¼‰å’Œé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©å™¨ï¼ˆCluster Autoscalerï¼‰èƒ½å¤ŸæˆåŠŸæ·»åŠ èŠ‚ç‚¹è‡³å…³é‡è¦ 21ã€‚
- **Cloud Monitoring:**
    - API å†™å…¥é…é¢ï¼ˆAPI Ingestion limitsï¼‰ï¼Œæˆ‘ä»¬è¯¦å°½çš„ç›‘æ§è®¾ç½®å¯èƒ½ä¼šäº§ç”Ÿå¤§é‡æŒ‡æ ‡æ•°æ®ã€‚

ä¸ºäº†ç¡®ä¿å‡†å¤‡å·¥ä½œçš„ä¸¥è°¨æ€§ï¼Œæˆ‘ä»¬æä¾›ä»¥ä¸‹æ¸…å•ä¾›æ‚¨åœ¨æµ‹è¯•å‰é€é¡¹æ ¸å¯¹ã€‚

**è¡¨ 2ï¼šGCP é…é¢é£è¡Œå‰æ£€æŸ¥æ¸…å•**

| æœåŠ¡ (Service)   | é…é¢åç§° (Quota Name)                         | é»˜è®¤é™åˆ¶ (Default Limit) | é¡¹ç›®å½“å‰ç”¨é‡ | æµ‹è¯•æ‰€éœ€é¢„ä¼°                 | æ˜¯å¦å·²ç”³è¯·æå‡ï¼Ÿ (Y/N) |
| ---------------- | --------------------------------------------- | ------------------------ | ------------ | ---------------------------- | ---------------------- |
| Cloud Scheduler  | Jobs per project                              | 5,000                    |              | ~500                         |                        |
| Cloud Pub/Sub    | Publisher throughput per large region         | 4 GB/s 20                |              | (æ ¹æ®è´Ÿè½½æ¨¡å‹ä¼°ç®—)           |                        |
| Cloud Pub/Sub    | Push subscriber throughput per large region   | 440 MB/s 20              |              | (æ ¹æ®è´Ÿè½½æ¨¡å‹ä¼°ç®—)           |                        |
| Compute Engine   | CPUs per region (e.g., us-central1)           | (å› é¡¹ç›®è€Œå¼‚)             |              | (æ ¹æ® HPA `maxReplicas`ä¼°ç®—) |                        |
| Cloud Monitoring | Time series ingestion API requests per minute | 60,000                   |              | (æ ¹æ®ç›‘æ§ç‚¹ä¼°ç®—)             |                        |

### 2.2. å®‰å…¨çš„æœåŠ¡èº«ä»½ï¼šå®æ–½ Workload Identity

ä¸ºäº†è®© GKE ä¸­è¿è¡Œçš„æœåŠ¡èƒ½å¤Ÿå®‰å…¨åœ°è°ƒç”¨ GCP APIï¼ˆå¦‚ Pub/Subï¼‰ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºå…¶é…ç½®èº«ä»½ã€‚å¼ºçƒˆå»ºè®®**é¿å…ä½¿ç”¨å¯¼å‡ºçš„æœåŠ¡è´¦å·å¯†é’¥ï¼ˆJSON key filesï¼‰**ï¼Œå› ä¸ºå®ƒä»¬æ˜¯é™æ€å‡­è¯ï¼Œä¸€æ—¦æ³„éœ²å°†æ„æˆä¸¥é‡çš„å®‰å…¨é£é™© 22ã€‚

Google æ¨èçš„æœ€ä½³å®è·µæ˜¯ä½¿ç”¨**GKE Workload Identity**ã€‚å®ƒå…è®¸æ‚¨å°† Kubernetes æœåŠ¡è´¦å·ï¼ˆKSAï¼‰ä¸ Google æœåŠ¡è´¦å·ï¼ˆGSAï¼‰è¿›è¡Œç»‘å®šï¼Œä½¿å¾— Pod èƒ½å¤Ÿä»¥ GSA çš„èº«ä»½å®‰å…¨åœ°è°ƒç”¨ GCP APIï¼Œæ— éœ€ç®¡ç†ä»»ä½•å¯†é’¥ 23ã€‚è¿™ç§æ–¹å¼ä¸ä»…æå¤§åœ°æå‡äº†å®‰å…¨æ€§ï¼Œä¹Ÿä½¿å¾—æƒé™ç®¡ç†å’Œå®¡è®¡æ›´ä¸ºç²¾ç»†ï¼Œå®Œå…¨ç¬¦åˆç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ 25ã€‚

ä»¥ä¸‹æ˜¯é…ç½® Workload Identity çš„è¯¦ç»†æ­¥éª¤ï¼š

1. **åœ¨ GKE é›†ç¾¤ä¸Šå¯ç”¨ Workload Identityï¼š**

    Bash

    ```
    gcloud container jiquns update CLUSTER_NAME \
        --workload-pool=PROJECT_ID.svc.id.goog
    ```

2. **ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸“ç”¨çš„ Google æœåŠ¡è´¦å·ï¼ˆGSAï¼‰ï¼š** éµå¾ªæœ€å°æƒé™åŸåˆ™ï¼Œä¸ºæ‚¨çš„â€œSchedule Serviceâ€å’Œ`backendService`åˆ†åˆ«åˆ›å»º GSA 26ã€‚

    Bash

    ```
    # GSA for the publisher service
    gcloud iam service-accounts create schedule-service-gsa --display-name="GSA for Schedule Service"
    # GSA for the consumer service
    gcloud iam service-accounts create backend-service-gsa --display-name="GSA for Backend Service"
    ```

3. **æˆäºˆå¿…è¦çš„ IAM è§’è‰²ï¼š**

    Bash

    ```
    # Grant publisher role to the schedule-service-gsa
    gcloud projects add-iam-policy-binding PROJECT_ID \
        --member="serviceAccount:schedule-service-gsa@PROJECT_ID.iam.gserviceaccount.com" \
        --role="roles/pubsub.publisher"

    # Grant subscriber role to the backend-service-gsa
    gcloud projects add-iam-policy-binding PROJECT_ID \
        --member="serviceAccount:backend-service-gsa@PROJECT_ID.iam.gserviceaccount.com" \
        --role="roles/pubsub.subscriber"
    ```

4. **åœ¨ GKE ä¸­åˆ›å»ºå¯¹åº”çš„ Kubernetes æœåŠ¡è´¦å·ï¼ˆKSAï¼‰ï¼š**

    YAML

    ```
    # ksa.yaml
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: schedule-service-ksa
      namespace: YOUR_NAMESPACE
    ---
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: backend-service-ksa
      namespace: YOUR_NAMESPACE
    ```

    Bash

    ```
    kubectl apply -f ksa.yaml
    ```

5. **å°† GSA ä¸ KSA è¿›è¡Œç»‘å®šï¼š** è¿™ä¸€æ­¥æ˜¯ Workload Identity çš„æ ¸å¿ƒï¼Œå®ƒæˆäºˆ KSA æ¨¡æ‹Ÿ GSA çš„æƒé™ 24ã€‚

    Bash

    ```
    # Bind for publisher
    gcloud iam service-accounts add-iam-policy-binding schedule-service-gsa@PROJECT_ID.iam.gserviceaccount.com \
        --role roles/iam.workloadIdentityUser \
        --member "serviceAccount:PROJECT_ID.svc.id.goog"

    # Bind for consumer
    gcloud iam service-accounts add-iam-policy-binding backend-service-gsa@PROJECT_ID.iam.gserviceaccount.com \
        --role roles/iam.workloadIdentityUser \
        --member "serviceAccount:PROJECT_ID.svc.id.goog"
    ```

6. **ä¸º KSA æ·»åŠ æ³¨è§£å¹¶æ›´æ–° Deploymentï¼š**

    Bash

    ```
    # Annotate KSA for publisher
    kubectl annotate serviceaccount schedule-service-ksa \
        --namespace YOUR_NAMESPACE \
        iam.gke.io/gcp-service-account=schedule-service-gsa@PROJECT_ID.iam.gserviceaccount.com

    # Annotate KSA for consumer
    kubectl annotate serviceaccount backend-service-ksa \
        --namespace YOUR_NAMESPACE \
        iam.gke.io/gcp-service-account=backend-service-gsa@PROJECT_ID.iam.gserviceaccount.com
    ```

    æœ€åï¼Œæ›´æ–°æ‚¨çš„ GKE Deployment YAML æ–‡ä»¶ï¼Œåœ¨`spec.template.spec`ä¸‹æŒ‡å®š`serviceAccountName`ä¸ºæ‚¨åˆ›å»ºçš„ KSA åç§°ã€‚

### 2.3. ä¸ºå¤±è´¥è€Œè®¾è®¡ï¼šPub/Sub å¼¹æ€§é…ç½®

å‹åŠ›æµ‹è¯•çš„ç›®çš„ä¹‹ä¸€å°±æ˜¯éªŒè¯ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›ã€‚æˆ‘ä»¬éœ€è¦åœ¨æµ‹è¯•å‰ï¼Œå¯¹ Pub/Sub è®¢é˜…è¿›è¡Œåˆç†çš„å¼¹æ€§é…ç½®ï¼Œä»¥ç¡®ä¿å®ƒåœ¨æ¶ˆè´¹è€…ï¼ˆ`backendService`ï¼‰å‡ºç°æ•…éšœæˆ–è¿‡è½½æ—¶ï¼Œèƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯é€ æˆæ•°æ®ä¸¢å¤±æˆ–â€œé‡è¯•é£æš´â€ã€‚

- æ­»ä¿¡ä¸»é¢˜ï¼ˆDLQï¼‰é…ç½®ï¼š
    DLQ æ˜¯å¤„ç†â€œæ¯’ä¸¸æ¶ˆæ¯â€ï¼ˆæ— æ³•è¢«æ¶ˆè´¹è€…æˆåŠŸå¤„ç†çš„æ¶ˆæ¯ï¼‰æˆ–åœ¨æ¶ˆè´¹è€…é•¿æ—¶é—´å®•æœºåï¼Œæ¶ˆæ¯è¾¾åˆ°é‡è¯•ä¸Šé™æ—¶çš„æœ€åä¿éšœã€‚å®ƒæ˜¯æˆ‘ä»¬å¯ç”¨æ€§ SLI çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚
    1. **åˆ›å»º DLQ ä¸»é¢˜ï¼š**

        Bash

        ```
        gcloud pubsub topics create your-dlq-topic
        ```

    2. **ä¸º DLQ ä¸»é¢˜åˆ›å»ºè®¢é˜…ï¼š** è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå®ƒç¡®ä¿äº†è¿›å…¥ DLQ çš„æ¶ˆæ¯èƒ½è¢«ä¿ç•™ä¸‹æ¥ä»¥ä¾›åç»­åˆ†æï¼Œå¦åˆ™æ¶ˆæ¯ä¼šä¸¢å¤± 28ã€‚

        Bash

        ```
        gcloud pubsub subscriptions create your-dlq-subscription \
            --topic=your-dlq-topic \
            --message-retention-duration=7d
        ```

    3. **æ›´æ–°ä¸»è®¢é˜…ï¼Œå…³è” DLQï¼š** è®¾ç½®`--dead-letter-topic`å’Œ`--max-delivery-attempts`ã€‚`max-delivery-attempts`ï¼ˆ5 åˆ° 100 ä¹‹é—´ï¼‰å®šä¹‰äº†åœ¨æ¶ˆæ¯è¢«å‘é€åˆ° DLQ ä¹‹å‰ï¼ŒPub/Sub å°†å°è¯•æŠ•é€’çš„æœ€å¤§æ¬¡æ•° 28ã€‚

        Bash

        ```
        gcloud pubsub subscriptions update your-main-subscription \
            --dead-letter-topic=your-dlq-topic \
            --max-delivery-attempts=5
        ```

    4. **ä¸º Pub/Sub æœåŠ¡è´¦å·æˆæƒï¼š** è¿™æ˜¯æœ€å®¹æ˜“è¢«å¿½ç•¥ä½†å´è‡³å…³é‡è¦çš„ä¸€æ­¥ã€‚å°†æ¶ˆæ¯ä»ä¸»è®¢é˜…è½¬å‘åˆ° DLQ ä¸»é¢˜çš„æ“ä½œï¼Œæ˜¯ç”±ä¸€ä¸ª Google ç®¡ç†çš„ç‰¹æ®ŠæœåŠ¡è´¦å·æ‰§è¡Œçš„ã€‚æˆ‘ä»¬å¿…é¡»æˆäºˆè¿™ä¸ªè´¦å·åœ¨ DLQ ä¸»é¢˜ä¸Šçš„å‘å¸ƒæƒé™ 29ã€‚

        Bash

        ```
        # First, get your project number
        PROJECT_NUMBER=$(gcloud projects describe PROJECT_ID --format='value(projectNumber)')

        # Grant the publisher role to the Pub/Sub service account
        gcloud pubsub topics add-iam-policy-binding your-dlq-topic \
            --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-pubsub.iam.gserviceaccount.com" \
            --role="roles/pubsub.publisher"
        ```
- é‡è¯•ç­–ç•¥é…ç½®ï¼š
    åœ¨é«˜ååé‡åœºæ™¯ä¸‹ï¼Œå¦‚æœ backendService æš‚æ—¶è¿‡è½½å¹¶å¼€å§‹æ‹’ç»ï¼ˆNACKï¼‰æ¶ˆæ¯ï¼Œé»˜è®¤çš„â€œç«‹å³é‡è¯•â€ç­–ç•¥ä¼šç«‹åˆ»å°†æ¶ˆæ¯é‡æ–°æŠ•é€’ï¼Œè¿™å¯èƒ½åŠ å‰§æ¶ˆè´¹è€…çš„è´Ÿè½½ï¼Œå½¢æˆâ€œé‡è¯•é£æš´â€ã€‚æ›´ç¨³å¥çš„ç­–ç•¥æ˜¯é‡‡ç”¨æŒ‡æ•°é€€é¿ï¼ˆExponential Backoffï¼‰ 28ã€‚è¿™ä¼šåœ¨æ¯æ¬¡é‡è¯•ä¹‹é—´å¼•å…¥é€æ¸å¢é•¿çš„å»¶è¿Ÿï¼Œç»™ä¸‹æ¸¸æœåŠ¡å–˜æ¯å’Œæ¢å¤çš„æ—¶é—´ã€‚
    Bash
    ```
    gcloud pubsub subscriptions update your-main-subscription \
        --min-retry-delay=10s \
        --max-retry-delay=600s
    ```
    è¿™ä¸ªé…ç½®å°†ä½¿å¾—é¦–æ¬¡é‡è¯•å»¶è¿Ÿè‡³å°‘ 10 ç§’ï¼Œåç»­çš„å»¶è¿Ÿä¼šä»¥æŒ‡æ•°çº§å¢é•¿ï¼Œç›´åˆ°æœ€å¤§ 600 ç§’çš„ä¸Šé™ã€‚å‹åŠ›æµ‹è¯•å°†éªŒè¯è¿™ä¸€æœºåˆ¶ä¸ HPA çš„åŠ¨æ€äº¤äº’æ•ˆæœã€‚

### 2.4. GKE å·¥ä½œè´Ÿè½½é…ç½®å®¡æŸ¥

æœ€åï¼Œæˆ‘ä»¬éœ€è¦å®¡æŸ¥ GKE ä¸Šä¸¤ä¸ªæœåŠ¡çš„ Deployment é…ç½®ï¼Œç¡®ä¿å®ƒä»¬ä¸ºå‹åŠ›æµ‹è¯•åšå¥½äº†å‡†å¤‡ã€‚

- **èµ„æºè¯·æ±‚ï¼ˆRequestsï¼‰ä¸é™åˆ¶ï¼ˆLimitsï¼‰ï¼š**
    - ç¡®ä¿`backendService`çš„ Deployment YAML ä¸­ä¸ºå®¹å™¨è®¾ç½®äº†åˆç†çš„ CPU å’Œå†…å­˜`requests`ä¸`limits`ã€‚`requests`æ˜¯ Kubernetes è°ƒåº¦å™¨åˆ†é…èµ„æºçš„ä¾æ®ï¼Œè€Œ`limits`åˆ™é˜²æ­¢å•ä¸ª Pod è€—å°½èŠ‚ç‚¹èµ„æºã€‚
    - åœ¨å‹åŠ›æµ‹è¯•ä¸­ï¼Œä¸ºäº†æ‰¾åˆ°æœåŠ¡çš„çœŸå®æ€§èƒ½ä¸Šé™ï¼Œå¯ä»¥å°†`limits`è®¾ç½®å¾—ç›¸å¯¹å®½æ¾ï¼Œå…è®¸ Pod å……åˆ†åˆ©ç”¨èŠ‚ç‚¹çš„èµ„æºã€‚ä½†`requests`å¿…é¡»è®¾ç½®ï¼Œä»¥ä¿è¯ Pod èƒ½å¤Ÿè¢«è°ƒåº¦åˆ°æœ‰è¶³å¤Ÿèµ„æºçš„èŠ‚ç‚¹ä¸Šã€‚
- **æ°´å¹³ Pod è‡ªåŠ¨ä¼¸ç¼©å™¨ï¼ˆHPAï¼‰é…ç½®ï¼š**
    - è®°å½•ä¸‹`backendService`å½“å‰ HPA çš„é…ç½®ï¼š`minReplicas`ã€`maxReplicas`ä»¥åŠç›®æ ‡æŒ‡æ ‡ï¼ˆä¾‹å¦‚ï¼Œ`targetCPUUtilizationPercentage: 80`ï¼‰ã€‚è¿™ä¸ªåŸºçº¿æ˜¯åç»­åˆ†æå’Œä¼˜åŒ–çš„åŸºç¡€ 32ã€‚åœ¨ç¬¬ 6 éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•åŸºäºæ›´åˆé€‚çš„æŒ‡æ ‡æ¥ä¼˜åŒ–è¿™ä¸ª HPAã€‚

## ç¬¬ 3 éƒ¨åˆ†ï¼šç¼–æ’è´Ÿè½½ï¼šJMeter ä¸ gcloud çš„ååŒåº”ç”¨

æœ¬èŠ‚å°†è¯¦ç»†é˜è¿°å¦‚ä½•ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„ JMeter å·¥å…·ï¼Œç»“åˆ`gcloud`å‘½ä»¤è¡Œï¼Œæ¥ç²¾ç¡®åœ°ç”Ÿæˆå’Œæ§åˆ¶æµ‹è¯•è´Ÿè½½ã€‚æˆ‘ä»¬å°†é‡‡ç”¨ä¸€ç§å·§å¦™çš„è®¾è®¡ï¼Œä»¥é€‚åº”ç³»ç»Ÿçš„å¼‚æ­¥ç‰¹æ€§ã€‚

### 3.1. è‡ªåŠ¨åŒ–æµ‹è¯•è£…ç½®ç”Ÿæˆï¼šæ‰¹é‡åˆ›å»º Scheduler ä½œä¸š

æ‰‹åŠ¨åˆ›å»ºæ•°ç™¾ä¸ª Cloud Scheduler ä½œä¸šæ˜¯ä¸å¯è¡Œçš„ã€‚æˆ‘ä»¬å¿…é¡»é€šè¿‡è„šæœ¬è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ã€‚ä»¥ä¸‹`bash`è„šæœ¬åˆ©ç”¨`gcloud`å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸ä»…èƒ½æ‰¹é‡åˆ›å»ºä½œä¸šï¼Œè¿˜èƒ½é€šè¿‡ç²¾å·§çš„è°ƒåº¦è®¾è®¡ï¼Œç”Ÿæˆå¹³æ»‘ä¸”æŒç»­çš„è´Ÿè½½ã€‚

Bash

```
#!/bin/bash

# Configuration
PROJECT_ID="your-gcp-project-id"
LOCATION="your-gcp-region" # e.g., us-central1
TARGET_PUBSUB_TOPIC="your-schedule-service-topic"
NUM_JOBS=200 # Number of scheduler jobs to create
JOBS_PER_MINUTE=600 # Desired total triggers per minute

# Calculate the interval for staggering jobs
# We use modulo arithmetic to spread jobs across 60 seconds.
# For example, with 200 jobs, we can have multiple jobs firing each second.
# Let's aim for a high frequency, e.g., 10 triggers per second.

echo "--- Preparing to create ${NUM_JOBS} Cloud Scheduler jobs ---"
echo "Target Topic: ${TARGET_PUBSUB_TOPIC}"
echo "Location: ${LOCATION}"

# Create a file to store job names for JMeter
JOB_NAMES_FILE="scheduler_job_names.csv"
echo "job_name" > ${JOB_NAMES_FILE}

for i in $(seq 1 ${NUM_JOBS}); do
  JOB_NAME="stress-test-job-$(printf "%03d" ${i})"

  # Stagger the schedule across each minute to create a smooth load
  # This cron expression will run the job at a specific second within every minute.
  # e.g., for i=1, second=1; for i=61, second=1 again.
  SECOND=$(( (i-1) % 60 ))
  SCHEDULE="${SECOND} * * * *"

  # Unique message body for tracing
  MESSAGE_BODY="{\"job_name\":\"${JOB_NAME}\", \"timestamp\":\"\$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"

  echo "Creating job: ${JOB_NAME} with schedule: '${SCHEDULE}'"

  gcloud scheduler jobs create pubsub ${JOB_NAME} \
    --project=${PROJECT_ID} \
    --location=${LOCATION} \
    --schedule="${SCHEDULE}" \
    --topic=${TARGET_PUBSUB_TOPIC} \
    --message-body="${MESSAGE_BODY}" \
    --time-zone="Etc/UTC"

  # Check for command success
  if [ $? -eq 0 ]; then
    echo "${JOB_NAME}" >> ${JOB_NAMES_FILE}
    echo "Successfully created ${JOB_NAME}"
  else
    echo "!!! Failed to create ${JOB_NAME}. Exiting."
    exit 1
  fi

  # Sleep briefly to avoid hitting API rate limits for job creation
  sleep 0.5
done

echo "--- Finished creating ${NUM_JOBS} jobs. ---"
echo "Job names saved to ${JOB_NAMES_FILE} for use with JMeter."

# Script to delete all created jobs after the test
echo "To delete these jobs later, run the following command:"
echo "for job in \$(cat ${JOB_NAMES_FILE} | tail -n +2); do gcloud scheduler jobs delete \$job --location=${LOCATION} --quiet; done"
```

è¿™ä¸ªè„šæœ¬çš„æ ¸å¿ƒæ€æƒ³åœ¨äºè°ƒåº¦ (`--schedule`) çš„è®¾è®¡ã€‚ä¸€ä¸ªå¹¼ç¨šçš„å®ç°å¯èƒ½ä¼šä¸ºæ‰€æœ‰ä½œä¸šè®¾ç½®`* * * * *`ï¼Œè¿™å°†å¯¼è‡´æ¯åˆ†é’Ÿå¼€å§‹æ—¶äº§ç”Ÿä¸€ä¸ªå·¨å¤§çš„è´Ÿè½½å°–å³°ï¼Œéšåæ˜¯ 59 ç§’çš„ç©ºé—²ï¼Œè¿™å¹¶ä¸èƒ½æœ‰æ•ˆåœ°æµ‹è¯•ç³»ç»Ÿçš„æŒç»­å¤„ç†èƒ½åŠ› 34ã€‚æˆ‘ä»¬çš„è„šæœ¬é€šè¿‡

`SECOND=$(( (i-1) % 60 ))`å°†ä½œä¸šå‡åŒ€åœ°åˆ†å¸ƒåœ¨æ¯ä¸€åˆ†é’Ÿçš„ 60 ç§’å†…ï¼Œä»è€Œäº§ç”Ÿä¸€ä¸ªæ›´åŠ å¹³æ»‘ã€æŒç»­çš„é«˜é¢‘è¯·æ±‚æµï¼Œè¿™æ˜¯ä¸€ç§æ›´é«˜çº§ã€æ›´çœŸå®çš„è´Ÿè½½æ¨¡å¼ã€‚

### 3.2. JMeter æµ‹è¯•è®¡åˆ’ï¼šé©±åŠ¨è´Ÿè½½å¼•æ“

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è§£å†³æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•ä½¿ç”¨ JMeter è¿™ä¸ªä¸ºåŒæ­¥è¯·æ±‚-å“åº”æ¨¡å‹è®¾è®¡çš„å·¥å…·ï¼Œæ¥é©±åŠ¨ä¸€ä¸ªå¼‚æ­¥å·¥ä½œæµã€‚

**è§£å†³æ–¹æ¡ˆï¼š** JMeter ä¸ç›´æ¥è°ƒç”¨`backendService`ï¼Œå› ä¸ºé‚£å°†æ— æ³•è·å¾—æœ‰æ„ä¹‰çš„å“åº”æ—¶é—´ã€‚ç›¸åï¼ŒJMeter å°†æ‰®æ¼”ä¸€ä¸ª**æŒ‡æŒ¥å®˜**çš„è§’è‰²ï¼Œé€šè¿‡è°ƒç”¨`gcloud`å‘½ä»¤æ¥**æŒ‰éœ€è§¦å‘**å·²ç»åˆ›å»ºå¥½çš„ Cloud Scheduler ä½œä¸šã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½åˆ©ç”¨ JMeter å¼ºå¤§çš„å¹¶å‘æ§åˆ¶å’Œè´Ÿè½½å‰–é¢ç®¡ç†èƒ½åŠ›ï¼ŒåŒæ—¶å®Œå…¨å°Šé‡ç›®æ ‡ç³»ç»Ÿçš„äº‹ä»¶é©±åŠ¨æ¶æ„ã€‚

ä»¥ä¸‹æ˜¯ JMeter æµ‹è¯•è®¡åˆ’çš„å…³é”®ç»„ä»¶ï¼š

1. **çº¿ç¨‹ç»„ (Thread Group):** æˆ‘ä»¬å°†ä½¿ç”¨ **jp@gc - Stepping Thread Group** æ’ä»¶ã€‚ä¸æ ‡å‡†çš„çº¿ç¨‹ç»„ç›¸æ¯”ï¼Œå®ƒèƒ½è®©æˆ‘ä»¬æ›´ç²¾ç»†åœ°æ§åˆ¶è´Ÿè½½çš„çˆ¬å‡ã€æŒç»­å’Œä¸‹é™è¿‡ç¨‹ï¼Œéå¸¸é€‚åˆè¿›è¡Œä¸¥è°¨çš„å‹åŠ›æµ‹è¯• 35ã€‚
2. **CSV æ•°æ®æ–‡ä»¶è®¾ç½® (CSV Data Set Config):** æ­¤ç»„ä»¶å°†è¯»å–æˆ‘ä»¬åœ¨ 3.1 èŠ‚ä¸­ç”Ÿæˆçš„`scheduler_job_names.csv`æ–‡ä»¶ã€‚åœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œå®ƒä¼šä¸ºæ¯ä¸ªè™šæ‹Ÿç”¨æˆ·ï¼ˆçº¿ç¨‹ï¼‰åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ Cloud Scheduler ä½œä¸šåç§°ã€‚
3. **OS è¿›ç¨‹å–æ ·å™¨ (OS Process Sampler):** è¿™æ˜¯è¿æ¥ JMeter ä¸ GCP çš„æ¡¥æ¢ã€‚åœ¨çº¿ç¨‹ç»„çš„å¾ªç¯ä¸­ï¼Œæ¯ä¸ªè™šæ‹Ÿç”¨æˆ·å°†æ‰§è¡Œä¸€ä¸ª OS è¿›ç¨‹å–æ ·å™¨ã€‚è¯¥å–æ ·å™¨é…ç½®ä¸ºè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š`gcloud scheduler jobs run ${job_name}` 38ã€‚å…¶ä¸­

    `${job_name}`å˜é‡ç”± CSV æ•°æ®æ–‡ä»¶è®¾ç½®ç»„ä»¶æä¾›ã€‚

4. **HTTP è®¤è¯ç®¡ç†å™¨ (HTTP Authorization Manager):** å¦‚æœæ‚¨çš„`backendService`éœ€è¦æŸç§å½¢å¼çš„è®¤è¯ï¼ˆä¾‹å¦‚ï¼ŒBasic Authï¼‰ï¼Œæ‚¨éœ€è¦æ·»åŠ æ­¤ç®¡ç†å™¨ã€‚å®ƒä¼šè‡ªåŠ¨ä¸ºè¯·æ±‚æ·»åŠ `Authorization`å¤´ 39ã€‚ä¾‹å¦‚ï¼Œå¯¹äº Basic Authï¼Œæ‚¨åªéœ€æä¾›ç”¨æˆ·åå’Œå¯†ç ï¼ŒJMeter 3.2+ç‰ˆæœ¬ä¼šè‡ªåŠ¨å¤„ç† Base64 ç¼–ç  40ã€‚

è¿™ç§è®¾è®¡çš„å·§å¦™ä¹‹å¤„åœ¨äºï¼Œå®ƒå°† JMeter çš„æµ‹é‡ç›®æ ‡ä»æ— æ³•æµ‹é‡çš„â€œå¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶é—´â€è½¬ç§»åˆ°äº†å¯æµ‹é‡çš„â€œè§¦å‘å‘½ä»¤æˆåŠŸç‡â€ã€‚JMeter è®°å½•çš„å“åº”æ—¶é—´å’ŒæˆåŠŸ/å¤±è´¥çŠ¶æ€ï¼Œå®é™…ä¸Šåæ˜ äº† Cloud Scheduler API çš„å¥åº·çŠ¶å†µå’Œå“åº”èƒ½åŠ›ã€‚å¦‚æœ`gcloud`å‘½ä»¤å¼€å§‹å¤§é‡å¤±è´¥æˆ–è¶…æ—¶ï¼Œè¿™æœ¬èº«å°±æ˜¯ä¸€ä¸ªé‡è¦çš„è§‚æµ‹ç‚¹ã€‚

### 3.3. é…ç½® Stepping Thread Group è¿›è¡Œ 30 åˆ†é’Ÿæµ‹è¯•

æ ¹æ®ç”¨æˆ· 30 åˆ†é’Ÿçš„æµ‹è¯•æ—¶é•¿è¦æ±‚ï¼Œæˆ‘ä»¬ä¸º Stepping Thread Group æä¾›ä¸€ä¸ªå…·ä½“çš„é…ç½®æ–¹æ¡ˆã€‚è¿™ä¸ªæ–¹æ¡ˆåŒ…å«äº†ä¸€ä¸ªå¹³ç¼“çš„åŠ å‹æœŸã€ä¸€ä¸ªé•¿æ—¶é—´çš„ç¨³å®šè´Ÿè½½æœŸå’Œä¸€ä¸ªå¯æ§çš„å‡å‹æœŸã€‚

å›¾ 1ï¼šStepping Thread Group è´Ÿè½½å‰–é¢å›¾

(æ­¤å¤„åº”æ’å…¥ä¸€ä¸ª Stepping Thread Group é…ç½®ç•Œé¢çš„æˆªå›¾æˆ–å…¶ç”Ÿæˆçš„è´Ÿè½½å›¾è¡¨ï¼Œç›´è§‚å±•ç¤ºè´Ÿè½½å˜åŒ–)

å…·ä½“é…ç½®å‚æ•° 36:

- **This group will start:** `100` threads. (åˆå§‹å¹¶å‘æ•°)
- **First, wait for:** `0` seconds. (ç«‹å³å¼€å§‹)
- **Then, start:** `10` threads. (ç¬¬ä¸€æ‰¹å¯åŠ¨ 10 ä¸ªçº¿ç¨‹)
- **Next, add:** `10` threads every `30` seconds, using ramp-up of `5` seconds. (æ¯ 30 ç§’å¢åŠ  10 ä¸ªçº¿ç¨‹ï¼Œç”¨ 5 ç§’å®Œæˆè¿™ 10 ä¸ªçº¿ç¨‹çš„å¯åŠ¨)
- **Then, hold load for:** `1800` seconds. (è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°åï¼Œç»´æŒè´Ÿè½½ 30 åˆ†é’Ÿ)
- **Finally, stop:** `10` threads every `10` seconds. (æµ‹è¯•ç»“æŸåï¼Œæ¯ 10 ç§’åœæ­¢ 10 ä¸ªçº¿ç¨‹)

è¿™ä¸ªé…ç½®å°†ç”Ÿæˆä¸€ä¸ªé˜¶æ¢¯å¼ä¸Šå‡çš„è´Ÿè½½ï¼Œè®©æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿç³»ç»Ÿåœ¨ä¸åŒå‹åŠ›æ°´å¹³ä¸‹çš„è¡Œä¸ºï¼Œç„¶ååœ¨æœ€å¤§è´Ÿè½½ä¸‹æŒç»­è¿è¡Œ 30 åˆ†é’Ÿï¼Œä»¥æµ‹è¯•å…¶è€åŠ›å’Œç¨³å®šæ€§ã€‚

## ç¬¬ 4 éƒ¨åˆ†ï¼šè§‚æµ‹å°ï¼šå¤šå±‚æ¬¡ç›‘æ§ç­–ç•¥

æ²¡æœ‰å…¨é¢çš„ç›‘æ§ï¼Œæµ‹è¯•å°±æ˜¯ç›²ç›®çš„ã€‚æœ¬èŠ‚å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä» GCP çš„å„ä¸ªå±‚é¢æ”¶é›†å¿…è¦çš„æ•°æ®ï¼Œä»¥è¿›è¡Œæ·±å…¥çš„æ€§èƒ½åˆ†æå’Œé—®é¢˜è¯Šæ–­ã€‚

### 4.1. å®æ—¶æµ‹è¯•ç¼–æ’æŒ‡æ ‡ï¼šJMeter, Prometheus ä¸ Grafana

ä¸ºäº†å®æ—¶äº†è§£æˆ‘ä»¬**æ­£åœ¨æ–½åŠ **çš„è´Ÿè½½æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦å°† JMeter çš„åº¦é‡æ•°æ®æµå¼ä¼ è¾“åˆ°ä¸€ä¸ªå¤–éƒ¨ç›‘æ§ç³»ç»Ÿã€‚

- **åç«¯ç›‘å¬å™¨ (Backend Listener):** æˆ‘ä»¬å°†åœ¨ JMeter æµ‹è¯•è®¡åˆ’ä¸­æ·»åŠ ä¸€ä¸ª`Backend Listener` 42ã€‚
- **Prometheus ä½œä¸ºåç«¯:** å°½ç®¡ InfluxDB æ˜¯ä¼ ç»Ÿé€‰æ‹© 42ï¼Œä½†æˆ‘ä»¬æ›´æ¨èä½¿ç”¨
    **Prometheus Listener** (`jmeter-prometheus-plugin`) 46ã€‚Prometheus æ˜¯äº‘åŸç”Ÿç”Ÿæ€çš„äº‹å®æ ‡å‡†ï¼Œä¸ GKE è‡ªèº«çš„ç›‘æ§ä½“ç³»èƒ½æ›´å¥½åœ°èåˆ 47ã€‚
- **é…ç½®æµç¨‹:**
    1. åœ¨ JMeter çš„`lib/ext`ç›®å½•ä¸‹å®‰è£…`jmeter-prometheus-plugin.jar` 46ã€‚
    2. åœ¨æµ‹è¯•è®¡åˆ’çš„æ ¹èŠ‚ç‚¹æˆ–çº¿ç¨‹ç»„ä¸‹ï¼Œæ·»åŠ `Listener -> Prometheus Listener`ã€‚
    3. é…ç½® Prometheus æœåŠ¡å™¨çš„`prometheus.yml`æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„æŠ“å–ç›®æ ‡ï¼ˆscrape targetï¼‰ï¼ŒæŒ‡å‘ JMeter æ‰€åœ¨çš„æœºå™¨å’Œç«¯å£ï¼ˆé»˜è®¤ä¸º`localhost:9270`ï¼‰47ã€‚

        YAML

        ```
        scrape_configs:
          - job_name: 'jmeter'
            static_configs:
              - targets: ['<jmeter_load_generator_ip>:9270']
        ```

    4. åœ¨ Grafana ä¸­ï¼Œæ·»åŠ  Prometheus ä½œä¸ºæ•°æ®æºï¼Œå¹¶åˆ›å»ºä¸€ä¸ªä»ªè¡¨ç›˜æ¥å¯è§†åŒ–å…³é”®çš„ JMeter æŒ‡æ ‡ï¼Œä¾‹å¦‚ï¼š

        - **æ´»åŠ¨çº¿ç¨‹æ•° (Active Threads):** `jmeter_threads{state="active"}`
        - **äº‹åŠ¡é€Ÿç‡ (Transaction Rate / RPS):** `rate(jmeter_sampler_total[1m])`
        - **é”™è¯¯ç‡ (Error Rate):** `rate(jmeter_sampler_total{code!="200"}[1m]) / rate(jmeter_sampler_total[1m])`

è¿™ç§è®¾ç½®æä¾›äº†ä¸€ä¸ªå®æ—¶çš„â€œæŒ‡æŒ¥ä¸­å¿ƒâ€è§†å›¾ã€‚å¦‚æœåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼ŒGrafana æ˜¾ç¤ºçš„äº‹åŠ¡é€Ÿç‡ä¸‹é™ï¼Œè€Œ Stepping Thread Group çš„é…ç½®è¡¨æ˜å®ƒåº”è¯¥åœ¨ä¸Šå‡ï¼Œè¿™å°±æ„å‘³ç€é—®é¢˜å¯èƒ½å‡ºåœ¨ JMeter è´Ÿè½½æœºæœ¬èº«æˆ– Cloud Scheduler API ä¸Šï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿè¿…é€Ÿå°†é—®é¢˜ä¸è¢«æµ‹ç³»ç»Ÿåˆ†ç¦»å¼€æ¥ã€‚

### 4.2. ç›‘æ§æ¶ˆæ¯æ€»çº¿ï¼šPub/Sub å¥åº·çŠ¶å†µ

Pub/Sub æ˜¯è¿æ¥ä¸¤ä¸ª GKE æœåŠ¡çš„å…³é”®å¼‚æ­¥é“¾è·¯ï¼Œå…¶å¥åº·çŠ¶å†µç›´æ¥å†³å®šäº†æ•´ä¸ªç³»ç»Ÿçš„è¡¨ç°ã€‚æˆ‘ä»¬å°†é‡ç‚¹ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼Œå®ƒä»¬æ˜¯ç³»ç»Ÿç§¯å‹å’Œå¤„ç†å¤±è´¥çš„ç›´æ¥ä¿¡å·ã€‚

- å…³é”®æŒ‡æ ‡ 7:
    - **`subscription/num_undelivered_messages` (æœªæŠ•é€’æ¶ˆæ¯æ•°):** è¿™æ˜¯æœ€é‡è¦çš„æŒ‡æ ‡ï¼Œå³ç§¯å‹ï¼ˆBacklogï¼‰çš„å¤§å°ã€‚ä¸€ä¸ªæŒç»­å¢é•¿çš„ç§¯å‹æ˜ç¡®è¡¨ç¤ºæ¶ˆè´¹è€…ï¼ˆ`backendService`ï¼‰çš„å¤„ç†é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§è€…ï¼ˆ"Schedule Service"ï¼‰çš„å‘å¸ƒé€Ÿåº¦ã€‚
    - **`subscription/oldest_unacked_message_age` (æœ€æ—§æœªç¡®è®¤æ¶ˆæ¯å¹´é¾„):** è¿™æ˜¯æˆ‘ä»¬çš„æ–°é²œåº¦ SLIã€‚å¦‚æœè¿™ä¸ªå€¼æŒç»­èµ°é«˜ï¼Œè¯´æ˜æœ‰äº›æ¶ˆæ¯å¯èƒ½è¢«â€œå¡ä½â€äº†ï¼Œå¤„ç†å»¶è¿Ÿéå¸¸ä¸¥é‡ã€‚
    - **`subscription/dead_letter_message_count` (æ­»ä¿¡æ¶ˆæ¯æ•°):** ç›´æ¥åº¦é‡äº†å¤„ç†å¤±è´¥çš„æ¶ˆæ¯æ€»æ•°ï¼Œæ˜¯è®¡ç®—æˆ‘ä»¬å¯ç”¨æ€§ SLI çš„æ ¸å¿ƒæ•°æ®ã€‚
    - **`topic/send_request_count` (ä¸»é¢˜å‘é€è¯·æ±‚æ•°) & `subscription/pull_request_count` (è®¢é˜…æ‹‰å–è¯·æ±‚æ•°):** ç”¨äºè¡¡é‡æ¶ˆæ¯æ€»çº¿ä¸¤ç«¯çš„ååé‡ã€‚
- **ç›‘æ§æŸ¥è¯¢è¯­è¨€ (MQL) æŸ¥è¯¢:** æˆ‘ä»¬å°†æä¾›å¯ç›´æ¥ç”¨äº Cloud Monitoring ä»ªè¡¨ç›˜çš„ MQL æŸ¥è¯¢è¯­å¥ 7ã€‚
    - **ç¤ºä¾‹ï¼šç›‘æ§ç§¯å‹å¤§å°**
        ä»£ç æ®µ
        ```
        fetch pubsub_subscription
        ```

| metric 'pubsub.googleapis.com/subscription/num_undelivered_messages'

| filter (resource.subscription_id == 'your-main-subscription')

| group_by 1m, [value_num_undelivered_messages_mean: mean(value.num_undelivered_messages)]

| every 1m

- **ç¤ºä¾‹ï¼šç›‘æ§æ­»ä¿¡æ¶ˆæ¯å¢é‡**mql

fetch pubsub_subscription

| metric 'pubsub.googleapis.com/subscription/dead_letter_message_count'

| filter (resource.subscription_id == 'your-main-subscription')

| align rate(1m)

| every 1m

````

### 4.3. GKEå·¥ä½œè´Ÿè½½æ€§èƒ½ç›‘æ§

æˆ‘ä»¬éœ€è¦æ·±å…¥åˆ°GKEå†…éƒ¨ï¼Œè§‚å¯Ÿâ€œSchedule Serviceâ€å’Œ`backendService`åœ¨è´Ÿè½½ä¸‹çš„å…·ä½“è¡¨ç°ã€‚Cloud Monitoringæä¾›äº†ä¸°å¯Œçš„GKEåŸç”ŸæŒ‡æ ‡ 50ã€‚

- å…³é”®æŒ‡æ ‡ 51:

    - **Podçº§åˆ«èµ„æºåˆ©ç”¨ç‡:**

        - `kubernetes.io/container/cpu/core_usage_time`: å®¹å™¨CPUä½¿ç”¨æ—¶é—´ã€‚

        - `kubernetes.io/container/memory/used_bytes`: å®¹å™¨å·²ç”¨å†…å­˜ã€‚

        - æˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•é€šè¿‡`group_by` Deploymentåç§°æ¥èšåˆè¿™äº›æŒ‡æ ‡ï¼Œä»¥è·å¾—æœåŠ¡çš„æ•´ä½“èµ„æºæ¶ˆè€—è§†å›¾ã€‚

    - **HPAçŠ¶æ€æŒ‡æ ‡:**

        - `kubernetes.io/hpa/spec/target_utilization` vs `kubernetes.io/hpa/current_utilization`: æ¯”è¾ƒç›®æ ‡åˆ©ç”¨ç‡å’Œå½“å‰åˆ©ç”¨ç‡ï¼Œè§‚å¯ŸHPAçš„è·Ÿè¸ªç²¾åº¦ã€‚

        - `kubernetes.io/hpa/current_replicas`: å®æ—¶è·Ÿè¸ªHPAæ‰§è¡Œçš„ä¼¸ç¼©åŠ¨ä½œï¼Œè¿™æ˜¯éªŒè¯å…¶è¡Œä¸ºçš„å…³é”®ã€‚

    - **PodçŠ¶æ€:**

        - æˆ‘ä»¬å°†ä½¿ç”¨MQLæ¥ç»Ÿè®¡å¤„äºä¸åŒé˜¶æ®µï¼ˆ`Pending`, `Running`, `Failed`, `CrashLoopBackOff`ï¼‰çš„Podæ•°é‡ï¼Œä»¥å¿«é€Ÿå‘ç°è°ƒåº¦é—®é¢˜æˆ–åº”ç”¨å´©æºƒ 53ã€‚

        - **ç¤ºä¾‹ï¼šç›‘æ§CrashLoopingçš„Pod**

            ä»£ç æ®µ

            ```
            fetch k8s_container
            ```


| metric 'kubernetes.io/container/restart_count'

| filter (resource.jiqun_name == 'your-jiqun' && resource.namespace_name == 'your-namespace' && resource.pod_name =~ 'backend-service-.*')

| align delta(10m)

| group_by [resource.pod_name], [value_restart_count_delta: sum(value.restart_count)]

| condition val() > 0

````

é€šè¿‡å°†è¿™äº› GKE æŒ‡æ ‡ä¸ Pub/Sub ç§¯å‹æŒ‡æ ‡å…³è”åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ç²¾ç¡®è¯Šæ–­ç“¶é¢ˆã€‚ä¾‹å¦‚ï¼šç§¯å‹å¢é•¿ï¼ŒåŒæ—¶`current_replicas`è¾¾åˆ°`maxReplicas`ä¸” CPU ä½¿ç”¨ç‡ 100%ï¼Œè¿™æ˜¯å…¸å‹çš„æ¶ˆè´¹è€…ç®—åŠ›é¥±å’Œã€‚å¦‚æœç§¯å‹å¢é•¿ï¼Œä½† CPU å¾ˆä½ä¸” Pod å¤„äº`CrashLoopBackOff`çŠ¶æ€ï¼Œé‚£é—®é¢˜å°±æ˜¯åº”ç”¨ Bugï¼Œè€Œéæ€§èƒ½ç“¶é¢ˆã€‚

### 4.4. é»„é‡‘æ ‡å‡†ï¼šä½¿ç”¨ OpenTelemetry æµ‹é‡ç«¯åˆ°ç«¯å»¶è¿Ÿ

è¿™æ˜¯æœ¬ç›‘æ§ç­–ç•¥ä¸­æŠ€æœ¯è¦æ±‚æœ€é«˜ï¼Œä½†ä»·å€¼ä¹Ÿæœ€å¤§çš„éƒ¨åˆ†ã€‚æˆ‘ä»¬å¿…é¡»æ˜ç¡®æŒ‡å‡ºï¼Œ**æ²¡æœ‰åˆ†å¸ƒå¼è¿½è¸ªï¼Œå°±æ— æ³•å‡†ç¡®æµ‹é‡ç«¯åˆ°ç«¯å»¶è¿Ÿ SLO**ã€‚

- æœåŠ¡æ¤å…¥ (Instrumentation):
    æˆ‘ä»¬å°†æŒ‡å¯¼å¦‚ä½•ä½¿ç”¨ OpenTelemetry Java Agent ä¸ºæ‚¨çš„ä¸¤ä¸ª Java æœåŠ¡ï¼ˆå‡è®¾ä¸º Javaï¼‰è¿›è¡Œè‡ªåŠ¨æ¤å…¥ã€‚å¯¹äºå¤§å¤šæ•°åŸºäºæµè¡Œæ¡†æ¶ï¼ˆå¦‚ Spring Bootï¼‰å’Œåº“ï¼ˆå¦‚ gRPC, HTTP å®¢æˆ·ç«¯ï¼‰çš„äº¤äº’ï¼ŒJava Agent å¯ä»¥å®ç°â€œé›¶ä»£ç â€çš„è‡ªåŠ¨è¿½è¸ª 55ã€‚
    1. ä¸‹è½½æœ€æ–°çš„`opentelemetry-javaagent.jar`ã€‚
    2. åœ¨å¯åŠ¨æ‚¨çš„ Java åº”ç”¨çš„ JVM å‚æ•°ä¸­åŠ å…¥`-javaagent:path/to/opentelemetry-javaagent.jar`ã€‚
    3. é€šè¿‡ç¯å¢ƒå˜é‡é…ç½® Agentï¼Œä¾‹å¦‚æŒ‡å®šæœåŠ¡åå’Œå¯¼å‡ºç«¯ç‚¹ï¼ˆæŒ‡å‘ Cloud Traceï¼‰ã€‚

        Bash

        ```
        export OTEL_SERVICE_NAME=backend-service
        export OTEL_TRACES_EXPORTER=gcp
        export OTEL_METRICS_EXPORTER=none
        export OTEL_LOGS_EXPORTER=none
        ```
- ä¸Šä¸‹æ–‡ä¼ æ’­ (Context Propagation):
    è¿™æ˜¯è¿æ¥å¼‚æ­¥æœåŠ¡è¿½è¸ªé“¾çš„å…³é”®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæœåŠ¡çš„è¿½è¸ªä¿¡æ¯ä¸ä¼šè‡ªåŠ¨ä¼ é€’ç»™é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦çš„å¦ä¸€ä¸ªæœåŠ¡ã€‚æˆ‘ä»¬éœ€è¦ç¡®ä¿è¿½è¸ªä¸Šä¸‹æ–‡ï¼ˆtrace contextï¼‰èƒ½å¤Ÿè·¨è¶Š Pub/Subã€‚
    1. **å‘å¸ƒç«¯ ("Schedule Service"):** å½“æœåŠ¡æ”¶åˆ°è§¦å‘ä¿¡å·å¹¶å‡†å¤‡å‘å¸ƒæ¶ˆæ¯æ—¶ï¼ŒOpenTelemetry Agent ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª spanã€‚å½“ä½¿ç”¨å¯ç”¨äº† OpenTelemetry çš„ Pub/Sub å®¢æˆ·ç«¯åº“æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å°†å½“å‰çš„ trace contextï¼ˆåŒ…å«`trace_id`å’Œ`span_id`ï¼‰æ³¨å…¥åˆ°å°†è¦å‘å¸ƒçš„ Pub/Sub æ¶ˆæ¯çš„**å±æ€§ï¼ˆattributesï¼‰**ä¸­ 58ã€‚è¿™ä¸ªä¸Šä¸‹æ–‡é€šå¸¸éµå¾ª W3C çš„

        `traceparent`æ ‡å‡† 60ã€‚

    2. **è®¢é˜…ç«¯ (`backendService`):** å½“æœåŠ¡ä» Pub/Sub æ‹‰å–åˆ°æ¶ˆæ¯æ—¶ï¼ŒOTel Agent æˆ–æ‚¨çš„æ‰‹åŠ¨æ¤å…¥ä»£ç éœ€è¦ä»æ¶ˆæ¯çš„å±æ€§ä¸­**æå–**å‡º`traceparent`ã€‚
    3. ç„¶åï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ span æ¥ä»£è¡¨æ¶ˆæ¯å¤„ç†è¿™ä¸ªæ“ä½œï¼Œä½†ä¼šå°†è¿™ä¸ªæ–° span ä¸ä»æ¶ˆæ¯ä¸­æå–çš„ä¸Šä¸‹æ–‡**é“¾æ¥ï¼ˆlinkï¼‰**èµ·æ¥ï¼Œæˆ–è€…å°†å…¶ä½œä¸ºçˆ¶ spanã€‚è¿™æ ·ï¼Œä¸¤ä¸ªçœ‹ä¼¼ç‹¬ç«‹çš„æ“ä½œå°±åœ¨é€»è¾‘ä¸Šè¢«å…³è”åˆ°äº†åŒä¸€ä¸ªè¿½è¸ªä¸‹ã€‚
    4. ä¸¤ä¸ªæœåŠ¡éƒ½å°†å„è‡ªçš„ span æ•°æ®å¯¼å‡ºåˆ° Cloud Traceã€‚
- åœ¨ Cloud Trace ä¸­åˆ†æ:
    Cloud Trace ä¼šè‡ªåŠ¨æ ¹æ® span ä¸­çš„ trace_idã€span_id å’Œçˆ¶å­å…³ç³»ï¼Œå°†æ¥è‡ªä¸åŒæœåŠ¡çš„ spanâ€œç¼åˆâ€æˆä¸€ä¸ªå®Œæ•´çš„ã€ç«¯åˆ°ç«¯çš„è¿½è¸ªè§†å›¾ã€‚æ‚¨å°†èƒ½çœ‹åˆ°ä¸€ä¸ªæ¸…æ™°çš„ç€‘å¸ƒå›¾ï¼Œæ˜¾ç¤ºä» Scheduler è§¦å‘åˆ° backendService å¤„ç†å®Œæˆçš„å®Œæ•´è€—æ—¶ï¼Œä»¥åŠæ¯ä¸€ç¯èŠ‚çš„è€—æ—¶ 60ã€‚Cloud Trace ä¼šåŸºäºè¿™äº›æ•°æ®è‡ªåŠ¨ç”Ÿæˆå»¶è¿Ÿåˆ†å¸ƒå›¾ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­ç›´æ¥è¯»å– P95ã€P99 å»¶è¿Ÿï¼Œç”¨äº SLO çš„åˆ¤å®šã€‚

## ç¬¬ 5 éƒ¨åˆ†ï¼šåˆ†æä¸è§£è¯»ï¼šä»æ•°æ®åˆ°æ´è§

åŸå§‹æ•°æ®æœ¬èº«æ²¡æœ‰æ„ä¹‰ï¼Œæœ¬èŠ‚å°†æŒ‡å¯¼å¦‚ä½•å°†æˆ‘ä»¬åœ¨ç¬¬ 4 éƒ¨åˆ†æ”¶é›†åˆ°çš„æµ·é‡æ•°æ®ï¼Œè½¬åŒ–ä¸ºå¯è¡ŒåŠ¨çš„ç»“è®ºã€‚

### 5.1. ç»Ÿä¸€å¯è§‚æµ‹æ€§ä»ªè¡¨ç›˜

æˆ‘ä»¬å¼ºçƒˆå»ºè®®åœ¨ Cloud Monitoring æˆ– Grafana ä¸­åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„ä»ªè¡¨ç›˜ï¼Œå°†æ‰€æœ‰å…³é”®æŒ‡æ ‡åœ¨å…±äº«çš„æ—¶é—´è½´ä¸Šè¿›è¡Œå…³è”å±•ç¤ºã€‚ä¸€ä¸ªå…¸å‹çš„å¸ƒå±€å¦‚ä¸‹ï¼š

- **ç¬¬ä¸€è¡Œ (è´Ÿè½½ç”Ÿæˆ):**
    - JMeter æ´»åŠ¨çº¿ç¨‹æ•° (æ¥è‡ª Prometheus)
    - JMeter äº‹åŠ¡é€Ÿç‡ (RPS) (æ¥è‡ª Prometheus)
- **ç¬¬äºŒè¡Œ (è¢«æµ‹ç³»ç»ŸçŠ¶æ€):**
    - Pub/Sub ç§¯å‹æ¶ˆæ¯æ•° (`num_undelivered_messages`)
    - `backendService` HPA å½“å‰å‰¯æœ¬æ•° (`current_replicas`)
    - `backendService` CPU åˆ©ç”¨ç‡ (èšåˆ)
- **ç¬¬ä¸‰è¡Œ (ç³»ç»Ÿäº§å‡ºä¸è´¨é‡):**
    - ç«¯åˆ°ç«¯ P95 å»¶è¿Ÿ (æ¥è‡ª Cloud Trace)
    - Pub/Sub æœ€æ—§æ¶ˆæ¯å¹´é¾„ (`oldest_unacked_message_age`)
    - DLQ æ¶ˆæ¯æ€»æ•° (`dead_letter_message_count`)

ä¸€ä¸ªç»Ÿä¸€çš„ä»ªè¡¨ç›˜æ˜¯è¿›è¡Œé—®é¢˜åˆ†æå’Œæ•…äº‹è®²è¿°çš„å¼ºå¤§å·¥å…·ã€‚å®ƒèƒ½è®©ä»»ä½•è§‚å¯Ÿè€…ä¸€ç›®äº†ç„¶åœ°çœ‹åˆ°å› æœå…³ç³»ï¼šâ€œçœ‹ï¼Œå½“ JMeter çº¿ç¨‹æ•°åœ¨è¿™é‡Œå¼€å§‹çˆ¬å‡æ—¶ï¼ŒPub/Sub çš„ç§¯å‹ä¹Ÿå¼€å§‹æŠ¬å¤´ï¼Œéšå HPA å‰¯æœ¬æ•°è¿…é€Ÿå¢åŠ ï¼Œç›´åˆ°è¾¾åˆ°ä¸Šé™ï¼Œç´§æ¥ç€ç«¯åˆ°ç«¯å»¶è¿Ÿå¼€å§‹é£™å‡ï¼Œçªç ´äº†æˆ‘ä»¬çš„ SLO é˜ˆå€¼ã€‚â€ è¿™ç§å¯è§†åŒ–çš„å…³è”åˆ†æï¼Œè¿œæ¯”å­¤ç«‹åœ°æŸ¥çœ‹å„ä¸ªæŒ‡æ ‡è¦å¼ºå¤§å¾—å¤šã€‚

### 5.2. è¯†åˆ«ç“¶é¢ˆä¸é¥±å’Œç‚¹

é€šè¿‡è§£è¯»ç»Ÿä¸€ä»ªè¡¨ç›˜ï¼Œæˆ‘ä»¬å¯ä»¥ç³»ç»Ÿåœ°å®šä½ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚

- **æ¶ˆè´¹è€…å—é™ (Consumer-Bound) åœºæ™¯:**
    - **ç°è±¡:** Pub/Sub ç§¯å‹ (`num_undelivered_messages`) éšè´Ÿè½½å¢åŠ è€Œçº¿æ€§å¢é•¿ã€‚åŒæ—¶ï¼Œ`backendService`çš„ CPU åˆ©ç”¨ç‡æŒç»­å¤„äºé«˜ä½ï¼ˆå¦‚ 95%-100%ï¼‰ï¼Œå¹¶ä¸”å…¶ Pod å‰¯æœ¬æ•°å·²ç»è¾¾åˆ°äº† HPA é…ç½®çš„`maxReplicas`ã€‚
    - **ç»“è®º:** è¿™æ˜¯æœ€å…¸å‹çš„â€œæ¶ˆè´¹è€…å¤„ç†ä¸è¿‡æ¥â€çš„ç“¶é¢ˆã€‚ç³»ç»Ÿçš„æœ€å¤§å¯æŒç»­ååé‡ï¼Œå°±æ˜¯ç§¯å‹å¼€å§‹å‡ºç°ç¨³å®šçº¿æ€§å¢é•¿å‰çš„é‚£ä¸ªè´Ÿè½½æ°´å¹³ã€‚
- **å‘å¸ƒè€…å—é™ (Publisher-Bound) åœºæ™¯:**
    - **ç°è±¡:** å°½ç®¡ JMeter çš„è´Ÿè½½ä»åœ¨å¢åŠ ï¼Œä½† Pub/Sub çš„`topic/send_request_count`æŒ‡æ ‡å´è¶‹äºå¹³ç¼“ï¼Œä¸å†å¢é•¿ã€‚åŒæ—¶ï¼Œâ€œSchedule Serviceâ€çš„ CPU åˆ©ç”¨ç‡è¾¾åˆ°é¥±å’Œã€‚
    - **ç»“è®º:** å‘å¸ƒç«¯æˆä¸ºäº†ç“¶é¢ˆã€‚è¿™ç§æƒ…å†µç›¸å¯¹å°‘è§ï¼Œä½†å¯èƒ½å‘ç”Ÿåœ¨â€œSchedule Serviceâ€æœ¬èº«æœ‰å¤æ‚é€»è¾‘æˆ–èµ„æºé™åˆ¶çš„æƒ…å†µä¸‹ã€‚
- **å¹³å°å—é™ (Platform-Bound) åœºæ™¯:**
    - **ç°è±¡:** ç³»ç»Ÿååé‡çªç„¶æ–­å´–å¼ä¸‹è·Œï¼ŒJMeter æ—¥å¿—ä¸­å‡ºç°å¤§é‡å…³äº API è°ƒç”¨çš„é”™è¯¯ï¼ˆå¦‚`PERMISSION_DENIED`, `RESOURCE_EXHAUSTED`ï¼‰ã€‚
    - **ç»“è®º:** æ­¤æ—¶åº”ç«‹å³å…³è”æŸ¥çœ‹ç¬¬ 2.1 èŠ‚ä¸­å‡†å¤‡çš„ GCP é…é¢ä»ªè¡¨ç›˜ã€‚å¾ˆå¯èƒ½æ˜¯æˆ‘ä»¬è§¦ç¢°äº† Cloud Schedulerã€Pub/Sub æˆ– Cloud Monitoring çš„ API é€Ÿç‡æˆ–ååé‡é…é¢ã€‚

### 5.3. éªŒè¯å¼¹æ€§æœºåˆ¶

å‹åŠ›æµ‹è¯•ä¹Ÿæ˜¯éªŒè¯ç³»ç»Ÿå¼¹æ€§è®¾è®¡æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œçš„æœ€ä½³æ—¶æœºã€‚

- **HPA è¡Œä¸ºéªŒè¯:**
    - è§‚å¯Ÿ`hpa/current_replicas`å›¾è¡¨ã€‚å½“è´Ÿè½½å¢åŠ æ—¶ï¼ŒHPA æ˜¯å¦èƒ½è¿…é€Ÿã€å¹³æ»‘åœ°å¢åŠ å‰¯æœ¬æ•°ï¼Ÿåœ¨æµ‹è¯•ç»“æŸçš„å‡å‹é˜¶æ®µï¼Œå®ƒæ˜¯å¦èƒ½ç›¸åº”åœ°ç¼©å®¹ä»¥èŠ‚çº¦æˆæœ¬ï¼Ÿæ˜¯å¦å­˜åœ¨â€œæŠ–åŠ¨â€ï¼ˆthrashingï¼‰ç°è±¡ï¼Œå³å‰¯æœ¬æ•°åœ¨çŸ­æ—¶é—´å†…é¢‘ç¹åœ°ä¸Šä¸‹æ³¢åŠ¨ï¼Ÿ32
- **é‡è¯•ä¸ DLQ æœºåˆ¶éªŒè¯:**
    - å¦‚æœåœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æœ‰æ„åœ°å¼•å…¥äº†ä¸€äº›â€œæ¯’ä¸¸æ¶ˆæ¯â€ï¼Œæˆ–ä¸´æ—¶å°†`backendService`çš„å‰¯æœ¬æ•°ç¼©å®¹åˆ° 0ï¼Œæˆ‘ä»¬åº”é‡ç‚¹è§‚å¯Ÿ`dead_letter_message_count`æŒ‡æ ‡ã€‚æ¶ˆæ¯æ˜¯å¦åœ¨è¾¾åˆ°`max_delivery_attempts`ï¼ˆä¾‹å¦‚ 5 æ¬¡ï¼‰åè¢«æ­£ç¡®åœ°è½¬å‘åˆ°äº† DLQï¼Ÿé…ç½®çš„æŒ‡æ•°é€€é¿ç­–ç•¥æ˜¯å¦æœ‰æ•ˆé˜²æ­¢äº†å¯†é›†çš„æ— æ•ˆé‡è¯•ï¼Ÿè¿™ç›´æ¥éªŒè¯äº†æˆ‘ä»¬åœ¨ 2.3 èŠ‚ä¸­çš„å¼¹æ€§é…ç½®ã€‚

### 5.4. SLO ç¬¦åˆæ€§æŠ¥å‘Š

è¿™æ˜¯å¯¹æ•´ä¸ªå‹åŠ›æµ‹è¯•çš„æœ€ç»ˆè£å†³ã€‚æˆ‘ä»¬å°†ç”Ÿæˆä¸€ä»½ç®€æ´çš„â€œæˆç»©å•â€ï¼Œå°†æµ‹è¯•æœŸé—´çš„å®é™…è¡¨ç°ä¸æˆ‘ä»¬åœ¨ç¬¬ 1.3 èŠ‚ä¸­è®¾å®šçš„ SLO è¿›è¡Œå¯¹æ¯”ã€‚

| SLI              | SLO ç›®æ ‡  | æµ‹è¯•æœŸé—´è¡¨ç°                     | æ˜¯å¦è¾¾æ ‡ï¼Ÿ | é”™è¯¯é¢„ç®—æ¶ˆè€—                |
| ---------------- | --------- | -------------------------------- | ---------- | --------------------------- |
| å¯ç”¨æ€§           | `> 99.9%` | `(æ€»å¤„ç†æ•° - DLQæ•°) / æ€»å¤„ç†æ•°`  | âœ… / âŒ    | `(DLQæ•° / æ€»å¤„ç†æ•°) * 100%` |
| ç«¯åˆ°ç«¯å»¶è¿Ÿ (P95) | `< 800ms` | Cloud Trace P95 å»¶è¿Ÿå€¼           | âœ… / âŒ    | è¶…æ ‡æ—¶é—´çª—å£å æ¯”            |
| æ–°é²œåº¦ (P99)     | `< 60s`   | `oldest_unacked_message_age`å³°å€¼ | âœ… / âŒ    | è¶…æ ‡æ—¶é—´çª—å£å æ¯”            |

è¿™ä»½æŠ¥å‘Šä¸ºæµ‹è¯•ç»“æœæä¾›äº†æ¸…æ™°ã€å®¢è§‚çš„ç»“è®ºã€‚å®ƒä¸å†æ˜¯æ¨¡ç³Šçš„â€œæµ‹è¯•å®Œæˆäº†â€ï¼Œè€Œæ˜¯æ˜ç¡®çš„â€œæ ¹æ®æˆ‘ä»¬å…±åŒåˆ¶å®šçš„æ ‡å‡†ï¼Œç³»ç»Ÿåœ¨ç›®æ ‡è´Ÿè½½ä¸‹æ˜¯/å¦è¶³å¤Ÿå¯é â€ 3ã€‚

## ç¬¬ 6 éƒ¨åˆ†ï¼šå·¥ç¨‹åŒ–å¼¹æ€§ï¼šé«˜çº§ç­–ç•¥ä¸åç»­æ­¥éª¤

æµ‹è¯•å·²ç»å®Œæˆï¼Œæ•°æ®åœ¨æ‰‹ã€‚æœ¬èŠ‚å°†ç€çœ¼äºæœªæ¥ï¼Œæä¾›ä¸€ç³»åˆ—å°†æµ‹è¯•æ´è§è½¬åŒ–ä¸ºé•¿æœŸå·¥ç¨‹ä»·å€¼çš„ã€å¯è½åœ°çš„å»ºè®®ï¼Œæ—¨åœ¨å°†ç³»ç»Ÿçš„å¯é æ€§æå‡åˆ°ä¸€ä¸ªæ–°çš„æˆç†Ÿåº¦ã€‚

### 6.1. é«˜çº§è‡ªåŠ¨ä¼¸ç¼©ï¼šåŸºäºæ­£ç¡®çš„ä¿¡å·è¿›è¡Œæ‰©å±•

- åŸºäº CPU/å†…å­˜ä¼¸ç¼©çš„é—®é¢˜:
    å¯¹äºä¸€ä¸ªä»æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹ä»»åŠ¡çš„ backendService æ¥è¯´ï¼ŒCPU åˆ©ç”¨ç‡æ˜¯è´Ÿè½½çš„æ»åæŒ‡æ ‡ã€‚å½“ CPU å‡é«˜æ—¶ï¼Œç§¯å‹å¾€å¾€å·²ç»å½¢æˆã€‚æœ€ç›´æ¥ã€æœ€é¢†å…ˆçš„è´Ÿè½½ä¿¡å·ï¼Œæ˜¯é˜Ÿåˆ—æœ¬èº«çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯ Pub/Sub çš„ç§¯å‹æ¶ˆæ¯æ•° 33ã€‚
- è§£å†³æ–¹æ¡ˆ 1ï¼šåŸºäºå¤–éƒ¨æŒ‡æ ‡çš„ HPA:
    æˆ‘ä»¬å¯ä»¥é…ç½® HPAï¼Œä½¿å…¶ç›´æ¥æ ¹æ® Pub/Sub çš„ç§¯å‹æ¶ˆæ¯æ•°ï¼ˆnum_undelivered_messagesï¼‰è¿›è¡Œä¼¸ç¼©ã€‚è¿™éœ€è¦ GKE é›†ç¾¤ä¸­å®‰è£…å¹¶é…ç½®å¥½ Cloud Monitoring çš„è‡ªå®šä¹‰æŒ‡æ ‡é€‚é…å™¨ï¼ˆCustom Metrics Adapterï¼‰ã€‚
    ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ HPA YAML æ¸…å•ï¼Œå®ƒå°†`backendService`çš„ä¼¸ç¼©å†³ç­–ä¸ Pub/Sub è®¢é˜…çš„ç§¯å‹æ·±åº¦ç›´æ¥æŒ‚é’© 63ï¼š
    YAML
    ```
    apiVersion: autoscaling/v2
    kind: HorizontalPodAutoscaler
    metadata:
      name: backend-service-pubsub-hpa
      namespace: your-namespace
    spec:
      scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: backendService
      minReplicas: 3
      maxReplicas: 100
      metrics:
      - type: External
        external:
          metric:
            # Metric format: pubsub.googleapis.com|subscription|metric_name
            name: pubsub.googleapis.com|subscription|num_undelivered_messages
            # Selector to target the specific subscription
            selector:
              matchLabels:
                resource.labels.subscription_id: "your-main-subscription"
          target:
            # Target an average of 100 messages per pod replica
            type: AverageValue
            averageValue: "100"
    ```
    è¿™ä¸ªé…ç½®çš„å«ä¹‰æ˜¯ï¼šâ€œä¿æŒ`backendService`çš„å‰¯æœ¬æ•°ï¼Œä½¿å¾—å¹³å‡æ¯ä¸ª Pod å¤„ç† 100 ä¸ªç§¯å‹æ¶ˆæ¯â€ã€‚å½“ç§¯å‹è¾¾åˆ° 300 æ—¶ï¼ŒHPA ä¼šå°è¯•æ‰©å±•åˆ° 3 ä¸ª Podï¼›å½“ç§¯å‹è¾¾åˆ° 10000 æ—¶ï¼Œå®ƒä¼šæ‰©å±•åˆ° 100 ä¸ª Podã€‚è¿™ç§ä¼¸ç¼©æ–¹å¼æ¯”åŸºäº CPU çš„ååº”æ›´è¿…é€Ÿã€æ›´ç›´æ¥ã€‚
- è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ KEDA è¿›è¡Œäº‹ä»¶é©±åŠ¨ä¼¸ç¼©:
    å¯¹äºæ›´é«˜çº§çš„åœºæ™¯ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ KEDA (Kubernetes Event-driven Autoscaler) 65ã€‚KEDA æ˜¯ä¸€ä¸ª CNCF çš„å­µåŒ–é¡¹ç›®ï¼Œå®ƒæå¤§åœ°å¢å¼ºäº† Kubernetes çš„äº‹ä»¶é©±åŠ¨ä¼¸ç¼©èƒ½åŠ›ã€‚
    - **æ ¸å¿ƒä¼˜åŠ¿:** KEDA å¯ä»¥ç›´æ¥ä¸å¤šç§äº‹ä»¶æºï¼ˆåŒ…æ‹¬ Pub/Subï¼‰é›†æˆï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå°†å‰¯æœ¬æ•°**ç¼©å®¹è‡³é›¶**ï¼Œä»è€Œåœ¨æ²¡æœ‰å·¥ä½œæ—¶å®ç°æè‡´çš„æˆæœ¬èŠ‚çº¦ï¼Œè¿™æ˜¯æ ‡å‡† HPA æ— æ³•åšåˆ°çš„ã€‚
    - **å®ç°æ–¹å¼:** æ‚¨éœ€è¦åœ¨é›†ç¾¤ä¸­å®‰è£… KEDAï¼Œç„¶ååˆ›å»ºä¸€ä¸ª`ScaledObject`è‡ªå®šä¹‰èµ„æºæ¥å®šä¹‰ä¼¸ç¼©è§„åˆ™ 67ã€‚
        YAML
        ```
        apiVersion: keda.sh/v1alpha1
        kind: ScaledObject
        metadata:
          name: pubsub-scaler
          namespace: your-namespace
        spec:
          scaleTargetRef:
            name: backendService # Name of the deployment to scale
          pollingInterval: 15  # How often to check the queue (in seconds)
          cooldownPeriod:  300 # Period to wait before scaling down to 0
          minReplicaCount: 0   # Scale down to zero when idle
          maxReplicaCount: 100 # Maximum number of replicas
          triggers:
          - type: gcp-pubsub
            metadata:
              subscriptionName: "your-main-subscription"
              queueLength: "100" # Target 100 messages per replica (similar to HPA's AverageValue)
              # Authentication using Workload Identity
              credentialsFromEnv: "GOOGLE_APPLICATION_CREDENTIALS"
        ```

é‡‡ç”¨åŸºäºç§¯å‹çš„ä¼¸ç¼©ç­–ç•¥ï¼Œæ˜¯æœ¬æ¬¡å‹åŠ›æµ‹è¯•å¯èƒ½äº§å‡ºçš„æœ€å…·ä»·å€¼çš„æ¶æ„æ”¹è¿›å»ºè®®ä¹‹ä¸€ã€‚å®ƒç›´æ¥è§£å†³äº†ç”¨æˆ·å¯¹äº HPA å¯èƒ½â€œæ’‘çˆ†â€çš„æ‹…å¿§ï¼Œå°†ä¼¸ç¼©é€»è¾‘ä»è¢«åŠ¨ååº”è½¬å˜ä¸ºä¸»åŠ¨é¢„æµ‹ã€‚

### 6.2. è¶…è¶Šè´Ÿè½½ï¼šä»å‹åŠ›æµ‹è¯•åˆ°æ··æ²Œå·¥ç¨‹

å‹åŠ›æµ‹è¯•éªŒè¯äº†ç³»ç»Ÿåœ¨ç†æƒ³è´Ÿè½½ä¸‹çš„æ€§èƒ½ï¼Œè€Œ**æ··æ²Œå·¥ç¨‹ï¼ˆChaos Engineeringï¼‰**åˆ™éªŒè¯ç³»ç»Ÿåœ¨**çœŸå®æ•…éšœ**ä¸‹çš„å¼¹æ€§ 68ã€‚æˆ‘ä»¬é¼“åŠ±æ‚¨çš„å›¢é˜Ÿå°†å¯é æ€§å®è·µæ¨å‘æ–°çš„é«˜åº¦ã€‚

- æ··æ²Œå·¥ç¨‹å·¥å…·ä»‹ç»:
    æˆ‘ä»¬æ¨èä»å¼€æºçš„ã€CNCF æ‰˜ç®¡çš„å·¥å…·å¼€å§‹ï¼Œå¦‚ LitmusChaos 70 æˆ–
    **Chaos Mesh** 71ã€‚å®ƒä»¬ä¸ GKE åŸç”Ÿé›†æˆï¼Œæä¾›äº†ä¸°å¯Œçš„â€œæ•…éšœæ³¨å…¥â€èƒ½åŠ›ã€‚
- ç­–åˆ’æ‚¨çš„ç¬¬ä¸€ä¸ªâ€œæ•…éšœæ¼”ç»ƒæ—¥ (Game Day)â€:
    Game Day æ˜¯ä¸€æ¬¡æœ‰è®¡åˆ’ã€æœ‰èŒƒå›´ã€æœ‰ç›®æ ‡çš„æ··æ²Œå®éªŒæ¼”ç»ƒ 72ã€‚æˆ‘ä»¬å»ºè®®ä»ä¸€ä¸ªç®€å•çš„å®éªŒå¼€å§‹ï¼š
    1. **å»ºç«‹å‡è¯´ (Hypothesis):** â€œå¦‚æœ`backendService`çš„ä¸€ä¸ª Pod è¢«æ„å¤–æ€æ­»ï¼ŒHPA åº”è¯¥èƒ½åœ¨ 2 åˆ†é’Ÿå†…å°†å…¶æ›¿æ¢ï¼ŒæœŸé—´ç³»ç»Ÿçš„ç«¯åˆ°ç«¯å»¶è¿Ÿ SLO ä¸åº”è¢«æŒç»­è¿åã€‚â€
    2. **æ‰§è¡Œå®éªŒ (Experiment):** åœ¨ä¸€ä¸ªä½è´Ÿè½½çš„æµ‹è¯•ç¯å¢ƒä¸­ï¼Œä½¿ç”¨`kubectl delete pod`æˆ–æ··æ²Œå·¥å…·ï¼Œéšæœºç»ˆæ­¢`backendService`çš„ä¸€ä¸ª Podã€‚
    3. **è§‚å¯Ÿä¸éªŒè¯ (Verify):** ç´§å¯†ç›‘æ§ç»Ÿä¸€ä»ªè¡¨ç›˜ã€‚HPA æ˜¯å¦å¦‚é¢„æœŸèˆ¬åˆ›å»ºäº†æ–°çš„ Podï¼ŸPub/Sub ç§¯å‹æ˜¯å¦æœ‰ç¬æ—¶çš„å°å¹…å¢é•¿ç„¶åè¿…é€Ÿå›è½ï¼Ÿå»¶è¿ŸæŒ‡æ ‡æ˜¯å¦åœ¨å¯æ¥å—çš„èŒƒå›´å†…æ³¢åŠ¨ï¼Ÿ
    4. **è¿›é˜¶å®éªŒï¼šæ³¨å…¥å»¶è¿Ÿ:** ä½¿ç”¨ Chaos Mesh ç­‰å·¥å…·ï¼Œå¯¹`backendService`çš„å‡ºç«™ç½‘ç»œæµé‡ï¼ˆä¾‹å¦‚ï¼Œè®¿é—®æ•°æ®åº“çš„æµé‡ï¼‰æ³¨å…¥ 200ms çš„å»¶è¿Ÿã€‚è§‚å¯Ÿè¿™æ˜¯å¦ä¼šè§¦å‘æ¶ˆæ¯å¤„ç†è¶…æ—¶ã€NACKï¼Œå¹¶æœ€ç»ˆåœ¨å¤šæ¬¡é‡è¯•åå°†æ¶ˆæ¯é€å…¥ DLQã€‚

è¿™ç§ä¸»åŠ¨å¯»æ‰¾ç³»ç»Ÿå¼±ç‚¹çš„å®éªŒæ€§æ–¹æ³•ï¼Œæ˜¯æ„å»ºè¶…é«˜å¯é æ€§ç³»ç»Ÿçš„å¿…ç»ä¹‹è·¯ï¼Œå®ƒèƒ½å¸®åŠ©æ‚¨åœ¨çœŸæ­£çš„ç”Ÿäº§æ•…éšœå‘ç”Ÿå‰ï¼Œå‘ç°å¹¶ä¿®å¤æ½œåœ¨çš„é—®é¢˜ 75ã€‚

### 6.3. æ‹¥æŠ±å¯é æ€§æ–‡åŒ–ï¼šæ— æŒ‡è´£çš„æ•…éšœååˆ†æ

æœ¬æŠ¥å‘Šçš„æœ€ç»ˆå»ºè®®ï¼Œæ˜¯å…³äºæ–‡åŒ–çš„ã€‚æ— è®ºæ˜¯å‹åŠ›æµ‹è¯•æœªè¾¾æ ‡ï¼Œè¿˜æ˜¯çœŸå®çš„ç”Ÿäº§ç¯å¢ƒå‘ç”Ÿæ•…éšœï¼Œæ ¸å¿ƒç›®æ ‡éƒ½åº”æ˜¯**å­¦ä¹ **ï¼Œè€Œé**æŒ‡è´£**ã€‚

æˆ‘ä»¬å¼ºçƒˆæ¨èå¼•å…¥ Google SRE æ–‡åŒ–çš„æ ¸å¿ƒå®è·µä¹‹ä¸€ï¼š**æ— æŒ‡è´£çš„æ•…éšœååˆ†æï¼ˆBlameless Postmortemï¼‰** 76ã€‚

- **æ ¸å¿ƒåŸåˆ™:**
    - **åšä¿¡å–„æ„:** é»˜è®¤æ‰€æœ‰å‚ä¸äº‹ä»¶çš„äººå‘˜ï¼Œåœ¨å½“æ—¶éƒ½åŸºäºä»–ä»¬æ‰€æŒæ¡çš„ä¿¡æ¯ï¼Œåšå‡ºäº†è‡ªå·±è®¤ä¸ºæœ€æ­£ç¡®çš„å†³å®šã€‚
    - **å…³æ³¨ç³»ç»Ÿ:** è°ƒæŸ¥çš„ç„¦ç‚¹åº”æ˜¯ç³»ç»Ÿæ€§ã€æµç¨‹æ€§ã€å·¥å…·æ€§çš„æˆå› ï¼Œè€Œä¸æ˜¯â€œæŸæŸæŸçŠ¯äº†é”™è¯¯â€ã€‚äººæ˜¯ä¸å¯ä¿®å¤çš„ï¼Œä½†ç³»ç»Ÿå’Œæµç¨‹å¯ä»¥ã€‚
    - **äº§å‡ºå¯è¡ŒåŠ¨çš„æ”¹è¿›é¡¹:** Postmortem çš„æœ€ç»ˆäº§ç‰©æ˜¯ä¸€ç³»åˆ—æœ‰æ˜ç¡®è´Ÿè´£äººã€æœ‰ä¼˜å…ˆçº§çš„ã€æ—¨åœ¨é˜²æ­¢é—®é¢˜å¤å‘çš„å…·ä½“è¡ŒåŠ¨é¡¹ã€‚

æˆ‘ä»¬å»ºè®®ï¼Œåœ¨æœ¬æ¬¡å‹åŠ›æµ‹è¯•ç»“æŸåï¼Œæ— è®ºç»“æœæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½ç»„ç»‡ä¸€æ¬¡æ­£å¼çš„ Postmortemã€‚è¿™ä¸ä»…èƒ½å›ºåŒ–æœ¬æ¬¡æµ‹è¯•çš„å®è´µç»éªŒï¼Œæ›´èƒ½ä½œä¸ºä¸€ä¸ªå¥‘æœºï¼Œåœ¨å›¢é˜Ÿä¸­æ’­ä¸‹æŒç»­æ”¹è¿›ã€æ‹¥æŠ±å¤±è´¥ã€ä»å¤±è´¥ä¸­å­¦ä¹ çš„å¯é æ€§æ–‡åŒ–çš„ç§å­ã€‚è¿™ç¡®ä¿äº†æœ¬æ¬¡æµ‹è¯•çš„ä»·å€¼ï¼Œå°†è¿œè¿œè¶…å‡ºå…¶ 30 åˆ†é’Ÿçš„æ‰§è¡Œçª—å£ï¼Œæˆä¸ºå›¢é˜Ÿå·¥ç¨‹èƒ½åŠ›æˆé•¿çš„é‡è¦é‡Œç¨‹ç¢‘ã€‚
