# summary

- Streaming Pullï¼šä½¿ç”¨ Streaming Pull æ—¶ï¼Œæ¶ˆæ¯ä»¥æµå¼æ–¹å¼äº¤ä»˜ æ˜¯ä¸æ˜¯è¿™ç§æƒ…å†µä¸‹ åªèƒ½é€šè¿‡ Java Client çš„æ–¹å¼æ¥ ACK æ¶ˆæ¯.gcloud å‘½ä»¤å°±ä¸è¡Œäº†

# About Streaming Pull + Ack

åœ¨ **ä½¿ç”¨ Pub/Sub çš„ Streaming Pull æ¨¡å¼æ—¶**ï¼Œ**ç¡®å®åªèƒ½é€šè¿‡å®¢æˆ·ç«¯ä»£ç ï¼ˆå¦‚ Java å®¢æˆ·ç«¯ï¼‰æ¥æ‰§è¡Œ ACK æ“ä½œ**ï¼Œè€Œ **gcloud å‘½ä»¤æ˜¯æ— æ³•ç”¨äº ACK è¿™ç±»æ¶ˆæ¯çš„**ã€‚

---

## **âœ… åŸå› è¯´æ˜ï¼š**

### **ğŸ“Œ Streaming Pull ç‰¹æ€§ï¼š**

- æ˜¯é€šè¿‡ gRPC é•¿è¿æ¥æŒç»­æ¥æ”¶æ¶ˆæ¯çš„æœºåˆ¶ã€‚
- ä¸€èˆ¬ç”¨äº GKEã€Cloud Run ç­‰æœåŠ¡ç«¯å®¹å™¨æŒç»­æ¶ˆè´¹åœºæ™¯ã€‚
- æ¶ˆæ¯åœ¨è¢«å®¢æˆ·ç«¯å¤„ç†åï¼Œéœ€ç”±å®¢æˆ·ç«¯ **æ˜¾å¼è°ƒç”¨ ack() æ–¹æ³•** è¿›è¡Œç¡®è®¤ã€‚

---

## **âŒ ä¸ºä»€ä¹ˆ**

## **gcloud**

## 
**å‘½ä»¤ä¸é€‚ç”¨ï¼š**

gcloud pubsub subscriptions pull æ˜¯é’ˆå¯¹ **Pull æ¨¡å¼çš„è®¢é˜…è€…**ï¼Œå®ƒï¼š

- é€šè¿‡ REST API å‘èµ·ä¸€æ¬¡æ€§æ‹‰å–è¯·æ±‚ï¼›
- åªå¤„ç†å½“å‰è¯·æ±‚ä¸­è¿”å›çš„æ¶ˆæ¯ï¼›
- ä¸æ„ŸçŸ¥ gRPC Streaming Pull çš„è¿æ¥ä¸Šä¸‹æ–‡ï¼›
- æ— æ³•è·å– Streaming Pull å·²ç¼“å­˜/å¤„ç†ä¸­çš„ ackId åˆ—è¡¨ã€‚

> å› æ­¤æ— æ³•é€šè¿‡ gcloud å‘½ä»¤å» ack Streaming Pull æ¨¡å¼ä¸‹æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚

---

## **âœ… æ­£ç¡®åšæ³•ï¼ˆä»¥ Java ä¸ºä¾‹ï¼‰ï¼š**

```java
subscriber = Subscriber.newBuilder(subscriptionName, (message, consumer) -> {
    try {
        // å¤„ç†æ¶ˆæ¯
        System.out.println("Received: " + message.getData().toStringUtf8());

        // ç¡®è®¤æˆåŠŸ
        consumer.ack();  // âœ… åªæ­¤å¤„æœ‰æ•ˆ
    } catch (Exception e) {
        // å¤„ç†å¤±è´¥ï¼ˆå¯é€‰ï¼‰
        consumer.nack(); // âŒ ä¼šå¯¼è‡´æ¶ˆæ¯é‡æŠ•
    }
}).build();

subscriber.startAsync().awaitRunning();
```

---

## **ğŸ”„ è¡¥å……ï¼š**

| **æ“ä½œ** | **Pull æ¨¡å¼æ”¯æŒ** | **Streaming Pull æ”¯æŒ** |
| --- | --- | --- |
| gcloud pubsub subscriptions pull | âœ… æ˜¯ | âŒ å¦ |
| gcloud pubsub subscriptions ack | âœ… æ˜¯ï¼ˆéœ€ ackIdï¼‰ | âŒ å¦ |
| å®¢æˆ·ç«¯ ack/nack æ–¹æ³•ï¼ˆJavaã€Python ç­‰ï¼‰ | âœ… æ˜¯ | âœ… æ˜¯ |
| Metrics (ack_count ç­‰) ç›‘æ§æ”¯æŒ | âœ… æ˜¯ | âœ… æ˜¯ |

---

å¦‚ä½ æ­£åœ¨ä½¿ç”¨ GKE + Javaï¼Œç¡®ä¿è®¾ç½®åˆé€‚çš„ï¼š

- executorThreadsï¼ˆå¹¶å‘çº¿ç¨‹æ•°ï¼‰
- maxAckExtensionPeriodï¼ˆæœ€å¤§å»¶é•¿æ—¶é—´ï¼‰
- ackDeadlineï¼ˆè®¢é˜…é…ç½®çš„ ack è¶…æ—¶ï¼‰

å¯ä»¥å¸®ä½ è‡ªåŠ¨ç”Ÿæˆå®Œæ•´é…ç½®ç¤ºä¾‹æˆ– dashboard é¢æ¿æ¨¡æ¿ï¼Œå¦‚æœ‰éœ€è¦å¯ç»§ç»­å‘ŠçŸ¥ã€‚

## Grok

æ˜¯çš„ï¼Œåœ¨ä½¿ç”¨ **Streaming Pull** çš„åœºæ™¯ä¸‹ï¼Œæ¶ˆæ¯çš„ç¡®è®¤ï¼ˆACKï¼‰ä¸»è¦é€šè¿‡ **Pub/Sub å®¢æˆ·ç«¯åº“**ï¼ˆå¦‚ Java Clientï¼‰æ¥å®ç°ï¼Œ`gcloud` å‘½ä»¤æ— æ³•ç›´æ¥ç”¨äºç¡®è®¤ï¼ˆACKï¼‰æˆ–å¤„ç† Streaming Pull çš„æ¶ˆæ¯ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†åˆ†æå’Œè¯´æ˜ï¼š

### ä¸ºä»€ä¹ˆ `gcloud` å‘½ä»¤æ— æ³•ç›´æ¥ ACK æ¶ˆæ¯ï¼Ÿ

1. **Streaming Pull çš„å·¥ä½œæœºåˆ¶**ï¼š

    - Streaming Pull æ˜¯é€šè¿‡ Pub/Sub å®¢æˆ·ç«¯åº“å»ºç«‹ä¸€ä¸ªé•¿æœŸçš„ gRPC æµå¼è¿æ¥ï¼Œä»è®¢é˜…ä¸­å®æ—¶æ‹‰å–æ¶ˆæ¯ã€‚
    - å®¢æˆ·ç«¯åº“è´Ÿè´£æ¥æ”¶æ¶ˆæ¯ã€å¤„ç†æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡ API è°ƒç”¨ï¼ˆå¦‚ `acknowledge` æ–¹æ³•ï¼‰ç¡®è®¤æ¶ˆæ¯ï¼ˆACKï¼‰æˆ–æ‹’ç»æ¶ˆæ¯ï¼ˆNACKï¼‰ã€‚
    - æ¶ˆæ¯çš„ç¡®è®¤é€»è¾‘æ˜¯åŠ¨æ€çš„ï¼Œä¾èµ–äºå®¢æˆ·ç«¯çš„å¤„ç†ç»“æœï¼Œè€Œ `gcloud` å‘½ä»¤æ˜¯é™æ€çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸»è¦ç”¨äºç®¡ç†å’Œé…ç½® Pub/Sub èµ„æºï¼ˆå¦‚ä¸»é¢˜ã€è®¢é˜…ã€å¿«ç…§ç­‰ï¼‰ï¼Œä¸é€‚åˆå¤„ç†å®æ—¶æ¶ˆæ¯æµã€‚

2. **gcloud çš„å±€é™æ€§**ï¼š
    - `gcloud pubsub` å‘½ä»¤ä¸»è¦ç”¨äºç®¡ç† Pub/Sub èµ„æºï¼ˆå¦‚åˆ›å»º/åˆ é™¤ä¸»é¢˜ã€è®¢é˜…ï¼Œè°ƒæ•´é…ç½®ï¼Œä½¿ç”¨ `seek` é‡æ”¾æ¶ˆæ¯ç­‰ï¼‰ã€‚
    - æ²¡æœ‰æä¾›ç›´æ¥æ“ä½œæ¶ˆæ¯å†…å®¹æˆ–ç¡®è®¤æ¶ˆæ¯çš„å‘½ä»¤ï¼Œå› ä¸ºè¿™äº›æ“ä½œéœ€è¦å®æ—¶äº¤äº’ï¼Œè€Œ `gcloud` æ›´é€‚åˆæ‰¹é‡æˆ–é…ç½®ç®¡ç†ä»»åŠ¡ã€‚

### Streaming Pull ä¸‹å¦‚ä½•ç¡®è®¤ï¼ˆACKï¼‰æ¶ˆæ¯ï¼Ÿ

åœ¨ Streaming Pull æ¨¡å¼ä¸‹ï¼Œç¡®è®¤æ¶ˆæ¯éœ€è¦é€šè¿‡ Pub/Sub å®¢æˆ·ç«¯åº“ï¼ˆå¦‚ Java å®¢æˆ·ç«¯ï¼‰å®ç°ã€‚ä»¥ä¸‹æ˜¯ Java å®¢æˆ·ç«¯çš„å…¸å‹æµç¨‹ï¼š

1. **è®¾ç½® Streaming Pull è®¢é˜…**ï¼š

    - ä½¿ç”¨ Google Cloud Pub/Sub Java å®¢æˆ·ç«¯åº“é…ç½®è®¢é˜…ã€‚
    - ç¤ºä¾‹ä»£ç ï¼ˆJavaï¼‰ï¼š

        ```java
        import com.google.cloud.pubsub.v1.AckReplyConsumer;
        import com.google.cloud.pubsub.v1.MessageReceiver;
        import com.google.cloud.pubsub.v1.Subscriber;
        import com.google.pubsub.v1.ProjectSubscriptionName;
        import com.google.pubsub.v1.PubsubMessage;

        public class StreamingPullExample {
            public static void main(String... args) throws Exception {
                String projectId = "your-project-id";
                String subscriptionId = "your-subscription-id";
                ProjectSubscriptionName subscriptionName = ProjectSubscriptionName.of(projectId, subscriptionId);

                MessageReceiver receiver =
                    (PubsubMessage message, AckReplyConsumer consumer) -> {
                        // å¤„ç†æ¶ˆæ¯
                        System.out.println("Received message: " + message.getData().toStringUtf8());
                        // ç¡®è®¤æ¶ˆæ¯
                        consumer.ack();
                    };

                Subscriber subscriber = null;
                try {
                    subscriber = Subscriber.newBuilder(subscriptionName, receiver).build();
                    subscriber.startAsync().awaitRunning();
                    System.out.println("Subscriber is running");
                    // ä¿æŒè¿è¡Œä»¥æ¥æ”¶æ¶ˆæ¯
                    Thread.sleep(60000);
                } finally {
                    if (subscriber != null) {
                        subscriber.stopAsync();
                    }
                }
            }
        }
        ```

    - åœ¨ `MessageReceiver` çš„å›è°ƒä¸­ï¼Œé€šè¿‡ `consumer.ack()` ç¡®è®¤æ¶ˆæ¯å·²å¤„ç†ï¼Œæˆ– `consumer.nack()` æ‹’ç»æ¶ˆæ¯ï¼ˆé‡æ–°æ’é˜Ÿï¼‰ã€‚

2. **å¤šçº¿ç¨‹ç¯å¢ƒ**ï¼š

    - åœ¨æ‚¨çš„åœºæ™¯ï¼ˆGKE + Java + Streaming Pull + å¤šçº¿ç¨‹ï¼‰ï¼ŒJava å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨å¤„ç†å¤šçº¿ç¨‹å¹¶å‘æ‹‰å–æ¶ˆæ¯ã€‚
    - ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œä¾‹å¦‚ä½¿ç”¨çº¿ç¨‹æ± æˆ–åŒæ­¥æœºåˆ¶ï¼Œé¿å…ç«äº‰æ¡ä»¶å¯¼è‡´æ¶ˆæ¯æœªè¢«æ­£ç¡®ç¡®è®¤ã€‚
    - ç¤ºä¾‹é…ç½®å¤šçº¿ç¨‹ï¼š
        ```java
        Subscriber subscriber = Subscriber.newBuilder(subscriptionName, receiver)
            .setParallelPullCount(4) // è®¾ç½®å¹¶å‘æ‹‰å–çº¿ç¨‹æ•°
            .build();
        ```

3. **é”™è¯¯å¤„ç†**ï¼š
    - å¦‚æœæ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œå»ºè®®é€šè¿‡ `consumer.nack()` å°†æ¶ˆæ¯é‡æ–°æ’é˜Ÿï¼Œæˆ–ç»“åˆæ­»ä¿¡ä¸»é¢˜ï¼ˆdead-letter topicï¼‰å¤„ç†æ— æ³•å¤„ç†çš„æ¶ˆæ¯ã€‚
    - ç¤ºä¾‹è®¾ç½®æ­»ä¿¡ä¸»é¢˜ï¼ˆé€šè¿‡ `gcloud` é…ç½®ï¼‰ï¼š
        ```bash
gcloud pubsub subscriptions create SUBSCRIPTION_ID --topic=TOPIC_ID --dead-letter-topic=DEAD_LETTER_TOPIC_NAME --max-delivery-attempts=5
        ```

### ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ `gcloud` å‘½ä»¤ï¼Ÿ

è™½ç„¶ `gcloud` æ— æ³•ç›´æ¥ ACK æ¶ˆæ¯ï¼Œä½†åœ¨ä»¥ä¸‹åœºæ™¯ä¸­å¯ä»¥è¾…åŠ©ç®¡ç† Streaming Pull çš„æ¶ˆæ¯å †ç§¯ï¼š

1. **æŸ¥çœ‹å †ç§¯æ¶ˆæ¯æ•°é‡**ï¼š

    - ä½¿ç”¨ Cloud Monitoring æ£€æŸ¥æœªç¡®è®¤æ¶ˆæ¯æ•°é‡ï¼š
        ```mql
fetch pubsub_subscription
| metric 'pubsub.googleapis.com/subscription/num_undelivered_messages'
| filter (resource.subscription_id == 'YOUR_SUBSCRIPTION_ID')
| group_by 1m, [value_num_undelivered_messages_sum: sum(value.num_undelivered_messages)]
        ```
    - è¿™å¯ä»¥å¸®åŠ©åˆ¤æ–­ Streaming Pull æ˜¯å¦å› å¤„ç†å»¶è¿Ÿå¯¼è‡´æ¶ˆæ¯å †ç§¯ã€‚

2. **é‡æ”¾æˆ–æ¸…é™¤æ¶ˆæ¯ï¼ˆSeekï¼‰**ï¼š

    - å¦‚æœéœ€è¦æ‰¹é‡æ¸…é™¤æœªç¡®è®¤æ¶ˆæ¯ï¼Œå¯ä»¥ä½¿ç”¨ `seek` å‘½ä»¤å°†è®¢é˜…æ—¶é—´æˆ³è®¾ç½®ä¸ºæœªæ¥æ—¶é—´ï¼š
        ```bash
gcloud pubsub subscriptions seek SUBSCRIPTION_ID --time=2025-07-04T12:00:00Z
        ```
    - æ³¨æ„ï¼šæ­¤æ“ä½œä¼šå°†æ‰€æœ‰æœªç¡®è®¤æ¶ˆæ¯æ ‡è®°ä¸ºå·²ç¡®è®¤ï¼Œéœ€è°¨æ…ä½¿ç”¨ã€‚

3. **è°ƒæ•´è®¢é˜…é…ç½®**ï¼š
    - ä¿®æ”¹é‡è¯•ç­–ç•¥ï¼š
        ```bash
gcloud pubsub subscriptions update SUBSCRIPTION_ID --min-retry-delay=10s --max-retry-delay=600s
        ```
    - é…ç½®æ­»ä¿¡ä¸»é¢˜ï¼š
        ```bash
gcloud pubsub subscriptions update SUBSCRIPTION_ID --dead-letter-topic=DEAD_LETTER_TOPIC_NAME --max-delivery-attempts=5
        ```

### æ€»ç»“

- **Streaming Pull ä¸‹ç¡®è®¤æ¶ˆæ¯**ï¼šå¿…é¡»é€šè¿‡ Pub/Sub å®¢æˆ·ç«¯åº“ï¼ˆå¦‚ Java Clientï¼‰çš„ `ack()` æ–¹æ³•å®ç°ï¼Œ`gcloud` å‘½ä»¤æ— æ³•ç›´æ¥ ACK æ¶ˆæ¯ã€‚
- **gcloud çš„ä½œç”¨**ï¼šç”¨äºç®¡ç† Pub/Sub èµ„æºï¼ˆå¦‚ä¸»é¢˜ã€è®¢é˜…é…ç½®ã€å¿«ç…§ï¼‰æˆ–æ‰¹é‡æ“ä½œï¼ˆå¦‚ `seek` æ¸…é™¤æ¶ˆæ¯ï¼‰ï¼Œé€‚åˆè¯Šæ–­å’Œé…ç½®è°ƒæ•´ã€‚
- **å»ºè®®**ï¼š
    - åœ¨ Java åº”ç”¨ä¸­ï¼Œç¡®ä¿æ­£ç¡®å®ç° `ack()` å’Œ `nack()` é€»è¾‘ï¼Œç»“åˆæ­»ä¿¡ä¸»é¢˜å¤„ç†å¤±è´¥æ¶ˆæ¯ã€‚
    - ä½¿ç”¨ Cloud Monitoring å®šæœŸæ£€æŸ¥æ¶ˆæ¯å †ç§¯æƒ…å†µã€‚
    - åœ¨ GKE å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œè°ƒæ•´ `setParallelPullCount` å’Œçº¿ç¨‹æ± å¤§å°ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚

å¦‚æœæ‚¨éœ€è¦æ›´å…·ä½“çš„ Java ä»£ç ç¤ºä¾‹ï¼ˆä¾‹å¦‚å¤„ç†æ­»ä¿¡ä¸»é¢˜æˆ–é”™è¯¯é‡è¯•é€»è¾‘ï¼‰ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥æä¾›ä»£ç æˆ–ä¼˜åŒ–å»ºè®®ï¼

# Gemini Deepsearch

# GCP Pub/Sub æ¶ˆæ¯é˜Ÿåˆ—è¿ç»´ä¸æ·±åº¦è¯Šæ–­æƒå¨æŒ‡å—

æœ¬æŠ¥å‘Šæ—¨åœ¨ä¸ºåœ¨ Google Kubernetes Engine (GKE) ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ Java å’Œ Streaming Pull æ¨¡å¼ç®¡ç† Google Cloud Pub/Sub çš„å¼€å‘ä¸è¿ç»´å›¢é˜Ÿï¼Œæä¾›ä¸€ä»½è¯¦å°½çš„æ“ä½œä¸è¯Šæ–­æŒ‡å—ã€‚å†…å®¹æ¶µç›–ä»åŸºç¡€å‘½ä»¤åˆ°é«˜çº§æ•…éšœæ’æŸ¥çš„å…¨é“¾è·¯æŠ€æœ¯ï¼Œé‡ç‚¹è§£å†³æ¶ˆæ¯ç§¯å‹çš„è¯†åˆ«ã€åˆ†æä¸æ¸…ç†ï¼Œå¹¶ç»“åˆæ‚¨çš„æŠ€æœ¯æ ˆæä¾›é’ˆå¯¹æ€§çš„ä¼˜åŒ–å»ºè®®ã€‚

## ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€ `gcloud pubsub` æ“ä½œï¼šå‘½ä»¤è¡Œå…¥é—¨

åœ¨æ·±å…¥æ¢è®¨å¤æ‚åœºæ™¯ä¹‹å‰ï¼Œå¿…é¡»å…ˆå»ºç«‹ä¸€å¥—åšå®çš„ `gcloud` å‘½ä»¤è¡Œæ“ä½œåŸºç¡€ã€‚è¿™éƒ¨åˆ†å°†å›é¡¾ Pub/Sub çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¹¶æä¾›ç®¡ç†å…¶åŸºæœ¬èµ„æºï¼ˆTopic å’Œ Subscriptionï¼‰çš„æ ‡å‡†å‘½ä»¤ã€‚

### æ ¸å¿ƒæ¦‚å¿µå›é¡¾

- **Topic (ä¸»é¢˜):** å‘å¸ƒè€…ï¼ˆPublisherï¼‰å‘é€æ¶ˆæ¯çš„å‘½åèµ„æºã€‚å¯ä»¥å°†å…¶ç†è§£ä¸ºä¸€ä¸ªæ¶ˆæ¯é€šé“æˆ–ä¿¡æ¯æº 1ã€‚
- **Subscription (è®¢é˜…):** ä»£è¡¨ä»ä¸€ä¸ªç‰¹å®šä¸»é¢˜æµå‘è®¢é˜…è€…åº”ç”¨ç¨‹åºçš„æ¶ˆæ¯æµçš„å‘½åèµ„æºã€‚ä¸€ä¸ªä¸»é¢˜å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…ï¼Œä»è€Œå®ç°æ¶ˆæ¯çš„æ‰‡å‡ºï¼ˆfan-outï¼‰åˆ†å‘ 1ã€‚
- **Message (æ¶ˆæ¯):** å‘å¸ƒè€…å‘é€åˆ°ä¸»é¢˜ï¼Œå¹¶æœ€ç»ˆæŠ•é€’ç»™è®¢é˜…è€…çš„æ•°æ®å•å…ƒï¼Œç”±æ•°æ®æœ¬èº«å’Œå¯é€‰çš„å±æ€§ï¼ˆattributesï¼‰ç»„æˆ 6ã€‚

### ç®¡ç† Topic (æ¶ˆæ¯é€šé“)

- **åˆ—å‡º Topic:** æŸ¥çœ‹é¡¹ç›®ä¸­çš„æ‰€æœ‰ä¸»é¢˜ï¼Œæ˜¯è¿›è¡Œèµ„æºç›˜ç‚¹å’Œç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬çš„åŸºç¡€ã€‚
    - å‘½ä»¤: `gcloud pubsub topics list` 1ã€‚
    - é«˜çº§ç”¨æ³•: å½“ä¸»é¢˜æ•°é‡åºå¤§æ—¶ï¼Œå¯ä½¿ç”¨ `--limit`ã€`--page-size` å’Œ `--filter` æ ‡å¿—è¿›è¡Œåˆ†é¡µå’Œç­›é€‰ 9ã€‚
- **æè¿° Topic:** è·å–å•ä¸ªä¸»é¢˜çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¶é…ç½®ã€å…³è”çš„ schema ä»¥åŠæ ‡ç­¾ç­‰ã€‚
    - å‘½ä»¤: `gcloud pubsub topics describe TOPIC_ID` 10ã€‚
- **åˆ›å»º Topic:**
    - å‘½ä»¤: `gcloud pubsub topics create TOPIC_ID` 1ã€‚
    - èƒŒæ™¯: è¿™æ˜¯æ„å»ºä»»ä½•æ–°æ¶ˆæ¯æµçš„ç¬¬ä¸€æ­¥ã€‚åœ¨åˆ›å»ºæ—¶å¯ä»¥é…ç½®æ¶ˆæ¯ä¿ç•™æ—¶é•¿ã€å®¢æˆ·ç®¡ç†çš„åŠ å¯†å¯†é’¥ï¼ˆCMEKï¼‰ç­‰é«˜çº§å±æ€§ 3ã€‚
- **åˆ é™¤ Topic:**
    - å‘½ä»¤: `gcloud pubsub topics delete TOPIC_ID` 10ã€‚
    - æ³¨æ„: åˆ é™¤ä¸€ä¸ªä»æœ‰å…³è”è®¢é˜…çš„ä¸»é¢˜ï¼Œä¼šå¯¼è‡´è¿™äº›è®¢é˜…è¿›å…¥â€œæ¸¸ç¦»â€çŠ¶æ€ï¼Œå…¶ `topic` å­—æ®µä¼šå˜ä¸º `_deleted-topic_`ã€‚è¿™ç§æƒ…å†µå¯èƒ½å¼•å‘æ··æ·†ï¼Œéœ€è¦å¯¹è¿™äº›è®¢é˜…è¿›è¡Œé¢å¤–çš„æ‰‹åŠ¨æ¸…ç† 12ã€‚

### ç®¡ç† Subscription (æ¶ˆè´¹è€…å…¥å£)

- **åˆ—å‡º Subscription:** æŸ¥çœ‹é¡¹ç›®ä¸­çš„æ‰€æœ‰è®¢é˜…ï¼Œæˆ–ä¸ç‰¹å®šä¸»é¢˜å…³è”çš„è®¢é˜…ã€‚
    - å‘½ä»¤ (é¡¹ç›®å†…æ‰€æœ‰): `gcloud pubsub subscriptions list` 4ã€‚
    - å‘½ä»¤ (ç‰¹å®šä¸»é¢˜): `gcloud pubsub topics list-subscriptions TOPIC_ID` 10ã€‚
- **æè¿° Subscription:** è¿™æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„è¯Šæ–­å‘½ä»¤ã€‚å®ƒèƒ½æ­ç¤ºè®¢é˜…çš„è¯¦ç»†é…ç½®ï¼Œå¦‚ç¡®è®¤æˆªæ­¢æ—¶é—´ï¼ˆ`ackDeadlineSeconds`ï¼‰ã€æ¨é€/æ‹‰å–æ¨¡å¼ã€é‡è¯•ç­–ç•¥ä»¥åŠæ­»ä¿¡é˜Ÿåˆ—è®¾ç½® 5ã€‚
    - å‘½ä»¤: `gcloud pubsub subscriptions describe SUBSCRIPTION_ID`ã€‚
- **åˆ›å»º Subscription:**
    - å‘½ä»¤: `gcloud pubsub subscriptions create SUBSCRIPTION_ID --topic=TOPIC_ID` 1ã€‚
    - èƒŒæ™¯: é’ˆå¯¹æ‚¨çš„ä½¿ç”¨åœºæ™¯ï¼ˆStreaming Pullï¼‰ï¼Œä¸»è¦åˆ›å»ºçš„æ˜¯æ‹‰å–å‹è®¢é˜…ã€‚åˆ›å»ºæ—¶çš„å…³é”®æ ‡å¿—åŒ…æ‹¬ `--ack-deadline` ä»¥åŠåç»­å°†è¯¦è¿°çš„æ­»ä¿¡ç­–ç•¥ç›¸\u0000å…³æ ‡å¿— 16ã€‚
- **æ›´æ–° Subscription:** ä¿®æ”¹ç°æœ‰è®¢é˜…çš„å±æ€§ï¼Œä¾‹å¦‚è°ƒæ•´ç¡®è®¤æˆªæ­¢æ—¶é—´æˆ–æ›´æ–°æ­»ä¿¡ç­–ç•¥ã€‚
    - å‘½ä»¤: `gcloud pubsub subscriptions update SUBSCRIPTION_ID --ack-deadline=30` 17ã€‚
- **åˆ é™¤ Subscription:**
    - å‘½ä»¤: `gcloud pubsub subscriptions delete SUBSCRIPTION_ID` 18ã€‚
    - æ³¨æ„: åˆ é™¤æ“ä½œæ˜¯æ°¸ä¹…æ€§çš„ï¼Œæ— æ³•æ’¤é”€ã€‚è®¢é˜…ä¸­æ‰€æœ‰æœªç¡®è®¤çš„æ¶ˆæ¯éƒ½å°†æ°¸ä¹…ä¸¢å¤± 18ã€‚åœ¨è€ƒè™‘å°†æ­¤æ“ä½œä½œä¸ºâ€œæ¸…ç©ºé˜Ÿåˆ—â€çš„æ‰‹æ®µæ—¶ï¼Œå¿…é¡»å……åˆ†è®¤è¯†åˆ°å…¶ä¸å¯é€†çš„åæœã€‚

### å…³äº IAM (èº«ä»½ä¸è®¿é—®ç®¡ç†)

æ‰€æœ‰ `gcloud` å‘½ä»¤çš„æ‰§è¡Œéƒ½éœ€è¦é€‚å½“çš„ IAM æƒé™ã€‚`roles/pubsub.editor` è§’è‰²æä¾›äº†å¹¿æ³›çš„ç®¡ç†æƒé™ï¼Œè€Œ `roles/pubsub.viewer` åˆ™æä¾›åªè¯»è®¿é—®æƒé™ 4ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”éµå¾ªæœ€å°æƒé™åŸåˆ™ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåªè´Ÿè´£å‘å¸ƒæ¶ˆæ¯çš„æœåŠ¡è´¦å·ä»…éœ€

`roles/pubsub.publisher` è§’è‰²ï¼Œè€Œä¸€ä¸ªåªæ¶ˆè´¹æ¶ˆæ¯çš„æœåŠ¡è´¦å·ä»…éœ€ `roles/pubsub.subscriber` è§’è‰² 20ã€‚

### `gcloud pubsub` å‘½ä»¤å¿«é€Ÿå‚è€ƒ

ä¸‹è¡¨æ±‡æ€»äº†æœ€å¸¸ç”¨çš„ `gcloud pubsub` å‘½ä»¤ï¼Œä»¥ä¾¿å¿«é€ŸæŸ¥é˜…ã€‚

| èµ„æº | æ“ä½œ | `gcloud` å‘½ä»¤ç¤ºä¾‹ |
| --- | --- | --- |
| Topic | åˆ—å‡º | `gcloud pubsub topics list` |
| Topic | æè¿° | `gcloud pubsub topics describe my-topic` |
| Topic | åˆ›å»º | `gcloud pubsub topics create my-topic` |
| Topic | åˆ é™¤ | `gcloud pubsub topics delete my-topic` |
| Topic | å‘å¸ƒæ¶ˆæ¯ | `gcloud pubsub topics publish my-topic --message "Hello"` |
| Subscription | åˆ—å‡º | `gcloud pubsub subscriptions list` |
| Subscription | æè¿° | `gcloud pubsub subscriptions describe my-subscription` |
| Subscription | åˆ›å»º | `gcloud pubsub subscriptions create my-subscription --topic=my-topic` |
| Subscription | åˆ é™¤ | `gcloud pubsub subscriptions delete my-subscription` |
| Subscription | æ‹‰å–æ¶ˆæ¯ | `gcloud pubsub subscriptions pull my-subscription --limit=10` |
| Subscription | ç¡®è®¤æ¶ˆæ¯ | `gcloud pubsub subscriptions ack my-subscription --ack-ids="ack_id_1,ack_id_2"` |
| Subscription | é‡ç½®ç§¯å‹ | `gcloud pubsub subscriptions seek my-subscription --time=...` æˆ– `--snapshot=...` |
| Snapshot | åˆ—å‡º | `gcloud pubsub snapshots list` |
| Snapshot | åˆ›å»º | `gcloud pubsub snapshots create my-snapshot --subscription=my-subscription` |
| Snapshot | åˆ é™¤ | `gcloud pubsub snapshots delete my-snapshot` |

## ç¬¬äºŒéƒ¨åˆ†ï¼šè¯Šæ–­æ¶ˆæ¯ç§¯å‹ï¼šé‡åŒ–ç§¯å‹çŠ¶å†µ

æœ¬èŠ‚æ—¨åœ¨æä¾›ä¸€å¥—å®Œæ•´çš„å·¥å…·å’ŒçŸ¥è¯†ä½“ç³»ï¼Œç”¨äºç›‘æ§è®¢é˜…çš„å¥åº·çŠ¶å†µï¼Œè¯†åˆ«æ¶ˆæ¯ç§¯å‹çš„å½¢æˆï¼Œå¹¶ç†è§£ä¸åŒç§¯å‹æ¨¡å¼èƒŒåçš„æ ¹æœ¬åŸå› ã€‚è¿™æ˜¯è¿›è¡Œæœ‰æ•ˆæ•…éšœæ’æŸ¥çš„æ ¸å¿ƒè¯Šæ–­æ­¥éª¤ã€‚

### ä¸¤ä¸ªå…³é”®æŒ‡æ ‡

æ¶ˆæ¯ç§¯å‹å¹¶éå•ä¸€ç»´åº¦çš„é—®é¢˜ï¼Œå®ƒåŒæ—¶å…·æœ‰â€œè§„æ¨¡â€å’Œâ€œæ—¶æ•ˆæ€§â€ä¸¤ä¸ªç»´åº¦ã€‚Cloud Monitoring æä¾›äº†ä¸¤ä¸ªæ ¸å¿ƒæŒ‡æ ‡æ¥ç²¾ç¡®åº¦é‡è¿™ä¸¤ä¸ªæ–¹é¢ 21ã€‚

- **`pubsub.googleapis.com/subscription/num_undelivered_messages`**: è®¢é˜…ç§¯å‹ä¸­æœªç¡®è®¤æ¶ˆæ¯çš„æ•°é‡ã€‚è¿™ä¸ªæŒ‡æ ‡åæ˜ äº†ç§¯å‹çš„**è§„æ¨¡**ã€‚ä¸€ä¸ªæŒç»­é«˜ä¼çš„æ•°å€¼è¡¨æ˜æ¶ˆè´¹è€…çš„å¤„ç†é€Ÿåº¦è·Ÿä¸ä¸Šæ¶ˆæ¯çš„å‘å¸ƒé€Ÿåº¦ 24ã€‚
- **`pubsub.googleapis.com/subscription/oldest_unacked_message_age`**: ç§¯å‹ä¸­æœ€æ—©ä¸€æ¡æœªç¡®è®¤æ¶ˆæ¯çš„å¹´é¾„ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚è¿™ä¸ªæŒ‡æ ‡åæ˜ äº†ç§¯å‹çš„**é™ˆæ—§ç¨‹åº¦**ã€‚ä¸€ä¸ªæŒç»­å¾ˆé«˜æˆ–ä¸æ–­å¢é•¿çš„æ•°å€¼æ˜¯ä¸€ä¸ªä¸¥é‡çš„è­¦å‘Šä¿¡å·ï¼Œè¡¨æ˜æŸäº›æ¶ˆæ¯å¯èƒ½è¢«â€œå¡ä½â€æ— æ³•å¤„ç†ï¼Œæˆ–è€…æ•´ä½“å¤„ç†å»¶è¿Ÿæé«˜ 24ã€‚

### æŸ¥è¯¢æŒ‡æ ‡çš„æ–¹æ³•

- **é€šè¿‡ Cloud Console:** åœ¨ Pub/Sub è®¢é˜…çš„è¯¦æƒ…é¡µé¢ï¼Œæœ‰ä¸€ä¸ªâ€œæŒ‡æ ‡â€æ ‡ç­¾é¡µï¼Œå…¶ä¸­æä¾›äº†é’ˆå¯¹ä¸Šè¿°å…³é”®æŒ‡æ ‡çš„é¢„æ„å»ºå›¾è¡¨ï¼Œå¯ä»¥è¿›è¡Œå¿«é€Ÿçš„ç›®è§†æ£€æŸ¥ 30ã€‚
- **é€šè¿‡ Metrics Explorer å’Œ MQL:** å¯¹äºæ›´æ·±å…¥çš„åˆ†æï¼Œå¯ä»¥ä½¿ç”¨ Metrics Explorer æ„å»ºè‡ªå®šä¹‰å›¾è¡¨ï¼Œæˆ–ä½¿ç”¨ç›‘æ§æŸ¥è¯¢è¯­è¨€ (MQL) è¿›è¡Œç²¾ç¡®æŸ¥è¯¢ 21ã€‚
    - **ç¤ºä¾‹ MQL æŸ¥è¯¢ (è·å–ç‰¹å®šè®¢é˜…çš„æœªæŠ•é€’æ¶ˆ\u0000æ¯æ•°):**
        ```mql
fetch pubsub_subscription
| metric 'pubsub.googleapis.com/subscription/num_undelivered_messages'
| filter (resource.subscription_id == 'your-subscription-id')
| group_by 1m, [value_num_undelivered_messages_mean: mean(value.num_undelivered_messages)]
| every 1m
        ```
26

### è§£è¯»ç§¯å‹æ¨¡å¼çš„å› æœé“¾

æŒ‡æ ‡æœ¬èº«åªæ˜¯æ•°æ®ï¼ŒçœŸæ­£çš„ä»·å€¼åœ¨äºè§£è¯»å®ƒä»¬ã€‚å¦‚æœ `num_undelivered_messages` å¾ˆé«˜ä½† `oldest_unacked_message_age` å¾ˆä½ï¼Œè¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿå¦‚æœä¸¤è€…éƒ½æŒç»­å¢é•¿ï¼Œåˆæ„å‘³ç€ä»€ä¹ˆï¼Ÿé€šè¿‡ç»¼åˆåˆ†æï¼Œå¯ä»¥æ„å»ºä¸€ä¸ªè¯Šæ–­æµç¨‹å›¾ã€‚

- **åœºæ™¯ä¸€: `num_undelivered_messages` å’Œ `oldest_unacked_message_age` åŒæ—¶å¢é•¿**
    - **è¯Šæ–­:** ç³»ç»Ÿæ€§çš„æ¶ˆè´¹è€…æ€§èƒ½ç“¶é¢ˆã€‚è®¢é˜…è€…çš„æ•´ä½“å¤„ç†èƒ½åŠ›å·²æ— æ³•è·Ÿä¸Šæ¶ˆæ¯çš„å‘å¸ƒé€Ÿç‡ã€‚
    - **å¯èƒ½åŸå›  (ç»“åˆæ‚¨çš„ GKE/Java æŠ€æœ¯æ ˆ):**
        1. **æ¶ˆè´¹è€…èµ„æºä¸è¶³:** GKE Pod é­é‡äº† CPU æˆ–å†…å­˜çš„é™åˆ¶ä¸èŠ‚æµ (throttling)ï¼Œå¯¼è‡´å¤„ç†èƒ½åŠ›ä¸‹é™ï¼ˆè¯¦è§ç¬¬å…­éƒ¨åˆ†ï¼‰27ã€‚
        2. **ä¸‹æ¸¸ä¾èµ–ç“¶é¢ˆ:** Java åº”ç”¨ç¨‹åºåœ¨ç­‰å¾…ä¸€ä¸ªç¼“æ…¢çš„æ•°æ®åº“æŸ¥è¯¢æˆ–å¤–éƒ¨ API è°ƒç”¨ï¼Œé˜»å¡äº†æ¶ˆæ¯å¤„ç†çº¿ç¨‹ã€‚
        3. **ä»£ç æ•ˆç‡ä½ä¸‹:** è¿‘æœŸéƒ¨ç½²çš„ä»£ç å˜æ›´å¼•å…¥äº†æ€§èƒ½å›å½’ï¼Œé™ä½äº†æ¶ˆæ¯å¤„ç†é€»è¾‘çš„æ•ˆç‡ 25ã€‚
- **åœºæ™¯äºŒ: `num_undelivered_messages` ç¨³å®šåœ¨è¾ƒé«˜æ°´å¹³ï¼Œè€Œ `oldest_unacked_message_age` æŒç»­å¢é•¿**
    - **è¯Šæ–­:** â€œæ¯’ä¸¸â€æ¶ˆæ¯ (Poison Pill) æˆ–ç‰¹å®šæ¶ˆæ¯å¤„ç†å¤±è´¥ã€‚å¤§éƒ¨åˆ†æ¶ˆæ¯éƒ½èƒ½è¢«æ­£å¸¸å¤„ç†ï¼Œä½†æœ‰ä¸€æ¡æˆ–å‡ æ¡ç‰¹å®šçš„æ¶ˆæ¯å¯¼è‡´æ¶ˆè´¹è€…ç¨‹åºå‡ºé”™ã€ä¸»åŠ¨ `nack()` æ¶ˆæ¯ï¼Œæˆ–ä½¿å…¶ç¡®è®¤è¶…æ—¶ã€‚éšå Pub/Sub ä¼šé‡æ–°æŠ•é€’è¯¥æ¶ˆæ¯ï¼Œå½¢æˆæ¶æ€§å¾ªç¯ã€‚
    - **å¯èƒ½åŸå› :**
        1. æ¶ˆæ¯ä½“æ ¼å¼é”™è¯¯ï¼Œä¾‹å¦‚ä¸€ä¸ªç•¸å½¢çš„ JSONï¼Œå¯¼è‡´ Java ä»£ç æ— æ³•è§£æã€‚
        2. æŸæ¡æ¶ˆæ¯çš„å†…å®¹è§¦å‘äº†æ¶ˆè´¹è€…é€»è¾‘ä¸­çš„ä¸€ä¸ªç‰¹å®š bug æˆ–æœªå¤„ç†çš„å¼‚å¸¸ã€‚
        3. æ¶ˆè´¹è€…ä»£ç åå¤å¯¹æŸæ¡æ¶ˆæ¯è°ƒç”¨ `nack()`ï¼Œè¿™æ˜ç¡®åœ°æŒ‡ç¤º Pub/Sub é‡æ–°æŠ•é€’è¯¥æ¶ˆæ¯ 27ã€‚
- **åœºæ™¯ä¸‰: `num_undelivered_messages` å‡ºç°çŸ­æš‚å°–å³°åæ¢å¤æ­£å¸¸**
    - **è¯Šæ–­:** ç¬æ—¶æµé‡çªå¢ã€‚è¿™é€šå¸¸æ˜¯æ­£å¸¸ç°è±¡ï¼Œä¹Ÿæ­£æ˜¯ Pub/Sub è¿™ç±»æ¶ˆæ¯ç³»ç»Ÿè®¾è®¡çš„ç›®çš„æ‰€åœ¨â€”â€”å‰Šå³°å¡«è°·ã€‚ç³»ç»Ÿå¸æ”¶äº†æµé‡æ´ªå³°ï¼Œæ¶ˆè´¹è€…éšç€æ—¶é—´æ¨ç§»ä¼šé€æ­¥èµ¶ä¸Šå¤„ç†è¿›åº¦ã€‚
    - **åº”å¯¹:** é€šå¸¸æ— éœ€å¹²é¢„ï¼Œé™¤éæ¢å¤æ—¶é—´è¶…å‡ºäº†ä¸šåŠ¡çš„æœåŠ¡ç­‰çº§ç›®æ ‡ (SLO)ã€‚é€šè¿‡è°ƒæ•´æ¶ˆè´¹è€…å®¢æˆ·ç«¯çš„æµæ§è®¾ç½®å¯ä»¥æ›´å¥½åœ°åº”å¯¹è¿™ç§æƒ…å†µ 25ã€‚

### å»ºç«‹ä¸»åŠ¨å‘Šè­¦

åˆ©ç”¨ Cloud Monitoring ä¸ºå…³é”®æŒ‡æ ‡åˆ›å»ºå‘Šè­¦ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œå½“ `oldest_unacked_message_age` è¶…è¿‡ä¸€ä¸ªè®¾å®šçš„é˜ˆå€¼ï¼ˆå¦‚ 600 ç§’ï¼‰æ—¶è§¦å‘å‘Šè­¦ï¼Œå› ä¸ºè¿™å‡ ä¹æ€»æ˜¯é—®é¢˜çš„å¾å…† 30ã€‚

### å…³é”® Pub/Sub ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | MQL æ ‡è¯†ç¬¦ | æè¿° | è¿ç»´æ´å¯Ÿ |
| --- | --- | --- | --- |
| æœªç¡®è®¤æ¶ˆæ¯æ•° | `pubsub.googleapis.com/subscription/num_undelivered_messages` | è®¢é˜…ä¸­æœªè¢«ç¡®è®¤çš„æ¶ˆæ¯æ€»æ•°ã€‚ | **ç§¯å‹è§„æ¨¡**ï¼šåæ˜ æ¶ˆè´¹è€…æ˜¯å¦èƒ½è·Ÿä¸Šå‘å¸ƒé€Ÿç‡ã€‚æŒç»­å¢é•¿è¡¨ç¤ºå¤„ç†èƒ½åŠ›ä¸è¶³ã€‚ |
| æœ€è€æœªç¡®è®¤æ¶ˆæ¯å¹´é¾„ | `pubsub.googleapis.com/subscription/oldest_unacked_message_age` | è®¢é˜…ä¸­æœ€è€ä¸€æ¡æœªç¡®è®¤æ¶ˆæ¯çš„å¹´é¾„ï¼ˆç§’ï¼‰ã€‚ | **ç§¯å‹å¥åº·åº¦**ï¼šåæ˜ æ¶ˆæ¯å¤„ç†çš„åœæ»æƒ…å†µã€‚æŒç»­å¢é•¿æ˜¯ä¸¥é‡è­¦æŠ¥ï¼Œå¯èƒ½å­˜åœ¨â€œæ¯’ä¸¸â€æ¶ˆæ¯æˆ–å¤„ç†å®Œå…¨é˜»å¡ã€‚ |
| æ¨é€è¯·æ±‚è®¡æ•° | `pubsub.googleapis.com/subscription/push_request_count` | ï¼ˆé€‚ç”¨äº Push è®¢é˜…ï¼‰æŒ‰å“åº”ç åˆ†ç»„çš„æ¨é€å°è¯•æ¬¡æ•°ã€‚ | **æ¨é€ç«¯ç‚¹å¥åº·åº¦**ï¼šé«˜é”™è¯¯ç ç‡ï¼ˆå¦‚ 5xxï¼‰ç›´æ¥å¯¼è‡´æ¶ˆæ¯ç§¯å‹ã€‚ |
| æŠ•é€’å»¶è¿Ÿå¥åº·åˆ† | `pubsub.googleapis.com/subscription/delivery_latency_health_score` | ä¸€ä¸ªç»¼åˆåˆ†æ•°ï¼Œè¡¡é‡è®¢é˜…çš„æŠ•é€’å»¶è¿Ÿå¥åº·çŠ¶å†µã€‚ | **å»¶è¿Ÿæ ¹å› åˆ†æ**ï¼šå¸®åŠ©è¯†åˆ«å¯¼è‡´æŠ•é€’å»¶è¿Ÿå¢åŠ çš„å› ç´  30ã€‚ |
| ç¡®è®¤æˆªæ­¢æ—¥æœŸè¿‡æœŸè®¡æ•° | `pubsub.googleapis.com/subscription/expired_ack_deadlines_count` | æ¶ˆæ¯å› è¶…å‡ºç¡®è®¤æˆªæ­¢æ—¶é—´è€Œè¿‡æœŸçš„æ¬¡æ•°ã€‚ | **å¤„ç†è¶…æ—¶**ï¼šè¯¥å€¼éé›¶è¡¨ç¤ºæ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯è¿‡æ…¢ï¼Œæˆ–å®¢æˆ·ç«¯æµæ§è®¾ç½®ä¸å½“ï¼Œå¯¼è‡´æ¶ˆæ¯è¢«é‡å¤æŠ•é€’ã€‚ |

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šçª¥æ¢é˜Ÿåˆ—å†…éƒ¨ï¼šæ‰‹åŠ¨æ¶ˆæ¯æ£€æŸ¥

æœ¬èŠ‚å°†æä¾›å®‰å…¨æœ‰æ•ˆçš„æ–¹æ³•ï¼Œç”¨äºæ‰‹åŠ¨æ‹‰å–å’Œæ£€æŸ¥è®¢é˜…ä¸­çš„å•ä¸ªæ¶ˆæ¯ã€‚è¿™å¯¹äºè°ƒè¯•åœ¨ä¸Šä¸€èŠ‚ä¸­è¯†åˆ«å‡ºçš„â€œæ¯’ä¸¸â€æ¶ˆæ¯åœºæ™¯è‡³å…³é‡è¦ã€‚

### `gcloud pubsub subscriptions pull` å‘½ä»¤æ·±åº¦è§£æ

è¯¥å‘½ä»¤æ˜¯è¿›è¡Œæ‰‹åŠ¨æ£€æŸ¥çš„ä¸»è¦å·¥å…· 1ã€‚

- **é»˜è®¤è¡Œä¸º:** é»˜è®¤æƒ…å†µä¸‹ï¼Œ`pull` å‘½ä»¤**ä¸ä¼š**ç¡®è®¤æ¶ˆæ¯ã€‚å®ƒä¼šè¿”å›æ¶ˆæ¯çš„æ•°æ®ã€å±æ€§ä»¥åŠä¸€ä¸ªå”¯ä¸€çš„ `ackId` 1ã€‚æ¶ˆæ¯åœ¨è®¢é˜…ä¸­ä¿æŒæœªç¡®è®¤çŠ¶æ€ï¼Œå¹¶åœ¨å…¶ç¡®è®¤æˆªæ­¢æ—¶é—´ï¼ˆack deadlineï¼‰åˆ°æœŸåè¢«é‡æ–°æŠ•é€’ã€‚è¿™å¯¹äºæ£€æŸ¥è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨åœ¨ä¸â€œæ¶ˆè´¹â€æ¶ˆæ¯çš„æƒ…å†µä¸‹â€œçª¥è§†â€å…¶å†…å®¹ã€‚
    - å‘½ä»¤: `gcloud pubsub subscriptions pull YOUR_SUBSCRIPTION_ID --limit=1`
- **è‡ªåŠ¨ç¡®è®¤:** `--auto-ack` æ ‡å¿—ç”¨äºåœ¨ä¸€ä¸ªæ­¥éª¤ä¸­å®Œæˆæ‹‰å–å’Œæ¶ˆè´¹ã€‚è¿™å¯¹äºç®€å•çš„æ¶ˆè´¹è„šæœ¬å¾ˆæœ‰ç”¨ï¼Œä½†åœ¨ç”Ÿäº§è®¢é˜…ä¸Šè¿›è¡Œè°ƒè¯•æ—¶åº”è°¨æ…ä½¿ç”¨ 1ã€‚
    - å‘½ä»¤: `gcloud pubsub subscriptions pull YOUR_SUBSCRIPTION_ID --limit=1 --auto-ack`
- **æ ¼å¼åŒ–è¾“å‡º:** ä½¿ç”¨ `--format` æ ‡å¿—å¯ä»¥ä»…æå–æ¶ˆæ¯æ•°æ®ï¼Œä»¥ä¾¿äºæŸ¥çœ‹æˆ–å¤„ç†ã€‚è¯·æ³¨æ„ï¼Œè¿”å›çš„æ•°æ®æ˜¯ Base64 ç¼–ç çš„ï¼Œéœ€è¦è¿›è¡Œè§£ç  35ã€‚
    - è·å–è§£ç åæ•°æ®çš„å‘½ä»¤: `gcloud pubsub subscriptions pull YOUR_SUBSCRIPTION_ID --format="value(message.data)" | base64 -d`

### â€œé—´è°è®¢é˜…â€æŠ€æœ¯ï¼šå®ç°å®‰å…¨çš„å®æ—¶è°ƒè¯•

åœ¨è°ƒè¯•å®æ—¶ç³»ç»Ÿæ—¶ï¼Œä¸€ä¸ªä¸»è¦æŒ‘æˆ˜æ˜¯æ£€æŸ¥æ¶ˆæ¯ï¼ˆå³æ‹‰å–å®ƒï¼‰ä¼šæš‚æ—¶å°†å…¶ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œä»è€Œé˜»æ­¢äº†çœŸæ­£çš„æ¶ˆè´¹è€…æ¥æ”¶å®ƒã€‚è¿™ä¼šå¹²æ‰°æ‚¨æ­£åœ¨å°è¯•è°ƒè¯•çš„ç³»ç»Ÿã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åˆ©ç”¨ Pub/Sub ä¸»é¢˜å‘å…¶æ‰€æœ‰è®¢é˜…å¹¿æ’­æ¶ˆæ¯çš„ç‰¹æ€§ã€‚é€šè¿‡ä¸ºåŒä¸€ä¸»é¢˜åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ã€é¢å¤–çš„è®¢é˜…ï¼Œå¯ä»¥å®ç°å¯¹æ¶ˆæ¯æµçš„æ— ä¾µå…¥å¼è§‚å¯Ÿã€‚è¿™ä¸ªâ€œé—´è°â€è®¢é˜…å°†æ¥æ”¶åˆ°è‡ªå…¶åˆ›å»ºä¹‹åå‘å¸ƒçš„æ‰€æœ‰æ¶ˆæ¯çš„å‰¯æœ¬ï¼Œä»è€Œå…è®¸å®‰å…¨åœ°æ‹‰å–å’Œæ£€æŸ¥ï¼Œè€Œä¸ä¼šå½±å“ä¸»åº”ç”¨ç¨‹åºçš„è®¢é˜… 36ã€‚

- **åˆ†æ­¥æ“ä½œæµç¨‹:**
    1. è¯†åˆ«é—®é¢˜è®¢é˜…çš„ä¸»é¢˜:

        ```bash
gcloud pubsub subscriptions describe PRIMARY_SUB_ID --format="value(topic)"
        ```

    2. ä¸ºè¯¥ä¸»é¢˜åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„â€œé—´è°â€è®¢é˜…:

        ```bash
gcloud pubsub subscriptions create spy-subscription --topic=TOPIC_ID 36
        ```

    3. å‘å¸ƒä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼Œæˆ–ç­‰å¾…ä¸€æ¡æœ‰é—®é¢˜çš„æ¶ˆæ¯è¢«å‘å¸ƒã€‚
    4. ä»é—´è°è®¢é˜…ä¸­å®‰å…¨åœ°æ‹‰å–æ¶ˆæ¯è¿›è¡Œæ£€æŸ¥:

        ```bash
gcloud pubsub subscriptions pull spy-subscription --limit=1
        ```

    5. è°ƒè¯•å®Œæˆåï¼Œåˆ é™¤é—´è°è®¢é˜…ï¼Œä»¥é¿å…ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—å’Œæ¶ˆæ¯ç§¯å‹:

        ```bash
gcloud pubsub subscriptions delete spy-subscription
        ```

### ç²¾ç¡®æ§åˆ¶ï¼šæ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯

åœ¨ä½¿ç”¨ä¸å¸¦ `--auto-ack` çš„ `pull` å‘½ä»¤æ£€æŸ¥æ¶ˆæ¯åï¼Œæ‚¨å¯èƒ½ä¼šå†³å®šéœ€è¦ä»é˜Ÿåˆ—ä¸­ç§»é™¤å®ƒã€‚è¿™å¯ä»¥é€šè¿‡ `ack` å‘½ä»¤å’Œä» `pull` å“åº”ä¸­è·å–çš„ `ackId` æ¥å®Œæˆã€‚

- å‘½ä»¤: `gcloud pubsub subscriptions ack YOUR_SUBSCRIPTION_ID --ack-ids=ACK_ID_FROM_PULL_COMMAND` 1
- **åº”ç”¨åœºæ™¯:** æ­¤æ–¹æ³•éå¸¸é€‚åˆåœ¨é€šè¿‡æ£€æŸ¥è¯†åˆ«å‡ºä¸€æ¡å·²çŸ¥çš„â€œæ¯’ä¸¸â€æ¶ˆæ¯åï¼Œæ‰‹åŠ¨å°†å…¶ç§»é™¤ã€‚

## ç¬¬å››éƒ¨åˆ†ï¼šæ¸…ç†ä¸æ¸…é™¤æ¶ˆæ¯ç§¯å‹çš„ç­–ç•¥

æœ¬èŠ‚æ—¨åœ¨æä¾›æ¸…æ™°ã€å¯æ“ä½œçš„ç­–ç•¥ï¼Œç”¨äºæ¸…é™¤è®¢é˜…ä¸­ç§¯å‹çš„æ‰€æœ‰æœªç¡®è®¤æ¶ˆæ¯ï¼Œå¹¶å¯¹ä¸¤ç§ä¸»è¦æ–¹æ³•åŠå…¶å½±å“è¿›è¡Œæ·±å…¥æ¯”è¾ƒã€‚

### æ³¨æ„ï¼šPub/Sub æ²¡æœ‰ç›´æ¥çš„ `purge` å‘½ä»¤

ä¸€ä¸ªå¸¸è§çš„è¯¯è§£æ˜¯å¯»æ‰¾ä¸€ä¸ªç±»ä¼¼ `purge` æˆ– `clear` çš„å‘½ä»¤æ¥æ¸…ç©ºé˜Ÿåˆ—ã€‚ç„¶è€Œï¼ŒPub/Sub å¹¶æœªæä¾›è¿™æ ·çš„ç›´æ¥å‘½ä»¤ 37ã€‚æ¸…é™¤ç§¯å‹æ¶ˆæ¯çš„æœºåˆ¶æ˜¯é—´æ¥ä½†åŠŸèƒ½å¼ºå¤§çš„ã€‚ä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•ï¼šä½¿ç”¨

`seek` æ“ä½œé‡ç½®åˆ°æŸä¸ªæ—¶é—´ç‚¹ï¼Œä»¥åŠåˆ é™¤å¹¶é‡å»ºè®¢é˜…ã€‚ç†è§£è¿™ä¸¤ç§ç­–ç•¥çš„å·®å¼‚è‡³å…³é‡è¦ã€‚

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ `gcloud pubsub subscriptions seek` è¿›è¡Œç²¾ç¡®æ¸…é™¤

- **æ¦‚å¿µ:** `seek` æ“ä½œå¯ä»¥ä¿®æ”¹è®¢é˜…ä¸­æ¶ˆæ¯çš„ç¡®è®¤çŠ¶æ€ã€‚é€šè¿‡ `seek` åˆ°ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´æˆ³ï¼Œæ‚¨å¯ä»¥æœ‰æ•ˆåœ°å°†æ‰€æœ‰åœ¨è¯¥æ—¶é—´ç‚¹ä¹‹å‰å‘å¸ƒçš„æ¶ˆæ¯æ ‡è®°ä¸ºâ€œå·²ç¡®è®¤â€ï¼Œä»è€Œå°†å®ƒä»¬ä»å¾…æŠ•é€’çš„ç§¯å‹ä¸­ç§»é™¤ 37ã€‚
- **æ¸…é™¤æ‰€æœ‰æœªç¡®è®¤æ¶ˆæ¯:** `seek` åˆ°å½“å‰æ—¶é—´æˆ–æœªæ¥çš„æŸä¸ªæ—¶é—´ç‚¹ã€‚è¿™ä¸ªæ“ä½œçš„è¯­ä¹‰æ˜¯ï¼šâ€œå°†æˆªè‡³æ­¤åˆ»æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯éƒ½è§†ä¸ºå·²ç¡®è®¤ï¼Œä¸è¦å†æŠ•é€’å®ƒä»¬ã€‚â€
    - å‘½ä»¤ (ä½¿ç”¨æœªæ¥ä¸€åˆ†é’Ÿçš„æ—¶é—´æˆ³): `gcloud pubsub subscriptions seek YOUR_SUBSCRIPTION_ID --time=$(date -u -d'1 minute' +%Y-%m-%dT%H:%M:%SZ)` 37
- **å½±å“:** è¿™æ˜¯ä¸€ä¸ªå¯¹è®¢é˜…çš„â€œå°±åœ°â€ä¿®æ”¹ã€‚å®ƒé€šå¸¸é€Ÿåº¦å¾ˆå¿«ï¼Œå¹¶ä¿ç•™äº†è®¢é˜…çš„æ‰€æœ‰é…ç½®å’Œèº«ä»½æ ‡è¯†ã€‚è¿™æ˜¯æ¨èçš„ã€æœ€å®‰å…¨çš„æ¸…é™¤ç§¯å‹çš„æ–¹æ³•ã€‚

### æ–¹æ³•äºŒï¼šâ€œæ ¸å¼¹â€é€‰é¡¹ - åˆ é™¤å¹¶é‡å»ºè®¢é˜…

- **æ¦‚å¿µ:** åˆ é™¤ä¸€ä¸ªè®¢é˜…ä¼šæ°¸ä¹…æ€§åœ°ç§»é™¤å®ƒåŠå…¶ç§¯å‹çš„æ‰€æœ‰æœªç¡®è®¤æ¶ˆæ¯ 18ã€‚ç„¶åç”¨ç›¸åŒçš„åç§°å’Œé…ç½®é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„è®¢é˜…ï¼Œå¯ä»¥å®ç°â€œä»é›¶å¼€å§‹â€ã€‚
- **æ“ä½œæµç¨‹:**
    1. `gcloud pubsub subscriptions delete YOUR_SUBSCRIPTION_ID` 18
    2. `gcloud pubsub subscriptions create YOUR_SUBSCRIPTION_ID --topic=YOUR_TOPIC_ID [..å…¶ä»–é…ç½®æ ‡å¿—..]` 1
- **å…³é”®å½±å“ä¸é£é™©:**
    - **å…¨æ–°å®ä½“:** æ–°åˆ›å»ºçš„è®¢é˜…ä¸æ—§è®¢é˜…å®Œå…¨æ— å…³ï¼Œä¸ç»§æ‰¿ä»»ä½•å†å²çŠ¶æ€ 18ã€‚
    - **é‡å»ºå»¶è¿Ÿä¸é”™è¯¯:** åœ¨åˆ é™¤åç«‹å³ç”¨åŒåé‡å»ºèµ„æºï¼Œå¯èƒ½ä¼šé‡åˆ°çŸ­æš‚çš„å»¶è¿Ÿæˆ– API é”™è¯¯ 13ã€‚è¿™å¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…åœ¨çŸ­æ—¶é—´å†…æ— æ³•è¿æ¥ï¼Œé€ æˆæœåŠ¡ä¸­æ–­ã€‚
    - **æ¶ˆæ¯ä¸¢å¤±é£é™©:** åœ¨è®¢é˜…è¢«åˆ é™¤å’Œé‡æ–°åˆ›å»ºä¹‹é—´çš„è¿™ä¸ªæ—¶é—´çª—å£å†…ï¼Œå‘å¸ƒåˆ°ä¸»é¢˜çš„ä»»ä½•æ¶ˆæ¯éƒ½å°†å¯¹è¿™ä¸ªè®¢é˜…ä¸¢å¤±ï¼Œé™¤éä¸»é¢˜æœ¬èº«é…ç½®äº†æ¶ˆæ¯ä¿ç•™ 41ã€‚

### ç§¯å‹æ¸…ç†æ–¹æ³•å¯¹æ¯” (`seek` vs. `delete/recreate`)

| ç‰¹æ€§ | æ–¹æ³•ä¸€: `seek --time` | æ–¹æ³•äºŒ: `delete` & `recreate` |
| --- | --- | --- |
| **å‘½ä»¤** | `gcloud pubsub subscriptions seek my-sub --time=...` | gcloud pubsub subscriptions delete my-sub<br><br>gcloud pubsub subscriptions create my-sub --topic=... |
| **å¯¹ç§¯å‹çš„å½±å“** | å°†æŒ‡å®šæ—¶é—´å‰çš„æ‰€æœ‰æ¶ˆæ¯æ ‡è®°ä¸ºå·²ç¡®è®¤ï¼Œä»é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚ | æ°¸ä¹…åˆ é™¤æ•´ä¸ªè®¢é˜…ï¼ŒåŒ…æ‹¬æ‰€æœ‰ç§¯å‹æ¶ˆæ¯ã€‚ |
| **æ¶ˆæ¯ä¸¢å¤±é£é™©** | ä½ã€‚ä»…å½±å“è¯¥è®¢é˜…å†…çš„æ¶ˆæ¯çŠ¶æ€ï¼Œä¸å½±å“ä¸»é¢˜ã€‚ | **é«˜**ã€‚åœ¨åˆ é™¤å’Œé‡å»ºæœŸé—´å‘å¸ƒçš„æ¶ˆæ¯ä¼šä¸¢å¤±ã€‚ |
| **æœåŠ¡ä¸­æ–­** | æ— ã€‚æ“ä½œæ˜¯å°±åœ°çš„ï¼Œæ¶ˆè´¹è€…è¿æ¥ä¸å—å½±å“ã€‚ | æœ‰ã€‚å­˜åœ¨çŸ­æš‚çš„è®¢é˜…ä¸å¯ç”¨çª—å£ã€‚ |
| **é£é™©ç­‰çº§** | **ä½** | **é«˜** |
| **\u0000ç†æƒ³åº”ç”¨åœºæ™¯** | **æ¨èçš„å¸¸è§„æ–¹æ³•**ã€‚å¿«é€Ÿã€å®‰å…¨åœ°æ¸…é™¤ç§¯å‹ï¼ŒåŒæ—¶ä¿ç•™è®¢é˜…é…ç½®ã€‚ | ç´§æ€¥æƒ…å†µä¸‹çš„æœ€åæ‰‹æ®µï¼Œå½“ `seek` ä¸å¯ç”¨æˆ–éœ€è¦å½»åº•é‡ç½®æ—¶ï¼Œä¸”èƒ½æ¥å—çŸ­æš‚ä¸­æ–­å’Œæ¶ˆæ¯ä¸¢å¤±é£é™©ã€‚ |

## ç¬¬äº”éƒ¨åˆ†ï¼šé«˜çº§å¼¹æ€§æ¨¡å¼ï¼šæ­»ä¿¡é˜Ÿåˆ—ä¸å¿«ç…§

æœ¬èŠ‚å°†ä»‹ç»ä¸¤ç§å¼ºå¤§çš„ã€ç”¨äºæ„å»ºæ›´å…·å¼¹æ€§å’Œå¯æ¢å¤æ€§çš„ç³»ç»Ÿçš„ä¸»åŠ¨åŠŸèƒ½ï¼Œå¸®åŠ©æ‚¨ä»è¢«åŠ¨ä¿®å¤è½¬å‘ä¸»åŠ¨é˜²å¾¡ã€‚

### ä½¿ç”¨æ­»ä¿¡é˜Ÿåˆ— (DLQ) å¤„ç†â€œæ¯’ä¸¸â€æ¶ˆæ¯

- **æ¦‚å¿µ:** ä¸å…¶è®©ä¸€æ¡æ— æ³•å¤„ç†çš„â€œæ¯’ä¸¸â€æ¶ˆæ¯åœ¨ç³»ç»Ÿä¸­æ— ä¼‘æ­¢åœ°å¾ªç¯é‡è¯•ï¼Œä¸å¦‚é…ç½®è®¢é˜…ï¼Œåœ¨ç»è¿‡ä¸€å®šæ¬¡æ•°çš„å¤±è´¥æŠ•é€’åï¼Œè‡ªåŠ¨å°†å…¶è½¬å‘åˆ°ä¸€ä¸ªä¸“é—¨çš„â€œæ­»ä¿¡â€ä¸»é¢˜ 42ã€‚è¿™èƒ½æœ‰æ•ˆéš”ç¦»é—®é¢˜æ¶ˆæ¯ï¼Œè®©ä¸»æ¶ˆè´¹è€…å¯ä»¥ç»§ç»­å¤„ç†å¥åº·çš„ä¸šåŠ¡æ¶ˆæ¯ã€‚
- **é€šè¿‡ `gcloud` é…ç½®:**
    1. **åˆ›å»ºæ­»ä¿¡ä¸»é¢˜:** `gcloud pubsub topics create my-dead-letter-topic` 42
    2. **ä¸ºæ­»ä¿¡ä¸»é¢˜åˆ›å»ºè®¢é˜… (ç”¨äºæ£€æŸ¥æ­»ä¿¡):** `gcloud pubsub subscriptions create my-dead-letter-sub --topic=my-dead-letter-topic` 42
    3. **æ›´æ–°ä¸»è®¢é˜…ä»¥ä½¿ç”¨ DLQ:** å…³é”®æ˜¯ `--max-delivery-attempts` æ ‡å¿—ï¼Œå…¶å€¼å¿…é¡»åœ¨ 5 åˆ° 100 ä¹‹é—´ 16ã€‚

        - å‘½ä»¤: `gcloud pubsub subscriptions update PRIMARY_SUB_ID --dead-letter-topic=my-dead-letter-topic --max-delivery-attempts=5` 17
- ä¸€ä¸ªå®¹æ˜“è¢«å¿½ç•¥çš„ IAM è¦æ±‚:
    ä¸€ä¸ªå¸¸è§çš„é™·é˜±æ˜¯ï¼Œé…ç½®äº†æ­»ä¿¡ç­–ç•¥åå‘ç°å®ƒå¹¶æœªç”Ÿæ•ˆã€‚å…¶æ ¹æœ¬åŸå› åœ¨äºï¼Œæ‰§è¡Œâ€œå°†æ¶ˆæ¯è½¬å‘åˆ°æ­»ä¿¡ä¸»é¢˜â€è¿™ä¸ªåŠ¨ä½œçš„å®ä½“ï¼Œå¹¶éæ‚¨åº”ç”¨ç¨‹åºçš„æœåŠ¡è´¦å·ï¼Œè€Œæ˜¯ä¸€ä¸ªç”± Google æ‰˜ç®¡çš„ã€ç‰¹æ®Šçš„ Pub/Sub æœåŠ¡ä»£ç†ï¼ˆService Agentï¼‰ã€‚å…¶æ ¼å¼ä¸º service-{project-number}@gcp-sa-pubsub.iam.gserviceaccount.comã€‚è¿™ä¸ªæœåŠ¡ä»£ç†å¿…é¡»æ‹¥æœ‰å¯¹æ­»ä¿¡ä¸»é¢˜çš„ pubsub.publisher æƒé™ï¼Œä»¥åŠå¯¹æºè®¢é˜…çš„ pubsub.subscriber æƒé™ï¼Œæ‰èƒ½æ­£å¸¸å·¥ä½œ 43ã€‚è™½ç„¶é€šè¿‡ Cloud Console æ“ä½œæ—¶ï¼Œè¿™äº›æƒé™å¯èƒ½è¢«è‡ªåŠ¨æˆäºˆï¼Œä½†åœ¨ä½¿ç”¨ CLI æˆ–åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆIaCï¼‰å·¥å…·æ—¶ï¼Œè¿™é€šå¸¸æ˜¯ä¸€ä¸ªéœ€è¦æ‰‹åŠ¨å®Œæˆçš„å…³é”®æ­¥éª¤ã€‚
    - æˆäºˆå¿…è¦æƒé™çš„å‘½ä»¤:
        ```bash
gcloud pubsub topics add-iam-policy-binding my-dead-letter-topic --member="serviceAccount:service-PROJECT_NUMBER@gcp-sa-pubsub.iam.gserviceaccount.com" --role="roles/pubsub.publisher" 43
        ```

### ä½¿ç”¨å¿«ç…§ (Snapshot) è¿›è¡ŒçŠ¶æ€ç®¡ç†ä¸æ¶ˆæ¯é‡æ”¾

- **æ¦‚å¿µ:** å¿«ç…§æ•è·äº†è®¢é˜…åœ¨ç‰¹å®šæ—¶é—´ç‚¹çš„ç¡®è®¤çŠ¶æ€ã€‚å®ƒæ˜¯ä¸€ä¸ªâ€œä¿å­˜ç‚¹â€ï¼Œä¿ç•™äº†ä»é‚£ä¸€åˆ»èµ·æ‰€æœ‰æœªç¡®è®¤çš„æ¶ˆæ¯ 47ã€‚éšåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨
    `seek` æ“ä½œå°†è¯¥è®¢é˜…ï¼ˆç”šè‡³å¦ä¸€ä¸ªè®¢é˜…ï¼‰æ¢å¤åˆ°è¿™ä¸ªä¿å­˜çš„çŠ¶æ€ã€‚
- **åº”ç”¨åœºæ™¯:**
    1. **ä»é”™è¯¯çš„éƒ¨ç½²ä¸­æ¢å¤:** æ‚¨çš„æ¶ˆè´¹è€…ä»£ç ä¸­å­˜åœ¨ä¸€ä¸ª bugï¼Œå¯¼è‡´å®ƒé”™è¯¯åœ° `ack` äº†æ¶ˆæ¯è€Œæ²¡æœ‰å®é™…å¤„ç†ã€‚æ‚¨å¯ä»¥ `seek` å›åˆ°éƒ¨ç½²å‰åˆ›å»ºçš„å¿«ç…§ï¼Œä»¥å¼ºåˆ¶é‡æ–°æŠ•é€’è¿™äº›è¢«é”™è¯¯ç¡®è®¤çš„æ¶ˆæ¯ 40ã€‚
    2. **ä¸ºæ–°ç¯å¢ƒå¡«å……æ•°æ®:** ä¸ºæµ‹è¯•ç¯å¢ƒåˆ›å»ºä¸€ä¸ªæ–°çš„è®¢é˜…ï¼Œç„¶åå°†å…¶ `seek` åˆ°ç”Ÿäº§è®¢é˜…çš„å¿«ç…§ï¼Œä»è€Œè·å¾—ä¸€ä¸ªçœŸå®çš„æ¶ˆæ¯æµç”¨äºæµ‹è¯• 39ã€‚
- **ç›¸å…³å‘½ä»¤:**
    1. **åˆ›å»ºå¿«ç…§:** `gcloud pubsub snapshots create my-snapshot --subscription=YOUR_SUBSCRIPTION_ID` 39
    2. **å°†è®¢é˜… seek åˆ°å¿«ç…§:** `gcloud pubsub subscriptions seek YOUR_SUBSCRIPTION_ID --snapshot=my-snapshot` 39
- å¿«ç…§çš„ç”Ÿå‘½å‘¨æœŸä¸è¿‡æœŸè§„åˆ™:
    å¿«ç…§å¹¶éæ°¸ä¹…æœ‰æ•ˆã€‚å®ƒä»¬çš„è¿‡æœŸæ—¶é—´éµå¾ªä¸€ä¸ªéå¸¸å…·ä½“ä¸”ä¸ç›´è§‚çš„å…¬å¼ï¼šè¿‡æœŸæ—¶é—´ = 7 å¤© - (æºè®¢é˜…ä¸­æœ€è€æœªç¡®è®¤æ¶ˆæ¯çš„å¹´é¾„) 47ã€‚è¿™æ„å‘³ç€ï¼Œä¸ºä¸€ä¸ªç§¯å‹äº†å¾ˆæ—§æ¶ˆæ¯çš„è®¢é˜…åˆ›å»ºå¿«ç…§ï¼Œè¯¥å¿«ç…§çš„æœ‰æ•ˆæœŸå¯èƒ½ä¼šéå¸¸çŸ­ã€‚å¦‚æœè®¡ç®—å‡ºçš„æœ‰æ•ˆæœŸä¸è¶³ä¸€å°æ—¶ï¼ŒPub/Sub æœåŠ¡ç”šè‡³ä¼šæ‹’ç»åˆ›å»ºè¯¥å¿«ç…§ã€‚å¯¹äºä»»ä½•ä¾èµ–å¿«ç…§è¿›è¡Œç¾éš¾æ¢å¤è®¡åˆ’çš„å›¢é˜Ÿæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿…é¡»äº†è§£çš„å…³é”®ç»†èŠ‚ã€‚

## ç¬¬å…­éƒ¨åˆ†ï¼šå…¨æ ˆæ•…éšœæ’æŸ¥ï¼šGKE ä¸Šçš„ Pub/Sub æ¶ˆè´¹è€…

æœ¬èŠ‚å°†æ‰“é€š Pub/Sub ä¸ Kubernetes ä¹‹é—´çš„å£å’ï¼Œæä¾›ä¸€ä¸ªå…¨é¢çš„æ•…éšœæ’æŸ¥æŒ‡å—ï¼Œä¸“\u0000é—¨é’ˆå¯¹æ‚¨åœ¨ GKE ä¸Šè¿è¡Œ Java åº”ç”¨çš„ç‰¹å®šç¯å¢ƒã€‚

### å…¨æ ˆæ•…éšœçš„çº§è”æ•ˆåº”

GKE ä¸­çš„ `CrashLoopBackOff` çŠ¶æ€å¹¶éå­¤ç«‹çš„ K8s é—®é¢˜ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç—‡çŠ¶ã€‚åœ¨æ‚¨çš„ä½¿ç”¨åœºæ™¯ä¸­ï¼Œå› æœé“¾å¯èƒ½æ¨ªè·¨æ•´ä¸ªæŠ€æœ¯æ ˆï¼Œå°† Pub/Sub çš„é—®é¢˜ä¸ GKE çš„é—®é¢˜ç´§å¯†è”ç³»åœ¨ä¸€èµ·ã€‚

- **æ•…éšœçº§è”è¿‡ç¨‹:**
    1. **æ ¹æœ¬åŸå› :** GKE Pod çš„é…ç½®é”™è¯¯ï¼ˆå¦‚å†…å­˜é™åˆ¶ä¸è¶³ã€æœåŠ¡è´¦å·æƒé™ä¸æ­£ç¡®ï¼‰æˆ– Java åº”ç”¨ç¨‹åºä¸­å¼•å…¥äº† bugã€‚
    2. **GKE ç—‡çŠ¶:** æ¶ˆè´¹è€… Pod å¯åŠ¨åï¼Œæ— æ³•æ­£å¸¸åˆå§‹åŒ–æˆ–å¤„ç†æ¶ˆæ¯ï¼Œéšå³å´©æºƒã€‚Kubernetes å°è¯•é‡å¯å®ƒï¼Œä½†å®ƒå†æ¬¡å´©æºƒï¼Œæœ€ç»ˆè¿›å…¥ `CrashLoopBackOff` çŠ¶æ€ 52ã€‚
    3. **Pub/Sub ç—‡çŠ¶:** åœ¨ Pod æŒç»­å´©æºƒæœŸé—´ï¼Œå®ƒæ— æ³•ç¡®è®¤ä»»ä½•æ¶ˆæ¯ã€‚`oldest_unacked_message_age` æŒ‡æ ‡å¼€å§‹ç¨³å®šå¢é•¿ 27ã€‚
    4. **ç§¯å‹å½¢æˆ:** ç”±äºæ²¡æœ‰æ¶ˆæ¯è¢«ç¡®è®¤ï¼Œéšç€æ–°æ¶ˆæ¯ä¸æ–­å‘å¸ƒï¼Œ`num_undelivered_messages` æŒ‡æ ‡ä¹Ÿå¼€å§‹éšä¹‹å¢é•¿ 25ã€‚
    5. **æœ€ç»ˆç»“æœ:** è¿ç»´äººå‘˜åŒæ—¶è§‚å¯Ÿåˆ° Pub/Sub çš„æ¶ˆæ¯ç§¯å‹å’Œ GKE çš„ `CrashLoopBackOff`ï¼Œå¿…é¡»è®¤è¯†åˆ°è¿™ä¸¤è€…æ˜¯åŒä¸€é—®é¢˜çš„ä¸¤ä¸ªä¸åŒè¡¨ç°ã€‚

### ä½¿ç”¨ `kubectl` è°ƒè¯• GKE æ¶ˆè´¹è€…

- **ç¬¬ä¸€æ­¥: ç¡®è®¤ `CrashLoopBackOff`**
    - `kubectl get pods -n YOUR_NAMESPACE` - æŸ¥æ‰¾ `RESTARTS` æ¬¡æ•°éé›¶ä¸” `STATUS` ä¸º `CrashLoopBackOff` çš„ Pod 52ã€‚
- **ç¬¬äºŒæ­¥: æ£€æŸ¥æ—¥å¿—**
    - Pod çš„æ—¥å¿—æ˜¯å¯»æ‰¾æ ¹å› çš„æœ€é‡è¦çº¿ç´¢ï¼Œé€šå¸¸ä¼šåŒ…å«å¯¼è‡´å´©æºƒçš„ Java å †æ ˆè·Ÿè¸ªæˆ–é”™è¯¯ä¿¡æ¯ã€‚
    - `kubectl logs POD_NAME -n YOUR_NAMESPACE` (æŸ¥çœ‹å½“å‰å®¹å™¨çš„æ—¥å¿—)
    - `kubectl logs POD_NAME -n YOUR_NAMESPACE -p` (æŸ¥çœ‹**ä¸Šä¸€æ¬¡**å´©æºƒçš„å®¹å™¨çš„æ—¥å¿—) 53
- **ç¬¬ä¸‰æ­¥: æè¿° Pod**
    - æ­¤å‘½ä»¤å¯ä»¥æ­ç¤ºé…ç½®å±‚é¢çš„é—®é¢˜ã€‚
    - `kubectl describe pod POD_NAME -n YOUR_NAMESPACE` 53
    - é‡ç‚¹å…³æ³¨:
        - **Exit Code (é€€å‡ºç ):** é€€å‡ºç  `1` é€šå¸¸è¡¨ç¤ºåº”ç”¨ç¨‹åºé”™è¯¯ã€‚é€€å‡ºç  `137` åˆ™å¼ºçƒˆæš—ç¤ºå®¹å™¨å› ä¸ºå†…å­˜ä¸è¶³è¢«ç³»ç»Ÿæ€æ­» (OOMKilled) 53ã€‚
        - **Events (äº‹ä»¶):** äº‹ä»¶éƒ¨åˆ†ä¼šæ˜¾ç¤ºå­˜æ´»æ¢é’ˆ (liveness probe) æˆ–å°±ç»ªæ¢é’ˆ (readiness probe) å¤±è´¥ç­‰ Kubernetes å±‚é¢çš„é—®é¢˜ 52ã€‚
        - **Service Account:** ç¡®è®¤ Pod ä½¿ç”¨äº†æ­£ç¡®çš„ Kubernetes æœåŠ¡è´¦å· (KSA)ï¼Œå¹¶ä¸”è¯¥ KSA é€šè¿‡ Workload Identity æ­£ç¡®åœ°ç»‘å®šåˆ°äº†æ‰€éœ€çš„ Google æœåŠ¡è´¦å· (GSA) 54ã€‚

### æ€§èƒ½æ€æ‰‹ï¼šGKE çš„ CPU ä¸å†…å­˜èŠ‚æµ

- **æ¦‚å¿µ:** å³ä½¿ Pod æ²¡æœ‰å´©æºƒï¼Œå…¶æ€§èƒ½ä¹Ÿå¯èƒ½ä¸¥é‡ä¸‹é™ï¼Œä»è€Œå¯¼è‡´æ¶ˆæ¯ç§¯å‹ã€‚è¿™é€šå¸¸æ˜¯ç”±èµ„æºé™åˆ¶å¼•èµ·çš„ã€‚å½“ä¸€ä¸ªå®¹\u0000å™¨ä½¿ç”¨çš„ CPU è¶…å‡ºå…¶ `limit` æ—¶ï¼Œå®ƒå°†è¢«**èŠ‚æµ**ï¼ˆå³æ€§èƒ½è¢«å¼ºåˆ¶é™ä½ï¼‰ã€‚å½“ä¸€ä¸ªå®¹å™¨ä½¿ç”¨çš„å†…å­˜è¶…å‡ºå…¶ `limit` æ—¶ï¼Œå®ƒå°†è¢«**æ€æ­»** (OOMKilled)ï¼Œä»è€Œå¯¼è‡´ `CrashLoopBackOff` 56ã€‚
- CPU èŠ‚æµï¼šæ— å£°ä½†è‡´å‘½
    Kubernetes ä¸ä¼šä¸º CPU èŠ‚æµç”Ÿæˆä¸€ä¸ªæ˜ç¡®çš„â€œäº‹ä»¶â€ã€‚æ‚¨çš„åº”ç”¨ç¨‹åºåªæ˜¯å˜å¾—è¶Šæ¥è¶Šæ…¢ï¼Œè¿™å¯èƒ½æéš¾è°ƒè¯•ã€‚æ‚¨å¯èƒ½ä¼šè§‚å¯Ÿåˆ° oldest_unacked_message_age æŒç»­å¢é«˜ï¼Œä½†åœ¨åº”ç”¨æ—¥å¿—ä¸­å´æ‰¾ä¸åˆ°ä»»ä½•æ˜æ˜¾çš„é”™è¯¯ 57ã€‚
- **è¯Šæ–­:** åœ¨ Cloud Monitoring ä¸­æ£€æŸ¥å®¹å™¨çš„ CPU èŠ‚æµæŒ‡æ ‡ï¼š`kubernetes.io/container/cpu/throttle_time`ã€‚å¦‚æœè¯¥æŒ‡æ ‡æŒç»­å¢é•¿ï¼Œè¯´æ˜æ‚¨çš„ Pod æ­£é­å— CPU é¥¥é¥¿ã€‚
- **è§£å†³æ–¹æ¡ˆ:**
    1. **åˆç†è®¾ç½® Requests:** ç¡®ä¿ Pod è§„æ ¼ä¸­ `resources.requests` çš„ CPU å’Œå†…å­˜å€¼å‡†ç¡®åæ˜ äº†å…¶æ­£å¸¸è¿è¡Œæ‰€éœ€ã€‚
    2. **è°¨æ…ä½¿ç”¨ CPU Limits:** è®¸å¤šä¸“å®¶ç°åœ¨å»ºè®®**ä¸è®¾ç½® CPU limits**ï¼Œä»…è®¾ç½® CPU requestsã€‚è¿™å¯ä»¥é˜²æ­¢èŠ‚æµï¼Œå…è®¸ Pod åœ¨èŠ‚ç‚¹æœ‰ç©ºé—²èµ„æºæ—¶â€œçªå‘â€ä½¿ç”¨ï¼ŒåŒæ—¶ä»ç„¶ä¿è¯å…¶æ‰€è¯·æ±‚çš„èµ„æºé‡ 60ã€‚
    3. **è®¾ç½® Memory Limits = Memory Requests:** è¿™æ˜¯æœ€ä½³å®è·µï¼Œå®ƒä¸ºæ‚¨çš„ Pod æä¾›äº† Guaranteed çš„ QoS ç­‰çº§ï¼Œä½¿å…¶è¡Œä¸ºæ›´å¯é¢„æµ‹ 60ã€‚
    4. ä½¿ç”¨å‚ç›´ Pod è‡ªåŠ¨æ‰©ç¼©å™¨ (VPA) çš„ `Off` (æ¨è) æ¨¡å¼ï¼Œæ¥è·å–å…³äºåˆç†èµ„æºè¯·\u0000æ±‚/é™åˆ¶çš„å»ºè®® 61ã€‚

### ä¼˜åŒ–é«˜ååé‡ Java Streaming Pull å®¢æˆ·ç«¯

æ‚¨çš„æŠ€æœ¯æ ˆ (Java, Streaming Pull, å¤šçº¿ç¨‹) ä¾èµ–äºä¸€ä¸ªå¤æ‚çš„å®¢æˆ·ç«¯åº“ï¼Œè¯¥åº“å†…éƒ¨ç®¡ç†ç€ gRPC æµã€æ¶ˆæ¯ç§Ÿçº¦å’Œçº¿ç¨‹ã€‚è¯¯è§£å…¶é…ç½®æ˜¯æ€§èƒ½é—®é¢˜çš„å¸¸è§æ ¹æº 62ã€‚

- **ç²¾ç»†è°ƒæ•´æµæ§ (Flow Control):**
    - è®¢é˜…è€…å®¢æˆ·ç«¯å…·æœ‰æµæ§è®¾ç½®ï¼Œä»¥é˜²æ­¢å…¶è¢«æ¶ˆæ¯æ·¹æ²¡ã€‚å…³é”®å‚æ•°æ˜¯ `setMaxOutstandingElementCount` (æ¶ˆæ¯æ•°é‡) å’Œ `setMaxOutstandingRequestBytes` (æ¶ˆæ¯æ€»å¤§å°) 31ã€‚
    - å¦‚æœè¿™äº›é™åˆ¶è®¾ç½®å¾—è¿‡é«˜ï¼Œè¶…å‡ºäº†åº”ç”¨ç¨‹åºçš„å¤„ç†èƒ½åŠ›ï¼Œæ¶ˆæ¯å°†åœ¨å®¢æˆ·ç«¯å†…å­˜ä¸­ç§¯å‹ã€‚å®¢æˆ·ç«¯åº“ä¼šå°è¯•å»¶é•¿å®ƒä»¬çš„ç¡®è®¤æˆªæ­¢æ—¶é—´ï¼Œä½†å¦‚æœå¤„ç†æŒç»­ç¼“æ…¢ï¼Œå®ƒä»¬æœ€ç»ˆä¼šè¶…æ—¶å¹¶è¢«é‡æ–°æŠ•é€’ï¼Œå¯¼è‡´ç§¯å‹å’Œé‡å¤å¤„ç†ã€‚åä¹‹ï¼Œå¦‚æœé™åˆ¶å¤ªä½ï¼Œåˆ™å¯èƒ½æ— æ³•è¾¾åˆ°æœ€å¤§ååé‡ã€‚è¿™æ˜¯ä¸€ä¸ªå…³é”®çš„æ€§èƒ½è°ƒä¼˜å‚æ•°ã€‚
- **å¤šçº¿ç¨‹æœ€ä½³å®è·µï¼šé…ç½®è‡ªå®šä¹‰ `ExecutorProvider`**
    - **æ¦‚å¿µ:** Java å®¢æˆ·ç«¯ä½¿ç”¨ `ExecutorProvider` æ¥è·å–ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œç”¨äºæ‰§è¡Œç”¨æˆ·æä¾›çš„æ¶ˆæ¯æ¥æ”¶å›è°ƒå‡½æ•° (`MessageReceiver`) 65ã€‚
    - **é»˜è®¤è¡Œä¸º:** é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ä¼šä¸ºæ¯ä¸ªå¹¶è¡Œæ‹‰å–æµåˆ›å»ºä¸€ä¸ªåŒ…å« 5 ä¸ªçº¿ç¨‹çš„æ–°çº¿ç¨‹æ±  66ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨è®¾ç½®äº†
        `setParallelPullCount(4)`ï¼Œé‚£ä¹ˆæ‚¨å°†è·å¾— 4Ã—5=20 ä¸ªçº¿ç¨‹\u0000ç”¨äºæ¶ˆæ¯å¤„ç†ã€‚
    - **ä¸ºä½•è‡ªå®šä¹‰:** å¦‚æœæ‚¨çš„æ¶ˆæ¯å¤„ç†æ˜¯ I/O å¯†é›†å‹çš„ï¼ˆä¾‹å¦‚ï¼Œè°ƒç”¨æ•°æ®åº“ï¼‰ï¼Œæ‚¨å¯èƒ½éœ€è¦è¿œå¤šäºé»˜è®¤å€¼çš„çº¿ç¨‹æ•°æ¥è¾¾åˆ°é«˜å¹¶å‘ã€‚å¦‚æœå¤„ç†æ˜¯ CPU å¯†é›†å‹çš„ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°†çº¿ç¨‹æ•°é™åˆ¶ä¸ºå¯ç”¨æ ¸å¿ƒæ•°ã€‚æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„ `ExecutorProvider` å¯ä»¥è®©æ‚¨ç²¾ç¡®æ§åˆ¶çº¿ç¨‹æ¨¡å‹ï¼Œä»¥åŒ¹é…æ‚¨çš„å·¥ä½œè´Ÿè½½ç‰¹æ€§ã€‚
    - **ç¤ºä¾‹ä»£ç ç‰‡æ®µ (æ¦‚å¿µæ€§):**
        ```java
        // æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„æ‰§è¡Œå™¨æœåŠ¡æ¥å¤„ç†æ¶ˆæ¯
        ExecutorProvider executorProvider =
            InstantiatingExecutorProvider.newBuilder().setExecutorThreadCount(16).build();

        Subscriber subscriber =
            Subscriber.newBuilder(subscriptionName, receiver)
               .setFlowControlSettings(flowControlSettings)
               .setExecutorProvider(executorProvider)
               .setParallelPullCount(2) // å¯åŠ¨ 2 ä¸ªå¹¶è¡Œæµ
               .build();
        ```
        65
    - è¿™ä¸ªé…ç½®æ˜¯ä¼˜åŒ–æ‚¨ç‰¹å®šæŠ€æœ¯æ ˆçš„æœ€åä¸€å—ã€ä¹Ÿæ˜¯è‡³å…³é‡è¦çš„ä¸€å—æ‹¼å›¾ï¼Œå®ƒç›´æ¥è§£å†³äº†æ‚¨æåˆ°çš„â€œå¤šçº¿ç¨‹â€ä¸Šä¸‹æ–‡ä¸­çš„æ€§èƒ½è°ƒä¼˜é—®é¢˜ã€‚

## ç»“è®º

æˆåŠŸç®¡ç† GCP Pub/Sub æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°¤å…¶æ˜¯åœ¨ GKE è¿™ç§å¤æ‚çš„ç¯å¢ƒä¸­ï¼Œè¦æ±‚è¿ç»´äººå‘˜å…·å¤‡è·¨è¶Šæ¶ˆæ¯ä¸­é—´ä»¶ã€Kubernetes å’Œåº”ç”¨ç¨‹åºæœ¬èº«çš„å…¨æ ˆè¯Šæ–­èƒ½\u0000åŠ›ã€‚

1. **åŸºç¡€æ“ä½œæ˜¯åŸºçŸ³:** ç†Ÿç»ƒä½¿ç”¨ `gcloud pubsub` å‘½ä»¤è¿›è¡Œæ—¥å¸¸çš„å¢åˆ æ”¹æŸ¥æ˜¯é«˜æ•ˆè¿ç»´çš„èµ·ç‚¹ã€‚
2. **ç›‘æ§æ˜¯è¯Šæ–­çš„æ ¸å¿ƒ:** æ¶ˆæ¯ç§¯å‹çš„æ ¸å¿ƒè¯Šæ–­ä¾èµ–äºå¯¹ `num_undelivered_messages` å’Œ `oldest_unacked_message_age` è¿™ä¸¤ä¸ªå…³é”®æŒ‡æ ‡çš„æŒç»­ç›‘æ§å’Œæ­£ç¡®è§£è¯»ã€‚å»ºç«‹åŸºäºè¿™äº›æŒ‡æ ‡çš„å‘Šè­¦æ˜¯å®ç°ä¸»åŠ¨è¿ç»´çš„å…³é”®ã€‚
3. **æ¸…é™¤ç§¯å‹éœ€è°¨æ…:** `seek` æ“ä½œæ˜¯æ¸…é™¤ç§¯å‹çš„é¦–é€‰æ–¹æ³•ï¼Œå®ƒå®‰å…¨ä¸”å¯¹æœåŠ¡æ— ä¸­æ–­ã€‚åˆ é™¤å¹¶é‡å»ºè®¢é˜…æ˜¯ä¸€ç§é«˜é£é™©æ“ä½œï¼Œåº”ä»…åœ¨å……åˆ†ç†è§£å…¶æ¶ˆæ¯ä¸¢å¤±å’ŒæœåŠ¡ä¸­æ–­é£é™©åï¼Œä½œä¸ºæœ€åæ‰‹æ®µä½¿ç”¨ã€‚
4. **å¼¹æ€§è®¾è®¡ä¼˜äºäº‹åè¡¥æ•‘:** ä¸»åŠ¨é…ç½®æ­»ä¿¡é˜Ÿåˆ— (DLQ) å’Œåˆ©ç”¨å¿«ç…§ (Snapshot) è¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼Œæ˜¯æ„å»ºå¥å£®ã€å¯æ¢å¤ç³»ç»Ÿçš„æ ‡å¿—ã€‚ç†è§£ DLQ çš„ IAM éœ€æ±‚å’Œå¿«ç…§çš„è¿‡æœŸç­–ç•¥æ˜¯æˆåŠŸå®æ–½è¿™äº›æ¨¡å¼çš„å‰æã€‚
5. **é—®é¢˜æ ¹æºå¾€å¾€åœ¨æ¶ˆè´¹è€…ç«¯:** åœ¨ GKE ç¯å¢ƒä¸­ï¼ŒPub/Sub çš„æ¶ˆæ¯ç§¯å‹é€šå¸¸æ˜¯æ¶ˆè´¹è€… Pod é—®é¢˜çš„**ç»“æœ**ï¼Œè€Œé**åŸå› **ã€‚æ’æŸ¥æ–¹å‘åº”é¦–å…ˆèšç„¦äº GKE Pod çš„æ—¥å¿—ã€èµ„æºé™åˆ¶ï¼ˆCPU/å†…å­˜èŠ‚æµï¼‰å’Œåº”ç”¨å±‚é¢çš„æ€§èƒ½ç“¶é¢ˆã€‚ç²¾ç»†åŒ–é…ç½® Java å®¢æˆ·ç«¯çš„æµæ§å’Œçº¿ç¨‹æ±  (`ExecutorProvider`) å¯¹æœ€å¤§åŒ–ååé‡è‡³å…³é‡è¦ã€‚

é€šè¿‡ç»“åˆä½¿ç”¨æœ¬æŠ¥å‘Šä¸­æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ã€ç›‘æ§ç­–ç•¥å’Œæ¶æ„æ¨¡å¼ï¼Œå›¢é˜Ÿå¯ä»¥æœ‰æ•ˆåœ°è¯Š\u0000æ–­å’Œè§£å†³ Pub/Sub æ¶ˆæ¯ç§¯å‹é—®é¢˜ï¼Œç¡®ä¿æ¶ˆæ¯å¤„ç†ç®¡é“çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚

# ChatGPT

# GCP Pub/Sub æ¶ˆæ¯é˜Ÿåˆ—å‘½ä»¤ä¸æ“ä½œæ‰‹å†Œ

## ğŸ“Œ ä¸€ã€æŸ¥çœ‹æ¶ˆæ¯å †ç§¯ç›¸å…³æŒ‡æ ‡

### 1. ä½¿ç”¨ `gcloud pubsub subscriptions describe` æŸ¥çœ‹è®¢é˜…çŠ¶æ€

```bash
gcloud pubsub subscriptions describe [SUBSCRIPTION_NAME] --project=[PROJECT_ID]
```

#### è¾“å‡ºå…³æ³¨å­—æ®µè¯´æ˜ï¼š

| å­—æ®µå | è¯´æ˜ |
| --- | --- |
| `backlogBytes` | å½“å‰æœª ack æ¶ˆæ¯çš„æ€»å­—èŠ‚æ•°ï¼ˆè¿‘ä¼¼å€¼ï¼‰ |
| `backlogMessages` | å½“å‰å †ç§¯çš„æœª ack æ¶ˆæ¯æ•°é‡ï¼ˆè¿‘ä¼¼å€¼ï¼‰ |
| `messageRetentionDuration` | æ¶ˆæ¯æœ€å¤§ä¿ç•™æ—¶é—´ï¼ˆé»˜è®¤ 7 å¤©ï¼‰ |

---

### 2. Stackdriverï¼ˆCloud Monitoringï¼‰æŒ‡æ ‡æŸ¥çœ‹ï¼ˆæ¨èï¼‰

- æŒ‡æ ‡åç§°ï¼š

| æŒ‡æ ‡åç§° | å«ä¹‰ |
| --- | --- |
| `subscription/num_undelivered_messages` | å †ç§¯çš„æ¶ˆæ¯æ•°é‡ï¼ˆbacklogï¼‰ |
| `subscription/oldest_unacked_message_age` | æœ€æ—§æœª ack æ¶ˆæ¯çš„æ—¶é—´ï¼ˆç§’ï¼‰ |
| `subscription/pull_ack_message_operation_count` | æˆåŠŸ ack çš„æ•°é‡ |
| `subscription/pull_request_count` | å®¢æˆ·ç«¯å‘èµ·çš„ pull è¯·æ±‚æ¬¡æ•° |

---

## ğŸ“Œ äºŒã€å¦‚ä½•æŸ¥çœ‹æ¶ˆæ¯å†…å®¹

### 1. ä½¿ç”¨ `gcloud pubsub subscriptions pull` æ‹‰å–æ¶ˆæ¯

```bash
gcloud pubsub subscriptions pull [SUBSCRIPTION_NAME] \
  --limit=10 \
  --project=[PROJECT_ID] \
  --format=json
```

---

## ğŸ“Œ ä¸‰ã€å¦‚ä½•æ‰‹åŠ¨ ack / nack / æ¸…ç†å †ç§¯æ¶ˆæ¯

âš ï¸ **æ³¨æ„ï¼šPub/Sub ä¸æ”¯æŒâ€œæ‰‹åŠ¨åˆ é™¤å †ç§¯æ¶ˆæ¯â€ã€‚** ä½†ä½ å¯ä»¥é€šè¿‡æ‹‰å– + ack çš„æ–¹å¼â€œæ¶ˆè´¹æ‰å®ƒä»¬â€ï¼Œå˜ç›¸æ¸…ç† backlogã€‚

### 1. æ‰‹åŠ¨ ack æ¶ˆæ¯

```bash
gcloud pubsub subscriptions pull [SUBSCRIPTION_NAME] \
  --limit=10 \
  --auto-ack
```

æˆ–ä½¿ç”¨ `--ack-ids` æ˜ç¡® ack æŸäº›æ¶ˆæ¯ï¼š

```bash
gcloud pubsub subscriptions ack [SUBSCRIPTION_NAME] --ack-ids=ACK_ID_1,ACK_ID_2
```

### 2. æ‰‹åŠ¨ nackï¼ˆä¸æ¨èï¼‰

å®¢æˆ·ç«¯ SDK ç¤ºä¾‹ï¼ˆJavaï¼‰ï¼š

```java
message.nack();
```

---

## ğŸ“Œ å››ã€å¦‚ä½•â€œæ¸…ç©ºâ€ä¸€ä¸ªè®¢é˜…çš„ backlogï¼ˆä¸¤ç§æ–¹å¼ï¼‰

### âœ… æ–¹æ¡ˆ Aï¼šåˆ é™¤æ—§çš„è®¢é˜…é‡æ–°åˆ›å»º

```bash
gcloud pubsub subscriptions delete [SUBSCRIPTION_NAME]
gcloud pubsub subscriptions create [SUBSCRIPTION_NAME] \
  --topic=[TOPIC_NAME] \
  --ack-deadline=30
```

---

### âœ… æ–¹æ¡ˆ Bï¼šæ–°å»ºè¿‡æ»¤å™¨è®¢é˜…ï¼Œä»…æ¥æ”¶æœªæ¥æ¶ˆæ¯

```bash
gcloud pubsub subscriptions create [NEW_SUB] \
  --topic=[TOPIC_NAME] \
  --filter='attributes.ts > "2025-07-03T00:00:00Z"'
```

---

## ğŸ“Œ äº”ã€Streaming Pull ç›¸å…³æŒ‡æ ‡ï¼ˆé€‚ç”¨äº GKEï¼‰

| æŒ‡æ ‡åç§° | è¯´æ˜ |
| --- | --- |
| `open_streaming_pulls` | å½“å‰æ´»è·ƒ StreamingPull è¿æ¥æ•° |
| `ack_message_count` | æˆåŠŸç¡®è®¤çš„æ¶ˆæ¯æ•°é‡ |
| `expired_ack_deadlines` | è¶…æ—¶æœª ack å¯¼è‡´çš„é‡æŠ•æ¬¡æ•° |

---

## ğŸ“Œ å…­ã€è°ƒè¯•å‘½ä»¤æ±‡æ€»

```bash
# æŸ¥çœ‹ Topic åˆ—è¡¨
gcloud pubsub topics list

# æŸ¥çœ‹æŸ Topic çš„è®¢é˜…è€…åˆ—è¡¨
gcloud pubsub topics list-subscriptions [TOPIC_NAME]

# æŸ¥çœ‹è®¢é˜…è¯¦æƒ…ï¼ˆå †ç§¯æ¶ˆæ¯ç­‰ï¼‰
gcloud pubsub subscriptions describe [SUBSCRIPTION_NAME]

# æ‹‰å–æ¶ˆæ¯å¹¶è‡ªåŠ¨ ack
gcloud pubsub subscriptions pull [SUBSCRIPTION_NAME] --auto-ack

# åˆ é™¤å¹¶é‡å»ºè®¢é˜…ï¼ˆæ¸…é™¤ backlogï¼‰
gcloud pubsub subscriptions delete [SUBSCRIPTION_NAME]
gcloud pubsub subscriptions create [SUBSCRIPTION_NAME] --topic=[TOPIC_NAME]
```

---

## ğŸ“Œ ä¸ƒã€æœ€ä½³å®è·µå»ºè®®

| å»ºè®®é¡¹ | è¯´æ˜ |
| --- | --- |
| é…ç½®è¶³å¤Ÿå¤šçš„ Streaming Pull çº¿ç¨‹ | `executor-threads` è¶³å¤Ÿå¤§é¿å… backlog |
| ç›‘æ§ oldest_unacked_message_age | è¯¥æŒ‡æ ‡å‡é«˜è¯´æ˜æ¶ˆè´¹ä¸åŠæ—¶ |
| å®šæœŸæ‹‰å– + ack æ¸…ç†æ— ç”¨æ¶ˆæ¯ | å¯ç”¨è„šæœ¬æˆ–å®šæ—¶ä»»åŠ¡å®ç°â€œæ¶ˆè´¹æ¨¡æ‹Ÿâ€ |
| é…ç½® dead letter topic | ä¿ç•™å¤±è´¥è®°å½•ï¼Œé˜²æ­¢æ— é™é‡æŠ• |

---

# Claude

# GCP Pub/Sub æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†å‘½ä»¤æ•´ç†

## 1. åŸºæœ¬æŸ¥çœ‹å‘½ä»¤

### æŸ¥çœ‹æ‰€æœ‰ Topic å’Œ Subscription

```bash
# æŸ¥çœ‹æ‰€æœ‰ Topic
gcloud pubsub topics list

# æŸ¥çœ‹æ‰€æœ‰ Subscription
gcloud pubsub subscriptions list

# \u0000çœ‹ç‰¹å®š Topic çš„è¯¦ç»†ä¿¡æ¯
gcloud pubsub topics describe TOPIC_NAME

# æŸ¥çœ‹ç‰¹å®š Subscription çš„è¯¦ç»†ä¿¡æ¯
gcloud pubsub subscriptions describe SUBSCRIPTION_NAME
```

### æŸ¥çœ‹æ¶ˆæ¯å †ç§¯æƒ…å†µ

```bash
# æŸ¥çœ‹ Subscription çš„æ¶ˆæ¯å †ç§¯æ•°é‡
gcloud pubsub subscriptions describe SUBSCRIPTION_NAME --format="value(numUndeliveredMessages)"

# æŸ¥çœ‹è¯¦ç»†çš„ Subscription çŠ¶æ€ï¼ˆåŒ…æ‹¬å †ç§¯æ¶ˆæ¯æ•°ï¼‰
gcloud pubsub subscriptions describe SUBSCRIPTION_NAME --format="table(
  name,
  numUndeliveredMessages,
  ackDeadlineSeconds,
  messageRetentionDuration,
  expirationPolicy.ttl
)"
```

## 2. ç›‘æ§å’Œè¯Šæ–­å‘½ä»¤

### å®æ—¶ç›‘æ§æ¶ˆæ¯æµé‡

```bash
# ç›‘æ§ Topic çš„å‘å¸ƒé€Ÿç‡
gcloud logging read "
  resource.type=\"pubsub_topic\"
  resource.labels.topic_id=\"TOPIC_NAME\"
  protoPayload.methodName=\"google.pubsub.v1.Publisher.Publish\"
" --limit=50 --format="table(timestamp, protoPayload.request.messages.length)"

# ç›‘æ§ Subscription çš„æ¶ˆè´¹æƒ…å†µ
gcloud logging read "
  resource.type=\"pubsub_subscription\"
  resource.labels.subscription_id=\"SUBSCRIPTION_NAME\"
  protoPayload.methodName=\"google.pubsub.v1.Subscriber.Pull\"
" --limit=50 --format="table(timestamp, protoPayload.response.receivedMessages.length)"
```

### æŸ¥çœ‹æ¶ˆæ¯å±æ€§å’Œå†…å®¹

```bash
# æ‹‰å–æ¶ˆæ¯é¢„è§ˆï¼ˆä¸ä¼š ACKï¼‰
gcloud pubsub subscriptions pull SUBSCRIPTION_NAME --limit=5 --format="table(
  message.data.decode(base64),
  message.attributes,
  message.messageId,
  message.publishTime,
  ackId
)"

# æ‹‰å–å¹¶ç«‹å³ ACK æ¶ˆæ¯
gcloud pubsub subscriptions pull SUBSCRIPTION_NAME --auto-ack --limit=10
```

## 3. æ‰‹åŠ¨æ¸…ç†æ¶ˆæ¯

### æ¸…ç†å †ç§¯æ¶ˆæ¯çš„æ–¹æ³•

```bash
# æ–¹æ³•1: æ‰¹é‡æ‹‰å–å¹¶ ACK æ¶ˆæ¯
gcloud pubsub subscriptions pull SUBSCRIPTION_NAME --auto-ack --limit=1000

# æ–¹æ³•2: ä½¿ç”¨å¾ªç¯æ¸…ç†å¤§é‡æ¶ˆæ¯
for i in {1..100}; do
  gcloud pubsub subscriptions pull SUBSCRIPTION_NAME --auto-ack --limit=1000
  echo "Cleared batch $i"
  sleep 1
done

# æ–¹æ³•3: é‡ç½® Subscriptionï¼ˆåˆ é™¤å¹¶é‡å»ºï¼‰
gcloud pubsub subscriptions delete SUBSCRIPTION_NAME
gcloud pubsub subscriptions create SUBSCRIPTION_NAME --topic=TOPIC_NAME
```

### ç´§æ€¥æ¸…ç†è„šæœ¬

```bash
#!/bin/bash
# å¿«é€Ÿæ¸…ç†å †ç§¯æ¶ˆæ¯çš„è„šæœ¬

SUBSCRIPTION_NAME="your-subscription-name"
BATCH_SIZE=1000
MAX_BATCHES=100

echo "å¼€å§‹æ¸…ç† Subscription: $SUBSCRIPTION_NAME"

for ((i=1; i<=MAX_BATCHES; i++)); do
    echo "æ­£åœ¨å¤„ç†ç¬¬ $i æ‰¹æ¬¡..."

    # æ‹‰å–æ¶ˆæ¯æ•°é‡
    MESSAGE_COUNT=$(gcloud pubsub subscriptions pull $SUBSCRIPTION_NAME --auto-ack --limit=$BATCH_SIZE --format="value(message.messageId)" | wc -l)

    if [ $MESSAGE_COUNT -eq 0 ]; then
        echo "æ²¡æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œæ¸…ç†å®Œæˆ"
        break
    fi

    echo "æ¸…ç†äº† $MESSAGE_COUNT æ¡æ¶ˆæ¯"
    sleep 0.5
done

echo "æ¸…ç†æ“ä½œå®Œæˆ"
```

## 4. é…ç½®è°ƒä¼˜å‘½ä»¤

### è°ƒæ•´ Subscription é…ç½®

```bash
# ä¿®æ”¹ ACK è¶…æ—¶æ—¶é—´
gcloud pubsub subscriptions modify SUBSCRIPTION_NAME --ack-deadline=60

# ä¿®æ”¹æ¶ˆæ¯ä¿ç•™æ—¶é—´
gcloud pubsub subscriptions modify SUBSCRIPTION_NAME --message-retention-duration=7d

# ä¿®æ”¹æœ€å¤§æŠ•é€’å°è¯•æ¬¡æ•°
gcloud pubsub subscriptions modify SUBSCRIPTION_NAME --max-delivery-attempts=10

# é…ç½®æ­»ä¿¡é˜Ÿåˆ—
gcloud pubsub subscriptions modify SUBSCRIPTION_NAME \
  --dead-letter-topic=projects/PROJECT_ID/topics/DEAD_LETTER_TOPIC \
  --max-delivery-attempts=5
```

### åˆ›å»ºä¼˜åŒ–çš„ Subscription

```bash
# åˆ›å»ºå…·æœ‰æœ€ä½³å®è·µé…ç½®çš„ Subscription
gcloud pubsub subscriptions create SUBSCRIPTION_NAME \
  --topic=TOPIC_NAME \
  --ack-deadline=60 \
  --message-retention-duration=7d \
  --max-delivery-attempts=10 \
  --dead-letter-topic=projects/PROJECT_ID/topics/dead-letter-topic \
  --enable-message-ordering
```

## 5. æ•…éšœæ’æŸ¥æµç¨‹

```mermaid
flowchart TD
    A[å‘ç°æ¶ˆæ¯å †ç§¯] --> B[æ£€æŸ¥å †ç§¯æ•°é‡]
    B --> C{å †ç§¯æ•°é‡ > é˜ˆå€¼?}
    C -->|æ˜¯| D[æ£€æŸ¥æ¶ˆè´¹è€…çŠ¶æ€]
    C -->|å¦| E[æ­£å¸¸ç›‘æ§]

    D --> F[æ£€æŸ¥ GKE Pod çŠ¶æ€]
    F --> G{Pod è¿è¡Œæ­£å¸¸?}
    G -->|å¦| H[é‡å¯ Pod]
    G -->|æ˜¯| I[æ£€æŸ¥åº”ç”¨æ—¥å¿—]

    I --> J{å‘ç°é”™è¯¯?}
    J -->|æ˜¯| K[ä¿®å¤åº”ç”¨é”™è¯¯]
    J -->|å¦| L[æ£€æŸ¥ç½‘ç»œè¿æ¥]

    L --> M[æ£€æŸ¥ Pub/Sub é…ç½®]
    M --> N{é…ç½®åˆç†?}
    N -->|å¦| O[è°ƒæ•´é…ç½®å‚æ•°]
    N -->|æ˜¯| P[è€ƒè™‘æ‰©å®¹]

    H --> Q[ç›‘æ§æ¢å¤æƒ…å†µ]
    K --> Q
    O --> Q
    P --> Q
    Q --> R[é—®é¢˜è§£å†³]

    E --> S[æŒç»­ç›‘æ§]
    R --> S
```

## 6. ç›‘æ§æŒ‡æ ‡æŸ¥è¯¢

### ä½¿ç”¨ gcloud æŸ¥è¯¢ç›‘æ§æŒ‡æ ‡

```bash
# æŸ¥è¯¢æ¶ˆæ¯å †ç§¯è¶‹åŠ¿
gcloud monitoring metrics list --filter="metric.type:pubsub"

# æŸ¥è¯¢ç‰¹å®š Subscription çš„æŒ‡æ ‡
gcloud monitoring time-series list \
  --filter='metric.type="pubsub.googleapis.com/subscription/num_undelivered_messages"' \
  --interval-start-time="2024-01-01T00:00:00Z" \
  --interval-end-time="2024-01-02T00:00:00Z"
```

### åˆ›å»ºç›‘æ§å‘Šè­¦

```bash
# åˆ›å»ºæ¶ˆæ¯å †ç§¯å‘Šè­¦ç­–ç•¥
gcloud alpha monitoring policies create --policy-from-file=alert-policy.yaml
```

alert-policy.yaml ç¤ºä¾‹ï¼š

```yaml
displayName: "Pub/Sub Message Backlog Alert"
conditions:
  - displayName: "High message backlog"
    conditionThreshold:
      filter: 'resource.type="pubsub_subscription" resource.label.subscription_id="your-subscription"'
      comparison: COMPARISON_GT
      thresholdValue: 1000
      duration: 300s
      aggregations:
        - alignmentPeriod: 60s
          perSeriesAligner: ALIGN_MEAN
notificationChannels:
  - projects/PROJECT_ID/notificationChannels/CHANNEL_ID
```

## 7. å¸¸ç”¨ç®¡ç†è„šæœ¬

### æ‰¹é‡ç®¡ç†å¤šä¸ª Subscription

```bash
#!/bin/bash
# æ‰¹é‡æ£€æŸ¥å¤šä¸ª Subscription çš„çŠ¶æ€

SUBSCRIPTIONS=("sub1" "sub2" "sub3")

echo "| Subscription | Undelivered Messages | ACK Deadline |"
echo "|--------------|---------------------|--------------|"

for sub in "${SUBSCRIPTIONS[@]}"; do
    undelivered=$(gcloud pubsub subscriptions describe $sub --format="value(numUndeliveredMessages)")
    ack_deadline=$(gcloud pubsub subscriptions describe $sub --format="value(ackDeadlineSeconds)")
    echo "| $sub | $undelivered | ${ack_deadline}s |"
done
```

## 8. æœ€ä½³å®è·µå»ºè®®

### é…ç½®å‚æ•°å»ºè®®è¡¨

| å‚æ•° | æ¨èå€¼ | è¯´æ˜ |
| --- | --- |
| ackDeadlineSeconds | 60-600 | æ ¹æ®æ¶ˆæ¯å¤„ç†æ—¶é—´è°ƒæ•´ |
| messageRetentionDuration | 7d | æ¶ˆæ¯ä¿ç•™æ—¶é—´ |
| maxDeliveryAttempts | 5-10 | æœ€å¤§é‡è¯•æ¬¡æ•° |
| enableMessageOrdering | true | å¦‚éœ€ä¿åºåˆ™å¯ç”¨ |

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¹¶å‘æ§åˆ¶**ï¼šæ ¹æ® GKE èŠ‚ç‚¹èµ„æºè°ƒæ•´æ¶ˆè´¹è€…å¹¶å‘æ•°
2. **æ‰¹é‡å¤„ç†**ï¼šä½¿ç”¨ `maxMessages` å‚æ•°æ‰¹é‡æ‹‰å–
3. **è¿æ¥å¤ç”¨**ï¼šä¿æŒé•¿è¿æ¥é¿å…é¢‘ç¹å»ºç«‹è¿æ¥
4. **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®åˆé€‚çš„å †ç§¯é˜ˆå€¼å‘Šè­¦

é€šè¿‡è¿™äº›å‘½ä»¤å’Œæµç¨‹ï¼Œä½ å¯ä»¥æœ‰æ•ˆåœ°ç®¡ç†å’Œç›‘æ§ GCP Pub/Sub æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³æ¶ˆæ¯å †ç§¯é—®é¢˜ã€‚

# Grok

### å…³é”®è¦ç‚¹

- å¯ä»¥é€šè¿‡ Cloud Monitoring æŸ¥çœ‹æœªäº¤ä»˜æ¶ˆæ¯æ•°é‡ï¼Œä½†æ²¡æœ‰ç›´æ¥çš„ CLI å‘½ä»¤ã€‚
- ä½¿ç”¨ `seek` å‘½ä»¤å¯ä»¥æ‰‹åŠ¨æ¸…é™¤æ¶ˆæ¯ï¼Œä½†éœ€è°¨æ…æ“ä½œã€‚
- é…ç½®æ¶ˆæ¯ä¿ç•™å’Œé‡è¯•ç­–ç•¥æœ‰åŠ©äºç®¡ç†æ¶ˆæ¯å †ç§¯ã€‚

---

### æŸ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—å †ç§¯

è¦æŸ¥çœ‹ GCP Pub/Sub æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å †ç§¯æ¶ˆæ¯ï¼Œå¯ä»¥é€šè¿‡ Cloud Monitoring ç›‘æ§æœªäº¤ä»˜æ¶ˆæ¯æ•°é‡ã€‚ä½¿ç”¨ä»¥ä¸‹ MQL æŸ¥è¯¢ï¼š

- æ‰“å¼€ Google Cloud Console > Monitoring > Metrics Explorerã€‚
- è¾“å…¥æŸ¥è¯¢ï¼š
    ```mql
fetch pubsub_subscription
| metric 'pubsub.googleapis.com/subscription/num_undelivered_messages'
| filter (resource.subscription_id == 'YOUR_SUBSCRIPTION_ID')
| group_by 1m, [value_num_undelivered_messages_sum: sum(value.num_undelivered_messages)]
    ```
    æ›¿æ¢ `YOUR_SUBSCRIPTION_ID` ä¸ºå®é™…è®¢é˜… IDã€‚

å¦‚æœé…ç½®äº†æ­»ä¿¡ä¸»é¢˜ï¼ˆdead-letter topicï¼‰ï¼Œè¿˜å¯ä»¥ç›‘æ§è¢«è½¬å‘åˆ°æ­»ä¿¡ä¸»é¢˜çš„æ¶ˆæ¯æ•°é‡ï¼š

- ä½¿ç”¨ MQL æŸ¥è¯¢ï¼š
    ```mql
fetch pubsub_subscription
| metric 'pubsub.googleapis.com/subscription/dead_letter_message_count'
| filter (resource.subscription_id == 'YOUR_SUBSCRIPTION_ID')
| group_by 1m, [value_dead_letter_message_count_sum: sum(value.dead_letter_message_count)]
    ```

### æ‰‹åŠ¨æ¸…ç†æ¶ˆæ¯

è¦æ‰‹åŠ¨æ¸…ç†æ¶ˆæ¯ï¼Œå¯ä»¥ä½¿ç”¨ `seek` å‘½ä»¤å°†è®¢é˜…çš„æ—¶é—´æˆ³è®¾ç½®ä¸ºæœªæ¥æ—¶é—´ï¼Œä»è€Œæ ‡è®°æ‰€æœ‰å½“å‰æ¶ˆæ¯ä¸ºå·²ç¡®è®¤ï¼š

- å‘½ä»¤ç¤ºä¾‹ï¼š
    ```bash
gcloud pubsub subscriptions seek SUBSCRIPTION_ID --time=2025-07-04T00:00:00Z
    ```
    æ³¨æ„ï¼šæ­¤æ“ä½œä¸å¯é€†ï¼Œéœ€åœ¨éç”Ÿäº§ç¯å¢ƒä¸­æµ‹è¯•ã€‚

å¦å¤–ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´æ¶ˆæ¯ä¿ç•™è®¾ç½®æ¥é—´æ¥ç®¡ç†å †ç§¯ï¼š

- åˆ›å»ºä¸»é¢˜æ—¶è®¾ç½®æ¶ˆæ¯ä¿ç•™ï¼š
    ```bash
gcloud pubsub topics create TOPIC_ID --message-retention-duration=7d
    ```
- æ›´æ–°è®¢é˜…çš„å·²ç¡®è®¤æ¶ˆæ¯ä¿ç•™ï¼š
    ```bash
gcloud pubsub subscriptions update SUBSCRIPTION_ID --retain-acked-messages --message-retention-duration=5d
    ```

### å…¶ä»–ç®¡ç†é€‰é¡¹

\u0000æœæ¶ˆæ¯å †ç§¯å› å¤„ç†å¤±è´¥å¯¼è‡´ï¼Œå¯ä»¥é…ç½®é‡è¯•ç­–ç•¥æˆ–æ­»ä¿¡ä¸»é¢˜ï¼š

- åˆ›å»ºå¸¦é‡è¯•ç­–ç•¥çš„è®¢é˜…ï¼š
    ```bash
gcloud pubsub subscriptions create SUBSCRIPTION_ID --topic=TOPIC_ID --min-retry-delay=10s --max-retry-delay=600s
    ```
- è®¾ç½®æ­»ä¿¡ä¸»é¢˜ï¼š
    ```bash
gcloud pubsub subscriptions create SUBSCRIPTION_ID --topic=TOPIC_ID --dead-letter-topic=DEAD_LETTER_TOPIC_NAME --max-delivery-attempts=5
    ```
    éœ€ä¸ºæœåŠ¡è´¦æˆ·æˆäºˆæƒé™ï¼Œå…·ä½“å‘½ä»¤è§ä¸‹æ–‡ã€‚

---

---

### è¯¦ç»†æŠ¥å‘Šï¼šGCP Pub/Sub æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†æŒ‡å—

ä»¥ä¸‹æ˜¯é’ˆå¯¹ GCP Pub/Sub æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†çš„ä¸€ä»½è¯¦ç»†æŠ¥å‘Šï¼Œæ¶µç›–æŸ¥çœ‹æ¶ˆæ¯å †ç§¯ã€æ‰‹åŠ¨æ¸…ç†æ¶ˆæ¯ä»¥åŠç›¸å…³é…ç½®ï¼Œç‰¹åˆ«ç»“åˆæ‚¨çš„ä½¿ç”¨åœºæ™¯ï¼ˆGKE + Java + Streaming Pull + å¤šçº¿ç¨‹ï¼‰æä¾›å»ºè®®ã€‚

#### èƒŒæ™¯ä¸æ¦‚è¿°

GCP Pub/Sub æ˜¯ä¸€ç§æ¶ˆæ¯ä¼ é€’æœåŠ¡ï¼Œæ”¯æŒå¼‚æ­¥æ¶ˆæ¯ä¼ è¾“ï¼Œé€‚ç”¨äºäº‹ä»¶é©±åŠ¨åº”ç”¨ã€‚åœ¨æ‚¨çš„åœºæ™¯ä¸­ï¼Œä½¿ç”¨ Streaming Pull å’Œå¤šçº¿ç¨‹çš„ Java åº”ç”¨éƒ¨ç½²åœ¨ GKE ä¸Šï¼Œå¯èƒ½é¢ä¸´æ¶ˆæ¯å †ç§¯çš„é—®é¢˜ã€‚æ¶ˆæ¯å †ç§¯é€šå¸¸è¡¨ç°ä¸ºæœªç¡®è®¤ï¼ˆundeliveredï¼‰æ¶ˆæ¯æˆ–å› å¤„ç†å¤±è´¥è€Œç´¯ç§¯çš„æ¶ˆæ¯ã€‚æœ¬æŠ¥å‘Šå°†æä¾› CLI å‘½ä»¤å’Œæ“ä½œæŒ‡å—ï¼Œå¸®åŠ©æ‚¨è¯Šæ–­å’Œç®¡ç†è¿™äº›é—®é¢˜ã€‚

#### æŸ¥çœ‹æ¶ˆæ¯å †ç§¯çš„è¯¦ç»†æ–¹æ³•

ç”±äº Pub/Sub æ²¡æœ‰ç›´æ¥çš„ CLI å‘½ä»¤æ˜¾ç¤ºè®¢é˜…ä¸­çš„æ¶ˆæ¯æ•°é‡ï¼Œå»º\u0000è®®é€šè¿‡ Cloud Monitoring ç›‘æ§ç›¸å…³æŒ‡æ ‡ï¼š

1. **æœªäº¤ä»˜æ¶ˆæ¯æ•°é‡**

    - ä½¿ç”¨ `subscription/num_undelivered_messages` æŒ‡æ ‡ç›‘æ§è®¢é˜…ä¸­æœªè¢«ç¡®è®¤ä¸”æœªè¢«å½“å‰è®¢é˜…è€…å¤„ç†çš„æ¶ˆæ¯æ•°é‡ã€‚
    - **æ“ä½œæ­¥éª¤**ï¼š
        - æ‰“å¼€ Google Cloud Console > Monitoring > Metrics Explorerã€‚
        - è¾“å…¥ä»¥ä¸‹ MQL æŸ¥è¯¢ï¼š
            ```mql
fetch pubsub_subscription
| metric 'pubsub.googleapis.com/subscription/num_undelivered_messages'
| filter (resource.subscription_id == 'YOUR_SUBSCRIPTION_ID')
| group_by 1m, [value_num_undelivered_messages_sum: sum(value.num_undelivered_messages)]
            ```
        - æ›¿æ¢ `YOUR_SUBSCRIPTION_ID` ä¸ºå®é™…è®¢é˜… IDã€‚
    - **ç”¨é€”**ï¼šå¸®åŠ©è¯†åˆ«æ¶ˆæ¯å †ç§¯çš„è§„æ¨¡ï¼Œç‰¹åˆ«é€‚ç”¨äº Streaming Pull åœºæ™¯ï¼Œç¡®ä¿å¤šçº¿ç¨‹åº”ç”¨æœªå› åŒæ­¥é—®é¢˜å¯¼è‡´æ¶ˆæ¯æœªç¡®è®¤ã€‚

2. **æ­»ä¿¡ä¸»é¢˜è½¬å‘æ¶ˆæ¯**

    - å¦‚æœé…ç½®äº†æ­»ä¿¡ä¸»é¢˜ï¼ˆdead-letter topicï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `subscription/dead_letter_message_count` æŒ‡æ ‡ç›‘æ§å› å¤„ç†å¤±è´¥è€Œè¢«è½¬å‘åˆ°æ­»ä¿¡ä¸»é¢˜çš„æ¶ˆæ¯æ•°é‡ã€‚
    - **MQL æŸ¥è¯¢ç¤ºä¾‹**ï¼š
        ```mql
fetch pubsub_subscription
| metric 'pubsub.googleapis.com/subscription/dead_letter_message_count'
| filter (resource.subscription_id == 'YOUR_SUBSCRIPTION_ID')
| group_by 1m, [value_dead_letter_message_count_sum: sum(value.dead_letter_message_count)]
        ```
    - **ç”¨é€”**ï¼šå¸®åŠ©åˆ†æå¤„ç†å¤±è´¥çš„æ¨¡å¼ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½å‡ºç°çš„ç«äº‰æ¡ä»¶å¯¼è‡´çš„æ¶ˆæ¯å¤„ç†å¤±è´¥ã€‚

3. **ä½¿ç”¨å¿«ç…§æ£€æŸ¥æ¶ˆæ¯**

    - å¯ä»¥é€šè¿‡åˆ›å»ºè®¢é˜…çš„å¿«ç…§æ¥æ£€æŸ¥ç‰¹å®šæ—¶é—´ç‚¹çš„æ¶ˆæ¯çŠ¶æ€ã€‚
    - **å‘½ä»¤**ï¼š
        - åˆ›å»ºå¿«ç…§ï¼š
            ```bash
gcloud pubsub snapshots create SNAPSHOT_ID --subscription=SUBSCRIPTION_ID
            ```
        - å¿«ç…§çš„ç”Ÿå‘½å‘¨æœŸä¸º 7 å¤©å‡å»æœ€è€æœªç¡®è®¤æ¶ˆæ¯çš„å¹´é¾„ï¼Œæœ€çŸ­ 1 å°æ—¶ã€‚
    - **æ³¨æ„**ï¼šå¿«ç…§æœ¬èº«ä¸ç›´æ¥æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹ï¼Œé€šå¸¸éœ€è¦é€šè¿‡ Pub/Sub API æˆ–å®¢æˆ·ç«¯åº“ï¼ˆå¦‚ Java å®¢æˆ·ç«¯ï¼‰è¿›ä¸€æ­¥å¤„ç†ï¼Œé€‚åˆæ‚¨çš„ Java åº”ç”¨åœºæ™¯ã€‚

4. **åŸºæœ¬è®¢é˜…å’Œä¸»é¢˜ä¿¡æ¯**
    - ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ—å‡ºè®¢é˜…å’Œä¸»é¢˜ï¼Œç¡®è®¤é…ç½®ï¼š
        - åˆ—å‡ºè®¢é˜…ï¼š
            ```bash
gcloud pubsub subscriptions list
            ```
        - åˆ—å‡ºä¸»é¢˜ï¼š
            ```bash
gcloud pubsub topics list
            ```
    - è¿™äº›å‘½ä»¤ä¸æ˜¾ç¤ºæ¶ˆæ¯æ•°é‡ï¼Œä½†å¯ç”¨äºéªŒè¯è®¢é˜…å’Œä¸»é¢˜çš„é…ç½®æ˜¯å¦æ­£ç¡®ã€‚

#### æ‰‹åŠ¨æ¸…ç†æ¶ˆæ¯çš„è¯¦ç»†æ–¹æ³•

æ¸…ç†æ¶ˆæ¯å †ç§¯å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼Œéœ€æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„æ–¹æ³•ï¼š

1. **ä½¿ç”¨ Seek å‘½ä»¤æ¸…é™¤æ¶ˆæ¯**

    - é€šè¿‡å°†è®¢é˜…çš„æ—¶é—´æˆ³è®¾ç½®ä¸ºæœªæ¥æ—¶é—´ï¼Œå¯ä»¥æ ‡è®°æ‰€æœ‰å½“å‰æ¶ˆæ¯ä¸ºå·²ç¡®è®¤ï¼Œä»è€Œâ€œæ¸…é™¤â€å®ƒä»¬ã€‚
    - **å‘½ä»¤**ï¼š
        ```bash
gcloud pubsub subscriptions seek SUBSCRIPTION_ID --time=2025-07-04T00:00:00Z
        ```
        - æ›¿æ¢ `SUBSCRIPTION_ID` ä¸ºå®é™…è®¢é˜… IDï¼Œ`2025-07-04T00:00:00Z` ä¸ºæœªæ¥æ—¶é—´ï¼ˆå½“å‰æ—¶é—´ä¸º 2025 å¹´ 7 æœˆ 3 æ—¥ 23:38 JSTï¼Œå»ºè®®é€‰æ‹©ç¨åæ—¶é—´ï¼‰ã€‚
    - **æ³¨æ„**ï¼š
        - æ­¤æ“ä½œä¸å¯é€†ï¼Œæ‰€æœ‰å½“å‰æ¶ˆæ¯å°†è¢«æ ‡è®°ä¸ºå·²ç¡®è®¤ï¼Œéœ€åœ¨éç”Ÿäº§ç¯å¢ƒä¸­æµ‹è¯•ã€‚
        - è¦æ±‚è®¢é˜…å¯ç”¨äº†æ¶ˆæ¯ä¿ç•™åŠŸèƒ½ã€‚

2. **è°ƒæ•´æ¶ˆæ¯ä¿ç•™è®¾ç½®**

    - é€šè¿‡é…ç½®æ¶ˆæ¯ä¿ç•™æ—¶é—´ï¼Œå¯ä»¥æ§åˆ¶æ¶ˆæ¯çš„ä¿ç•™å‘¨æœŸï¼Œé—´æ¥ç®¡ç†å †ç§¯ã€‚
    - **ä¸»é¢˜æ¶ˆæ¯ä¿ç•™**ï¼š
        - åˆ›å»ºä¸»é¢˜æ—¶è®¾ç½®ï¼š
            ```bash
gcloud pubsub topics create TOPIC_ID --message-retention-duration=7d
            ```
            - æœ€å¤§ä¿ç•™æ—¶é—´ä¸º 31 å¤©ï¼Œè´¹ç”¨è®¡å…¥ä¸»é¢˜æ‰€å±é¡¹ç›®ã€‚
        - æ›´æ–°ä¸»é¢˜ä¿ç•™æ—¶é—´ï¼š
            ```bash
gcloud pubsub topics update TOPIC_ID --message-retention-duration=1d
            ```
            - æ¸…é™¤ä¿ç•™è®¾ç½®ï¼š
                ```bash
gcloud pubsub topics update TOPIC_ID --clear-message-retention-duration
                ```
    - **è®¢é˜…å·²ç¡®è®¤æ¶ˆæ¯ä¿ç•™**ï¼š
        - åˆ›å»ºè®¢é˜…æ—¶è®¾ç½®ï¼š
            ```bash
gcloud pubsub subscriptions create SUBSCRIPTION_ID --retain-acked-messages --message-retention-duration=5d
            ```
            - é»˜è®¤ä¿ç•™ 7 å¤©ï¼Œæœ€å¤§ 31 å¤©ï¼Œè´¹ç”¨è®¡å…¥è®¢é˜…æ‰€å±é¡¹ç›®ã€‚
        - æ›´æ–°è®¢é˜…ä¿ç•™æ—¶é—´ï¼š
            ```bash
gcloud pubsub subscriptions update SUBSCRIPTION_ID --message-retention-duration=1d
            ```
            - ç¦ç”¨å·²ç¡®è®¤æ¶ˆæ¯ä¿ç•™ï¼š
                ```bash
gcloud pubsub subscriptions update SUBSCRIPTION_ID --no-retain-acked-messages
                ```

3. **å¤„ç†å¤±è´¥æ¶ˆæ¯ï¼šé‡è¯•ç­–ç•¥å’Œæ­»ä¿¡ä¸»é¢˜**
    - å¦‚æœæ¶ˆæ¯å †ç§¯å› å¤„ç†å¤±è´¥å¯¼è‡´ï¼Œå¯ä»¥é€šè¿‡é…ç½®é‡è¯•ç­–ç•¥æˆ–æ­»ä¿¡ä¸»é¢˜æ¥ç®¡ç†ã€‚
    - **é‡è¯•ç­–ç•¥ï¼ˆExponential Backoffï¼‰**ï¼š
        - åˆ›å»ºå¸¦é‡è¯•ç­–ç•¥çš„è®¢é˜…ï¼š
            ```bash
gcloud pubsub subscriptions create SUBSCRIPTION_ID --topic=TOPIC_ID --min-retry-delay=10s --max-retry-delay=600s
            ```
            - æœ€å°é‡è¯•å»¶è¿Ÿï¼š0-600 ç§’ï¼Œé»˜è®¤ 10 ç§’ã€‚
            - æœ€å¤§é‡è¯•å»¶è¿Ÿï¼š0-600 ç§’ï¼Œé»˜è®¤ 600 ç§’ã€‚
            - é€‚ç”¨äºå› çŸ­æš‚æ•…éšœå¯¼è‡´çš„å¤„ç†å¤±è´¥ï¼Œç‰¹åˆ«åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½å‡ºç°çš„ç«äº‰æ¡ä»¶ã€‚
    - **æ­»ä¿¡ä¸»é¢˜**ï¼š
        - åˆ›å»ºå¸¦æ­»ä¿¡ä¸»é¢˜çš„è®¢é˜…ï¼š
            ```bash
gcloud pubsub subscriptions create SUBSCRIPTION_ID --topic=TOPIC_ID --dead-letter-topic=DEAD_LETTER_TOPIC_NAME --max-delivery-attempts=5
            ```
            - æœ€å¤§äº¤ä»˜å°è¯•æ¬¡æ•°ï¼š5-100ï¼Œé»˜è®¤ 5ã€‚
        - æ›´æ–°ç°æœ‰è®¢é˜…çš„æ­»ä¿¡ä¸»é¢˜ï¼š
            ```bash
gcloud pubsub subscriptions update SUBSCRIPTION_ID --dead-letter-topic=DEAD_LETTER_TOPIC_NAME --max-delivery-attempts=5
            ```
        - ç§»é™¤æ­»ä¿¡ç­–ç•¥ï¼š
            ```bash
gcloud pubsub subscriptions update SUBSCRIPTION_ID --clear-dead-letter-policy
            ```
        - **æƒé™é…ç½®**ï¼š
            - Pub/Sub ä½¿ç”¨æœåŠ¡è´¦æˆ· `service-project-number@gcp-sa-pubsub.iam.gserviceaccount.com`ã€‚
            - ä¸ºæ­»ä¿¡ä¸»é¢˜æˆäºˆå‘å¸ƒè€…è§’è‰²ï¼š
                ```bash
PUBSUB_SERVICE_ACCOUNT="service-project-number@gcp-sa-pubsub.iam.gserviceaccount.com"
gcloud pubsub topics add-iam-policy-binding DEAD_LETTER_TOPIC_NAME --member="serviceAccount:$PUBSUB_SERVICE_ACCOUNT" --role="roles/pubsub.publisher"
                ```
            - ä¸ºåŸå§‹è®¢é˜…æˆäºˆè®¢é˜…è€…è§’è‰²ï¼š
                ```bash
PUBSUB_SERVICE_ACCOUNT="service-project-number@gcp-sa-pubsub.iam.gserviceaccount.com"
gcloud pubsub subscriptions add-iam-policy-binding SUBSCRIPTION_ID --member="serviceAccount:$PUBSUB_SERVICE_ACCOUNT" --role="roles/pubsub.subscriber"
                ```

#### é’ˆå¯¹ GKE + Java + Streaming Pull + å¤šçº¿ç¨‹çš„ç‰¹åˆ«å»ºè®®

- **Streaming Pull**ï¼šä½¿ç”¨ Streaming Pull æ—¶ï¼Œæ¶ˆæ¯ä»¥æµå¼æ–¹å¼äº¤ä»˜ï¼Œç¡®ä¿ Java åº”ç”¨æ­£ç¡®ç¡®è®¤æ¶ˆæ¯ã€‚æœªç¡®è®¤æ¶ˆæ¯ä¼šç´¯ç§¯ï¼Œå»ºè®®ç›‘æ§ `subscription/num_undelivered_messages`ã€‚
- **å¤šçº¿ç¨‹**ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæ³¨æ„çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´æ¶ˆæ¯å¤„ç†å¤±è´¥æˆ–æœªç¡®è®¤ã€‚å»ºè®®ä½¿ç”¨æ­»ä¿¡ä¸»é¢˜æ•è·å¤±è´¥æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡æ—¥å¿—åˆ†æå®šä½é—®é¢˜ã€‚
- **å®¢æˆ·ç«¯åº“**ï¼šè™½ç„¶æœ¬æŠ¥å‘Šèšç„¦ CLI å‘½ä»¤ï¼Œä½†æ‚¨çš„ Java åº”ç”¨å¯é€šè¿‡ Pub/Sub å®¢æˆ·ç«¯åº“å®ç°é‡è¯•ç­–ç•¥å’Œæ­»ä¿¡ä¸»é¢˜å¤„ç†ï¼Œå»ºè®®å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š
    - [Pub/Sub Java å®¢æˆ·ç«¯åº“æ–‡æ¡£](https://cloud.google.com/pubsub/docs/reference/libraries#client-libraries-install-java)

#### å‘½ä»¤æ±‡æ€»è¡¨

ä»¥ä¸‹æ˜¯å…³é”®å‘½ä»¤çš„æ±‡æ€»ï¼Œä¾¿äºå‚è€ƒï¼š

| **æ“ä½œ** | **å‘½ä»¤** |
| --- | --- |
| æŸ¥çœ‹æœªäº¤ä»˜æ¶ˆæ¯æ•°é‡ | ä½¿ç”¨ Cloud Monitoringï¼ŒMQL æŸ¥è¯¢ `subscription/num_undelivered_messages` |
| åˆ›å»ºå¿«ç…§ | `gcloud pubsub snapshots create SNAPSHOT_ID --subscription=SUBSCRIPTION_ID` |
| æ¸…é™¤æ¶ˆ\u0000æ¯ï¼ˆSeek åˆ°æœªæ¥æ—¶é—´ï¼‰ | `gcloud pubsub subscriptions seek SUBSCRIPTION_ID --time=2025-07-04T00:00:00Z` |
| é…ç½®ä¸»é¢˜æ¶ˆæ¯ä¿ç•™ | `gcloud pubsub topics create/update TOPIC_ID --message-retention-duration=7d` |
| é…ç½®è®¢é˜…å·²ç¡®è®¤æ¶ˆæ¯ä¿ç•™ | `gcloud pubsub subscriptions create/update SUBSCRIPTION_ID --retain-acked-messages --message-retention-duration=5d` |
| è®¾ç½®é‡è¯•ç­–ç•¥ | `gcloud pubsub subscriptions create SUBSCRIPTION_ID --min-retry-delay=10s --max-retry-delay=600s` |
| è®¾ç½®æ­»ä¿¡ä¸»é¢˜ | `gcloud pubsub subscriptions create/update SUBSCRIPTION_ID --dead-letter-topic=DEAD_LETTER_TOPIC_NAME --max-delivery-attempts=5` |

#### ç»“è®ºä¸å»ºè®®

- å»ºè®®å®šæœŸç›‘æ§ `subscription/num_undelivered_messages` å’Œ `subscription/dead_letter_message_count` ä»¥æ—©æœŸå‘ç°æ¶ˆæ¯å †ç§¯ã€‚
- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ“ä½œå‰ï¼Œæµ‹è¯• `seek` å‘½ä»¤ä»¥ç¡®ä¿ä¸ä¼šæ„å¤–ä¸¢å¤±é‡è¦æ¶ˆæ¯ã€‚
- ç»“åˆæ‚¨çš„å¤šçº¿ç¨‹ Java åº”ç”¨ï¼Œæ³¨æ„çº¿ç¨‹åŒæ­¥å’Œæ¶ˆæ¯ç¡®è®¤é€»è¾‘ï¼Œç¡®ä¿ Streaming Pull çš„é«˜æ•ˆå¤„ç†ã€‚

**å‚è€ƒèµ„æ–™**ï¼š

- [é‡æ”¾å’Œæ¸…é™¤æ¶ˆæ¯ | Pub/Sub æ–‡æ¡£ | Google Cloud](https://cloud.google.com/pubsub/docs/replay-overview)
- [å¤„ç†æ¶ˆæ¯å¤±è´¥ | Pub/Sub æ–‡æ¡£ | Google Cloud](https://cloud.google.com/pubsub/docs/handling-failures)
- [ç›‘æ§ Pub/Sub | Pub/Sub æ–‡æ¡£ | Google Cloud](https://cloud.google.com/pubsub/docs/monitoring)