- parallel-pull-count\***\*æ˜¯å»ºè®®å€¼ï¼Œä¸æ˜¯ç¡¬é™åˆ¶**

```bash
åœ¨ spring-cloud-gcp-pubsub ä¸­ï¼Œparallel-pull-count çš„æœ¬è´¨æ˜¯ä¼ ç»™ Google çš„åŽŸç”Ÿå®¢æˆ·ç«¯åº“ï¼ˆSubscriber.Builder.setParallelPullCountï¼‰çš„å‚æ•°ï¼Œ**å®ƒæŽ§åˆ¶çš„æ˜¯åˆ›å»ºå¤šå°‘ä¸ª StreamingPull çº¿ç¨‹ï¼ˆSessionsï¼‰**ï¼Œä½†å®¢æˆ·ç«¯åº“**å¯èƒ½æ ¹æ®è´Ÿè½½æˆ–å†…éƒ¨é‡è¯•æœºåˆ¶è‡ªåŠ¨å¢žåŠ è¿žæŽ¥**ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

> âš ï¸ ä½ è®¾çš„æ˜¯ â€œè‡³å°‘ x ä¸ªè¿žæŽ¥â€ï¼Œä½†å¹¶ä¸æ˜¯ç¡¬æ€§ä¸Šé™ã€‚
```

- çº¿ç¨‹ä¼šä¸€ç›´å ç”¨ executor-threads ç›´åˆ°ä¸€ä¸ªå®Œæ•´çš„ e2e é‡Šæ”¾
- GKE Pod ==> access pull messages ==> then ack the message ==> then call backend service api
	- the flow 

```mermaid
sequenceDiagram
    participant Sub as ScheduleService (Consumer)
    participant PubSub as Google Pub/Sub
    participant API as Backend API

    PubSub->>+Sub: 1. Deliver Message
    Sub->>-PubSub: 2. **Acknowledge Immediately**
    Note right of PubSub: Message is now deleted. <br/> It will NOT be redelivered.
    Sub->>+API: 3. Call Backend API
    Note over Sub,API: What happens if this call fails? <br/> The message is already gone.
    API-->>-Sub: 4. API Response (Success or Failure)
```

- About monitor

| Metric åç§°                        | å•ä½    | ç¤ºä¾‹å€¼   | æŒ‡æ ‡è¯´æ˜Ž                                                                              | å…¸åž‹é—®é¢˜æˆ–å¼‚å¸¸å«ä¹‰                                                                                                                    | ä¼˜åŒ–å»ºè®®                                                                                                                                 |
| :--------------------------------- | :------ | :------- | :------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------ | :--------------------------------------------------------------------------------------------------------------------------------------- |
| Oldest unacked message age         | s       | 0        | è®¢é˜…ä¸­æœªç¡®è®¤ï¼ˆUnacknowledgedï¼‰çš„æœ€æ—§æ¶ˆæ¯çš„å¹´é¾„ã€‚                                      | é«˜å€¼è¡¨æ˜Žè®¢é˜…è€…æœªèƒ½åŠæ—¶å¤„ç†å’Œç¡®è®¤æ¶ˆæ¯ï¼Œå¯èƒ½å¯¼è‡´æ¶ˆæ¯ç§¯åŽ‹ã€å»¶è¿Ÿå¤„ç†ã€‚                                                                    | æ£€æŸ¥è®¢é˜…è€…åº”ç”¨æ€§èƒ½ã€é”™è¯¯æ—¥å¿—ã€èµ„æºæ˜¯å¦å……è¶³ã€‚è€ƒè™‘å¢žåŠ è®¢é˜…è€…å®žä¾‹æ•°é‡æˆ–æé«˜å¤„ç†å¹¶å‘åº¦ã€‚æ£€æŸ¥è®¢é˜…çš„ç¡®è®¤æˆªæ­¢æ—¶é—´ï¼ˆAck deadlineï¼‰è®¾ç½®æ˜¯å¦åˆç†ã€‚ |
| Unacked messages by region         | (Count) | 0        | æŒ‰åŒºåŸŸç»Ÿè®¡çš„æœªç¡®è®¤æ¶ˆæ¯æ•°é‡ã€‚                                                          | æŸä¸ªç‰¹å®šåŒºåŸŸçš„æœªç¡®è®¤æ¶ˆæ¯æ•°é‡é«˜ï¼Œå¯èƒ½è¡¨æ˜Žè¯¥åŒºåŸŸçš„è®¢é˜…è€…å¤„ç†èƒ½åŠ›ä¸è¶³æˆ–å­˜åœ¨é—®é¢˜ã€‚                                                        | å…³æ³¨å‡ºçŽ°ç§¯åŽ‹çš„åŒºåŸŸï¼Œé’ˆå¯¹è¯¥åŒºåŸŸçš„è®¢é˜…è€…è¿›è¡ŒæŽ’æŸ¥å’Œä¼˜åŒ–ã€‚                                                                                   |
| **Delivery metrics**               |         |          | **æ¶ˆæ¯ä¼ è¾“ç›¸å…³æŒ‡æ ‡é›†åˆï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªå­æŒ‡æ ‡ï¼š**                                        |                                                                                                                                       |                                                                                                                                          |
| - Ack message count                | /s      | 0.058/s  | æ¯ç§’è¢«è®¢é˜…è€…ç¡®è®¤çš„æ¶ˆæ¯æ•°é‡ã€‚                                                          | å¦‚æžœæ­¤å€¼è¿œä½ŽäºŽâ€œSent message countâ€ï¼Œè¡¨ç¤ºæ¶ˆæ¯è™½ç„¶è¢«å‘é€ä½†æœªè¢«è®¢é˜…è€…ç¡®è®¤ï¼Œå¯èƒ½å­˜åœ¨å¤„ç†æ…¢æˆ–ç¡®è®¤å¤±è´¥ã€‚                                    | æ£€æŸ¥è®¢é˜…è€…ç¡®è®¤æ¶ˆæ¯çš„é€»è¾‘æ˜¯å¦æ­£ç¡®é«˜æ•ˆï¼Œç¡®ä¿åœ¨æˆåŠŸå¤„ç†åŽåŠæ—¶å‘é€ç¡®è®¤ã€‚æŽ’æŸ¥è®¢é˜…è€…é”™è¯¯ã€‚                                                     |
| - Publish message count            | /s      | 0.058/s  | æ¯ç§’å‘å¸ƒåˆ° Topic çš„æ¶ˆæ¯æ•°é‡ã€‚                                                         | æ­¤å€¼ä»£è¡¨æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆPublisherï¼‰çš„åžåé‡ã€‚å¦‚æžœä½ŽäºŽé¢„æœŸï¼Œå¯èƒ½æ˜¯ç”Ÿäº§è€…ç«¯å‘å¸ƒé€Ÿåº¦å—é™ã€‚                                                   | æ£€æŸ¥ç”Ÿäº§è€…åº”ç”¨çš„å‘å¸ƒé€»è¾‘å’Œæ€§èƒ½ï¼Œç¡®è®¤ç½‘ç»œè¿žæŽ¥å’ŒæŽˆæƒæ˜¯å¦æ­£å¸¸ã€‚                                                                             |
| - Sent message count               | /s      | 0.058/s  | æ¯ç§’ä»Ž Topic å‘é€ç»™è®¢é˜…è€…çš„æ¶ˆæ¯æ•°é‡ã€‚                                                 | æ­¤å€¼ä»£è¡¨ Pub/Sub æˆåŠŸå°†æ¶ˆæ¯å‘é€ç»™è®¢é˜…è€…çš„åžåé‡ã€‚å¦‚æžœæ­¤å€¼è¿œä½ŽäºŽâ€œPublish message countâ€ï¼Œå¯èƒ½ Pub/Sub åˆ°è®¢é˜…è€…ä¹‹é—´å­˜åœ¨è¿žæŽ¥æˆ–é…ç½®é—®é¢˜ã€‚ | æ£€æŸ¥è®¢é˜…æ˜¯å¦é…ç½®æ­£ç¡®ï¼Œè®¢é˜…è€…æ˜¯å¦å¤„äºŽè¿è¡ŒçŠ¶æ€å¹¶èƒ½æŽ¥æ”¶æ¶ˆæ¯ã€‚ç¡®ä¿ Pub/Sub æœåŠ¡å¸æˆ·æœ‰æƒé™å‘é€æ¶ˆæ¯ç»™è®¢é˜…ç«¯ç‚¹ï¼ˆå¯¹äºŽ Push è®¢é˜…ï¼‰ã€‚              |
| Ack message count by delivery type | /s      | 0.0467/s | æŒ‰æ¶ˆæ¯æŠ•é€’æ–¹å¼ï¼ˆPull, Push ç­‰ï¼‰ç»Ÿè®¡çš„ç¡®è®¤æ¶ˆæ¯æ•°é‡ã€‚æˆªå›¾æ˜¾ç¤ºçš„æ˜¯ Pull æ–¹å¼çš„ç¡®è®¤æ•°é‡ã€‚ | é’ˆå¯¹ç‰¹å®šæŠ•é€’æ–¹å¼çš„ç¡®è®¤æ•°é‡ä½Žï¼Œè¡¨æ˜Žè¯¥æŠ•é€’æ–¹å¼çš„è®¢é˜…è€…å¤„ç†æˆ–ç¡®è®¤å­˜åœ¨é—®é¢˜ã€‚                                                              | å¦‚æžœæ˜¯ Pull è®¢é˜…ï¼Œæ£€æŸ¥æ‹‰å–å’Œç¡®è®¤é€»è¾‘ï¼›å¦‚æžœæ˜¯ Push è®¢é˜…ï¼Œæ£€æŸ¥ Push ç«¯ç‚¹çš„å¯ç”¨æ€§å’Œå¤„ç†èƒ½åŠ›ã€‚                                               |
| Publish to ack delta               | s       | 0        | æ¶ˆæ¯ä»Žå‘å¸ƒåˆ°è¢«è®¢é˜…è€… _ç¬¬ä¸€æ¬¡_ ç¡®è®¤çš„å¹³å‡æ—¶é—´é—´éš”ã€‚                                    | é«˜å€¼è¡¨ç¤ºæ•´ä¸ªæ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸï¼ˆå‘å¸ƒã€ä¼ è¾“ã€è®¢é˜…è€…å¤„ç†ã€ç¡®è®¤ï¼‰çš„ç«¯åˆ°ç«¯å»¶è¿Ÿè¾ƒé«˜ã€‚                                                            | ç»¼åˆåˆ†æžå…¶ä»–æŒ‡æ ‡ï¼ˆUnacked age, Ack count vs Sent count, Pull/Push to ack deltaï¼‰æ¥å®šä½å»¶è¿Ÿå‘ç”Ÿçš„çŽ¯èŠ‚ï¼ˆå‘å¸ƒã€ä¼ è¾“ã€è®¢é˜…è€…å¤„ç†ï¼‰ã€‚         |
| Pull to ack delta                  | s       | 0        | æ¶ˆæ¯ä»Žè¢« Pull è®¢é˜…è€…æ‹‰å–åˆ°è¢«è¯¥è®¢é˜…è€…ç¡®è®¤çš„å¹³å‡æ—¶é—´é—´éš”ã€‚                              | é«˜å€¼ç‰¹åˆ«æŒ‡å‡ºå»¶è¿Ÿå‘ç”Ÿåœ¨ Pull è®¢é˜…è€…ç«¯ï¼Œå³æ¶ˆæ¯è¢«æ‹‰å–åŽæœªè¢«åŠæ—¶å¤„ç†å’Œç¡®è®¤ã€‚                                                              | é‡ç‚¹ä¼˜åŒ– Pull è®¢é˜…è€…çš„æ¶ˆæ¯å¤„ç†é€»è¾‘ï¼Œæé«˜å¤„ç†é€Ÿåº¦å’Œå¹¶å‘åº¦ã€‚ç¡®ä¿åœ¨å¤„ç†å®ŒæˆåŽç«‹å³å‘é€ç¡®è®¤ã€‚                                                 |
| Billable bytes by region           | B       | N/A      | æŒ‰åŒºåŸŸç»Ÿè®¡çš„è®¡è´¹å­—èŠ‚æ•°ï¼ˆåŒ…æ‹¬å‘å¸ƒå’Œè®¢é˜…çš„æ•°æ®é‡ï¼‰ã€‚                                    | è®¡è´¹å­—èŠ‚æ•°å¼‚å¸¸å‡é«˜å¯èƒ½è¡¨æ˜Žæ•°æ®é‡æ„å¤–å¢žåŠ ï¼Œä¾‹å¦‚é”™è¯¯åœ°é‡å¤å‘å¸ƒæˆ–è®¢é˜…å¤§é‡æ¶ˆæ¯ã€‚                                                          | ç›‘æŽ§æ•°æ®é‡å¢žé•¿è¶‹åŠ¿ï¼ŒæŽ’æŸ¥åº”ç”¨æ˜¯å¦å­˜åœ¨é‡å¤å‘å¸ƒæˆ–æ¶ˆè´¹é€»è¾‘é”™è¯¯ã€‚è¯„ä¼°æ˜¯å¦éœ€è¦åŽ‹ç¼©æ¶ˆæ¯ä½“ã€‚                                                     |

|                      |                                                                                      |
| -------------------- | ------------------------------------------------------------------------------------ |
| æŒ‡æ ‡åç§°             | å«ä¹‰ï¼ˆéžå­—é¢ï¼‰                                                                       |
| Publish to Ack Delta | è¡¨ç¤ºä¸€æ¡æ¶ˆæ¯ä»Žè¢«å‘å¸ƒåˆ° Pub/Sub Topic åˆ°è¢«å®¢æˆ·ç«¯ç¡®è®¤ï¼ˆackï¼‰ä¹‹é—´çš„æ—¶é—´å·®ï¼ˆç›¸å¯¹çŽ°åœ¨ï¼‰ã€‚ |
| Pull to Ack Delta    | è¡¨ç¤ºä¸€æ¡æ¶ˆæ¯ä»Žè¢«å®¢æˆ·ç«¯æ‹‰å–ï¼ˆpullï¼‰åˆ°è¢«å®¢æˆ·ç«¯ç¡®è®¤ï¼ˆackï¼‰ä¹‹é—´çš„æ—¶é—´å·®ï¼ˆç›¸å¯¹çŽ°åœ¨ï¼‰ã€‚    |

- about Test value
    - ![test-value](./testing-value.md)

# Q

å¦‚ä½•å¢žåŠ  executor-threadsã€‚ä¸è°ƒæ•´ä»£ç é€»è¾‘çš„æƒ…å†µä¸‹åœ¨ Deployment çš„çŽ¯å¢ƒå˜é‡ä¸­è®¾ç½® Spring Boot çš„é…ç½®ï¼š

env:

â€¢ name:

SPRING_CLOUD_GCP_PUBSUB_SUBSCRIBER_EXECUTOR_THREADS

value: "10"

Spring Boot ä¼šè‡ªåŠ¨å°†å…¶æ˜ å°„ä¸º

spring.cloud.gcp.pubsub.subscriber.executor-threads=10.

ç›®å‰çŠ¶æ€

PRD æ²¡æœ‰æ‰©å®¹ä¹‹å‰

2 ä¸ª Pod\*4 ä¸ª executor-threads ==>æŽ¥æ”¶è¿™ 8 ä¸ªæ¶ˆæ¯çš„èƒ½åŠ›==>æ‰€æœ‰è®¢é˜…å…±äº«çš„

PRD æ‰©å®¹è¿‡ä¹‹åŽ

4 ä¸ª Pod \*4 ä¸ª executor-threads ==> æŽ¥æ”¶è¿™ 16 ä¸ªæ¶ˆæ¯çš„èƒ½åŠ›==>æ‰€æœ‰è®¢é˜…å…±äº«çš„

å‡è®¾åˆ°äº†æŸä¸ªæ•´ç‚¹ PUB/SUB

å¯èƒ½å¹¶å‘è¿›æ¥ 50 ä¸ªæ¶ˆæ¯ï¼Œé‚£ä¹ˆæˆ‘é¦–å…ˆè¦æœ‰èƒ½åŠ›ç¬¬ä¸€æ—¶é—´æŽ¥æ”¶è¿™ 50 ä¸ªæ¶ˆæ¯

==> æ‰€æœ‰è®¢é˜…å…±äº«çš„

é‚£ä¹ˆ 5 ä¸ª Pod \*10 ä¸ª executor-threads æ‰å…·å¤‡è¿™æ ·çš„æŽ¥æ”¶èƒ½åŠ›ã€è™½ç„¶å¹¶å‘çº¿ç¨‹å¹¶ä¸ä»£è¡¨æ¶ˆæ¯åžåè‡ªåŠ¨æå‡ã€‘è‡³äºŽæˆ‘ä»¬åŽé¢èƒ½å¦å¤„ç†è¿‡æ¥ æˆ–è€… BackendService æ˜¯å¦èƒ½å½±å“ æˆ‘ä»¬ç¬¬ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œä¹Ÿæ˜¯æœ‰çš„==>å°±æ˜¯è¶…æ—¶çš„ä¼˜åŒ–ï¼Œä¸ºæ¯ä¸ª HTTP è°ƒç”¨è®¾ç½®ï¼Œè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢çº¿ç¨‹æ°¸è¿œé˜»å¡ž

æˆ‘ä»¬å‡è®¾ CPU è¢«åƒçˆ† é‚£ä¹ˆæˆ‘ä»¬çš„ HPA å¯ä»¥ç¡®ä¿æ¯”å¦‚æˆ‘ä»¬è®¾ç½®ä¸º 5-10 ä¸ª Pod

ä¹Ÿå¯ä»¥æœ‰ä¸€å®šçš„æ‰©å®¹èƒ½åŠ›æ¥æ»¡è¶³è¿™ä¸ªéœ€æ±‚.è¿™æ ·é™ä½Žäº†å¢žåŠ  executor-

threads çš„é£Žé™©

è€Œä¸”åŽé¢çš„ backend Service å¯¹äºŽæˆ‘ä»¬æ¥è¯´æ˜¯

IO å¯†é›†åž‹åœºæ™¯ï¼ˆçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´ç­‰å¾… HTTP å“åº”ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥æ”¾å®½çº¿ç¨‹æ•°è®¾ç½® executor-threads æ˜¯å¯è¡Œçš„ï¼Œå¦‚æžœä¸€ä¸ªä»»åŠ¡çš„ä¸»è¦è€—æ—¶ ä¸æ˜¯åœ¨ CPU è®¡ç®—ä¸Šï¼Œè€Œæ˜¯åœ¨ç­‰å¾…ç½‘ç»œã€ç£ç›˜ã€æ•°æ®åº“ã€HTTPã€å¤–éƒ¨ç³»ç»Ÿå“åº”ç­‰ 1O æ“ä½œå®Œæˆ

CPU æ²¡æœ‰åšå¤ªå¤šäº‹ï¼Œåªæ˜¯çº¿ç¨‹ã€è¢«å ç”¨ã€‘å¤„äºŽ é˜»å¡žçŠ¶æ€ï¼ˆwaiting for socketresponseï¼‰ã€‚é‚£ä¹ˆè¿™ä¸ªå°±æ˜¯ 10 å¯†é›†åž‹åœºæ™¯

è¯„ä¼°æ•´ç‚¹æˆ–è€…æŸä¸ªç‚¹çž¬æ—¶æ‹‰å–æ¶ˆæ¯ä¹Ÿå°±æ˜¯å¹¶å‘æ¶ˆæ¯æ¥ä¹‹åŽçš„å†…å­˜è€—ç”¨æƒ…å†µã€‚

# A 1

å½“ç„¶å¯ä»¥ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„ Markdown æºç å½¢å¼è¾“å‡ºï¼Œä½ å¯ä»¥ç›´æŽ¥å¤åˆ¶ç²˜è´´è¿› .md æ–‡ä»¶æˆ–ä½ å…¬å¸çš„æ–‡æ¡£å¹³å°ï¼Œæ— éœ€ä¿®æ”¹å°±èƒ½å‘ˆçŽ°æ ¼å¼ä¸Žå›¾è¡¨å†…å®¹ã€‚

# âœ… GKE Java Pub/Sub Subscriber å¹¶å‘å¤„ç†èƒ½åŠ›ä¼˜åŒ–æ–¹æ¡ˆ

## ðŸŽ¯ ä¼˜åŒ–ç›®æ ‡

ä¸ºäº†è§£å†³å½“å‰ GKE ä¸­ Pub/Sub æ¶ˆè´¹æœåŠ¡åœ¨ **æ¶ˆæ¯é«˜å³°æ—¶åˆ»ï¼ˆå¦‚æ•´ç‚¹è§¦å‘ï¼‰å“åº”ç¼“æ…¢ã€çº¿ç¨‹è¢«é˜»å¡žè¿‡ä¹…** ç­‰é—®é¢˜ï¼Œæˆ‘ä»¬ä»Žä¸¤ä¸ªæ ¸å¿ƒæ–¹å‘å‡ºå‘è¿›è¡Œä¼˜åŒ–ï¼š

1. **å¢žåŠ çº¿ç¨‹æ± çº¿ç¨‹æ•°ï¼ˆexecutor-threadsï¼‰ä»¥æå‡å¹¶å‘æŽ¥æ”¶ä¸Žå¤„ç†èƒ½åŠ›**

2. **ä¼˜åŒ– Backend API çš„è¯·æ±‚è¶…æ—¶ä¸Žé‡è¯•ç­–ç•¥ï¼ŒåŽ‹ç¼©å¤„ç†æ—¶é—´çª—å£**

---

## 1ï¸âƒ£ æå‡çº¿ç¨‹æ± çº¿ç¨‹æ•°ï¼ˆexecutor-threadsï¼‰

### âœ… åœºæ™¯èƒŒæ™¯

å½“å‰ Pod æ¯ä¸ªçº¿ç¨‹åœ¨å¤„ç† Pub/Sub æ¶ˆæ¯æ—¶ï¼Œä¼šå‘èµ·åŒæ­¥ HTTP è¯·æ±‚è‡³ backend APIï¼Œè€Œå“åº”æ—¶é—´é€šå¸¸ä¸º 10~60sï¼Œå±žäºŽ **IO å¯†é›†åž‹åœºæ™¯**ï¼Œå¯¼è‡´çº¿ç¨‹é•¿æœŸå¤„äºŽ â€œWaitingâ€ çŠ¶æ€ï¼ŒCPU åˆ©ç”¨çŽ‡ä½Žã€‚

### âœ… è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨ Spring Cloud GCP åŽŸç”Ÿæ”¯æŒé…ç½®é¡¹ï¼š

```yaml
env:
Â  - name: SPRING_CLOUD_GCP_PUBSUB_SUBSCRIBER_EXECUTOR_THREADS
Â  Â  value: "10"
```

ç­‰æ•ˆäºŽï¼š

spring.cloud.gcp.pubsub.subscriber.executor-threads=10

âœ… æ•ˆæžœå¯¹æ¯”ç¤ºæ„å›¾

```mermaid
flowchart TD
    PS[Pub/Sub Topic] -->|StreamingPull| Pod1

    subgraph Pod1 [GKE Pod #1]
        direction TB
        T1[Thread 1 âž waiting HTTP]
        T2[Thread 2 âž waiting HTTP]
        T3[Thread 3 âž waiting HTTP]
        T10[Thread 10 âž waiting HTTP]
    end

    note right of Pod1
        æ›´å¤šçº¿ç¨‹ æ›´å¿«æŽ¥æ”¶å¹¶è¡Œå¤„ç†æ¶ˆæ¯ ç¼“è§£çž¬æ—¶ç§¯åŽ‹
    end note
```

âœ… ç»“åˆ HPA è‡ªåŠ¨æ‰©å®¹èƒ½åŠ›

çº¿ç¨‹æ•°ä¸Šå‡ âž HTTP è¯·æ±‚å¹¶å‘å¢žå¤š âž CPU ä¸Šå‡ âž HPA æ‰©å®¹ âž æå‡æ•´ä½“åžå

|              |                         |
| ------------ | ----------------------- |
| é…ç½®é¡¹       | ç¤ºä¾‹å€¼                  |
| HPA é…ç½®     | minPods: 3, maxPods: 10 |
| CPU trigger  | target: 80%             |
| å®¹å™¨èµ„æºé™åˆ¶ | 1 CPU / 1Gi RAM         |

2ï¸âƒ£ ä¼˜åŒ– Backend API è°ƒç”¨é€»è¾‘ï¼ˆåŽ‹ç¼©è€—æ—¶ï¼‰

âœ… å½“å‰é—®é¢˜

åŽŸé€»è¾‘ä¸ºåŒæ­¥è°ƒç”¨ + 3 æ¬¡ retryï¼Œæ¯æ¬¡è¶…æ—¶ä¸ºæ•°åˆ†é’Ÿï¼Œæ€»è€—æ—¶æœ€å¤šå¯è¾¾ï¼š

retry #1: 360sï¼ˆå¤±è´¥ï¼‰

retry #2: 360sï¼ˆå¤±è´¥ï¼‰

retry #3: 360sï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰

æ€»è€—æ—¶ â‰ˆ 18 åˆ†é’Ÿ

ä¸¥é‡å ç”¨çº¿ç¨‹èµ„æº âž æ— æ³•å¤„ç†æ–°æ¶ˆæ¯ âž backlog å¢žåŠ 

âœ… æ”¹è¿›æ–¹æ¡ˆ

ä½¿ç”¨è¶…æ—¶æŽ§åˆ¶æœºåˆ¶ï¼ˆå¦‚ HttpClient è®¾ç½®ï¼‰ï¼Œç¼©çŸ­é‡è¯•å‘¨æœŸ âž æ‰€æœ‰ retry æŽ§åˆ¶åœ¨ 60s å†…å®Œæˆ

```Java
HttpClient client = HttpClient.newBuilder()
Â  Â  .connectTimeout(Duration.ofSeconds(5))
Â  Â  .build();
HttpRequest request = HttpRequest.newBuilder()
Â  Â  .timeout(Duration.ofSeconds(10))Â  // å•æ¬¡è¯·æ±‚æœ€å¤§ 10s
Â  Â  ...
```

âœ… æ–°ç­–ç•¥è®¾è®¡

|          |          |                    |
| -------- | -------- | ------------------ |
| é‡è¯•åºå· | è¶…æ—¶æ—¶é—´ | ç´¯è®¡æ—¶é—´çª—å£       |
| ç¬¬ 1 æ¬¡  | 10s      | 0s ~ 10s           |
| ç¬¬ 2 æ¬¡  | 20s      | 10s ~ 30s          |
| ç¬¬ 3 æ¬¡  | 30s      | 30s ~ 60s          |
| åˆè®¡     |          | âœ… æœ€é•¿ 60s å†…å®Œæˆ |

âœ… æ•ˆæžœ

- ç¼“è§£çº¿ç¨‹æ± é˜»å¡žåŽ‹åŠ›
- å¿«é€Ÿ fail fastï¼Œé‡Šæ”¾èµ„æº
- é¿å…å›  backend å¼‚å¸¸å¯¼è‡´çº¿ç¨‹é•¿æœŸæŒ‚èµ·æˆ–å †ç§¯

âœ… æ€»ä½“æ•ˆæžœå›¾ï¼ˆæ¶ˆæ¯æŽ¥æ”¶æµç¨‹ + ä¼˜åŒ–ç‚¹ï¼‰

```mermaid

flowchart TD
Â  Â  PubSub[Pub/Sub Topic] -->|StreamingPull| Queue[æ¶ˆæ¯é˜Ÿåˆ—]
Â  Â  subgraph Pod [GKE Pod]
Â  Â  Â  Â  direction TB
Â  Â  Â  Â  Queue -->|1| Thread1[çº¿ç¨‹1 âž message1 âž HTTPè¯·æ±‚ âž è¶…æ—¶æŽ§åˆ¶]
Â  Â  Â  Â  Queue -->|2| Thread2[çº¿ç¨‹2 âž message2 âž HTTPè¯·æ±‚ âž è¶…æ—¶æŽ§åˆ¶]
Â  Â  Â  Â  Queue -->|...| ThreadN[çº¿ç¨‹N âž messageN âž HTTPè¯·æ±‚ âž è¶…æ—¶æŽ§åˆ¶]
Â  Â  end
Â  Â  note right of Pod
Â  Â  Â  Â  executor-threads æé«˜ âž æ”¯æŒæ›´å¤šå¹¶å‘è¯·æ±‚\n
Â  Â  Â  Â  æ¯ä¸ªçº¿ç¨‹ä»»åŠ¡åœ¨ 60s å†…å®Œæˆ âž å¿«é€Ÿé‡Šæ”¾èµ„æº
Â  Â  end note
```

ðŸ§  æ€»ç»“å¯¹æ¯”è¡¨

|                 |                     |                     |                         |
| --------------- | ------------------- | ------------------- | ----------------------- |
| ç»´åº¦            | ä¼˜åŒ–å‰              | ä¼˜åŒ–åŽ              | æ•ˆæžœ                    |
| æ¯ä¸ª Pod çº¿ç¨‹æ•° | é»˜è®¤ 4              | å¢žåŠ è‡³ 10           | æ¯ Pod å¹¶å‘å¤„ç†èƒ½åŠ›æå‡ |
| è¯·æ±‚é˜»å¡žæ—¶é—´    | æœ€é•¿ 18 åˆ†é’Ÿ        | é™åˆ¶åœ¨ 1 åˆ†é’Ÿå†…     | å¿«é€Ÿé‡Šæ”¾çº¿ç¨‹èµ„æº        |
| GKE HPA æ•æ„Ÿåº¦  | CPU åˆ©ç”¨ä½Ž âž æ‰©å®¹æ…¢ | CPU æŠ¬å‡ âž è‡ªåŠ¨è§¦å‘ | æ”¯æ’‘é«˜å³°å¹¶å‘            |
| å¹¶å‘èƒ½åŠ›        | æ˜“ backlog          | å¯åº”å¯¹çž¬æ—¶ 50+ æ¶ˆæ¯ | ðŸŸ¢ ç¨³å®šå¯é              |

âœ… è½åœ°å»ºè®®

1. ä¿®æ”¹ Deployment é…ç½®ï¼Œå¢žåŠ çº¿ç¨‹æ± è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼ˆexecutor-threads=10ï¼‰
2. é…ç½® HTTP è¯·æ±‚çº§åˆ«çš„è¿žæŽ¥/å“åº”è¶…æ—¶ï¼Œä½¿ç”¨ fail fast ç­–ç•¥
3. åœ¨ GKE ä¸Šè®¾ç½®åˆç†çš„ HPA é˜ˆå€¼ä¸Žèµ„æºé™åˆ¶
4. è”åŠ¨ç›‘æŽ§ç³»ç»Ÿè§‚å¯Ÿçº¿ç¨‹æ± é˜Ÿåˆ—é•¿åº¦ã€CPU åˆ©ç”¨çŽ‡ã€å¤„ç†å»¶è¿Ÿ
5. è§†æƒ…å†µè¿›ä¸€æ­¥ä¼˜åŒ–ä¸ºå¼‚æ­¥éžé˜»å¡žæ¨¡åž‹ï¼ˆå¦‚ WebClient + Reactorï¼‰

# A 2

ä½ è¿™æ®µåˆ†æžéžå¸¸æ¸…æ™°ï¼Œæ€è·¯å¯¹å¾—éžå¸¸åˆ°ä½ã€‚ä¸‹é¢æˆ‘æ¥å¸®ä½ æ•´ç†å¹¶æ€»ç»“ä¸ºä¸€ä¸ªç»“æž„åŒ–çš„éƒ¨ç½²ä¼˜åŒ–å»ºè®®ï¼Œä¾¿äºŽä½ å†…éƒ¨è½åœ°æˆ–ä½œä¸ºè¯„å®¡æ–‡æ¡£ä½¿ç”¨ã€‚

âœ… GKE Java Pub/Sub Subscriber ä¼˜åŒ–æ€»ç»“ä¸Žå»ºè®®

ðŸŽ¯ å½“å‰ç›®æ ‡

æå‡ GKE ä¸­ Java Subscriber å®¢æˆ·ç«¯å¯¹ çž¬æ—¶å¹¶å‘æ¶ˆæ¯æ‹‰å–ä¸Žå¤„ç†èƒ½åŠ›ï¼Œé¿å…æ•´ç‚¹è§¦å‘æ—¶çš„â€œæ¶ˆæ¯å †ç§¯â€æˆ–â€œå“åº”è¶…æ—¶â€é—®é¢˜ã€‚

ðŸ§  èƒŒæ™¯çŽ°çŠ¶

|                  |                                           |
| ---------------- | ----------------------------------------- |
| é¡¹ç›®             | å½“å‰é…ç½®                                  |
| GKE Pod          | é»˜è®¤æ¯ä¸ª Pod é…ç½® 1 vCPU / 1Gi            |
| HPA              | å·²å¯ç”¨ï¼Œæ”¯æŒ Pod åŠ¨æ€æ‰©å®¹ï¼ˆ5 ~ 10 ä¸ªï¼‰    |
| executor-threads | é»˜è®¤ä¸ºæ¯ä¸ª Pod 4 ä¸ªçº¿ç¨‹ï¼ˆåŒæ­¥é˜»å¡ž IOï¼‰    |
| Pub/Sub æ¶ˆæ¯     | æ¯ä¸ªæ•´ç‚¹å¯èƒ½æœ‰ 50+ å¹¶å‘æ¶ˆæ¯               |
| backend service  | å“åº”ä¸ç¨³å®šï¼ˆ10s ~ 60sï¼‰ï¼Œä¸º IO å¯†é›†åž‹æ“ä½œ |

âœ… å®žæ–½æ–¹æ¡ˆæ€»ç»“

ðŸ§© 1.

é€šè¿‡ Deployment çŽ¯å¢ƒå˜é‡åŠ¨æ€é…ç½® executor-threads

æ— éœ€æ”¹ä»£ç ï¼Œç›´æŽ¥é€šè¿‡ env æ³¨å…¥ Spring Boot é…ç½®ï¼š

env:

- name: SPRING_CLOUD_GCP_PUBSUB_SUBSCRIBER_EXECUTOR_THREADS

value: "10"

Spring Boot ä¼šè‡ªåŠ¨æ˜ å°„ä¸ºï¼š

spring.cloud.gcp.pubsub.subscriber.executor-threads=10

ðŸ§© 2.

ç†è§£æ•´ä½“å¤„ç†èƒ½åŠ›ï¼ˆçº¿ç¨‹æ€»æ•° = Pod æ•° Ã— æ¯ Pod çº¿ç¨‹æ•°ï¼‰

|                |                  |                          |
| -------------- | ---------------- | ------------------------ |
| åœºæ™¯           | è®¡ç®—             | æ€»çº¿ç¨‹æ•°ï¼ˆå¹¶å‘å¤„ç†èƒ½åŠ›ï¼‰ |
| åˆå§‹           | 2 Pod Ã— 4 çº¿ç¨‹   | 8                        |
| æ‰©å®¹åŽ         | 4 Pod Ã— 4 çº¿ç¨‹   | 16                       |
| ä¼˜åŒ–åŽï¼ˆæŽ¨èï¼‰ | 5 Pod Ã— 10 çº¿ç¨‹  | 50 âœ…                    |
| æ»¡è½½åŽ         | 10 Pod Ã— 10 çº¿ç¨‹ | 100 ðŸ”                   |

ðŸ§© 3.

æ¶ˆæ¯æ‹‰å–ä¸Ž executor çº¿ç¨‹è§£è€¦è¯´æ˜Ž

- Pub/Sub StreamingPull ä¼šæ ¹æ® buffer è®¾ç½®é¢„æ‹‰æ¶ˆæ¯
- åªæœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œæ¶ˆæ¯æ‰ä¼šè¿›å…¥æ¶ˆè´¹ï¼ˆMessageReceiver.onMessage()ï¼‰
- æ‰€ä»¥æå‡çº¿ç¨‹æ•°å¯ä»¥æå‡ç¬¬ä¸€æ—¶é—´â€œæŽ¥æ”¶+å¤„ç†â€çš„æœ€å¤§åžå

ðŸ§© 4.

é£Žé™©æŽ§åˆ¶ï¼šä¸ºä»€ä¹ˆè¿™å¥—æ–¹æ¡ˆæ˜¯å¹³æ»‘çš„ï¼Ÿ

|                  |                                   |                                    |
| ---------------- | --------------------------------- | ---------------------------------- |
| ç»´åº¦             | æŽ§åˆ¶ç­–ç•¥                          | è¯´æ˜Ž                               |
| CPU å ç”¨         | HPA è‡ªåŠ¨æ‰©å®¹                      | çº¿ç¨‹å¤šæ—¶ CPU ä¸Šå‡ âž è‡ªåŠ¨æ‰© Pod     |
| å†…å­˜å ç”¨         | ä¸å»ºè®® executor > 16ï¼ˆ1Giï¼‰       | é¿å… OOMï¼ˆçº¿ç¨‹æ± å †æ ˆ+æ¶ˆæ¯ bufferï¼‰ |
| è¯·æ±‚é˜»å¡ž         | åŠ å…¥ HTTP è¶…æ—¶é™åˆ¶ï¼ˆå¦‚ 20sï¼‰      | é¿å…çº¿ç¨‹æ°¸ä¹…é˜»å¡ž                   |
| Pub/Sub æ¶ˆæ¯é¢„æ‹‰ | é…ç½® maxOutstandingMessages æŽ§åˆ¶  | é˜²æ­¢ç§¯åŽ‹è¿‡å¤šæœªå¤„ç†æ¶ˆæ¯             |
| åŽç«¯æœåŠ¡æ…¢       | å±žäºŽ IO å¯†é›† âž æ›´é€‚åˆé«˜çº¿ç¨‹æ•°     | ä¸ä¼š CPU çˆ†ï¼Œä½†çº¿ç¨‹è¢«æŒ‚èµ·          |
| è§¦å‘é«˜å³°æ¶ˆæ¯ç§¯åŽ‹ | å¢žåŠ æ€»çº¿ç¨‹æ•°å¯ä»¥ç¼“è§£æŽ¥æ”¶/å“åº”ç“¶é¢ˆ | âœ… ç›®æ ‡ä¼˜åŒ–ç‚¹å³åœ¨æ­¤                |

ðŸ§© 5.

å¯é€‰å¢žå¼ºé¡¹ï¼ˆåŽç»­ä¼˜åŒ–æ–¹å‘ï¼‰

|                                           |                                  |
| ----------------------------------------- | -------------------------------- |
| ä¼˜åŒ–æ–¹å‘                                  | è¯´æ˜Ž                             |
| ä½¿ç”¨ WebClient + Reactor å¼‚æ­¥è°ƒç”¨ backend | æå‡çº¿ç¨‹åˆ©ç”¨çŽ‡ï¼ˆéžé˜»å¡ž IOï¼‰      |
| å°†æ…¢æŽ¥å£ / å¿«æŽ¥å£æ‹†åˆ†ä¸åŒ Subscription    | æŒ‰ SLA è®¾å®šä¸åŒçº¿ç¨‹æ•°æˆ– Pod è§„æ¨¡ |
| é…ç½® DLQï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰                      | é¿å…å¤±è´¥è¯·æ±‚æ— é™å †ç§¯é‡è¯•         |
| è®¾ç½® message TTL                          | å¯¹å¤„ç†è¶…æ—¶çš„æ¶ˆæ¯è‡ªåŠ¨æ¸…ç†         |

âœ… å°ç»“

**æå‡ executor-threads æ˜¯åˆç†ä¸”å¯æŽ§çš„ä¼˜åŒ–æ‰‹æ®µï¼Œå°¤å…¶åœ¨ IO å¯†é›†åž‹åœºæ™¯ä¸‹ã€‚**æ­é… GKE HPA å¯å®žçŽ°èµ„æºè‡ªåŠ¨è°ƒèŠ‚ï¼Œæå‡æ•´ä½“ç³»ç»Ÿåžåèƒ½åŠ›å¹¶é™ä½Žçž¬æ—¶å †ç§¯é£Žé™©ã€‚

å¦‚ä½ éœ€è¦ï¼Œæˆ‘è¿˜å¯ä»¥ï¼š

- å¸®ä½ ç”Ÿæˆä¸€ä»½æ ‡å‡†æ ¼å¼çš„ã€Œæ€§èƒ½ä¼˜åŒ–å˜æ›´è¯´æ˜Žæ–‡æ¡£ã€
- å¸®ä½ ç”»å‡ºã€Œçº¿ç¨‹æ± å ç”¨ä¸Žæ‰©å®¹å…³ç³»å›¾ã€ã€ŒPub/Sub æ¶ˆæ¯è¿›å…¥å¤„ç†çº¿ç¨‹çš„æµè½¬è·¯å¾„ã€

æ˜¯å¦éœ€è¦ï¼Ÿ

# è®¾ç½®æ¶ˆæ¯ TTL

å½“ç„¶å¯ä»¥ï¼ŒPub/Sub ä¸­çš„æ¶ˆæ¯ TTLï¼ˆTime to Liveï¼‰ æ˜¯ä¸€ä¸ªéžå¸¸é‡è¦çš„åŠŸèƒ½ï¼Œç”¨äºŽè‡ªåŠ¨æ¸…ç†é‚£äº›â€œè¶…æ—¶æœªè¢« ackâ€çš„æ¶ˆæ¯ï¼Œé¿å…æ¶ˆæ¯æ°¸ä¹…å †ç§¯æˆ–åå¤é‡æŠ•é€’ã€‚

ä¸‹é¢æˆ‘æ¥è¯¦ç»†è§£é‡Šå…¶å«ä¹‰ã€ä½œç”¨ã€è®¾ç½®æ–¹å¼ã€æ³¨æ„äº‹é¡¹ï¼Œå¹¶é™„å¸¦æ“ä½œç¤ºä¾‹ã€‚

âœ… ä»€ä¹ˆæ˜¯ Message TTLï¼Ÿ

Message TTL æ˜¯æŒ‡ä¸€æ¡æ¶ˆæ¯åœ¨ Pub/Sub Topic ä¸­å¯ä»¥â€œç”Ÿå­˜â€çš„æœ€å¤§æ—¶é—´ã€‚å¦‚æžœåœ¨è¿™ä¸ªæ—¶é—´å†…æ²¡æœ‰è¢«æˆåŠŸ ackï¼Œå®ƒå°†è¢« è‡ªåŠ¨åˆ é™¤ï¼Œä¸å†æŠ•é€’ã€‚

âœ… ä¸ºä»€ä¹ˆéœ€è¦è®¾ç½® Message TTLï¼Ÿ

|                     |                                                  |
| ------------------- | ------------------------------------------------ |
| åŽŸå›                 | è¯´æ˜Ž                                             |
| ðŸ” é˜²æ­¢æ¶ˆæ¯æ°¸è¿œé‡è¯• | æŸäº›æ¶ˆæ¯å¯èƒ½å› é€»è¾‘ç¼ºé™·æˆ–åŽç«¯ä¸å¯ç”¨ï¼Œå§‹ç»ˆå¤„ç†å¤±è´¥ |
| ðŸ§  å‡å°‘èµ„æºæµªè´¹     | é‡è¯•å¤±è´¥ä¼šå ç”¨è®¢é˜…è€…çº¿ç¨‹ã€CPUã€ç½‘ç»œèµ„æº          |
| ðŸ§¹ æ¸…ç†è„æ•°æ®       | é¿å…å¤šå¹´åŽ†å²æ— ç”¨æ¶ˆæ¯å †ç§¯ï¼ˆå¦‚ test topicï¼‰        |
| âœ… æé«˜ç³»ç»Ÿç¨³å®šæ€§   | æŽ§åˆ¶æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸï¼Œæé«˜å¯é¢„æµ‹æ€§                   |

âœ… Pub/Sub TTL è®¾ç½®ä½ç½®è¯´æ˜Ž

|                      |                                                        |
| -------------------- | ------------------------------------------------------ |
| ç»„ä»¶                 | TTL è®¾ç½®ä½ç½®                                           |
| âœ… Topic å±‚é¢        | æ¶ˆæ¯å‘å¸ƒåŽæœ€å¤šä¿ç•™å¤šä¹…ï¼ˆæ— è®ºæ˜¯å¦è¢«è®¢é˜…ï¼‰               |
| âŒ Subscription å±‚é¢ | ä¸æ”¯æŒè®¾ç½® TTLï¼Œä½†å¯ä»¥è®¾ç½® ackDeadlineï¼ˆå•æ¬¡å¤„ç†æ—¶é—´ï¼‰ |

âœ… è®¾ç½®æ–¹å¼ï¼ˆTTL æ˜¯ Topic å±‚çº§å±žæ€§ï¼‰

ðŸ”§ ä½¿ç”¨

gcloud

è®¾ç½®ï¼ˆåˆ›å»ºæ—¶æŒ‡å®š TTLï¼‰ï¼š

gcloud pubsub topics create my-topic \

--message-retention-duration=600sÂ  # TTL = 10 åˆ†é’Ÿ

ðŸ”„ å·²æœ‰ Topic è®¾ç½® TTLï¼ˆæ›´æ–°ï¼‰ï¼š

gcloud pubsub topics update my-topic \

--message-retention-duration=3600sÂ  # TTL = 1 å°æ—¶

âœ… TTL æœ€å°å€¼æ˜¯ 10sï¼Œæœ€å¤§å€¼æ˜¯ 7 å¤©ï¼ˆé»˜è®¤ 7 å¤©ï¼‰

âœ… å·¥ä½œæœºåˆ¶å›¾ç¤º

```mermaid
sequenceDiagram

participant Client as Publisher

participant PS as Pub/Sub Topic

participant SS as GKE Pod

participant API as Backend

Client->>PS: Publish message at t=0

Note over PS: TTL å¼€å§‹è®¡æ—¶ï¼ˆè®¾ç½®ä¸º 600sï¼‰

SS->>PS: StreamingPull æŽ¥æ”¶æ¶ˆæ¯

SS->>+API: è°ƒç”¨åŽç«¯ API

API-->>-SS: å“åº”å¤±è´¥ / é˜»å¡ž

alt æœªåœ¨ ackDeadline å†… ack

Note over PS: é‡æŠ•é€’ï¼ˆé‡è¯•ä¸­ï¼‰

end

alt è¶…è¿‡ TTL æ—¶é—´

PS-->>SS: ä¸å†æŠ•é€’ï¼Œæ¶ˆæ¯ä¸¢å¼ƒ âŒ

end
```

âœ… æ³¨æ„äº‹é¡¹

|                              |                                                        |
| ---------------------------- | ------------------------------------------------------ |
| é¡¹ç›®                         | æ³¨æ„ç‚¹                                                 |
| TTL â‰  ackDeadline            | ackDeadline æ˜¯â€œå•æ¬¡å¤„ç†è¶…æ—¶æ—¶é—´â€ï¼ŒTTL æ˜¯â€œæ¶ˆæ¯æ€»å¯¿å‘½â€   |
| æ— æ³•é…ç½®åœ¨ Subscription ä¸Š   | TTL å¿…é¡»åœ¨ Topic ä¸Šè®¾ç½®                                |
| è¶…æ—¶ä¸ä¼šè¿›å…¥ DLQï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰ | DLQ è§¦å‘æ¡ä»¶æ˜¯â€œack å¤±è´¥æ¬¡æ•°è¶…é™â€ï¼ŒTTL è¶…æ—¶ä¸ä¼šè§¦å‘ DLQ |
| é€‚ç”¨äºŽâ€œè¿‡æœŸå°±æ²¡æ„ä¹‰â€çš„æ¶ˆæ¯   | å¦‚å®šæ—¶ä»»åŠ¡é€šçŸ¥ã€å®žæ—¶æŒ‡æ ‡ã€CI/CD trigger ç­‰             |

ðŸŽ¯ å®žæˆ˜å»ºè®®ï¼ˆç»“åˆä½ çš„æƒ…å†µï¼‰

|                         |                              |
| ----------------------- | ---------------------------- |
| ç±»åž‹                    | å»ºè®® TTL è®¾ç½®                |
| è°ƒç”¨åŽç«¯ API çš„è°ƒåº¦æ¶ˆæ¯ | 600sï¼ˆå³ 10 åˆ†é’Ÿï¼‰           |
| å®žæ—¶é€šçŸ¥ç±»äº‹ä»¶          | 60~180s                      |
| éœ€è¦ç¡®ä¿æœ€ç»ˆå¤„ç†çš„æ¶ˆæ¯  | TTL é•¿ï¼ˆé»˜è®¤ 7dï¼‰ + é…ç½® DLQ |
| ä¸´æ—¶æµ‹è¯•ç”¨ Topic        | 300sï¼Œé¿å…é—ç•™è„æ•°æ®         |

âœ… æ€»ç»“ä¸€å¥è¯

Pub/Sub Topic çš„ TTL è®¾ç½®å¯ç¡®ä¿æ¶ˆæ¯ä¸ä¼šæ°¸ä¹…å †ç§¯æˆ–æ— é™é‡è¯•ï¼Œæ˜¯æŽ§åˆ¶ç³»ç»Ÿç¨³å®šæ€§ä¸Žèµ„æºåˆ©ç”¨çš„å…³é”®ç­–ç•¥ä¹‹ä¸€ã€‚

æ˜¯å¦éœ€è¦æˆ‘ä¹Ÿå¸®ä½ ä¸€å¹¶æ¢³ç† Pub/Sub ä¸­å…³äºŽ ackDeadlineã€TTLã€Retryã€DLQ ç­‰å‡ ä¸ªæ¦‚å¿µçš„å¯¹æ¯”å›¾ï¼Ÿé‚£æ ·ä½ å¯ä»¥ç”¨äºŽå†…éƒ¨åˆ†äº«æˆ–æ–‡æ¡£è¯´æ˜Žã€‚

### åœºæ™¯æè¿°ï¼š

å½“å‰ Java Pub/Sub å®¢æˆ·ç«¯è¿è¡Œåœ¨ GKE Pod ä¸­ï¼Œé‡‡ç”¨ StreamingPull æ‹‰å–æ¶ˆæ¯ï¼Œä½¿ç”¨çº¿ç¨‹æ± ï¼ˆexecutor-threadsï¼‰è¿›è¡Œ HTTP è°ƒç”¨ï¼ˆåŒæ­¥é˜»å¡žï¼‰ã€‚ä¸ºé¿å…çº¿ç¨‹é˜»å¡žå¯¼è‡´ç³»ç»Ÿå¡é¡¿ï¼Œé€šè¿‡ HPA å¯¹ CPU å ç”¨è¿›è¡Œç›‘æŽ§å¹¶è§¦å‘è‡ªåŠ¨æ‰©å®¹ã€‚

âœ… çº¿ç¨‹æ± å ç”¨ä¸Ž GKE HPA æ‰©å®¹å…³ç³»å›¾

#### çº¿ç¨‹æ± å ç”¨ä¸Ž GKE HPA æ‰©å®¹å…³ç³»å›¾

```mermaid
flowchart TD
    PS[Pub/Sub Topic] -->|StreamingPull| Pod1
    PS -->|StreamingPull| Pod2

    subgraph Pod1 [GKE Pod #1 (1 vCPU)]
        direction TB
        T1[Thread 1 âž waiting HTTP]
        T2[Thread 2 âž waiting HTTP]
        T3[Thread 3 âž waiting HTTP]
        T4[Thread 4 âž waiting HTTP]
        CPU1[CPU ä½¿ç”¨çŽ‡æå‡] -->|è§¦å‘ HPA| HPA[Pod æ‰©å®¹è§¦å‘]
    end

    subgraph Pod2 [GKE Pod #2 (1 vCPU)]
        direction TB
        T5[Thread 1 âž waiting HTTP]
        T6[Thread 2 âž waiting HTTP]
        T7[Thread 3 âž waiting HTTP]
        T8[Thread 4 âž waiting HTTP]
        CPU2[CPU ä½¿ç”¨çŽ‡æå‡] -->|è§¦å‘ HPA| HPA
    end

    HPA --> Pod3[ðŸ†• Pod #3 å¯åŠ¨]
    Pod3 -->|å»ºç«‹ StreamingPull| PS

    note right of HPA
        å¹¶å‘çº¿ç¨‹ç­‰å¾… backend å“åº” âž CPU è°ƒåº¦å˜é«˜ âž HPA æ£€æµ‹åˆ° CPU ä¸Šå‡ âž è‡ªåŠ¨æ‰©å®¹ Pod
    end note
```

---

### âœ… Pub/Sub æ¶ˆæ¯è¿›å…¥å¤„ç†çº¿ç¨‹çš„æµè½¬è·¯å¾„

#### Pub/Sub æ¶ˆæ¯è¿›å…¥å¤„ç†çº¿ç¨‹çš„æµè½¬è·¯å¾„

```mermaid
flowchart TD
    PS[Pub/Sub Topic] -->|StreamingPull| SubClient[Java Subscriber Client]

    subgraph SubClient [GKE Pod ä¸­çš„ Subscriber Client]
        direction TB
        Queue[Message QueueBuffer]
        ThreadPool[Thread Pool executor-threads]
        API[è°ƒç”¨ backend APIé˜»å¡žåŒæ­¥]
        Queue -->|1| Thread1[çº¿ç¨‹1 âž message1 âž HTTPè¯·æ±‚] --> API
        Queue -->|2| Thread2[çº¿ç¨‹2 âž message2 âž HTTPè¯·æ±‚] --> API
        Queue -->|...| ThreadN[çº¿ç¨‹N âž messageN âž HTTPè¯·æ±‚] --> API
    end
```

---
