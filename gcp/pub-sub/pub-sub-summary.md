# Q

å¦‚ä½•å¢åŠ  executor-threadsã€‚ä¸è°ƒæ•´ä»£ç é€»è¾‘çš„æƒ…å†µä¸‹åœ¨ Deployment çš„ç¯å¢ƒå˜é‡ä¸­è®¾ç½® Spring Boot çš„é…ç½®ï¼š

env:

â€¢ name:

SPRING_CLOUD_GCP_PUBSUB_SUBSCRIBER_EXECUTOR_THREADS

value: "10"

Spring Boot ä¼šè‡ªåŠ¨å°†å…¶æ˜ å°„ä¸º

spring.cloud.gcp.pubsub.subscriber.executor-threads=10.

ç›®å‰çŠ¶æ€

PRD æ²¡æœ‰æ‰©å®¹ä¹‹å‰

2 ä¸ª Pod\*4 ä¸ª executor-threads ==>æ¥æ”¶è¿™ 8 ä¸ªæ¶ˆæ¯çš„èƒ½åŠ›==>æ‰€æœ‰è®¢é˜…å…±äº«çš„

PRD æ‰©å®¹è¿‡ä¹‹å

4 ä¸ª Pod \*4 ä¸ª executor-threads ==> æ¥æ”¶è¿™ 16 ä¸ªæ¶ˆæ¯çš„èƒ½åŠ›==>æ‰€æœ‰è®¢é˜…å…±äº«çš„

å‡è®¾åˆ°äº†æŸä¸ªæ•´ç‚¹ PUB/SUB

å¯èƒ½å¹¶å‘è¿›æ¥ 50 ä¸ªæ¶ˆæ¯ï¼Œé‚£ä¹ˆæˆ‘é¦–å…ˆè¦æœ‰èƒ½åŠ›ç¬¬ä¸€æ—¶é—´æ¥æ”¶è¿™ 50 ä¸ªæ¶ˆæ¯

==> æ‰€æœ‰è®¢é˜…å…±äº«çš„

é‚£ä¹ˆ 5 ä¸ª Pod \*10 ä¸ª executor-threads æ‰å…·å¤‡è¿™æ ·çš„æ¥æ”¶èƒ½åŠ›ã€è™½ç„¶å¹¶å‘çº¿ç¨‹å¹¶ä¸ä»£è¡¨æ¶ˆæ¯ååè‡ªåŠ¨æå‡ã€‘è‡³äºæˆ‘ä»¬åé¢èƒ½å¦å¤„ç†è¿‡æ¥ æˆ–è€… BackendService æ˜¯å¦èƒ½å½±å“ æˆ‘ä»¬ç¬¬ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œä¹Ÿæ˜¯æœ‰çš„==>å°±æ˜¯è¶…æ—¶çš„ä¼˜åŒ–ï¼Œä¸ºæ¯ä¸ª HTTP è°ƒç”¨è®¾ç½®ï¼Œè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢çº¿ç¨‹æ°¸è¿œé˜»å¡

æˆ‘ä»¬å‡è®¾ CPU è¢«åƒçˆ† é‚£ä¹ˆæˆ‘ä»¬çš„ HPA å¯ä»¥ç¡®ä¿æ¯”å¦‚æˆ‘ä»¬è®¾ç½®ä¸º 5-10 ä¸ª Pod

ä¹Ÿå¯ä»¥æœ‰ä¸€å®šçš„æ‰©å®¹èƒ½åŠ›æ¥æ»¡è¶³è¿™ä¸ªéœ€æ±‚.è¿™æ ·é™ä½äº†å¢åŠ  executor-

threads çš„é£é™©

è€Œä¸”åé¢çš„ backend Service å¯¹äºæˆ‘ä»¬æ¥è¯´æ˜¯

IO å¯†é›†å‹åœºæ™¯ï¼ˆçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´ç­‰å¾… HTTP å“åº”ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥æ”¾å®½çº¿ç¨‹æ•°è®¾ç½® executor-threads æ˜¯å¯è¡Œçš„ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡çš„ä¸»è¦è€—æ—¶ ä¸æ˜¯åœ¨ CPU è®¡ç®—ä¸Šï¼Œè€Œæ˜¯åœ¨ç­‰å¾…ç½‘ç»œã€ç£ç›˜ã€æ•°æ®åº“ã€HTTPã€å¤–éƒ¨ç³»ç»Ÿå“åº”ç­‰ 1O æ“ä½œå®Œæˆ

CPU æ²¡æœ‰åšå¤ªå¤šäº‹ï¼Œåªæ˜¯çº¿ç¨‹ã€è¢«å ç”¨ã€‘å¤„äº é˜»å¡çŠ¶æ€ï¼ˆwaiting for socketresponseï¼‰ã€‚é‚£ä¹ˆè¿™ä¸ªå°±æ˜¯ 10 å¯†é›†å‹åœºæ™¯

è¯„ä¼°æ•´ç‚¹æˆ–è€…æŸä¸ªç‚¹ç¬æ—¶æ‹‰å–æ¶ˆæ¯ä¹Ÿå°±æ˜¯å¹¶å‘æ¶ˆæ¯æ¥ä¹‹åçš„å†…å­˜è€—ç”¨æƒ…å†µã€‚



# A 1

å½“ç„¶å¯ä»¥ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„ Markdown æºç å½¢å¼è¾“å‡ºï¼Œä½ å¯ä»¥ç›´æ¥å¤åˆ¶ç²˜è´´è¿› .md æ–‡ä»¶æˆ–ä½ å…¬å¸çš„æ–‡æ¡£å¹³å°ï¼Œæ— éœ€ä¿®æ”¹å°±èƒ½å‘ˆç°æ ¼å¼ä¸å›¾è¡¨å†…å®¹ã€‚

# âœ… GKE Java Pub/Sub Subscriber å¹¶å‘å¤„ç†èƒ½åŠ›ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

ä¸ºäº†è§£å†³å½“å‰ GKE ä¸­ Pub/Sub æ¶ˆè´¹æœåŠ¡åœ¨ **æ¶ˆæ¯é«˜å³°æ—¶åˆ»ï¼ˆå¦‚æ•´ç‚¹è§¦å‘ï¼‰å“åº”ç¼“æ…¢ã€çº¿ç¨‹è¢«é˜»å¡è¿‡ä¹…** ç­‰é—®é¢˜ï¼Œæˆ‘ä»¬ä»ä¸¤ä¸ªæ ¸å¿ƒæ–¹å‘å‡ºå‘è¿›è¡Œä¼˜åŒ–ï¼š

1. **å¢åŠ çº¿ç¨‹æ± çº¿ç¨‹æ•°ï¼ˆexecutor-threadsï¼‰ä»¥æå‡å¹¶å‘æ¥æ”¶ä¸å¤„ç†èƒ½åŠ›**

2. **ä¼˜åŒ– Backend API çš„è¯·æ±‚è¶…æ—¶ä¸é‡è¯•ç­–ç•¥ï¼Œå‹ç¼©å¤„ç†æ—¶é—´çª—å£**

---

## 1ï¸âƒ£ æå‡çº¿ç¨‹æ± çº¿ç¨‹æ•°ï¼ˆexecutor-threadsï¼‰

### âœ… åœºæ™¯èƒŒæ™¯

å½“å‰ Pod æ¯ä¸ªçº¿ç¨‹åœ¨å¤„ç† Pub/Sub æ¶ˆæ¯æ—¶ï¼Œä¼šå‘èµ·åŒæ­¥ HTTP è¯·æ±‚è‡³ backend APIï¼Œè€Œå“åº”æ—¶é—´é€šå¸¸ä¸º 10~60sï¼Œå±äº **IO å¯†é›†å‹åœºæ™¯**ï¼Œå¯¼è‡´çº¿ç¨‹é•¿æœŸå¤„äº â€œWaitingâ€ çŠ¶æ€ï¼ŒCPU åˆ©ç”¨ç‡ä½ã€‚

### âœ… è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨ Spring Cloud GCP åŸç”Ÿæ”¯æŒé…ç½®é¡¹ï¼š

```yaml

env:

Â  - name: SPRING_CLOUD_GCP_PUBSUB_SUBSCRIBER_EXECUTOR_THREADS

Â  Â  value: "10"
```

ç­‰æ•ˆäºï¼š

spring.cloud.gcp.pubsub.subscriber.executor-threads=10

âœ… æ•ˆæœå¯¹æ¯”ç¤ºæ„å›¾

```mermaid
flowchart TD
    PS[Pub/Sub Topic] -->|StreamingPull| Pod1

    subgraph Pod1 [GKE Pod #1]
        direction TB
        T1[Thread 1 â waiting HTTP]
        T2[Thread 2 â waiting HTTP]
        T3[Thread 3 â waiting HTTP]
        T10[Thread 10 â waiting HTTP]
    end

    note right of Pod1
        æ›´å¤šçº¿ç¨‹ æ›´å¿«æ¥æ”¶å¹¶è¡Œå¤„ç†æ¶ˆæ¯ ç¼“è§£ç¬æ—¶ç§¯å‹
    end note
```

âœ… ç»“åˆ HPA è‡ªåŠ¨æ‰©å®¹èƒ½åŠ›

çº¿ç¨‹æ•°ä¸Šå‡ â HTTP è¯·æ±‚å¹¶å‘å¢å¤š â CPU ä¸Šå‡ â HPA æ‰©å®¹ â æå‡æ•´ä½“åå

|              |                         |
| ------------ | ----------------------- |
| é…ç½®é¡¹       | ç¤ºä¾‹å€¼                  |
| HPA é…ç½®     | minPods: 3, maxPods: 10 |
| CPU trigger  | target: 80%             |
| å®¹å™¨èµ„æºé™åˆ¶ | 1 CPU / 1Gi RAM         |

2ï¸âƒ£ ä¼˜åŒ– Backend API è°ƒç”¨é€»è¾‘ï¼ˆå‹ç¼©è€—æ—¶ï¼‰

âœ… å½“å‰é—®é¢˜

åŸé€»è¾‘ä¸ºåŒæ­¥è°ƒç”¨ + 3 æ¬¡ retryï¼Œæ¯æ¬¡è¶…æ—¶ä¸ºæ•°åˆ†é’Ÿï¼Œæ€»è€—æ—¶æœ€å¤šå¯è¾¾ï¼š

retry #1: 360sï¼ˆå¤±è´¥ï¼‰

retry #2: 360sï¼ˆå¤±è´¥ï¼‰

retry #3: 360sï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰

æ€»è€—æ—¶ â‰ˆ 18 åˆ†é’Ÿ

ä¸¥é‡å ç”¨çº¿ç¨‹èµ„æº â æ— æ³•å¤„ç†æ–°æ¶ˆæ¯ â backlog å¢åŠ 

âœ… æ”¹è¿›æ–¹æ¡ˆ

ä½¿ç”¨è¶…æ—¶æ§åˆ¶æœºåˆ¶ï¼ˆå¦‚ HttpClient è®¾ç½®ï¼‰ï¼Œç¼©çŸ­é‡è¯•å‘¨æœŸ â æ‰€æœ‰ retry æ§åˆ¶åœ¨ 60s å†…å®Œæˆ

```Java

HttpClient client = HttpClient.newBuilder()

Â  Â  .connectTimeout(Duration.ofSeconds(5))

Â  Â  .build();



HttpRequest request = HttpRequest.newBuilder()

Â  Â  .timeout(Duration.ofSeconds(10))Â  // å•æ¬¡è¯·æ±‚æœ€å¤§ 10s

Â  Â  ...

```

âœ… æ–°ç­–ç•¥è®¾è®¡

|          |          |                    |
| -------- | -------- | ------------------ |
| é‡è¯•åºå· | è¶…æ—¶æ—¶é—´ | ç´¯è®¡æ—¶é—´çª—å£       |
| ç¬¬ 1 æ¬¡  | 10s      | 0s ~ 10s           |
| ç¬¬ 2 æ¬¡  | 20s      | 10s ~ 30s          |
| ç¬¬ 3 æ¬¡  | 30s      | 30s ~ 60s          |
| åˆè®¡     |          | âœ… æœ€é•¿ 60s å†…å®Œæˆ |

âœ… æ•ˆæœ

- ç¼“è§£çº¿ç¨‹æ± é˜»å¡å‹åŠ›
- å¿«é€Ÿ fail fastï¼Œé‡Šæ”¾èµ„æº
- é¿å…å›  backend å¼‚å¸¸å¯¼è‡´çº¿ç¨‹é•¿æœŸæŒ‚èµ·æˆ–å †ç§¯

âœ… æ€»ä½“æ•ˆæœå›¾ï¼ˆæ¶ˆæ¯æ¥æ”¶æµç¨‹ + ä¼˜åŒ–ç‚¹ï¼‰

```mermaid

flowchart TD

Â  Â  PubSub[Pub/Sub Topic] -->|StreamingPull| Queue[æ¶ˆæ¯é˜Ÿåˆ—]



Â  Â  subgraph Pod [GKE Pod]

Â  Â  Â  Â  direction TB

Â  Â  Â  Â  Queue -->|1| Thread1[çº¿ç¨‹1 â message1 â HTTPè¯·æ±‚ â è¶…æ—¶æ§åˆ¶]

Â  Â  Â  Â  Queue -->|2| Thread2[çº¿ç¨‹2 â message2 â HTTPè¯·æ±‚ â è¶…æ—¶æ§åˆ¶]

Â  Â  Â  Â  Queue -->|...| ThreadN[çº¿ç¨‹N â messageN â HTTPè¯·æ±‚ â è¶…æ—¶æ§åˆ¶]

Â  Â  end



Â  Â  note right of Pod

Â  Â  Â  Â  executor-threads æé«˜ â æ”¯æŒæ›´å¤šå¹¶å‘è¯·æ±‚\n

Â  Â  Â  Â  æ¯ä¸ªçº¿ç¨‹ä»»åŠ¡åœ¨ 60s å†…å®Œæˆ â å¿«é€Ÿé‡Šæ”¾èµ„æº

Â  Â  end note
Â  Â  ```









ğŸ§  æ€»ç»“å¯¹æ¯”è¡¨



|   |   |   |   |
|---|---|---|---|
|ç»´åº¦|ä¼˜åŒ–å‰|ä¼˜åŒ–å|æ•ˆæœ|
|æ¯ä¸ª Pod çº¿ç¨‹æ•°|é»˜è®¤ 4|å¢åŠ è‡³ 10|æ¯ Pod å¹¶å‘å¤„ç†èƒ½åŠ›æå‡|
|è¯·æ±‚é˜»å¡æ—¶é—´|æœ€é•¿ 18 åˆ†é’Ÿ|é™åˆ¶åœ¨ 1 åˆ†é’Ÿå†…|å¿«é€Ÿé‡Šæ”¾çº¿ç¨‹èµ„æº|
|GKE HPA æ•æ„Ÿåº¦|CPU åˆ©ç”¨ä½ â æ‰©å®¹æ…¢|CPU æŠ¬å‡ â è‡ªåŠ¨è§¦å‘|æ”¯æ’‘é«˜å³°å¹¶å‘|
|å¹¶å‘èƒ½åŠ›|æ˜“ backlog|å¯åº”å¯¹ç¬æ—¶ 50+ æ¶ˆæ¯|ğŸŸ¢ ç¨³å®šå¯é |









âœ… è½åœ°å»ºè®®





1. ä¿®æ”¹ Deployment é…ç½®ï¼Œå¢åŠ çº¿ç¨‹æ± è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆexecutor-threads=10ï¼‰
2. é…ç½® HTTP è¯·æ±‚çº§åˆ«çš„è¿æ¥/å“åº”è¶…æ—¶ï¼Œä½¿ç”¨ fail fast ç­–ç•¥
3. åœ¨ GKE ä¸Šè®¾ç½®åˆç†çš„ HPA é˜ˆå€¼ä¸èµ„æºé™åˆ¶
4. è”åŠ¨ç›‘æ§ç³»ç»Ÿè§‚å¯Ÿçº¿ç¨‹æ± é˜Ÿåˆ—é•¿åº¦ã€CPU åˆ©ç”¨ç‡ã€å¤„ç†å»¶è¿Ÿ
5. è§†æƒ…å†µè¿›ä¸€æ­¥ä¼˜åŒ–ä¸ºå¼‚æ­¥éé˜»å¡æ¨¡å‹ï¼ˆå¦‚ WebClient + Reactorï¼‰


# A 2

ä½ è¿™æ®µåˆ†æéå¸¸æ¸…æ™°ï¼Œæ€è·¯å¯¹å¾—éå¸¸åˆ°ä½ã€‚ä¸‹é¢æˆ‘æ¥å¸®ä½ æ•´ç†å¹¶æ€»ç»“ä¸ºä¸€ä¸ªç»“æ„åŒ–çš„éƒ¨ç½²ä¼˜åŒ–å»ºè®®ï¼Œä¾¿äºä½ å†…éƒ¨è½åœ°æˆ–ä½œä¸ºè¯„å®¡æ–‡æ¡£ä½¿ç”¨ã€‚

âœ… GKE Java Pub/Sub Subscriber ä¼˜åŒ–æ€»ç»“ä¸å»ºè®®

ğŸ¯ å½“å‰ç›®æ ‡

æå‡ GKE ä¸­ Java Subscriber å®¢æˆ·ç«¯å¯¹ ç¬æ—¶å¹¶å‘æ¶ˆæ¯æ‹‰å–ä¸å¤„ç†èƒ½åŠ›ï¼Œé¿å…æ•´ç‚¹è§¦å‘æ—¶çš„â€œæ¶ˆæ¯å †ç§¯â€æˆ–â€œå“åº”è¶…æ—¶â€é—®é¢˜ã€‚

ğŸ§  èƒŒæ™¯ç°çŠ¶

|                  |                                           |
| ---------------- | ----------------------------------------- |
| é¡¹ç›®             | å½“å‰é…ç½®                                  |
| GKE Pod          | é»˜è®¤æ¯ä¸ª Pod é…ç½® 1 vCPU / 1Gi            |
| HPA              | å·²å¯ç”¨ï¼Œæ”¯æŒ Pod åŠ¨æ€æ‰©å®¹ï¼ˆ5 ~ 10 ä¸ªï¼‰    |
| executor-threads | é»˜è®¤ä¸ºæ¯ä¸ª Pod 4 ä¸ªçº¿ç¨‹ï¼ˆåŒæ­¥é˜»å¡ IOï¼‰    |
| Pub/Sub æ¶ˆæ¯     | æ¯ä¸ªæ•´ç‚¹å¯èƒ½æœ‰ 50+ å¹¶å‘æ¶ˆæ¯               |
| backend service  | å“åº”ä¸ç¨³å®šï¼ˆ10s ~ 60sï¼‰ï¼Œä¸º IO å¯†é›†å‹æ“ä½œ |

âœ… å®æ–½æ–¹æ¡ˆæ€»ç»“

ğŸ§© 1.

é€šè¿‡ Deployment ç¯å¢ƒå˜é‡åŠ¨æ€é…ç½® executor-threads

æ— éœ€æ”¹ä»£ç ï¼Œç›´æ¥é€šè¿‡ env æ³¨å…¥ Spring Boot é…ç½®ï¼š

env:

- name: SPRING_CLOUD_GCP_PUBSUB_SUBSCRIBER_EXECUTOR_THREADS

value: "10"

Spring Boot ä¼šè‡ªåŠ¨æ˜ å°„ä¸ºï¼š

spring.cloud.gcp.pubsub.subscriber.executor-threads=10

ğŸ§© 2.

ç†è§£æ•´ä½“å¤„ç†èƒ½åŠ›ï¼ˆçº¿ç¨‹æ€»æ•° = Pod æ•° Ã— æ¯ Pod çº¿ç¨‹æ•°ï¼‰

|                |                  |                          |
| -------------- | ---------------- | ------------------------ |
| åœºæ™¯           | è®¡ç®—             | æ€»çº¿ç¨‹æ•°ï¼ˆå¹¶å‘å¤„ç†èƒ½åŠ›ï¼‰ |
| åˆå§‹           | 2 Pod Ã— 4 çº¿ç¨‹   | 8                        |
| æ‰©å®¹å         | 4 Pod Ã— 4 çº¿ç¨‹   | 16                       |
| ä¼˜åŒ–åï¼ˆæ¨èï¼‰ | 5 Pod Ã— 10 çº¿ç¨‹  | 50 âœ…                    |
| æ»¡è½½å         | 10 Pod Ã— 10 çº¿ç¨‹ | 100 ğŸ”                   |

ğŸ§© 3.

æ¶ˆæ¯æ‹‰å–ä¸ executor çº¿ç¨‹è§£è€¦è¯´æ˜

- Pub/Sub StreamingPull ä¼šæ ¹æ® buffer è®¾ç½®é¢„æ‹‰æ¶ˆæ¯
- åªæœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œæ¶ˆæ¯æ‰ä¼šè¿›å…¥æ¶ˆè´¹ï¼ˆMessageReceiver.onMessage()ï¼‰
- æ‰€ä»¥æå‡çº¿ç¨‹æ•°å¯ä»¥æå‡ç¬¬ä¸€æ—¶é—´â€œæ¥æ”¶+å¤„ç†â€çš„æœ€å¤§åå

ğŸ§© 4.

é£é™©æ§åˆ¶ï¼šä¸ºä»€ä¹ˆè¿™å¥—æ–¹æ¡ˆæ˜¯å¹³æ»‘çš„ï¼Ÿ

|                  |                                   |                                    |
| ---------------- | --------------------------------- | ---------------------------------- |
| ç»´åº¦             | æ§åˆ¶ç­–ç•¥                          | è¯´æ˜                               |
| CPU å ç”¨         | HPA è‡ªåŠ¨æ‰©å®¹                      | çº¿ç¨‹å¤šæ—¶ CPU ä¸Šå‡ â è‡ªåŠ¨æ‰© Pod     |
| å†…å­˜å ç”¨         | ä¸å»ºè®® executor > 16ï¼ˆ1Giï¼‰       | é¿å… OOMï¼ˆçº¿ç¨‹æ± å †æ ˆ+æ¶ˆæ¯ bufferï¼‰ |
| è¯·æ±‚é˜»å¡         | åŠ å…¥ HTTP è¶…æ—¶é™åˆ¶ï¼ˆå¦‚ 20sï¼‰      | é¿å…çº¿ç¨‹æ°¸ä¹…é˜»å¡                   |
| Pub/Sub æ¶ˆæ¯é¢„æ‹‰ | é…ç½® maxOutstandingMessages æ§åˆ¶  | é˜²æ­¢ç§¯å‹è¿‡å¤šæœªå¤„ç†æ¶ˆæ¯             |
| åç«¯æœåŠ¡æ…¢       | å±äº IO å¯†é›† â æ›´é€‚åˆé«˜çº¿ç¨‹æ•°     | ä¸ä¼š CPU çˆ†ï¼Œä½†çº¿ç¨‹è¢«æŒ‚èµ·          |
| è§¦å‘é«˜å³°æ¶ˆæ¯ç§¯å‹ | å¢åŠ æ€»çº¿ç¨‹æ•°å¯ä»¥ç¼“è§£æ¥æ”¶/å“åº”ç“¶é¢ˆ | âœ… ç›®æ ‡ä¼˜åŒ–ç‚¹å³åœ¨æ­¤                |

ğŸ§© 5.

å¯é€‰å¢å¼ºé¡¹ï¼ˆåç»­ä¼˜åŒ–æ–¹å‘ï¼‰

|                                           |                                  |
| ----------------------------------------- | -------------------------------- |
| ä¼˜åŒ–æ–¹å‘                                  | è¯´æ˜                             |
| ä½¿ç”¨ WebClient + Reactor å¼‚æ­¥è°ƒç”¨ backend | æå‡çº¿ç¨‹åˆ©ç”¨ç‡ï¼ˆéé˜»å¡ IOï¼‰      |
| å°†æ…¢æ¥å£ / å¿«æ¥å£æ‹†åˆ†ä¸åŒ Subscription    | æŒ‰ SLA è®¾å®šä¸åŒçº¿ç¨‹æ•°æˆ– Pod è§„æ¨¡ |
| é…ç½® DLQï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰                      | é¿å…å¤±è´¥è¯·æ±‚æ— é™å †ç§¯é‡è¯•         |
| è®¾ç½® message TTL                          | å¯¹å¤„ç†è¶…æ—¶çš„æ¶ˆæ¯è‡ªåŠ¨æ¸…ç†         |

âœ… å°ç»“

**æå‡ executor-threads æ˜¯åˆç†ä¸”å¯æ§çš„ä¼˜åŒ–æ‰‹æ®µï¼Œå°¤å…¶åœ¨ IO å¯†é›†å‹åœºæ™¯ä¸‹ã€‚**æ­é… GKE HPA å¯å®ç°èµ„æºè‡ªåŠ¨è°ƒèŠ‚ï¼Œæå‡æ•´ä½“ç³»ç»Ÿååèƒ½åŠ›å¹¶é™ä½ç¬æ—¶å †ç§¯é£é™©ã€‚

å¦‚ä½ éœ€è¦ï¼Œæˆ‘è¿˜å¯ä»¥ï¼š

- å¸®ä½ ç”Ÿæˆä¸€ä»½æ ‡å‡†æ ¼å¼çš„ã€Œæ€§èƒ½ä¼˜åŒ–å˜æ›´è¯´æ˜æ–‡æ¡£ã€
- å¸®ä½ ç”»å‡ºã€Œçº¿ç¨‹æ± å ç”¨ä¸æ‰©å®¹å…³ç³»å›¾ã€ã€ŒPub/Sub æ¶ˆæ¯è¿›å…¥å¤„ç†çº¿ç¨‹çš„æµè½¬è·¯å¾„ã€

æ˜¯å¦éœ€è¦ï¼Ÿ

# è®¾ç½®æ¶ˆæ¯ TTL

å½“ç„¶å¯ä»¥ï¼ŒPub/Sub ä¸­çš„æ¶ˆæ¯ TTLï¼ˆTime to Liveï¼‰ æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½ï¼Œç”¨äºè‡ªåŠ¨æ¸…ç†é‚£äº›â€œè¶…æ—¶æœªè¢« ackâ€çš„æ¶ˆæ¯ï¼Œé¿å…æ¶ˆæ¯æ°¸ä¹…å †ç§¯æˆ–åå¤é‡æŠ•é€’ã€‚

ä¸‹é¢æˆ‘æ¥è¯¦ç»†è§£é‡Šå…¶å«ä¹‰ã€ä½œç”¨ã€è®¾ç½®æ–¹å¼ã€æ³¨æ„äº‹é¡¹ï¼Œå¹¶é™„å¸¦æ“ä½œç¤ºä¾‹ã€‚

âœ… ä»€ä¹ˆæ˜¯ Message TTLï¼Ÿ

Message TTL æ˜¯æŒ‡ä¸€æ¡æ¶ˆæ¯åœ¨ Pub/Sub Topic ä¸­å¯ä»¥â€œç”Ÿå­˜â€çš„æœ€å¤§æ—¶é—´ã€‚å¦‚æœåœ¨è¿™ä¸ªæ—¶é—´å†…æ²¡æœ‰è¢«æˆåŠŸ ackï¼Œå®ƒå°†è¢« è‡ªåŠ¨åˆ é™¤ï¼Œä¸å†æŠ•é€’ã€‚

âœ… ä¸ºä»€ä¹ˆéœ€è¦è®¾ç½® Message TTLï¼Ÿ

|                     |                                                  |
| ------------------- | ------------------------------------------------ |
| åŸå›                 | è¯´æ˜                                             |
| ğŸ” é˜²æ­¢æ¶ˆæ¯æ°¸è¿œé‡è¯• | æŸäº›æ¶ˆæ¯å¯èƒ½å› é€»è¾‘ç¼ºé™·æˆ–åç«¯ä¸å¯ç”¨ï¼Œå§‹ç»ˆå¤„ç†å¤±è´¥ |
| ğŸ§  å‡å°‘èµ„æºæµªè´¹     | é‡è¯•å¤±è´¥ä¼šå ç”¨è®¢é˜…è€…çº¿ç¨‹ã€CPUã€ç½‘ç»œèµ„æº          |
| ğŸ§¹ æ¸…ç†è„æ•°æ®       | é¿å…å¤šå¹´å†å²æ— ç”¨æ¶ˆæ¯å †ç§¯ï¼ˆå¦‚ test topicï¼‰        |
| âœ… æé«˜ç³»ç»Ÿç¨³å®šæ€§   | æ§åˆ¶æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸï¼Œæé«˜å¯é¢„æµ‹æ€§                   |

âœ… Pub/Sub TTL è®¾ç½®ä½ç½®è¯´æ˜

|                      |                                                        |
| -------------------- | ------------------------------------------------------ |
| ç»„ä»¶                 | TTL è®¾ç½®ä½ç½®                                           |
| âœ… Topic å±‚é¢        | æ¶ˆæ¯å‘å¸ƒåæœ€å¤šä¿ç•™å¤šä¹…ï¼ˆæ— è®ºæ˜¯å¦è¢«è®¢é˜…ï¼‰               |
| âŒ Subscription å±‚é¢ | ä¸æ”¯æŒè®¾ç½® TTLï¼Œä½†å¯ä»¥è®¾ç½® ackDeadlineï¼ˆå•æ¬¡å¤„ç†æ—¶é—´ï¼‰ |

âœ… è®¾ç½®æ–¹å¼ï¼ˆTTL æ˜¯ Topic å±‚çº§å±æ€§ï¼‰

ğŸ”§ ä½¿ç”¨

gcloud

è®¾ç½®ï¼ˆåˆ›å»ºæ—¶æŒ‡å®š TTLï¼‰ï¼š

gcloud pubsub topics create my-topic \

--message-retention-duration=600sÂ  # TTL = 10 åˆ†é’Ÿ

ğŸ”„ å·²æœ‰ Topic è®¾ç½® TTLï¼ˆæ›´æ–°ï¼‰ï¼š

gcloud pubsub topics update my-topic \

--message-retention-duration=3600sÂ  # TTL = 1 å°æ—¶

âœ… TTL æœ€å°å€¼æ˜¯ 10sï¼Œæœ€å¤§å€¼æ˜¯ 7 å¤©ï¼ˆé»˜è®¤ 7 å¤©ï¼‰

âœ… å·¥ä½œæœºåˆ¶å›¾ç¤º
```mermaid
sequenceDiagram

participant Client as Publisher

participant PS as Pub/Sub Topic

participant SS as GKE Pod

participant API as Backend

Client->>PS: Publish message at t=0

Note over PS: TTL å¼€å§‹è®¡æ—¶ï¼ˆè®¾ç½®ä¸º 600sï¼‰

SS->>PS: StreamingPull æ¥æ”¶æ¶ˆæ¯

SS->>+API: è°ƒç”¨åç«¯ API

API-->>-SS: å“åº”å¤±è´¥ / é˜»å¡

alt æœªåœ¨ ackDeadline å†… ack

Note over PS: é‡æŠ•é€’ï¼ˆé‡è¯•ä¸­ï¼‰

end

alt è¶…è¿‡ TTL æ—¶é—´

PS-->>SS: ä¸å†æŠ•é€’ï¼Œæ¶ˆæ¯ä¸¢å¼ƒ âŒ

end
``` 

âœ… æ³¨æ„äº‹é¡¹

|                              |                                                        |
| ---------------------------- | ------------------------------------------------------ |
| é¡¹ç›®                         | æ³¨æ„ç‚¹                                                 |
| TTL â‰  ackDeadline            | ackDeadline æ˜¯â€œå•æ¬¡å¤„ç†è¶…æ—¶æ—¶é—´â€ï¼ŒTTL æ˜¯â€œæ¶ˆæ¯æ€»å¯¿å‘½â€   |
| æ— æ³•é…ç½®åœ¨ Subscription ä¸Š   | TTL å¿…é¡»åœ¨ Topic ä¸Šè®¾ç½®                                |
| è¶…æ—¶ä¸ä¼šè¿›å…¥ DLQï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰ | DLQ è§¦å‘æ¡ä»¶æ˜¯â€œack å¤±è´¥æ¬¡æ•°è¶…é™â€ï¼ŒTTL è¶…æ—¶ä¸ä¼šè§¦å‘ DLQ |
| é€‚ç”¨äºâ€œè¿‡æœŸå°±æ²¡æ„ä¹‰â€çš„æ¶ˆæ¯   | å¦‚å®šæ—¶ä»»åŠ¡é€šçŸ¥ã€å®æ—¶æŒ‡æ ‡ã€CI/CD trigger ç­‰             |

ğŸ¯ å®æˆ˜å»ºè®®ï¼ˆç»“åˆä½ çš„æƒ…å†µï¼‰

|                         |                              |
| ----------------------- | ---------------------------- |
| ç±»å‹                    | å»ºè®® TTL è®¾ç½®                |
| è°ƒç”¨åç«¯ API çš„è°ƒåº¦æ¶ˆæ¯ | 600sï¼ˆå³ 10 åˆ†é’Ÿï¼‰           |
| å®æ—¶é€šçŸ¥ç±»äº‹ä»¶          | 60~180s                      |
| éœ€è¦ç¡®ä¿æœ€ç»ˆå¤„ç†çš„æ¶ˆæ¯  | TTL é•¿ï¼ˆé»˜è®¤ 7dï¼‰ + é…ç½® DLQ |
| ä¸´æ—¶æµ‹è¯•ç”¨ Topic        | 300sï¼Œé¿å…é—ç•™è„æ•°æ®         |

âœ… æ€»ç»“ä¸€å¥è¯

Pub/Sub Topic çš„ TTL è®¾ç½®å¯ç¡®ä¿æ¶ˆæ¯ä¸ä¼šæ°¸ä¹…å †ç§¯æˆ–æ— é™é‡è¯•ï¼Œæ˜¯æ§åˆ¶ç³»ç»Ÿç¨³å®šæ€§ä¸èµ„æºåˆ©ç”¨çš„å…³é”®ç­–ç•¥ä¹‹ä¸€ã€‚

æ˜¯å¦éœ€è¦æˆ‘ä¹Ÿå¸®ä½ ä¸€å¹¶æ¢³ç† Pub/Sub ä¸­å…³äº ackDeadlineã€TTLã€Retryã€DLQ ç­‰å‡ ä¸ªæ¦‚å¿µçš„å¯¹æ¯”å›¾ï¼Ÿé‚£æ ·ä½ å¯ä»¥ç”¨äºå†…éƒ¨åˆ†äº«æˆ–æ–‡æ¡£è¯´æ˜ã€‚


### åœºæ™¯æè¿°ï¼š
å½“å‰ Java Pub/Sub å®¢æˆ·ç«¯è¿è¡Œåœ¨ GKE Pod ä¸­ï¼Œé‡‡ç”¨ StreamingPull æ‹‰å–æ¶ˆæ¯ï¼Œä½¿ç”¨çº¿ç¨‹æ± ï¼ˆexecutor-threadsï¼‰è¿›è¡Œ HTTP è°ƒç”¨ï¼ˆåŒæ­¥é˜»å¡ï¼‰ã€‚ä¸ºé¿å…çº¿ç¨‹é˜»å¡å¯¼è‡´ç³»ç»Ÿå¡é¡¿ï¼Œé€šè¿‡ HPA å¯¹ CPU å ç”¨è¿›è¡Œç›‘æ§å¹¶è§¦å‘è‡ªåŠ¨æ‰©å®¹ã€‚



âœ… çº¿ç¨‹æ± å ç”¨ä¸ GKE HPA æ‰©å®¹å…³ç³»å›¾

#### çº¿ç¨‹æ± å ç”¨ä¸ GKE HPA æ‰©å®¹å…³ç³»å›¾

```mermaid
flowchart TD
    PS[Pub/Sub Topic] -->|StreamingPull| Pod1
    PS -->|StreamingPull| Pod2

    subgraph Pod1 [GKE Pod #1 (1 vCPU)]
        direction TB
        T1[Thread 1 â waiting HTTP]
        T2[Thread 2 â waiting HTTP]
        T3[Thread 3 â waiting HTTP]
        T4[Thread 4 â waiting HTTP]
        CPU1[CPU ä½¿ç”¨ç‡æå‡] -->|è§¦å‘ HPA| HPA[Pod æ‰©å®¹è§¦å‘]
    end

    subgraph Pod2 [GKE Pod #2 (1 vCPU)]
        direction TB
        T5[Thread 1 â waiting HTTP]
        T6[Thread 2 â waiting HTTP]
        T7[Thread 3 â waiting HTTP]
        T8[Thread 4 â waiting HTTP]
        CPU2[CPU ä½¿ç”¨ç‡æå‡] -->|è§¦å‘ HPA| HPA
    end

    HPA --> Pod3[ğŸ†• Pod #3 å¯åŠ¨]
    Pod3 -->|å»ºç«‹ StreamingPull| PS

    note right of HPA
        å¹¶å‘çº¿ç¨‹ç­‰å¾… backend å“åº” â CPU è°ƒåº¦å˜é«˜ â HPA æ£€æµ‹åˆ° CPU ä¸Šå‡ â è‡ªåŠ¨æ‰©å®¹ Pod
    end note
``` 
---

### âœ… Pub/Sub æ¶ˆæ¯è¿›å…¥å¤„ç†çº¿ç¨‹çš„æµè½¬è·¯å¾„

```markdown
#### Pub/Sub æ¶ˆæ¯è¿›å…¥å¤„ç†çº¿ç¨‹çš„æµè½¬è·¯å¾„

```mermaid
flowchart TD
    PS[Pub/Sub Topic] -->|StreamingPull| SubClient[Java Subscriber Client]

    subgraph SubClient [GKE Pod ä¸­çš„ Subscriber Client]
        direction TB
        Queue[Message Queue(Buffer)]
        ThreadPool[Thread Pool (executor-threads)]
        API[è°ƒç”¨ backend APIï¼ˆé˜»å¡åŒæ­¥ï¼‰]
        Queue -->|1| Thread1[çº¿ç¨‹1 â message1 â HTTPè¯·æ±‚] --> API
        Queue -->|2| Thread2[çº¿ç¨‹2 â message2 â HTTPè¯·æ±‚] --> API
        Queue -->|...| ThreadN[çº¿ç¨‹N â messageN â HTTPè¯·æ±‚] --> API
    end

    note right of ThreadPool
        Pub/Sub StreamingPull ä¼šé¢„å…ˆå¡«å……æ¶ˆæ¯é˜Ÿåˆ—ï¼Œ
        ç©ºé—²çº¿ç¨‹æ‹‰å‡ºæ¶ˆæ¯å¤„ç†ï¼Œ
        å¦‚æœçº¿ç¨‹éƒ½è¢«é˜»å¡ï¼Œä¼šå‡ºç°å¤„ç† backlog
    end note
```
---
 

