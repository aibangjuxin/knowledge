| **å­—æ®µ**                 | **ç¤ºä¾‹å€¼** | **è¯´æ˜**                                        |
| ---------------------- | ------- | --------------------------------------------- |
| **ackDeadlineSeconds** | 10      | è®¢é˜…è€…åœ¨è¿™æ®µæ—¶é—´ï¼ˆç§’ï¼‰å†…ç¡®è®¤æ¶ˆæ¯ï¼Œå¦åˆ™æ¶ˆæ¯å°†é‡æ–°æŠ•é€’ã€‚é»˜è®¤æ˜¯ 10 ç§’ã€‚æœ€å¤§ 600 ç§’ã€‚ |

æˆ‘ä»¬è®¾ç½®ä¸º 600S
unacked æ€»æ•°æ˜¯å¦ä¸€ç›´å¢é•¿ï¼ˆçº¿ç¨‹/å¤„ç†å¤ªæ…¢ï¼‰

è§‚å¯Ÿåˆ° unacked messages è¶Šæ¥è¶Šå¤šï¼Œè¯´æ˜æ¶ˆæ¯è¢«æ‹‰å–åï¼Œ600s å†…ä»æœª ackï¼Œæˆ–çº¿ç¨‹æ²¡æœ‰åŠæ—¶å¤„ç†å®Œ

å¦‚æœè¿™ä¸ªçº¿ç¨‹æ± å¤ªå°ï¼ˆä¾‹å¦‚ 2~4 ä¸ªçº¿ç¨‹ï¼‰\*\*

- å¦‚æœ Pub/Sub æ¯ç§’æ¨é€ 50 æ¡æ¶ˆæ¯
- ä½†ä½ åªæœ‰ 4 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªå¤„ç†è€—æ—¶ 20 ç§’
- åˆ™æœ€å¤šåªèƒ½å¤„ç† 3/min Ã— 4 = 12 æ¡/minï¼Œå…¶å®ƒç§¯å‹
- å‰©ä½™æ¶ˆæ¯æ— æ³•åœ¨ 600 ç§’å†…å®Œæˆæ¶ˆè´¹ â‡’ å¯¼è‡´ \*\*unacked å¢é•¿

ä½ æåˆ°çš„ **â€œUnacked messages by region > 20 in 5minâ€** æ˜¯ Google Cloud Pub/Sub ä¸­ä¸€ä¸ªéå¸¸å…³é”®çš„æ€§èƒ½/å¥åº·æŒ‡æ ‡ï¼Œè¯´æ˜ï¼š

> âœ… æ¶ˆè´¹è€…è®¢é˜…äº†æ¶ˆæ¯ï¼Œä½†**æœªåœ¨ ack deadline æ—¶é—´å†… ack**ï¼ˆç¡®è®¤æ¥æ”¶ï¼‰ï¼Œå¯¼è‡´æ¶ˆæ¯å¤„äº **Unackedï¼ˆå¾…ç¡®è®¤ï¼‰** çŠ¶æ€ã€‚

---

## **âœ… ä¸€å›¾ç†è§£ï¼šUnacked message çŠ¶æ€**

```mermaid
flowchart TD
    A[Pub/Sub Topic] --> B[Subscription]
    B --> C[Push æˆ– Pull æ‹‰å–æ¶ˆæ¯]
    C --> D[æ¶ˆæ¯æŠ•é€’ç»™ ScheduleService]
    D --> E[åº”ç”¨é€»è¾‘å¤„ç†ä¸­]
    E --> F{æ˜¯å¦ ackï¼Ÿ}
    F -- å¦ï¼Œè¶…æ—¶ --> G[æ¶ˆæ¯è¿›å…¥ unacked çŠ¶æ€]
    G -- deadline è¾¾åˆ° --> B[é‡æ–°æŠ•é€’æ¶ˆæ¯ï¼ˆé‡è¯•ï¼‰]
```

---

## **âœ… å‡ºç° Unacked Message å¸¸è§åŸå› **

| **åŸå› ç±»å‹**              | **å¯èƒ½çš„æŒ‡æ ‡ä¿¡å· / ç°è±¡**                  | **è¯´æ˜**                 |
| ------------------------- | ------------------------------------------ | ------------------------ |
| âŒ ScheduleService æ²¡ ack | ä»£ç é€»è¾‘å¼‚å¸¸ã€æ—  consumer.ack() æˆ–æœªæ‰§è¡Œåˆ° | æœªæ˜¾å¼ ack/nack æ¶ˆæ¯     |
| â± å¤„ç†è¶…æ—¶                | ack_deadline é…ç½®ä¸è¶³                      | é»˜è®¤ 10sï¼Œå¤„ç†è¶…æ—¶ä¼šé‡æŠ• |
| ğŸ§µ å¹¶å‘ä¸è¶³               | æ¶ˆè´¹çº¿ç¨‹ä¸å¤Ÿï¼Œæ¶ˆæ¯å¤„ç†ç§¯å‹                 | executorThreadCount å¤ªå° |
| ğŸ“¦ ç§¯å‹å¤ªå¤š               | æ¶ˆæ¯è¿›æ¥å¤ªå¿«ï¼Œå¤„ç†è·Ÿä¸ä¸Š                   | flowControlSettings é™æµ |
| â— æŠ›å‡ºå¼‚å¸¸æœªå¤„ç†         | æœª try/catchï¼Œå¯¼è‡´å¤„ç†é€»è¾‘ç›´æ¥ crash       | æ¶ˆæ¯æœª ackï¼Œä¹Ÿæœª nack    |
| ğŸš« åº”ç”¨ç“¶é¢ˆ               | CPU å¿™ã€ç½‘ç»œè°ƒç”¨æ…¢ã€è¿æ¥æ± æ¯ç«­             | Java æœåŠ¡æœ¬èº«å¤„ç†æ…¢      |

---

## **âœ… æ’æŸ¥å®šä½æ­¥éª¤ï¼ˆå»ºè®®é¡ºåºï¼‰**

### **1ï¸âƒ£ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡åˆ†æ**

ä½¿ç”¨ **Cloud Monitoring (Stackdriver)** æˆ– **Grafana/Prometheus** å¯¹æ¯”ä»¥ä¸‹æŒ‡æ ‡ï¼š

| **æŒ‡æ ‡å**                                                    | **è¯´æ˜**                                |
| ------------------------------------------------------------- | --------------------------------------- |
| subscription/num_undelivered_messages                         | Topic ä¸­æœªè¢«æŠ•é€’çš„æ¶ˆæ¯æ•°                |
| subscription/num_unacked_messages                             | å·²æŠ•é€’ä½†æœª ack çš„æ¶ˆæ¯æ•°ï¼ˆä½ ç°åœ¨å…³æ³¨çš„ï¼‰ |
| subscription/ack_message_count                                | æˆåŠŸ ack çš„æ€»æ•°                         |
| subscription/pull_ack_latency                                 | æ¶ˆè´¹åˆ° ack çš„è€—æ—¶åˆ†å¸ƒ                   |
| subscription/expired_ack_deadlines_count                      | æœª ack è¶…æ—¶å¯¼è‡´é‡æ–°æŠ•é€’çš„æ¬¡æ•°           |
| pubsub.googleapis.com/subscription/oldest_unacked_message_age | æœ€è€æœª ack æ¶ˆæ¯ç­‰å¾…æ—¶é—´                 |

ğŸ‘‰ é‡ç‚¹çœ‹ï¼š

- unacked æ€»æ•°æ˜¯å¦ä¸€ç›´å¢é•¿ï¼ˆçº¿ç¨‹/å¤„ç†å¤ªæ…¢ï¼‰
- ack_latency æ˜¯å¦å˜å¤§ï¼ˆæ…¢ï¼‰
- expired_ack_deadlines æ˜¯å¦é£™å‡ï¼ˆè¢«é‡æ–°æŠ•é€’ï¼‰

---

### **2ï¸âƒ£ æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼ˆScheduleServiceï¼‰**

å®šä½æ˜¯å¦å­˜åœ¨ä»¥ä¸‹å¼‚å¸¸ï¼š

```
ERROR: Exception during message processing
WARN: Retry logic failed after 3 attempts
```

> çœ‹ä½ æ˜¯å¦åœ¨ try/catch ä¸­ä¸¢å¤±å¼‚å¸¸ã€æœª ackã€é€»è¾‘å¤ªæ…¢ï¼ˆæ¯”å¦‚è°ƒç”¨å¤–éƒ¨ HTTP é˜»å¡ï¼‰

---

### **3ï¸âƒ£**Â 

### **jstack**

### Â **åˆ†æçº¿ç¨‹å †æ ˆçŠ¶æ€**

è¿›å…¥ Podï¼š

```
kubectl exec -it POD_NAME -- jstack 1 | less
```

æœç´¢å…³é”®è¯ï¼š

- WAITING / BLOCKED â†’ çº¿ç¨‹æ˜¯å¦è¢«é”æˆ–é˜»å¡
- http-nio-_ / ForkJoinPool / task-_ â†’ å“ªäº›çº¿ç¨‹æ± ç¹å¿™

---

### **4ï¸âƒ£ æŸ¥çœ‹ä½ çš„ Pub/Sub æ¶ˆè´¹é…ç½®ï¼ˆæ˜¯å¦è®¾ç½®åˆç†ï¼‰**

#### **âœ… FlowControl + Executor è®¾ç½®æ˜¯å¦è¶³å¤Ÿï¼š**

```java
Subscriber.newBuilder(subscriptionName, receiver)
    .setFlowControlSettings(
        FlowControlSettings.newBuilder()
            .setMaxOutstandingElementCount(1000)
            .setMaxOutstandingRequestBytes(20 * 1024 * 1024)
            .build()
    )
    .setExecutorProvider(
        InstantiatingExecutorProvider.newBuilder().setExecutorThreadCount(20).build()
    )
```

å¦‚æœè®¾ç½®å¤ªå°ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯æ’é˜Ÿ â†’ æœªåŠæ—¶æ¶ˆè´¹ â†’ è¶…è¿‡ deadline â†’ unacked ç´¯ç§¯ã€‚

---

### **5ï¸âƒ£ æ£€æŸ¥ AckDeadline æ˜¯å¦éœ€è¦è°ƒæ•´**

```
gcloud pubsub subscriptions update my-sub \
  --ack-deadline=60  # å•ä½æ˜¯ç§’ï¼Œæœ€é•¿ 600
```

å¦‚æœä½ çš„å¤„ç†é€»è¾‘è¾ƒé‡ï¼ˆä¾‹å¦‚ HTTP é‡è¯•ï¼‰ï¼Œ10s é»˜è®¤æ˜¯è¿œè¿œä¸å¤Ÿçš„ã€‚
æˆ‘ä»¬æ˜¯ 600S ç›‘æ§çš„

---

### **6ï¸âƒ£ æ£€æŸ¥å¤„ç†é€»è¾‘ä¸­çš„å¤–éƒ¨è°ƒç”¨è€—æ—¶ï¼ˆè°ƒç”¨ Kong æˆ– BackendAPIï¼‰**

å»ºè®®åœ¨æ¶ˆè´¹é€»è¾‘é‡Œåšå¦‚ä¸‹ç›‘æ§åŸ‹ç‚¹ï¼š

```java
long start = System.currentTimeMillis();
try {
  callBackend();
  consumer.ack();
} catch (Exception e) {
  consumer.nack();
} finally {
  metrics.timer("pubsub.processing.latency").record(System.currentTimeMillis() - start);
}
```

å¹¶å¯¹ callBackend() åšè¶…æ—¶å¤„ç†ï¼ˆæ¨èä½¿ç”¨ Reactor/Asyncï¼‰

---

## **âœ… æ€»ç»“ï¼šå¿«é€Ÿæ’æŸ¥æµç¨‹å›¾**

```mermaid
flowchart TD
    A[ç›‘æ§å‘ç° Unacked > 20] --> B[æŸ¥çœ‹ Stackdriver æŒ‡æ ‡è¶‹åŠ¿]
    B --> C{å¤„ç†å¤ªæ…¢ï¼Ÿ}
    C -- æ˜¯ --> D[è°ƒå¤§ ack deadline]
    C -- å¦ --> E[å¢åŠ  executor / flowControl]
    B --> F[åˆ†ææ—¥å¿—æ˜¯å¦æœª ack / æŠ›å¼‚å¸¸]
    F --> G[æ”¹è¿› try/catch & nack é€»è¾‘]
    G --> H[jstack åˆ†ææ˜¯å¦çº¿ç¨‹é˜»å¡]
```

---

## **âœ… é™„åŠ å»ºè®®**

| **ç›‘æ§ç›®æ ‡**             | **å»ºè®®æ–¹æ¡ˆ**                         |
| ------------------------ | ------------------------------------ |
| Ack å¤„ç†æˆåŠŸç‡           | Prometheus æŒ‡æ ‡ï¼šmessage.ack.success |
| æ¶ˆæ¯ç§¯å‹ä¸¥é‡æŠ¥è­¦         | å»ºè®®é…ç½® Cloud Alerting              |
| è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆæ¶ˆè´¹å‹åŠ›å¤§ï¼‰ | ä½¿ç”¨ K8s HPAï¼ˆCPU æˆ– è‡ªå®šä¹‰æŒ‡æ ‡ï¼‰    |

---

æ¶ˆè´¹è€…è®¢é˜…äº†æ¶ˆæ¯ï¼Œä½†**æœªåœ¨ ack deadline æ—¶é—´å†… ack**ï¼ˆç¡®è®¤æ¥æ”¶ï¼‰ï¼Œå¯¼è‡´æ¶ˆæ¯å¤„äº **Unackedï¼ˆå¾…ç¡®è®¤ï¼‰** çŠ¶æ€

è¿™ä¸ªæ—¶é—´è®¾ç½®å¦‚ä½•æŸ¥çœ‹?

gcloud pubsub subscriptions describe my-subscription ?

æ˜¯çš„ï¼Œâœ… **ä½ å¯ä»¥é€šè¿‡ gcloud pubsub subscriptions describe å‘½ä»¤æŸ¥çœ‹ ackDeadlineSeconds** çš„å½“å‰è®¾ç½®å€¼ï¼Œä¹Ÿå°±æ˜¯æ¶ˆæ¯ä» Pub/Sub æŠ•é€’ç»™æ¶ˆè´¹è€…åï¼Œ**åœ¨å¤šä¹…ä¹‹å†…å¿…é¡» ackï¼Œå¦åˆ™ä¼šè¢«é‡æ–°æŠ•é€’**ã€‚

---

## **âœ… æŸ¥çœ‹ Ack Deadline è®¾ç½®çš„å‘½ä»¤ï¼š**

```
gcloud pubsub subscriptions describe my-subscription
```

---

## **âœ… è¾“å‡ºå­—æ®µè¯´æ˜ï¼ˆé‡ç‚¹å­—æ®µï¼‰**

ç¤ºä¾‹è¾“å‡ºï¼š

```
ackDeadlineSeconds: 10
expirationPolicy:
  ttl: 2678400s
messageRetentionDuration: 604800s
name: projects/my-project/subscriptions/my-subscription
pushConfig: {}
topic: projects/my-project/topics/my-topic
```

| **å­—æ®µå**               | **å«ä¹‰**                                                |
| ------------------------ | ------------------------------------------------------- |
| ackDeadlineSeconds       | âœ… **å½“å‰ ack deadline é…ç½®ï¼ˆå•ä½ç§’ï¼‰**ï¼ˆé»˜è®¤æ˜¯ 10 ç§’ï¼‰ |
| messageRetentionDuration | æœªè¢« ack æ¶ˆæ¯åœ¨ Pub/Sub ç³»ç»Ÿä¸­ä¿ç•™å¤šä¹…ï¼ˆé»˜è®¤ 7 å¤©ï¼‰     |
| pushConfig               | å¦‚æœæ˜¯ push æ¨¡å¼ä¼šæ˜¾ç¤º endpoint ä¿¡æ¯                    |
| topic                    | å½“å‰è®¢é˜…å¯¹åº”çš„ topic                                    |

---

## **âœ… å¦‚æœéœ€è¦ä¿®æ”¹è¿™ä¸ªå€¼ï¼ˆæ¯”å¦‚æ”¹ä¸º 60 ç§’ï¼‰**

```
gcloud pubsub subscriptions update my-subscription \
  --ack-deadline=60
```

æ³¨æ„ï¼š

- æœ€å°å€¼ï¼š10 ç§’ï¼ˆé»˜è®¤ï¼‰
- æœ€å¤§å€¼ï¼š600 ç§’ï¼ˆ10 åˆ†é’Ÿï¼‰

---

## **âœ… ä¿®æ”¹å»ºè®®**

| **å¤„ç†é€»è¾‘åœºæ™¯**           | **å»ºè®® ack deadline æ—¶é—´** |
| -------------------------- | -------------------------- |
| ç®€å•é€»è¾‘ï¼Œå¿«é€Ÿå¤„ç†ï¼ˆ< 5sï¼‰ | ä¿æŒé»˜è®¤ 10 ç§’             |
| è°ƒç”¨å¤–éƒ¨ APIï¼Œæœ‰é‡è¯•é€»è¾‘   | è®¾ç½®ä¸º 30 ~ 60 ç§’          |
| è°ƒç”¨ä¾èµ–ç³»ç»Ÿæ…¢æˆ– IO å¯†é›†   | å¯è®¾ä¸º 120 ~ 300 ç§’        |

---

æ˜¯å¦éœ€è¦æˆ‘ä¹Ÿå¸®ä½ æ•´ç†ä¸€ä¸ªè„šæœ¬ï¼Œè‡ªåŠ¨æ‰¹é‡æŸ¥çœ‹å¤šä¸ª subscription çš„ ackDeadline è®¾ç½®ï¼Ÿ

æ¶ˆè´¹è€…è®¢é˜…äº†æ¶ˆæ¯ï¼Œä½†**æœªåœ¨ ack deadline æ—¶é—´å†… ack**ï¼ˆç¡®è®¤æ¥æ”¶ï¼‰ï¼Œå¯¼è‡´æ¶ˆæ¯å¤„äº **Unackedï¼ˆå¾…ç¡®è®¤ï¼‰** çŠ¶æ€

æˆ‘ä»¬è®¾ç½®ä¸º 600S

unacked æ€»æ•°æ˜¯å¦ä¸€ç›´å¢é•¿ï¼ˆçº¿ç¨‹/å¤„ç†å¤ªæ…¢ï¼‰

é‚£ä¹ˆæˆ‘å¦‚ä½•ä¼˜åŒ–è¿™ä¸ªé—®é¢˜,å¦‚æœä»çº¿ç¨‹æ¥è¯´ è¿™é‡Œç‰¹æŒ‡ä»€ä¹ˆ?

æ˜¯ Schedule Service å» pub /subÂ  subscription å–æ¶ˆæ¯çš„ çº¿ç¨‹ä¹ˆ?

ä½ ç†è§£å¾—å®Œå…¨æ­£ç¡®ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€æ­¥æ­¥æ‹†è§£ä½ çš„é—®é¢˜ï¼Œå¹¶**ç²¾ç¡®è§£é‡Šè¿™ä¸ªâ€œçº¿ç¨‹â€æŒ‡çš„æ˜¯è°â€ã€â€œå¦‚ä½•ä¼˜åŒ–â€**ã€‚

---

## **âœ… é—®é¢˜èƒŒæ™¯å†æ¢³ç†ä¸€ä¸‹ï¼š**

- ä½ ä½¿ç”¨ **Pull æ¨¡å¼** ä» **Pub/Sub Subscription** æ‹‰å–æ¶ˆæ¯ã€‚
- ä½ è®¾ç½®äº† ackDeadlineSeconds = 600ï¼ˆæœ€å¤§å€¼ï¼‰ã€‚
- **ä½†ä½ è§‚å¯Ÿåˆ° unacked messages è¶Šæ¥è¶Šå¤šï¼Œè¯´æ˜æ¶ˆæ¯è¢«æ‹‰å–åï¼Œ600s å†…ä»æœª ackï¼Œæˆ–çº¿ç¨‹æ²¡æœ‰åŠæ—¶å¤„ç†å®Œã€‚**

---

## **âœ… é—®é¢˜æœ¬è´¨ï¼šæ¶ˆæ¯è¢« Schedule Service æ‹‰åˆ°äº†ï¼Œä½†æ²¡æœ‰åŠæ—¶å¤„ç†å®Œæˆ– ack**

æ‰€ä»¥ï¼š

> **è¿™é‡Œçš„çº¿ç¨‹ç‰¹æŒ‡ï¼š**

> âœ… Schedule Service ä¸­ï¼Œè´Ÿè´£æ‰§è¡Œæ‹‰å–æ¶ˆæ¯åçš„ **å›è°ƒå‡½æ•°ï¼ˆMessageReceiver æ¥å£ï¼‰** ä¸­ä¸šåŠ¡é€»è¾‘çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯ **â€œæ¶ˆæ¯å¤„ç†çº¿ç¨‹æ± â€**ã€‚

---

## **âœ… ç¤ºä¾‹ï¼šä½ å½“å‰ Schedule Service æ¶ˆè´¹ Pub/Sub çš„ä»£ç ç»“æ„ï¼ˆJavaï¼‰**

```java
Subscriber subscriber = Subscriber.newBuilder(subscriptionName, receiver)
    .setExecutorProvider(InstantiatingExecutorProvider.newBuilder()
        .setExecutorThreadCount(4) // ğŸ‘ˆ å°±æ˜¯è¿™é‡Œæ§åˆ¶çº¿ç¨‹æ•°
        .build())
    .build();

subscriber.startAsync().awaitRunning();
```

### **å›è°ƒé€»è¾‘ï¼š**

```java
MessageReceiver receiver = (message, consumer) -> {
    try {
        // ğŸ‘‡ ä½ çš„ä¸šåŠ¡é€»è¾‘ï¼šä¾‹å¦‚ HTTP è°ƒç”¨ Kongã€é‡è¯•ã€å›å†™ç­‰
        processMessage(message);

        consumer.ack(); // ğŸ‘ˆ æˆåŠŸå°± ack
    } catch (Exception e) {
        consumer.nack(); // ğŸ‘ˆ å¤±è´¥ nack
    }
};
```

---

## **âœ… å¦‚æœè¿™ä¸ªçº¿ç¨‹æ± å¤ªå°ï¼ˆä¾‹å¦‚ 2~4 ä¸ªçº¿ç¨‹ï¼‰**

- å¦‚æœ Pub/Sub æ¯ç§’æ¨é€ 50 æ¡æ¶ˆæ¯
- ä½†ä½ åªæœ‰ 4 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªå¤„ç†è€—æ—¶ 20 ç§’
- åˆ™æœ€å¤šåªèƒ½å¤„ç† 3/min Ã— 4 = 12 æ¡/minï¼Œå…¶å®ƒç§¯å‹
- å‰©ä½™æ¶ˆæ¯æ— æ³•åœ¨ 600 ç§’å†…å®Œæˆæ¶ˆè´¹ â‡’ å¯¼è‡´ **unacked å¢é•¿**

---

## **âœ… ä¼˜åŒ–å»ºè®®æ¸…å•ï¼ˆä»çº¿ç¨‹ä¸å¤„ç†è§’åº¦ï¼‰**

| **ä¼˜åŒ–ç»´åº¦**          | **å»ºè®®æ–¹æ³•**                                       |
| --------------------- | -------------------------------------------------- |
| **å¢åŠ å¹¶å‘çº¿ç¨‹æ•°**    | æé«˜ executorThreadCountï¼Œå¦‚ä» 4 å¢åŠ åˆ° 20         |
| **é™åˆ¶æ‹‰å–æµé‡**      | ä½¿ç”¨ FlowControlSettings æ§åˆ¶ç§¯å‹æ•°é‡/ä½“ç§¯         |
| **ä¼˜åŒ–å¤„ç†é€»è¾‘è€—æ—¶**  | å‡å°‘ HTTP è¯·æ±‚ã€ä½¿ç”¨è¿æ¥æ± ã€å¼‚æ­¥å¤„ç†               |
| **ä½¿ç”¨æ‰¹å¤„ç†/çº¿ç¨‹æ± ** | ç»“åˆ ThreadPoolExecutor å¯¹é«˜è€—æ—¶é€»è¾‘å¹¶è¡Œæ‰§è¡Œ       |
| **ç›‘æ§è€—æ—¶æŒ‡æ ‡**      | æ‰“åŸ‹ç‚¹ç›‘æ§æ¯æ¡æ¶ˆæ¯å¤„ç†è€—æ—¶ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦çº¿ç¨‹è€—å°½ï¼‰ |

---

## **âœ… æ¨èè®¾ç½®ä¸¾ä¾‹**

```java
Subscriber.newBuilder(subscriptionName, receiver)
    .setExecutorProvider(
        InstantiatingExecutorProvider.newBuilder()
            .setExecutorThreadCount(20) // ğŸ‘ˆ æå‡çº¿ç¨‹æ•°
            .build()
    )
    .setFlowControlSettings(
        FlowControlSettings.newBuilder()
            .setMaxOutstandingElementCount(1000) // ğŸ‘ˆ é™åˆ¶åŒæ—¶ç§¯å‹æ¶ˆæ¯æ•°é‡
            .setMaxOutstandingRequestBytes(50 * 1024 * 1024) // 50MB
            .build()
    )
    .build();
```

---

## **âœ… æ’æŸ¥æµç¨‹å›¾ï¼ˆåŸºäº unacked å¢é•¿ï¼‰**

```mermaid
flowchart TD
    A[å‘ç° unacked message æŒç»­å¢é•¿] --> B[æŸ¥çœ‹ ackDeadline è®¾ç½®: 600 ç§’]
    B --> C[æŸ¥çœ‹ ScheduleService executorThreadCount é…ç½®]
    C --> D{çº¿ç¨‹æ•°æ˜¯å¦åå°‘ï¼Ÿ}
    D -- æ˜¯ --> E[æå‡çº¿ç¨‹æ± å¤§å°]
    D -- å¦ --> F[åˆ†æå•æ¡æ¶ˆæ¯å¤„ç†è€—æ—¶]
    F --> G{ä¸šåŠ¡é€»è¾‘æ…¢ï¼Ÿ}
    G -- æ˜¯ --> H[ä¼˜åŒ–å¤„ç†/å¼‚æ­¥/å‹ç¼©/å¹¶å‘]
    G -- å¦ --> I[æ‰“ç›‘æ§ï¼Œè§‚å¯Ÿå¼‚å¸¸å’Œå¡ç‚¹]
```

---

## **âœ… ç¤ºä¾‹æŒ‡æ ‡å»ºè®®ï¼ˆPrometheusï¼‰**

| **æŒ‡æ ‡åç§°**                  | **å«ä¹‰**           |
| ----------------------------- | ------------------ |
| pubsub.consumer.message.count | æ¯åˆ†é’Ÿå¤„ç†å¤šå°‘æ¡   |
| pubsub.consumer.latency       | æ¯æ¡å¤„ç†è€—æ—¶       |
| pubsub.consumer.pending       | å½“å‰å¤„ç†ä¸­çš„æ•°é‡   |
| executor.active_threads       | çº¿ç¨‹æ± å½“å‰å ç”¨æƒ…å†µ |
| pubsub.consumer.failed.count  | nack çš„æ•°é‡        |

---

## **âœ… æ€»ç»“å…³é”®ç‚¹**

| **é—®é¢˜ç‚¹**   | **è§£æ³•**                                                |
| ------------ | ------------------------------------------------------- |
| unacked å¢é•¿ | è¯´æ˜çº¿ç¨‹å¤„ç†ä¸è¿‡æ¥ï¼Œæˆ–è€…å¤„ç†å¤ªæ…¢                        |
| å“ªäº›çº¿ç¨‹ï¼Ÿ   | æ˜¯ Schedule Service ä¸­ MessageReceiver å›è°ƒå†…éƒ¨æ‰§è¡Œçº¿ç¨‹ |
| å¦‚ä½•æ§åˆ¶ï¼Ÿ   | executorThreadCount + Flow Control                      |
| å¦‚ä½•ä¼˜åŒ–ï¼Ÿ   | æå‡å¹¶å‘ + ç›‘æ§å¤„ç†è€—æ—¶ + ä¸šåŠ¡é€»è¾‘ç˜¦èº«                  |

---

å¦‚æœä½ æ„¿æ„ï¼Œä¹Ÿå¯ä»¥ç»™æˆ‘ä½ ç›®å‰çš„çº¿ç¨‹æ± é…ç½®ã€messageReceiver ä¸­çš„ä¸»è¦é€»è¾‘ï¼Œæˆ‘å¯ä»¥å¸®ä½ è¯„ä¼°ä¸€ä¸ªå…·ä½“çº¿ç¨‹æ•°æ¨è + æœ€å¤§æ‹‰å–é€Ÿç‡æ¨¡å‹ã€‚æ˜¯å¦éœ€è¦æˆ‘ç”Ÿæˆä¸€ä¸ªå¯è§‚æµ‹çš„ Prometheus æŒ‡æ ‡æ¨¡æ¿ YAML ç”¨äº Grafanaï¼Ÿ
