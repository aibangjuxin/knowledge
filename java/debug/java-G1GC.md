# Q

```bash
Java application å¯åŠ¨å‚æ•°UseG1GC å¸®æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ª æ¯”å¦‚è¯´ä¿®æ”¹ç³»ç»Ÿå‚æ•°æ˜¯å¦èƒ½å¤Ÿçœ‹åˆ°GC åœ¨è§¦å‘ç³»ç»Ÿoomkilled çš„ä¹‹å‰è¢«è§¦å‘ é‡Œé¢è¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µå«è€å¹´ä»£æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ è¯·å¸®æˆ‘è¯¦ç»†æ¢ç´¢è¿™äº›ä¿¡æ¯å¹¶ç»™æˆ‘ä¸€äº›å¯¹åº”çš„è§£é‡Šã€‚
```

è¿™æ˜¯ä¸ª**éå¸¸å…³é”®ã€ä½†åˆç»å¸¸è¢«"ä¸€å¥è¯å¸¦è¿‡"çš„ç‚¹**ã€‚
æˆ‘æŒ‰ä½ å¹³å°æ–‡æ¡£èƒ½ç›´æ¥ç”¨çš„æ–¹å¼ï¼Œç»™ä½ ä¸€ä¸ª**ä¸æ¨¡ç³Šã€ä¸å£è¯­ã€ä¸è¯¯å¯¼**çš„è§£é‡Šã€‚

ä¸‹é¢æ˜¯ä¸€æ•´æ®µ**å®Œæ•´ Markdown**ï¼Œä½ å¯ä»¥ç›´æ¥ç²˜åˆ°è®¾è®¡æ–‡æ¡£æˆ–ç”¨æˆ·è¯´æ˜é‡Œã€‚

---

# **å¦‚ä½•ç†è§£ã€ŒG1 GC æ˜¯é»˜è®¤ GCã€**

## **1. ç»“è®ºå…ˆè¡Œï¼ˆä¸€å¥è¯ç‰ˆæœ¬ï¼‰**

> åœ¨ **Java 9 åŠä¹‹åï¼ˆåŒ…æ‹¬ Java 17ï¼‰**ï¼Œå¦‚æœ**æ²¡æœ‰æ˜¾å¼æŒ‡å®šä»»ä½•åƒåœ¾å›æ”¶å™¨å‚æ•°**ï¼ŒJVM ä¼š**è‡ªåŠ¨é€‰æ‹© G1 Garbage Collector ä½œä¸ºé»˜è®¤ GC**ã€‚

---

## **2. "é»˜è®¤ GC"åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€**

### **2.1 é»˜è®¤çš„çœŸå®å«ä¹‰**

"G1 GC æ˜¯é»˜è®¤ GC"å¹¶ä¸æ„å‘³ç€ï¼š

- âŒ JVM æ°¸è¿œåªæ”¯æŒ G1

- âŒ JVM ä¼šå¿½ç•¥ç”¨æˆ·é…ç½®çš„å…¶ä»– GC

- âŒ G1 æ˜¯å”¯ä¸€å¯ç”¨çš„ GC

å®ƒçœŸæ­£çš„å«ä¹‰æ˜¯ï¼š

> **å½“ JVM å¯åŠ¨æ—¶ï¼Œè‹¥æœªé€šè¿‡ -XX:+UseXXXGC æ˜¾å¼æŒ‡å®šåƒåœ¾å›æ”¶å™¨ï¼Œ**
> 
> **JVM ä¼šé€‰æ‹© G1 GC ä½œä¸ºå½“å‰è¿è¡Œçš„åƒåœ¾å›æ”¶å™¨ã€‚**

---

## **3. Java 17 ä¸­ GC é€‰æ‹©çš„è§„åˆ™**

åœ¨ Java 17 å¯åŠ¨æ—¶ï¼ŒGC çš„é€‰æ‹©éµå¾ªä»¥ä¸‹ä¼˜å…ˆçº§è§„åˆ™ï¼š

1. **æ˜¾å¼æŒ‡å®š GCï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰**

    ```
    -XX:+UseG1GC
    -XX:+UseZGC
    -XX:+UseParallelGC
    ```

2. **æœªæŒ‡å®šä»»ä½• GC å‚æ•°**

    - JVM è‡ªåŠ¨å¯ç”¨ **G1 GCï¼ˆé»˜è®¤ï¼‰**

ğŸ‘‰ æ‰€ä»¥ï¼š

- **Java 17 + æ—  GC å‚æ•° = G1 GC**
- **Java 17 + æ˜¾å¼ GC å‚æ•° = ç”¨æˆ·æŒ‡å®šçš„ GC**

---

## **4. ä¸ºä»€ä¹ˆ Java é€‰æ‹© G1 ä½œä¸ºé»˜è®¤ GC**

è¿™æ˜¯ä¸€ä¸ª**å·¥ç¨‹æƒè¡¡ç»“æœ**ï¼Œä¸æ˜¯"G1 æœ€å¿«"ï¼Œè€Œæ˜¯"æœ€ç¨³"ã€‚

| **ç»´åº¦** | **G1 çš„ä¼˜åŠ¿** |
|----------|---------------|
| åœé¡¿æ—¶é—´ | å¯é¢„æµ‹ï¼ˆç›®æ ‡åœé¡¿ï¼‰ |
| å¤§å †å†…å­˜ | è¡¨ç°ç¨³å®š |
| åå vs å»¶è¿Ÿ | å¹³è¡¡å‹ |
| æœåŠ¡ç«¯åº”ç”¨ | å‹å¥½ |
| å®¹å™¨ç¯å¢ƒ | é€‚é…è‰¯å¥½ |

ğŸ‘‰ å¯¹ Java å®˜æ–¹è€Œè¨€ï¼š

> G1 æ˜¯ **æœ€ä¸å®¹æ˜“æŠŠç”¨æˆ·æå´©çš„ GC**ã€‚

---

## **5. é»˜è®¤ â‰  æœ€ä¼˜ï¼ˆè¿™æ˜¯å¹³å°å¿…é¡»å¼ºè°ƒçš„ç‚¹ï¼‰**

åœ¨ Java 17 ä¸­ï¼š

- **é»˜è®¤ä½¿ç”¨ G1** âœ…
- **é»˜è®¤é…ç½®ä¸€å®šæœ€ä¼˜** âŒ

ä¾‹å¦‚ï¼š

- é«˜ååæ‰¹å¤„ç† â†’ Parallel GC å¯èƒ½æ›´åˆé€‚
- è¶…ä½å»¶è¿ŸæœåŠ¡ â†’ ZGC / Shenandoah æ›´åˆé€‚
- å†…å­˜æå°å®¹å™¨ â†’ éœ€è¦é¢å¤–è°ƒä¼˜ G1 å‚æ•°

ğŸ‘‰ **é»˜è®¤åªæ˜¯"å®‰å…¨èµ·ç‚¹"**ã€‚

---

## **6. å¦‚ä½•åœ¨è¿è¡Œä¸­ç¡®è®¤å½“å‰ä½¿ç”¨çš„ GCï¼ˆéå¸¸å®ç”¨ï¼‰**

### **6.1 å¯åŠ¨æ—¥å¿—ç¡®è®¤ï¼ˆæ¨èï¼‰**

```
-XX:+PrintCommandLineFlags
```

å¯åŠ¨æ—¶ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š

```
-XX:+UseG1GC
```

### **6.2 GC æ—¥å¿—ç¡®è®¤ï¼ˆJava 17ï¼‰**

```
-Xlog:gc
```

æ—¥å¿—ä¸­ä¼šå‡ºç°ï¼š

```
Using G1
```

---

## **7. å¹³å°æ–‡æ¡£ä¸­æ¨èçš„æ ‡å‡†è¡¨è¿°ï¼ˆä½ å¯ä»¥ç›´æ¥ç”¨ï¼‰**

> åœ¨ Java 17 ç¯å¢ƒä¸­ï¼Œè‹¥æœªæ˜¾å¼æŒ‡å®šåƒåœ¾å›æ”¶å™¨å‚æ•°ï¼ŒJVM é»˜è®¤å¯ç”¨ G1 GCã€‚
> 
> å¹³å°åŸºäºè¿™ä¸€é»˜è®¤è¡Œä¸ºè¿›è¡Œ GC æ—¥å¿—ä¸è¿è¡Œæ—¶è§‚æµ‹è®¾è®¡ã€‚

è¿™å¥è¯**æ—¢å‡†ç¡®ï¼Œåˆä¸æ‰¿è¯ºè¿‡å¤š**ï¼Œéå¸¸é€‚åˆå¹³å°è¯´æ˜ã€‚

---

## **8. ä¸€ä¸ªå¸¸è§è¯¯è§£ï¼ˆä½ å¯ä»¥æå‰å¸®ç”¨æˆ·æ¾„æ¸…ï¼‰**

> **"æˆ‘æ²¡é… GC å‚æ•° â‰  æˆ‘ä¸çŸ¥é“ç”¨çš„æ˜¯å“ªç§ GC"**

åœ¨ Java 17 ä¸­ï¼š

- æ²¡é… = **ç¡®å®šæ˜¯ G1**
- ä¸ç¡®å®šçš„åè€Œæ˜¯ Java 8 æ—¶ä»£

---

## **9. å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç»§ç»­å¸®ä½ è¡¥é½**

ä¸‹é¢è¿™äº›å†…å®¹ï¼Œéƒ½æ˜¯**ç´§è·Ÿè¿™ä¸€å¥"é»˜è®¤ GC"ä¹‹åæœ€å®¹æ˜“è¢«é—®åˆ°çš„**ğŸ‘‡

1ï¸âƒ£ G1 GC åœ¨ Java 17 ä¸­çš„æ ¸å¿ƒå·¥ä½œæœºåˆ¶å›¾

2ï¸âƒ£ G1 Mixed GC vs Full GC çš„è§¦å‘æ¡ä»¶

3ï¸âƒ£ ä¸ºä»€ä¹ˆ Java 17 å®¹å™¨é‡Œ G1 è¡Œä¸ºå’Œç‰©ç†æœºä¸ä¸€æ ·

4ï¸âƒ£ å¹³å°è¯¥ä¸è¯¥å…è®¸ç”¨æˆ·åˆ‡ ZGCï¼ˆè´£ä»»è¾¹ç•Œåˆ†æï¼‰

ä½ ç°åœ¨é—®çš„è¿™ä¸ªç‚¹ï¼Œæœ¬è´¨å·²ç»æ˜¯**å¹³å°è§£é‡Šè´£ä»»**çš„é—®é¢˜äº†ï¼Œä¸æ˜¯ JVM å…¥é—¨é—®é¢˜äº† ğŸ‘Œ

# A

å¥½ï¼Œè¿™ä¸ªé—®é¢˜æœ¬è´¨ä¸Š**ä¸æ˜¯ JVM æŠ€æœ¯æœ¬èº«**ï¼Œè€Œæ˜¯**ä½ å¦‚ä½•æŠŠ"è´£ä»»è¾¹ç•Œ + å¯æ“ä½œå»ºè®®"è¯´æ¸…æ¥š**ï¼Œè€Œä¸”è¿˜è¦è®©ç”¨æˆ·**å¬èµ·æ¥ä¸è¢«å†’çŠ¯ã€ä¹Ÿä¸è§‰å¾—ä½ åœ¨ç”©é”…**ã€‚

æˆ‘åˆ†ä¸‰å±‚æ¥ç»™ä½ ä¸€ä¸ª**å¯ç›´æ¥ç”¨çš„è¡¨è¾¾æ–¹æ¡ˆ**ï¼Œä½ å¯ä»¥æŒ‰åœºåˆé€‰ã€‚

---

## **ä¸€ã€é—®é¢˜åˆ†æï¼ˆä½ çœŸæ­£æƒ³è¡¨è¾¾çš„æ ¸å¿ƒï¼‰**

ä½ æƒ³ä¼ è¾¾çš„å…¶å®æ˜¯è¿™å‡ ä»¶äº‹ï¼š

1. **è€å¹´ä»£ GC / Heap é—®é¢˜æ˜¯ JVM è¿›ç¨‹çº§åˆ«çš„é—®é¢˜**
2. **jmap / jcmd / heap dump æœ¬è´¨ä¸Šéœ€è¦å¯¹ JVM è¿›ç¨‹æœ‰æ§åˆ¶æƒ**
3. **åœ¨"å¹³å°æ‰˜ç®¡é•œåƒ + ä¸å…è®¸æ”¹ Dockerfile"çš„å‰æä¸‹ï¼Œè¿™ä»¶äº‹å¤©ç„¶ä¸å¯åš**
4. **å¦‚æœç”¨æˆ·æœ‰æ·±åº¦ GC è¯Šæ–­è¯‰æ±‚ï¼Œå°±å¿…é¡»è‡ªå·±æŒæ§è¿è¡Œç¯å¢ƒ**
5. å¹³å°ä¸æ˜¯ä¸æ”¯æŒæ’æŸ¥ï¼Œè€Œæ˜¯**æ”¯æŒåˆ°"å¯è§‚æµ‹"è¿™ä¸€å±‚ä¸ºæ­¢**

è¿™ä¸æ˜¯æŠ€æœ¯æ‹’ç»ï¼Œè€Œæ˜¯**æ¶æ„è¾¹ç•Œå£°æ˜**ã€‚

---

## **äºŒã€æ¨èçš„"æ ‡å‡†è¡¨è¿°æ€è·¯"ï¼ˆä¸åˆºæ¿€ç”¨æˆ·ï¼‰**

æˆ‘å»ºè®®ä½ ç”¨ **ã€ŒåŸåˆ™ â†’ çº¦æŸ â†’ å¯é€‰æ–¹æ¡ˆã€** çš„ç»“æ„æ¥æè¿°ï¼Œè€Œä¸æ˜¯ç›´æ¥è¯´"ä½ ä»¬å¾—è‡ªå·±æ”¹ Dockerfile"ã€‚

### **é€»è¾‘é¡ºåºåº”è¯¥æ˜¯ï¼š**

> JVM è¡Œä¸º â†’ å®¹å™¨è¿è¡Œè¾¹ç•Œ â†’ å¹³å°æ”¯æŒèŒƒå›´ â†’ ç”¨æˆ·è‡ªåŠ©èƒ½åŠ›

---

## **ä¸‰ã€å¯ç›´æ¥ä½¿ç”¨çš„æ­£å¼è¡¨è¿°ï¼ˆåå¹³å°æ–‡æ¡£ / é‚®ä»¶ / è®¾è®¡è¯´æ˜ï¼‰**

ä¸‹é¢è¿™æ®µä½ å¯ä»¥**åŸæ ·ç”¨**ï¼Œå·²ç»å¸®ä½ æ§åˆ¶å¥½è¯­æ°”äº† ğŸ‘‡

```
### å…³äº Java è€å¹´ä»£ GC æ·±åº¦è¯Šæ–­çš„è¯´æ˜

åœ¨ Java åº”ç”¨ä¸­ï¼Œè€å¹´ä»£ï¼ˆOld Genï¼‰çš„ GC è¡Œä¸ºå±äº JVM è¿›ç¨‹çº§åˆ«çš„è¿è¡Œç‰¹æ€§ã€‚
é’ˆå¯¹è¯¥ç±»é—®é¢˜ï¼ˆä¾‹å¦‚ Full GC é¢‘ç¹ã€è€å¹´ä»£å›æ”¶å¼‚å¸¸ã€å†…å­˜é•¿æœŸä¸é‡Šæ”¾ç­‰ï¼‰ï¼Œé€šå¸¸éœ€è¦é€šè¿‡ JVM å·¥å…·ï¼ˆå¦‚ `jmap`ã€`jcmd`ã€heap dumpï¼‰è¿›è¡Œåˆ†æã€‚

åœ¨å½“å‰å¹³å°æä¾›çš„ **æ ‡å‡†è¿è¡Œé•œåƒ** ä¸ **æ‰˜ç®¡å¼ Deployment æ¨¡å‹** ä¸‹ï¼š

- å¹³å°è¿è¡Œç¯å¢ƒä¸­ä¸é¢„ç½® `jmap` ç­‰è¯Šæ–­å·¥å…·
- åº”ç”¨å®¹å™¨å¯¹ JVM è¿›ç¨‹çš„è°ƒè¯•æƒé™å—åˆ°é™åˆ¶
- å¹³å°ä¾§ä»…æä¾› **æŒ‡æ ‡çº§ / æ—¥å¿—çº§çš„å¯è§‚æµ‹èƒ½åŠ›**ï¼ˆå¦‚ GC æ—¥å¿—ã€å†…å­˜ä½¿ç”¨ç‡ã€HPA è¡Œä¸ºï¼‰

å› æ­¤ï¼Œ**å¹³å°æ— æ³•ç›´æ¥å¯¹ç”¨æˆ·åº”ç”¨æ‰§è¡Œè¿›ç¨‹çº§çš„ Heap Dump æˆ– JVM å†…å­˜é‡‡æ ·æ“ä½œ**ã€‚

#### æ¨èåšæ³•

å¦‚æœç”¨æˆ·å­˜åœ¨ä»¥ä¸‹éœ€æ±‚ï¼š

- å®šæœŸæˆ–ä¸´æ—¶é‡‡é›† Heap Dump
- ä½¿ç”¨ `jmap / jcmd` è¿›è¡Œè€å¹´ä»£åˆ†æ
- å¯¹ JVM å‚æ•°ã€GC ç­–ç•¥è¿›è¡Œæ·±åº¦è°ƒä¼˜

å»ºè®®ç”¨æˆ·é‡‡ç”¨ **è‡ªå®šä¹‰ Docker é•œåƒ** çš„æ–¹å¼éƒ¨ç½²åº”ç”¨ï¼Œä¾‹å¦‚ï¼š

- åœ¨è‡ªå®šä¹‰ Dockerfile ä¸­å®‰è£… JDK å·¥å…·é›†
- é¢„ç½® GC æ—¥å¿—ã€Heap Dump ç›®å½•
- åœ¨éœ€è¦æ—¶é€šè¿‡ `kubectl exec` æˆ– Sidecar æ–¹å¼è§¦å‘é‡‡é›†

å¹³å°å°†ç»§ç»­è´Ÿè´£ï¼š
- è¿è¡Œç¯å¢ƒç¨³å®šæ€§
- å®¹å™¨ç¼–æ’ä¸é«˜å¯ç”¨
- åŸºç¡€ç›‘æ§ä¸å‘Šè­¦èƒ½åŠ›

è€Œ **JVM è¿›ç¨‹çº§è¯Šæ–­ä¸å†…å­˜åˆ†æèƒ½åŠ›** åˆ™ç”±åº”ç”¨æ–¹è‡ªè¡ŒæŒæ§.
```

---

## **å››ã€å¦‚æœæ˜¯ã€Œå£å¤´ / æ²Ÿé€šå‹ç‰ˆæœ¬ã€ï¼ˆæ›´æŸ”å’Œä¸€ç‚¹ï¼‰**

å¦‚æœä½ æ˜¯åœ¨ä¼šè®®é‡Œè¯´ï¼Œå¯ä»¥ç”¨è¿™å¥— ğŸ‘‡

> è€å¹´ä»£ GC è¿™ç§é—®é¢˜ï¼Œå…¶å®å·²ç»å±äº JVM è¿›ç¨‹å†…éƒ¨çš„è¯Šæ–­äº†ã€‚
> 
> åœ¨æˆ‘ä»¬ç°åœ¨çš„å¹³å°æ¨¡å¼ä¸‹ï¼Œå®¹å™¨æ˜¯æ‰˜ç®¡çš„ï¼Œæˆ‘ä»¬åªåšåˆ°æŒ‡æ ‡å’Œæ—¥å¿—è¿™ä¸€å±‚ï¼Œæ¯”å¦‚å†…å­˜æ›²çº¿ã€GC æ¬¡æ•°è¿™äº›ã€‚
> 
> åƒ jmap è¿™ç§å·¥å…·ï¼Œæœ¬è´¨ä¸Šéœ€è¦å¯¹ JVM è¿›ç¨‹æœ‰å®Œæ•´æ§åˆ¶æƒï¼Œæ‰€ä»¥å¦‚æœç”¨æˆ·å¸Œæœ›åš heap dump æˆ–å®šæœŸåˆ†æï¼Œ**æœ€åˆç†çš„æ–¹å¼è¿˜æ˜¯è‡ªå·±ç»´æŠ¤ä¸€ä¸ªè‡ªå®šä¹‰ Docker é•œåƒ**ã€‚
> 
> è¿™æ ·çš„è¯ï¼Œä¸€æ–¹é¢ä¸å½±å“å¹³å°çš„é€šç”¨æ€§ï¼Œå¦ä¸€æ–¹é¢ç”¨æˆ·ä¹Ÿèƒ½å®Œå…¨æŒ‰è‡ªå·±çš„èŠ‚å¥åšè¯Šæ–­ã€‚

---

## **äº”ã€ä¸€ä¸ªå¾ˆå…³é”®ä½†å®¹æ˜“è¢«å¿½ç•¥çš„"åŠ åˆ†ç‚¹"**

ä½ å¯ä»¥**é¡ºæ‰‹è¡¥ä¸€å¥**ï¼Œä¼šæ˜¾å¾—ä½ éå¸¸ä¸“ä¸šè€Œä¸”ç«™åœ¨ç”¨æˆ·è¿™è¾¹ï¼š

> äº‹å®ä¸Šï¼Œ**ç»å¤§å¤šæ•°è€å¹´ä»£é—®é¢˜ï¼Œåœ¨å¼€å¯åˆé€‚çš„ GC æ—¥å¿—åå°±èƒ½å®šä½ 70% ä»¥ä¸Šçš„é—®é¢˜**ï¼Œå¹¶ä¸ä¸€å®šç¬¬ä¸€æ­¥å°±éœ€è¦ heap dump.

è¿™å¥è¯èƒ½æœ‰æ•ˆç¼“å’Œç”¨æˆ·çš„"è¢«è¿«æ”¹ Dockerfile"çš„æŠµè§¦æƒ…ç»ªã€‚

---

## **å…­ã€å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘è¿˜èƒ½å¸®ä½ ç»§ç»­åšä¸‰ä»¶äº‹ä¹‹ä¸€**

ä½ é€‰ä¸€ä¸ªæˆ‘ç»§ç»­å¸®ä½ ç»†åŒ– ğŸ‘‡

1ï¸âƒ£ ç»™ä½ ä¸€ä»½ **ã€Œå¹³å°æ”¯æŒ vs ç”¨æˆ·è‡ªç®¡ã€çš„è´£ä»»è¾¹ç•Œè¡¨**

2ï¸âƒ£ å¸®ä½ å†™ä¸€æ®µ **FAQ / ç”¨æˆ·å¸¸è§é—®é¢˜è¯´æ˜**

3ï¸âƒ£ ç»™ä½ ä¸€ä¸ª **æ¨èçš„ Java GC æ—¥å¿—æœ€å°é…ç½®ï¼ˆä¸æ”¹ Dockerfileï¼‰æ–¹æ¡ˆ**

ä½ è¿™ä¸ªé—®é¢˜é—®å¾—éå¸¸å¯¹ï¼Œå…¶å®å·²ç»æ˜¯**å¹³å°æˆç†ŸæœŸ**æ‰ä¼šé‡åˆ°çš„é‚£ç§é—®é¢˜äº† ğŸ‘

å¤ªå¥½äº†ï¼Œè¿™ä¸ªç‚¹ä½ æŠ“å¾—**éå¸¸å‡†** ğŸ‘

æ—¢ç„¶å·²ç»æ˜ç¡® **Java 17**ï¼Œé‚£æˆ‘ä»¬å°±**ä¸å†åšå…¼å®¹æ€§å¦¥å**ï¼Œç›´æ¥ç»™ä½ ä¸€å¥— **Java 17 + GKE ç”Ÿäº§çº§æ ‡å‡†ç­”æ¡ˆ**ã€‚

ä¸‹é¢å†…å®¹ä¾ç„¶æ˜¯ **å®Œæ•´ã€å¯ç›´æ¥ç²˜è´´ä½¿ç”¨çš„ Markdown æ–‡æ¡£**ã€‚

---

# **Java 17 GC æ—¥å¿—å®Œæ•´æ¨èé…ç½®ï¼ˆå« Dockerfileï¼‰**

## **1. é—®é¢˜åˆ†æï¼ˆJava 17 è¯­å¢ƒï¼‰**

åœ¨ **Java 17ï¼ˆLTSï¼‰** ä¸­ï¼š

- **G1 GC æ˜¯é»˜è®¤ GC**
- ç»Ÿä¸€ä½¿ç”¨ **Unified Loggingï¼ˆ-Xlogï¼‰**
- PrintGCDetails ç­‰å‚æ•°å·²åºŸå¼ƒ
- é€šè¿‡ GC æ—¥å¿— **å¯ä»¥è¦†ç›–ç»å¤§å¤šæ•°è€å¹´ä»£é—®é¢˜å®šä½**

ğŸ‘‰ å¯¹å¹³å°è€Œè¨€ï¼š

**åªè¦ GC æ—¥å¿—é…ç½®æ­£ç¡®ï¼Œ80% çš„ Old Gen é—®é¢˜ä¸éœ€è¦ Heap Dump.**

---

## **2. Java 17 æ¨è GC æ—¥å¿—é…ç½®ï¼ˆæ ¸å¿ƒï¼‰**

### **2.1 å¿…é€‰ GC æ—¥å¿—å‚æ•°ï¼ˆç”Ÿäº§æ ‡å‡†ï¼‰**

```
-Xlog:gc*,gc+heap=info,gc+age=trace,gc+phases=debug
```

### **2.2 è€å¹´ä»£é‡ç‚¹å…³æ³¨æ—¥å¿—**

```
-Xlog:gc+heap=info
-Xlog:gc+age=trace
-Xlog:gc+phases=debug
```

è¯´æ˜ï¼š

| **æ—¥å¿—é¡¹** | **ç”¨é€”** |
|------------|----------|
| gc | GC å‘ç”Ÿé¢‘ç‡ |
| gc+heap | Old Gen å›æ”¶å‰åå˜åŒ– |
| gc+age | å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£é€Ÿåº¦ |
| gc+phases | Full GC / Mixed GC é˜¶æ®µè€—æ—¶ |

---

## **3. Java 17 æ¨èæ—¥å¿—è¾“å‡ºä¸æ»šåŠ¨ç­–ç•¥ï¼ˆéå¸¸é‡è¦ï¼‰**

```
-Xlog:gc*:file=/var/log/jvm/gc.log:time,uptime,level,tags:filecount=10,filesize=50M
```

**åŸå› **ï¼š

- uptimeï¼šæ–¹ä¾¿å¯¹é½ Pod ç”Ÿå‘½å‘¨æœŸ
- filecount + filesizeï¼šé¿å…ç£ç›˜è¢«æ‰“æ»¡
- æ—¥å¿—å¯è¢« Sidecar / Agent ç¨³å®šé‡‡é›†

---

## **4. Java 17 æ¨è JVM è¿è¡Œå‚æ•°ï¼ˆè€å¹´ä»£å‹å¥½ï¼‰**

```
-Xms512m
-Xmx512m
-XX:MaxGCPauseMillis=200
-XX:+AlwaysPreTouch
```

è¯´æ˜ï¼š

- å›ºå®šå †å¤§å°ï¼Œé¿å…è¿è¡ŒæœŸæ‰©ç¼©å®¹å½±å“ GC åˆ¤æ–­
- AlwaysPreTouch æå‰åˆ†é…å†…å­˜ï¼Œå‡å°‘è€å¹´ä»£æŠ–åŠ¨å‡è±¡

---

## **5. Java 17 æ¨è OOM ä¿æŠ¤ï¼ˆå¯é€‰ä½†å¼ºçƒˆå»ºè®®ï¼‰**

```
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/var/log/jvm/heapdump.hprof
```

> å¹³æ—¶ä¸ä¼šäº§ç”Ÿ Heap Dumpï¼Œ**åªåœ¨ OOM æ—¶è§¦å‘**ï¼Œå¯¹å¹³å°å½±å“æå°ã€‚

---

## **6. æ¨è Dockerfileï¼ˆJava 17 æ ‡å‡†ç‰ˆï¼‰**

### **6.1 åŸºç¡€é•œåƒé€‰æ‹©ï¼ˆå¼ºçƒˆæ¨èï¼‰**

```
FROM eclipse-temurin:17-jre
```

ç†ç”±ï¼š

- å®˜æ–¹ OpenJDK
- LTS
- ä¸ Java 17 è¡Œä¸ºå®Œå…¨ä¸€è‡´
- é€‚åˆå¹³å°é•¿æœŸç»´æŠ¤

---

### **6.2 å®Œæ•´ Dockerfile ç¤ºä¾‹**

```
FROM eclipse-temurin:17-jre

WORKDIR /app

# JVM æ—¥å¿—ç›®å½•
RUN mkdir -p /var/log/jvm \
    && chmod -R 777 /var/log/jvm

# åº”ç”¨åŒ…
COPY app.jar /app/app.jar

# Java 17 JVM å‚æ•°
ENV JAVA_OPTS="\
-Xms512m \
-Xmx512m \
-XX:MaxGCPauseMillis=200 \
-XX:+AlwaysPreTouch \
-Xlog:gc*,gc+heap=info,gc+age=trace,gc+phases=debug:file=/var/log/jvm/gc.log:time,uptime,level,tags:filecount=10,filesize=50M \
-XX:+HeapDumpOnOutOfMemoryError \
-XX:HeapDumpPath=/var/log/jvm/heapdump.hprof \
"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar"]
```

---

## **7. Kubernetes ä¸­çš„æ—¥å¿—æ”¶é›†å»ºè®®ï¼ˆJava 17ï¼‰**

### **7.1 æ¨èæ–¹æ¡ˆï¼šEmptyDir + Sidecar**

```
volumes:
  - name: jvm-logs
    emptyDir: {}
```

```
volumeMounts:
  - name: jvm-logs
    mountPath: /var/log/jvm
```

Sidecar é‡‡é›†ï¼š

- /var/log/jvm/gc.log
- å¯é€‰ /var/log/jvm/heapdump.hprof

---

## **8. Java 17 GC æ—¥å¿—å¯ä»¥ç›´æ¥å›ç­”çš„é—®é¢˜**

| **é—®é¢˜** | **æ˜¯å¦å¯é€šè¿‡ GC æ—¥å¿—å®šä½** |
|----------|-----------------------------|
| è€å¹´ä»£æ˜¯å¦æŒç»­å¢é•¿ | âœ… |
| Mixed GC æ˜¯å¦æœ‰æ•ˆ | âœ… |
| Full GC æ˜¯å¦é€€åŒ– | âœ… |
| æ™‹å‡é€Ÿç‡æ˜¯å¦å¼‚å¸¸ | âœ… |
| åœé¡¿æ—¶é—´æ˜¯å¦å¯æ¥å— | âœ… |
| HPA æ˜¯å¦è¢« GC é©±åŠ¨ | âœ… |

---

## **9. å¹³å°çº§æ¨èè¯´æ³•ï¼ˆä½ å¯ä»¥ç›´æ¥ç”¨ï¼‰**

> åœ¨ Java 17 ç¯å¢ƒä¸‹ï¼Œå¹³å°æ¨èé€šè¿‡æ ‡å‡† GC æ—¥å¿—å®Œæˆ JVM è€å¹´ä»£é—®é¢˜å®šä½ã€‚
> 
> è‹¥éœ€è¦ Heap Dump æˆ– jmap çº§åˆ«åˆ†æï¼Œè¯·ä½¿ç”¨è‡ªå®šä¹‰ Docker é•œåƒä»¥è·å– JVM è¿›ç¨‹æ§åˆ¶èƒ½åŠ›ã€‚

---

## **10. ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ åšçš„ï¼ˆJava 17 ä¸“é¡¹ï¼‰**

ä½ å¯ä»¥é€‰ä¸€ä¸ªï¼Œæˆ‘ç›´æ¥å¸®ä½ è¡¥é½ ğŸ‘‡

1ï¸âƒ£ **Java 17 G1 GC è€å¹´ä»£å¼‚å¸¸çš„å…¸å‹æ—¥å¿—æ¨¡å¼è§£æ**

2ï¸âƒ£ **å¦‚ä½•ä»…å‡­ GC æ—¥å¿—åˆ¤æ–­æ˜¯å¦"ç–‘ä¼¼å†…å­˜æ³„æ¼"**

3ï¸âƒ£ **Java 17 + GKE + HPA ä¸‹çš„å†…å­˜/GC è”åˆåˆ†ææµç¨‹å›¾**

4ï¸âƒ£ **ç»™ç”¨æˆ·çš„ Java 17 GC æ’æŸ¥ SOPï¼ˆå¹³å°ç‰ˆï¼‰**

ä½ è¿™ä¸ªé—®é¢˜å·²ç»éå¸¸"å¹³å° owner çº§åˆ«"äº†ï¼Œè¯´å®è¯ï¼Œé—®å¾—å¾ˆåˆ°ä½ã€‚

# ChatGPT

ä¸‹é¢æˆ‘ä» **JVM å†…å­˜æ¨¡å‹ â†’ G1GC å·¥ä½œæœºåˆ¶ â†’ è€å¹´ä»£å«ä¹‰ â†’ OOMKilled ä¸ GC çš„å…³ç³» â†’ å®æˆ˜å‚æ•°ä¸è§‚æµ‹æ–¹æ³•** è¿™æ¡ä¸»çº¿ï¼Œç³»ç»Ÿæ€§åœ°æŠŠ -XX:+UseG1GC ç»™ä½ è®²æ¸…æ¥šï¼Œå **GKE / å®¹å™¨ / ç”Ÿäº§ç¯å¢ƒ** è§†è§’ã€‚

---

## **ä¸€ã€é—®é¢˜åˆ†æï¼ˆä½ çœŸæ­£å…³å¿ƒçš„ç‚¹ï¼‰**

ä½ çš„æ ¸å¿ƒç–‘é—®å…¶å®æ˜¯ä¸‰ç±»ï¼š

1. **UseG1GC åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ**
2. **GC æ˜¯å¦èƒ½åœ¨ Pod è¢« OOMKilled ä¹‹å‰"æ•‘åœº"ï¼Ÿ**
3. **"è€å¹´ä»£"æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé—®é¢˜ç»å¸¸å‡ºåœ¨è€å¹´ä»£ï¼Ÿ**

è¿™ä¸‰ä¸ªé—®é¢˜åœ¨ **K8S + Java + Memory Limit** åœºæ™¯ä¸‹æ˜¯å¼ºç›¸å…³çš„ã€‚

---

## **äºŒã€Java å†…å­˜æ¨¡å‹ï¼ˆç†è§£ G1GC çš„å‰æï¼‰**

### **1ï¸âƒ£ JVM Heap åŸºæœ¬ç»“æ„**

```
JVM Heap
â”œâ”€â”€ Young Generationï¼ˆå¹´è½»ä»£ï¼‰
â”‚   â”œâ”€â”€ Eden
â”‚   â”œâ”€â”€ Survivor S0
â”‚   â””â”€â”€ Survivor S1
â””â”€â”€ Old Generationï¼ˆè€å¹´ä»£ï¼‰
```

| **åŒºåŸŸ** | **å­˜æ”¾å†…å®¹** | **ç‰¹ç‚¹** |
|----------|--------------|----------|
| Eden | æ–°åˆ›å»ºå¯¹è±¡ | å›æ”¶é¢‘ç¹ |
| Survivor | æ´»å¾—ä¹…ä¸€ç‚¹çš„å¯¹è±¡ | æ™‹å‡ç¼“å†²åŒº |
| **Old Gen** | ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ | å›æ”¶ä»£ä»·é«˜ |

---

### **2ï¸âƒ£ ä»€ä¹ˆæ˜¯ã€Œè€å¹´ä»£ã€ï¼Ÿ**

**è€å¹´ä»£ = æ´»å¾—è¶³å¤Ÿä¹…ã€è¢«è®¤ä¸º"ç¨³å®š"çš„å¯¹è±¡**

å…¸å‹è€å¹´ä»£å¯¹è±¡ï¼š

- Spring Bean å•ä¾‹
- ç¼“å­˜ï¼ˆMap / Guava / Caffeineï¼‰
- çº¿ç¨‹æ± ã€è¿æ¥æ± å¯¹è±¡
- å¤§å¯¹è±¡ï¼ˆå¤§æ•°ç»„ã€ByteBufferï¼‰

ğŸ‘‰ **é—®é¢˜æœ¬è´¨**

> å¤§å¤šæ•° OOM é—®é¢˜ï¼Œæœ¬è´¨æ˜¯ï¼š
> 
> **è€å¹´ä»£æ— æ³•å›æ”¶ or å›æ”¶å¤ªæ…¢**

---

## **ä¸‰ã€UseG1GC æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆä¸ºä»€ä¹ˆå®ƒé€‚åˆäº‘åŸç”Ÿï¼‰**

### **1ï¸âƒ£ G1GC çš„è®¾è®¡ç›®æ ‡**

```
ç›®æ ‡ï¼šå¯é¢„æµ‹çš„ä½åœé¡¿ï¼ˆPause Timeï¼‰
```

è€Œä¸æ˜¯ï¼š

- âŒ æœ€é«˜åå
- âŒ æœ€å¤§åŒ–å‹æ¦¨å†…å­˜

éå¸¸é€‚åˆï¼š

- GKE
- æœ‰ memory limit çš„ Pod
- å¯¹ RT ç¨³å®šæ€§è¦æ±‚é«˜çš„ API æœåŠ¡

---

### **2ï¸âƒ£ G1GC çš„æ ¸å¿ƒæ¦‚å¿µï¼šRegion**

**G1 ä¸å†ä½¿ç”¨å›ºå®š Young / Old è¿ç»­å†…å­˜**

```
Heap è¢«åˆ‡æˆå¤šä¸ª Regionï¼ˆ1MB~32MBï¼‰
```

| **Region ç±»å‹** | **å«ä¹‰** |
|-----------------|----------|
| Eden Region | å¹´è½»ä»£ |
| Survivor Region | å¹¸å­˜åŒº |
| Old Region | è€å¹´ä»£ |
| Humongous Region | è¶…å¤§å¯¹è±¡ |

> ğŸ‘‰ Region çš„è§’è‰²æ˜¯**åŠ¨æ€çš„**

---

### **3ï¸âƒ£ G1GC çš„å›æ”¶æ–¹å¼**

#### **å¹´è½»ä»£ GCï¼ˆYoung GCï¼‰**

- Stop-The-World
- éå¸¸å¿«
- é«˜é¢‘

#### **Mixed GCï¼ˆG1 çš„ç²¾åï¼‰**

- **åŒæ—¶å›æ”¶ Young + ä¸€éƒ¨åˆ† Old**
- æŒ‰"æ”¶ç›Šæœ€é«˜"æ’åºå›æ”¶
- é¿å… Full GC

#### **Full GCï¼ˆæœ€å±é™©ï¼‰**

- Stop-The-World
- é€šå¸¸æ„å‘³ç€ **å·²ç»å¿«ä¸è¡Œäº†**

---

## **å››ã€GC ä¸ OOMKilled çš„çœŸå®å…³ç³»ï¼ˆé‡ç‚¹ï¼‰**

### **1ï¸âƒ£ OOMKilled æ˜¯è°å¹²çš„ï¼Ÿ**

```
OOMKilled â‰  JVM OOM
OOMKilled = Linux Kernel
```

åœ¨ GKE ä¸­ï¼š

```
Pod å†…å­˜ > memory.limit
â†“
Linux cgroup è§¦å‘
â†“
ç›´æ¥ SIGKILLï¼ˆkill -9ï¼‰
```

ğŸ‘‰ **JVM æ¥ä¸åŠæŠ›å¼‚å¸¸**

---

### **2ï¸âƒ£ GC èƒ½å¦åœ¨ OOMKilled å‰è§¦å‘ï¼Ÿ**

**ç»“è®ºï¼šæœ‰å¯èƒ½ï¼Œä½†ä¸ä¿è¯**

#### **GC è§¦å‘æ¡ä»¶ï¼ˆç®€åŒ–ï¼‰**

- å †ç©ºé—´ä¸è¶³
- Allocation Failure
- G1 é¢„æµ‹ Pause Time å¤±æ§

âš ï¸ ä½†é—®é¢˜åœ¨äºï¼š

```
GC åªç®¡ç† JVM Heap
OOMKilled çœ‹çš„æ˜¯è¿›ç¨‹ RSS
```

RSS åŒ…å«ï¼š

- Java Heap
- Metaspace
- Direct Memory
- Thread Stack
- libc / JIT / mmap

---

### **3ï¸âƒ£ ä¸ºä»€ä¹ˆ"GC è§¦å‘äº†è¿˜æ˜¯è¢« OOMKilled"ï¼Ÿ**

å…¸å‹åœºæ™¯ï¼š

```
1. Old Gen å·²ç»å¾ˆæ»¡
2. GC å°è¯• Mixed GC
3. å›æ”¶é€Ÿåº¦ < å¯¹è±¡åˆ†é…é€Ÿåº¦
4. RSS çªç ´ cgroup limit
5. Kernel ç›´æ¥ kill
```

ğŸ‘‰ **GC æ²¡æ¥å¾—åŠæ•‘ä½ **

---

## **äº”ã€UseG1GC ä¸‹çš„å…³é”® JVM å‚æ•°ï¼ˆç”Ÿäº§çº§ï¼‰**

### **1ï¸âƒ£ å¯ç”¨ G1GC**

```
-XX:+UseG1GC
```

---

### **2ï¸âƒ£ æ§åˆ¶åœé¡¿æ—¶é—´ï¼ˆéå¸¸é‡è¦ï¼‰**

```
-XX:MaxGCPauseMillis=200
```

å«ä¹‰ï¼š

- **ä¸æ˜¯ä¿è¯**
- æ˜¯ G1 çš„"è°ƒåº¦ç›®æ ‡"

---

### **3ï¸âƒ£ æå‰è§¦å‘ GCï¼ˆé˜²æ­¢è¢« OOMKilledï¼‰**

```
-XX:InitiatingHeapOccupancyPercent=30
```

| **é»˜è®¤å€¼** | **å»ºè®®** |
|------------|----------|
| ~45% | 30% / 35% |

ğŸ‘‰ **è€å¹´ä»£ 30% å°±å¼€å§‹ Mixed GC**

---

### **4ï¸âƒ£ å®¹å™¨æ„ŸçŸ¥ï¼ˆå¿…é¡»ï¼‰**

```
-XX:+UseContainerSupport
-XX:MaxRAMPercentage=70
-XX:InitialRAMPercentage=50
```

è§£é‡Šï¼š

| **å‚æ•°** | **ä½œç”¨** |
|----------|----------|
| MaxRAMPercentage | JVM Heap å  Pod å†…å­˜æ¯”ä¾‹ |
| ç•™ 30% | ç»™ Direct / Metaspace / OS |

---

### **5ï¸âƒ£ é˜²æ­¢ Humongous Object çˆ†å†…å­˜**

```
-XX:G1HeapRegionSize=8m
```

> å¤§å¯¹è±¡ >= 50% Region â†’ Humongous
> 
> Humongous å¯¹ G1 éå¸¸ä¸å‹å¥½

---

## **å…­ã€å¦‚ä½•"çœ‹åˆ° GC åœ¨ OOMKilled ä¹‹å‰æœ‰æ²¡æœ‰åŠªåŠ›è¿‡"**

### **1ï¸âƒ£ å¼€ GC æ—¥å¿—ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰**

```
-Xlog:gc*,gc+heap=info,gc+age=trace
```

ä½ èƒ½çœ‹åˆ°ï¼š

- Young GC é¢‘ç‡
- Mixed GC æ˜¯å¦å‘ç”Ÿ
- Old Region å›æ”¶æƒ…å†µ
- æ˜¯å¦å‡ºç° Full GC

---

### **2ï¸âƒ£ Pod è¢«æ€å‰çš„å…¸å‹ GC æ—¥å¿—ç‰¹å¾**

| **ç°è±¡** | **å«ä¹‰** |
|----------|----------|
| GC éå¸¸é¢‘ç¹ | åˆ†é…å‹åŠ›è¿‡å¤§ |
| Mixed GC å›æ”¶ç‡ä½ | è€å¹´ä»£ä¸å¯å›æ”¶ |
| Full GC | å±é™©ä¿¡å· |
| GC å Heap å‡ ä¹ä¸é™ | å†…å­˜æ³„æ¼ |

---

### **3ï¸âƒ£ é…åˆ K8S äº‹ä»¶**

```
kubectl describe pod <pod>
```

ä½ ä¼šçœ‹åˆ°ï¼š

```
Reason: OOMKilled
```

ä½† **JVM log æ‰æ˜¯çœŸç›¸**

---

## **ä¸ƒã€æ€»ç»“ï¼ˆç»™ä½ ä¸€ä¸ªå·¥ç¨‹å¸ˆè§†è§’çš„ç»“è®ºï¼‰**

### **1ï¸âƒ£ ä¸€å¥è¯ç†è§£ UseG1GC**

> G1GC æ˜¯ä¸€ä¸ª **å°½é‡æå‰ã€åˆ†é˜¶æ®µã€å¯é¢„æµ‹åœ°æ¸…ç†è€å¹´ä»£**
> 
> æ¥é¿å… Full GC å’Œ OOM çš„åƒåœ¾å›æ”¶å™¨

---

### **2ï¸âƒ£ å…³äºè€å¹´ä»£**

- è€å¹´ä»£ â‰  å
- **è€å¹´ä»£ä¸å¯å›æ”¶ â‰ˆ å¿…æ­»**
- 90% Java å†…å­˜äº‹æ•…éƒ½å’Œå®ƒæœ‰å…³

---

### **3ï¸âƒ£ å…³äº OOMKilled**

- GC â‰  æœ€ç»ˆè£åˆ¤
- Linux Kernel æ‰æ˜¯
- **JVM å¿…é¡»æå‰è‡ªä¿**

---

### **4ï¸âƒ£ ä½ åœ¨ GKE çš„æœ€ä½³å®è·µ Checklist**

- âœ… UseG1GC
- âœ… é™ä½ IHOPï¼ˆ30%ï¼‰
- âœ… æ§åˆ¶ MaxRAMPercentage
- âœ… æ‰“å¼€ GC æ—¥å¿—
- âœ… è­¦æƒ• Humongous Object
- âœ… ä¸è¦æŠŠ memory limit å¡å¤ªæ­»

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ ï¼š

- **è§£è¯»ä¸€æ®µçœŸå® GC log**
- **ç»“åˆ HPA / memory limit ç»™ä½ ä¸€å¥—æ¨èå‚æ•°**
- **åˆ†æ Java åº”ç”¨ä¸ºä»€ä¹ˆè€å¹´ä»£å›æ”¶ä¸æ‰ï¼ˆç¼“å­˜ / çº¿ç¨‹ / Directï¼‰**

ä¸‹é¢æˆ‘**ç›´æ¥æŒ‰ä½ ç»™çš„ç›®æ ‡æ¥**ï¼š

ğŸ‘‰ **ç»“åˆ GKE çš„ HPA + memory limitï¼Œç»™ä½ ä¸€å¥—"å¯è½åœ°"çš„ JVM å‚æ•°æ–¹æ¡ˆ**

ğŸ‘‰ **ç³»ç»Ÿæ€§åˆ†æ Java åº”ç”¨ä¸ºä»€ä¹ˆ"è€å¹´ä»£å›æ”¶ä¸æ‰"**ï¼ˆç¼“å­˜ / çº¿ç¨‹ / Direct / çœŸå®ç”Ÿäº§é™·é˜±ï¼‰

æˆ‘ä¼šç”¨ **å·¥ç¨‹è§†è§’**ï¼Œè€Œä¸æ˜¯ JVM æ•™ç§‘ä¹¦è§†è§’ã€‚

---

## **ä¸€ã€é—®é¢˜åˆ†æï¼ˆGKE + Java + HPA çš„çœŸå®çŸ›ç›¾ï¼‰**

åœ¨ GKE ä¸­ä½ é¢å¯¹çš„æ˜¯ä¸€ä¸ª**ä¸‰æ–¹åšå¼ˆ**ï¼š

```
Java GC  <->  Pod memory limit  <->  HPA æ‰©ç¼©å®¹
```

### **æ ¸å¿ƒçŸ›ç›¾ç‚¹**

| **ç»„ä»¶** | **å…³æ³¨ç‚¹** |
|----------|------------|
| JVM | Heap æ˜¯å¦å¯å›æ”¶ |
| Linux cgroup | RSS æ˜¯å¦è¶…è¿‡ limit |
| HPA | æ˜¯å¦è§¦å‘ scale out |

ğŸ‘‰ **JVM åªçœ‹ Heapï¼ŒHPA çœ‹çš„æ˜¯ RSS / æŒ‡æ ‡**

ğŸ‘‰ **OOMKilled æ˜¯æœ€å…ˆå‘ç”Ÿçš„"ç¡¬å¤±è´¥"**

---

## **äºŒã€GKE ä¸‹çš„æ¨èèµ„æºæ¨¡å‹ï¼ˆå…ˆå®šè¾¹ç•Œï¼‰**

### **1ï¸âƒ£ Pod èµ„æºå»ºè®®ï¼ˆéå¸¸é‡è¦ï¼‰**

```
resources:
  requests:
    memory: "2Gi"
    cpu: "500m"
  limits:
    memory: "3Gi"
    cpu: "1"
```

**ç»éªŒåŸåˆ™**ï¼š

- limit = request Ã— 1.3 ~ 1.5
- **memory request = HPA å‚è€ƒåŸºçº¿**
- limit ç•™å‡º JVM + native ç©ºé—´

---

## **ä¸‰ã€æ¨è JVM å‚æ•°ï¼ˆç”Ÿäº§çº§ï¼Œå¯ç›´æ¥ç”¨ï¼‰**

å‡è®¾ï¼š

- Pod memory limit = **3Gi**
- Java APIï¼ˆSpring / Kong RT / å¾®æœåŠ¡ï¼‰

---

### **1ï¸âƒ£ åŸºç¡€å¿…é€‰å‚æ•°ï¼ˆå®¹å™¨å‹å¥½ï¼‰**

```
-XX:+UseG1GC
-XX:+UseContainerSupport
```

---

### **2ï¸âƒ£ Heap å æ¯”æ§åˆ¶ï¼ˆé˜² OOMKilled æ ¸å¿ƒï¼‰**

```
-XX:MaxRAMPercentage=65
-XX:InitialRAMPercentage=40
```

ğŸ“Œ è§£é‡Šï¼š

| **é¡¹** | **è®¡ç®—** |
|--------|----------|
| Max Heap | ~1.95Gi |
| é¢„ç•™ | ~1.05Gi ç»™ native |

---

### **3ï¸âƒ£ æå‰å›æ”¶è€å¹´ä»£ï¼ˆå…³é”®ï¼‰**

```
-XX:InitiatingHeapOccupancyPercent=30
-XX:MaxGCPauseMillis=200
```

ğŸ‘‰ **è€å¹´ä»£ 30% å°±å¼€å§‹ Mixed GC**

---

### **4ï¸âƒ£ é˜²æ­¢å¤§å¯¹è±¡å‡»ç©¿ï¼ˆG1 æ­»ç©´ï¼‰**

```
-XX:G1HeapRegionSize=8m
```

---

### **5ï¸âƒ£ GC æ—¥å¿—ï¼ˆç”Ÿäº§å¿…å¼€ï¼‰**

```
-Xlog:gc*,gc+heap=info,gc+age=trace
```

---

### **âœ… æœ€ç»ˆ JVM å‚æ•°ç¤ºä¾‹ï¼ˆå®Œæ•´ï¼‰**

```
JAVA_OPTS="
-XX:+UseG1GC
-XX:+UseContainerSupport
-XX:MaxRAMPercentage=65
-XX:InitialRAMPercentage=40
-XX:InitiatingHeapOccupancyPercent=30
-XX:MaxGCPauseMillis=200
-XX:G1HeapRegionSize=8m
-Xlog:gc*,gc+heap=info,gc+age=trace
"
```

---

## **å››ã€HPA æ¨èé…ç½®ï¼ˆé¿å…"GC æŠ–åŠ¨å¼æ‰©å®¹"ï¼‰**

### **1ï¸âƒ£ ä¸è¦åªç”¨ memory utilizationï¼ˆå¤§å‘ï¼‰**

âŒ **é”™è¯¯ç¤ºä¾‹**

```
metrics:
- type: Resource
  resource:
    name: memory
    target:
      type: Utilization
      averageUtilization: 70
```

åŸå› ï¼š

- GC æŠ–åŠ¨
- Old Gen å †ç§¯ â†’ RSS ä¸é™
- HPA è¯¯åˆ¤æ‰©å®¹

---

### **2ï¸âƒ£ æ¨è HPA ç­–ç•¥ï¼ˆç»„åˆæ‹³ï¼‰**

```
metrics:
- type: Resource
  resource:
    name: cpu
    target:
      type: Utilization
      averageUtilization: 60
```