# Horizontal Pod Autoscaler (HPA) 详解 - GitHub兼容版

## 核心公式

HPA的核心算法公式为：

```
desiredReplicas = ⌈ currentReplicas × (currentMetricValue / desiredMetricValue) ⌉
```

其中，⌈ ⌉ 表示向上取整（ceiling function）。

## 重要说明

**HPA没有内置的10%容差机制**。扩容和缩容都是基于当前指标值与目标值的比较，任何超过目标值的情况都可能触发扩容，任何低于目标值的情况都可能触发缩容（受其他因素如冷却时间等影响）。

## HPA 配置示例

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: aibang-deployment-hpa
  namespace: aibang
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: aibang-deployment
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 750
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

## CPU 扩容和缩容的触发条件分析

目标CPU利用率：750%

### 1. 从1个副本扩容到2个副本

**触发条件**：CPU利用率 > 750%

当CPU利用率为800%时：
```
desiredReplicas = ⌈ 1 × (800 / 750) ⌉ = ⌈ 1.067 ⌉ = 2
```

当CPU利用率为751%时：
```
desiredReplicas = ⌈ 1 × (751 / 750) ⌉ = ⌈ 1.001 ⌉ = 2
```

**结论**：任何超过750%的CPU利用率都会触发从1个副本扩容到2个副本。

### 2. 从2个副本扩容到3个副本

**触发条件**：需要计算出desiredReplicas > 2

设当前CPU利用率为x%，则：
```
⌈ 2 × (x / 750) ⌉ > 2
```

这意味着：
```
2 × (x / 750) > 2
x / 750 > 1
x > 750
```

但由于向上取整的特性，我们需要：
```
2 × (x / 750) > 2
```

实际上，当x > 750时，结果就会大于2，向上取整后为3。

**验证**：当CPU利用率为751%时：
```
desiredReplicas = ⌈ 2 × (751 / 750) ⌉ = ⌈ 2.003 ⌉ = 3
```

**结论**：任何超过750%的CPU利用率都会触发从2个副本扩容到3个副本。

### 3. 从3个副本缩容到2个副本

**触发条件**：需要计算出desiredReplicas ≤ 2

设当前CPU利用率为x%，则：
```
⌈ 3 × (x / 750) ⌉ ≤ 2
```

这意味着：
```
3 × (x / 750) ≤ 2
x / 750 ≤ 2/3
x ≤ 500
```

**验证**：
- 当CPU利用率为500%时：
```
desiredReplicas = ⌈ 3 × (500 / 750) ⌉ = ⌈ 2 ⌉ = 2
```

- 当CPU利用率为501%时：
```
desiredReplicas = ⌈ 3 × (501 / 750) ⌉ = ⌈ 2.004 ⌉ = 3
```

**结论**：当CPU利用率 ≤ 500%时，会从3个副本缩容到2个副本。

### 4. 从2个副本缩容到1个副本

**触发条件**：需要计算出desiredReplicas ≤ 1

设当前CPU利用率为x%，则：
```
⌈ 2 × (x / 750) ⌉ ≤ 1
```

这意味着：
```
2 × (x / 750) ≤ 1
x / 750 ≤ 1/2
x ≤ 375
```

**验证**：
- 当CPU利用率为375%时：
```
desiredReplicas = ⌈ 2 × (375 / 750) ⌉ = ⌈ 1 ⌉ = 1
```

- 当CPU利用率为376%时：
```
desiredReplicas = ⌈ 2 × (376 / 750) ⌉ = ⌈ 1.001 ⌉ = 2
```

**结论**：当CPU利用率 ≤ 375%时，会从2个副本缩容到1个副本。

## Memory 扩容和缩容的触发条件分析

目标内存利用率：80%

### 1. 从1个副本扩容到2个副本

**触发条件**：内存利用率 > 80%

当内存利用率为81%时：
```
desiredReplicas = ⌈ 1 × (81 / 80) ⌉ = ⌈ 1.0125 ⌉ = 2
```

**结论**：任何超过80%的内存利用率都会触发从1个副本扩容到2个副本。

### 2. 从2个副本扩容到3个副本

**触发条件**：内存利用率 > 80%

当内存利用率为81%时：
```
desiredReplicas = ⌈ 2 × (81 / 80) ⌉ = ⌈ 2.025 ⌉ = 3
```

**结论**：任何超过80%的内存利用率都会触发从2个副本扩容到3个副本。

### 3. 从3个副本缩容到2个副本

**触发条件**：需要计算出desiredReplicas ≤ 2

设当前内存利用率为x%，则：
```
3 × (x / 80) ≤ 2
x ≤ 160/3 ≈ 53.33%
```

**验证**：
- 当内存利用率为53%时：
```
desiredReplicas = ⌈ 3 × (53 / 80) ⌉ = ⌈ 1.9875 ⌉ = 2
```

- 当内存利用率为54%时：
```
desiredReplicas = ⌈ 3 × (54 / 80) ⌉ = ⌈ 2.025 ⌉ = 3
```

**结论**：当内存利用率 ≤ 53%时，会从3个副本缩容到2个副本。

### 4. 从2个副本缩容到1个副本

**触发条件**：需要计算出desiredReplicas ≤ 1

设当前内存利用率为x%，则：
```
2 × (x / 80) ≤ 1
x ≤ 40%
```

**验证**：
- 当内存利用率为40%时：
```
desiredReplicas = ⌈ 2 × (40 / 80) ⌉ = ⌈ 1 ⌉ = 1
```

- 当内存利用率为41%时：
```
desiredReplicas = ⌈ 2 × (41 / 80) ⌉ = ⌈ 1.025 ⌉ = 2
```

**结论**：当内存利用率 ≤ 40%时，会从2个副本缩容到1个副本。

## Memory扩容和缩容的触发条件 (averageValue 800Mi)

当使用绝对值（如800Mi）而非百分比时，算法完全相同：

```
desiredReplicas = ⌈ currentReplicas × (currentMemoryUsage / 800Mi) ⌉
```

### 1. 从1个副本扩容到2个副本

**触发条件**：内存使用量 > 800Mi

当内存使用量为801Mi时：
```
desiredReplicas = ⌈ 1 × (801 / 800) ⌉ = ⌈ 1.00125 ⌉ = 2
```

### 2. 从2个副本扩容到3个副本

**触发条件**：内存使用量 > 800Mi

当内存使用量为801Mi时：
```
desiredReplicas = ⌈ 2 × (801 / 800) ⌉ = ⌈ 2.0025 ⌉ = 3
```

### 3. 从3个副本缩容到2个副本

**触发条件**：内存使用量 ≤ 533Mi

```
3 × (x / 800) ≤ 2
x ≤ 1600/3 ≈ 533.33Mi
```

当内存使用量为533Mi时：
```
desiredReplicas = ⌈ 3 × (533 / 800) ⌉ = ⌈ 1.99875 ⌉ = 2
```

### 4. 从2个副本缩容到1个副本

**触发条件**：内存使用量 ≤ 400Mi

```
2 × (x / 800) ≤ 1
x ≤ 400Mi
```

当内存使用量为400Mi时：
```
desiredReplicas = ⌈ 2 × (400 / 800) ⌉ = ⌈ 1 ⌉ = 1
```

## 多指标HPA行为

当HPA配置了多个指标时，它会：

1. **分别计算每个指标的期望副本数**
2. **选择最大值作为最终的副本数**

例如，在你的配置中：
- CPU计算结果：2个副本
- 内存计算结果：2个副本
- 最终副本数：max(2, 2) = 2个副本

## 关键要点

1. **没有内置容差**：HPA直接基于当前值与目标值的比较进行计算
2. **向上取整**：确保副本数始终为正整数
3. **多指标取最大值**：防止任何一个指标超标
4. **冷却时间**：实际生产中，HPA有扩容和缩容的冷却时间，防止频繁变化
5. **最小/最大副本数限制**：计算结果会受到minReplicas和maxReplicas的约束

## 实际示例验证

基于你的describe输出：
```
resource cpu on pods (as a percentage of request) 15%(15m)/750%
resource memory on pods (as a percentage of request) 58%(367126528)/80%
```

CPU计算：
```
desiredReplicas = ⌈ 2 × (15 / 750) ⌉ = ⌈ 0.04 ⌉ = 1
```

内存计算：
```
desiredReplicas = ⌈ 2 × (58 / 80) ⌉ = ⌈ 1.45 ⌉ = 2
```

最终副本数：max(1, 2) = 2个副本

这解释了为什么当前副本数保持在2个。

## 快速参考表

### CPU (目标: 750%)

| 当前副本数 | 扩容触发条件 | 缩容触发条件 |
|-----------|-------------|-------------|
| 1 → 2     | > 750%      | N/A         |
| 2 → 3     | > 750%      | ≤ 375%      |
| 3 → 2     | N/A         | ≤ 500%      |

### Memory (目标: 80%)

| 当前副本数 | 扩容触发条件 | 缩容触发条件 |
|-----------|-------------|-------------|
| 1 → 2     | > 80%       | N/A         |
| 2 → 3     | > 80%       | ≤ 40%       |
| 3 → 2     | N/A         | ≤ 53%       |

### Memory (目标: 800Mi)

| 当前副本数 | 扩容触发条件 | 缩容触发条件 |
|-----------|-------------|-------------|
| 1 → 2     | > 800Mi     | N/A         |
| 2 → 3     | > 800Mi     | ≤ 400Mi     |
| 3 → 2     | N/A         | ≤ 533Mi     |