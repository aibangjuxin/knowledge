# HPA 扩缩容算法与容忍度解析

针对 HPA 基于内存扩容的算法疑虑，本文总结了 HPA 的核心计算公式以及"容忍度"（Tolerance）的关键作用，直接解答关于 "81%/80%" 是否触发扩容的问题。

## 1. 核心结论

**你的 81%/80% 场景下，HPA 不会扩容。**

虽然计算结果大于 2，但由于 HPA 默认存在 **10% 的容忍度（tolerance）**，偏差过小（1.25%）会被忽略，以此防止因为指标微小波动导致的副本数震荡（Flapping）。

## 2. HPA 计算公式详解

HPA 计算期望副本数的基本公式如下：

$$
\text{期望副本数} = \lceil \text{当前副本数} \times \frac{\text{当前指标值}}{\text{目标指标值}} \rceil
$$

其中 $\lceil \dots \rceil$ 代表 **向上取整（Ceil）**。

### 关键机制：容忍度 (Tolerance)

为了避免频繁扩缩容，HPA 引入了 `tolerance` 参数，默认值为 **0.1 (即 10%)**。

判断是否扩容的条件是：

```text
| 1 - (当前使用率 / 目标使用率) | > 容忍度
```

只有当 **计算出的比率与 1.0 的偏差超过 10%** 时，HPA 才会执行扩缩容操作。

## 3. 你的场景案例分析

我们带入你提供的数据进行计算：

*   **当前副本数**: 2
*   **目标内存利用率**: 80% (0.8)
*   **当前内存利用率**: 81% (0.81)

### 第一步：计算使用率比率 (Usage Ratio)

$$
\text{Usage Ratio} = \frac{81}{80} = 1.0125
$$

### 第二步：检查容忍度

计算偏差值：

$$
\text{偏差} = | 1 - 1.0125 | = 0.0125 \quad (即 1.25\%)
$$

**判断**：
由于 `0.0125` (1.25%) 远小于默认容忍度 `0.1` (10%)。

**结论**：
HPA 认为这次变化还在"可容忍"的波动范围内，**忽略忽略该信号，不进行扩容**。

### 假如没有容忍度（或偏差足够大）

如果偏差超过了 10%（例如当前利用率到了 89%，89/80 = 1.1125 > 1.1），那么计算过程如下：

$$
\text{计算结果} = 2 \times 1.1125 = 2.225
$$
$$
\text{期望副本数} = \lceil 2.225 \rceil = 3
$$

这时才会扩容到 3。

## 4. 总结表

| 场景 | 当前值/目标值 | 比率 (Ratio) | 偏差 | 是否超过 Tolerance (0.1) | 动作 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **你的场景** | 81% / 80% | 1.0125 | 1.25% | **否** (< 10%) | **保持不变** (2) |
| **扩容场景** | 89% / 80% | 1.1125 | 11.25% | **是** (> 10%) | **扩容** (`ceil(2.225)` -> 3) |
| **临界点** | 88% / 80% | 1.1 | 10% | **否** (= 10%) | **保持不变** |

> **注意**：可以通过设置 kube-controller-manager 的 `--horizontal-pod-autoscaler-tolerance` 参数修改此默认值，但云厂商环境（如 GKE）通常默认为 0.1 且无法轻易修改全局配置。
