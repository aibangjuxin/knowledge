åœ¨å¤šç§Ÿæˆ·ï¼ˆmulti-tenantï¼‰Kubernetes é›†ç¾¤ä¸­ï¼Œå°¤å…¶æ˜¯åŒä¸€ä¸ª namespace ä¸­éƒ¨ç½²äº†ä¸åŒç”¨æˆ·çš„æœåŠ¡æ—¶ï¼Œå°† Deployment ä¸­çš„ livenessProbeã€readinessProbe æˆ– startupProbe ä½¿ç”¨ HTTPS åè®®è€Œä¸æ˜¯ HTTPï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªå®‰å…¨å±‚é¢çš„å¥½å¤„ï¼š

âœ… ä½¿ç”¨ HTTPS å¥åº·æ£€æŸ¥çš„å®‰å…¨ä¼˜åŠ¿

|                                     |                                                                                                                                                                                                                  |
| ----------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| å®‰å…¨ç‚¹                              | è¯´æ˜                                                                                                                                                                                                             |
| 1. é˜²æ­¢æ˜æ–‡ä¼ è¾“æ•æ„Ÿä¿¡æ¯             | å¦‚æœå¥åº·æ£€æŸ¥æ¶‰åŠè®¤è¯ä¿¡æ¯ï¼ˆå¦‚ Tokenï¼‰ã€Cookie æˆ–å†…éƒ¨çŠ¶æ€æ•°æ®ï¼ŒHTTP æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œå®¹æ˜“è¢«æŠ“åŒ…æˆ–ç›‘å¬ã€‚HTTPS å¯ç¡®ä¿ TLS åŠ å¯†ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»ï¼ˆMitMï¼‰å’Œçªƒå¬ã€‚                                                            |
| 2. é™åˆ¶ namespace å†…éƒ¨æœåŠ¡ç›‘å¬      | åœ¨åŒä¸€ä¸ª namespace é‡Œéƒ¨ç½²å¤šä¸ªç”¨æˆ·æœåŠ¡æ—¶ï¼ŒæŸäº› Pod å¯ä»¥é€šè¿‡ç›‘å¬å…¶ä»– Pod çš„ IP å’Œç«¯å£å°è¯•è¿æ¥ï¼Œè‹¥å¥åº·æ£€æŸ¥èµ° HTTPï¼Œå®¹æ˜“è¢«æ»¥ç”¨æˆ–æ¢æµ‹ï¼ˆHTTP æ— éœ€æ¡æ‰‹å³å“åº”ï¼‰ã€‚è€Œ HTTPS å¢åŠ äº†åè®®å¤æ‚æ€§å’ŒéªŒè¯è¦æ±‚ï¼Œæ›´éš¾è¢«æ¨¡æ‹Ÿå’Œåˆ©ç”¨ã€‚ |
| 3. é˜²æ­¢ spoofing ä¸ forged response | è‹¥æ˜¯ HTTPï¼Œåªè¦æœ‰ Pod ç›‘å¬å¯¹åº”ç«¯å£å³å¯å“åº”å¥åº·æ£€æŸ¥ï¼Œå¯èƒ½ç»•è¿‡çœŸå®å¥åº·çŠ¶æ€ã€‚è€Œ HTTPS ä¼šæ£€æŸ¥è¯ä¹¦é“¾ï¼Œä¼ªé€  HTTPS æœåŠ¡æˆæœ¬å’Œéš¾åº¦é«˜å¾—å¤šã€‚                                                                               |
| 4. åˆ©äºä¸ mTLS æ¶æ„å¯¹é½             | å¦‚æœä½ å·²ç»åœ¨é‡‡ç”¨ GCP HTTPS Load Balancer + mTLS æˆ–æ˜¯ Kong çš„åŒå‘è®¤è¯ï¼Œå¥åº·æ£€æŸ¥ç”¨ HTTPS æœ‰åŠ©äºç»Ÿä¸€é€šä¿¡æ–¹å¼ï¼Œç®€åŒ–è®¤è¯é€»è¾‘å’Œå®¡è®¡ç­–ç•¥ã€‚                                                                              |
| 5. å‡å°‘å®‰å…¨å®¡è®¡æ—¶ false positive    | ä½¿ç”¨ HTTP å¥åº·æ£€æŸ¥å¯èƒ½åœ¨å®‰å…¨å®¡è®¡ä¸­è¢«æ ‡è®°ä¸ºâ€œæ˜æ–‡é€šä¿¡â€ï¼Œä»è€Œå¼•å‘å‘Šè­¦ã€‚ä½¿ç”¨ HTTPS åˆ™ç¬¦åˆç°ä»£å®‰å…¨åŸºçº¿ã€‚                                                                                                              |

âš ï¸ æ³¨æ„äº‹é¡¹

|                 |                                                                                                                                                                                                                 |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| é¡¹ç›®            | å»ºè®®                                                                                                                                                                                                            |
| è¯ä¹¦ç®¡ç†        | å¦‚æœ Pod å†…éƒ¨ä½¿ç”¨ HTTPSï¼Œéœ€è¦ä¸ºæ¯ä¸ª Pod æä¾›å¯ä¿¡è¯ä¹¦ï¼ˆå¯ä½¿ç”¨è‡ªç­¾ CA + sidecar æˆ– SPIRE/SDS ä¸‹å‘è¯ä¹¦ï¼‰ã€‚å¦åˆ™ kubelet å¥åº·æ£€æŸ¥å°†å› ä¸ºè¯ä¹¦ä¸å¯ä¿¡å¤±è´¥ã€‚                                                              |
| è·³è¿‡ TLS éªŒè¯ï¼Ÿ | kubelet çš„é»˜è®¤è¡Œä¸ºæ˜¯ä¸éªŒè¯è¯ä¹¦çš„ Common Name / SAN æˆ–ç­¾å‘æœºæ„ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨ probe ä¸­ä½¿ç”¨ httpsï¼Œä½†ä¸ç”¨é…ç½®å¤æ‚çš„ CA ä¿¡ä»»é“¾ â€”â€” é€‚åˆå†…éƒ¨ä½¿ç”¨ã€‚è‹¥å¼€å¯å¼ºæ ¡éªŒï¼ˆå¦‚é€šè¿‡ Istioï¼‰ï¼Œéœ€ç¡®ä¿ kubelet ä¿¡ä»»ç›®æ ‡æœåŠ¡è¯ä¹¦ã€‚ |
| æ€§èƒ½å¼€é”€        | ç›¸æ¯” HTTPï¼ŒHTTPS å­˜åœ¨å¾®å°çš„æ¡æ‰‹å’ŒåŠ å¯†å¼€é”€ï¼Œä½†å¯¹ç°ä»£é›†ç¾¤å¯å¿½ç•¥ä¸è®¡ã€‚                                                                                                                                             |

âœ… å®é™…ç¤ºä¾‹

livenessProbe:

httpGet:

scheme: HTTPS

path: /healthz

port: 8443

initialDelaySeconds: 5

periodSeconds: 10

âœ… æ¨èå®è·µï¼ˆå¤šç”¨æˆ· namespace ä¸‹ï¼‰

1. ä¸ºæ‰€æœ‰ç”¨æˆ·çš„æœåŠ¡ç»Ÿä¸€ä½¿ç”¨ HTTPS æ¥å£ï¼ˆå³ä¾¿å†…éƒ¨ï¼‰ï¼Œæœ€å°åŒ–è¯¯ç”¨é£é™©ã€‚
2. æ‰€æœ‰ probe ä½¿ç”¨ scheme: HTTPSï¼Œç¦ç”¨ HTTPã€‚
3. å¦‚æœç»“åˆäº† service meshï¼ˆå¦‚ Istio æˆ– Linkerdï¼‰ï¼Œå»ºè®®å¼€å¯ mTLS + æˆæƒç­–ç•¥ã€‚
4. æ—¥å¿—ä¸­éšè— probe ç›¸å…³è¯·æ±‚è®°å½•ï¼Œé˜²æ­¢è¢«åˆ©ç”¨çŒœæµ‹è·¯å¾„ã€‚

ğŸ“Œ Mermaid æµç¨‹å›¾ï¼šæ¶æ„ Pod å°è¯•æ¢æµ‹å¥åº·æ£€æŸ¥

```mermaid
sequenceDiagram

Â  Â  participant MaliciousPod

Â  Â  participant VictimPod

Â  Â  participant Kubelet



Â  Â  MaliciousPod->>VictimPod: HTTP /healthz æ¢æµ‹å°è¯•

Â  Â  Note right of VictimPod: å¥åº·æ£€æŸ¥æ¥å£è¢«æš´éœ²



Â  Â  Kubelet->>VictimPod: å‘èµ· HTTPS probe è¯·æ±‚

Â  Â  VictimPod-->>Kubelet: è¿”å› 200 OK + TLS åŠ å¯†



Â  Â  MaliciousPod--xVictimPod: HTTPS æ— æ³•æ¡æ‰‹
```

å¦‚æœä½ ä»¬æœªæ¥æœ‰è¿›ä¸€æ­¥çš„å®‰å…¨è¦æ±‚ï¼Œæ¯”å¦‚æœåŠ¡ä¹‹é—´åªå…è®¸é€šè¿‡ Sidecar é€šä¿¡ã€æˆ– Zero Trust æ¶æ„æ¥å…¥ï¼Œé‚£ä¹ˆä½¿ç”¨ HTTPS å¥åº·æ£€æŸ¥æ˜¯å‘æ›´å¼ºéš”ç¦»èƒ½åŠ›çš„ä¸€æ­¥è¿‡æ¸¡ã€‚

å¦‚éœ€ï¼Œæˆ‘ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥å¸®ä½ å‡ºä¸€ä»½å®‰å…¨ç­–ç•¥åŸºçº¿æ–‡æ¡£ï¼Œæ¶µç›– namespace å…±äº«åœºæ™¯ä¸‹çš„é€šä¿¡çº¦æŸã€è®¤è¯ç­–ç•¥ç­‰ã€‚

ç»§ç»­è¡¥å……ï¼š

ğŸ›¡ï¸ è¿›é˜¶å¢å¼ºå»ºè®®ï¼ˆç»­ï¼‰

|                                       |                                                                                                                                                                     |
| ------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| å®‰å…¨æªæ–½                              | è¯´æ˜                                                                                                                                                                |
| ğŸ“Œ NetworkPolicy é™åˆ¶æ¢æµ‹æ¥æº         | æ˜ç¡®å£°æ˜ï¼šåªæœ‰ kubelet æ‰€åœ¨èŠ‚ç‚¹çš„ IP èŒƒå›´èƒ½è®¿é—® Pod çš„ probe ç«¯å£ï¼Œä¾‹å¦‚ 10256/Node IPã€‚è¿™æ ·å³ä½¿æ˜¯ HTTPï¼Œä¹Ÿèƒ½ä¸€å®šç¨‹åº¦é˜²æ­¢è¢« tenant é—´æ»¥ç”¨æ¢æµ‹ã€‚                      |
| ğŸ” ç»Ÿä¸€æ¢é’ˆè·¯å¾„å¹¶åŠ éªŒè¯å¤´             | ä½¿ç”¨ /internal-healthzã€/liveness-check ç­‰éé»˜è®¤è·¯å¾„ï¼Œå¹¶åœ¨æœåŠ¡ç«¯æ ¡éªŒè‡ªå®šä¹‰ headerï¼Œä¾‹å¦‚ X-Probe-Token: abc123ï¼Œé˜²æ­¢æ™®é€šè¯·æ±‚è®¿é—®æ¢é’ˆè·¯å¾„ï¼ˆé€‚åˆ HTTP åœºæ™¯ä¸‹åšåŠ å›ºï¼‰ã€‚ |
| ğŸ” Istio / mTLS mesh æ¢é’ˆç»•è¡Œé…ç½®     | å¦‚æœä½ çš„æœåŠ¡å¼€å¯äº† mTLS Sidecarï¼Œç¡®ä¿å¥åº·æ£€æŸ¥ç«¯å£è¦ä¹ˆä½¿ç”¨ HTTPSï¼Œè¦ä¹ˆé…ç½® passthrough/exclude ä»¥è®© kubelet èƒ½è®¿é—®ã€‚                                                 |
| ğŸ“˜ ä½¿ç”¨ startupProbe é™åˆ¶åˆæœŸå¤±è´¥è¡Œä¸º | é¿å…åœ¨åˆå§‹åŒ–é˜¶æ®µæš´éœ²è¿‡å¤šé”™è¯¯ç»†èŠ‚ï¼Œæé«˜å®‰å…¨æ€§ã€‚ä¾‹å¦‚åˆæœŸä½¿ç”¨ HTTPS ä¸”è¿”å› minimal å“åº”ï¼Œä¸è¿”å›æ ˆä¿¡æ¯æˆ–æ•æ„Ÿé…ç½®çŠ¶æ€ã€‚                                                  |

âœ… å…¨é¢ HTTPS å¥åº·æ£€æŸ¥æ¶æ„å»ºè®®

é€‚ç”¨åœºæ™¯ï¼š

- å¤šç”¨æˆ·å…±äº« namespaceï¼ˆä½†æš‚æœªå¯ç”¨å…¨ç½‘éš”ç¦»ï¼‰
- æœåŠ¡æ¶æ„é€æ­¥å‘ Zero Trust æ¼”è¿›
- æœ‰ä¸€å®šè¯ä¹¦ç®¡ç†èƒ½åŠ›æˆ–è®¡åˆ’å¼•å…¥ SPIREã€Istioã€Consul Connect ç­‰å·¥å…·
```mermaid
graph TD;

subgraph namespace-a

A1[ç”¨æˆ· A çš„ Pod] -->|HTTPS 443| Liveness1[å¥åº·æ£€æŸ¥æ¥å£]

A2[ç”¨æˆ· B çš„ Pod] -->|âŒ æ‹’ç»| Liveness1

end

subgraph kubelet

K1[èŠ‚ç‚¹ Kubelet Agent] -->|âœ” å…è®¸| Liveness1

end

subgraph NetworkPolicy

Rule1[å…è®¸ Node IP æ®µè®¿é—®ç«¯å£ 8443]

Rule2[æ‹’ç» namespace å†…å…¶ä»– Pod è®¿é—®]

end
```


âœ… ç¤ºä¾‹å¼ºåŒ–é…ç½®ç‰‡æ®µï¼ˆå¸¦ token æ ¡éªŒï¼‰

å‡è®¾æœåŠ¡ç›‘å¬ 8443ï¼Œä½¿ç”¨ HTTPS å¹¶éªŒè¯ Header ä¸­çš„ Token
```yaml
livenessProbe:

httpGet:

scheme: HTTPS

path: /internal-healthz

port: 8443

httpHeaders:

- name: X-Probe-Token

value: abc123securetoken

initialDelaySeconds: 10

timeoutSeconds: 2

periodSeconds: 10
```

åº”ç”¨å®¹å™¨ä¸­æ£€æŸ¥ headerï¼š
```java
@GetMapping("/internal-healthz")

public ResponseEntity<String> probe(HttpServletRequest request) {

String token = request.getHeader("X-Probe-Token");

if (!"abc123securetoken".equals(token)) {

return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();

}

return ResponseEntity.ok("ok");

}
```
ğŸ¯ æ€»ç»“ï¼šå¯ç”¨ HTTPS å¥åº·æ£€æŸ¥çš„å®æˆ˜ä»·å€¼


|           |                                                              |
| --------- | ------------------------------------------------------------ |
| åˆ†ç±»      | ä»·å€¼                                                         |
| ğŸ” å®‰å…¨æ€§ | é˜²æ­¢è¢«å—…æ¢ã€ä¼ªé€ å’Œæ»¥ç”¨ã€‚é¿å…æ•æ„ŸçŠ¶æ€ä¿¡æ¯æ³„éœ²ã€‚               |
| ğŸ§± éš”ç¦»æ€§ | é™ä½åŒ namespace ä¸‹æ¨ªå‘æ”»å‡»é£é™©ã€‚é…åˆ NetworkPolicy æ›´æœ‰æ•ˆã€‚ |
| âš™ï¸ ä¸€è‡´æ€§ | ä¸ç”Ÿäº§ç¯å¢ƒç»Ÿä¸€ä¸º HTTPS é€šä¿¡ï¼Œå‡å°‘è°ƒè¯•ã€éƒ¨ç½²å·®å¼‚ã€‚            |
| ğŸ“Š åˆè§„æ€§ | æ»¡è¶³é›¶ä¿¡ä»»ã€å®‰å…¨å®¡è®¡ã€é›¶æ˜æ–‡é€šä¿¡ç­‰æ ‡å‡†è¦æ±‚ã€‚                 |


å¦‚æœä½ è®¡åˆ’è¿›ä¸€æ­¥éš”ç¦»æˆ–å¤šå›¢é˜Ÿå…±ç”¨åŒä¸€ namespaceï¼Œæˆ‘å¯ä»¥å¸®ä½ å‡ºä¸€ä»½æ›´å®Œæ•´çš„å®‰å…¨ç¡¬åŒ– checklistï¼Œæ¶µç›–ï¼š

- Pod é—´é€šä¿¡éš”ç¦»ç­–ç•¥ï¼ˆåŒ…æ‹¬ probe çš„ç‰¹æ®Šè§„åˆ™ï¼‰
- æ¢é’ˆè·¯å¾„é˜²æ»¥ç”¨è§„èŒƒ
- kubelet + probe ç‰¹æ®Šè®¿é—®éœ€æ±‚è§„åˆ’ï¼ˆå¦‚æ˜¯å¦éœ€ç»•è¿‡ mTLSï¼‰
- å®‰å…¨å®¡è®¡æ—¥å¿—é‡‡é›†å»ºè®®

æ˜¯å¦éœ€è¦ï¼Ÿæˆ‘å¯ä»¥åŸºäºä½ å½“å‰ GKE æˆ– GCE æ¶æ„ç»™å‡ºç»†åŒ–å»ºè®®ã€‚
