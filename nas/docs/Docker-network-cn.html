<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Network CN Preview</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
        }
        @media (max-width: 767px) {
            body {
                padding: 15px;
            }
        }
        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
        }
    </style>
</head>
<body>
    <div id="content" class="markdown-body"></div>
    <div id="raw-markdown" style="display: none;">

- [QNAP NAS ä¸Šçš„ Docker è¿›ç¨‹ä¸Žç½‘ç»œè¯¦è§£](#qnap-nas-ä¸Šçš„-docker-è¿›ç¨‹ä¸Žç½‘ç»œè¯¦è§£)
  - [Summary](#summary)
  - [1. æž¶æž„æ¦‚è§ˆï¼šQNAP Container Station](#1-æž¶æž„æ¦‚è§ˆqnap-container-station)
  - [2. `docker pull` æµç¨‹ï¼ˆé•œåƒèŽ·å–ï¼‰](#2-docker-pull-æµç¨‹é•œåƒèŽ·å–)
    - [ðŸ”´ å…³é”®ç‚¹ï¼šä¸º `docker pull` è®¾ç½®ä»£ç†](#-å…³é”®ç‚¹ä¸º-docker-pull-è®¾ç½®ä»£ç†)
  - [3. `docker run` æµç¨‹ï¼ˆå®¹å™¨æ‰§è¡Œï¼‰](#3-docker-run-æµç¨‹å®¹å™¨æ‰§è¡Œ)
    - [ðŸ”´ å…³é”®ç‚¹ï¼šä¸ºå®¹å™¨ (K3s) è®¾ç½®ä»£ç†](#-å…³é”®ç‚¹ä¸ºå®¹å™¨-k3s-è®¾ç½®ä»£ç†)
  - [4. ä¾èµ–å…³ç³»ä¸Žæµç¨‹æ€»ç»“](#4-ä¾èµ–å…³ç³»ä¸Žæµç¨‹æ€»ç»“)
  - [5. QNAP ç‰¹å®šè·¯å¾„åˆ†æž](#5-qnap-ç‰¹å®šè·¯å¾„åˆ†æž)
  - [6. å›¾è§£ï¼šç½‘ç»œæµç¨‹](#6-å›¾è§£ç½‘ç»œæµç¨‹)

# QNAP NAS ä¸Šçš„ Docker è¿›ç¨‹ä¸Žç½‘ç»œè¯¦è§£

æœ¬æ–‡æ¡£æ·±å…¥æŽ¢è®¨äº† QNAP NAS ä¸Š Docker çš„æ‰§è¡Œæµç¨‹ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹ `rancher/k3s` åœºæ™¯ã€‚å®ƒé˜æ˜Žäº†åœ¨ä¸åŒé˜¶æ®µï¼ˆé•œåƒæ‹‰å– vs å®¹å™¨è¿è¡Œï¼‰æ‰€éœ€çš„ç½‘ç»œè·¯å¾„ã€ä¾èµ–å…³ç³»è§£æžä»¥åŠä»£ç†é…ç½®ã€‚

## Summary

**ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦**ï¼šåœ¨ SSH ä¼šè¯ä¸­è®¾ç½® `export HTTP_PROXY` ä¸ä¼šå½±å“ `docker pull`ï¼Œå› ä¸ºï¼š
- Docker CLI åªæ˜¯é€šè¿‡ Unix å¥—æŽ¥å­—å‘å®ˆæŠ¤è¿›ç¨‹å‘é€ API è¯·æ±‚
- å®ˆæŠ¤è¿›ç¨‹ä½œä¸ºç‹¬ç«‹çš„ç³»ç»ŸæœåŠ¡è¿è¡Œï¼Œæœ‰è‡ªå·±çš„çŽ¯å¢ƒ
- åªæœ‰å®ˆæŠ¤è¿›ç¨‹çš„çŽ¯å¢ƒå˜é‡æ‰å¯¹é•œåƒæ‹‰å–æœ‰æ•ˆ


**é˜¶æ®µ 2ï¼šK3s æ‹‰å–å…¶å†…éƒ¨é•œåƒ**
```bash
# éœ€è¦ï¼šä¼ é€’ç»™å®¹å™¨çš„çŽ¯å¢ƒå˜é‡
docker run -e HTTP_PROXY="..." -e HTTPS_PROXY="..." rancher/k3s
```

**ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªé˜¶æ®µï¼Ÿ**
- K3s æœ¬èº«æ˜¯ä¸€ä¸ªåŒ…å« containerd çš„ Kubernetes å‘è¡Œç‰ˆ
- å½“ K3s å¯åŠ¨æ—¶ï¼Œå®ƒéœ€è¦æ‹‰å–ç³»ç»Ÿé•œåƒï¼ˆpauseã€corednsã€traefikï¼‰
- è¿™äº›æ‹‰å–æ“ä½œå‘ç”Ÿåœ¨å®¹å™¨å†…éƒ¨ï¼Œä½¿ç”¨ containerdï¼ˆä¸æ˜¯ Docker daemonï¼‰
- å› æ­¤ï¼Œå®¹å™¨è¿›ç¨‹éœ€è¦è‡ªå·±çš„ä»£ç†é…ç½®

**éªŒè¯**ï¼šè¿™æ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚è®¸å¤šç”¨æˆ·å¿½ç•¥äº†è¿™ä¸€ç‚¹ï¼Œå¹¶ä¸”ç–‘æƒ‘ä¸ºä»€ä¹ˆå³ä½¿é…ç½®äº† Docker daemon ä»£ç†ï¼ŒK3s pods ä»ç„¶ä¼šå‡ºçŽ° `ImagePullBackOff` é”™è¯¯ã€‚


## 1. æž¶æž„æ¦‚è§ˆï¼šQNAP Container Station

åœ¨ QNAP NAS ä¸Šï¼Œ**Container Station** æä¾›äº† Docker çŽ¯å¢ƒã€‚å®ƒä¸Žæ ‡å‡†çš„ Linux å®‰è£…ç•¥æœ‰ä¸åŒï¼š

*   **Docker å®¢æˆ·ç«¯ (`docker` CLI)**:
    *   ä½ç½®: `/share/CACHEDEV1_DATA/.qpkg/container-station/bin/docker`
    *   è§’è‰²: å‘é€å‘½ä»¤ï¼ˆå¦‚ `run`, `pull`ï¼‰ç»™ Docker å®ˆæŠ¤è¿›ç¨‹ (Daemon)ã€‚
    *   ç½‘ç»œ: å®ƒæœ¬èº«**ä¸**æ‰§è¡Œç½‘ç»œæ“ä½œï¼ˆé™¤äº† `build` ä¸Šä¸‹æ–‡ä¼ è¾“ï¼‰ã€‚
*   **Docker å®ˆæŠ¤è¿›ç¨‹ (`dockerd`)**:
    *   è§’è‰²: åŽå°è¿›ç¨‹ï¼Œè´Ÿè´£ç®¡ç†å®¹å™¨ã€é•œåƒå’Œç½‘ç»œã€‚**å®ƒæ˜¯æ‰§è¡Œå®žé™… `docker pull` çš„ç»„ä»¶ã€‚**
    *   ç½‘ç»œ: ç›´æŽ¥ä½¿ç”¨ NAS çš„å®¿ä¸»æœºç½‘ç»œè¿žæŽ¥ã€‚
*   **å®¹å™¨ (ä¾‹å¦‚ K3s)**:
    *   è§’è‰²: å®žé™…è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚
    *   ç½‘ç»œ: å–å†³äºŽæ‰€é€‰çš„ `--network` æ¨¡å¼ã€‚

---

## 2. `docker pull` æµç¨‹ï¼ˆé•œåƒèŽ·å–ï¼‰

å½“ä½ è¿è¡Œ `docker pull rancher/k3s:v1.21.1-k3s1` æ—¶ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

1.  **å‘½ä»¤**: ä½ åœ¨ Shell ä¸­æ‰§è¡Œè¯¥å‘½ä»¤ã€‚
2.  **è¯·æ±‚**: Docker å®¢æˆ·ç«¯é€šè¿‡ Unix å¥—æŽ¥å­— (`/var/run/docker.sock`) å‘ Docker å®ˆæŠ¤è¿›ç¨‹å‘é€ API è¯·æ±‚ã€‚
3.  **è§£æž**:
    *   å®ˆæŠ¤è¿›ç¨‹æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ˜¯å¦æœ‰è¯¥é•œåƒã€‚
    *   å¦‚æžœç¼ºå¤±ï¼Œå®ƒä¼šæŸ¥è¯¢é…ç½®çš„é•œåƒä»“åº“ï¼ˆé»˜è®¤æ˜¯ Docker Hub `index.docker.io`ï¼‰ã€‚
4.  **ä¸‹è½½**: å®ˆæŠ¤è¿›ç¨‹ä¸‹è½½é•œåƒå±‚ã€‚
    *   **ä¾èµ–å…³ç³»**: å¦‚æžœæŸä¸ªå±‚ä¸‹è½½å¤±è´¥ï¼ˆä¾‹å¦‚ç½‘ç»œè¶…æ—¶ã€è¢«å¢™ï¼‰ï¼Œæ•´ä¸ªæ‹‰å–è¿‡ç¨‹å°±ä¼šå¤±è´¥ã€‚
    *   **ç½‘ç»œè·¯å¾„**: æµé‡èµ°å‘ä¸º **NAS å®¿ä¸»æœºæŽ¥å£** -> **ç½‘å…³** -> **äº’è”ç½‘**ã€‚
    *   **ä»£ç†**: å®ˆæŠ¤è¿›ç¨‹**ä¸ä¼š**è‡ªåŠ¨ä½¿ç”¨ QNAP çš„ç³»ç»Ÿä»£ç†è®¾ç½®ã€‚å®ƒä¹Ÿä¼šå¿½ç•¥ä½ åœ¨ SSH ä¼šè¯ä¸­è®¾ç½®çš„ `export HTTP_PROXY` ç­‰ Shell çŽ¯å¢ƒå˜é‡ã€‚

### ðŸ”´ å…³é”®ç‚¹ï¼šä¸º `docker pull` è®¾ç½®ä»£ç†
è¦è®© `docker pull` åœ¨ä»£ç†åŽå·¥ä½œï¼Œä½ å¿…é¡»é…ç½® **Docker å®ˆæŠ¤è¿›ç¨‹ (Docker Daemon)** æœ¬èº«ã€‚

*   **æ ‡å‡† Linux**: ç¼–è¾‘ `/etc/systemd/system/docker.service.d/http-proxy.conf`ã€‚
*   **QNAP Container Station**: ç”±äºŽ QNAP ç»å¸¸é‡ç½®ç³»ç»Ÿæ–‡ä»¶æˆ–ç¼ºä¹æ ‡å‡†çš„ systemd è·¯å¾„ï¼Œä½ é€šå¸¸éœ€è¦ä¿®æ”¹å¯åŠ¨è„šæœ¬æˆ–å°†çŽ¯å¢ƒå˜é‡æ³¨å…¥åˆ°å®ˆæŠ¤è¿›ç¨‹çš„å¯åŠ¨åºåˆ—ä¸­ã€‚
    *   *è¯·å‚è€ƒæœ¬ç›®å½•ä¸‹çš„ `docker-proxy.md`ï¼Œäº†è§£æ¶‰åŠ `docker.service.d` æˆ– `daemon.json` çš„ QNAP ä¸“ç”¨ä¿®æ”¹æ–¹æ³•ã€‚*

---

## 3. `docker run` æµç¨‹ï¼ˆå®¹å™¨æ‰§è¡Œï¼‰

å½“ä½ è¿è¡Œ `docker run ... rancher/k3s:v1.21.1-k3s1` æ—¶ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

1.  **å¯åŠ¨**: å®ˆæŠ¤è¿›ç¨‹åˆ›å»ºå®¹å™¨çŽ¯å¢ƒï¼ˆå‘½åç©ºé—´ã€cgroupsï¼‰ã€‚
2.  **ç½‘ç»œæ¨¡å¼**:
    *   **`--network host` (NAS ä¸Šè¿è¡Œ K3s æŽ¨è)**:
        *   å®¹å™¨ä¸Ž NAS å…±äº«**å®Œå…¨ç›¸åŒçš„ç½‘ç»œæ ˆ**ã€‚
        *   IP åœ°å€: ä¸Ž NAS IP ç›¸åŒï¼ˆä¾‹å¦‚ `192.168.31.88`ï¼‰ã€‚
        *   ç«¯å£: K3s ç›´æŽ¥ç›‘å¬ NAS çš„ç«¯å£ï¼ˆ6443 ç­‰ï¼‰ã€‚ä¸éœ€è¦ NAT è½¬æ¢ã€‚
        *   **æµé‡**: K3s çš„å‡ºç«™æµé‡çœ‹èµ·æ¥å’Œ NAS æ“ä½œç³»ç»Ÿæœ¬èº«çš„æµé‡å®Œå…¨ä¸€æ ·ã€‚
    *   **`--network bridge` (é»˜è®¤)**:
        *   å®¹å™¨èŽ·å¾—ä¸€ä¸ªå†…éƒ¨ IPï¼ˆä¾‹å¦‚ `172.17.0.2`ï¼‰ã€‚
        *   æµé‡é€šè¿‡ NAS IP è¿›è¡Œ NAT è½¬å‘ã€‚
        *   éœ€è¦ `-p` ç«¯å£æ˜ å°„ã€‚

### ðŸ”´ å…³é”®ç‚¹ï¼šä¸ºå®¹å™¨ (K3s) è®¾ç½®ä»£ç†
å³ä½¿å®ˆæŠ¤è¿›ç¨‹å·²ç»é…ç½®äº†ä»£ç†æ¥*æ‹‰å–*åŸºç¡€é•œåƒï¼Œ**è¿è¡Œä¸­çš„å®¹å™¨**å¹¶ä¸ä¼šè‡ªåŠ¨ç»§æ‰¿è¿™ä¸ªä»£ç†é…ç½®ã€‚

**åœºæ™¯**: K3s å¯åŠ¨ã€‚å®ƒéœ€è¦ä»Ž `k8s.gcr.io` æˆ– `docker.io` ç­‰ä»“åº“æ‹‰å–å†…éƒ¨é•œåƒï¼ˆsandbox `pause`, `coredns`, `traefik`ï¼‰ã€‚
*   **å¦‚æžœç¼ºå°‘ä»£ç†**: K3s å°†æ— æ³•æ‹‰å–è¿™äº›å†…éƒ¨é•œåƒï¼Œå¯¼è‡´ç³»ç»Ÿ Pod å‡ºçŽ° `ImagePullBackOff` é”™è¯¯ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: ä½ å¿…é¡»åœ¨è¿è¡Œæ—¶å°†ä»£ç†å˜é‡**ä¼ é€’è¿›å®¹å™¨**ã€‚

```bash
docker run -d --name k3s \
  --network host \
  -e HTTP_PROXY="http://192.168.31.198:7222" \
  -e HTTPS_PROXY="http://192.168.31.198:7222" \
  -e NO_PROXY="localhost,127.0.0.1,192.168.0.0/16,10.0.0.0/8" \
  rancher/k3s:v1.21.1-k3s1 server
```

---

## 4. ä¾èµ–å…³ç³»ä¸Žæµç¨‹æ€»ç»“

| åŠ¨ä½œ | è´Ÿè´£ç»„ä»¶ | ç½‘ç»œèº«ä»½ | ä»£ç†é…ç½®ä½ç½® |
| :--- | :--- | :--- | :--- |
| **`docker pull`** | **Docker Daemon** (`dockerd`) | NAS å®¿ä¸»æœº IP | å®ˆæŠ¤è¿›ç¨‹é…ç½® (`daemon.json` æˆ– `systemd` env) |
| **`docker run`** | **Docker Client** (`docker`) | N/A (API è°ƒç”¨) | Shell Env (ä»…å½±å“å®¢æˆ·ç«¯-æœåŠ¡å™¨é€šä¿¡ï¼Œæžå°‘éœ€è¦) |
| **K3s å¯åŠ¨** | **å®¹å™¨è¿›ç¨‹** (k3s) | NAS å®¿ä¸»æœº IP (å¦‚æžœç”¨ `--net host`) | **`docker run` ä¸­çš„ `-e HTTP_PROXY` æ ‡å¿—** |
| **K3s æ‹‰å–é•œåƒ** | **Containerd** (K3s å†…éƒ¨) | NAS å®¿ä¸»æœº IP (å¦‚æžœç”¨ `--net host`) | ç»§æ‰¿è‡ª K3s å®¹å™¨çš„çŽ¯å¢ƒå˜é‡ (`-e` æ ‡å¿—) |

## 5. QNAP ç‰¹å®šè·¯å¾„åˆ†æž

ä½ æåˆ°äº†è·¯å¾„ï¼š`/share/CACHEDEV1_DATA/.qpkg/container-station/bin/docker`

*   **åœ¨è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸Šè®¾ç½®ä»£ç†**:
    *   åœ¨è¿è¡Œæ­¤äºŒè¿›åˆ¶æ–‡ä»¶ä¹‹å‰è¿è¡Œ `export HTTP_PROXY=...` **ä»…**å½±å“å®¢æˆ·ç«¯ã€‚
    *   å®ƒ**ä¸ä¼š**å¸®åŠ© `docker pull`ï¼ˆå› ä¸ºæ˜¯å®ˆæŠ¤è¿›ç¨‹åœ¨å¹²æ´»ï¼‰ã€‚
    *   å®ƒ**ä¸ä¼š**å¸®åŠ©å®¹å™¨ï¼ˆé™¤éžä½ æ˜¾å¼ä¼ é€’ `-e`ï¼‰ã€‚

*   **QNAP çš„æ­£ç¡®ç­–ç•¥**:
    1.  **æ‹‰å–é•œåƒ**: é…ç½®å®ˆæŠ¤è¿›ç¨‹ï¼ˆå…¨å±€è®¾ç½®ï¼‰ã€‚
    2.  **è¿è¡Œ K3s**: åœ¨ä½ çš„ `docker run` å‘½ä»¤ä¸­ä¼ é€’ `-e HTTP_PROXY` å‚æ•°ã€‚è¿™ç¡®ä¿ K3s å¯ä»¥è¿žæŽ¥äº’è”ç½‘ä»¥èŽ·å–å…¶ä¾èµ–é¡¹ã€‚

## 6. å›¾è§£ï¼šç½‘ç»œæµç¨‹

```mermaid
graph TD
    subgraph NAS_Host [QNAP NAS Host]
        Client[Docker Client CLI]
        Daemon[Docker Daemon Service]
        
        subgraph Container_K3s ["K3s Container (--net host)"]
            K3s_Process[K3s Server]
            Containerd[Internal Containerd]
        end
    end

    Internet[Internet / Registry]
    Proxy["Proxy Server (e.g., Mac/Loon)"]

    %% Flows
    Client -- "1. Command (run/pull)" --> Daemon
    Daemon -- "2. Pull Base Image (Needs Daemon Proxy)" --> Proxy
    Proxy -.-> Internet
    
    Daemon -- "3. Start Container" --> K3s_Process
    
    K3s_Process -- "4. Pull Sandbox/CoreDNS (Needs -e Proxy)" --> Containerd
    Containerd -- "Traffic via Host Interface" --> Proxy
```
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var rawMarkdown = document.getElementById('raw-markdown').innerText;
            var contentDiv = document.getElementById('content');
            
            // Configure marked
            marked.setOptions({
                highlight: function(code, lang) {
                    return code;
                }
            });

            // Render markdown
            contentDiv.innerHTML = marked.parse(rawMarkdown);

            // Initialize mermaid
            mermaid.initialize({ startOnLoad: true });
            
            // Find mermaid code blocks and render them
            var mermaidBlocks = document.querySelectorAll('.language-mermaid');
            mermaidBlocks.forEach(function(block, index) {
                var graphDefinition = block.innerText;
                var insertSvg = function(svgCode, bindFunctions) {
                    var div = document.createElement('div');
                    div.innerHTML = svgCode;
                    block.parentNode.replaceWith(div);
                };
                mermaid.render('mermaidGraph' + index, graphDefinition).then(function(result) {
                    insertSvg(result.svg);
                });
            });
        });
    </script>
</body>
</html>
