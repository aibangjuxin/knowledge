# Docker 容器备份与迁移指南 (k3s)

本文档记录了如何获取运行中容器的启动参数、备份当前状态以及重启并配置代理的完整流程。

## 1. 获取运行中容器的启动参数

在停止容器前，必须拿到其原始启动命令，否则无法完全恢复网络、挂载和环境变量。

### 方法 A：使用 `runlike` (推荐，全自动)
最简单的方法是使用 `runlike` 镜像，它可以根据现有容器生成 `docker run` 命令。
- assaflavie/runlike 这是一个镜像文件需要先下载到 NAS 上
```bash
# 获取 1213af7b16dc (qnap-k3s) 的启动参数
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock assaflavie/runlike 1213af7b16dc

sh-3.2# docker run --rm -v /var/run/docker.sock:/var/run/docker.sock assaflavie/runlike 1213af7b16dc  
docker run --name=qnap-k3s --hostname=qnap-k3s-Q21CA01210 --mac-address=02:42:0a:00:03:08 --volume /share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/var/lib/kubelet:/var/lib/kubelet --volume /share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/var/lib/rancher/k3s:/var/lib/rancher/k3s --volume /share/CACHEDEV1_DATA/.qpkg/container-station/var/log/container-station/k3s:/var/log --volume /share/CACHEDEV1_DATA/.qpkg/container-station/etc/k3s:/etc/k3s --volume /share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/etc/rancher:/etc/rancher --volume /share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/var/lib/cni:/var/lib/cni --network=bridge --privileged -p 61000:61000 -p 61001:61001 -p 61002:61002 -p 61003:61003 -p 61004:61004 -p 61005:61005 -p 61006:61006 -p 61007:61007 -p 61008:61008 -p 61009:61009 -p 61010:61010 -p 61011:61011 -p 61012:61012 -p 61013:61013 -p 61014:61014 -p 61015:61015 -p 61016:61016 -p 61017:61017 -p 61018:61018 -p 61019:61019 -p 61020:61020 -p 61021:61021 -p 61022:61022 -p 61023:61023 -p 61024:61024 -p 61025:61025 -p 61026:61026 -p 61027:61027 -p 61028:61028 -p 61029:61029 -p 61030:61030 -p 61031:61031 -p 61032:61032 -p 61033:61033 -p 61034:61034 -p 61035:61035 -p 61036:61036 -p 61037:61037 -p 61038:61038 -p 61039:61039 -p 61040:61040 -p 61041:61041 -p 61042:61042 -p 61043:61043 -p 61044:61044 -p 61045:61045 -p 61046:61046 -p 61047:61047 -p 61048:61048 -p 61049:61049 -p 61050:61050 -p 61051:61051 -p 61052:61052 -p 61053:61053 -p 61054:61054 -p 61055:61055 -p 61056:61056 -p 61057:61057 -p 61058:61058 -p 61059:61059 -p 61060:61060 -p 61061:61061 -p 61062:61062 -p 61063:61063 -p 61064:61064 -p 61065:61065 -p 61066:61066 -p 61067:61067 -p 61068:61068 -p 61069:61069 -p 61070:61070 -p 61071:61071 -p 61072:61072 -p 61073:61073 -p 61074:61074 -p 61075:61075 -p 61076:61076 -p 61077:61077 -p 61078:61078 -p 61079:61079 -p 61080:61080 -p 61081:61081 -p 61082:61082 -p 61083:61083 -p 61084:61084 -p 61085:61085 -p 61086:61086 -p 61087:61087 -p 61088:61088 -p 61089:61089 -p 61090:61090 -p 61091:61091 -p 61092:61092 -p 61093:61093 -p 61094:61094 -p 61095:61095 -p 61096:61096 -p 61097:61097 -p 61098:61098 -p 61099:61099 -p 61100:61100 -p 61101:61101 -p 61102:61102 -p 61103:61103 -p 61104:61104 -p 61105:61105 -p 61106:61106 -p 61107:61107 -p 61108:61108 -p 61109:61109 -p 61110:61110 -p 61111:61111 -p 61112:61112 -p 61113:61113 -p 61114:61114 -p 61115:61115 -p 61116:61116 -p 61117:61117 -p 61118:61118 -p 61119:61119 -p 61120:61120 -p 61121:61121 -p 61122:61122 -p 61123:61123 -p 61124:61124 -p 61125:61125 -p 61126:61126 -p 61127:61127 -p 61128:61128 -p 61129:61129 -p 61130:61130 -p 61131:61131 -p 61132:61132 -p 61133:61133 -p 61134:61134 -p 61135:61135 -p 61136:61136 -p 61137:61137 -p 61138:61138 -p 61139:61139 -p 61140:61140 -p 61141:61141 -p 61142:61142 -p 61143:61143 -p 61144:61144 -p 61145:61145 -p 61146:61146 -p 61147:61147 -p 61148:61148 -p 61149:61149 -p 61150:61150 -p 61151:61151 -p 61152:61152 -p 61153:61153 -p 61154:61154 -p 61155:61155 -p 61156:61156 -p 61157:61157 -p 61158:61158 -p 61159:61159 -p 61160:61160 -p 61161:61161 -p 61162:61162 -p 61163:61163 -p 61164:61164 -p 61165:61165 -p 61166:61166 -p 61167:61167 -p 61168:61168 -p 61169:61169 -p 61170:61170 -p 61171:61171 -p 61172:61172 -p 61173:61173 -p 61174:61174 -p 61175:61175 -p 61176:61176 -p 61177:61177 -p 61178:61178 -p 61179:61179 -p 61180:61180 -p 61181:61181 -p 61182:61182 -p 61183:61183 -p 61184:61184 -p 61185:61185 -p 61186:61186 -p 61187:61187 -p 61188:61188 -p 61189:61189 -p 61190:61190 -p 61191:61191 -p 61192:61192 -p 61193:61193 -p 61194:61194 -p 61195:61195 -p 61196:61196 -p 61197:61197 -p 61198:61198 -p 61199:61199 -p 61200:61200 -p 61201:61201 -p 61202:61202 -p 61203:61203 -p 61204:61204 -p 61205:61205 -p 61206:61206 -p 61207:61207 -p 61208:61208 -p 61209:61209 -p 61210:61210 -p 61211:61211 -p 61212:61212 -p 61213:61213 -p 61214:61214 -p 61215:61215 -p 61216:61216 -p 61217:61217 -p 61218:61218 -p 61219:61219 -p 61220:61220 -p 61221:61221 -p 61222:61222 -p 61223:61223 -p 61224:61224 -p 61225:61225 -p 61226:61226 -p 61227:61227 -p 61228:61228 -p 61229:61229 -p 61230:61230 -p 61231:61231 -p 61232:61232 -p 61233:61233 -p 61234:61234 -p 61235:61235 -p 61236:61236 -p 61237:61237 -p 61238:61238 -p 61239:61239 -p 61240:61240 -p 61241:61241 -p 61242:61242 -p 61243:61243 -p 61244:61244 -p 61245:61245 -p 61246:61246 -p 61247:61247 -p 61248:61248 -p 61249:61249 -p 61250:61250 -p 61251:61251 -p 61252:61252 -p 61253:61253 -p 61254:61254 -p 61255:61255 -p 61256:61256 -p 61257:61257 -p 61258:61258 -p 61259:61259 -p 61260:61260 -p 61261:61261 -p 61262:61262 -p 61263:61263 -p 61264:61264 -p 61265:61265 -p 61266:61266 -p 61267:61267 -p 61268:61268 -p 61269:61269 -p 61270:61270 -p 61271:61271 -p 61272:61272 -p 61273:61273 -p 61274:61274 -p 61275:61275 -p 61276:61276 -p 61277:61277 -p 61278:61278 -p 61279:61279 -p 61280:61280 -p 61281:61281 -p 61282:61282 -p 61283:61283 -p 61284:61284 -p 61285:61285 -p 61286:61286 -p 61287:61287 -p 61288:61288 -p 61289:61289 -p 61290:61290 -p 61291:61291 -p 61292:61292 -p 61293:61293 -p 61294:61294 -p 61295:61295 -p 61296:61296 -p 61297:61297 -p 61298:61298 -p 61299:61299 -p 61300:61300 -p 61301:61301 -p 61302:61302 -p 61303:61303 -p 61304:61304 -p 61305:61305 -p 61306:61306 -p 61307:61307 -p 61308:61308 -p 61309:61309 -p 61310:61310 -p 61311:61311 -p 61312:61312 -p 61313:61313 -p 61314:61314 -p 61315:61315 -p 61316:61316 -p 61317:61317 -p 61318:61318 -p 61319:61319 -p 61320:61320 -p 61321:61321 -p 61322:61322 -p 61323:61323 -p 61324:61324 -p 61325:61325 -p 61326:61326 -p 61327:61327 -p 61328:61328 -p 61329:61329 -p 61330:61330 -p 61331:61331 -p 61332:61332 -p 61333:61333 -p 61334:61334 -p 61335:61335 -p 61336:61336 -p 61337:61337 -p 61338:61338 -p 61339:61339 -p 61340:61340 -p 61341:61341 -p 61342:61342 -p 61343:61343 -p 61344:61344 -p 61345:61345 -p 61346:61346 -p 61347:61347 -p 61348:61348 -p 61349:61349 -p 61350:61350 -p 61351:61351 -p 61352:61352 -p 61353:61353 -p 61354:61354 -p 61355:61355 -p 61356:61356 -p 61357:61357 -p 61358:61358 -p 61359:61359 -p 61360:61360 -p 61361:61361 -p 61362:61362 -p 61363:61363 -p 61364:61364 -p 61365:61365 -p 61366:61366 -p 61367:61367 -p 61368:61368 -p 61369:61369 -p 61370:61370 -p 61371:61371 -p 61372:61372 -p 61373:61373 -p 61374:61374 -p 61375:61375 -p 61376:61376 -p 61377:61377 -p 61378:61378 -p 61379:61379 -p 61380:61380 -p 61381:61381 -p 61382:61382 -p 61383:61383 -p 61384:61384 -p 61385:61385 -p 61386:61386 -p 61387:61387 -p 61388:61388 -p 61389:61389 -p 61390:61390 -p 61391:61391 -p 61392:61392 -p 61393:61393 -p 61394:61394 -p 61395:61395 -p 61396:61396 -p 61397:61397 -p 61398:61398 -p 61399:61399 -p 61400:61400 -p 61401:61401 -p 61402:61402 -p 61403:61403 -p 61404:61404 -p 61405:61405 -p 61406:61406 -p 61407:61407 -p 61408:61408 -p 61409:61409 -p 61410:61410 -p 61411:61411 -p 61412:61412 -p 61413:61413 -p 61414:61414 -p 61415:61415 -p 61416:61416 -p 61417:61417 -p 61418:61418 -p 61419:61419 -p 61420:61420 -p 61421:61421 -p 61422:61422 -p 61423:61423 -p 61424:61424 -p 61425:61425 -p 61426:61426 -p 61427:61427 -p 61428:61428 -p 61429:61429 -p 61430:61430 -p 61431:61431 -p 61432:61432 -p 61433:61433 -p 61434:61434 -p 61435:61435 -p 61436:61436 -p 61437:61437 -p 61438:61438 -p 61439:61439 -p 61440:61440 -p 61441:61441 -p 61442:61442 -p 61443:61443 -p 61444:61444 -p 61445:61445 -p 61446:61446 -p 61447:61447 -p 61448:61448 -p 61449:61449 -p 61450:61450 -p 61451:61451 -p 61452:61452 -p 61453:61453 -p 61454:61454 -p 61455:61455 -p 61456:61456 -p 61457:61457 -p 61458:61458 -p 61459:61459 -p 61460:61460 -p 61461:61461 -p 61462:61462 -p 61463:61463 -p 61464:61464 -p 61465:61465 -p 61466:61466 -p 61467:61467 -p 61468:61468 -p 61469:61469 -p 61470:61470 -p 61471:61471 -p 61472:61472 -p 61473:61473 -p 61474:61474 -p 61475:61475 -p 61476:61476 -p 61477:61477 -p 61478:61478 -p 61479:61479 -p 61480:61480 -p 61481:61481 -p 61482:61482 -p 61483:61483 -p 61484:61484 -p 61485:61485 -p 61486:61486 -p 61487:61487 -p 61488:61488 -p 61489:61489 -p 61490:61490 -p 61491:61491 -p 61492:61492 -p 61493:61493 -p 61494:61494 -p 61495:61495 -p 61496:61496 -p 61497:61497 -p 61498:61498 -p 61499:61499 -p 61500:61500 -p 61501:61501 -p 61502:61502 -p 61503:61503 -p 61504:61504 -p 61505:61505 -p 61506:61506 -p 61507:61507 -p 61508:61508 -p 61509:61509 -p 61510:61510 -p 61511:61511 -p 61512:61512 -p 61513:61513 -p 61514:61514 -p 61515:61515 -p 61516:61516 -p 61517:61517 -p 61518:61518 -p 61519:61519 -p 61520:61520 -p 61521:61521 -p 61522:61522 -p 61523:61523 -p 61524:61524 -p 61525:61525 -p 61526:61526 -p 61527:61527 -p 61528:61528 -p 61529:61529 -p 61530:61530 -p 61531:61531 -p 61532:61532 -p 61533:61533 -p 61534:61534 -p 61535:61535 -p 61536:61536 -p 61537:61537 -p 61538:61538 -p 61539:61539 -p 61540:61540 -p 61541:61541 -p 61542:61542 -p 61543:61543 -p 61544:61544 -p 61545:61545 -p 61546:61546 -p 61547:61547 -p 61548:61548 -p 61549:61549 -p 61550:61550 -p 61551:61551 -p 61552:61552 -p 61553:61553 -p 61554:61554 -p 61555:61555 -p 61556:61556 -p 61557:61557 -p 61558:61558 -p 61559:61559 -p 61560:61560 -p 61561:61561 -p 61562:61562 -p 61563:61563 -p 61564:61564 -p 61565:61565 -p 61566:61566 -p 61567:61567 -p 61568:61568 -p 61569:61569 -p 61570:61570 -p 61571:61571 -p 61572:61572 -p 61573:61573 -p 61574:61574 -p 61575:61575 -p 61576:61576 -p 61577:61577 -p 61578:61578 -p 61579:61579 -p 61580:61580 -p 61581:61581 -p 61582:61582 -p 61583:61583 -p 61584:61584 -p 61585:61585 -p 61586:61586 -p 61587:61587 -p 61588:61588 -p 61589:61589 -p 61590:61590 -p 61591:61591 -p 61592:61592 -p 61593:61593 -p 61594:61594 -p 61595:61595 -p 61596:61596 -p 61597:61597 -p 61598:61598 -p 61599:61599 -p 61600:61600 -p 61601:61601 -p 61602:61602 -p 61603:61603 -p 61604:61604 -p 61605:61605 -p 61606:61606 -p 61607:61607 -p 61608:61608 -p 61609:61609 -p 61610:61610 -p 61611:61611 -p 61612:61612 -p 61613:61613 -p 61614:61614 -p 61615:61615 -p 61616:61616 -p 61617:61617 -p 61618:61618 -p 61619:61619 -p 61620:61620 -p 61621:61621 -p 61622:61622 -p 61623:61623 -p 61624:61624 -p 61625:61625 -p 61626:61626 -p 61627:61627 -p 61628:61628 -p 61629:61629 -p 61630:61630 -p 61631:61631 -p 61632:61632 -p 61633:61633 -p 61634:61634 -p 61635:61635 -p 61636:61636 -p 61637:61637 -p 61638:61638 -p 61639:61639 -p 61640:61640 -p 61641:61641 -p 61642:61642 -p 61643:61643 -p 61644:61644 -p 61645:61645 -p 61646:61646 -p 61647:61647 -p 61648:61648 -p 61649:61649 -p 61650:61650 -p 61651:61651 -p 61652:61652 -p 61653:61653 -p 61654:61654 -p 61655:61655 -p 61656:61656 -p 61657:61657 -p 61658:61658 -p 61659:61659 -p 61660:61660 -p 61661:61661 -p 61662:61662 -p 61663:61663 -p 61664:61664 -p 61665:61665 -p 61666:61666 -p 61667:61667 -p 61668:61668 -p 61669:61669 -p 61670:61670 -p 61671:61671 -p 61672:61672 -p 61673:61673 -p 61674:61674 -p 61675:61675 -p 61676:61676 -p 61677:61677 -p 61678:61678 -p 61679:61679 -p 61680:61680 -p 61681:61681 -p 61682:61682 -p 61683:61683 -p 61684:61684 -p 61685:61685 -p 61686:61686 -p 61687:61687 -p 61688:61688 -p 61689:61689 -p 61690:61690 -p 61691:61691 -p 61692:61692 -p 61693:61693 -p 61694:61694 -p 61695:61695 -p 61696:61696 -p 61697:61697 -p 61698:61698 -p 61699:61699 -p 61700:61700 -p 61701:61701 -p 61702:61702 -p 61703:61703 -p 61704:61704 -p 61705:61705 -p 61706:61706 -p 61707:61707 -p 61708:61708 -p 61709:61709 -p 61710:61710 -p 61711:61711 -p 61712:61712 -p 61713:61713 -p 61714:61714 -p 61715:61715 -p 61716:61716 -p 61717:61717 -p 61718:61718 -p 61719:61719 -p 61720:61720 -p 61721:61721 -p 61722:61722 -p 61723:61723 -p 61724:61724 -p 61725:61725 -p 61726:61726 -p 61727:61727 -p 61728:61728 -p 61729:61729 -p 61730:61730 -p 61731:61731 -p 61732:61732 -p 61733:61733 -p 61734:61734 -p 61735:61735 -p 61736:61736 -p 61737:61737 -p 61738:61738 -p 61739:61739 -p 61740:61740 -p 61741:61741 -p 61742:61742 -p 61743:61743 -p 61744:61744 -p 61745:61745 -p 61746:61746 -p 61747:61747 -p 61748:61748 -p 61749:61749 -p 61750:61750 -p 61751:61751 -p 61752:61752 -p 61753:61753 -p 61754:61754 -p 61755:61755 -p 61756:61756 -p 61757:61757 -p 61758:61758 -p 61759:61759 -p 61760:61760 -p 61761:61761 -p 61762:61762 -p 61763:61763 -p 61764:61764 -p 61765:61765 -p 61766:61766 -p 61767:61767 -p 61768:61768 -p 61769:61769 -p 61770:61770 -p 61771:61771 -p 61772:61772 -p 61773:61773 -p 61774:61774 -p 61775:61775 -p 61776:61776 -p 61777:61777 -p 61778:61778 -p 61779:61779 -p 61780:61780 -p 61781:61781 -p 61782:61782 -p 61783:61783 -p 61784:61784 -p 61785:61785 -p 61786:61786 -p 61787:61787 -p 61788:61788 -p 61789:61789 -p 61790:61790 -p 61791:61791 -p 61792:61792 -p 61793:61793 -p 61794:61794 -p 61795:61795 -p 61796:61796 -p 61797:61797 -p 61798:61798 -p 61799:61799 -p 61800:61800 -p 61801:61801 -p 61802:61802 -p 61803:61803 -p 61804:61804 -p 61805:61805 -p 61806:61806 -p 61807:61807 -p 61808:61808 -p 61809:61809 -p 61810:61810 -p 61811:61811 -p 61812:61812 -p 61813:61813 -p 61814:61814 -p 61815:61815 -p 61816:61816 -p 61817:61817 -p 61818:61818 -p 61819:61819 -p 61820:61820 -p 61821:61821 -p 61822:61822 -p 61823:61823 -p 61824:61824 -p 61825:61825 -p 61826:61826 -p 61827:61827 -p 61828:61828 -p 61829:61829 -p 61830:61830 -p 61831:61831 -p 61832:61832 -p 61833:61833 -p 61834:61834 -p 61835:61835 -p 61836:61836 -p 61837:61837 -p 61838:61838 -p 61839:61839 -p 61840:61840 -p 61841:61841 -p 61842:61842 -p 61843:61843 -p 61844:61844 -p 61845:61845 -p 61846:61846 -p 61847:61847 -p 61848:61848 -p 61849:61849 -p 61850:61850 -p 61851:61851 -p 61852:61852 -p 61853:61853 -p 61854:61854 -p 61855:61855 -p 61856:61856 -p 61857:61857 -p 61858:61858 -p 61859:61859 -p 61860:61860 -p 61861:61861 -p 61862:61862 -p 61863:61863 -p 61864:61864 -p 61865:61865 -p 61866:61866 -p 61867:61867 -p 61868:61868 -p 61869:61869 -p 61870:61870 -p 61871:61871 -p 61872:61872 -p 61873:61873 -p 61874:61874 -p 61875:61875 -p 61876:61876 -p 61877:61877 -p 61878:61878 -p 61879:61879 -p 61880:61880 -p 61881:61881 -p 61882:61882 -p 61883:61883 -p 61884:61884 -p 61885:61885 -p 61886:61886 -p 61887:61887 -p 61888:61888 -p 61889:61889 -p 61890:61890 -p 61891:61891 -p 61892:61892 -p 61893:61893 -p 61894:61894 -p 61895:61895 -p 61896:61896 -p 61897:61897 -p 61898:61898 -p 61899:61899 -p 61900:61900 -p 61901:61901 -p 61902:61902 -p 61903:61903 -p 61904:61904 -p 61905:61905 -p 61906:61906 -p 61907:61907 -p 61908:61908 -p 61909:61909 -p 61910:61910 -p 61911:61911 -p 61912:61912 -p 61913:61913 -p 61914:61914 -p 61915:61915 -p 61916:61916 -p 61917:61917 -p 61918:61918 -p 61919:61919 -p 61920:61920 -p 61921:61921 -p 61922:61922 -p 61923:61923 -p 61924:61924 -p 61925:61925 -p 61926:61926 -p 61927:61927 -p 61928:61928 -p 61929:61929 -p 61930:61930 -p 61931:61931 -p 61932:61932 -p 61933:61933 -p 61934:61934 -p 61935:61935 -p 61936:61936 -p 61937:61937 -p 61938:61938 -p 61939:61939 -p 61940:61940 -p 61941:61941 -p 61942:61942 -p 61943:61943 -p 61944:61944 -p 61945:61945 -p 61946:61946 -p 61947:61947 -p 61948:61948 -p 61949:61949 -p 61950:61950 -p 61951:61951 -p 61952:61952 -p 61953:61953 -p 61954:61954 -p 61955:61955 -p 61956:61956 -p 61957:61957 -p 61958:61958 -p 61959:61959 -p 61960:61960 -p 61961:61961 -p 61962:61962 -p 61963:61963 -p 61964:61964 -p 61965:61965 -p 61966:61966 -p 61967:61967 -p 61968:61968 -p 61969:61969 -p 61970:61970 -p 61971:61971 -p 61972:61972 -p 61973:61973 -p 61974:61974 -p 61975:61975 -p 61976:61976 -p 61977:61977 -p 61978:61978 -p 61979:61979 -p 61980:61980 -p 61981:61981 -p 61982:61982 -p 61983:61983 -p 61984:61984 -p 61985:61985 -p 61986:61986 -p 61987:61987 -p 61988:61988 -p 61989:61989 -p 61990:61990 -p 61991:61991 -p 61992:61992 -p 61993:61993 -p 61994:61994 -p 61995:61995 -p 61996:61996 -p 61997:61997 -p 61998:61998 -p 61999:61999 -p 62000:62000 -p 6443:6443 --restart=on-failure:3 --label='com.qnap.kubernetes=True' --log-opt max-file=10 --log-opt max-size=10m --runtime=runc --detach=true rancher/k3s:v1.21.1-k3s1 server --config /etc/rancher/config.yaml
```

### 方法 B：手动分析 `docker inspect` (万能)
如果无法运行 `runlike`，可以通过过滤 JSON 获取核心配置：

```bash
# 查看环境变量
docker inspect 1213af7b16dc --format '{{json .Config.Env}}' | jq

[
  "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/bin/aux",
  "CRI_CONFIG_FILE=/var/lib/rancher/k3s/agent/etc/crictl.yaml"
]

# 查看挂载卷 (重要：确保数据持久化路径)
docker inspect 1213af7b16dc --format '{{json .Mounts}}' | jq


[
  {
    "Type": "bind",
    "Source": "/share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/var/lib/kubelet",
    "Destination": "/var/lib/kubelet",
    "Mode": "",
    "RW": true,
    "Propagation": "rprivate"
  },
  {
    "Type": "bind",
    "Source": "/share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/var/lib/rancher/k3s",
    "Destination": "/var/lib/rancher/k3s",
    "Mode": "",
    "RW": true,
    "Propagation": "rprivate"
  },
  {
    "Type": "bind",
    "Source": "/share/CACHEDEV1_DATA/.qpkg/container-station/var/log/container-station/k3s",
    "Destination": "/var/log",
    "Mode": "",
    "RW": true,
    "Propagation": "rprivate"
  },
  {
    "Type": "bind",
    "Source": "/share/CACHEDEV1_DATA/.qpkg/container-station/etc/k3s",
    "Destination": "/etc/k3s",
    "Mode": "",
    "RW": true,
    "Propagation": "rprivate"
  },
  {
    "Type": "bind",
    "Source": "/share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/etc/rancher",
    "Destination": "/etc/rancher",
    "Mode": "",
    "RW": true,
    "Propagation": "rprivate"
  },
  {
    "Type": "bind",
    "Source": "/share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/var/lib/cni",
    "Destination": "/var/lib/cni",
    "Mode": "",
    "RW": true,
    "Propagation": "rprivate"
  }
]


# 查看网络与端口
docker inspect 1213af7b16dc --format '{{json .NetworkSettings.Ports}}' | jq
```

---

## 1.5. 最终精简版启动命令 (基于您的 runlike 结果)

您获取的 `runlike` 结果中之所以有上千行，是因为它把 `61000-62000` 之间的每一个端口都拆开写成了 `-p`。在 Docker 命令中，我们可以直接用**范围表示法**来大幅简化。

### 核心优化点：
1. **端口简化**：使用 `-p 61000-62000:61000-62000` 一行代替上千行。
2. **保留关键标识**：保留了 `--hostname` 和 `--mac-address` 以确保 K8s 内部节点识别一致。
3. **加入代理支持**：在精简命令中预留了代理环境变量。
- success start 
```bash
docker run -d \
  --name qnap-k3s-proxy \
  --hostname qnap-k3s-Q21CA01210 \
  --mac-address 02:42:0a:00:03:08 \
  --privileged \
  --restart always \
  --network bridge \
  -p 6443:6443 \
  -p 61000-62000:61000-62000 \
  -e HTTP_PROXY="http://192.168.31.198:7222" \
  -e HTTPS_PROXY="http://192.168.31.198:7222" \
  -e NO_PROXY="localhost,127.0.0.1,10.0.0.0/8" \
  -v /share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/var/lib/kubelet:/var/lib/kubelet \
  -v /share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/var/lib/rancher/k3s:/var/lib/rancher/k3s \
  -v /share/CACHEDEV1_DATA/.qpkg/container-station/var/log/container-station/k3s:/var/log \
  -v /share/CACHEDEV1_DATA/.qpkg/container-station/etc/k3s:/etc/k3s \
  -v /share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/etc/rancher:/etc/rancher \
  -v /share/CACHEDEV1_DATA/.qpkg/container-station/var/lib/k3s/var/lib/cni:/var/lib/cni \
  rancher/k3s:v1.21.1-k3s1 \
  server --config /etc/rancher/config.yaml
```

> [!TIP]
> **关于网络模式**：虽然您的原始命令使用的是 `bridge` 模式，但在 QNAP 上运行 K3s，如果端口冲突不严重，使用 `--network host` 会获得更好的性能且不需要手动映射上千个端口。不过为了保险，上面依然保留了您原有的 `bridge` 逻辑。

---

## 2. 容器备份 (保存当前修改)

为了防止损坏现有容器，我们在操作前将其当前状态提交为新镜像并导出。

```bash
# 1. 提交当前运行中的容器状态为新镜像
docker commit 1213af7b16dc qnap-k3s-backup:20260110
sh-3.2# docker commit 1213af7b16dc qnap-k3s-backup:20260110
sha256:f69fea691eb0d93cc8485c51b09794f7184c2e31b8c70ca10cc4ae016cc6541e

# 2. 将镜像保存为压缩包 (存放在宿主机安全位置)
mkdir -p /share/CACHEDEV3_DATA/git/k3s/backups
docker save -o /share/CACHEDEV3_DATA/git/k3s/backups/k3s-backup-v1.tar qnap-k3s-backup:20260110



# 3. 验证备份文件
du -sh /share/CACHEDEV3_DATA/git/k3s/backups/k3s-backup-v1.tar
sh-3.2# du -sh /share/CACHEDEV3_DATA/git/k3s/backups/k3s-backup-v1.tar
168M	/share/CACHEDEV3_DATA/git/k3s/backups/k3s-backup-v1.tar
```

---

## 3. 设置代理并重新拉取/启动

如果您想为容器配置代理（例如解决拉取镜像失败问题），请按以下步骤操作。

### 停止并移除旧容器 (确保已完成第2步备份)
```bash
docker stop 1213af7b16dc
docker rm 1213af7b16dc
```

### 带代理启动新容器
假设您从第一步拿到了启动参数，现在只需添加环境变量 `-e`。

```bash
# 启动示例 (需根据 runlike 的结果调整)
docker run -d \
  --name qnap-k3s \
  --privileged \
  --network host \
  -e HTTP_PROXY="http://your-proxy-ip:port" \
  -e HTTPS_PROXY="http://your-proxy-ip:port" \
  -e NO_PROXY="localhost,127.0.0.1,10.0.0.0/8" \
  -v /var/lib/rancher/k3s:/var/lib/rancher/k3s \
  rancher/k3s:v1.21.1-k3s1 \
  server
```

> [!IMPORTANT]
> **K3s 内部代理声明**：由于 K3s 内部会启动 containerd，通常需要在 Docker 启动参数中显式传递代理变量，以便 K3s 内部能够正确拉取系统镜像。
