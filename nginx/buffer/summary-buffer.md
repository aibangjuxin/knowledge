- [Q](#q)
- [Summary 2](#summary-2)
		- [1. `client_request_buffer_max_size`](#1-client_request_buffer_max_size)
		- [2. `request_body_max_size`](#2-request_body_max_size)
		- [æ€»ç»“](#æ€»ç»“)
		- [ç¤ºä¾‹åœºæ™¯](#ç¤ºä¾‹åœºæ™¯)
- [nginx é…ç½®](#nginx-é…ç½®)

# Q

```bash
æˆ‘ä»¬æ˜¯è¿è¡Œåœ¨Googleçš„GKE APIå¹³å°,å¹³å°æŽ¥å…¥å„ä¸ªTeamçš„API.APIéƒ½æ˜¯ç»è¿‡Kong Gatewayæµå…¥åˆ°æˆ‘ä»¬çš„Runtime
å¤§æ¦‚çš„æµç¨‹å¦‚ä¸‹
GLB+nginxL7==>Squid==>KongDP==> User GKE Deploy
Squidå› ä¸ºæˆ‘ä»¬ç½‘ç»œéš”ç¦»æ‰€ä»¥éœ€è¦Squidåšä»£ç†è·³è½¬åˆ°å“ªæ­¥çŽ¯å¢ƒçš„Kong DP
æˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªå¤§æ–‡ä»¶ä¸Šä¼ ä¸ŽTokenè®¤è¯[æˆ‘ä»¬ä½¿ç”¨KongDPçš„Plugåšæ ¡éªŒ]æ—¶æ•ˆæ€§å†²çªçš„é—®é¢˜ã€‚é‚£ä¹ˆå¯¹äºŽæˆ‘ç±»ä¼¼è¿™æ ·çš„æž¶æž„æ¥è¯´ æœ€ä½³çš„å®žè·µæ–¹æ¡ˆåº”è¯¥æ˜¯ä»€ä¹ˆ?  
æ¯”å¦‚åœ¨nginxä¸Šé¢å¦‚ä¸‹é…ç½®
```nginx.conf
location /api/ {
Â  Â  proxy_pass http://squid_backend;
Â  Â  proxy_request_buffering off;
Â  Â  proxy_buffering off;
Â  Â  proxy_http_version 1.1;
Â  Â  client_max_body_size 100m;
Â  Â  proxy_read_timeout 300s;
Â  Â  proxy_send_timeout 300s;
}
```

Squidä¸Šå¦‚ä¸‹é…ç½®

```squid.conf
request_body_max_size 50 MB
client_request_buffer_max_size 64 KBÂ 
```

ä¸Šé¢æ˜¯æˆ‘å·²ç»æŽ¢ç´¢çš„ä¸€äº›è§£å†³æ–¹æ¡ˆ. æ¯”å¦‚åœ¨é™åˆ¶ç”¨æˆ·æœ€å¤§ä¸Šä¼ æ–‡ä»¶å¤§å°çš„åŒæ—¶,èƒ½æ»¡è¶³æˆ‘ä»¬çš„ç”¨æˆ·èƒ½å®Œæˆå¿«é€ŸTokenæ ¡éªŒ.

# summary 1

ä½ è¿™ä¸ªåœºæ™¯é‡Œä¸»è¦çŸ›ç›¾æ˜¯ **å¤§æ–‡ä»¶ä¸Šä¼  + Token æ ¡éªŒæ—¶æ•ˆæ€§**ã€‚

é—®é¢˜ç‚¹åœ¨äºŽï¼š

- **KongDP çš„ Token æ ¡éªŒå¿…é¡»ç­‰åˆ°è¯·æ±‚ä½“ä¼ è¾“åˆ°è¾¾æ—¶æ‰èƒ½å¼€å§‹**ï¼ˆå°¤å…¶å¦‚æžœä»£ç†èŠ‚ç‚¹å…ˆç¼“å­˜/ç¼“å†²è¯·æ±‚ä½“ï¼‰ã€‚
- **Squid å’Œ Nginx çš„ buffering é…ç½®**ç›´æŽ¥å†³å®šäº† Token æ ¡éªŒæ˜¯â€œå…ˆæ ¡éªŒ headerï¼Œå†æµå¼è½¬å‘ bodyâ€è¿˜æ˜¯â€œå¿…é¡»å®Œæ•´æ”¶ä¸‹ body æ‰èƒ½è½¬å‘â€ã€‚
- å¦‚æžœç¼“å†²è¿‡å¤§ï¼ˆå¦‚ client_request_buffer_max_size=50Mï¼‰ï¼Œæ ¡éªŒä¼šå»¶è¿Ÿï¼Œå¯¼è‡´ Token è¿‡æœŸã€‚

---

## **æœ€ä½³å®žè·µæ–¹å‘**

### **1.**Â 

### **æµå¼è½¬å‘ + Header ä¼˜å…ˆæ ¡éªŒ**

- åœ¨ **Nginx** å’Œ **Squid** ä¸Šå¼€å¯ **æµå¼è½¬å‘**ï¼Œå³ä¸ç¼“å­˜å®Œæ•´è¯·æ±‚ä½“ï¼š
    - Nginx ç”¨ proxy_request_buffering offï¼ˆä½ å·²é…ç½® âœ…ï¼‰ã€‚
    - Squid å»ºè®® client_request_buffer_max_size è®¾ç½®ä¸ºè¾ƒå°å€¼ï¼ˆå¦‚ 64KBï¼‰ï¼Œåªç¼“å­˜å¤´éƒ¨ + å°‘é‡ body ç‰‡æ®µå³å¯ã€‚
    - è¿™æ · Squid ä¼šå…ˆæŠŠ header é€åˆ° KongDPï¼ŒKongDP èƒ½å¤Ÿå…ˆåš Token æ ¡éªŒï¼Œå†å†³å®šæ˜¯å¦ç»§ç»­è¯»å– bodyã€‚

### **2.**Â 

### **åœ¨ KongDP æå‰æ ¡éªŒ Tokenï¼ˆHeader-only authï¼‰**

- åœ¨ KongDP çš„æ’ä»¶é€»è¾‘é‡Œï¼Œå°½é‡åšåˆ°**åªåŸºäºŽ Header æ ¡éªŒ Token**ï¼Œä¸ä¾èµ–è¯·æ±‚ä½“ã€‚
- ä¸€æ—¦ header æ ¡éªŒé€šè¿‡ï¼Œå†ç»§ç»­æŽ¥æ”¶/è½¬å‘å¤§æ–‡ä»¶ã€‚
- å¦‚æžœä½ ä»¬çš„ Token æ ¡éªŒéœ€è¦ payload å‚ä¸Žï¼ˆä¾‹å¦‚ç­¾åè¦†ç›– bodyï¼‰ï¼Œå°±å¿…é¡»è¦è°ƒæ•´æž¶æž„ï¼ˆè§ç¬¬ 4 ç‚¹ï¼‰ã€‚

### **3.**Â 

### **è¶…æ—¶å‚æ•°çš„åŒ¹é…**

- Nginx proxy_read_timeoutã€proxy_send_timeout å·²ç»è®¾ç½®è¾ƒå¤§ï¼ˆ300sï¼‰ï¼Œå¯ä»¥ä¿éšœå¤§æ–‡ä»¶ä¸Šä¼ ã€‚
- Squid éœ€è¦é…åˆè®¾ç½® request_body_max_sizeï¼ˆæŽ§åˆ¶æœ€å¤§æ–‡ä»¶å¤§å°ï¼‰ï¼Œé¿å…è¿‡å¤§æ–‡ä»¶æ‹–åž®ä»£ç†ã€‚

### **4.**Â 

### **æ›´é«˜çº§çš„æ–¹æ¡ˆï¼ˆæŽ¨èæ”¹é€ æ€è·¯ï¼‰**

å¦‚æžœæœªæ¥ä½ ä»¬ä¸Šä¼ çš„æ–‡ä»¶è¿˜ä¼šæ›´å¤§ï¼Œæˆ–è€…å¯¹ Token æ—¶æ•ˆè¦æ±‚æ›´ä¸¥æ ¼ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **åˆ†ç¦» Auth ä¸Ž Upload**

    - å…ˆè°ƒç”¨ä¸€ä¸ªå°è¯·æ±‚æŽ¥å£éªŒè¯ Tokenï¼ˆç”± KongDP å®Œæˆï¼‰ã€‚
    - éªŒè¯é€šè¿‡åŽè¿”å›žä¸€ä¸ª **ä¸€æ¬¡æ€§ä¸Šä¼  URL**ï¼ˆPresigned URLï¼Œå­˜å‚¨åœ¨ GCS/Bucket æˆ–åŽç«¯æœåŠ¡ï¼‰ã€‚
    - ç”¨æˆ·ç”¨è¿™ä¸ª URL ç›´æŽ¥ä¸Šä¼ å¤§æ–‡ä»¶ï¼Œä¸å†èµ° KongDP è®¤è¯é“¾è·¯ã€‚
    - KongDP åªç®¡é‰´æƒï¼Œä¸ç®¡å¤§æ–‡ä»¶ä¼ è¾“ã€‚
    - ä¼˜ç‚¹ï¼šé¿å…å¤§æ–‡ä»¶é•¿é“¾è·¯ + Token è¿‡æœŸé—®é¢˜ã€‚

2. **çŸ­æ—¶ Token + Refresh æœºåˆ¶**

    - ä¸Šä¼ æŽ¥å£ç­¾å‘ **çŸ­æ—¶æœ‰æ•ˆ Token**ï¼Œä¸Šä¼ è¿‡ç¨‹ä¸­å³ä¾¿ç”¨æˆ·é•¿æ—¶é—´å ç”¨é“¾è·¯ï¼Œä¹Ÿä¸ä¼šå› ä¸ºåˆå§‹ Token è¿‡æœŸè€Œå¤±è´¥ã€‚
    - KongDP æ’ä»¶åªæ£€æŸ¥å¤´éƒ¨ Tokenï¼Œä¸æ„ŸçŸ¥ Bodyã€‚

---

## **æ€»ç»“**

åœ¨ä½ å½“å‰çš„æž¶æž„ä¸‹ï¼ŒæŽ¨èç»„åˆæ–¹æ¡ˆï¼š

1. **Nginx + Squid éƒ½å¼€å¯æµå¼è½¬å‘**ï¼ˆé¿å…ç¼“å­˜å®Œæ•´ bodyï¼‰ã€‚

```
proxy_request_buffering off;
proxy_buffering off;
```

```
client_request_buffer_max_size 64 KB   # ä¿æŒå°å€¼
request_body_max_size 50 MB           # é™åˆ¶æœ€å¤§æ–‡ä»¶
```

1.

2.  **KongDP æ’ä»¶åªæ ¡éªŒ header ä¸­çš„ Token**ï¼Œé¿å…ä¾èµ– bodyã€‚
3.  **å¦‚æžœåŽç»­æ–‡ä»¶æ›´å¤§** â†’ æ”¹é€ ä¸º **é¢„ç­¾åç›´ä¼ æ–¹æ¡ˆ**ï¼ŒKong åªè´Ÿè´£é‰´æƒï¼Œæ–‡ä»¶èµ°å­˜å‚¨ç³»ç»Ÿã€‚

---

### **Mermaid æµç¨‹å›¾**

```mermaid
graph TD;
    A[Client ä¸Šä¼ è¯·æ±‚] --> B[Nginx L7 proxy]
    B --> C[Squid Proxy<br/>æµå¼è½¬å‘ Header]
    C --> D[Kong DP<br/>Token Header æ ¡éªŒ]
    D -->|æ ¡éªŒé€šè¿‡| E[Runtime Service<br/>æŽ¥æ”¶ Body]
    D -->|æ ¡éªŒå¤±è´¥| F[è¿”å›ž 401/403]

    subgraph å¯é€‰ä¼˜åŒ–
        G[Auth æŽ¥å£å…ˆæ ¡éªŒ Token]
        G --> H[ç”Ÿæˆ Presigned URL]
        H --> I[Client ç›´ä¼  GCS/åŽç«¯å­˜å‚¨]
    end
```

---

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä»½ **å®Œæ•´çš„æŽ¨èé…ç½®æ¸…å•**ï¼ˆNginx + Squid + Kong æ’ä»¶ä¾§ï¼‰ï¼Œæ–¹ä¾¿ä½ ç›´æŽ¥å¥—ç”¨å¯¹æ¯”ï¼Ÿ

# summay2 Claude

åŸºäºŽæ‚¨çš„æž¶æž„å’Œå½“å‰é‡åˆ°çš„é—®é¢˜ï¼Œæˆ‘æ¥åˆ†æžä¸€ä¸‹æœ€ä½³å®žè·µæ–¹æ¡ˆã€‚

## æž¶æž„æµç¨‹å›¾

```mermaid
graph TD
    A[Client] --> B[GLB + Nginx L7]
    B --> C[Squid Proxy]
    C --> D[Kong DP]
    D --> E[Token Validation Plugin]
    E --> F[User GKE Deploy]
    
    subgraph "é—®é¢˜åŒºåŸŸ"
        G[å¤§æ–‡ä»¶ä¸Šä¼ ]
        H[Tokenæ—¶æ•ˆæ€§]
    end
    
    G -.-> C
    H -.-> D
```

## æ ¸å¿ƒé—®é¢˜åˆ†æž

æ‚¨çš„é—®é¢˜ä¸»è¦é›†ä¸­åœ¨ï¼š

1. **å¤§æ–‡ä»¶ä¸Šä¼ å»¶è¿Ÿ** vs **Tokenå¿«é€Ÿæ ¡éªŒ**çš„å†²çª
2. å½“å‰é…ç½®åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶ï¼ŒTokenå¯èƒ½åœ¨ä¸Šä¼ å®Œæˆå‰è¿‡æœŸ

## æœ€ä½³å®žè·µæ–¹æ¡ˆ

### 1. Nginxå±‚ä¼˜åŒ–

```nginx
location /api/upload/ {
    # å¤§æ–‡ä»¶ä¸Šä¼ ä¸“ç”¨è·¯å¾„
    proxy_pass http://squid_backend;
    proxy_request_buffering off;
    proxy_buffering off;
    proxy_http_version 1.1;
    client_max_body_size 500m;  # å¢žå¤§é™åˆ¶
    proxy_read_timeout 900s;    # 15åˆ†é’Ÿ
    proxy_send_timeout 900s;
    
    # å¯ç”¨æµå¼ä¼ è¾“
    proxy_set_header Connection "";
    proxy_set_header X-Upload-Content-Length $content_length;
}

location /api/ {
    # æ™®é€šAPIè¯·æ±‚
    proxy_pass http://squid_backend;
    proxy_request_buffering on;
    proxy_buffering on;
    proxy_http_version 1.1;
    client_max_body_size 10m;
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;
}
```

### 2. Squidé…ç½®ä¼˜åŒ–

```bash
# åŸºç¡€é…ç½®ä¿æŒä¸å˜ï¼Œæ·»åŠ ä»¥ä¸‹ä¼˜åŒ–
request_body_max_size 500 MB
client_request_buffer_max_size 1 MB  # å¢žå¤§ç¼“å†²åŒº

# æ·»åŠ å¤§æ–‡ä»¶å¤„ç†ä¼˜åŒ–
range_offset_limit -1
quick_abort_min -1 KB
quick_abort_max -1 KB
quick_abort_pct 95

# è¿žæŽ¥æ± ä¼˜åŒ–
server_persistent_connections on
client_persistent_connections on
half_closed_clients off

# å†…å­˜ä½¿ç”¨ä¼˜åŒ–
cache_mem 512 MB
maximum_object_size_in_memory 512 KB
```

### 3. Kongå±‚è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šTokené¢„éªŒè¯ + é•¿æ•ˆToken

```lua
-- Kongæ’ä»¶é…ç½®
local token_validator = {
  name = "enhanced-token-validator",
  config = {
    pre_validate_upload = true,
    extended_token_ttl = 1800,  -- 30åˆ†é’Ÿ
    upload_threshold = 10485760  -- 10MB
  }
}
```

#### æ–¹æ¡ˆBï¼šåˆ†ç¦»è®¤è¯å’Œä¸Šä¼ æµç¨‹

```mermaid
sequenceDiagram
    participant C as Client
    participant N as Nginx
    participant S as Squid
    participant K as Kong
    participant A as API Service
    
    C->>N: 1. é¢„è®¤è¯è¯·æ±‚ + æ–‡ä»¶å…ƒä¿¡æ¯
    N->>S: è½¬å‘è®¤è¯è¯·æ±‚
    S->>K: ä»£ç†åˆ°Kong
    K->>A: Tokenæ ¡éªŒ
    A-->>K: è¿”å›žUpload Token + URL
    K-->>S: è½¬å‘å“åº”
    S-->>N: ä»£ç†å“åº”
    N-->>C: è¿”å›žUpload Token
    
    C->>N: 2. ä½¿ç”¨Upload Tokenä¸Šä¼ æ–‡ä»¶
    N->>S: æµå¼ä¼ è¾“
    S->>K: ä»£ç†ä¸Šä¼ 
    K->>A: ç›´æŽ¥è½¬å‘ï¼ˆè·³è¿‡è®¤è¯ï¼‰
    A-->>K: ä¸Šä¼ å®Œæˆ
    K-->>S: è½¬å‘å“åº”
    S-->>N: ä»£ç†å“åº”
    N-->>C: ä¸Šä¼ æˆåŠŸ
```

### 4. æŽ¨èçš„å®Œæ•´è§£å†³æ–¹æ¡ˆ

|ç»„ä»¶|ä¼˜åŒ–é…ç½®|è¯´æ˜Ž|
|---|---|---|
|Nginx|åˆ†è·¯å¾„å¤„ç†|å¤§æ–‡ä»¶ä¸Šä¼ å•ç‹¬è·¯å¾„ï¼Œå…³é—­ç¼“å†²|
|Squid|å¢žå¤§ç¼“å†²åŒº|1MBç¼“å†²åŒºï¼Œ500MBæœ€å¤§è¯·æ±‚ä½“|
|Kong|åŒTokenæœºåˆ¶|è®¤è¯Token + ä¸Šä¼ Tokenåˆ†ç¦»|
|APIæœåŠ¡|æµå¼å¤„ç†|æ”¯æŒchunkedä¼ è¾“å’Œæ–­ç‚¹ç»­ä¼ |

### 5. ç›‘æŽ§å’Œè°ƒä¼˜

```bash
# Squidç›‘æŽ§è„šæœ¬
#!/bin/bash
# squid_monitor.sh

echo "=== Squidè¿žæŽ¥çŠ¶æ€ ==="
netstat -an | grep :3128 | awk '{print $6}' | sort | uniq -c

echo "=== å¤§æ–‡ä»¶ä¼ è¾“ç»Ÿè®¡ ==="
tail -1000 /var/log/squid/access.log | awk '$7 > 10000000 {print $1, $7, $6}' | head -10

echo "=== å†…å­˜ä½¿ç”¨æƒ…å†µ ==="
squidclient -p 3128 mgr:mem
```

### 6. æ€§èƒ½è°ƒä¼˜å‚æ•°

```bash
# ç³»ç»Ÿå±‚é¢ä¼˜åŒ–
echo 'net.core.rmem_max = 67108864' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 67108864' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_rmem = 4096 87380 67108864' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_wmem = 4096 65536 67108864' >> /etc/sysctl.conf

sysctl -p
```

### 7. å…³é”®å»ºè®®

1. **ä½¿ç”¨é¢„è®¤è¯æœºåˆ¶**ï¼šå…ˆéªŒè¯Tokenï¼ŒèŽ·å–ä¸´æ—¶ä¸Šä¼ å‡­è¯
2. **å®žæ–½æµå¼ä¼ è¾“**ï¼šé¿å…åœ¨ä»£ç†å±‚ç¼“å­˜å¤§æ–‡ä»¶
3. **è®¾ç½®åˆç†è¶…æ—¶**ï¼šæ ¹æ®æ–‡ä»¶å¤§å°åŠ¨æ€è°ƒæ•´è¶…æ—¶æ—¶é—´
4. **ç›‘æŽ§å…³é”®æŒ‡æ ‡**ï¼šè¿žæŽ¥æ•°ã€ä¼ è¾“é€ŸçŽ‡ã€é”™è¯¯çŽ‡

è¿™ç§æž¶æž„å¯ä»¥å¾ˆå¥½åœ°å¹³è¡¡å¤§æ–‡ä»¶ä¸Šä¼ æ€§èƒ½å’ŒTokenå®‰å…¨æ€§ï¼ŒåŒæ—¶ä¿æŒç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚

# Summary 3

1.Â  **KongDP çš„è®¤è¯æ’ä»¶**ï¼šå½“è¯·æ±‚åˆ°è¾¾ KongDP æ—¶ï¼Œè®¤è¯æ’ä»¶ä¼šæå– Token å¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§ã€‚è¿™ä¸ª 30 ç§’çš„è¶…æ—¶æ˜¯é’ˆå¯¹ Token æœ¬èº«çš„æœ‰æ•ˆæœŸï¼Œè€Œä¸æ˜¯é’ˆå¯¹è¯·æ±‚çš„ä¼ è¾“æ—¶é—´ã€‚

2.Â  **è¯·æ±‚çš„æŠµè¾¾æ—¶é—´**ï¼šå¦‚æžœæ•´ä¸ªè¯·æ±‚ä½“ï¼ˆåŒ…æ‹¬æ–‡ä»¶ï¼‰åœ¨ Token è¿‡æœŸä¹‹å‰æ²¡æœ‰å®Œå…¨æŠµè¾¾ KongDPï¼Œå¹¶è¢« KongDP çš„è®¤è¯æ’ä»¶å¤„ç†ï¼Œé‚£ä¹ˆè¯·æ±‚å°±ä¼šå¤±è´¥ã€‚

3. åˆ†æž Squid çš„æ—¥å¿—åŽ»çœ‹çœ‹æ˜¯ä¸æ˜¯è¿™é‡Œå¡åœ¨é‚£?
    - https://www.squid-cache.org/Doc/config/client_request_buffer_max_size/
    - è¿™æŒ‡å®šäº†å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§ç¼“å†²åŒºå¤§å°ã€‚å½“æœ‰äººä¸Šä¼ å¤§æ–‡ä»¶æ—¶ï¼Œå®ƒå¯ä»¥é˜²æ­¢ squid å ç”¨è¿‡å¤šå†…å­˜ã€‚
    - This specifies the maximum buffer size of a client request. It prevents squid eating too much memory when somebody uploads a large file.
    -

```bash
client_request_buffer_max_size 50 MBÂ æ˜¯æœ€å¤§çš„é—®é¢˜
client_request_buffer_max_size 0        # å–æ¶ˆäº†è¯·æ±‚ç¼“å†²åŒºçš„å¤§å°é™åˆ¶
client_request_buffer_max_size 1 KB     # æœ€å¤šç¼“å†²1KB
client_request_buffer_max_size 64 KB    # é»˜è®¤å€¼ï¼Œç¼“å†²64KB

å¦‚æžœä¸Šä¼ æ–‡ä»¶æ˜¯50MBï¼Œè€Œè¿™ä¸ªå€¼ä¹Ÿè®¾ç½®ä¸º50MBã€‚è¿™æ„å‘³ç€Squidä¼šå°è¯•å°†æ•´ä¸ª50MBçš„è¯·æ±‚ä½“å®Œå…¨ç¼“å†²åˆ°å†…å­˜ä¸­ï¼Œç„¶åŽå†è½¬å‘ç»™ä¸Šæ¸¸ã€‚è¿™æ­£æ˜¯å¯¼è‡´Tokenåœ¨æ–‡ä»¶ä¸Šä¼ æœŸé—´è¶…æ—¶çš„ä¸»å› 

å¦‚æžœä¸Šä¼ æ–‡ä»¶æ˜¯30M,ä¹Ÿå°±æ˜¯å°äºŽ50MB.

æœ€é‡è¦ï¼š å°† client_request_buffer_max_size 50 MB è°ƒæ•´ä¸º 1 KB (æˆ–æ›´å°)ï¼Œæˆ–è€…ç›´æŽ¥ç§»é™¤æ­¤è¡Œï¼Œè®©Squidåœ¨cache deny allçš„èƒŒæ™¯ä¸‹å°è¯•æµå¼å¤„ç†ã€‚
æ¯”å¦‚æˆ‘å¯ä»¥è®¾ç½®ä¸º32Kå°±å¯ä»¥äº† ==> è€Œä¸æ˜¯50MB ?

æ‰€ä»¥è¿™ä¸ªå€¼æ¯”å¦‚æˆ‘è®¾ç½®ä¸º2M ä¹Ÿå°±æ˜¯è¯´ å­˜å‚¨è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“çš„ç¼“å†²åŒºçš„æœ€å¤§å¤§å° æ˜¯2M è¿™æ ·ä¹Ÿä¸ä¼šå½±å“æˆ‘ç”¨æˆ·ä¸Šä¼ 50Mæ–‡ä»¶,è¿˜èƒ½å¿«é€Ÿå®Œæˆæˆ‘çš„TOkenè®¤è¯?


```

éžå¸¸å¥½çš„é—®é¢˜ ðŸ‘ ä½ æŠŠ Squid çš„ä¸¤ä¸ªå‚æ•°æžæ¸…æ¥šä»¥åŽï¼Œé€»è¾‘å°±é€šäº†ï¼š

â¸»

1. client_request_buffer_max_size
   â€¢ ä½œç”¨ï¼šæŽ§åˆ¶ å•ä¸ªè¯·æ±‚ body åœ¨å†…å­˜ä¸­ç¼“å­˜çš„æœ€å¤§å¤§å°ã€‚
   â€¢ è¡Œä¸ºï¼š
   â€¢ å¦‚æžœè¯·æ±‚ä½“ â‰¤ è¿™ä¸ªå€¼ â†’ Squid ä¼šä¸€æ¬¡æ€§è¯»å®Œæ”¾åˆ°å†…å­˜ï¼Œå†è½¬å‘ã€‚
   â€¢ å¦‚æžœè¯·æ±‚ä½“ > è¿™ä¸ªå€¼ â†’ Squid åªåœ¨å†…å­˜ä¿ç•™è¿™ä¸€å—ï¼Œå‰©ä½™éƒ¨åˆ†ä¼š æµå¼è½¬å‘ åˆ°ä¸Šæ¸¸ï¼ˆä¸ä¼šé˜»å¡žä¸Šä¼ ï¼‰ã€‚

ðŸ‘‰ æ‰€ä»¥ï¼Œè¿™ä¸ªå‚æ•°ä¸»è¦å†³å®šçš„æ˜¯ æ˜¯å¦å…¨é‡ç¼“å†²åœ¨å†…å­˜ï¼Œè¿˜æ˜¯æµå¼è½¬å‘ã€‚

â¸»

2. request_body_max_size
   â€¢ ä½œç”¨ï¼šæŽ§åˆ¶ å…è®¸çš„æœ€å¤§è¯·æ±‚ä½“å¤§å°ã€‚
   â€¢ è¡Œä¸ºï¼šè¶…è¿‡è¿™ä¸ªå¤§å°ï¼ŒSquid ç›´æŽ¥è¿”å›ž 413 Request Entity Too Largeï¼Œè¯·æ±‚ä¸ä¼šè½¬å‘ã€‚

ðŸ‘‰ å®ƒæ˜¯ä¸€ä¸ª ç¡¬é™åˆ¶ï¼Œç‹¬ç«‹äºŽ client_request_buffer_max_sizeã€‚

â¸»

3. ä½ æåˆ°çš„åœºæ™¯åˆ†æž
   â€¢ å¦‚æžœ client_request_buffer_max_size 50Mï¼š
   â€¢ ç”¨æˆ·ä¸Šä¼  50M æ–‡ä»¶æ—¶ï¼ŒSquid ä¼šå…ˆç­‰ 50M å…¨éƒ¨æ”¶å®Œï¼Œç¼“å­˜åœ¨å†…å­˜é‡Œï¼Œå†å‘ç»™ Kongã€‚
   â€¢ è¿™ç¡®å®žå¯èƒ½å¯¼è‡´ Token æ’ä»¶åœ¨ç­‰å¾…æ–‡ä»¶ä¸Šä¼ æ—¶å°±è¶…æ—¶ï¼ˆå› ä¸º Kong è¦ç­‰ Squid äº¤å®Œè¯·æ±‚å¤´å’Œ body æ‰èƒ½å¤„ç†ï¼‰ã€‚
   â€¢ å¦‚æžœ client_request_buffer_max_size 64Kï¼š
   â€¢ ç”¨æˆ·ä¸Šä¼  50M æ–‡ä»¶æ—¶ï¼ŒSquid åªä¼šåœ¨å†…å­˜é‡Œä¿ç•™ 64K çš„ç‰‡æ®µï¼Œå‰©ä¸‹éƒ¨åˆ†ç›´æŽ¥æµå¼è½¬å‘ç»™ Kongã€‚
   â€¢ è¿™æ · Kong å¯ä»¥ å°½æ—©æ”¶åˆ°è¯·æ±‚å¤´å’Œ Tokenï¼Œé©¬ä¸Šè¿›è¡Œ Token æ ¡éªŒï¼Œè€Œä¸ç”¨ç­‰ 50M ä¸Šä¼ å®Œã€‚
   â€¢ æ–‡ä»¶å¤§å°é™åˆ¶ä»ç„¶ç”± request_body_max_size æŽ§åˆ¶ï¼ˆæ¯”å¦‚ 50M ä»¥å†…å…è®¸ï¼‰ã€‚

ðŸ‘‰ æ‰€ä»¥ è°ƒå° client_request_buffer_max_size å¯ä»¥é¿å…å¤§æ–‡ä»¶è¢« Squid é˜»å¡žï¼Œè®© Token é€»è¾‘æ›´åŠæ—¶ã€‚

â¸»

4. å»ºè®®é…ç½®

```squid.conf
æœ€å¤§å…è®¸ä¸Šä¼ æ–‡ä»¶å¤§å°
request_body_max_size 50 MB

å•æ¬¡å†…å­˜ç¼“å†²å¤§å°ï¼Œè¶…è¿‡éƒ¨åˆ†æµå¼è½¬å‘
client_request_buffer_max_size 64 KB
```

è¿™æ ·ï¼š
â€¢ æ–‡ä»¶ > 50M â†’ ç›´æŽ¥è¢«æ‹’ç»ï¼ˆç¬¦åˆä¸šåŠ¡è§„åˆ™ï¼‰ã€‚
â€¢ æ–‡ä»¶ â‰¤ 50M â†’ èµ°æµå¼è½¬å‘ï¼Œé¿å… Squid å¡ä½å¤§æ–‡ä»¶ï¼ŒKong èƒ½å°½å¿«åš Token éªŒè¯ã€‚

â¸»

5. âœ… æ€»ç»“
   â€¢ request_body_max_size = æ–‡ä»¶ä¸Šä¼ å…è®¸çš„ æœ€å¤§å¤§å°ã€‚
   â€¢ client_request_buffer_max_size = å†…å­˜ä¸­æœ€å¤šç¼“å­˜å¤šå°‘ï¼Œè¶…è¿‡å°± è¾¹æ”¶è¾¹è½¬å‘ã€‚
   â€¢ è®¾ç½® client_request_buffer_max_size å¤ªå¤§ï¼ŒSquid å°±ä¼šé˜»å¡žåœ¨æœ¬åœ°ç¼“å†²ï¼Œå¯¼è‡´ Token è¶…æ—¶ã€‚
   â€¢ è®¾ç½®æˆ 64K è¿™ç§è¾ƒå°çš„å€¼ ä¸ä¼šé™åˆ¶æ–‡ä»¶å¤§å°ï¼Œåè€Œèƒ½æé«˜ Token æ’ä»¶çš„å“åº”åŠæ—¶æ€§ã€‚

â¸»

1. å¢žåŠ ä¸€ä¸ªé…ç½®
    - https://www.squid-cache.org/Doc/config/request_body_max_size/
    - request_body_max_size è¿™ä¸ªæ‰æ˜¯æŽ§åˆ¶ç”¨æˆ·ä¸Šä¼ å¤§å°çš„

```
request_body_max_size = 50MB

è¿™è§„å®šäº†HTTPè¯·æ±‚ä½“çš„æœ€å¤§å¤§å°ã€‚
æ¢å¥è¯è¯´ï¼Œå°±æ˜¯PUT/POSTè¯·æ±‚çš„æœ€å¤§å¤§å°ã€‚
å¦‚æžœç”¨æˆ·å°è¯•å‘é€çš„è¯·æ±‚ä½“è¶…è¿‡æ­¤é™åˆ¶ï¼Œå°†ä¼šæ”¶åˆ°â€œæ— æ•ˆè¯·æ±‚â€çš„é”™è¯¯ä¿¡æ¯ã€‚
å¦‚æžœå°†æ­¤å‚æ•°è®¾ç½®ä¸ºé›¶ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œåˆ™ä¸ä¼šæ–½åŠ ä»»ä½•é™åˆ¶ã€‚

å¦è¯·å‚é˜…client_request_buffer_max_sizeï¼Œå®ƒæ˜¯å¦ä¸€ç§å¯é…ç½®çš„å¯¹å®¢æˆ·ç«¯ä¸Šä¼ çš„é™åˆ¶ã€‚
```

ä¸‹é¢æ˜¯å¯¹æ‚¨æåˆ°çš„ SQUID é…ç½®é¡¹çš„è¯¦ç»†è§£é‡Šï¼š

### 1. `client_request_buffer_max_size`

**é…ç½®é¡¹:**

```plaintext
client_request_buffer_max_size 64 KB
```

**è§£é‡Š:**

- **ä½œç”¨:** è¯¥é…ç½®é¡¹ç”¨äºŽæŒ‡å®š SQUID åœ¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ—¶ç”¨äºŽå­˜å‚¨è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“çš„ç¼“å†²åŒºçš„æœ€å¤§å¤§å°ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™æ˜¯æŒ‡ä»Žå®¢æˆ·ç«¯è¯·æ±‚ä¸­å®Œå…¨è¯»å–æ•°æ®æ‰€å…è®¸çš„æœ€å¤§å­—èŠ‚æ•°ã€‚
- **å•ä½:** å¯ä»¥ç”¨å­—èŠ‚ï¼ˆBï¼‰ï¼Œåƒå­—èŠ‚ï¼ˆKBï¼‰ï¼Œå…†å­—èŠ‚ï¼ˆMBï¼‰ç­‰å•ä½æ¥è®¾ç½®ï¼Œé»˜è®¤ä¸º 64 KBã€‚
- **å½±å“:** å¦‚æžœè¯·æ±‚å¤´æˆ–è¯·æ±‚ä½“çš„å¤§å°è¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼ŒSQUID å°†ä¼šæ‹’ç»è¯·æ±‚å¹¶è¿”å›žä¸€ä¸ªé”™è¯¯å“åº”ï¼ˆé€šå¸¸æ˜¯ 400 Bad Requestï¼‰ã€‚è®¾ç½®è¿™ä¸ªå€¼å¯ä»¥å¸®åŠ©é˜²æ­¢å®¢æˆ·ç«¯å‘é€è¿‡å¤§çš„è¯·æ±‚ï¼Œå¯¹æœåŠ¡å™¨çš„å†…å­˜èµ„æºé€ æˆåŽ‹åŠ›æˆ–è€…æ¶æ„è¯·æ±‚ã€‚

### 2. `request_body_max_size`

**é…ç½®é¡¹:**

```plaintext
request_body_max_size = 50MB
```

**è§£é‡Š:**

- **ä½œç”¨:** è¯¥é€‰é¡¹å®šä¹‰äº†å®¢æˆ·è¯·æ±‚ä¸»ä½“ï¼ˆrequest bodyï¼‰çš„æœ€å¤§å…è®¸å¤§å°ã€‚è¯·æ±‚ä¸»ä½“é€šå¸¸æ˜¯åœ¨ HTTP POST è¯·æ±‚æˆ–è€… PUT è¯·æ±‚ä¸­åŒ…å«çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæ–‡ä»¶ä¸Šä¼ ã€‚
- **å•ä½:** ä¹Ÿå¯ä»¥ä½¿ç”¨å­—èŠ‚ï¼ˆBï¼‰ï¼Œåƒå­—èŠ‚ï¼ˆKBï¼‰ï¼Œå…†å­—èŠ‚ï¼ˆMBï¼‰ç­‰å•ä½æ¥è®¾ç½®ã€‚æ­¤å¤„è®¾ç½®ä¸º 50MBã€‚
- **å½±å“:** å¦‚æžœå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä½“è¶…è¿‡äº†è¿™ä¸€é™åˆ¶ï¼ŒSQUID ä¼šç«‹å³ä¸­æ­¢è¯·æ±‚å¹¶è¿”å›žé”™è¯¯å“åº”ã€‚è¿™ä¸ªé€‰é¡¹å¯¹äºŽæŽ§åˆ¶ä¸Šä¼ æ–‡ä»¶çš„å¤§å°éžå¸¸æœ‰ç”¨ï¼Œé˜²æ­¢æ¶æ„ç”¨æˆ·åˆ©ç”¨è¿‡å¤§çš„è¯·æ±‚ç ´åæœåŠ¡å™¨ã€‚

### æ€»ç»“

è¿™ä¸¤ä¸ªé…ç½®é¡¹çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†ç¡®ä¿æœåŠ¡å™¨çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼Œé¿å…å¤§è¯·æ±‚ç»™æœåŠ¡å™¨é€ æˆè´Ÿæ‹…æˆ–è¢«ç”¨äºŽæ‹’ç»æœåŠ¡æ”»å‡»ã€‚åœ¨è¿›è¡Œé…ç½®æ—¶ï¼Œæ ¹æ®è‡ªèº«çš„å…·ä½“åº”ç”¨åœºæ™¯å’Œéœ€æ±‚è°ƒæ•´è¿™ä¸¤ä¸ªå‚æ•°æ˜¯ååˆ†é‡è¦çš„ï¼Œä»¥å¹³è¡¡å¯ç”¨æ€§å’Œå®‰å…¨æ€§ã€‚

### ç¤ºä¾‹åœºæ™¯

- å¦‚æžœä½ çš„åº”ç”¨ä¸­é€šå¸¸å¤„ç†å°æ–‡ä»¶ä¸Šä¼ ï¼Œå¦‚ç”¨æˆ·å¤´åƒï¼Œåˆ™å¯ä»¥å°† `request_body_max_size` è®¾ç½®ä¸ºç›¸å¯¹è¾ƒå°çš„å€¼ï¼ˆå¦‚ 2MBï¼‰ã€‚
- åœ¨é«˜è´Ÿè½½çŽ¯å¢ƒä¸­åˆç†è®¾ç½® `client_request_buffer_max_size` åˆ™å¯ä»¥é˜²æ­¢æœåŠ¡å› å¤„ç†å¤§é‡å¤§è¯·æ±‚è€Œå´©æºƒã€‚

é€šè¿‡å¯¹è¿™ä¸¤ä¸ªé…ç½®è¿›è¡Œåˆç†è®¾ç½®ï¼Œæ‚¨å¯ä»¥æ›´å¥½åœ°ç®¡ç†å’ŒæŽ§åˆ¶åº”ç”¨æœåŠ¡çš„å®‰å…¨å’Œæ€§èƒ½ã€‚

# nginx é…ç½®

```yaml
location /api/ {
Â  Â  proxy_pass http://squid_backend;
Â  Â  proxy_request_buffering off;
Â  Â  proxy_buffering off;Â 
Â  Â  proxy_http_version 1.1;
Â  Â  proxy_set_header Connection ""; # æ¸…é™¤ Connection headerï¼Œæ”¯æŒé•¿è¿žæŽ¥.éœ€è¦ç”¨æˆ·ç¡®è®¤
Â  Â  client_max_body_size 100m;
Â  Â  proxy_read_timeout 300s;
Â  Â  proxy_send_timeout 300s;
}
```

å¢žåŠ ä¸€ä¸ª proxy_buffering off;

```mermaid

sequenceDiagram

Â  Â  participant Client

Â  Â  participant Nginx

Â  Â  participant Squid

Â  Â  participant KongDP



Â  Â  Client->>+Nginx: POST /upload (æºå¸¦æœ‰æ•ˆToken)

Â  Â  Nginx->>+Squid: æµå¼è½¬å‘è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“...

Â  Â  note over Squid: Squidå¼€å§‹ç¼“å†²æ•´ä¸ªè¯·æ±‚ä½“...

Â  Â  Client-->>Squid: ...æ–‡ä»¶ä¸Šä¼ æŒç»­è¶…è¿‡30ç§’...

Â  Â  note over Squid: æ–‡ä»¶æŽ¥æ”¶å®Œæ¯•!

Â  Â  note right of Client: æ­¤æ—¶Tokenå·²è¿‡æœŸ!

Â  Â  Squid->>+KongDP: è½¬å‘å®Œæ•´è¯·æ±‚

Â  Â  KongDP-->>KongDP: Tokenè®¤è¯æ’ä»¶æ‰§è¡Œ

Â  Â  note over KongDP: è®¤è¯å¤±è´¥ (401 Unauthorized)

Â  Â  KongDP-->>-Squid: è¿”å›ž 401

Â  Â  Squid-->>-Nginx: è¿”å›ž 401

Â  Â  Nginx-->>-Client: è¿”å›ž 401

```

```mermaid

sequenceDiagram

Â  Â  participant Client

Â  Â  participant Nginx

Â  Â  participant Squid

Â  Â  participant KongDP



Â  Â  Client->>+Nginx: POST /upload (æºå¸¦æœ‰æ•ˆToken)

Â  Â  Nginx->>+Squid: æµå¼è½¬å‘ (ç«‹å³)

Â  Â  Squid->>+KongDP: æµå¼è½¬å‘ (ç«‹å³)

Â  Â  note over KongDP: æ”¶åˆ°è¯·æ±‚å¤´, Tokenæœ‰æ•ˆ!

Â  Â  KongDP-->>KongDP: Tokenè®¤è¯æ’ä»¶æ‰§è¡Œ

Â  Â  note over KongDP: è®¤è¯æˆåŠŸ!

Â  Â  note over Client, KongDP: æ–‡ä»¶å†…å®¹åœ¨è®¤è¯åŽæŒç»­æµå¼ä¼ è¾“

Â  Â  KongDP->>GKE Runtime: (to GKE) æµå¼è½¬å‘è¯·æ±‚ä½“...

Â  Â  GKE Runtime-->>KongDP: (from GKE) è¿”å›ž 200 OK

Â  Â  KongDP-->>-Squid: è¿”å›ž 200 OK

Â  Â  Squid-->>-Nginx: è¿”å›ž 200 OK

Â  Â  Nginx-->>-Client: è¿”å›ž 200 OK

```
