- [Q](#q)
- [Summary](#summary)
    - [1. `client_request_buffer_max_size`](#1-client_request_buffer_max_size)
    - [2. `request_body_max_size`](#2-request_body_max_size)
    - [æ€»ç»“](#æ€»ç»“)
    - [ç¤ºä¾‹åœºæ™¯](#ç¤ºä¾‹åœºæ™¯)
- [nginx é…ç½®](#nginx-é…ç½®)

# Q
```
é‚£ä¹ˆçŽ°åœ¨å¸®æˆ‘åˆ†æžè¿™æ ·ä¸€ä¸ªé—®é¢˜Â 

GCPå·¥ç¨‹é‡Œé¢

æˆ‘æœ‰ä¸€ä¸ªPOSTçš„è¯·æ±‚ å‘é€åˆ°ä¸€ä¸ªAPI URL æˆ‘è¿™ä¸ªAPIçš„URLçš„followæµä¼šç»è¿‡ä¸€ä¸ªGLB + Nginxç„¶åŽåŽé¢æ˜¯ä¸€ä¸ªSquid ä»£ç†æŠŠè¯·æ±‚å‘é€åˆ°KongDP ç„¶åŽå†åˆ°æˆ‘çš„GKEçš„Runtime

ç„¶åŽæˆ‘è¿™ä¸ªPost APIå¿…é¡»æœ‰ä¸€ä¸ªtokenéœ€è¦è®¤è¯ ä¹Ÿå°±æ˜¯è¯´æˆ‘çš„tokenè¿™ä¸ªæ’ä»¶æ˜¯é…ç½®åœ¨æˆ‘çš„KongDPä¸Šé¢Â 

é‚£ä¹ˆæˆ‘æƒ³äº†è§£ è¿™ä¸ªæ•´ä¸ªçš„followæµé‡Œé¢ æˆ‘POSTçš„è¯·æ±‚æ¯”å¦‚ä¸Šä¼ ä¸€ä¸ªå¤§çš„æ–‡ä»¶ æ¯”å¦‚è¯´50M

ç„¶åŽæˆ‘çš„tokençš„è¶…æ—¶æ—¶é—´è®¾ç½®çš„å°±æ˜¯30ç§’ é‚£ä¹ˆæˆ‘å¦‚ä½•å®žçŽ°æˆ‘çš„éœ€æ±‚.æ¯”å¦‚å¯èƒ½å•ç‹¬æ–‡ä»¶ä¸Šä¼ å°±è¶…è¿‡äº†30S.é‚£ä¹ˆå°±ä¼šTokenè¶…æ—¶.

é‚£ä¹ˆæˆ‘å¦‚ä½•å¹³è¡¡è¿™ä¸ªé—®é¢˜ ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¶…æ—¶æ—¶é—´çš„30ç§’çš„è®¾ç½®æ˜¯é’ˆå¯¹å“ªäº›åœ°æ–¹çš„?Â 

æ¯”å¦‚æ‰¾åˆ°ç±»ä¼¼è¿™ä¸ªåŠžæ³• åœ¨nginxè®¾ç½®äº†proxy_request_buffering offÂ 

åŒæ—¶æˆ‘ç¡®å®šæˆ‘çš„Kong DPé’ˆå¯¹è¿™ä¸ªAPIä¹Ÿè®¾ç½®äº†buffering off ä½†æ˜¯çŽ°åœ¨çœ‹èµ·æ¥è¿˜ä¸èƒ½å®žçŽ°ç›®çš„?
**Squid** è¦ç¡®è®¤ä¹Ÿæ”¯æŒ **streaming? Squid é»˜è®¤é…ç½®é€šå¸¸ä¼šä¸ºäº†å†…å®¹æ‰«ææˆ–ç¼“å­˜è€Œç¼“å†²è¯·æ±‚ä½“ é‡ç‚¹é›†ä¸­åœ¨è¿™é‡Œçœ‹çœ‹æ€Žä¹ˆåŽ»å®žçŽ°**

æˆ–è€…æ˜¯å¦è¿˜æœ‰æ›´å¤šçš„æ€è·¯

å…¶å®žå°±æ˜¯æƒ³å®žçŽ°è¯·æ±‚åœ¨ Token è¿‡æœŸå‰åˆ°è¾¾ KongDP å¹¶å®Œæˆè®¤è¯

å°±æ˜¯æƒ³è®©ä¸Šä¼ å¤§æ–‡ä»¶çš„æ—¶å€™ä¸è¦Blockæˆ‘çš„Tokençš„æ ¡éªŒÂ 
```

# Summary 
1.Â  **KongDP çš„è®¤è¯æ’ä»¶**ï¼šå½“è¯·æ±‚åˆ°è¾¾ KongDP æ—¶ï¼Œè®¤è¯æ’ä»¶ä¼šæå– Token å¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§ã€‚è¿™ä¸ª 30 ç§’çš„è¶…æ—¶æ˜¯é’ˆå¯¹ Token æœ¬èº«çš„æœ‰æ•ˆæœŸï¼Œè€Œä¸æ˜¯é’ˆå¯¹è¯·æ±‚çš„ä¼ è¾“æ—¶é—´ã€‚

2.Â  **è¯·æ±‚çš„æŠµè¾¾æ—¶é—´**ï¼šå¦‚æžœæ•´ä¸ªè¯·æ±‚ä½“ï¼ˆåŒ…æ‹¬æ–‡ä»¶ï¼‰åœ¨ Token è¿‡æœŸä¹‹å‰æ²¡æœ‰å®Œå…¨æŠµè¾¾ KongDPï¼Œå¹¶è¢« KongDP çš„è®¤è¯æ’ä»¶å¤„ç†ï¼Œé‚£ä¹ˆè¯·æ±‚å°±ä¼šå¤±è´¥ã€‚

3. åˆ†æž Squid çš„æ—¥å¿—åŽ»çœ‹çœ‹æ˜¯ä¸æ˜¯è¿™é‡Œå¡åœ¨é‚£?
    - https://www.squid-cache.org/Doc/config/client_request_buffer_max_size/
    - è¿™æŒ‡å®šäº†å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§ç¼“å†²åŒºå¤§å°ã€‚å½“æœ‰äººä¸Šä¼ å¤§æ–‡ä»¶æ—¶ï¼Œå®ƒå¯ä»¥é˜²æ­¢squidå ç”¨è¿‡å¤šå†…å­˜ã€‚
    - This specifies the maximum buffer size of a client request. It prevents squid eating too much memory when somebody uploads a large file.
    - 

```bash
client_request_buffer_max_size 50 MBÂ æ˜¯æœ€å¤§çš„é—®é¢˜
client_request_buffer_max_size 0        # å–æ¶ˆäº†è¯·æ±‚ç¼“å†²åŒºçš„å¤§å°é™åˆ¶
client_request_buffer_max_size 1 KB     # æœ€å¤šç¼“å†²1KB
client_request_buffer_max_size 64 KB    # é»˜è®¤å€¼ï¼Œç¼“å†²64KB

å¦‚æžœä¸Šä¼ æ–‡ä»¶æ˜¯50MBï¼Œè€Œè¿™ä¸ªå€¼ä¹Ÿè®¾ç½®ä¸º50MBã€‚è¿™æ„å‘³ç€Squidä¼šå°è¯•å°†æ•´ä¸ª50MBçš„è¯·æ±‚ä½“å®Œå…¨ç¼“å†²åˆ°å†…å­˜ä¸­ï¼Œç„¶åŽå†è½¬å‘ç»™ä¸Šæ¸¸ã€‚è¿™æ­£æ˜¯å¯¼è‡´Tokenåœ¨æ–‡ä»¶ä¸Šä¼ æœŸé—´è¶…æ—¶çš„ä¸»å› 

å¦‚æžœä¸Šä¼ æ–‡ä»¶æ˜¯30M,ä¹Ÿå°±æ˜¯å°äºŽ50MB.

æœ€é‡è¦ï¼š å°† client_request_buffer_max_size 50 MB è°ƒæ•´ä¸º 1 KB (æˆ–æ›´å°)ï¼Œæˆ–è€…ç›´æŽ¥ç§»é™¤æ­¤è¡Œï¼Œè®©Squidåœ¨cache deny allçš„èƒŒæ™¯ä¸‹å°è¯•æµå¼å¤„ç†ã€‚
æ¯”å¦‚æˆ‘å¯ä»¥è®¾ç½®ä¸º32Kå°±å¯ä»¥äº† ==> è€Œä¸æ˜¯50MB ?

æ‰€ä»¥è¿™ä¸ªå€¼æ¯”å¦‚æˆ‘è®¾ç½®ä¸º2M ä¹Ÿå°±æ˜¯è¯´ å­˜å‚¨è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“çš„ç¼“å†²åŒºçš„æœ€å¤§å¤§å° æ˜¯2M è¿™æ ·ä¹Ÿä¸ä¼šå½±å“æˆ‘ç”¨æˆ·ä¸Šä¼ 50Mæ–‡ä»¶,è¿˜èƒ½å¿«é€Ÿå®Œæˆæˆ‘çš„TOkenè®¤è¯?


```

éžå¸¸å¥½çš„é—®é¢˜ ðŸ‘ ä½ æŠŠ Squid çš„ä¸¤ä¸ªå‚æ•°æžæ¸…æ¥šä»¥åŽï¼Œé€»è¾‘å°±é€šäº†ï¼š

â¸»

1. client_request_buffer_max_size
	â€¢	ä½œç”¨ï¼šæŽ§åˆ¶ å•ä¸ªè¯·æ±‚ body åœ¨å†…å­˜ä¸­ç¼“å­˜çš„æœ€å¤§å¤§å°ã€‚
	â€¢	è¡Œä¸ºï¼š
	â€¢	å¦‚æžœè¯·æ±‚ä½“ â‰¤ è¿™ä¸ªå€¼ â†’ Squid ä¼šä¸€æ¬¡æ€§è¯»å®Œæ”¾åˆ°å†…å­˜ï¼Œå†è½¬å‘ã€‚
	â€¢	å¦‚æžœè¯·æ±‚ä½“ > è¿™ä¸ªå€¼ â†’ Squid åªåœ¨å†…å­˜ä¿ç•™è¿™ä¸€å—ï¼Œå‰©ä½™éƒ¨åˆ†ä¼š æµå¼è½¬å‘ åˆ°ä¸Šæ¸¸ï¼ˆä¸ä¼šé˜»å¡žä¸Šä¼ ï¼‰ã€‚

ðŸ‘‰ æ‰€ä»¥ï¼Œè¿™ä¸ªå‚æ•°ä¸»è¦å†³å®šçš„æ˜¯ æ˜¯å¦å…¨é‡ç¼“å†²åœ¨å†…å­˜ï¼Œè¿˜æ˜¯æµå¼è½¬å‘ã€‚

â¸»

2. request_body_max_size
	â€¢	ä½œç”¨ï¼šæŽ§åˆ¶ å…è®¸çš„æœ€å¤§è¯·æ±‚ä½“å¤§å°ã€‚
	â€¢	è¡Œä¸ºï¼šè¶…è¿‡è¿™ä¸ªå¤§å°ï¼ŒSquid ç›´æŽ¥è¿”å›ž 413 Request Entity Too Largeï¼Œè¯·æ±‚ä¸ä¼šè½¬å‘ã€‚

ðŸ‘‰ å®ƒæ˜¯ä¸€ä¸ª ç¡¬é™åˆ¶ï¼Œç‹¬ç«‹äºŽ client_request_buffer_max_sizeã€‚

â¸»

3. ä½ æåˆ°çš„åœºæ™¯åˆ†æž
	â€¢	å¦‚æžœ client_request_buffer_max_size 50Mï¼š
	â€¢	ç”¨æˆ·ä¸Šä¼  50M æ–‡ä»¶æ—¶ï¼ŒSquid ä¼šå…ˆç­‰ 50M å…¨éƒ¨æ”¶å®Œï¼Œç¼“å­˜åœ¨å†…å­˜é‡Œï¼Œå†å‘ç»™ Kongã€‚
	â€¢	è¿™ç¡®å®žå¯èƒ½å¯¼è‡´ Token æ’ä»¶åœ¨ç­‰å¾…æ–‡ä»¶ä¸Šä¼ æ—¶å°±è¶…æ—¶ï¼ˆå› ä¸º Kong è¦ç­‰ Squid äº¤å®Œè¯·æ±‚å¤´å’Œ body æ‰èƒ½å¤„ç†ï¼‰ã€‚
	â€¢	å¦‚æžœ client_request_buffer_max_size 64Kï¼š
	â€¢	ç”¨æˆ·ä¸Šä¼  50M æ–‡ä»¶æ—¶ï¼ŒSquid åªä¼šåœ¨å†…å­˜é‡Œä¿ç•™ 64K çš„ç‰‡æ®µï¼Œå‰©ä¸‹éƒ¨åˆ†ç›´æŽ¥æµå¼è½¬å‘ç»™ Kongã€‚
	â€¢	è¿™æ · Kong å¯ä»¥ å°½æ—©æ”¶åˆ°è¯·æ±‚å¤´å’Œ Tokenï¼Œé©¬ä¸Šè¿›è¡Œ Token æ ¡éªŒï¼Œè€Œä¸ç”¨ç­‰ 50M ä¸Šä¼ å®Œã€‚
	â€¢	æ–‡ä»¶å¤§å°é™åˆ¶ä»ç„¶ç”± request_body_max_size æŽ§åˆ¶ï¼ˆæ¯”å¦‚ 50M ä»¥å†…å…è®¸ï¼‰ã€‚

ðŸ‘‰ æ‰€ä»¥ è°ƒå° client_request_buffer_max_size å¯ä»¥é¿å…å¤§æ–‡ä»¶è¢« Squid é˜»å¡žï¼Œè®© Token é€»è¾‘æ›´åŠæ—¶ã€‚

â¸»

4. å»ºè®®é…ç½®
```squid.conf
æœ€å¤§å…è®¸ä¸Šä¼ æ–‡ä»¶å¤§å°
request_body_max_size 50 MB

å•æ¬¡å†…å­˜ç¼“å†²å¤§å°ï¼Œè¶…è¿‡éƒ¨åˆ†æµå¼è½¬å‘
client_request_buffer_max_size 64 KB
```
è¿™æ ·ï¼š
	â€¢	æ–‡ä»¶ > 50M â†’ ç›´æŽ¥è¢«æ‹’ç»ï¼ˆç¬¦åˆä¸šåŠ¡è§„åˆ™ï¼‰ã€‚
	â€¢	æ–‡ä»¶ â‰¤ 50M â†’ èµ°æµå¼è½¬å‘ï¼Œé¿å… Squid å¡ä½å¤§æ–‡ä»¶ï¼ŒKong èƒ½å°½å¿«åš Token éªŒè¯ã€‚

â¸»

5. âœ… æ€»ç»“
	â€¢	request_body_max_size = æ–‡ä»¶ä¸Šä¼ å…è®¸çš„ æœ€å¤§å¤§å°ã€‚
	â€¢	client_request_buffer_max_size = å†…å­˜ä¸­æœ€å¤šç¼“å­˜å¤šå°‘ï¼Œè¶…è¿‡å°± è¾¹æ”¶è¾¹è½¬å‘ã€‚
	â€¢	è®¾ç½® client_request_buffer_max_size å¤ªå¤§ï¼ŒSquid å°±ä¼šé˜»å¡žåœ¨æœ¬åœ°ç¼“å†²ï¼Œå¯¼è‡´ Token è¶…æ—¶ã€‚
	â€¢	è®¾ç½®æˆ 64K è¿™ç§è¾ƒå°çš„å€¼ ä¸ä¼šé™åˆ¶æ–‡ä»¶å¤§å°ï¼Œåè€Œèƒ½æé«˜ Token æ’ä»¶çš„å“åº”åŠæ—¶æ€§ã€‚

â¸»



1. å¢žåŠ ä¸€ä¸ªé…ç½® 
   - https://www.squid-cache.org/Doc/config/request_body_max_size/
   - request_body_max_size è¿™ä¸ªæ‰æ˜¯æŽ§åˆ¶ç”¨æˆ·ä¸Šä¼ å¤§å°çš„
```
request_body_max_size = 50MB 

è¿™è§„å®šäº†HTTPè¯·æ±‚ä½“çš„æœ€å¤§å¤§å°ã€‚
æ¢å¥è¯è¯´ï¼Œå°±æ˜¯PUT/POSTè¯·æ±‚çš„æœ€å¤§å¤§å°ã€‚
å¦‚æžœç”¨æˆ·å°è¯•å‘é€çš„è¯·æ±‚ä½“è¶…è¿‡æ­¤é™åˆ¶ï¼Œå°†ä¼šæ”¶åˆ°â€œæ— æ•ˆè¯·æ±‚â€çš„é”™è¯¯ä¿¡æ¯ã€‚
å¦‚æžœå°†æ­¤å‚æ•°è®¾ç½®ä¸ºé›¶ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œåˆ™ä¸ä¼šæ–½åŠ ä»»ä½•é™åˆ¶ã€‚

å¦è¯·å‚é˜…client_request_buffer_max_sizeï¼Œå®ƒæ˜¯å¦ä¸€ç§å¯é…ç½®çš„å¯¹å®¢æˆ·ç«¯ä¸Šä¼ çš„é™åˆ¶ã€‚
```

ä¸‹é¢æ˜¯å¯¹æ‚¨æåˆ°çš„ SQUID é…ç½®é¡¹çš„è¯¦ç»†è§£é‡Šï¼š

### 1. `client_request_buffer_max_size`

**é…ç½®é¡¹:**
```plaintext
client_request_buffer_max_size 64 KB
```

**è§£é‡Š:**
- **ä½œç”¨:** è¯¥é…ç½®é¡¹ç”¨äºŽæŒ‡å®š SQUID åœ¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ—¶ç”¨äºŽå­˜å‚¨è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“çš„ç¼“å†²åŒºçš„æœ€å¤§å¤§å°ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™æ˜¯æŒ‡ä»Žå®¢æˆ·ç«¯è¯·æ±‚ä¸­å®Œå…¨è¯»å–æ•°æ®æ‰€å…è®¸çš„æœ€å¤§å­—èŠ‚æ•°ã€‚
- **å•ä½:** å¯ä»¥ç”¨å­—èŠ‚ï¼ˆBï¼‰ï¼Œåƒå­—èŠ‚ï¼ˆKBï¼‰ï¼Œå…†å­—èŠ‚ï¼ˆMBï¼‰ç­‰å•ä½æ¥è®¾ç½®ï¼Œé»˜è®¤ä¸º 64 KBã€‚
- **å½±å“:** å¦‚æžœè¯·æ±‚å¤´æˆ–è¯·æ±‚ä½“çš„å¤§å°è¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼ŒSQUID å°†ä¼šæ‹’ç»è¯·æ±‚å¹¶è¿”å›žä¸€ä¸ªé”™è¯¯å“åº”ï¼ˆé€šå¸¸æ˜¯ 400 Bad Requestï¼‰ã€‚è®¾ç½®è¿™ä¸ªå€¼å¯ä»¥å¸®åŠ©é˜²æ­¢å®¢æˆ·ç«¯å‘é€è¿‡å¤§çš„è¯·æ±‚ï¼Œå¯¹æœåŠ¡å™¨çš„å†…å­˜èµ„æºé€ æˆåŽ‹åŠ›æˆ–è€…æ¶æ„è¯·æ±‚ã€‚

### 2. `request_body_max_size`

**é…ç½®é¡¹:**
```plaintext
request_body_max_size = 50MB
```

**è§£é‡Š:**
- **ä½œç”¨:** è¯¥é€‰é¡¹å®šä¹‰äº†å®¢æˆ·è¯·æ±‚ä¸»ä½“ï¼ˆrequest bodyï¼‰çš„æœ€å¤§å…è®¸å¤§å°ã€‚è¯·æ±‚ä¸»ä½“é€šå¸¸æ˜¯åœ¨ HTTP POST è¯·æ±‚æˆ–è€… PUT è¯·æ±‚ä¸­åŒ…å«çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæ–‡ä»¶ä¸Šä¼ ã€‚
- **å•ä½:** ä¹Ÿå¯ä»¥ä½¿ç”¨å­—èŠ‚ï¼ˆBï¼‰ï¼Œåƒå­—èŠ‚ï¼ˆKBï¼‰ï¼Œå…†å­—èŠ‚ï¼ˆMBï¼‰ç­‰å•ä½æ¥è®¾ç½®ã€‚æ­¤å¤„è®¾ç½®ä¸º 50MBã€‚
- **å½±å“:** å¦‚æžœå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä½“è¶…è¿‡äº†è¿™ä¸€é™åˆ¶ï¼ŒSQUID ä¼šç«‹å³ä¸­æ­¢è¯·æ±‚å¹¶è¿”å›žé”™è¯¯å“åº”ã€‚è¿™ä¸ªé€‰é¡¹å¯¹äºŽæŽ§åˆ¶ä¸Šä¼ æ–‡ä»¶çš„å¤§å°éžå¸¸æœ‰ç”¨ï¼Œé˜²æ­¢æ¶æ„ç”¨æˆ·åˆ©ç”¨è¿‡å¤§çš„è¯·æ±‚ç ´åæœåŠ¡å™¨ã€‚

### æ€»ç»“

è¿™ä¸¤ä¸ªé…ç½®é¡¹çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†ç¡®ä¿æœåŠ¡å™¨çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼Œé¿å…å¤§è¯·æ±‚ç»™æœåŠ¡å™¨é€ æˆè´Ÿæ‹…æˆ–è¢«ç”¨äºŽæ‹’ç»æœåŠ¡æ”»å‡»ã€‚åœ¨è¿›è¡Œé…ç½®æ—¶ï¼Œæ ¹æ®è‡ªèº«çš„å…·ä½“åº”ç”¨åœºæ™¯å’Œéœ€æ±‚è°ƒæ•´è¿™ä¸¤ä¸ªå‚æ•°æ˜¯ååˆ†é‡è¦çš„ï¼Œä»¥å¹³è¡¡å¯ç”¨æ€§å’Œå®‰å…¨æ€§ã€‚ 

### ç¤ºä¾‹åœºæ™¯
- å¦‚æžœä½ çš„åº”ç”¨ä¸­é€šå¸¸å¤„ç†å°æ–‡ä»¶ä¸Šä¼ ï¼Œå¦‚ç”¨æˆ·å¤´åƒï¼Œåˆ™å¯ä»¥å°† `request_body_max_size` è®¾ç½®ä¸ºç›¸å¯¹è¾ƒå°çš„å€¼ï¼ˆå¦‚ 2MBï¼‰ã€‚
- åœ¨é«˜è´Ÿè½½çŽ¯å¢ƒä¸­åˆç†è®¾ç½® `client_request_buffer_max_size` åˆ™å¯ä»¥é˜²æ­¢æœåŠ¡å› å¤„ç†å¤§é‡å¤§è¯·æ±‚è€Œå´©æºƒã€‚

é€šè¿‡å¯¹è¿™ä¸¤ä¸ªé…ç½®è¿›è¡Œåˆç†è®¾ç½®ï¼Œæ‚¨å¯ä»¥æ›´å¥½åœ°ç®¡ç†å’ŒæŽ§åˆ¶åº”ç”¨æœåŠ¡çš„å®‰å…¨å’Œæ€§èƒ½ã€‚


# nginx é…ç½®

```yaml
location /api/ {
Â  Â  proxy_pass http://squid_backend;
Â  Â  proxy_request_buffering off;
Â  Â  proxy_buffering off;Â 
Â  Â  proxy_http_version 1.1;
Â  Â  proxy_set_header Connection ""; # æ¸…é™¤ Connection headerï¼Œæ”¯æŒé•¿è¿žæŽ¥.éœ€è¦ç”¨æˆ·ç¡®è®¤
Â  Â  client_max_body_size 100m;
Â  Â  proxy_read_timeout 300s;
Â  Â  proxy_send_timeout 300s;
}
```

å¢žåŠ ä¸€ä¸ª proxy_buffering off;

```mermaid

sequenceDiagram

Â  Â  participant Client

Â  Â  participant Nginx

Â  Â  participant Squid

Â  Â  participant KongDP



Â  Â  Client->>+Nginx: POST /upload (æºå¸¦æœ‰æ•ˆToken)

Â  Â  Nginx->>+Squid: æµå¼è½¬å‘è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“...

Â  Â  note over Squid: Squidå¼€å§‹ç¼“å†²æ•´ä¸ªè¯·æ±‚ä½“...

Â  Â  Client-->>Squid: ...æ–‡ä»¶ä¸Šä¼ æŒç»­è¶…è¿‡30ç§’...

Â  Â  note over Squid: æ–‡ä»¶æŽ¥æ”¶å®Œæ¯•!

Â  Â  note right of Client: æ­¤æ—¶Tokenå·²è¿‡æœŸ!

Â  Â  Squid->>+KongDP: è½¬å‘å®Œæ•´è¯·æ±‚

Â  Â  KongDP-->>KongDP: Tokenè®¤è¯æ’ä»¶æ‰§è¡Œ

Â  Â  note over KongDP: è®¤è¯å¤±è´¥ (401 Unauthorized)

Â  Â  KongDP-->>-Squid: è¿”å›ž 401

Â  Â  Squid-->>-Nginx: è¿”å›ž 401

Â  Â  Nginx-->>-Client: è¿”å›ž 401

```

```mermaid

sequenceDiagram

Â  Â  participant Client

Â  Â  participant Nginx

Â  Â  participant Squid

Â  Â  participant KongDP



Â  Â  Client->>+Nginx: POST /upload (æºå¸¦æœ‰æ•ˆToken)

Â  Â  Nginx->>+Squid: æµå¼è½¬å‘ (ç«‹å³)

Â  Â  Squid->>+KongDP: æµå¼è½¬å‘ (ç«‹å³)

Â  Â  note over KongDP: æ”¶åˆ°è¯·æ±‚å¤´, Tokenæœ‰æ•ˆ!

Â  Â  KongDP-->>KongDP: Tokenè®¤è¯æ’ä»¶æ‰§è¡Œ

Â  Â  note over KongDP: è®¤è¯æˆåŠŸ!

Â  Â  note over Client, KongDP: æ–‡ä»¶å†…å®¹åœ¨è®¤è¯åŽæŒç»­æµå¼ä¼ è¾“

Â  Â  KongDP->>GKE Runtime: (to GKE) æµå¼è½¬å‘è¯·æ±‚ä½“...

Â  Â  GKE Runtime-->>KongDP: (from GKE) è¿”å›ž 200 OK

Â  Â  KongDP-->>-Squid: è¿”å›ž 200 OK

Â  Â  Squid-->>-Nginx: è¿”å›ž 200 OK

Â  Â  Nginx-->>-Client: è¿”å›ž 200 OK

```
