# Nginx `proxy_request_buffering` è¯¦è§£

`proxy_request_buffering` æ˜¯ Nginx ä¸­ä¸€ä¸ªè‡³å…³é‡è¦çš„ä»£ç†æŒ‡ä»¤ï¼Œå®ƒå†³å®šäº† Nginx åœ¨å°†å®¢æˆ·ç«¯çš„è¯·æ±‚å‘é€åˆ°ä¸Šæ¸¸ï¼ˆUpstreamï¼‰æœåŠ¡å™¨ä¹‹å‰ï¼Œæ˜¯å¦è¦å®Œæ•´åœ°ç¼“å†²ï¼ˆbufferï¼‰æ•´ä¸ªè¯·æ±‚ä½“ï¼ˆRequest Bodyï¼‰ã€‚

## é»˜è®¤é…ç½®

åœ¨ Nginx ä¸­ï¼Œæ­¤æŒ‡ä»¤çš„é»˜è®¤å€¼æ˜¯ `on`ã€‚

```nginx
# è¯­æ³•: proxy_request_buffering on | off;
# é»˜è®¤: proxy_request_buffering on;
# ä¸Šä¸‹æ–‡: http, server, location
```

é»˜è®¤å¼€å¯æ­¤åŠŸèƒ½ï¼Œæ„å‘³ç€ Nginx ä¼šå…ˆå°†ä»å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„è¯·æ±‚ä½“å®Œæ•´åœ°è¯»å…¥ä¸€ä¸ªç¼“å†²åŒºï¼Œç„¶åå†å°†æ•´ä¸ªè¯·æ±‚ä¸€æ¬¡æ€§å‘é€ç»™åç«¯æœåŠ¡ã€‚

---

## å·¥ä½œæœºåˆ¶ä¸å½±å“

`proxy_request_buffering` çš„å¼€å¯ä¸å…³é—­ï¼Œå¯¹æœåŠ¡å™¨çš„æ€§èƒ½ã€èµ„æºä½¿ç”¨å’Œå®¢æˆ·ç«¯ä½“éªŒæœ‰ç€æˆªç„¶ä¸åŒçš„å½±å“ã€‚

### 1. `proxy_request_buffering on;` (é»˜è®¤è¡Œä¸º)

å½“æŒ‡ä»¤å¼€å¯æ—¶ï¼ŒNginx çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1.  Nginx æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚å¤´ã€‚
2.  Nginx å¼€å§‹æ¥æ”¶è¯·æ±‚ä½“ï¼Œå¹¶å°†å…¶å†™å…¥å†…å­˜ä¸­çš„ç¼“å†²åŒºï¼ˆç”± `client_body_buffer_size` å®šä¹‰ï¼‰ã€‚
3.  å¦‚æœè¯·æ±‚ä½“å¤§å°è¶…è¿‡äº†å†…å­˜ç¼“å†²åŒºï¼ŒNginx ä¼šå°†è¶…å‡ºéƒ¨åˆ†å†™å…¥ä¸€ä¸ªä¸´æ—¶çš„ç£ç›˜æ–‡ä»¶ã€‚
4.  åªæœ‰å½“ Nginx æ¥æ”¶åˆ°**å®Œæ•´**çš„è¯·æ±‚ä½“åï¼Œå®ƒæ‰ä¼šä¸åç«¯ä¸Šæ¸¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå¹¶å°†æ•´ä¸ªè¯·æ±‚ä½“ä¸€æ¬¡æ€§å‘é€è¿‡å»ã€‚
5.  ä¸Šæ¸¸æœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œå¹¶å°†å“åº”è¿”å›ç»™ Nginxï¼ŒNginx å†å°†å“åº”è½¬å‘ç»™å®¢æˆ·ç«¯ã€‚

#### å·¥ä½œæµç¨‹å›¾ (Mermaid)

```mermaid
sequenceDiagram
    participant Client
    participant Nginx
    participant Upstream Server

    Client->>+Nginx: å‘é€è¯·æ±‚ (Request with Body)
    Nginx-->>Nginx: å°†è¯·æ±‚ä½“å®Œæ•´å­˜å…¥ç¼“å†²åŒº (å†…å­˜æˆ–ç£ç›˜)
    Note over Nginx: ç›´åˆ°æ¥æ”¶å®Œæ‰€æœ‰æ•°æ®...
    Nginx->>+Upstream Server: å‘é€å®Œæ•´çš„è¯·æ±‚
    Upstream Server-->>-Nginx: å¤„ç†åè¿”å›å“åº”
    Nginx-->>-Client: è½¬å‘å“åº”
```

#### ä¼˜ç‚¹

-   **ä¿æŠ¤ä¸Šæ¸¸æœåŠ¡å™¨**ï¼šä¸Šæ¸¸æœåŠ¡å™¨åªéœ€å¤„ç†ä¸€ä¸ªå®Œæ•´çš„ã€å¿«é€Ÿçš„è¯·æ±‚ï¼Œè€Œæ— éœ€ç­‰å¾…å¯èƒ½å¾ˆæ…¢çš„å®¢æˆ·ç«¯ç½‘ç»œã€‚è¿™ä½¿å¾—ä¸Šæ¸¸æœåŠ¡å™¨çš„è¿æ¥å¯ä»¥è¢«å¿«é€Ÿå¤„ç†å’Œé‡Šæ”¾ï¼Œæå¤§åœ°æé«˜äº†å…¶ååèƒ½åŠ›å’Œèµ„æºåˆ©ç”¨ç‡ã€‚
-   **æé«˜åç«¯æ•ˆç‡**ï¼šåç«¯æœåŠ¡å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸å¿…å¤„ç†æ…¢é€Ÿç½‘ç»œè¿æ¥å¸¦æ¥çš„å¤æ‚æ€§ã€‚

#### ç¼ºç‚¹

-   **å»¶è¿Ÿå¢åŠ **ï¼šå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œç‰¹åˆ«æ˜¯ä¸Šä¼ å¤§æ–‡ä»¶æ—¶ï¼Œå¿…é¡»ç­‰åˆ°æ•´ä¸ªæ–‡ä»¶ä¸Šä¼ åˆ° Nginx å¹¶è¢«å®Œæ•´æ¥æ”¶åï¼Œåç«¯æœåŠ¡æ‰å¼€å§‹å¤„ç†ã€‚è¿™ä¼šå¢åŠ å®¢æˆ·ç«¯æ„Ÿå—åˆ°çš„â€œé¦–å­—èŠ‚å“åº”æ—¶é—´â€ï¼ˆTime to First Byte, TTFBï¼‰ã€‚
-   **Nginx èµ„æºæ¶ˆè€—**ï¼šå¦‚æœå¹¶å‘ä¸Šä¼ é‡å¾ˆå¤§ï¼Œä¼šæ¶ˆè€— Nginx æœåŠ¡å™¨å¤§é‡çš„å†…å­˜å’Œç£ç›˜ I/Oï¼Œå› ä¸ºæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦ä¸€ä¸ªç¼“å†²åŒºã€‚

### 2. `proxy_request_buffering off;`

å½“æŒ‡ä»¤å…³é—­æ—¶ï¼ŒNginx çš„è¡Œä¸ºä¼šå‘ç”Ÿæ ¹æœ¬æ€§æ”¹å˜ï¼š

1.  Nginx æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚å¤´åï¼Œä¼šç«‹å³ä¸ä¸Šæ¸¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚
2.  Nginx ä¼šä»¥â€œæµå¼â€ï¼ˆStreamingï¼‰çš„æ–¹å¼ï¼Œä¸€è¾¹æ¥æ”¶å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œä¸€è¾¹å°†å…¶åŒæ­¥è½¬å‘ç»™ä¸Šæ¸¸æœåŠ¡å™¨ã€‚è¯·æ±‚ä½“ä¸ä¼šè¢«å®Œæ•´åœ°ä¿å­˜åœ¨ Nginx çš„ç¼“å†²åŒºä¸­ã€‚

#### å·¥ä½œæµç¨‹å›¾ (Mermaid)

```mermaid
sequenceDiagram
    participant Client
    participant Nginx
    participant Upstream Server

    Client->>+Nginx: å¼€å§‹å‘é€è¯·æ±‚ä½“
    Nginx->>+Upstream Server: ç«‹å³å»ºç«‹è¿æ¥å¹¶å¼€å§‹è½¬å‘æ•°æ® (æµå¼)
    Client->>Nginx: ...æŒç»­å‘é€æ•°æ®...
    Nginx->>Upstream Server: ...æŒç»­è½¬å‘æ•°æ®...
    Note over Nginx, Upstream Server: åœ¨æ•´ä¸ªä¸Šä¼ æœŸé—´ï¼Œè¿æ¥è¢«æŒç»­å ç”¨
    Upstream Server-->>-Nginx: å¤„ç†åè¿”å›å“åº”
    Nginx-->>-Client: è½¬å‘å“åº”
```

#### ä¼˜ç‚¹

-   **ä½å»¶è¿Ÿ**ï¼šåç«¯æœåŠ¡å‡ ä¹å¯ä»¥å®æ—¶åœ°æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼Œéå¸¸é€‚åˆéœ€è¦å³æ—¶å¤„ç†æ•°æ®çš„åœºæ™¯ï¼ˆå¦‚æµå¼ä¸Šä¼ ã€å®æ—¶é€šä¿¡ï¼‰ã€‚
-   **å‡å°‘ Nginx èµ„æºæ¶ˆè€—**ï¼šNginx ä¸éœ€è¦ä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…å¤§å—å†…å­˜æˆ–å†™å…¥ç£ç›˜æ–‡ä»¶ï¼Œèµ„æºå ç”¨æ›´å°‘ã€‚

#### ç¼ºç‚¹

-   **å ç”¨ä¸Šæ¸¸æœåŠ¡å™¨è¿æ¥**ï¼šå¦‚æœå®¢æˆ·ç«¯ç½‘ç»œå¾ˆæ…¢ï¼Œé‚£ä¹ˆè¿™ä¸ªæ…¢é€Ÿçš„ä¸Šä¼ è¿‡ç¨‹ä¼šé•¿æ—¶é—´å ç”¨ä¸€ä¸ªå®è´µçš„ä¸Šæ¸¸æœåŠ¡å™¨è¿æ¥ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™å¾ˆå®¹æ˜“è€—å°½ä¸Šæ¸¸æœåŠ¡å™¨çš„å¯ç”¨å·¥ä½œè¿›ç¨‹ï¼ˆWorker Processesï¼‰ï¼Œå¯¼è‡´å…¶æ— æ³•å¤„ç†æ–°çš„è¯·æ±‚ï¼Œä»è€Œé€ æˆæœåŠ¡é˜»å¡ç”šè‡³é›ªå´©ã€‚

---

## é…ç½®ç¤ºä¾‹

ä½ å¯ä»¥åœ¨ `http`, `server`, æˆ– `location` å—ä¸­é…ç½®æ­¤æŒ‡ä»¤ã€‚

```nginx
location /upload {
    # å¯¹äºéœ€è¦å³æ—¶å¤„ç†çš„å¤§æ–‡ä»¶ä¸Šä¼ æˆ–æµå¼ APIï¼Œå»ºè®®å…³é—­
    proxy_request_buffering off;
    proxy_pass http://my_backend;
}

location /api {
    # å¯¹äºæ™®é€šçš„ API è¯·æ±‚ï¼ˆå¦‚ POST JSON æ•°æ®ï¼‰ï¼Œå»ºè®®ä¿æŒé»˜è®¤å¼€å¯
    proxy_request_buffering on;
    proxy_pass http://my_backend;
}
```

## æ€»ç»“ä¸æœ€ä½³å®è·µ

| é…ç½® | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
| :--- | :--- | :--- | :--- |
| **`on` (é»˜è®¤)** | ä¿æŠ¤å’Œè§£æ”¾åç«¯æœåŠ¡ï¼Œæé«˜åç«¯ååé‡ã€‚ | å¢åŠ å®¢æˆ·ç«¯ä¸Šä¼ å»¶è¿Ÿï¼Œæ¶ˆè€— Nginx èµ„æºã€‚ | å¤§å¤šæ•° Web åº”ç”¨ã€API æ¥å£ã€å¸¸è§„æ–‡ä»¶ä¸Šä¼ ã€‚ |
| **`off`** | ä½å»¶è¿Ÿï¼Œæ•°æ®å®æ—¶ä¼ é€’ï¼ŒNginx èµ„æºå ç”¨å°‘ã€‚ | é•¿æ—¶é—´å ç”¨åç«¯è¿æ¥ï¼Œæ˜“å—æ…¢å®¢æˆ·ç«¯æ”»å‡»ã€‚ | è§†é¢‘/éŸ³é¢‘æµå¼ä¸Šä¼ ã€gRPCã€WebSocket ä»£ç†ã€éœ€è¦å®æ—¶å¤„ç†æ•°æ®çš„é•¿è¿æ¥æœåŠ¡ã€‚ |

æ€»çš„æ¥è¯´ï¼Œ`proxy_request_buffering` çš„é»˜è®¤è®¾ç½®ä¸º `on` æ˜¯ä¸€ä¸ªå®‰å…¨ä¸”é«˜æ•ˆçš„é€‰æ‹©ï¼Œå®ƒä¼˜åŒ–äº†åç«¯æœåŠ¡å™¨çš„æ€§èƒ½ã€‚åªæœ‰åœ¨ä½ æ˜ç¡®çŸ¥é“éœ€è¦è¿›è¡Œæµå¼å¤„ç†ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ¥å—å…¶å¯¹åç«¯è¿æ¥å ç”¨çš„å½±å“æ—¶ï¼Œæ‰åº”è¯¥è€ƒè™‘å°†å…¶è®¾ç½®ä¸º `off`ã€‚

---

## åœ¨ Kong ä¸ GKE ç¯å¢ƒä¸‹çš„å»¶ä¼¸æ¢è®¨

åœ¨ `Nginx + Kong DP + GKE Runtime` è¿™æ ·çš„ç°ä»£äº‘åŸç”Ÿæ¶æ„ä¸­ï¼Œå¯¹è¯·æ±‚ç¼“å†²çš„æ§åˆ¶åŒæ ·é‡è¦ï¼Œä½†é…ç½®æ–¹å¼å’Œç†è§£å±‚é¢éœ€è¦ç»“åˆ Kong çš„æŠ½è±¡æ¥è€ƒè™‘ã€‚

### `proxy_request_buffering off` ä¸ `client_body_buffer_size` çš„å…³ç³»

è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„æ··æ·†ç‚¹ã€‚ç®€å•æ¥è¯´ï¼Œ**è¿™ä¸¤ä¸ªæŒ‡ä»¤çš„ä½œç”¨å®Œå…¨ä¸åŒï¼Œä¸èƒ½ç­‰åŒçœ‹å¾…**ã€‚

-   **`proxy_request_buffering`**: è¿™æ˜¯æ§åˆ¶ **ä»£ç†è¡Œä¸ºæ¨¡å¼** çš„â€œæ€»å¼€å…³â€ã€‚`off` æ„å‘³ç€ Nginx æ”¶åˆ°ä»»ä½•è¯·æ±‚ä½“æ•°æ®åï¼Œä¼šç«‹åˆ»å°†å…¶è½¬å‘ç»™åç«¯ï¼ˆæµå¼ï¼‰ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ•´ä¸ªè¯·æ±‚ä½“æ¥æ”¶å®Œæ¯•ã€‚
-   **`client_body_buffer_size`**: è¿™ä¸ªæŒ‡ä»¤å®šä¹‰äº† Nginx ç”¨æ¥ **æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ä½“** çš„åˆå§‹å†…å­˜ç¼“å†²åŒºå¤§å°ã€‚**æ— è®º `proxy_request_buffering` æ˜¯ `on` è¿˜æ˜¯ `off`ï¼Œè¿™ä¸ªç¼“å†²åŒºéƒ½ä¼šè¢«ä½¿ç”¨**ã€‚
    -   å½“ `proxy_request_buffering` ä¸º `on` æ—¶ï¼Œå®ƒæ˜¯ç¼“å†²å®Œæ•´è¯·æ±‚ä½“çš„ç¬¬ä¸€å—å†…å­˜åŒºåŸŸï¼Œå¦‚æœä¸å¤Ÿï¼Œæ•°æ®ä¼šæº¢å‡ºåˆ°ç£ç›˜ã€‚
    -   å½“ `proxy_request_buffering` ä¸º `off` æ—¶ï¼ŒNginx ä¾ç„¶ä½¿ç”¨è¿™ä¸ªç¼“å†²åŒºæ¥ä¸´æ—¶å­˜æ”¾ä»å®¢æˆ·ç«¯æ”¶åˆ°çš„æ•°æ®å—ã€‚ä¸€æ—¦è¿™ä¸ªç¼“å†²åŒºè¢«å¡«æ»¡ï¼ŒNginx å°±ä¼šå°†è¿™éƒ¨åˆ†æ•°æ®â€œåˆ·é€â€ï¼ˆflushï¼‰ç»™åç«¯æœåŠ¡ï¼Œç„¶åæ¸…ç©ºç¼“å†²åŒºç»§ç»­æ¥æ”¶ä¸‹ä¸€å—æ•°æ®ã€‚

**ç»“è®º**ï¼š`proxy_request_buffering off` æ˜¯å¼€å¯æµå¼ä»£ç†çš„**å”¯ä¸€æ­£ç¡®æ–¹å¼**ã€‚å°† `client_body_buffer_size` è®¾ç½®ä¸º `0` å¹¶ä¸èƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œè¿™ä¸ç¬¦åˆ Nginx çš„è®¾è®¡ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶è¡Œä¸ºå¼‚å¸¸æˆ–è‡ªåŠ¨å›é€€åˆ°æŸä¸ªé»˜è®¤çš„æœ€å°ç¼“å†²åŒºå¤§å°ã€‚åœ¨æµå¼æ¨¡å¼ä¸‹ï¼Œ`client_body_buffer_size` å½±å“çš„æ˜¯æ•°æ®å—è½¬å‘çš„â€œç²’åº¦â€ï¼Œè€Œä¸æ˜¯â€œæ˜¯å¦ç¼“å†²â€è¿™ä¸ªè¡Œä¸ºæœ¬èº«ã€‚

**ä¸å†²çªï¼Œä½†ä¸ç­‰åŒï¼›ä¸è¦æŠŠ client_body_buffer_size è®¾ä¸º 0 ä½œä¸ºâ€œå…³é—­å†…å­˜ç¼“å†²â€çš„æ‰‹æ®µ**ã€‚
  

# **ç»“è®ºï¼ˆä¸€å¥è¯ï¼‰**

- proxy_request_buffering off æ§åˆ¶ **æ˜¯å¦æŠŠæ•´ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ä½“ç¼“å­˜åœ¨ Nginx å†ç»Ÿä¸€è½¬å‘ç»™ä¸Šæ¸¸**ï¼ˆoff = ä¸€è¾¹è¯»ä¸€è¾¹è½¬å‘ï¼Œæµå¼è½¬å‘ï¼‰ã€‚
    
- client_body_buffer_size æ§åˆ¶ **Nginx åœ¨å†…å­˜ä¸­ä¸ºè¯»å–å®¢æˆ·ç«¯è¯·æ±‚ä½“åˆ†é…çš„ç¼“å†²åŒºå¤§å°**ï¼›å¦‚æœè¯·æ±‚ä½“è¶…è¿‡è¯¥å¤§å°ï¼Œå‰©ä½™éƒ¨åˆ†ä¼šå†™å…¥ä¸´æ—¶æ–‡ä»¶ã€‚æŠŠå®ƒè®¾ä¸º 0 ä¸æ˜¯å®˜æ–¹ç”¨æ³•ä¸”å¯èƒ½å¼•å‘å¼‚å¸¸ï¼ˆæœ‰äººæŠ¥ 400/å¼‚å¸¸è¡Œä¸ºï¼‰ï¼Œä¸è¦ç”¨ 0 æ¥â€œç¦ç”¨å†…å­˜ç¼“å†²â€ã€‚
    

  

# **ç»†èŠ‚è§£é‡Šï¼ˆè¦ç‚¹å¼ï¼‰**

1. **proxy_request_buffering çš„è¯­ä¹‰**
    
    - onï¼ˆé»˜è®¤ï¼‰ï¼šNginx ä¼šå…ˆæŠŠ**æ•´ä¸ª**è¯·æ±‚ä½“è¯»å®Œï¼ˆå¯èƒ½åœ¨å†…å­˜ä¹Ÿå¯èƒ½è½åˆ°ä¸´æ—¶æ–‡ä»¶ï¼‰ï¼Œç„¶åå†æŠŠè¯·æ±‚äº¤ç»™ upstreamã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ä¸Šæ¸¸å¯ä»¥ç«‹å³æ”¶åˆ°å®Œæ•´çš„è¯·æ±‚ï¼ˆä¾¿äºé‡è¯•/è´Ÿè½½å‡è¡¡ï¼‰ï¼Œåå¤„æ˜¯ä¼šå ç”¨ç£ç›˜/å†…å­˜å¹¶å¢åŠ å»¶è¿Ÿã€‚
        
    - offï¼šNginx ä¸€è¾¹ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®ä¸€è¾¹å‘ upstream è½¬å‘ï¼ˆstreamingï¼‰ã€‚ä¼˜ç‚¹ï¼šä¸éœ€è¦äº‹å…ˆæŠŠå¤§æ–‡ä»¶å…¨éƒ¨å†™åˆ°ç£ç›˜ï¼Œé€‚åˆå¤§æ–‡ä»¶/é•¿æ—¶é—´ä¸Šä¼ ã€‚ç¼ºç‚¹ï¼šä¸€æ—¦å¼€å§‹è½¬å‘å°±ä¸èƒ½å†åˆ‡æ¢åˆ°å…¶ä»– upstreamï¼ˆä¸èƒ½é‡è¯•ï¼‰ï¼›ä¸Šæ¸¸å¿…é¡»èƒ½æ¥å— chunked/æµå¼è¯·æ±‚ã€‚
        
    
2. **client_body_buffer_size çš„è¯­ä¹‰**
    
    - è¿™æ˜¯è¯»å®¢æˆ·ç«¯è¯·æ±‚ä½“æ—¶çš„**å†…å­˜ç¼“å†²åŒºå¤§å°**ï¼ˆå¯ä»¥åœ¨ http/server/location è®¾ç½®ï¼‰ã€‚é»˜è®¤ç­‰äº**ä¸¤é¡µå†…å­˜**ï¼ˆå¸¸è§å¹³å°ä¸º 8k æˆ– 16kï¼‰ã€‚å¦‚æœè¯·æ±‚ä½“ > è¯¥ç¼“å†²åŒºï¼Œåˆ™ Nginx ä¼šæŠŠå‰©ä½™å†™åˆ° client_body_temp_path æŒ‡å®šçš„ä¸´æ—¶æ–‡ä»¶ã€‚
        
    
3. **ä¸ºä»€ä¹ˆä¸è¦ç”¨ client_body_buffer_size 0**
    
    - å®˜æ–¹æ–‡æ¡£æ²¡æœ‰æŠŠ 0 å½“ä½œå…³é—­å†…å­˜ç¼“å†²çš„æ ‡å‡†æ–¹å¼ã€‚ç¤¾åŒº/issue ä¸­æœ‰ç”¨æˆ·æŠŠ 0 è®¾ä¸ºâ€œæƒ³å¼ºåˆ¶å†™å…¥ç£ç›˜â€ï¼Œç»“æœé‡åˆ° 400 æˆ–å…¶ä»–å¼‚å¸¸è¡Œä¸ºçš„æŠ¥å‘Šï¼ˆå®ç°/ç‰ˆæœ¬å·®å¼‚ä¼šå¯¼è‡´ä¸ç¨³å®šï¼‰ã€‚ç”¨ client_body_in_file_only æ‰æ˜¯å¼ºåˆ¶å†™å›ç£ç›˜çš„æ­£ç¡®æ‰‹æ®µï¼ˆä½†è¯¥æŒ‡ä»¤ä¹Ÿæœ‰å‰¯ä½œç”¨ï¼Œè§ä¸‹ï¼‰ã€‚
        
        é‚£ä¹ˆclient_body_buffer_size 0çš„å«ä¹‰æ˜¯ä»€ä¹ˆ?
        å¥½é—®é¢˜ ğŸ‘å®˜æ–¹ **nginx æ–‡æ¡£** å¯¹ client_body_buffer_size çš„è¯´æ˜æ˜¯ï¼š

  

> è®¾ç½®åœ¨è¯»å–å®¢æˆ·ç«¯è¯·æ±‚ä½“æ—¶åˆ†é…çš„ç¼“å†²åŒºå¤§å°ã€‚é»˜è®¤æ˜¯ä¸¤é¡µå†…å­˜ï¼ˆé€šå¸¸æ˜¯ 8k æˆ– 16kï¼‰ã€‚å¦‚æœè¯·æ±‚ä½“å¤§äºè¿™ä¸ªå€¼ï¼Œåˆ™å¤šä½™éƒ¨åˆ†ä¼šå†™åˆ° client_body_temp_pathã€‚

> ï¼ˆæ–‡æ¡£é‡Œæ²¡æœ‰æåˆ° 0 æ˜¯åˆæ³•å–å€¼ï¼‰

---

### **é‚£ä¹ˆ**Â ### **client_body_buffer_size 0**

### Â **åˆ°åº•æ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿ**

1. **ä¸æ˜¯æ ‡å‡†è¯­ä¹‰**
    
    - åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œ0 æ²¡æœ‰æ˜ç¡®è¯´æ˜ä»£è¡¨ä»€ä¹ˆï¼Œä¹Ÿæ²¡æœ‰â€œå…³é—­å†…å­˜ç¼“å†²â€çš„è¯´æ³•ã€‚
        
    - ä¸åŒç‰ˆæœ¬çš„ Nginx/OpenResty/Ingress Controllerï¼Œ0 å¯èƒ½ä¼šè¢«å½“æˆéæ³•å€¼ï¼Œæˆ–è€…è¢«è§£ææˆ **0 å­—èŠ‚å†…å­˜ç¼“å†²**ã€‚
        
    
2. **å¯èƒ½çš„å®ç°é€»è¾‘ï¼ˆæºç å±‚é¢ï¼‰**
    
    - Nginx åœ¨åˆ†é…è¯·æ±‚ä½“ç¼“å†²åŒºæ—¶ä¼šè°ƒç”¨ ngx_parse_size()ï¼Œ0 å°±æ˜¯â€œ0 å­—èŠ‚â€ã€‚
        
    - è¿™æ„å‘³ç€ **æ²¡æœ‰å†…å­˜ç¼“å†²**ï¼Œä¸€æ—¦è¯»åˆ°æ•°æ®å°±ç«‹åˆ»å†™å…¥ client_body_temp_path çš„ä¸´æ—¶æ–‡ä»¶ã€‚
        
    - è¿™ä¸æ˜¯è®¾è®¡ä¸Šçš„å¸¸è§„ç”¨æ³•ï¼Œå®é™…è¿è¡Œä¸­æœ‰ç”¨æˆ·åé¦ˆä¼šå¯¼è‡´ 400 Bad Request æˆ–è€… Nginx æ— æ³•æ­£å¸¸å¤„ç†è¯·æ±‚ä½“ã€‚
        
    
3. **ç¤¾åŒºåé¦ˆï¼ˆç»éªŒï¼‰**
    
    - ä¸€äº›ç”¨æˆ·æƒ³é€šè¿‡ client_body_buffer_size 0 æ¥â€œå¼ºåˆ¶å…¨éƒ¨å†™å…¥ç£ç›˜â€ï¼Œç»“æœé‡åˆ°å¼‚å¸¸ã€‚
        
    - æ­£ç¡®çš„æ–¹å¼æ˜¯ç”¨ [client_body_in_file_only](http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_in_file_only) æ¥å¼ºåˆ¶å†™æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç”¨ 0ã€‚
        
    

---

### **å°ç»“**

- client_body_buffer_size 0 â‰ˆ **0 å­—èŠ‚å†…å­˜ç¼“å†²**ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰è¯·æ±‚ä½“æ•°æ®ç›´æ¥è½ç›˜ï¼Œä¸èµ°å†…å­˜ã€‚
    
- ä½†è¿™ä¸æ˜¯å®˜æ–¹æ¨èæ–¹å¼ï¼Œå®¹æ˜“å‡ºé—®é¢˜ã€‚
    
- å¦‚æœç¡®å®æƒ³é¿å…å†…å­˜ç¼“å†²ï¼Œè¯·ç”¨ï¼š
    

```
client_body_in_file_only on;
```

è€Œä¸æ˜¯ client_body_buffer_size 0ã€‚

---

è¦ä¸è¦æˆ‘å¸®ä½ æŠŠ **â€œclient_body_buffer_size çš„å‡ ç§ä¸åŒé…ç½®å€¼å«ä¹‰å¯¹æ¯”è¡¨æ ¼â€**ï¼ˆæ¯”å¦‚ 0 / 8k / 1m / å¾ˆå¤§å€¼ï¼‰æ•´ç†å‡ºæ¥ï¼Ÿè¿™æ ·ä½ åœ¨æ–‡æ¡£é‡Œä¹Ÿèƒ½ä¸€çœ¼çœ‹æ˜ç™½ä¸åŒå–å€¼çš„å®é™…æ•ˆæœã€‚
    
4. **chunkedï¼ˆTransfer-Encoding: chunkedï¼‰ çš„é™·é˜±**
    
    - å¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨ chunked ä¼ è¾“ï¼ŒNginx åœ¨æŸäº›æƒ…å†µä¸‹ä»ç„¶ä¼šç¼“å­˜è¯·æ±‚ä½“ï¼Œ**é™¤é**ä½ åŒæ—¶ä¸º proxy è®¾ç½® proxy_http_version 1.1ï¼ˆå¹¶ä¿è¯ä¸Šæ¸¸èƒ½å¤„ç† chunkedï¼‰ï¼›å¦åˆ™ chunked è¯·æ±‚å¸¸è¢«å†™å…¥ä¸´æ—¶æ–‡ä»¶æˆ–å¯¼è‡´ buffering è¡Œä¸ºä¸åŒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šproxy_request_buffering off + chunked è¯·æ±‚æ—¶éœ€è¦é¢å¤–æ³¨æ„ proxy_http_versionã€‚
        
    
5. **client_body_in_file_only**ï¼ˆå¦‚æœä½ ç¡®å®è¦â€œåªå†™æ–‡ä»¶â€ï¼‰
    
    - è¯¥æŒ‡ä»¤å¯ä»¥å¼ºåˆ¶æŠŠè¯·æ±‚ä½“å†™å…¥æ–‡ä»¶ï¼ˆç”¨äºè°ƒè¯•æˆ–ç‰¹æ®Šåœºæ™¯ï¼‰ï¼Œä½†ä¼šä¿ç•™ä¸´æ—¶æ–‡ä»¶ï¼ˆon ä¼šä¿ç•™ï¼Œclean å¯æ¸…ç†ï¼‰ï¼Œå¹¶ä¸”å¯èƒ½å½±å“ä½ å¦‚ä½•æŠŠ body äº¤ç»™ upstreamï¼ˆéœ€ç”¨ $request_body_file ç­‰æˆ–è°ƒæ•´ proxy_pass_request_bodyï¼‰ã€‚ä¸æ˜¯æ™®é€šç”Ÿäº§åœºæ™¯ä¸‹ç”¨æ¥â€œèŠ‚çœå†…å­˜â€çš„é¦–é€‰ã€‚
        
    

  

# **å®é™…é…ç½®ç¤ºä¾‹ï¼ˆç›´æ¥å¯å¤åˆ¶ï¼‰**

```
# 1) æ¨èï¼šæµå¼ä¸Šä¼ åˆ° upstreamï¼ˆå‡å°‘ Nginx IO / disk ä¸´æ—¶æ–‡ä»¶ï¼‰
location /upload {
    proxy_pass http://backend;
    proxy_request_buffering off;       # ä¸€è¾¹è¯»ä¸€è¾¹å‘ç»™ upstream
    proxy_http_version 1.1;            # æ”¯æŒ chunked è½¬å‘åˆ° upstream
    client_body_buffer_size 16k;       # å°ç¼“å†²å³å¯ï¼ˆé»˜è®¤é€šå¸¸ 8k/16kï¼‰
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
}
```

ï¼ˆè¯´æ˜ï¼šé€‚ç”¨äº upstream èƒ½æµå¼æ¥æ”¶å¹¶æ”¯æŒ chunked çš„åœºæ™¯ï¼›æ³¨æ„è¶…æ—¶ã€ä¸Šæ¸¸å…¼å®¹æ€§ï¼‰

```
# 2) å¦‚æœä½ æƒ³å¼ºåˆ¶å†™å…¥ç£ç›˜ï¼ˆè°ƒè¯•æˆ–ç‰¹æ®Šåœºæ™¯ï¼‰ï¼Œä½¿ç”¨å®˜æ–¹æŒ‡ä»¤
location /upload2 {
    client_body_in_file_only on;       # å¼ºåˆ¶å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ˆä¼šä¿ç•™ï¼‰
    client_body_temp_path /var/nginx/client_body_temp;
    proxy_pass http://backend;
    # æ³¨æ„ï¼šæ­¤æ¨¡å¼ä¸‹ï¼Œå¤„ç†ä¸´æ—¶æ–‡ä»¶ã€æƒé™å’Œæ¸…ç†éå¸¸é‡è¦
}
```

```
# 3) ä¸è¦è¿™æ ·åšï¼ˆç¤ºä¾‹ï¼šé¿å…ï¼‰
# client_body_buffer_size 0;   # ä¸æ¨èï¼šæœªè¢«å®˜æ–¹è¯´æ˜ä¸ºâ€œåˆæ³•â€å…³é—­æ–¹å¼ï¼Œå¯èƒ½å¯¼è‡´å¼‚å¸¸
```

# **å¿«é€Ÿå†³ç­–è¡¨ï¼ˆä¸‰å¥è¯ï¼‰**

- æƒ³**ç«‹å³æŠŠä¸Šä¼ çš„æ¯ä¸€å—è½¬å‘åˆ°ä¸Šæ¸¸**ï¼šproxy_request_buffering off + proxy_http_version 1.1ï¼Œå¹¶ç¡®ä¿ä¸Šæ¸¸æ”¯æŒæµå¼ï¼ˆchunkedï¼‰ã€‚
    
- æƒ³**å‡å°‘å†…å­˜ä¸´æ—¶å ç”¨ä½†ä¸ç ´åæ­£å¸¸ä¼ é€’**ï¼šæŠŠ client_body_buffer_size è®¾å°ï¼ˆæ¯”å¦‚ 8k æˆ– 16kï¼‰ï¼Œè®©å¤§ä½“å†™åˆ° tmp æ–‡ä»¶ï¼›ä¸è¦è®¾ 0ã€‚
    
- è¦**å¼ºåˆ¶å†™ç›˜ä¸”ç”¨åˆ° $request_body_file**ï¼šä½¿ç”¨ client_body_in_file_onlyï¼ˆå¹¶å¤„ç†ä¸´æ—¶æ–‡ä»¶ï¼‰ã€‚
    

  

# **å°æç¤º & é£é™©**

- æµå¼ï¼ˆproxy_request_buffering offï¼‰**ä¼šé™ä½ Nginx åœ¨ä¸Šæ¸¸æ•…éšœæ—¶é‡è¯•çš„èƒ½åŠ›**ï¼ˆå› ä¸ºå·²ç»å¼€å§‹å‘é€ bodyï¼Œä¸èƒ½å®‰å…¨åˆ‡æ¢åˆ°åˆ«çš„ upstreamï¼‰ã€‚
    
- å¦‚æœä¸Šæ¸¸æ˜¯ HTTP/1.0 æˆ–ä¸æ”¯æŒ chunkedï¼Œä½ å¯èƒ½å¿…é¡»ä¿è¯ proxy_http_version 1.1 ä¸”ä¸Šæ¸¸èƒ½å¤„ç†ï¼›å¦åˆ™ Nginx ä»ä¼šåš buffering æˆ–å¤±è´¥ã€‚
    
- ç›‘æ§ client_body_temp_path çš„ç£ç›˜ä½¿ç”¨ï¼Œé¿å…ä¸´æ—¶æ–‡ä»¶å †ç§¯ã€‚
    
- å„ Nginx ç‰ˆæœ¬/patchï¼ˆä¾‹å¦‚ OpenResty / Kong / ingress-nginxï¼‰åœ¨å®ç°ç»†èŠ‚ä¸Šå¯èƒ½æœ‰å·®å¼‚ï¼Œéƒ¨ç½²å‰è¯·åœ¨ç›®æ ‡ç‰ˆæœ¬åšå°è§„æ¨¡éªŒè¯ã€‚
    

  

# **å¸®ä½ å¿«é€Ÿå¯è§†åŒ–ï¼ˆmermaidï¼‰**

```
graph LR
  Client -->|POST body| Nginx
  Nginx -->|<= client_body_buffer_size| MemoryBuffer
  Nginx -->|> client_body_buffer_size| TempFile
  MemoryBuffer -->|proxy_request_buffering on| BufferThenSend[ç¼“å†²åå†é€ upstream]
  MemoryBuffer -->|proxy_request_buffering off| StreamToUpstream[ä¸€è¾¹è¯»ä¸€è¾¹å‘ upstream]
  TempFile --> Upstream[Upstream ç”± Nginx è¯»å–å¹¶å‘é€]
```

---

éœ€è¦æˆ‘å¸®ä½ åŸºäºä½ å½“å‰çš„ Nginx ç‰ˆæœ¬ï¼ˆæˆ– Ingress/Kong å˜ä½“ï¼‰æŠŠä¸Šé¢çš„é…ç½®å†™æˆå®Œæ•´ server {} é…ç½®å¹¶åˆ—å‡ºæµ‹è¯•æ­¥éª¤ä¸æ³¨æ„ç‚¹å—ï¼Ÿå¦‚æœç»™æˆ‘ä½ ç°åœ¨çš„ Nginx ç‰ˆæœ¬ / æ˜¯ä¸æ˜¯åœ¨ k8s ingress / Kong ä¹‹ç±»çš„ç¯å¢ƒé‡Œï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™å‡ºæ›´ç²¾ç¡®çš„é…ç½®ç‰‡æ®µã€‚

### åœ¨ Kong Gateway (DP) ä¸­çš„é…ç½®

åœ¨ä½ çš„æ¶æ„ä¸­ï¼Œè¯·æ±‚é¦–å…ˆåˆ°è¾¾ Nginxï¼ˆå¯èƒ½ä½œä¸ºå››å±‚è´Ÿè½½å‡è¡¡å™¨ï¼‰ï¼Œç„¶åè¿›å…¥ Kong æ•°æ®å¹³é¢ï¼ˆDPï¼‰ï¼Œæœ€åç”± Kong ä»£ç†åˆ° GKE ä¸­è¿è¡Œçš„åç«¯æœåŠ¡ã€‚ä½ åº”å½“åœ¨ Kong çš„å±‚é¢è¿›è¡Œé…ç½®ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹åº•å±‚çš„ Nginx é…ç½®æ–‡ä»¶ã€‚

Kong å·²ç»å°† `proxy_request_buffering` æŠ½è±¡ä¸ºä¸€ä¸ªç®€å•çš„å¸ƒå°”é…ç½®ã€‚ä½ å¯ä»¥åœ¨ Kong çš„ **Service** å¯¹è±¡ä¸Šè¿›è¡Œè®¾ç½®ã€‚

-   `request_buffering: true` (é»˜è®¤å€¼) -> å¯¹åº” Nginx çš„ `proxy_request_buffering on;`
-   `request_buffering: false` -> å¯¹åº” Nginx çš„ `proxy_request_buffering off;`

#### Kong for Kubernetes (Ingress Controller) é…ç½®ç¤ºä¾‹

å¦‚æœä½ ä½¿ç”¨ Kong Ingress Controller åœ¨ GKE ä¸­ç®¡ç†æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ `KongIngress` è‡ªå®šä¹‰èµ„æºæˆ–ç›´æ¥åœ¨ Service çš„æ³¨è§£ä¸­å®ç°ã€‚æ›´æ¨èçš„æ–¹å¼æ˜¯ç›´æ¥é…ç½® Service æœ¬èº«ã€‚

è¿™æ˜¯ä¸€ä¸ªé€šè¿‡ `annotations` åœ¨ Kubernetes Service ä¸Šç¦ç”¨è¯·æ±‚ç¼“å†²çš„ä¾‹å­ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-streaming-app
  annotations:
    # é€šè¿‡æ³¨è§£å°† Kong çš„ request_buffering è®¾ç½®ä¸º false
    konghq.com/request-buffering: "false" 
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: my-streaming-app
```

å½“ Kong Ingress Controller å¤„ç†è¿™ä¸ª Service æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨åœ¨ç”Ÿæˆçš„ Nginx é…ç½®ä¸­ä¸ºå¯¹åº”çš„ `upstream` è®¾ç½® `proxy_request_buffering off;`ã€‚

### æ¶æ„æ€»ç»“ä¸å»ºè®®

| å±‚æ¬¡ | å…³æ³¨ç‚¹ | æ¨èé…ç½® | æ•ˆæœ |
| :--- | :--- | :--- | :--- |
| **Client** | å‘èµ·æµå¼è¯·æ±‚ | (ä¾‹å¦‚ï¼šä¸Šä¼ å¤§æ–‡ä»¶) | - |
| **Nginx (L4 LB)** | TCP è´Ÿè½½å‡è¡¡ | `proxy_protocol` (å¯é€‰) | å°†æµé‡è½¬å‘åˆ° Kong DP èŠ‚ç‚¹ï¼Œå¯é€‰ä¼ é€’çœŸå®å®¢æˆ·ç«¯ IPã€‚ |
| **Kong DP** | **æ ¸å¿ƒé…ç½®å±‚** | åœ¨ Kong Service è®¾ç½® `request_buffering: false` | **å®ç°æµå¼ä»£ç†çš„å…³é”®**ã€‚Kong DP ä¸ä¼šç¼“å†²æ•´ä¸ªè¯·æ±‚ä½“ã€‚ |
| **GKE Runtime** | åç«¯ä¸šåŠ¡é€»è¾‘ | èƒ½å¤Ÿå¤„ç†æµå¼è¯·æ±‚ | æœåŠ¡å¯ä»¥å®æ—¶å¤„ç†ä¼ å…¥çš„æ•°æ®æµã€‚ |

ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨ `Nginx + Kong DP + GKE` æ¶æ„ä¸­æƒ³è¦å®ç°æµå¼ã€ä½å»¶è¿Ÿçš„è¯·æ±‚è½¬å‘ï¼Œæ­£ç¡®çš„åšæ³•æ˜¯åœ¨ Kong çš„ Service å®šä¹‰ä¸­æ˜ç¡®è®¾ç½® **`request_buffering: false`**ã€‚ä½ ä¸éœ€è¦ï¼Œä¹Ÿä¸åº”è¯¥å°è¯•é€šè¿‡è®¾ç½® `client_body_buffer_size: 0` æ¥è¾¾åˆ°æ­¤ç›®çš„ã€‚