# Complete Squid Configuration for Multi-Proxy Egress Solution
# Based on the requirements from squid-egress-mult.md

# Define the port Squid listens on for client requests
http_port 3128

# Define ACLs for different service providers/domains
acl azure_services dstdomain .azure.com user-ai-api.azure.com
acl microsoft_services dstdomain .microsoftonline.com login.microsoftonline.com www.office.com
acl aws_services dstdomain .amazonaws.com
acl google_services dstdomain .googleapis.com
acl internal_network src 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12

# Define cache peers for different proxy types
# Azure direct proxy
cache_peer azure-proxy.internal:3128 parent 80 1 no-query name=azure-peer

# Microsoft direct proxy  
cache_peer microsoft-proxy.internal:3128 parent 80 1 no-query name=microsoft-peer

# Blue-Coat gateway for AWS and Google services
cache_peer bluecoat-gateway.internal:8080 parent 80 1 no-query name=bluecoat-peer

# External proxy for other services
cache_peer external-proxy.internal:3128 parent 80 1 no-query name=external-peer

# Route requests to appropriate peers based on domain
cache_peer_access azure-peer allow azure_services
cache_peer_access microsoft-peer allow microsoft_services
cache_peer_access bluecoat-peer allow aws_services
cache_peer_access bluecoat-peer allow google_services
cache_peer_access external-peer allow all

# Block all other requests from going to peers (security measure)
cache_peer_access azure-peer deny all
cache_peer_access microsoft-peer deny all
cache_peer_access bluecoat-peer deny all
cache_peer_access external-peer deny all

# Ensure requests matching specific ACLs go through proxies, not directly
never_direct allow azure_services
never_direct allow microsoft_services
never_direct allow aws_services
never_direct allow google_services

# Allow internal network access
http_access allow internal_network

# Allow access based on domain ACLs
http_access allow azure_services
http_access allow microsoft_services
http_access allow aws_services
http_access allow google_services

# Deny all other access (security measure)
http_access deny all

# Additional configuration options for performance and security
cache_mgr admin@company.com
visible_hostname squid-proxy
cache_effective_user squid
cache_effective_group squid

# Logging configuration
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log