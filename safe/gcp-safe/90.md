ä¸‹é¢æ•´ç†äº† GKE ä¸­â€œå¦‚ä½•å¼ºåˆ¶æ‰§è¡Œå®¹å™¨å®‰å…¨æ ‡å‡†â€ä»¥åŠå“ªäº›å®˜æ–¹æœºåˆ¶å¯ç”¨äºå¼ºåˆ¶é™åˆ¶å’Œå‡ºç¤ºè¯æ®ï¼Œå¹¶é™„ä¸Šå…·ä½“çš„æ–‡æ¡£å‡ºå¤„ï¼Œå¯ç”¨äºå®¡è®¡å’Œè¯æ˜ã€‚

â¸»

âœ… 1. åˆ©ç”¨ ç»„ç»‡ç­–ç•¥ï¼ˆOrganization Policyï¼‰ å¼ºåˆ¶æ‰§è¡Œå®‰å…¨è®¾ç½®ï¼ˆå®˜æ–¹æ”¯æŒï¼‰

GKE æä¾› Organization Policy Service ï¼Œå¯ä»¥åœ¨ç»„ç»‡/æ–‡ä»¶å¤¹/é¡¹ç›®çº§åˆ«å¼ºåˆ¶æ‰§è¡Œå®‰å…¨æœ€ä½³å®è·µï¼Œæ¯”å¦‚ï¼š

ğŸ¯ å¼ºåˆ¶ç¦ç”¨ä¸å®‰å…¨è®¾å®š
â€¢ ç¦ç”¨ kubelet åªè¯»ç«¯å£ï¼ˆ10255ï¼‰
â€¢ å¼ºåˆ¶è®¾ç½®èŠ‚ç‚¹é•œåƒä¸º Container-Optimized OS
â€¢ å¼ºåˆ¶å¯ç”¨è¯¸å¦‚ Shielded GKE Nodes æˆ–é™åˆ¶ ServiceAccount ä½¿ç”¨ç­‰é¡¹

è¿™äº›æœºåˆ¶é€šè¿‡ managed constraintsï¼ˆå—ç®¡ç†çº¦æŸï¼‰æ¥ç»Ÿä¸€å¼ºåˆ¶æ‰§è¡Œã€‚
ä½ å¯ä»¥åœ¨ç»„ç»‡ç­–ç•¥é¡µé¢æŸ¥çœ‹ç›¸å…³è®¾ç½®å¹¶å¯¼å‡ºé…ç½®ï¼Œä½œä¸ºå®¡è®¡â€œè¯æ®â€ã€‚ ï¿¼

ğŸ“Œ å®˜æ–¹ä¾‹å­ â€”â€” å¼ºåˆ¶ç¦ç”¨ä¸å®‰å…¨ kubelet åªè¯»ç«¯å£ï¼š
è¿™ä¸ªç­–ç•¥é€šè¿‡è‡ªå®šä¹‰çº¦æŸæˆ–ç»„ç»‡ç­–ç•¥å®ç°ï¼Œå½“ç”¨æˆ·åˆ›å»º/æ›´æ–°é›†ç¾¤æ—¶å¦‚æœå¯ç”¨äº†ä¸å®‰å…¨ç«¯å£ï¼Œåˆ™æ‹’ç»æ“ä½œã€‚ ï¿¼

ğŸ“Œ å®˜æ–¹è¯´æ˜ â€”â€” ä½¿ç”¨ç»„ç»‡ç­–ç•¥å¼ºåˆ¶å®‰å…¨æœ€ä½³å®è·µï¼š
Google å»ºè®®ä½¿ç”¨ Organization Policy å¯¹é›†ç¾¤å’Œå·¥ä½œè´Ÿè½½å®‰å…¨å®è·µè¿›è¡Œç»Ÿä¸€çš„ç»„ç»‡çº§æ§åˆ¶ã€‚ ï¿¼

â¸»

âœ… 2. ä½¿ç”¨ Policy Controller å¼ºåˆ¶ Runtime å®‰å…¨è§„åˆ™

Policy Controller æ˜¯ä¸€ä¸ªåœ¨ GKE ä¸Šå¯ç”¨çš„ å‡†å…¥æ§åˆ¶å™¨ï¼ˆAdmission Controllerï¼‰ï¼Œå¯ï¼š
â€¢ å¯¹ Kubernetes èµ„æºç”³è¯·è¿›è¡Œç­–ç•¥éªŒè¯
â€¢ å¼ºåˆ¶æ‰§è¡Œ Pod Security Standardsï¼ˆPSSï¼‰
â€¢ éƒ¨ç½²ç°æœ‰ç­–ç•¥åº“ï¼ˆå¦‚ Policy Essentials æˆ– Pod Security FP/Baseline/Restrictedï¼‰
â€¢ æä¾›å®¡è®¡æ¨¡å¼å’Œå¼ºåˆ¶æ¨¡å¼

Policy Controller æºäº Gatekeeper / OPA é¡¹ç›®ï¼ŒGoogle æä¾›é»˜è®¤çš„ç­–ç•¥åº“ï¼Œå¯ç”¨äº enforce CIS/å®‰å…¨æ ‡å‡†ã€‚ ï¿¼

ğŸ“Œ ç¤ºä¾‹çº¦æŸï¼š
ä½ å¯ä»¥éƒ¨ç½² PSS Baseline çº¦æŸé›†ï¼Œç¦æ­¢ç‰¹æƒå®¹å™¨ã€ç¦æ­¢ hostNamespaceã€å¼ºåˆ¶ seccomp/profile ç­‰ã€‚
è¿™äº›çº¦æŸä¼šåœ¨ Policy Controller Dashboard å’Œçº¦æŸçŠ¶æ€ä¸­æ˜¾ç¤ºè¿åæƒ…å†µï¼Œä½œä¸ºåˆè§„è¯æ®ã€‚ ï¿¼

â¸»

âœ… 3. ä½¿ç”¨ Pod Security Admission åŸç”Ÿæ§åˆ¶æ ‡å‡†

è‡ª Kubernetes 1.25 èµ·ï¼ŒPod Security Admission æ§åˆ¶å™¨æˆä¸ºå†…ç½®æœºåˆ¶ï¼Œå¯ç›´æ¥è®¾ç½® Namespace çº§åˆ«çš„å®‰å…¨æ ‡å‡†ï¼ˆæ¯”å¦‚ baseline / restrictedï¼‰ï¼Œå¯¹æ‰€æœ‰ Pods å¼ºåˆ¶å®æ–½æœ€ä½å®‰å…¨æ ‡å‡†ã€‚

è¿™ä¹Ÿæ˜¯ GKE å®˜æ–¹æ–‡æ¡£æ¨èçš„å¼ºåˆ¶å®¹å™¨å®‰å…¨ç­–ç•¥æ–¹å¼ä¹‹ä¸€ã€‚ ï¿¼

â¸»

ğŸ“Œ å¦‚ä½•æ”¶é›†â€œè¯æ®â€è¯æ˜å¼ºåˆ¶æ‰§è¡Œç­–ç•¥

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–â€œå¯å±•ç¤ºç»™å®¡è®¡æˆ–å®‰å…¨å›¢é˜Ÿâ€çš„è¯æ®ï¼š

âœ… 1) ç»„ç»‡ç­–ç•¥é…ç½®ï¼ˆOrganization Policyï¼‰

åœ¨ Google Cloud æ§åˆ¶å° â†’ Organization Policies â†’ å¯¼å‡ºå½“å‰ç­–ç•¥
ä¾‹å¦‚ï¼š
â€¢ æ˜¯å¦å¯ç”¨ constraints/container.managed.disableInsecureKubeletReadOnlyPort
â€¢ æ˜¯å¦å¼ºåˆ¶ Container-Optimized OS é•œåƒ
è¿™ç±»å¯¼å‡ºé…ç½®æ–‡ä»¶å¯ä»¥ç›´æ¥ä¸Šä¼ ç»™å®¡è®¡æ–¹ã€‚

â¸»

âœ… 2) Policy Controller çº¦æŸçŠ¶æ€ï¼ˆConstraint Statusï¼‰

è¿è¡Œå¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹çº¦æŸåŠè¿è§„è¯¦æƒ…ï¼š

# æŸ¥çœ‹ç‰¹å®šç­–ç•¥çº¦æŸçŠ¶æ€

kubectl get constraint -o wide

# æŸ¥çœ‹è¿åè¯¦æƒ…

kubectl get constraint -o json | jq '.items[] | {name: .metadata.name, violations: .status.totalViolations}'

è¿™äº›è¾“å‡ºå¯ä»¥ä½œä¸ºç­–ç•¥æ‰§è¡Œæ•ˆæœçš„è¯æ®ã€‚

â¸»

âœ… 3) PodSecurity æ ‡å‡†å®æ–½ç»“æœ

è®¾ç½® PodSecurity Admission åï¼š

kubectl get pods --all-namespaces -o custom-columns=NAME:.metadata.name,PSP:.metadata.annotations.pod-security\.kubernetes\.io/enforce

å¯ä»¥çœ‹åˆ°å“ªäº› Namespace å·²å¯ç”¨ baseline/restricted ç­‰ç­–ç•¥ã€‚

â¸»

ğŸ§¾ å®˜æ–¹å‚è€ƒæ–‡æ¡£é“¾æ¥ï¼ˆå¯ç”¨äºåˆè§„æŠ¥å‘Šï¼‰

ğŸ”— Policy Controller ä½¿ç”¨çº¦æŸï¼ˆPod Security / Policy Essentials ç­‰ï¼‰
https://docs.cloud.google.com/kubernetes-engine/enterprise/policy-controller/docs/how-to/using-constraints-to-enforce-pod-security ï¿¼

ğŸ”— ç»„ç»‡ç­–ç•¥ Service ç”¨äºå®‰å…¨æœ€ä½³å®è·µ
https://docs.cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster ï¿¼

ğŸ”— è‡ªå®šä¹‰ç»„ç»‡çº¦æŸç®¡ç†
https://docs.cloud.google.com/kubernetes-engine/docs/how-to/custom-org-policies ï¿¼

â¸»

ğŸ“Œ æ€»ç»“

å¼ºåˆ¶æ‰‹æ®µ ä½œç”¨ è·å–è¯æ®æ‰‹æ®µ
Organization Policy åœ¨ç»„ç»‡/é¡¹ç›®çº§åˆ«å¼ºåˆ¶ç¦ç”¨ä¸å®‰å…¨è®¾ç½® å¯¼å‡ºç»„ç»‡ç­–ç•¥é…ç½®ï¼ˆJSON/YAMLï¼‰
Policy Controller å¯¹å·¥ä½œè´Ÿè½½ç”Ÿå‘½å‘¨æœŸå¼ºåˆ¶ç­–ç•¥æ‰§è¡Œ Constraint çŠ¶æ€è¾“å‡ºã€Dashboard
PodSecurity Admission å¼ºåˆ¶ Pod å®‰å…¨æ ‡å‡† Namespace æ³¨é‡Š / Pod å…ƒæ•°æ®

â¸»

å¦‚éœ€ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥æä¾› å…·ä½“çš„å®¡è®¡æŠ¥å‘Šæ¨¡æ¿ï¼ˆJSON/Markdown æ ¼å¼ï¼‰ï¼Œæ¶µç›–è¿™äº›ç­–ç•¥çš„æ£€æŸ¥å‘½ä»¤å’Œè¾“å‡ºæ ·ä¾‹ï¼Œå¯ä¾›ç›´æ¥ç”¨äºåˆè§„æ–‡æ¡£ã€‚
