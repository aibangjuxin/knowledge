ä½ çš„ä¸¤ä¸ªé—®é¢˜éƒ½éå¸¸å…³é”®ï¼Œæ¶‰åŠ Terraform çš„æ ¸å¿ƒè¿è¡Œæœºåˆ¶ï¼š**çŠ¶æ€è½®è¯¢ä¸èµ„æºä¾èµ–çš„é”€æ¯é¡ºåº**ã€‚æˆ‘æ¥åˆ†åˆ«è¯´æ˜ã€‚

---

## **ğŸ”„ ç¬¬ä¸€éƒ¨åˆ†ï¼šTerraform ä¸ºä»€ä¹ˆè¦è½®è¯¢æ“ä½œçŠ¶æ€ï¼Ÿ**

  

Terraform åœ¨ç®¡ç† GCP èµ„æºï¼ˆç‰¹åˆ«æ˜¯ä¸€äº›å¼‚æ­¥åˆ›å»ºçš„èµ„æºï¼Œå¦‚ google_network_security_server_tls_policyï¼‰æ—¶ï¼Œä¼šé€šè¿‡ **è½®è¯¢ GCP çš„ long-running operations** æ¥å£ï¼Œæ¥ç¡®è®¤èµ„æºåˆ›å»ºæ˜¯å¦å®Œæˆã€‚

  

### **ğŸ¯ ä¸»è¦ç›®çš„ï¼š**

1. **ç­‰å¾…èµ„æºåˆ›å»ºå®Œæˆ**
    
    - å¾ˆå¤š GCP èµ„æºï¼ˆå¦‚ Cloud Armor policyã€Certificate Managerã€TLS Policyï¼‰éƒ½ä¸æ˜¯ç«‹åˆ»è¿”å›å®Œæˆï¼Œè€Œæ˜¯å¼‚æ­¥æ‰§è¡Œã€‚
        
    - Terraform ä¼šè½®è¯¢ operations.get æ¥å£ç›´åˆ° DONEã€‚
        
    
2. **å¤„ç†é”™è¯¯ä¸é‡è¯•é€»è¾‘**
    
    - å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œå®ƒå¯ä»¥åœ¨ plan/apply é˜¶æ®µä¸­æç¤ºä½ é”™è¯¯ï¼Œæ¯”å¦‚ä½ é‡åˆ°çš„ 403ã€‚
        
    - Terraform å¯ä»¥å†³å®šæ˜¯å¦é‡è¯•ï¼Œè¿˜æ˜¯ç»ˆæ­¢ï¼ˆfail-fastï¼‰ã€‚
        
    
3. **æ›´æ–° .tfstate çŠ¶æ€æ–‡ä»¶**
    
    - ç¡®ä¿ Terraform state æ–‡ä»¶è®°å½•çš„æ˜¯ **æœ€æ–°çš„ã€å·²ç»å®Œæˆçš„èµ„æºçŠ¶æ€**ï¼Œå¦åˆ™ä¸‹ä¸€æ¬¡ apply æˆ– destroy ä¼šå¼‚å¸¸ã€‚
        
    

---

## **ğŸ’¥ ç¬¬äºŒéƒ¨åˆ†ï¼šDestroy æ—¶èµ„æºé—´çš„ä¾èµ–å¯¼è‡´å¤±è´¥**

  

ä½ æåˆ°çš„ Destroy å¤±è´¥ï¼Œç¡®å®æ˜¯ Terraform ä½¿ç”¨ä¸­çš„ä¸€ä¸ªå¸¸è§éš¾ç‚¹ã€‚æ ¹æœ¬åŸå› åœ¨äºï¼š**èµ„æºä¹‹é—´çš„ä¾èµ–å…³ç³»æœªèƒ½æ­£ç¡®å¤„ç†æˆ–æ‰‹åŠ¨ç»•è¿‡äº† Terraform çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**ã€‚

---

### **ğŸ“Œ åœºæ™¯ä¸¾ä¾‹ï¼š**

  

å‡è®¾ä½ æœ‰å¦‚ä¸‹èµ„æºä¾èµ–ï¼š

```
resource "google_network_security_server_tls_policy" "tls_policy" {
  ...
}

resource "google_compute_backend_service" "backend" {
  security_policy = google_network_security_server_tls_policy.tls_policy.name
}
```

> å¦‚æœ backend_service æ²¡æœ‰å…ˆ destroy æ‰ï¼Œtls_policy æ˜¯æ— æ³•é”€æ¯çš„ï¼Œä¼šæŠ¥ GCP API çš„ â€œresource is still in useâ€ é”™è¯¯ã€‚

---

### **ğŸ§¯ è§£å†³æ–¹æ¡ˆå»ºè®®ï¼š**

  

#### **âœ… æ–¹æ³• 1ï¼šæ‰‹åŠ¨åˆ†é˜¶æ®µ destroyï¼ˆæœ€ä¿é™©ï¼‰**

```
# å…ˆå•ç‹¬é”€æ¯æœ‰ä¾èµ–çš„ä¸Šå±‚èµ„æº
terraform destroy -target=google_compute_backend_service.backend

# å†æ•´ä½“ destroy
terraform destroy
```

#### **âœ… æ–¹æ³• 2ï¼šæ¸…ç†ç»‘å®šä¾èµ–èµ„æºå† destroy**

- å¦‚æœä½ ç”¨äº† resource "google_compute_url_map" ç­‰è‡ªåŠ¨ç»‘å®š TLS/Backendï¼Œå¯ä»¥å°è¯•ä¿®æ”¹ .tfï¼Œå…ˆæ¸…ç©ºè¿™äº›å­—æ®µï¼ˆå¦‚æŠŠ security_policy = nullï¼‰ï¼Œå† destroyã€‚
    

  

#### **âœ… æ–¹æ³• 3ï¼šä½¿ç”¨**Â 

#### **lifecycle**

#### Â **+ ignore å¤„ç†æŸäº›å­—æ®µï¼ˆä¸æ¨èä¹±ç”¨ï¼‰**

```
resource "google_compute_backend_service" "backend" {
  ...

  lifecycle {
    ignore_changes = [security_policy]
  }
}
```

é€‚ç”¨äºä¸è®© Terraform ç®¡ç†æŸäº›ç»‘å®šï¼Œä½†è¦å°å¿ƒï¼š**å¿½ç•¥ä¹‹å Terraform æ— æ³•æ§åˆ¶è¿™ä¸ªå­—æ®µï¼Œdestroy æ—¶ä¹Ÿä¸ä¼šå¤„ç†è¿™ä¸ªä¾èµ–**ã€‚

---

## **âœ… æ€»ç»“å»ºè®®**

|**é—®é¢˜**|**å»ºè®®**|
|---|---|
|Terraform ä¸ºä»€ä¹ˆè½®è¯¢æ“ä½œçŠ¶æ€ï¼Ÿ|ä¸ºäº†ç­‰å¾…èµ„æºå¼‚æ­¥åˆ›å»ºå®Œæˆï¼Œæ›´æ–° stateï¼Œä¿è¯ apply/destroy æ­£å¸¸|
|Destroy æ—¶å‡ºç°ä¾èµ–æ— æ³•åˆ é™¤|ä½¿ç”¨ -target å…ˆæ‰‹åŠ¨é”€æ¯ä¸Šå±‚ä¾èµ–èµ„æºï¼›æˆ–è€…æ¸…ç†ç»‘å®šå­—æ®µå† destroy|
|Terraform ä¸å¤„ç†è‡ªåŠ¨è§£ç»‘ï¼Ÿ|æ˜¯çš„ï¼Œç›®å‰ Terraform **ä¸å…·å¤‡è‡ªåŠ¨è§£å¼€èµ„æºç»‘å®šä¾èµ–çš„èƒ½åŠ›**ï¼Œåªèƒ½æ˜¾å¼è¡¨è¾¾ä¾èµ–æˆ–æ‰‹åŠ¨å¤„ç†|

---

å¦‚æœä½ æ„¿æ„æˆ‘å¯ä»¥å¸®ä½ ç”Ÿæˆä¸€ä¸ª Mermaid å›¾è§£é‡Š destroy çš„ä¾èµ–æµç¨‹ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ

å¥½çš„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Mermaid æè¿°çš„ Terraform destroy è¿‡ç¨‹ä¸­ä¾èµ–å…³ç³»å¯¼è‡´å¤±è´¥çš„æµç¨‹å›¾ï¼Œå¸®åŠ©ä½ ç†è§£ä¸ºä»€ä¹ˆ destroy æœ‰æ—¶å¿…é¡»æ‰‹åŠ¨å¤„ç†ï¼š

---

```mermaid
graph TD
    A[terraform destroy æ‰§è¡Œ] --> B[å¼€å§‹é”€æ¯ google_network_security_server_tls_policy]
    B --> C{æ˜¯å¦å­˜åœ¨ä¾èµ–ç»‘å®šï¼Ÿ}
    C -- æ˜¯ --> D[ä¾èµ–èµ„æºå¦‚ Backend Service / URL Map ç­‰ä»å­˜åœ¨ç»‘å®š]
    D --> E[ServerTlsPolicy è¢« GCP æ‹’ç»é”€æ¯resource is in use]
    E --> F[Terraform é”€æ¯å¤±è´¥ï¼Œç»ˆæ­¢æ‰§è¡Œ âŒ]

    C -- å¦ --> G[æˆåŠŸé”€æ¯ TLS Policy âœ…]

    subgraph é”™è¯¯å¤„ç†å»ºè®®
        D1[æ‰‹åŠ¨é”€æ¯ä¾èµ–èµ„æº: terraform destroy -target=backend_service]
        D2[æˆ–æ¸…ç†ç»‘å®šå­—æ®µ security_policy = null]
    end

    F --> D1
    F --> D2
```

---

## **ğŸ” è¯´æ˜ï¼š**

- ServerTlsPolicy è¿™ç±»èµ„æºåœ¨ **è¢«å…¶ä»–èµ„æºç»‘å®šæ—¶æ— æ³•é”€æ¯**ã€‚
    
- Terraform å¹¶ä¸ä¼šè‡ªåŠ¨åˆ¤æ–­å¹¶è§£ç»‘è¿™äº›ç»‘å®šå…³ç³»ã€‚
    
- æ‰€ä»¥ä½ éœ€è¦å…ˆé”€æ¯å¼•ç”¨å®ƒçš„èµ„æºï¼ˆå¦‚ Backend Serviceã€URL Mapï¼‰ï¼Œå†é”€æ¯ TLS Policy æœ¬èº«ã€‚
    

---

## **âœ… å°æŠ€å·§æ€»ç»“**

|**æ“ä½œ**|**æ–¹æ³•**|
|---|---|
|æ£€æŸ¥èµ„æºé—´å¼•ç”¨å…³ç³»|æŸ¥çœ‹ .tf æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ xxx = resource.name ç±»å¼•ç”¨|
|å¼ºåˆ¶å…ˆé”€æ¯æŸä¸ªèµ„æº|terraform destroy -target=xxx|
|å¿«é€Ÿæ‰¾å¼•ç”¨è·¯å¾„|`terraform graph|
|æƒ³è·³è¿‡ç»‘å®šå­—æ®µç®¡ç†|ä½¿ç”¨ lifecycle.ignore_changesï¼Œä½†ä¸æ¨è destroy æ—¶ä½¿ç”¨|

---

å¦‚æœä½ å¸Œæœ›æˆ‘å¸®ä½ ç”»å‡ºä½ å½“å‰ Terraform ä¸­ TLS Policy çš„ä¾èµ–å›¾ï¼ˆMermaid æ ¼å¼ï¼‰ï¼Œè¯·è´´å‡ºä½ ä¸»è¦çš„ç›¸å…³ .tf æ®µè½ï¼Œæˆ‘å¯ä»¥å¿«é€Ÿç”Ÿæˆå›¾å½¢è¯´æ˜ã€‚


æˆ‘çš„æ ¸å¿ƒé—®é¢˜æ˜¯çŠ¶æ€è½®è¯¢çš„æ—¶å€™å´å°‘äº†ä¸ªæƒé™.é‚£ä¹ˆæœ‰æ²¡æœ‰ç®€å•çš„åŠæ³•ç»•è¿‡è¿™ä¸ªget .å› ä¸ºæˆ‘çœ‹åˆ°å…¶å®å¾ˆå¤šèµ„æºéƒ½åˆ›å»ºæˆåŠŸäº†.ä»…ä»…æ˜¯è¿™ä¸ªgetæƒé™ç¼ºå¤±äº†

ä½ è¯´å¾—éå¸¸å¯¹ï¼Œ**Terraform ä¸­æœ€å¸¸è§çš„ GCP æƒé™é—®é¢˜**å°±æ˜¯ï¼š

èµ„æºåˆ›å»ºæƒé™æœ‰äº†ï¼Œ**ä½†è½®è¯¢çŠ¶æ€çš„æƒé™ï¼ˆå¦‚ .operations.getï¼‰æ²¡æœ‰ï¼**

---

## **ğŸš¨ é—®é¢˜æ ¸å¿ƒ**

  

Terraform åœ¨ GCP åˆ›å»ºæŸäº›èµ„æºæ—¶ï¼Œä¼šä½¿ç”¨ GCP çš„ long-running operations æ¥å£ï¼Œæ¯”å¦‚ï¼š

```
GET https://networksecurity.googleapis.com/v1/projects/xxx/locations/global/operations/operation-xxxx
```

ä½ ç¼ºå°‘çš„æ˜¯ï¼š

```
roles/networksecurity.admin æˆ–
resourcemanager.projects.get + networksecurity.operations.get
```

**æ‰€ä»¥é—®é¢˜ä¸æ˜¯èµ„æºæœ¬èº«åˆ›å»ºå¤±è´¥ï¼Œè€Œæ˜¯ Terraform è½®è¯¢è¿™ä¸ª â€œæ“ä½œçŠ¶æ€â€ å¤±è´¥äº†ã€‚**

---

## **âœ… æœ‰æ²¡æœ‰åŠæ³•è·³è¿‡/ç»•è¿‡**Â 

## **.operations.get**

## Â **æƒé™ï¼Ÿ**

  

### **âŒ ç»“è®ºï¼š**

### **ç›®å‰**

### **æ— æ³•ç›´æ¥è·³è¿‡æˆ–å…³é—­ Terraform çš„çŠ¶æ€è½®è¯¢ï¼**

  

Terraform çš„ GCP provider ä¼šè‡ªåŠ¨è°ƒç”¨ .operations.get æ¥ç¡®è®¤åˆ›å»ºçŠ¶æ€å®Œæˆï¼Œä¸å…è®¸ç”¨æˆ·è·³è¿‡è¿™æ­¥ï¼Œä¹Ÿæ²¡æœ‰ flag å¯ä»¥å…³é—­å®ƒã€‚

---

## **âœ… è§£å†³æ–¹å¼å»ºè®®ï¼ˆæ¨èåšæ³•ï¼‰**

|**æ–¹æ³•**|**æ“ä½œ**|
|---|---|
|âœ… **å¢åŠ æƒé™ï¼ˆæ¨èï¼‰**|ç»™ Terraform çš„æœåŠ¡è´¦å·å¢åŠ ï¼šğŸ”¹roles/networksecurity.adminï¼ˆæœ€å…¨ï¼‰æˆ–è‡³å°‘ï¼šnetworksecurity.serverTlsPolicies.create + networksecurity.operations.get|
|ğŸ” **æœ€å°æƒé™ç­–ç•¥**|ä½ å¯ä»¥è‡ªå®šä¹‰ IAM Roleï¼Œä»…æ·»åŠ  networksecurity.operations.get æƒé™|
|ğŸ§ª **æ‰‹åŠ¨åˆ†é˜¶æ®µ Apply**|å¦‚æœä½ å‘ç°å¤šæ•°èµ„æºéƒ½å·²åˆ›å»ºæˆåŠŸï¼Œå¯ä»¥å°†æœ‰é—®é¢˜çš„èµ„æºå…ˆä» .tf ä¸­æ³¨é‡Šæ‰æˆ–ç§»é™¤ï¼Œæ‰§è¡Œä¸€æ¬¡ terraform apply ç¡®ä¿å…¶ä»–çŠ¶æ€è®°å½•æ— è¯¯ï¼Œç„¶åå†é‡æ–°æ·»åŠ èµ„æºå¹¶ applyï¼ˆä½†ä¾ç„¶éœ€è¦æƒé™ï¼‰|
|ğŸ§° **CLI ç»•è¿‡æ–¹å¼ï¼ˆä¸æ¨èï¼‰**|ç†è®ºä¸Šå¯ä»¥è‡ªå·±ç”¨ gcloud CLI åˆ›å»ºèµ„æºï¼Œç»•è¿‡ Terraformï¼Œä½†è¿™æ · state ä¼šä¸åŒæ­¥ï¼Œ**ä¸å¯å–**|
|ğŸ§¼ **æœ€åå®åœ¨ä¸è¡Œ**|ä¸´æ—¶ç”¨å…¨æƒé™çš„è´¦å·æ‰§è¡Œ Terraformï¼ˆç”¨äº apply åé©¬ä¸Šç¦ç”¨ï¼‰ï¼Œä½†è¯·åŠ¡å¿…è®°å½•æƒé™å˜æ›´ï¼Œé¿å…æ»¥ç”¨|

---

## **ğŸ“ æœ€ä½æƒé™å»ºè®®ä¸¾ä¾‹**

```
title: custom_terraform_tls_policy_role
includedPermissions:
  - networksecurity.serverTlsPolicies.create
  - networksecurity.serverTlsPolicies.get
  - networksecurity.operations.get
```

é€šè¿‡ GCP Console æˆ– Terraform åˆ›å»ºä¸€ä¸ª custom è§’è‰²ï¼Œèµ‹äºˆä½ çš„ Terraform æœåŠ¡è´¦å·å³å¯ã€‚

---

## **âœ… æ€»ç»“å»ºè®®**

|**é—®é¢˜**|**è¯´æ˜**|
|---|---|
|ä¸ºä»€ä¹ˆä¼šæŠ¥é”™ï¼Ÿ|å› ä¸º Terraform åœ¨ç­‰å¾… GCP å¼‚æ­¥æ“ä½œå®Œæˆæ—¶ï¼Œè°ƒç”¨äº† operations.getï¼Œä½ ç¼ºæƒé™|
|èƒ½å¦è·³è¿‡è¿™ä¸ªæ“ä½œï¼Ÿ|**ä¸èƒ½**ï¼ŒTerraform provider å¿…é¡»æ‹¿åˆ°æˆåŠŸçŠ¶æ€æ‰èƒ½ç»§ç»­|
|æœ€æ¨èæ–¹æ¡ˆï¼Ÿ|è¡¥ä¸Š networksecurity.operations.get æƒé™æˆ–èµ‹äºˆ networksecurity.admin ä¸´æ—¶æƒé™|

---

å¦‚æœä½ å¸Œæœ›æˆ‘å¸®ä½ ç”Ÿæˆ IAM è‡ªå®šä¹‰è§’è‰²çš„ .tf æ¨¡æ¿æˆ– gcloud å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ã€‚